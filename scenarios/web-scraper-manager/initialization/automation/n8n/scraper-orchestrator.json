{
  "name": "Web Scraper Orchestrator",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "minutes", "triggerAtMinute": 5}]
        }
      },
      "name": "Schedule Check",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM scraping_agents WHERE enabled = true AND (next_run IS NULL OR next_run <= NOW())"
      },
      "name": "Get Scheduled Agents",
      "type": "n8n-nodes-base.postgres",
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "{{$json.platform}}",
              "operation": "equals",
              "value2": "huginn"
            },
            {
              "value1": "{{$json.platform}}",
              "operation": "equals", 
              "value2": "browserless"
            },
            {
              "value1": "{{$json.platform}}",
              "operation": "equals",
              "value2": "agent-s2"
            }
          ]
        }
      },
      "name": "Route by Platform",
      "type": "n8n-nodes-base.switch",
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:4111/agents/{{$json.agent_type}}/run",
        "method": "POST",
        "body": "{{$json.configuration}}"
      },
      "name": "Execute Huginn Agent",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "url": "http://localhost:4110/screenshot",
        "method": "POST",
        "body": {
          "url": "{{$json.target_url}}",
          "options": "{{$json.configuration}}"
        }
      },
      "name": "Execute Browserless",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:4113/execute",
        "method": "POST",
        "body": {
          "task": "{{$json.configuration.task}}",
          "target": "{{$json.target_url}}"
        }
      },
      "name": "Execute Agent-S2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 400]
    },
    {
      "parameters": {
        "functionCode": "const results = items.map(item => {\n  return {\n    agent_id: item.agent_id,\n    data: item.data,\n    status: item.error ? 'failed' : 'success',\n    extracted_count: item.data ? Object.keys(item.data).length : 0\n  };\n});\nreturn results;"
      },
      "name": "Process Results",
      "type": "n8n-nodes-base.function",
      "position": [1050, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "scraping_results",
        "columns": "agent_id,status,data,extracted_count"
      },
      "name": "Store Results",
      "type": "n8n-nodes-base.postgres",
      "position": [1250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "{{$json.extracted_count}}",
              "operation": "smaller",
              "value2": 1
            }
          ]
        }
      },
      "name": "Check Data Quality",
      "type": "n8n-nodes-base.if",
      "position": [1450, 300]
    },
    {
      "parameters": {
        "message": "Scraping agent {{$json.agent_id}} returned no data",
        "additionalFields": {
          "priority": 2
        }
      },
      "name": "Alert on Failure",
      "type": "n8n-nodes-base.slack",
      "position": [1650, 350]
    }
  ],
  "connections": {
    "Schedule Check": {"main": [[{"node": "Get Scheduled Agents"}]]},
    "Get Scheduled Agents": {"main": [[{"node": "Route by Platform"}]]},
    "Route by Platform": {
      "main": [
        [{"node": "Execute Huginn Agent"}],
        [{"node": "Execute Browserless"}],
        [{"node": "Execute Agent-S2"}]
      ]
    },
    "Execute Huginn Agent": {"main": [[{"node": "Process Results"}]]},
    "Execute Browserless": {"main": [[{"node": "Process Results"}]]},
    "Execute Agent-S2": {"main": [[{"node": "Process Results"}]]},
    "Process Results": {"main": [[{"node": "Store Results"}]]},
    "Store Results": {"main": [[{"node": "Check Data Quality"}]]},
    "Check Data Quality": {"main": [[{"node": "Alert on Failure"}], []]}
  }
}