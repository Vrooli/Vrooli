#!/usr/bin/env bash
# Web Scraper Manager CLI
# Unified command-line interface for web scraping management

set -euo pipefail

# Configuration
API_BASE_URL="${WEB_SCRAPER_MANAGER_API_URL:-http://localhost:${API_PORT:-8091}}"
CLI_VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# API helper function
api_call() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    
    local curl_opts=(-s -X "$method" -H "Content-Type: application/json")
    
    if [[ -n "$data" ]]; then
        curl_opts+=(-d "$data")
    fi
    
    curl "${curl_opts[@]}" "$API_BASE_URL$endpoint"
}

# Check if API is available
check_api() {
    if ! curl -s "$API_BASE_URL/health" > /dev/null 2>&1; then
        log_error "API is not available at $API_BASE_URL"
        log_info "Make sure the Web Scraper Manager API is running"
        exit 1
    fi
}

# Command implementations
cmd_status() {
    log_info "Checking Web Scraper Manager status..."
    
    local response=$(api_call "GET" "/health")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        log_success "Web Scraper Manager API is healthy"
        echo "$response" | jq -r '.data // {}'
    else
        log_error "API health check failed"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_list_agents() {
    local platform="${1:-}"
    local enabled="${2:-}"
    
    log_info "Listing scraping agents..."
    
    local endpoint="/api/agents"
    local params=()
    
    if [[ -n "$platform" ]]; then
        params+=("platform=$platform")
    fi
    
    if [[ -n "$enabled" ]]; then
        params+=("enabled=$enabled")
    fi
    
    if [[ ${#params[@]} -gt 0 ]]; then
        endpoint="$endpoint?$(IFS=\&; echo "${params[*]}")"
    fi
    
    local response=$(api_call "GET" "$endpoint")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        local agents=$(echo "$response" | jq -r '.data')
        local count=$(echo "$agents" | jq 'length')
        
        log_success "Found $count agents"
        echo "$agents" | jq -r '.[] | "\(.id) | \(.name) | \(.platform) | \(.enabled)"' | \
            awk 'BEGIN{printf "%-36s | %-20s | %-12s | %-8s\n", "ID", "Name", "Platform", "Enabled"; print "----------------------------------------------------------------------"} {printf "%-36s | %-20s | %-12s | %-8s\n", $1, $3, $5, $7}'
    else
        log_error "Failed to list agents"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_create_agent() {
    local name="$1"
    local platform="$2"
    local agent_type="${3:-}"
    
    log_info "Creating new scraping agent: $name"
    
    local agent_data=$(jq -n \
        --arg name "$name" \
        --arg platform "$platform" \
        --arg agent_type "$agent_type" \
        '{
            name: $name,
            platform: $platform,
            agent_type: $agent_type,
            enabled: true,
            configuration: {},
            tags: []
        }')
    
    local response=$(api_call "POST" "/api/agents" "$agent_data")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        local agent_id=$(echo "$response" | jq -r '.data.id')
        log_success "Agent created with ID: $agent_id"
        echo "$response" | jq -r '.data'
    else
        log_error "Failed to create agent"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_delete_agent() {
    local agent_id="$1"
    
    log_warning "Deleting agent: $agent_id"
    read -p "Are you sure? (y/N): " -n 1 -r
    echo
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Agent deletion cancelled"
        return 0
    fi
    
    local response=$(api_call "DELETE" "/api/agents/$agent_id")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        log_success "Agent deleted successfully"
    else
        log_error "Failed to delete agent"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_execute_agent() {
    local agent_id="$1"
    
    log_info "Executing agent: $agent_id"
    
    local response=$(api_call "POST" "/api/agents/$agent_id/execute")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        local run_id=$(echo "$response" | jq -r '.data.run_id')
        log_success "Agent execution triggered with run ID: $run_id"
        echo "$response" | jq -r '.data'
    else
        log_error "Failed to execute agent"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_list_results() {
    local agent_id="${1:-}"
    local status="${2:-}"
    local limit="${3:-10}"
    
    log_info "Listing scraping results..."
    
    local endpoint="/api/results"
    local params=()
    
    if [[ -n "$agent_id" ]]; then
        endpoint="/api/agents/$agent_id/results"
    fi
    
    if [[ -n "$status" ]]; then
        params+=("status=$status")
    fi
    
    params+=("limit=$limit")
    
    if [[ ${#params[@]} -gt 0 ]]; then
        endpoint="$endpoint?$(IFS=\&; echo "${params[*]}")"
    fi
    
    local response=$(api_call "GET" "$endpoint")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        local results=$(echo "$response" | jq -r '.data')
        local count=$(echo "$results" | jq 'length')
        
        log_success "Found $count results"
        echo "$results" | jq -r '.[] | "\(.id) | \(.agent_id) | \(.status) | \(.started_at)"' | \
            awk 'BEGIN{printf "%-36s | %-36s | %-10s | %-20s\n", "Result ID", "Agent ID", "Status", "Started At"; print "--------------------------------------------------------------------------------"} {printf "%-36s | %-36s | %-10s | %-20s\n", $1, $3, $5, $7}'
    else
        log_error "Failed to list results"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_platforms() {
    log_info "Listing supported platforms..."
    
    local response=$(api_call "GET" "/api/platforms")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        echo "$response" | jq -r '.data[] | "\(.platform) | \(.best_for)"' | \
            awk 'BEGIN{printf "%-12s | %-50s\n", "Platform", "Best For"; print "--------------------------------------------------------------"} {printf "%-12s | %-50s\n", $1, $3}'
    else
        log_error "Failed to list platforms"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_metrics() {
    log_info "Getting system metrics..."
    
    local response=$(api_call "GET" "/api/metrics")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        log_success "System metrics:"
        echo "$response" | jq -r '.data'
    else
        log_error "Failed to get metrics"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

cmd_export() {
    local format="${1:-json}"
    local agent_ids="${2:-}"
    
    log_info "Triggering data export in $format format"
    
    local agent_ids_array="[]"
    if [[ -n "$agent_ids" ]]; then
        agent_ids_array=$(echo "$agent_ids" | tr ',' '\n' | jq -R . | jq -s .)
    fi
    
    local export_data=$(jq -n \
        --arg format "$format" \
        --argjson agent_ids "$agent_ids_array" \
        '{
            format: $format,
            agent_ids: $agent_ids,
            filters: {}
        }')
    
    local response=$(api_call "POST" "/api/export" "$export_data")
    local success=$(echo "$response" | jq -r '.success // false')
    
    if [[ "$success" == "true" ]]; then
        local export_id=$(echo "$response" | jq -r '.data.export_id')
        log_success "Export job queued with ID: $export_id"
        echo "$response" | jq -r '.data'
    else
        log_error "Failed to trigger export"
        echo "$response" | jq -r '.error // "Unknown error"'
        exit 1
    fi
}

# Help text
show_help() {
    cat << EOF
Web Scraper Manager CLI v$CLI_VERSION

USAGE:
    web-scraper-manager <command> [options]

COMMANDS:
    status                          Check API health and status
    agents list [platform] [enabled]   List all agents
    agents create <name> <platform> [type]  Create new agent
    agents delete <id>              Delete agent
    agents execute <id>             Execute agent
    results list [agent_id] [status] [limit]  List results
    platforms                       List supported platforms
    metrics                         Get system metrics
    export [format] [agent_ids]     Export data (format: json, csv, xml)
    help                            Show this help message

EXAMPLES:
    web-scraper-manager status
    web-scraper-manager agents list huginn true
    web-scraper-manager agents create "News Scraper" huginn WebsiteAgent
    web-scraper-manager agents execute 123e4567-e89b-12d3-a456-426614174000
    web-scraper-manager results list
    web-scraper-manager export json

ENVIRONMENT:
    WEB_SCRAPER_MANAGER_API_URL     API base URL (default: http://localhost:${API_PORT:-8091})
    API_PORT                        API port when running in orchestrated environment

EOF
}

# Main command router
main() {
    # Check dependencies
    if ! command -v jq &> /dev/null; then
        log_error "jq is required but not installed"
        exit 1
    fi
    
    if ! command -v curl &> /dev/null; then
        log_error "curl is required but not installed"
        exit 1
    fi
    
    # Parse command
    local cmd="${1:-help}"
    
    case "$cmd" in
        "status")
            check_api
            cmd_status
            ;;
        "agents")
            check_api
            local subcmd="${2:-list}"
            case "$subcmd" in
                "list")
                    cmd_list_agents "${3:-}" "${4:-}"
                    ;;
                "create")
                    if [[ $# -lt 4 ]]; then
                        log_error "Usage: agents create <name> <platform> [type]"
                        exit 1
                    fi
                    cmd_create_agent "$3" "$4" "${5:-}"
                    ;;
                "delete")
                    if [[ $# -lt 3 ]]; then
                        log_error "Usage: agents delete <id>"
                        exit 1
                    fi
                    cmd_delete_agent "$3"
                    ;;
                "execute")
                    if [[ $# -lt 3 ]]; then
                        log_error "Usage: agents execute <id>"
                        exit 1
                    fi
                    cmd_execute_agent "$3"
                    ;;
                *)
                    log_error "Unknown agents subcommand: $subcmd"
                    show_help
                    exit 1
                    ;;
            esac
            ;;
        "results")
            check_api
            local subcmd="${2:-list}"
            case "$subcmd" in
                "list")
                    cmd_list_results "${3:-}" "${4:-}" "${5:-10}"
                    ;;
                *)
                    log_error "Unknown results subcommand: $subcmd"
                    show_help
                    exit 1
                    ;;
            esac
            ;;
        "platforms")
            check_api
            cmd_platforms
            ;;
        "metrics")
            check_api
            cmd_metrics
            ;;
        "export")
            check_api
            cmd_export "${2:-json}" "${3:-}"
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        "version"|"--version")
            echo "Web Scraper Manager CLI v$CLI_VERSION"
            ;;
        *)
            log_error "Unknown command: $cmd"
            show_help
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"