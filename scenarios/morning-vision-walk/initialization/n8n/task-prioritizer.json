{
  "name": "Morning Vision - Task Prioritizer",
  "nodes": [
    {
      "parameters": {
        "path": "vision-task-prioritizer",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nreturn [{\n  json: {\n    session_id: \"test-session\",\n    user_id: \"test-user\",\n    tasks: [\n      { name: \"Fix scenario conversion bug\", category: \"bug\", effort: \"medium\" },\n      { name: \"Implement new n8n workflow\", category: \"feature\", effort: \"high\" },\n      { name: \"Update documentation\", category: \"docs\", effort: \"low\" }\n    ],\n    context: {\n      energy_level: \"high\",\n      available_time: \"4 hours\",\n      current_focus: \"scenario improvement\"\n    }\n  }\n}];"
      },
      "id": "provide-defaults",
      "name": "Provide Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "executeQuery",
        "query": "SELECT * FROM tasks WHERE user_id = $1 AND status IN ('pending', 'in_progress', 'blocked') ORDER BY created_at DESC",
        "additionalFields": {
          "queryParams": "={{ [$json.user_id] }}"
        }
      },
      "id": "fetch-existing-tasks",
      "name": "Fetch Existing Tasks",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [650, 200],
      "credentials": {
        "postgres": {
          "id": "vision-walk-postgres",
          "name": "Vision Walk Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Merge new tasks with existing ones\nconst newTasks = $('webhook-trigger').item.json.tasks || [];\nconst existingTasks = $('fetch-existing-tasks').item?.json || [];\nconst context = $('webhook-trigger').item.json.context || {};\n\n// Combine and deduplicate\nconst allTasks = [...newTasks];\n\nexistingTasks.forEach(existing => {\n  if (!allTasks.find(t => t.name === existing.task_name)) {\n    allTasks.push({\n      id: existing.id,\n      name: existing.task_name,\n      category: existing.category || 'general',\n      effort: existing.effort_estimate || 'medium',\n      status: existing.status,\n      priority: existing.priority,\n      created_at: existing.created_at\n    });\n  }\n});\n\nreturn [{\n  json: {\n    tasks: allTasks,\n    context: context,\n    total_count: allTasks.length\n  }\n}];"
      },
      "id": "merge-tasks",
      "name": "Merge Tasks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'http://localhost:5678' }}/webhook/ollama",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "You are a task prioritization expert for the Vrooli recursive improvement system. Prioritize these tasks based on:\n1. Impact on Vrooli's recursive improvement capability\n2. Current energy level and available time\n3. Dependencies and blockers\n4. Quick wins vs long-term investments\n\nTasks to prioritize:\n{{ JSON.stringify($json.tasks) }}\n\nContext:\n{{ JSON.stringify($json.context) }}\n\nProvide a prioritized list with:\n- top_priority (1-2 tasks for immediate focus)\n- today_goals (3-5 tasks achievable today)\n- this_week (remaining important tasks)\n- rationale (brief explanation of prioritization)\n- energy_alignment (how tasks match current energy)\n- recursive_impact (how each priority enhances Vrooli)\n\nFormat as JSON."
            },
            {
              "name": "model",
              "value": "llama3.2"
            },
            {
              "name": "temperature",
              "value": 0.7
            },
            {
              "name": "format",
              "value": "json"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-prioritize",
      "name": "AI Prioritize",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse and structure prioritization\nconst aiResponse = $json.response || '{}';\nlet priorities;\n\ntry {\n  priorities = typeof aiResponse === 'string' ? JSON.parse(aiResponse) : aiResponse;\n} catch (e) {\n  // Fallback if parsing fails\n  const tasks = $('merge-tasks').item.json.tasks || [];\n  priorities = {\n    top_priority: tasks.slice(0, 2).map(t => t.name),\n    today_goals: tasks.slice(0, 5).map(t => t.name),\n    this_week: tasks.slice(5, 10).map(t => t.name),\n    rationale: 'AI prioritization unavailable, using chronological order',\n    energy_alignment: 'moderate',\n    recursive_impact: 'standard'\n  };\n}\n\n// Add metadata and structure\nconst structuredPriorities = {\n  session_id: $('webhook-trigger').item.json.session_id,\n  user_id: $('webhook-trigger').item.json.user_id,\n  timestamp: new Date().toISOString(),\n  priorities: priorities,\n  task_count: $('merge-tasks').item.json.total_count,\n  context: $('merge-tasks').item.json.context\n};\n\nreturn [{ json: structuredPriorities }];"
      },
      "id": "structure-priorities",
      "name": "Structure Priorities",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "update",
        "schema": "public",
        "table": "tasks",
        "updateKey": "id",
        "columns": "priority",
        "additionalFields": {}
      },
      "id": "update-task-priorities",
      "name": "Update Task Priorities",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1450, 200],
      "credentials": {
        "postgres": {
          "id": "vision-walk-postgres",
          "name": "Vision Walk Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Prepare task updates based on prioritization\nconst priorities = $json.priorities;\nconst allTasks = $('merge-tasks').item.json.tasks || [];\nconst updates = [];\n\n// Assign priority scores\nconst assignPriority = (taskName, score) => {\n  const task = allTasks.find(t => t.name === taskName);\n  if (task && task.id) {\n    updates.push({\n      id: task.id,\n      priority: score\n    });\n  }\n};\n\n// Top priority: 100-90\npriorities.top_priority?.forEach((taskName, index) => {\n  assignPriority(taskName, 100 - index * 5);\n});\n\n// Today goals: 80-60\npriorities.today_goals?.forEach((taskName, index) => {\n  if (!priorities.top_priority?.includes(taskName)) {\n    assignPriority(taskName, 80 - index * 5);\n  }\n});\n\n// This week: 50-30\npriorities.this_week?.forEach((taskName, index) => {\n  if (!priorities.top_priority?.includes(taskName) && !priorities.today_goals?.includes(taskName)) {\n    assignPriority(taskName, 50 - index * 3);\n  }\n});\n\nreturn updates.length > 0 ? updates : [{ json: { message: 'No updates needed' } }];"
      },
      "id": "prepare-updates",
      "name": "Prepare Updates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'http://localhost:5678' }}/webhook/task-planner/sync",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "priorities",
              "value": "={{ $json.priorities }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            },
            {
              "name": "source",
              "value": "morning-vision-walk"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "sync-task-planner",
      "name": "Sync with Task Planner",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Generate actionable schedule\nconst priorities = $('structure-priorities').item.json.priorities;\nconst context = $('structure-priorities').item.json.context;\n\n// Create time blocks based on available time\nconst availableHours = parseInt(context.available_time) || 4;\nconst schedule = [];\n\nif (priorities.top_priority?.length > 0) {\n  schedule.push({\n    time_block: 'First 90 minutes',\n    task: priorities.top_priority[0],\n    reason: 'Peak energy for highest impact',\n    technique: 'Deep focus, no distractions'\n  });\n}\n\nif (priorities.top_priority?.length > 1) {\n  schedule.push({\n    time_block: 'After first break',\n    task: priorities.top_priority[1],\n    reason: 'Sustained energy for critical work',\n    technique: 'Pomodoro technique recommended'\n  });\n}\n\nif (priorities.today_goals?.length > 0) {\n  schedule.push({\n    time_block: 'Afternoon blocks',\n    tasks: priorities.today_goals.slice(0, 3),\n    reason: 'Batch similar tasks',\n    technique: 'Time-boxing with regular breaks'\n  });\n}\n\nreturn [{\n  json: {\n    schedule: schedule,\n    energy_optimization: priorities.energy_alignment,\n    recursive_focus: priorities.recursive_impact\n  }\n}];"
      },
      "id": "generate-schedule",
      "name": "Generate Schedule",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Compile final response\nconst priorities = $('structure-priorities').item.json;\nconst updateResult = $('update-task-priorities').item?.json || { updated: false };\nconst syncResult = $('sync-task-planner').item?.json || { synced: false };\nconst schedule = $('generate-schedule').item.json;\n\nreturn [{\n  json: {\n    success: true,\n    session_id: priorities.session_id,\n    timestamp: priorities.timestamp,\n    prioritization: {\n      top_priority: priorities.priorities.top_priority || [],\n      today_goals: priorities.priorities.today_goals || [],\n      this_week: priorities.priorities.this_week || [],\n      rationale: priorities.priorities.rationale\n    },\n    schedule: schedule.schedule,\n    optimization: {\n      energy_alignment: schedule.energy_optimization,\n      recursive_impact: schedule.recursive_focus\n    },\n    updates: {\n      database_updated: !!updateResult.id,\n      task_planner_synced: syncResult.synced || syncResult.success || false,\n      tasks_processed: priorities.task_count\n    }\n  }\n}];"
      },
      "id": "compile-response",
      "name": "Compile Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 350]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1850, 350]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [[{ "node": "fetch-existing-tasks", "type": "main", "index": 0 }]]
    },
    "manual-trigger": {
      "main": [[{ "node": "provide-defaults", "type": "main", "index": 0 }]]
    },
    "provide-defaults": {
      "main": [[{ "node": "fetch-existing-tasks", "type": "main", "index": 0 }]]
    },
    "fetch-existing-tasks": {
      "main": [[{ "node": "merge-tasks", "type": "main", "index": 0 }]]
    },
    "merge-tasks": {
      "main": [[{ "node": "ai-prioritize", "type": "main", "index": 0 }]]
    },
    "ai-prioritize": {
      "main": [[{ "node": "structure-priorities", "type": "main", "index": 0 }]]
    },
    "structure-priorities": {
      "main": [
        [
          { "node": "prepare-updates", "type": "main", "index": 0 },
          { "node": "sync-task-planner", "type": "main", "index": 0 },
          { "node": "generate-schedule", "type": "main", "index": 0 }
        ]
      ]
    },
    "prepare-updates": {
      "main": [[{ "node": "update-task-priorities", "type": "main", "index": 0 }]]
    },
    "update-task-priorities": {
      "main": [[{ "node": "compile-response", "type": "main", "index": 0 }]]
    },
    "sync-task-planner": {
      "main": [[{ "node": "compile-response", "type": "main", "index": 0 }]]
    },
    "generate-schedule": {
      "main": [[{ "node": "compile-response", "type": "main", "index": 0 }]]
    },
    "compile-response": {
      "main": [[{ "node": "respond", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}