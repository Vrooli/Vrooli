{
  "name": "Injection Tester",
  "nodes": [
    {
      "parameters": {},
      "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger", 
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "path": "injection-tester"
      },
      "id": "b2c3d4e5-f6g7-8901-2345-67890abcdef1",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 160],
      "webhookId": "injection-tester-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Batch Test Controller\n// Orchestrates testing of multiple injections against an agent\n\nconst input = $input.all()[0].json;\n\n// Extract parameters\nconst agentConfig = input.agent_config || {};\nconst injectionIds = input.injection_ids || [];\nconst testSuite = input.test_suite || 'default';\nconst batchId = input.batch_id || `batch_${Date.now()}`;\n\n// Validate inputs\nif (!agentConfig.system_prompt) {\n  throw new Error('Agent configuration must include system_prompt');\n}\n\nif (injectionIds.length === 0) {\n  throw new Error('At least one injection ID must be provided');\n}\n\n// Create batch test configuration\nconst batchConfig = {\n  batch_id: batchId,\n  test_suite: testSuite,\n  agent_config: agentConfig,\n  injection_ids: injectionIds,\n  total_tests: injectionIds.length,\n  started_at: new Date().toISOString(),\n  status: 'initializing'\n};\n\nreturn { batchConfig };"
      },
      "id": "c3d4e5f6-g7h8-9012-3456-7890abcdef12",
      "name": "Batch Initialization",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 230]
    },
    {
      "parameters": {
        "url": "={{ $vars.service.postgres.url }}/query",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": {
          "Content-Type": "application/json",
          "Authorization": "Bearer {{ $vars.service.postgres.token }}"
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"query\": \"SELECT id, name, category, example_prompt FROM injection_techniques WHERE id = ANY($1) AND is_active = true\",\n  \"params\": [{{ JSON.stringify($json.batchConfig.injection_ids) }}]\n}"
      },
      "id": "d4e5f6g7-h8i9-0123-4567-890abcdef123",
      "name": "Fetch Injections",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 230],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "e5f6g7h8-i9j0-1234-5678-90abcdef1234",
      "name": "Process Each Injection",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [900, 230]
    },
    {
      "parameters": {
        "jsCode": "// Prepare individual test\n// Sets up a single injection test against the agent\n\nconst batchConfig = $('Batch Initialization').first().json.batchConfig;\nconst injection = $input.all()[0].json;\n\n// Create test configuration for security sandbox\nconst testConfig = {\n  test_id: `${batchConfig.batch_id}_${injection.id}`,\n  session_id: batchConfig.batch_id,\n  agent_config: batchConfig.agent_config,\n  injection_prompt: injection.example_prompt,\n  injection_metadata: {\n    id: injection.id,\n    name: injection.name,\n    category: injection.category\n  },\n  batch_metadata: {\n    batch_id: batchConfig.batch_id,\n    test_suite: batchConfig.test_suite,\n    current_test: $itemIndex + 1,\n    total_tests: batchConfig.total_tests\n  }\n};\n\nreturn { testConfig };"
      },
      "id": "f6g7h8i9-j0k1-2345-6789-0abcdef12345", 
      "name": "Prepare Test",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 230]
    },
    {
      "parameters": {
        "url": "={{ $vars.service.n8n.url }}/webhook/security-sandbox",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.testConfig }}"
      },
      "id": "g7h8i9j0-k1l2-3456-7890-abcdef123456",
      "name": "Execute Sandbox Test",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1340, 230],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Process sandbox result\n// Handles the response from security sandbox and prepares for database storage\n\nconst testConfig = $('Prepare Test').first().json.testConfig;\nconst sandboxResult = $input.all()[0].json.testResult || {};\n\n// Handle sandbox errors\nif (!sandboxResult || sandboxResult.status !== 'completed') {\n  return {\n    testResult: {\n      test_id: testConfig.test_id,\n      injection_id: testConfig.injection_metadata.id,\n      agent_name: testConfig.agent_config.name || 'unnamed',\n      success: false,\n      error: 'Sandbox execution failed',\n      execution_time_ms: 0,\n      confidence_score: 0.0,\n      safety_violations: [],\n      response_text: '',\n      completed_at: new Date().toISOString()\n    }\n  };\n}\n\n// Process successful result\nconst processedResult = {\n  test_id: sandboxResult.test_id,\n  injection_id: testConfig.injection_metadata.id,\n  agent_name: testConfig.agent_config.name || 'unnamed',\n  injection_name: testConfig.injection_metadata.name,\n  injection_category: testConfig.injection_metadata.category,\n  success: sandboxResult.injection_successful,\n  execution_time_ms: sandboxResult.execution_time_ms,\n  confidence_score: sandboxResult.confidence_score,\n  safety_violations: sandboxResult.safety_violations,\n  response_text: sandboxResult.response_preview,\n  completed_at: sandboxResult.completed_at,\n  batch_metadata: testConfig.batch_metadata\n};\n\nreturn { testResult: processedResult };"
      },
      "id": "h8i9j0k1-l2m3-4567-8901-bcdef1234567",
      "name": "Process Result", 
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 230]
    },
    {
      "parameters": {
        "url": "={{ $vars.service.postgres.url }}/insert",
        "sendHeaders": true,
        "specifyHeaders": "json", 
        "jsonHeaders": {
          "Content-Type": "application/json",
          "Authorization": "Bearer {{ $vars.service.postgres.token }}"
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"table\": \"test_results\",\n  \"data\": {\n    \"injection_id\": \"{{ $json.testResult.injection_id }}\",\n    \"agent_id\": \"{{ $json.testResult.agent_id || null }}\",\n    \"success\": {{ $json.testResult.success }},\n    \"response_text\": \"{{ $json.testResult.response_text }}\",\n    \"execution_time_ms\": {{ $json.testResult.execution_time_ms }},\n    \"confidence_score\": {{ $json.testResult.confidence_score }},\n    \"safety_violations\": {{ JSON.stringify($json.testResult.safety_violations) }},\n    \"test_session_id\": \"{{ $json.testResult.batch_metadata.batch_id }}\",\n    \"metadata\": {{ JSON.stringify($json.testResult.batch_metadata) }}\n  }\n}"
      },
      "id": "i9j0k1l2-m3n4-5678-9012-cdef12345678",
      "name": "Store Result",
      "type": "n8n-nodes-base.httpRequest", 
      "typeVersion": 4.1,
      "position": [1780, 230],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Aggregate batch results\n// Collects all individual test results and creates batch summary\n\nconst allResults = $input.all().map(item => item.json.testResult || {});\nconst batchConfig = $('Batch Initialization').first().json.batchConfig;\n\n// Calculate batch statistics\nconst totalTests = allResults.length;\nconst successfulInjections = allResults.filter(r => r.success).length;\nconst avgExecutionTime = allResults.reduce((sum, r) => sum + (r.execution_time_ms || 0), 0) / totalTests;\nconst avgConfidence = allResults.reduce((sum, r) => sum + (r.confidence_score || 0), 0) / totalTests;\nconst totalViolations = allResults.reduce((sum, r) => sum + (r.safety_violations || 0), 0);\n\n// Group results by category\nconst resultsByCategory = {};\nfor (const result of allResults) {\n  const category = result.injection_category || 'unknown';\n  if (!resultsByCategory[category]) {\n    resultsByCategory[category] = { total: 0, successful: 0 };\n  }\n  resultsByCategory[category].total++;\n  if (result.success) resultsByCategory[category].successful++;\n}\n\n// Create batch summary\nconst batchSummary = {\n  batch_id: batchConfig.batch_id,\n  agent_name: batchConfig.agent_config.name || 'unnamed',\n  test_suite: batchConfig.test_suite,\n  completed_at: new Date().toISOString(),\n  statistics: {\n    total_tests: totalTests,\n    successful_injections: successfulInjections,\n    success_rate: totalTests > 0 ? successfulInjections / totalTests : 0,\n    avg_execution_time_ms: Math.round(avgExecutionTime),\n    avg_confidence_score: Math.round(avgConfidence * 1000) / 1000,\n    total_safety_violations: totalViolations,\n    robustness_score: totalTests > 0 ? Math.round((1 - successfulInjections / totalTests) * 100) : 0\n  },\n  category_breakdown: resultsByCategory,\n  individual_results: allResults.map(r => ({\n    injection_id: r.injection_id,\n    injection_name: r.injection_name,\n    success: r.success,\n    confidence: r.confidence_score\n  }))\n};\n\nreturn { batchSummary };"
      },
      "id": "j0k1l2m3-n4o5-6789-0123-def123456789",
      "name": "Batch Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 230]
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Batch Initialization",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Batch Initialization",
            "type": "main", 
            "index": 0
          }
        ]
      ]
    },
    "Batch Initialization": {
      "main": [
        [
          {
            "node": "Fetch Injections",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Injections": {
      "main": [
        [
          {
            "node": "Process Each Injection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Each Injection": {
      "main": [
        [
          {
            "node": "Prepare Test",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Test": {
      "main": [
        [
          {
            "node": "Execute Sandbox Test",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Sandbox Test": {
      "main": [
        [
          {
            "node": "Process Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Result": {
      "main": [
        [
          {
            "node": "Store Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Result": {
      "main": [
        [
          {
            "node": "Batch Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "injection-tester-v1.0",
  "meta": {
    "instanceId": "prompt-injection-arena"
  },
  "id": "injection-tester",
  "tags": [
    "security",
    "testing",
    "batch-processing"
  ]
}