version: 1.0
scenario: code-smell

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - README.md
    - api/main.go
    - api/go.mod
    - cli/code-smell
    - cli/install.sh
    - lib/rules-engine.js
    - initialization/rules/default.yaml
    - initialization/rules/vrooli-specific.yaml
    - ui/index.html
    - package.json
    - scenario-test.yaml
    
  required_dirs:
    - .vrooli
    - api
    - cli
    - lib
    - initialization
    - initialization/rules
    - ui
    - tests

# Resource validation
resources:
  required:
    - postgres
    - resource-claude-code
  optional:
    - redis
    - visited-tracker
  health_timeout: 60

# Declarative tests
tests:
  # API health checks
  - name: "API health check"
    type: http
    service: api
    endpoint: /api/v1/health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        service: code-smell

  - name: "API ready check"
    type: http
    service: api
    endpoint: /api/v1/health/ready
    method: GET
    expect:
      status: 200
      body:
        status: ready

  # Rules engine tests
  - name: "Rules are loaded"
    type: http
    service: api
    endpoint: /api/v1/code-smell/rules
    method: GET
    expect:
      status: 200
      body_contains:
        - rules
        - vrooli_specific_count

  - name: "CLI executable exists"
    type: file_exists
    path: cli/code-smell
    executable: true

  - name: "Rules hot-reload works"
    type: exec
    command: |
      echo "test_rule_$(date +%s):" >> initialization/rules/test.yaml &&
      echo "  name: Test Rule" >> initialization/rules/test.yaml &&
      echo "  pattern: TODO" >> initialization/rules/test.yaml &&
      echo "  risk_level: safe" >> initialization/rules/test.yaml &&
      sleep 2 &&
      ./cli/code-smell rules list | grep -q "Test Rule"
    expect:
      exit_code: 0

  # Analysis tests
  - name: "Analyze endpoint works"
    type: http
    service: api
    endpoint: /api/v1/code-smell/analyze
    method: POST
    body:
      paths: ["./lib/rules-engine.js"]
      auto_fix: false
    expect:
      status: 200
      body_contains:
        - violations
        - total_files
        - duration_ms

  - name: "CLI analyze command works"
    type: exec
    command: ./cli/code-smell analyze ./lib --risk safe
    expect:
      exit_code: 0
      output_contains:
        - "Analyzing"
        - "Found"
        - "files to analyze"

  # Queue and fix tests
  - name: "Review queue endpoint"
    type: http
    service: api
    endpoint: /api/v1/code-smell/queue
    method: GET
    expect:
      status: 200
      body:
        violations: []
        total: 0
        by_severity:
          error: 0
          warning: 0
          info: 0

  - name: "Fix endpoint accepts actions"
    type: http
    service: api
    endpoint: /api/v1/code-smell/fix
    method: POST
    body:
      violation_id: "test-violation-1"
      action: "approve"
    expect:
      status: 200
      body:
        success: true

  # Learning system test
  - name: "Pattern learning endpoint"
    type: http
    service: api
    endpoint: /api/v1/code-smell/learn
    method: POST
    body:
      pattern: "console.log"
      is_positive: false
      context:
        description: "Debug logging in production"
    expect:
      status: 200
      body:
        success: true

  # Statistics test
  - name: "Statistics endpoint"
    type: http
    service: api
    endpoint: /api/v1/code-smell/stats
    method: GET
    query:
      period: all
    expect:
      status: 200
      body_contains:
        - period
        - files_analyzed
        - violations_found
        - auto_fixed

  # UI tests
  - name: "UI is accessible"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body_contains:
        - "Code Smell Detector"
        - "Dashboard"
        - "Review Queue"

  # Vrooli-specific rule tests
  - name: "Detects hard-coded ports"
    type: exec
    command: |
      echo 'const url = "http://localhost:3000/api"' > /tmp/test-port.js &&
      ./cli/code-smell analyze /tmp/test-port.js | grep -q "Hard-coded port"
    expect:
      exit_code: 0

  - name: "Detects hard-coded home paths"
    type: exec
    command: |
      echo 'const path = "/home/matthalloran8/Vrooli"' > /tmp/test-home.js &&
      ./cli/code-smell analyze /tmp/test-home.js | grep -q "Hard-coded home"
    expect:
      exit_code: 0

  # Integration tests
  - name: "CLI status shows correct info"
    type: exec
    command: ./cli/code-smell status --json
    expect:
      exit_code: 0
      output_contains:
        - status
        - version
        - stats

  - name: "Rules can be enabled/disabled"
    type: exec
    command: |
      ./cli/code-smell rules disable hardcoded-port &&
      ./cli/code-smell rules list | grep hardcoded-port
    expect:
      exit_code: 0

# Performance validation
performance:
  - name: "Single file analysis speed"
    type: http
    service: api
    endpoint: /api/v1/code-smell/analyze
    method: POST
    body:
      paths: ["./lib/rules-engine.js"]
    expect:
      status: 200
      response_time_ms: 500

  - name: "Rules loading speed"
    type: http
    service: api
    endpoint: /api/v1/code-smell/rules
    method: GET
    expect:
      status: 200
      response_time_ms: 100

# Integration validation
integration:
  - name: "Discoverable via registry"
    type: registry
    check: exists
    service: code-smell

  - name: "CLI in PATH after install"
    type: exec
    command: which code-smell
    expect:
      exit_code: 0

  - name: "API documentation available"
    type: http
    service: api
    endpoint: /api/v1/docs
    method: GET
    expect:
      status: 200
      body:
        service: code-smell
        version: 1.0.0