version: 1.0
scenario: token-economy

# Structure validation
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/token-economy
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - scenario-test.yaml
    - ui/index.html
    - ui/package.json
    - ui/server.js
    - ui/app.js
    - ui/styles.css
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/storage
    - initialization/storage/postgres
    - ui
    - tests
    - data
    - docs

# Resource validation
resources:
  required:
    - postgres
    - redis
  optional:
    - qdrant
    - minio
    - ollama
  health_timeout: 60

# Declarative tests
tests:
  # Database tests
  - name: "PostgreSQL ledger tables exist"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_name IN ('tokens', 'wallets', 'transactions', 'balances', 'achievements', 'exchange_rates')"
    expect:
      rows:
        - count: 6
        
  - name: "Test household exists"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM households WHERE id = '00000000-0000-0000-0000-000000000001'"
    expect:
      rows:
        - count: 1
        
  # API health check
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  # Token creation test
  - name: "API can create token"
    type: http
    service: api
    endpoint: /api/v1/tokens/create
    method: POST
    body:
      symbol: TEST
      name: Test Token
      type: fungible
      initial_supply: 1000
    expect:
      status: 201
      body:
        token_id: "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
        
  # Wallet creation test
  - name: "API can create wallet"
    type: http
    service: api
    endpoint: /api/v1/wallets/create
    method: POST
    body:
      type: user
      user_id: test-user-1
    expect:
      status: 201
      body:
        wallet_id: "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
        address: "^0x[0-9a-f]{32}$"
        
  # CLI tests
  - name: "CLI status command works"
    type: exec
    command: ./cli/token-economy status --json
    expect:
      exit_code: 0
      output_contains:
        - status
        - database
        - redis
        
  - name: "CLI help command works"
    type: exec
    command: ./cli/token-economy help
    expect:
      exit_code: 0
      output_contains:
        - "Token Economy CLI"
        - "Commands:"
        - "wallet-create"
        - "balance"
        - "mint"
        - "transfer"
        
  - name: "CLI version command works"
    type: exec
    command: ./cli/token-economy version
    expect:
      exit_code: 0
      output_contains:
        - "Token Economy CLI"
        - "1.0.0"
        
  # UI tests
  - name: "UI server responds"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      headers:
        content-type: "text/html"
        
  - name: "UI assets load"
    type: http
    service: ui
    endpoint: /app.js
    method: GET
    expect:
      status: 200
      headers:
        content-type: "application/javascript"
        
  # Redis cache test
  - name: "Redis connection works"
    type: exec
    command: resource-redis ping
    expect:
      exit_code: 0
      output_contains:
        - PONG
        
  # Integration tests
  - name: "Full token lifecycle test"
    type: integration
    steps:
      - action: create_token
        endpoint: /api/v1/tokens/create
        method: POST
        body:
          symbol: LIFECYCLE
          name: Lifecycle Test Token
          type: fungible
        store: token_id
        
      - action: create_wallet
        endpoint: /api/v1/wallets/create
        method: POST
        body:
          type: user
          user_id: lifecycle-test-user
        store: wallet_id
        
      - action: mint_tokens
        endpoint: /api/v1/tokens/mint
        method: POST
        body:
          token_id: "${token_id}"
          to_wallet: "${wallet_id}"
          amount: 100
        expect:
          new_supply: 100
          
      - action: check_balance
        endpoint: /api/v1/wallets/${wallet_id}/balance
        method: GET
        expect:
          balances:
            - token_id: "${token_id}"
              amount: 100
              
# Performance validation
performance:
  - name: "API response time"
    type: latency
    endpoint: /api/v1/health
    method: GET
    requests: 100
    expect:
      p95: 100  # 95th percentile under 100ms
      p99: 200  # 99th percentile under 200ms
      
  - name: "Transaction throughput"
    type: throughput
    endpoint: /api/v1/tokens/transfer
    method: POST
    duration: 10  # seconds
    expect:
      tps: 100  # At least 100 TPS
      
# Security validation
security:
  - name: "SQL injection protection"
    type: security
    endpoint: /api/v1/wallets/'; DROP TABLE wallets; --/balance
    method: GET
    expect:
      status: 404  # Should fail safely
      
  - name: "Rate limiting active"
    type: rate_limit
    endpoint: /api/v1/tokens
    method: GET
    requests: 1100
    window: 60  # seconds
    expect:
      blocked_after: 1000