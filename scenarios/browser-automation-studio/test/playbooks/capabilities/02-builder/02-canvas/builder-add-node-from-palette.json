{
  "metadata": {
    "description": "Validates adding a node from the palette to the canvas via drag-and-drop",
    "version": 1,
    "reset": "full"
  },
  "settings": {
    "executionViewport": {
      "width": 1920,
      "height": 1080,
      "preset": "desktop"
    }
  },
  "nodes": [
    {
      "id": "call-open-builder",
      "type": "subflow",
      "data": {
        "label": "Open builder via fixture",
        "workflowId": "@fixture/open-builder-from-demo(projectName=@seed/projectName, projectFolder=@seed/projectFolder)"
      }
    },
    {
      "id": "assert-canvas-visible",
      "type": "assert",
      "data": {
        "label": "Canvas is visible",
        "selector": "@selector/workflowBuilder.reactFlowReady",
        "assertMode": "exists",
        "timeoutMs": 5000,
        "failureMessage": "Workflow builder canvas should be visible"
      }
    },
    {
      "id": "count-initial-nodes",
      "type": "evaluate",
      "data": {
        "label": "Count initial nodes on canvas",
        "expression": "document.querySelectorAll('.react-flow__node').length",
        "storeResult": "initialNodeCount"
      }
    },
    {
      "id": "assert-palette-visible",
      "type": "assert",
      "data": {
        "label": "Node palette is visible",
        "selector": "@selector/nodePalette.container",
        "assertMode": "exists",
        "timeoutMs": 5000,
        "failureMessage": "Node palette should be visible in sidebar"
      }
    },
    {
      "id": "get-navigate-node-position",
      "type": "evaluate",
      "data": {
        "label": "Get navigate node card position",
        "expression": "(() => { const card = document.querySelector('@selector/nodePalette.cards.navigate'); if (!card) return null; const rect = card.getBoundingClientRect(); return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 }; })()",
        "storeResult": "nodePalettePosition"
      }
    },
    {
      "id": "get-canvas-drop-position",
      "type": "evaluate",
      "data": {
        "label": "Calculate canvas drop position",
        "expression": "(() => { const canvas = document.querySelector('@selector/workflowBuilder.canvas.root'); if (!canvas) return null; const rect = canvas.getBoundingClientRect(); return { x: rect.left + 400, y: rect.top + 300 }; })()",
        "storeResult": "canvasDropPosition"
      }
    },
    {
      "id": "drag-navigate-node",
      "type": "dragDrop",
      "data": {
        "label": "Drag navigate node from palette to canvas",
        "sourceSelector": "@selector/nodePalette.cards.navigate",
        "targetSelector": ".react-flow__pane",
        "timeoutMs": 10000,
        "waitForMs": 2000
      }
    },
    {
      "id": "count-final-nodes",
      "type": "evaluate",
      "data": {
        "label": "Count nodes after drag",
        "expression": "document.querySelectorAll('.react-flow__node').length",
        "storeResult": "finalNodeCount"
      }
    },
    {
      "id": "verify-node-count-increased",
      "type": "evaluate",
      "data": {
        "label": "Verify node count increased",
        "expression": "(() => { const initial = Number({{initialNodeCount}} || 0); const final = Number({{finalNodeCount}} || 0); return Number.isFinite(initial) && Number.isFinite(final) && final > initial; })()",
        "storeResult": "nodeWasAdded"
      }
    },
    {
      "id": "check-navigate-node-exists",
      "type": "assert",
      "data": {
        "label": "Navigate node exists on canvas",
        "selector": ".react-flow__node[data-type=\"navigate\"]",
        "assertMode": "exists",
        "timeoutMs": 5000,
        "failureMessage": "Navigate node should be visible on canvas after drag-and-drop"
      }
    }
  ],
  "edges": [
    {
      "id": "e9",
      "source": "call-open-builder",
      "target": "assert-canvas-visible",
      "type": "smoothstep"
    },
    {
      "id": "e9a",
      "source": "assert-canvas-visible",
      "target": "count-initial-nodes",
      "type": "smoothstep"
    },
    {
      "id": "e10",
      "source": "count-initial-nodes",
      "target": "assert-palette-visible",
      "type": "smoothstep"
    },
    {
      "id": "e13",
      "source": "get-navigate-node-position",
      "target": "get-canvas-drop-position",
      "type": "smoothstep"
    },
    {
      "id": "e14",
      "source": "get-canvas-drop-position",
      "target": "drag-navigate-node",
      "type": "smoothstep"
    },
    {
      "id": "e15",
      "source": "drag-navigate-node",
      "target": "count-final-nodes",
      "type": "smoothstep"
    },
    {
      "id": "e17",
      "source": "count-final-nodes",
      "target": "verify-node-count-increased",
      "type": "smoothstep"
    },
    {
      "id": "e18",
      "source": "verify-node-count-increased",
      "target": "check-navigate-node-exists",
      "type": "smoothstep"
    },
    {
      "id": "e11-bridge-e12",
      "source": "assert-palette-visible",
      "target": "get-navigate-node-position",
      "type": "smoothstep"
    }
  ]
}