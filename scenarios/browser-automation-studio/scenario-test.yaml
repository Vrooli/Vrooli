version: 1.0
scenario: browser-automation-studio

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - README.md
    - api/main.go
    - api/go.mod
    - cli/browser-automation-studio
    - cli/install.sh
    - ui/package.json
    - ui/vite.config.ts
    - ui/src/App.tsx
    - ui/src/components/WorkflowBuilder.tsx
    - initialization/storage/postgres/schema.sql
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - ui
    - ui/src
    - ui/src/components
    - ui/src/components/nodes
    - ui/src/stores
    - initialization
    - initialization/storage
    - initialization/storage/postgres

# Resource validation
resources:
  required:
    - browserless
    - postgres
    - minio
  optional:
    - redis
    - ollama
    - n8n
  health_timeout: 60

# Declarative tests
tests:
  # API health check
  - name: "API health check"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body_contains:
        - status
        - healthy
      
  # Create workflow via API
  - name: "Create workflow via API"
    type: http
    service: api
    endpoint: /api/v1/workflows/create
    method: POST
    headers:
      Content-Type: application/json
    body:
      name: "test-workflow"
      folder_path: "/tests"
      flow_definition:
        nodes: []
        edges: []
    expect:
      status: 201
      body_contains:
        - workflow_id
        - status
        
  # List workflows
  - name: "List workflows API"
    type: http
    service: api
    endpoint: /api/v1/workflows
    method: GET
    expect:
      status: 200
      body_contains:
        - workflows
        
  # CLI status command
  - name: "CLI status command executes"
    type: exec
    command: ./cli/browser-automation-studio status
    expect:
      exit_code: 0
      output_contains:
        - "Browser Automation Studio Status"
        - "API Server"
        
  # CLI workflow list command
  - name: "CLI workflow list command"
    type: exec
    command: ./cli/browser-automation-studio workflow list --json
    expect:
      exit_code: 0
      output_contains:
        - "workflows"
        
  # CLI help command
  - name: "CLI help command"
    type: exec
    command: ./cli/browser-automation-studio help
    expect:
      exit_code: 0
      output_contains:
        - "Browser Automation Studio"
        - "COMMANDS"
        - "workflow"
        - "execution"
        
  # Database schema verification
  - name: "Database tables exist"
    type: sql
    service: postgres
    database: browser_automation_studio
    query: |
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name IN ('workflows', 'executions', 'screenshots')
    expect:
      row_count: 3
      
  # UI build test
  - name: "UI builds successfully"
    type: exec
    command: cd ui && npm run build
    timeout: 300000  # 5 minutes for build
    expect:
      exit_code: 0
      output_contains:
        - "vite"
        
  # Workflow execution test
  - name: "Execute workflow via API"
    type: http
    service: api
    endpoint: /api/v1/workflows/{workflow_id}/execute
    method: POST
    headers:
      Content-Type: application/json
    body:
      parameters: {}
      wait_for_completion: false
    expect:
      status: 200
      body_contains:
        - execution_id
        - status
    depends_on:
      - "Create workflow via API"
      
  # Screenshot retrieval test
  - name: "Get execution screenshots"
    type: http
    service: api
    endpoint: /api/v1/executions/{execution_id}/screenshots
    method: GET
    expect:
      status: 200
      body_contains:
        - screenshots
    depends_on:
      - "Execute workflow via API"

# Performance validation
performance:
  - name: "API response time"
    type: http
    service: api
    endpoint: /api/v1/workflows
    method: GET
    iterations: 10
    expect:
      avg_response_time: < 200ms
      p95_response_time: < 500ms
      
  - name: "Workflow creation performance"
    type: http
    service: api
    endpoint: /api/v1/workflows/create
    method: POST
    iterations: 5
    body:
      name: "perf-test-{iteration}"
      folder_path: "/performance"
    expect:
      avg_response_time: < 500ms
      p95_response_time: < 1000ms

# Integration validation
integration:
  - name: "Browserless resource available"
    type: exec
    command: resource-browserless status
    expect:
      exit_code: 0
      output_contains:
        - "running"
        
  - name: "PostgreSQL connection"
    type: sql
    service: postgres
    query: "SELECT 1"
    expect:
      row_count: 1
      
  - name: "MinIO storage available"
    type: http
    service: minio
    endpoint: /minio/health/live
    method: GET
    expect:
      status: 200

# Capability verification
capability:
  - name: "Visual workflow builder loads"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body_contains:
        - "Browser Automation Studio"
        
  - name: "AI prompt endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/workflows/create
    method: POST
    body:
      name: "ai-test"
      folder_path: "/"
      ai_prompt: "test prompt"
    expect:
      status: 201
      
  - name: "WebSocket endpoint available"
    type: websocket
    service: ws
    endpoint: /ws/executions/test
    expect:
      connection: success
      
# Validation summary
validation:
  required_pass_rate: 90  # 90% of tests must pass
  critical_tests:  # These must all pass
    - "API health check"
    - "CLI status command executes"
    - "Database tables exist"
    - "Visual workflow builder loads"