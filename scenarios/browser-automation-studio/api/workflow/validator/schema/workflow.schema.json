{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.vrooli.com/browser-automation-studio/workflow.schema.json",
  "title": "Vrooli Ascension Workflow",
  "description": "Canonical schema for Vrooli Ascension workflow definitions",
  "type": "object",
  "required": [
    "nodes",
    "edges"
  ],
  "properties": {
    "metadata": {
      "type": "object",
      "properties": {
        "description": {
          "type": "string"
        },
        "requirement": {
          "type": "string",
          "pattern": "^[A-Za-z0-9-_:\\.]+$"
        },
        "version": {
          "type": [
            "number",
            "string"
          ]
        },
        "owner": {
          "type": "string"
        }
      },
      "additionalProperties": true
    },
    "settings": {
      "type": "object",
      "properties": {
        "executionViewport": {
          "type": "object",
          "properties": {
            "width": {
              "type": "number",
              "minimum": 200
            },
            "height": {
              "type": "number",
              "minimum": 200
            },
            "preset": {
              "type": "string",
              "enum": [
                "desktop",
                "mobile",
                "custom"
              ]
            }
          },
          "required": [
            "width",
            "height"
          ],
          "additionalProperties": true
        },
        "entrySelector": {
          "type": "string",
          "minLength": 1
        },
        "entrySelectorTimeoutMs": {
          "type": "number",
          "minimum": 0
        },
        "entryTimeoutMs": {
          "type": "number",
          "minimum": 0
        }
      },
      "additionalProperties": true
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/node"
      }
    },
    "edges": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/edge"
      }
    }
  },
  "definitions": {
    "position": {
      "type": "object",
      "required": [
        "x",
        "y"
      ],
      "properties": {
        "x": {
          "type": "number"
        },
        "y": {
          "type": "number"
        }
      },
      "additionalProperties": true
    },
    "node": {
      "type": "object",
      "required": [
        "id",
        "type",
        "data"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        },
        "type": {
          "type": "string",
          "minLength": 1
        },
        "position": {
          "description": "Optional: omit or set to null for auto-layout workflows",
          "anyOf": [
            { "$ref": "#/definitions/position" },
            { "type": "null" }
          ]
        },
        "data": {
          "type": "object"
        },
        "width": {
          "type": "number"
        },
        "height": {
          "type": "number"
        },
        "selected": {
          "type": "boolean"
        },
        "dragging": {
          "type": "boolean"
        }
      },
      "additionalProperties": true,
      "allOf": [
        {
          "if": {
            "properties": {
              "type": { "const": "evaluate" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/evaluateNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "click" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/clickNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "assert" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/assertNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "navigate" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/navigateNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "wait" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/waitNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "type" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/typeNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "screenshot" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/screenshotNodeData"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": { "const": "subflow" }
            }
          },
          "then": {
            "properties": {
              "data": {
                "$ref": "#/definitions/subflowNodeData"
              }
            }
          }
        }
      ]
    },
    "commonNodeFields": {
      "type": "object",
      "properties": {
        "label": {
          "type": "string",
          "description": "Human-readable description of this step"
        },
        "resilience": {
          "$ref": "#/definitions/resilience"
        },
        "timeoutMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum time to wait for this step to complete"
        },
        "waitForMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Additional wait time after step completes"
        },
        "continueOnError": {
          "type": "boolean",
          "description": "Whether to continue workflow execution if this step fails"
        },
        "retryAttempts": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "description": "Number of retry attempts on failure"
        },
        "retryDelayMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Delay between retry attempts"
        },
        "retryBackoffFactor": {
          "type": "number",
          "minimum": 1,
          "description": "Multiplier for retry delay on each attempt"
        }
      }
    },
    "evaluateNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "required": ["expression"],
      "properties": {
        "expression": {
          "type": "string",
          "minLength": 1,
          "description": "JavaScript expression to evaluate in the browser context"
        },
        "storeResult": {
          "type": "string",
          "description": "Variable name to store the evaluation result"
        }
      },
      "propertyNames": {
        "not": {
          "enum": ["storeAs"]
        }
      },
      "additionalProperties": true
    },
    "clickNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "required": ["selector"],
      "properties": {
        "selector": {
          "type": "string",
          "minLength": 1,
          "description": "CSS selector or data-testid for the element to click"
        },
        "clickCount": {
          "type": "integer",
          "minimum": 1,
          "maximum": 3,
          "description": "Number of clicks (1=single, 2=double, 3=triple)"
        }
      },
      "additionalProperties": true
    },
    "assertNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "required": ["selector", "assertMode"],
      "properties": {
        "selector": {
          "type": "string",
          "minLength": 1,
          "description": "CSS selector or data-testid for the element to assert"
        },
        "assertMode": {
          "type": "string",
          "enum": ["exists", "not_exists", "visible", "hidden", "text_equals", "text_contains", "attribute_equals", "attribute_contains"],
          "description": "Type of assertion to perform"
        },
        "expectedValue": {
          "description": "Expected value for comparison assertions"
        },
        "attributeName": {
          "type": "string",
          "description": "Attribute name for attribute assertions"
        },
        "caseSensitive": {
          "type": "boolean",
          "description": "Whether text comparison is case-sensitive"
        },
        "failureMessage": {
          "type": "string",
          "description": "Custom error message on assertion failure"
        }
      },
      "additionalProperties": true
    },
    "navigateNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "required": ["destinationType"],
      "properties": {
        "destinationType": {
          "type": "string",
          "enum": ["url", "scenario"],
          "description": "Whether navigating to a URL or scenario"
        },
        "url": {
          "type": "string",
          "description": "Target URL (required when destinationType=url)"
        },
        "scenario": {
          "type": "string",
          "description": "Scenario name (required when destinationType=scenario)"
        },
        "scenarioPath": {
          "type": "string",
          "description": "Path within scenario (optional)"
        },
        "waitUntil": {
          "type": "string",
          "enum": ["load", "domcontentloaded", "networkidle"],
          "description": "Event to wait for after navigation"
        }
      },
      "additionalProperties": true
    },
    "waitNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "properties": {
        "waitType": {
          "type": "string",
          "enum": ["element", "duration", "delay", "time"],
          "description": "Type of wait to perform"
        },
        "selector": {
          "type": "string",
          "description": "CSS selector (required for element wait)"
        },
        "durationMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Duration in milliseconds (required for duration wait)"
        }
      },
      "additionalProperties": true
    },
    "typeNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "required": ["selector"],
      "properties": {
        "selector": {
          "type": "string",
          "minLength": 1,
          "description": "CSS selector or data-testid for the input element"
        },
        "text": {
          "type": "string",
          "description": "Text to type into the element"
        },
        "value": {
          "type": "string",
          "description": "Alias for text field"
        },
        "variable": {
          "type": "string",
          "description": "Variable name containing text to type"
        },
        "clear": {
          "type": "boolean",
          "description": "Whether to clear existing text before typing"
        },
        "delayMs": {
          "type": "integer",
          "minimum": 0,
          "description": "Delay between keystrokes"
        }
      },
      "additionalProperties": true
    },
    "screenshotNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "properties": {
        "fullPage": {
          "type": "boolean",
          "description": "Capture full scrollable page (true) or viewport only (false)"
        },
        "selector": {
          "type": "string",
          "description": "CSS selector to screenshot specific element"
        }
      },
      "additionalProperties": true
    },
    "subflowNodeData": {
      "allOf": [
        { "$ref": "#/definitions/commonNodeFields" }
      ],
      "type": "object",
      "properties": {
        "workflowId": {
          "type": "string",
          "description": "ID or fixture reference of workflow to call"
        },
        "workflowDefinition": {
          "type": "object",
          "description": "Inline workflow definition"
        },
        "parameters": {
          "type": "object",
          "description": "Parameters to pass to the called workflow"
        }
      },
      "additionalProperties": true
    },
    "resilience": {
      "type": "object",
      "properties": {
        "maxAttempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 25
        },
        "delayMs": {
          "type": "integer",
          "minimum": 0,
          "maximum": 120000
        },
        "backoffFactor": {
          "type": "number",
          "exclusiveMinimum": 0
        },
        "preconditionSelector": {
          "type": "string",
          "minLength": 1
        },
        "preconditionTimeoutMs": {
          "type": "integer",
          "minimum": 0
        },
        "preconditionWaitMs": {
          "type": "integer",
          "minimum": 0
        },
        "successSelector": {
          "type": "string",
          "minLength": 1
        },
        "successTimeoutMs": {
          "type": "integer",
          "minimum": 0
        },
        "successWaitMs": {
          "type": "integer",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "edge": {
      "type": "object",
      "required": [
        "id",
        "source",
        "target"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        },
        "source": {
          "type": "string",
          "minLength": 1
        },
        "target": {
          "type": "string",
          "minLength": 1
        },
        "sourceHandle": {
          "type": "string"
        },
        "targetHandle": {
          "type": "string"
        },
        "type": {
          "type": "string"
        },
        "animated": {
          "type": "boolean"
        },
        "label": {
          "type": "string"
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}
