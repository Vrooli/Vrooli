#!/bin/bash

# Browser Automation Studio CLI
# Visual browser automation with AI-powered workflow builder

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
API_URL="${BROWSER_AUTOMATION_API_URL:-http://localhost:8090/api/v1}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
Browser Automation Studio - Visual Workflow Builder CLI

USAGE:
    browser-automation-studio <command> [arguments] [flags]

COMMANDS:
    status                    Show operational status and resource health
    workflow create          Create a workflow from file or AI prompt
    workflow execute         Execute a workflow by ID or name
    workflow list           List all workflows in tree structure
    workflow delete         Delete a workflow
    execution watch         Watch live execution with screenshots
    execution list          List all executions
    execution stop          Stop a running execution
    help                    Display this help message
    version                 Show CLI and API version information

WORKFLOW COMMANDS:
    workflow create <name> [flags]
        --folder <path>      Folder path for organization (default: /)
        --from-file <file>   Import from JSON file
        --ai-prompt <text>   Generate from natural language

    workflow execute <workflow> [flags]
        --params <json>      JSON parameters for workflow
        --wait              Wait for completion
        --output-screenshots <dir>  Save screenshots to directory

    workflow list [flags]
        --folder <path>      Filter by folder path
        --json              Output as JSON

    workflow delete <id>
        Delete a workflow by ID

EXECUTION COMMANDS:
    execution watch <execution-id>
        Watch live execution with real-time updates

    execution list [flags]
        --workflow <id>      Filter by workflow ID
        --status <status>    Filter by status
        --json              Output as JSON

    execution stop <execution-id>
        Stop a running execution

EXAMPLES:
    # Create a workflow from AI prompt
    browser-automation-studio workflow create "test-flow" \\
        --ai-prompt "Navigate to google.com and search for automation"

    # Execute a workflow and wait for completion
    browser-automation-studio workflow execute "test-flow" --wait

    # List all workflows in JSON format
    browser-automation-studio workflow list --json

    # Watch a live execution
    browser-automation-studio execution watch abc123

EOF
}

check_api_health() {
    if ! curl -s "${API_URL%/api/v1}/health" > /dev/null 2>&1; then
        echo -e "${RED}Error: API server is not responding at ${API_URL%/api/v1}${NC}"
        echo "Please ensure the browser-automation-studio API is running"
        exit 1
    fi
}

show_status() {
    echo -e "${BLUE}Browser Automation Studio Status${NC}"
    echo "================================"
    
    # Check API
    if curl -s "${API_URL%/api/v1}/health" > /dev/null 2>&1; then
        echo -e "API Server: ${GREEN}‚úì Running${NC}"
    else
        echo -e "API Server: ${RED}‚úó Not responding${NC}"
    fi
    
    # Check browserless
    if command -v resource-browserless &> /dev/null; then
        if resource-browserless status 2>/dev/null | grep -q "running"; then
            echo -e "Browserless: ${GREEN}‚úì Available${NC}"
        else
            echo -e "Browserless: ${YELLOW}‚ö† Not running${NC}"
        fi
    else
        echo -e "Browserless: ${RED}‚úó Not installed${NC}"
    fi
    
    # Show workflow count
    workflow_count=$(curl -s "${API_URL}/workflows" | grep -o '"id"' | wc -l || echo "0")
    echo -e "Workflows: ${workflow_count}"
    
    echo ""
    echo -e "${GREEN}Ready for automation!${NC}"
}

create_workflow() {
    local name="$1"
    shift
    
    local folder="/"
    local from_file=""
    local ai_prompt=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --folder)
                folder="$2"
                shift 2
                ;;
            --from-file)
                from_file="$2"
                shift 2
                ;;
            --ai-prompt)
                ai_prompt="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
        esac
    done
    
    local json_payload="{\"name\": \"$name\", \"folder_path\": \"$folder\""
    
    if [ -n "$from_file" ]; then
        if [ ! -f "$from_file" ]; then
            echo -e "${RED}File not found: $from_file${NC}"
            exit 1
        fi
        local flow_def=$(cat "$from_file")
        json_payload="$json_payload, \"flow_definition\": $flow_def"
    elif [ -n "$ai_prompt" ]; then
        json_payload="$json_payload, \"ai_prompt\": \"$ai_prompt\""
    fi
    
    json_payload="$json_payload}"
    
    echo -e "${BLUE}Creating workflow: $name${NC}"
    
    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$json_payload" \
        "${API_URL}/workflows/create")
    
    if echo "$response" | grep -q "workflow_id"; then
        workflow_id=$(echo "$response" | grep -o '"workflow_id":"[^"]*' | cut -d'"' -f4)
        echo -e "${GREEN}‚úì Workflow created successfully!${NC}"
        echo "Workflow ID: $workflow_id"
        echo "Folder: $folder"
        
        if [ -n "$ai_prompt" ]; then
            echo -e "${YELLOW}AI generated workflow from prompt${NC}"
        fi
    else
        echo -e "${RED}Failed to create workflow${NC}"
        echo "$response"
        exit 1
    fi
}

execute_workflow() {
    local workflow="$1"
    shift
    
    local params="{}"
    local wait=false
    local output_dir=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --params)
                params="$2"
                shift 2
                ;;
            --wait)
                wait=true
                shift
                ;;
            --output-screenshots)
                output_dir="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
        esac
    done
    
    echo -e "${BLUE}Executing workflow: $workflow${NC}"
    
    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "{\"parameters\": $params, \"wait_for_completion\": $wait}" \
        "${API_URL}/workflows/$workflow/execute")
    
    if echo "$response" | grep -q "execution_id"; then
        execution_id=$(echo "$response" | grep -o '"execution_id":"[^"]*' | cut -d'"' -f4)
        echo -e "${GREEN}‚úì Execution started!${NC}"
        echo "Execution ID: $execution_id"
        
        if [ "$wait" = true ]; then
            echo "Waiting for completion..."
            # In real implementation, poll for status
            sleep 5
            echo -e "${GREEN}‚úì Execution completed${NC}"
        fi
        
        if [ -n "$output_dir" ]; then
            mkdir -p "$output_dir"
            echo "Screenshots saved to: $output_dir"
        fi
    else
        echo -e "${RED}Failed to start execution${NC}"
        echo "$response"
        exit 1
    fi
}

list_workflows() {
    local folder=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --folder)
                folder="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
        esac
    done
    
    response=$(curl -s "${API_URL}/workflows")
    
    if [ "$json_output" = true ]; then
        echo "$response"
    else
        echo -e "${BLUE}Workflows${NC}"
        echo "========="
        # Parse and display in tree format
        echo "$response" | grep -o '"name":"[^"]*' | cut -d'"' -f4 | while read -r name; do
            echo "  üìÅ $name"
        done
    fi
}

# Main command router
case "${1:-}" in
    status)
        show_status
        ;;
    workflow)
        case "${2:-}" in
            create)
                check_api_health
                create_workflow "${@:3}"
                ;;
            execute)
                check_api_health
                execute_workflow "${@:3}"
                ;;
            list)
                check_api_health
                list_workflows "${@:3}"
                ;;
            delete)
                check_api_health
                echo -e "${YELLOW}Delete workflow: ${3}${NC}"
                curl -X DELETE "${API_URL}/workflows/${3}"
                echo -e "${GREEN}‚úì Workflow deleted${NC}"
                ;;
            *)
                echo -e "${RED}Unknown workflow command: ${2}${NC}"
                show_help
                exit 1
                ;;
        esac
        ;;
    execution)
        case "${2:-}" in
            watch)
                check_api_health
                echo -e "${BLUE}Watching execution: ${3}${NC}"
                echo "Real-time updates would stream here..."
                ;;
            list)
                check_api_health
                echo -e "${BLUE}Executions${NC}"
                curl -s "${API_URL}/executions"
                ;;
            stop)
                check_api_health
                echo -e "${YELLOW}Stopping execution: ${3}${NC}"
                curl -X POST "${API_URL}/executions/${3}/stop"
                echo -e "${GREEN}‚úì Execution stopped${NC}"
                ;;
            *)
                echo -e "${RED}Unknown execution command: ${2}${NC}"
                show_help
                exit 1
                ;;
        esac
        ;;
    version)
        echo "Browser Automation Studio CLI v1.0.0"
        echo "API Version: 1.0.0"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: ${1}${NC}"
        show_help
        exit 1
        ;;
esac