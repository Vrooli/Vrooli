#!/bin/bash

# Resource Generator CLI
# Provides commands for creating and managing Vrooli resources with v2.0 contract compliance

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCENARIO_DIR="$(dirname "$SCRIPT_DIR")"
API_PORT="${API_PORT}"
API_HOST="${API_HOST:-localhost}"
API_BASE="http://${API_HOST}:${API_PORT}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}" >&2
}

print_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

check_api_health() {
    if [ -z "$API_PORT" ]; then
        print_error "API_PORT environment variable is not set"
        print_info "Set it when starting the scenario: API_PORT=<port> vrooli scenario resource-generator develop"
        exit 1
    fi
    
    if ! curl -sf "$API_BASE/health" > /dev/null 2>&1; then
        print_error "Resource Generator API is not running at $API_BASE"
        print_info "Start it with: API_PORT=<port> vrooli scenario resource-generator develop"
        exit 1
    fi
}

# Command functions
cmd_create() {
    local name=""
    local template="basic"
    local type="resource"
    local priority="medium"
    local description=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --name)
                name="$2"
                shift 2
                ;;
            --template)
                template="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --description)
                description="$2"
                shift 2
                ;;
            *)
                print_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    if [[ -z "$name" ]]; then
        print_error "Resource name is required (--name)"
        exit 1
    fi
    
    check_api_health
    
    print_info "Creating resource: $name"
    
    # Create JSON payload
    local json_payload=$(cat <<EOF
{
    "name": "$name",
    "template": "$template",
    "type": "$type",
    "priority": "$priority",
    "description": "$description"
}
EOF
    )
    
    # Send request to API
    response=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -d "$json_payload" \
        "$API_BASE/api/resources/generate" 2>/dev/null || echo "ERROR")
    
    if [[ "$response" == "ERROR" ]]; then
        print_error "Failed to queue resource generation"
        exit 1
    fi
    
    # Parse response
    if echo "$response" | grep -q '"success":true'; then
        local queue_id=$(echo "$response" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
        print_success "Resource generation queued successfully"
        print_info "Queue ID: $queue_id"
        print_info "Use 'resource-generator status' to check progress"
    else
        print_error "Failed to queue resource generation"
        echo "$response" | jq . 2>/dev/null || echo "$response"
        exit 1
    fi
}

cmd_status() {
    check_api_health
    
    print_info "Fetching queue status..."
    
    # Get queue status
    response=$(curl -sf "$API_BASE/api/queue" 2>/dev/null || echo "ERROR")
    
    if [[ "$response" == "ERROR" ]]; then
        print_error "Failed to fetch queue status"
        exit 1
    fi
    
    # Parse and display status
    if command -v jq &> /dev/null; then
        echo "$response" | jq -r '.data | to_entries[] | "\(.key): \(.value | length) items"'
    else
        echo "$response"
    fi
    
    # Get health status for processing state
    health_response=$(curl -sf "$API_BASE/health" 2>/dev/null || echo "{}")
    if command -v jq &> /dev/null; then
        processing_active=$(echo "$health_response" | jq -r '.data.processing_active // false')
        if [[ "$processing_active" == "true" ]]; then
            print_success "Queue processing is ACTIVE"
        else
            print_warning "Queue processing is PAUSED"
        fi
    fi
}

cmd_list_templates() {
    check_api_health
    
    print_info "Available resource templates:"
    echo ""
    
    # Get templates from API
    response=$(curl -sf "$API_BASE/api/templates" 2>/dev/null || echo "ERROR")
    
    if [[ "$response" == "ERROR" ]]; then
        print_error "Failed to fetch templates"
        exit 1
    fi
    
    # Parse and display templates
    if command -v jq &> /dev/null; then
        echo "$response" | jq -r '.data[] | "• \(.id) - \(.name)\n  \(.description)\n"'
    else
        # Fallback without jq
        echo "• ai-powered - AI/ML Resource"
        echo "  Resource with model management, inference API, and GPU support"
        echo ""
        echo "• data-processing - Data Processing Resource"
        echo "  ETL pipelines, batch/stream processing, validation"
        echo ""
        echo "• workflow-automation - Workflow Automation"
        echo "  Workflow engine, event-driven architecture, scheduling"
        echo ""
        echo "• monitoring - Monitoring & Observability"
        echo "  Metrics, logs, alerts, dashboards"
        echo ""
        echo "• communication - Communication Platform"
        echo "  Messaging, real-time features, protocol bridges"
        echo ""
        echo "• security - Security Resource"
        echo "  Scanning, authentication, secrets management"
    fi
}

cmd_queue() {
    local action="${1:-list}"
    shift || true
    
    case "$action" in
        list)
            cmd_status
            ;;
        add)
            # Add item to queue from YAML file
            local file="${1:-}"
            if [[ -z "$file" ]]; then
                print_error "YAML file path required"
                exit 1
            fi
            
            if [[ ! -f "$file" ]]; then
                print_error "File not found: $file"
                exit 1
            fi
            
            # Copy to pending queue
            cp "$file" "$SCENARIO_DIR/queue/pending/"
            print_success "Added $(basename "$file") to queue"
            ;;
        clear)
            local queue_type="${1:-failed}"
            local queue_dir="$SCENARIO_DIR/queue/$queue_type"
            
            if [[ ! -d "$queue_dir" ]]; then
                print_error "Invalid queue type: $queue_type"
                exit 1
            fi
            
            rm -f "$queue_dir"/*.yaml 2>/dev/null || true
            print_success "Cleared $queue_type queue"
            ;;
        *)
            print_error "Unknown queue action: $action"
            echo "Usage: resource-generator queue [list|add|clear]"
            exit 1
            ;;
    esac
}

cmd_start() {
    check_api_health
    
    print_info "Starting queue processing..."
    
    response=$(curl -sf -X POST "$API_BASE/api/processing/start" 2>/dev/null || echo "ERROR")
    
    if [[ "$response" == "ERROR" ]]; then
        print_error "Failed to start processing"
        exit 1
    fi
    
    print_success "Queue processing started"
}

cmd_stop() {
    check_api_health
    
    print_info "Stopping queue processing..."
    
    response=$(curl -sf -X POST "$API_BASE/api/processing/stop" 2>/dev/null || echo "ERROR")
    
    if [[ "$response" == "ERROR" ]]; then
        print_error "Failed to stop processing"
        exit 1
    fi
    
    print_success "Queue processing stopped"
}

cmd_validate() {
    local resource="${1:-}"
    
    if [[ -z "$resource" ]]; then
        print_error "Resource name required"
        echo "Usage: resource-generator validate <resource-name>"
        exit 1
    fi
    
    local resource_dir="/home/matthalloran8/Vrooli/resources/$resource"
    
    if [[ ! -d "$resource_dir" ]]; then
        print_error "Resource not found: $resource"
        exit 1
    fi
    
    print_info "Validating resource: $resource"
    echo ""
    
    # Check v2.0 contract compliance
    local issues=0
    
    # Check for required directories
    echo "Checking directory structure..."
    if [[ -d "$resource_dir/lib" ]]; then
        print_success "lib/ directory exists"
    else
        print_error "lib/ directory missing"
        ((issues++))
    fi
    
    if [[ -d "$resource_dir/.vrooli" ]]; then
        print_success ".vrooli/ directory exists"
    else
        print_error ".vrooli/ directory missing"
        ((issues++))
    fi
    
    # Check for service.json
    echo ""
    echo "Checking configuration..."
    if [[ -f "$resource_dir/.vrooli/service.json" ]]; then
        print_success "service.json exists"
        
        # Validate JSON syntax
        if command -v jq &> /dev/null; then
            if jq . "$resource_dir/.vrooli/service.json" > /dev/null 2>&1; then
                print_success "service.json is valid JSON"
            else
                print_error "service.json has invalid JSON syntax"
                ((issues++))
            fi
        fi
    else
        print_error "service.json missing"
        ((issues++))
    fi
    
    # Check for health checks
    echo ""
    echo "Checking health implementation..."
    if [[ -f "$resource_dir/lib/health.sh" ]] || grep -q "health" "$resource_dir/.vrooli/service.json" 2>/dev/null; then
        print_success "Health checks implemented"
    else
        print_warning "Health checks may not be implemented"
    fi
    
    # Check for README
    echo ""
    echo "Checking documentation..."
    if [[ -f "$resource_dir/README.md" ]]; then
        print_success "README.md exists"
    else
        print_warning "README.md missing"
    fi
    
    # Summary
    echo ""
    if [[ $issues -eq 0 ]]; then
        print_success "Resource passes v2.0 contract validation!"
    else
        print_error "Resource has $issues validation issues"
        exit 1
    fi
}

cmd_help() {
    cat <<EOF
Resource Generator CLI - Create new Vrooli resources with v2.0 contract compliance

Usage: resource-generator <command> [options]

Commands:
    create          Create a new resource
        --name <name>           Resource name (required)
        --template <template>   Template to use (default: basic)
        --type <type>          Resource type (default: resource)
        --priority <priority>   Priority level (default: medium)
        --description <desc>    Resource description
        
    status          Show queue status and processing state
    
    list-templates  List available resource templates
    
    queue           Manage the generation queue
        list                    Show queue status (default)
        add <file.yaml>        Add item from YAML file
        clear [failed|pending]  Clear specified queue
        
    start           Start queue processing
    
    stop            Stop queue processing
    
    validate        Validate a resource for v2.0 compliance
        <resource-name>        Name of resource to validate
        
    help            Show this help message

Examples:
    # Create a new Matrix Synapse resource
    resource-generator create --name matrix-synapse --template communication --priority high
    
    # Check queue status
    resource-generator status
    
    # List available templates
    resource-generator list-templates
    
    # Validate an existing resource
    resource-generator validate matrix-synapse
    
    # Start processing queued items
    resource-generator start

Environment Variables:
    API_PORT        Port where Resource Generator API is running (required)
    API_HOST        Host where Resource Generator API is running (default: localhost)

For more information, see: /home/matthalloran8/Vrooli/scenarios/resource-generator/README.md
EOF
}

# Main command routing
main() {
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        create)
            cmd_create "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        list-templates)
            cmd_list_templates "$@"
            ;;
        queue)
            cmd_queue "$@"
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        validate)
            cmd_validate "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo "Run 'resource-generator help' for usage information"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"