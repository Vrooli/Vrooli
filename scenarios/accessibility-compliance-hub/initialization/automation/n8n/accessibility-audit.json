{
  "name": "accessibility-audit",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "accessibility-audit-webhook"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "days",
              "daysInterval": 1
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst scenario = items[0].json.scenario_id || 'all';\nconst wcagLevel = items[0].json.wcag_level || 'AA';\nconst autoFix = items[0].json.auto_fix || false;\n\nreturn [{\n  json: {\n    scenario_id: scenario,\n    wcag_level: wcagLevel,\n    auto_fix: autoFix,\n    timestamp: new Date().toISOString(),\n    audit_id: `audit_${Date.now()}`\n  }\n}];"
      },
      "id": "prepare-audit",
      "name": "Prepare Audit Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 400]
    },
    {
      "parameters": {
        "command": "resource-browserless screenshot {{$json.scenario_url}} --output /tmp/{{$json.audit_id}}_screenshot.png --wait-for-selector body"
      },
      "id": "capture-screenshot",
      "name": "Capture UI Screenshot",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "command": "resource-browserless execute '\n  const axe = require(\"axe-core\");\n  axe.run(document, {\n    rules: {\n      \"wcagLevel\": \"{{$json.wcag_level}}\"\n    }\n  }).then(results => {\n    return results;\n  });\n' --url {{$json.scenario_url}}"
      },
      "id": "run-axe-audit",
      "name": "Run Axe Accessibility Audit",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [650, 450]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "url": "{{$env.SERVICE_N8N_URL}}/webhook/ollama-analysis",
        "options": {
          "bodyContentType": "json"
        },
        "bodyParametersJson": "{\n  \"prompt\": \"Analyze these accessibility issues and suggest fixes: {{$json.violations}}\",\n  \"context\": \"WCAG {{$json.wcag_level}} compliance for web application\"\n}"
      },
      "id": "get-ai-suggestions",
      "name": "Get AI Fix Suggestions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [850, 350]
    },
    {
      "parameters": {
        "jsCode": "const auditResults = $node['run-axe-audit'].json;\nconst aiSuggestions = $node['get-ai-suggestions'].json;\nconst screenshot = $node['capture-screenshot'].json;\n\n// Calculate compliance score\nconst totalChecks = auditResults.passes.length + auditResults.violations.length;\nconst score = (auditResults.passes.length / totalChecks) * 100;\n\n// Categorize issues by severity\nconst issues = auditResults.violations.map(v => ({\n  id: v.id,\n  impact: v.impact,\n  description: v.description,\n  help: v.help,\n  helpUrl: v.helpUrl,\n  nodes: v.nodes.length,\n  autoFixable: ['color-contrast', 'image-alt', 'label'].includes(v.id)\n}));\n\nreturn [{\n  json: {\n    audit_id: $node['prepare-audit'].json.audit_id,\n    scenario_id: $node['prepare-audit'].json.scenario_id,\n    timestamp: new Date().toISOString(),\n    wcag_level: $node['prepare-audit'].json.wcag_level,\n    score: Math.round(score),\n    total_issues: auditResults.violations.length,\n    critical_issues: issues.filter(i => i.impact === 'critical').length,\n    auto_fixable_issues: issues.filter(i => i.autoFixable).length,\n    issues: issues,\n    ai_suggestions: aiSuggestions,\n    screenshot_path: screenshot.path\n  }\n}];"
      },
      "id": "process-results",
      "name": "Process Audit Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.auto_fix}}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-auto-fix",
      "name": "Should Auto Fix?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "url": "{{$env.SERVICE_N8N_URL}}/webhook/auto-remediate",
        "options": {
          "bodyContentType": "json"
        },
        "bodyParametersJson": "{{JSON.stringify($json)}}"
      },
      "id": "trigger-auto-fix",
      "name": "Trigger Auto Remediation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1450, 350]
    },
    {
      "parameters": {
        "command": "resource-postgres query \"\n  INSERT INTO audit_reports \n  (id, scenario_id, wcag_level, score, total_issues, critical_issues, auto_fixable_issues, report_data, created_at)\n  VALUES \n  ('{{$json.audit_id}}', '{{$json.scenario_id}}', '{{$json.wcag_level}}', {{$json.score}}, {{$json.total_issues}}, {{$json.critical_issues}}, {{$json.auto_fixable_issues}}, '{{JSON.stringify($json)}}', NOW())\n\""
      },
      "id": "store-report",
      "name": "Store Audit Report",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1450, 500]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "Accessibility audit completed"
            }
          ],
          "number": [
            {
              "name": "score",
              "value": "={{$node['process-results'].json.score}}"
            },
            {
              "name": "issues_found",
              "value": "={{$node['process-results'].json.total_issues}}"
            }
          ]
        }
      },
      "id": "prepare-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1850, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "prepare-audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "schedule-trigger": {
      "main": [
        [
          {
            "node": "prepare-audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-audit": {
      "main": [
        [
          {
            "node": "capture-screenshot",
            "type": "main",
            "index": 0
          },
          {
            "node": "run-axe-audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "run-axe-audit": {
      "main": [
        [
          {
            "node": "get-ai-suggestions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "capture-screenshot": {
      "main": [
        [
          {
            "node": "process-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-ai-suggestions": {
      "main": [
        [
          {
            "node": "process-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-results": {
      "main": [
        [
          {
            "node": "check-auto-fix",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-auto-fix": {
      "main": [
        [
          {
            "node": "trigger-auto-fix",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "store-report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "trigger-auto-fix": {
      "main": [
        [
          {
            "node": "store-report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "store-report": {
      "main": [
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-response": {
      "main": [
        [
          {
            "node": "webhook-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [],
  "createdAt": "2025-01-04T12:00:00.000Z",
  "updatedAt": "2025-01-04T12:00:00.000Z"
}