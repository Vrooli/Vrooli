{
  "name": "Personal Digital Twin - Data Ingestion",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "personal-digital-twin/ingest",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide test defaults for manual testing\nreturn {\n  persona_id: $input.item.json.persona_id || 'test-persona-001',\n  source_type: $input.item.json.source_type || 'text',\n  source_id: $input.item.json.source_id || 'doc-' + Date.now(),\n  content: $input.item.json.content || 'This is a sample document about machine learning, AI agents, and recursive improvement systems. The persona enjoys technology and innovation.',\n  metadata: $input.item.json.metadata || {\n    category: 'technology',\n    importance: 'high',\n    tags: ['AI', 'innovation', 'learning']\n  },\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "set_test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const input = $input.item.json;\n\n// Validate required fields\nif (!input.persona_id) {\n  throw new Error('persona_id is required');\n}\n\nif (!input.content && !input.file_path) {\n  throw new Error('Either content or file_path is required');\n}\n\n// Generate unique document ID\nconst docId = `${input.persona_id}_${input.source_id || Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n// Extract text content based on source type\nlet textContent = '';\nif (input.content) {\n  textContent = input.content;\n} else if (input.file_path) {\n  // In production, this would read from file\n  textContent = `Content from file: ${input.file_path}`;\n}\n\nreturn {\n  doc_id: docId,\n  persona_id: input.persona_id,\n  source_type: input.source_type || 'text',\n  source_id: input.source_id || 'unknown',\n  text_content: textContent,\n  metadata: input.metadata || {},\n  timestamp: input.timestamp || new Date().toISOString(),\n  processing_status: 'pending'\n};"
      },
      "id": "validate_and_prepare",
      "name": "Validate and Prepare",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const doc = $input.item.json;\n\n// Create embedding generation prompt\nconst embeddingPrompt = `Generate a semantic embedding for the following text. Focus on capturing the key concepts, themes, and context:\\n\\n${doc.text_content}\\n\\nProvide a JSON response with:\\n1. key_concepts: array of main concepts\\n2. themes: array of themes\\n3. sentiment: overall sentiment\\n4. summary: brief summary`;\n\nreturn {\n  prompt: embeddingPrompt,\n  model: 'nomic-embed-text',\n  type: 'embedding',\n  quiet: true,\n  original_doc: doc\n};"
      },
      "id": "prepare_embedding_request",
      "name": "Prepare Embedding Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.SHARED_WORKFLOW_OLLAMA }}",
        "source": "parameter",
        "workflowParameters": {
          "prompt": "={{ $json.prompt }}",
          "model": "={{ $json.model }}",
          "type": "={{ $json.type }}",
          "quiet": "={{ $json.quiet }}"
        }
      },
      "id": "generate_embedding",
      "name": "Generate Embedding",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "persona_documents",
        "columns": "doc_id,persona_id,source_type,source_id,content,embedding,metadata,created_at",
        "values": "={{ $json.doc_id }},={{ $json.persona_id }},={{ $json.source_type }},={{ $json.source_id }},={{ $json.text_content }},={{ $json.embedding }},={{ JSON.stringify($json.metadata) }},={{ $json.timestamp }}",
        "options": {}
      },
      "id": "store_in_postgres",
      "name": "Store in PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1400, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-personal-digital-twin",
          "name": "PostgreSQL - Personal Digital Twin"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "http://localhost:6333/collections/persona_embeddings/points",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "points",
              "value": "={{ [{\"id\": $json.doc_id, \"vector\": $json.embedding_vector, \"payload\": {\"persona_id\": $json.persona_id, \"source_type\": $json.source_type, \"metadata\": $json.metadata}}] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "store_in_qdrant",
      "name": "Store in Qdrant",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1400, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const doc = $('Validate and Prepare').item.json;\nconst embeddingResult = $('Generate Embedding').item.json;\n\n// Parse embedding response\nlet embedding = [];\ntry {\n  if (embeddingResult.embedding) {\n    embedding = embeddingResult.embedding;\n  } else if (embeddingResult.response) {\n    const parsed = JSON.parse(embeddingResult.response);\n    embedding = parsed.embedding || [];\n  }\n} catch (e) {\n  // Generate mock embedding for testing\n  embedding = Array(384).fill(0).map(() => Math.random() * 2 - 1);\n}\n\nreturn {\n  success: true,\n  doc_id: doc.doc_id,\n  persona_id: doc.persona_id,\n  message: `Document ${doc.doc_id} successfully ingested for persona ${doc.persona_id}`,\n  embedding_size: embedding.length,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond_to_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1800, 400]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Test Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Test Defaults": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Validate and Prepare",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate and Prepare": {
      "main": [
        [
          {
            "node": "Prepare Embedding Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Embedding Request": {
      "main": [
        [
          {
            "node": "Generate Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Embedding": {
      "main": [
        [
          {
            "node": "Store in PostgreSQL",
            "type": "main",
            "index": 0
          },
          {
            "node": "Store in Qdrant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store in PostgreSQL": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store in Qdrant": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "personal-digital-twin-data-ingestion"
}