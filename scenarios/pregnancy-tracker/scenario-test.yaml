# Pregnancy Tracker Scenario Test Configuration
# Privacy-first pregnancy tracking with evidence-based information

version: "1.0.0"
scenario: pregnancy-tracker

metadata:
  name: "Pregnancy Tracker Tests"
  description: "Comprehensive test suite for pregnancy tracking with privacy and multi-tenant support"
  tags:
    - health
    - privacy
    - multi-tenant
    - evidence-based
    - search

dependencies:
  required:
    - postgres
    - scenario-authenticator
  optional:
    - redis
    - ollama
    - period-tracker
    - calendar

test_suites:
  - name: "API Health Checks"
    tests:
      - name: "API responds to health check"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/health"
        expected:
          status: 200
          body_contains:
            - "healthy"
            - "pregnancy-tracker"
            - "privacy"
      
      - name: "Database connection verified"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/status"
        expected:
          status: 200
          body_contains:
            - "operational"
            - "connected"
      
      - name: "Encryption enabled"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/health/encryption"
        expected:
          status: 200
          body_contains:
            - "enabled"
            - "aes256"
      
      - name: "Search index healthy"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/search/health"
        expected:
          status: 200
          body_contains:
            - "healthy"

  - name: "Pregnancy Tracking"
    tests:
      - name: "Start new pregnancy tracking"
        type: http
        request:
          method: POST
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/pregnancy/start"
          headers:
            X-User-ID: "test-user-1"
            Content-Type: "application/json"
          body: |
            {
              "lmp_date": "2024-01-01T00:00:00Z",
              "due_date": "2024-10-08T00:00:00Z"
            }
        expected:
          status: 200
          body_contains:
            - "id"
            - "lmp_date"
            - "due_date"
      
      - name: "Get current pregnancy"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/pregnancy/current"
          headers:
            X-User-ID: "test-user-1"
        expected:
          status: 200
          body_contains:
            - "current_week"
            - "ongoing"

  - name: "Week Content and Search"
    tests:
      - name: "Get week 12 information"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/content/week/12"
        expected:
          status: 200
          body_contains:
            - "week"
            - "development"
            - "tips"
      
      - name: "Search for morning sickness"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/search?q=morning+sickness"
        expected:
          status: 200
          body_contains:
            - "title"
            - "snippet"
      
      - name: "Search with no results"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/search?q=xyzabc123notfound"
        expected:
          status: 200
          body_is_array: true

  - name: "Daily Logging"
    tests:
      - name: "Save daily log"
        type: http
        request:
          method: POST
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/logs/daily"
          headers:
            X-User-ID: "test-user-1"
            Content-Type: "application/json"
          body: |
            {
              "weight": 145.5,
              "blood_pressure": "120/80",
              "symptoms": ["nausea", "fatigue"],
              "mood": 7,
              "energy": 5,
              "notes": "Feeling good today"
            }
        expected:
          status: 200
          body_contains:
            - "id"
      
      - name: "Get logs for date range"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/logs/range?start=2024-01-01&end=2024-12-31"
          headers:
            X-User-ID: "test-user-1"
        expected:
          status: 200
          body_is_array: true

  - name: "Appointments"
    tests:
      - name: "Add appointment"
        type: http
        request:
          method: POST
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/appointments"
          headers:
            X-User-ID: "test-user-1"
            Content-Type: "application/json"
          body: |
            {
              "date": "2024-06-15T10:00:00Z",
              "type": "ultrasound",
              "provider": "Dr. Smith",
              "location": "Medical Center",
              "notes": "20-week anatomy scan"
            }
        expected:
          status: 200
          body_contains:
            - "id"
      
      - name: "Get upcoming appointments"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/appointments/upcoming"
          headers:
            X-User-ID: "test-user-1"
        expected:
          status: 200
          body_is_array: true

  - name: "Multi-Tenant Isolation"
    tests:
      - name: "User 2 cannot see User 1 data"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/pregnancy/current"
          headers:
            X-User-ID: "test-user-2"
        expected:
          status: 404
          body_contains:
            - "No active pregnancy"
      
      - name: "User 2 can start their own pregnancy"
        type: http
        request:
          method: POST
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/pregnancy/start"
          headers:
            X-User-ID: "test-user-2"
            Content-Type: "application/json"
          body: |
            {
              "lmp_date": "2024-02-01T00:00:00Z",
              "due_date": "2024-11-08T00:00:00Z"
            }
        expected:
          status: 200
          body_contains:
            - "id"

  - name: "Export Functions"
    tests:
      - name: "Export JSON data"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/export/json"
          headers:
            X-User-ID: "test-user-1"
        expected:
          status: 200
          headers:
            Content-Type: "application/json"
          body_contains:
            - "export_date"
            - "privacy_notice"
      
      - name: "Export PDF report"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/export/pdf"
          headers:
            X-User-ID: "test-user-1"
        expected:
          status: 200
          headers:
            Content-Type: "application/pdf"
      
      - name: "Get emergency card"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_API_PORT}/api/v1/export/emergency-card"
          headers:
            X-User-ID: "test-user-1"
        expected:
          status: 200
          body_contains:
            - "blood_type"

  - name: "CLI Tests"
    tests:
      - name: "CLI help command"
        type: command
        command: "pregnancy-tracker help"
        expected:
          exit_code: 0
          stdout_contains:
            - "Pregnancy Tracker CLI"
            - "Privacy-first"
            - "status"
            - "start"
      
      - name: "CLI status without pregnancy"
        type: command
        command: "PREGNANCY_TRACKER_USER=cli-test-user pregnancy-tracker status"
        expected:
          stdout_contains:
            - "No active pregnancy"
      
      - name: "CLI search function"
        type: command
        command: "pregnancy-tracker search morning sickness"
        expected:
          exit_code: 0
          stdout_contains:
            - "Searching for"
      
      - name: "CLI week info"
        type: command
        command: "pregnancy-tracker week-info 20"
        expected:
          exit_code: 0
          stdout_contains:
            - "Week 20"

  - name: "UI Tests"
    tests:
      - name: "UI server responds"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_UI_PORT}/"
        expected:
          status: 200
          headers:
            Content-Type: "text/html"
          body_contains:
            - "Pregnancy Tracker"
            - "Privacy"
      
      - name: "UI CSS loads"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_UI_PORT}/styles.css"
        expected:
          status: 200
          headers:
            Content-Type: "text/css"
          body_contains:
            - "pregnancy-tracker"
      
      - name: "UI JavaScript loads"
        type: http
        request:
          method: GET
          url: "http://localhost:${PREGNANCY_TRACKER_UI_PORT}/app.js"
        expected:
          status: 200
          headers:
            Content-Type: "application/javascript"
          body_contains:
            - "pregnancy"

validation:
  requirements:
    - "All health checks must pass"
    - "Multi-tenant isolation must be verified"
    - "Search functionality must work"
    - "Data export must be functional"
    - "CLI commands must execute successfully"
    - "UI must be accessible"
  
  privacy_checks:
    - "No external API calls except opted-in features"
    - "All sensitive data encrypted at rest"
    - "User data completely isolated"
    - "Export includes privacy notice"

performance:
  targets:
    - metric: "API response time"
      threshold: "< 200ms for 95%"
    - metric: "Search response time"
      threshold: "< 500ms"
    - metric: "UI load time"
      threshold: "< 2s"
    - metric: "Concurrent users"
      threshold: ">= 10"

success_criteria:
  - "All P0 requirements from PRD implemented"
  - "Search returns evidence-based content"
  - "Multi-tenant isolation working"
  - "Export generates valid files"
  - "Privacy guarantees maintained"