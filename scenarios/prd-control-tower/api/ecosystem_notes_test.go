package main

import (
	"strings"
	"testing"
)

// [REQ:PCT-REQ-INTEGRATION] Build task notes for ecosystem manager integration
func TestBuildTaskNotes(t *testing.T) {
	tests := []struct {
		name       string
		custom     string
		entityType string
		entityName string
		wantBase   string
		wantCustom bool
	}{
		{
			name:       "no custom notes",
			custom:     "",
			entityType: "scenario",
			entityName: "auth-service",
			wantBase:   "Autogenerated from PRD Control Tower for scenario/auth-service. Source PRD: scenarios/auth-service/PRD.md",
			wantCustom: false,
		},
		{
			name:       "with custom notes",
			custom:     "Additional context for this scenario implementation",
			entityType: "scenario",
			entityName: "payment-gateway",
			wantBase:   "Autogenerated from PRD Control Tower for scenario/payment-gateway. Source PRD: scenarios/payment-gateway/PRD.md",
			wantCustom: true,
		},
		{
			name:       "whitespace only custom notes",
			custom:     "   \t\n   ",
			entityType: "resource",
			entityName: "cache-layer",
			wantBase:   "Autogenerated from PRD Control Tower for resource/cache-layer. Source PRD: resources/cache-layer/PRD.md",
			wantCustom: false,
		},
		{
			name:       "custom notes with newlines",
			custom:     "Line 1\nLine 2\nLine 3",
			entityType: "scenario",
			entityName: "analytics",
			wantBase:   "Autogenerated from PRD Control Tower for scenario/analytics. Source PRD: scenarios/analytics/PRD.md",
			wantCustom: true,
		},
		{
			name:       "resource type",
			custom:     "Resource-specific notes",
			entityType: "resource",
			entityName: "database-connector",
			wantBase:   "Autogenerated from PRD Control Tower for resource/database-connector. Source PRD: resources/database-connector/PRD.md",
			wantCustom: true,
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			result := buildTaskNotes(tt.custom, tt.entityType, tt.entityName)

			// Should always contain the base message
			if !strings.Contains(result, tt.wantBase) {
				t.Errorf("buildTaskNotes() missing base message.\nGot: %s\nWant to contain: %s",
					result, tt.wantBase)
			}

			// Check if custom notes are included when expected
			trimmedCustom := strings.TrimSpace(tt.custom)
			if tt.wantCustom {
				if !strings.Contains(result, trimmedCustom) {
					t.Errorf("buildTaskNotes() missing custom notes.\nGot: %s\nWant to contain: %s",
						result, trimmedCustom)
				}
				// Should have newline separator between base and custom
				if !strings.Contains(result, "\n\n") {
					t.Error("buildTaskNotes() should separate base and custom notes with double newline")
				}
			} else {
				// Should only contain base message
				if result != tt.wantBase {
					t.Errorf("buildTaskNotes() = %q, want %q (no custom notes)", result, tt.wantBase)
				}
			}
		})
	}
}
