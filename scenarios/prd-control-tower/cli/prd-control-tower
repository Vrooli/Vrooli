#!/usr/bin/env bash
#
# PRD Control Tower CLI
# Centralized management of Product Requirements Documents
#

set -eo pipefail

# Port detection with precedence: specific env var > auto-detect > generic env var (if valid) > default
detect_api_port() {
    # Priority 1: Scenario-specific environment variable
    if [[ -n "${PRD_CONTROL_TOWER_API_PORT}" ]]; then
        echo "${PRD_CONTROL_TOWER_API_PORT}"
        return
    fi

    # Priority 2: Auto-detect from running process
    local detected_port
    detected_port=$(lsof -ti:18600 -sTCP:LISTEN 2>/dev/null | head -1 || echo "")
    if [[ -n "$detected_port" ]]; then
        echo "18600"
        return
    fi

    # Priority 3: Generic API_PORT (only if in valid range 15000-19999)
    if [[ -n "${API_PORT}" ]] && [[ "${API_PORT}" =~ ^[0-9]+$ ]] && [[ "${API_PORT}" -ge 15000 ]] && [[ "${API_PORT}" -le 19999 ]]; then
        echo "${API_PORT}"
        return
    fi

    # Priority 4: Default port
    echo "18600"
}

API_PORT=$(detect_api_port)
API_URL="http://localhost:${API_PORT}/api/v1"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

cmd_help() {
    cat <<EOF
PRD Control Tower CLI

USAGE:
    prd-control-tower <command> [options]

COMMANDS:
    status              Show service health and statistics
    list-drafts         List all open drafts with metadata
    validate <name>     Validate PRD structure for scenario/resource
    create-draft        Create new draft (interactive wizard)
    publish <draft-id>  Publish draft to PRD.md
    help                Show this help message

EXAMPLES:
    prd-control-tower status
    prd-control-tower list-drafts
    prd-control-tower validate scenario-auditor
    prd-control-tower create-draft
    prd-control-tower publish abc-123

ENVIRONMENT:
    PRD_CONTROL_TOWER_API_PORT    API port (default: 18600)
    API_PORT                      Fallback API port if in range 15000-19999

EOF
}

cmd_status() {
    echo -e "${BLUE}PRD Control Tower Status${NC}"
    echo ""

    # Check API health
    if response=$(curl -s -f "${API_URL}/health" 2>/dev/null); then
        status=$(echo "$response" | jq -r '.status // "unknown"')
        readiness=$(echo "$response" | jq -r '.readiness // false')

        if [[ "$status" == "healthy" ]]; then
            echo -e "${GREEN}✓${NC} API: healthy (port ${API_PORT})"
        elif [[ "$status" == "degraded" ]]; then
            echo -e "${YELLOW}⚠${NC} API: degraded (port ${API_PORT})"
        else
            echo -e "${RED}✗${NC} API: $status (port ${API_PORT})"
        fi

        # Show draft count if available
        if draft_response=$(curl -s -f "${API_URL}/drafts" 2>/dev/null); then
            draft_count=$(echo "$draft_response" | jq '. | length' 2>/dev/null || echo "unknown")
            echo -e "  Drafts: $draft_count"
        fi
    else
        echo -e "${RED}✗${NC} API: not running or unreachable (port ${API_PORT})"
        echo ""
        echo "To start the service:"
        echo "  cd scenarios/prd-control-tower && make start"
        exit 1
    fi
}

cmd_list_drafts() {
    echo -e "${BLUE}Open Drafts${NC}"
    echo ""

    response=$(curl -s -f "${API_URL}/drafts" 2>/dev/null)
    if [[ $? -ne 0 ]]; then
        echo -e "${RED}✗${NC} Failed to fetch drafts (API not running?)"
        exit 1
    fi

    draft_count=$(echo "$response" | jq -r '.total // 0')
    if [[ "$draft_count" -eq 0 ]]; then
        echo "No drafts found"
    else
        echo "$response" | jq -r '.drafts[] | "\(.entity_type)/\(.entity_name) (ID: \(.id), Updated: \(.updated_at))"'
    fi
}

cmd_validate() {
    local name="$1"
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error:${NC} Entity name required"
        echo "Usage: prd-control-tower validate <scenario-name>"
        exit 1
    fi

    echo -e "${BLUE}Validating PRD: ${name}${NC}"
    echo ""

    # Determine if scenario or resource (use VROOLI_ROOT or default)
    local vrooli_root="${VROOLI_ROOT:-${HOME}/Vrooli}"
    local entity_type="scenario"
    if [[ -d "${vrooli_root}/resources/${name}" ]]; then
        entity_type="resource"
    fi

    response=$(curl -s -X POST "${API_URL}/drafts/validate" \
        -H "Content-Type: application/json" \
        -d "{\"entity_type\": \"${entity_type}\", \"entity_name\": \"${name}\"}" 2>/dev/null)

    if [[ $? -ne 0 ]]; then
        echo -e "${RED}✗${NC} Validation failed (API error)"
        exit 1
    fi

    # Check if response contains violations object
    if echo "$response" | jq -e '.violations' &>/dev/null; then
        echo -e "${GREEN}✓${NC} Validation completed"
        echo ""
        echo "Full validation results available via scenario-auditor CLI"
        echo "Run: scenario-auditor audit ${name} --timeout 240"
    else
        echo -e "${RED}✗${NC} Validation failed or no violations data returned"
        echo "$response" | jq -r '.message // "Unknown error"'
    fi
}

cmd_create_draft() {
    echo -e "${BLUE}Create Draft Wizard${NC}"
    echo ""
    echo "This command will be implemented by improvers."
    echo "It will provide an interactive wizard for creating new PRD drafts."
}

cmd_publish() {
    local draft_id="$1"
    if [[ -z "$draft_id" ]]; then
        echo -e "${RED}Error:${NC} Draft ID required"
        echo "Usage: prd-control-tower publish <draft-id>"
        exit 1
    fi

    echo -e "${BLUE}Publishing draft: ${draft_id}${NC}"
    echo ""
    echo "This command will be implemented by improvers."
    echo "It will publish the draft to PRD.md after validation and diff preview."
}

# Main command router
case "${1:-help}" in
    status)
        cmd_status
        ;;
    list-drafts)
        cmd_list_drafts
        ;;
    validate)
        cmd_validate "$2"
        ;;
    create-draft)
        cmd_create_draft
        ;;
    publish)
        cmd_publish "$2"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo -e "${RED}Error:${NC} Unknown command: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
