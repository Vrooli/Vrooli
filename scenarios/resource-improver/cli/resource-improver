#!/usr/bin/env bash
# Resource Improver CLI
# Command-line interface for managing continuous resource improvement

set -euo pipefail

APP_ROOT="${APP_ROOT:-$(builtin cd "${BASH_SOURCE[0]%/*}/../../.." && builtin pwd)}"
SCRIPT_DIR="${APP_ROOT}/scenarios/resource-improver/cli"
CLI_NAME="resource-improver"
VERSION="1.0.0"

# API URL - must be provided via environment
if [[ -z "${API_PORT:-}" ]]; then
    echo "Error: API_PORT environment variable is required" >&2
    exit 1
fi
API_URL="${RESOURCE_IMPROVER_API_URL:-http://localhost:${API_PORT}}"

# Color codes for styling
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Banner
show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                                                                       
    ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
    ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
                                                                    
                üîß Continuous Resource Improvement System v${VERSION} üîß
EOF
    echo -e "${NC}"
}

# Error handling
error() {
    echo -e "${RED}‚ùå Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

info() {
    echo -e "${CYAN}‚ÑπÔ∏è  $1${NC}"
}

warn() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# Try to get API port from environment
get_api_port() {
    local port=""
    
    # Try various environment variables
    if [[ -n "${API_PORT:-}" ]]; then
        port="$API_PORT"
    elif [[ -n "${RESOURCE_IMPROVER_PORT:-}" ]]; then
        port="$RESOURCE_IMPROVER_PORT"
    else
        # Try to read from service.json
        local service_json="${APP_ROOT}/scenarios/resource-improver/.vrooli/service.json"
        if [[ -f "$service_json" ]] && command -v jq >/dev/null 2>&1; then
            port=$(jq -r '.ports.api.fallback // empty' "$service_json" 2>/dev/null || echo "")
        fi
    fi
    
    if [[ -z "$port" ]]; then
        port="15001" # Default fallback
    fi
    
    echo "$port"
}

# API helper functions
api_get() {
    local endpoint="$1"
    local port
    port=$(get_api_port)
    local url="http://localhost:${port}${endpoint}"
    
    curl -s "$url" || error "Failed to connect to API at $url"
}

api_post() {
    local endpoint="$1"
    local data="$2"
    local port
    port=$(get_api_port)
    local url="http://localhost:${port}${endpoint}"
    
    curl -s -X POST -H "Content-Type: application/json" -d "$data" "$url" || error "Failed to post to API at $url"
}

api_delete() {
    local endpoint="$1"
    local port
    port=$(get_api_port)
    local url="http://localhost:${port}${endpoint}"
    
    curl -s -X DELETE "$url" || error "Failed to delete via API at $url"
}

# Check if API is available
check_api() {
    local port
    port=$(get_api_port)
    local url="http://localhost:${port}/health"
    
    if ! curl -s "$url" > /dev/null 2>&1; then
        error "Resource Improver API is not running at $url. Please start it first with: vrooli scenario resource-improver develop"
    fi
}

# Command implementations
cmd_status() {
    info "Checking Resource Improver status..."
    check_api
    
    local health_response
    health_response=$(api_get "/health")
    
    if echo "$health_response" | jq -r '.status' | grep -q "healthy"; then
        success "Resource Improver API is healthy"
        local port
        port=$(get_api_port)
        info "API URL: http://localhost:${port}"
        
        # Show queue status
        echo
        info "Queue Status:"
        local queue_status
        queue_status=$(api_get "/api/queue/status")
        echo "$queue_status" | jq -r '"  Pending: \(.pending), In Progress: \(.in_progress), Completed: \(.completed), Failed: \(.failed)"'
        
        # Show resource health summary
        echo
        info "Resource Health Summary:"
        echo "$health_response" | jq -r '.resources[] | "  \(.name): \(.health) (v2.0: \(.v2_compliance_score // 0)%, reliability: \(.health_reliability // 0)%)"'
    else
        error "Resource Improver API is unhealthy"
    fi
}

cmd_list_resources() {
    info "Listing available resources for improvement..."
    check_api
    
    local resources
    resources=$(api_get "/api/resources/list")
    
    echo "$resources" | jq -r '.resources[] | "üì¶ \(.name): \(.status) (v2.0: \(.v2_compliance_score)%, health: \(.health_reliability)%)"'
}

cmd_analyze() {
    local resource_name="$1"
    
    if [[ -z "$resource_name" ]]; then
        error "Resource name is required. Usage: $CLI_NAME analyze <resource-name>"
    fi
    
    info "Analyzing $resource_name for improvement opportunities..."
    check_api
    
    local metrics
    metrics=$(api_get "/api/resource/metrics?resource=$resource_name")
    
    echo -e "${MAGENTA}üìä Resource Analysis: $resource_name${NC}"
    echo "$metrics" | jq -r '"
v2.0 Compliance Score: \(.metrics.v2_compliance_score)%
Health Reliability: \(.metrics.health_reliability)%  
CLI Coverage: \(.metrics.cli_coverage)%
Documentation: \(.metrics.doc_completeness)%
Overall Status: \(.metrics.status)

üîß Recommendations:"'
    
    echo "$metrics" | jq -r '.metrics.recommendations[]' | sed 's/^/  ‚Ä¢ /'
}

cmd_submit() {
    local title=""
    local description=""
    local type="improvement"
    local target=""
    local priority="medium"
    
    # Parse command line options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --title)
                title="$2"
                shift 2
                ;;
            --description)
                description="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            --target)
                target="$2"
                shift 2
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            *)
                error "Unknown option: $1"
                ;;
        esac
    done
    
    if [[ -z "$title" || -z "$target" ]]; then
        error "Title and target are required. Usage: $CLI_NAME submit --title 'Fix health checks' --target postgres"
    fi
    
    info "Submitting improvement request..."
    check_api
    
    local payload
    payload=$(jq -n \
        --arg title "$title" \
        --arg description "$description" \
        --arg type "$type" \
        --arg target "$target" \
        --arg priority "$priority" \
        '{
            title: $title,
            description: $description,
            type: $type,
            target: $target,
            priority: $priority
        }')
    
    local response
    response=$(api_post "/api/improvement/submit" "$payload")
    
    if echo "$response" | jq -r '.status' | grep -q "created"; then
        success "Improvement submitted successfully"
        echo "$response" | jq -r '"Item ID: \(.item_id)"'
    else
        error "Failed to submit improvement"
    fi
}

cmd_queue() {
    local action="${1:-status}"
    
    case "$action" in
        status)
            info "Queue Status:"
            check_api
            local queue_status
            queue_status=$(api_get "/api/queue/status")
            echo "$queue_status" | jq -r '"
üì• Pending: \(.pending)
‚ö° In Progress: \(.in_progress)  
‚úÖ Completed: \(.completed)
‚ùå Failed: \(.failed)
üìä Total: \(.total)"'
            ;;
        start)
            info "Starting next improvement..."
            check_api
            local result
            result=$(api_post "/api/improvement/start" "{}")
            
            if echo "$result" | jq -r '.status' | grep -q "started"; then
                success "Improvement started"
                echo "$result" | jq -r '"Working on: \(.item.title)"'
            elif echo "$result" | jq -r '.status' | grep -q "no_work"; then
                info "No pending improvements in queue"
            else
                error "Failed to start improvement"
            fi
            ;;
        *)
            error "Unknown queue action: $action. Use 'status' or 'start'"
            ;;
    esac
}

cmd_compliance() {
    local resource_name="${1:-all}"
    
    if [[ "$resource_name" == "all" ]]; then
        info "Checking v2.0 compliance for all resources..."
        check_api
        local resources
        resources=$(api_get "/api/resources/list")
        
        echo -e "${BLUE}üìã v2.0 Compliance Report${NC}"
        echo "$resources" | jq -r '.resources[] | "üì¶ \(.name): \(.v2_compliance_score)% (\(if .v2_compliance_score >= 90 then "‚úÖ PASS" elif .v2_compliance_score >= 70 then "‚ö†Ô∏è  WARN" else "‚ùå FAIL" end))"'
    else
        cmd_analyze "$resource_name"
    fi
}

cmd_validate() {
    local resource_name="$1"
    
    if [[ -z "$resource_name" ]]; then
        error "Resource name is required. Usage: $CLI_NAME validate <resource-name>"
    fi
    
    info "Validating $resource_name..."
    
    # Check if resource exists
    local resources_dir="${HOME}/Vrooli/resources"
    local resource_path="$resources_dir/$resource_name"
    
    if [[ ! -d "$resource_path" ]]; then
        error "Resource $resource_name not found at $resource_path"
    fi
    
    echo -e "${BLUE}üîç Validating Resource: $resource_name${NC}"
    
    # Check v2.0 contract components
    local score=0
    local max_score=10
    
    echo "üìÅ Directory Structure:"
    if [[ -d "$resource_path/lib" ]]; then
        echo "  ‚úÖ lib/ directory exists"
        ((score++))
        
        # Check for required lib files
        for file in common.sh health.sh lifecycle.sh content.sh; do
            if [[ -f "$resource_path/lib/$file" ]]; then
                echo "  ‚úÖ lib/$file exists"
                ((score++))
            else
                echo "  ‚ùå lib/$file missing"
            fi
        done
    else
        echo "  ‚ùå lib/ directory missing"
    fi
    
    echo
    echo "üìÑ Configuration Files:"
    if [[ -f "$resource_path/service.json" ]]; then
        echo "  ‚úÖ service.json exists"
        ((score++))
    else
        echo "  ‚ùå service.json missing"
    fi
    
    if [[ -f "$resource_path/README.md" ]]; then
        echo "  ‚úÖ README.md exists"
        ((score++))
    else
        echo "  ‚ùå README.md missing"
    fi
    
    echo
    echo "üè• Health Checks:"
    if command -v "resource-$resource_name" >/dev/null 2>&1; then
        echo "  ‚úÖ CLI available"
        ((score++))
        
        if "resource-$resource_name" health >/dev/null 2>&1; then
            echo "  ‚úÖ Health check passes"
            ((score++))
        else
            echo "  ‚ùå Health check fails"
        fi
    else
        echo "  ‚ùå CLI not available"
    fi
    
    echo
    local percentage=$((score * 100 / max_score))
    echo -e "üìä v2.0 Compliance Score: ${percentage}% (${score}/${max_score})"
    
    if [[ $percentage -ge 90 ]]; then
        echo -e "${GREEN}‚úÖ EXCELLENT - Resource is v2.0 compliant${NC}"
    elif [[ $percentage -ge 70 ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  GOOD - Minor improvements needed${NC}"
    elif [[ $percentage -ge 50 ]]; then
        echo -e "${MAGENTA}üîß NEEDS IMPROVEMENT - Several issues to address${NC}"
    else
        echo -e "${RED}‚ùå CRITICAL - Major v2.0 compliance issues${NC}"
    fi
}

# Help text
show_help() {
    show_banner
    cat << EOF

${WHITE}USAGE:${NC}
    $CLI_NAME <command> [options]

${WHITE}COMMANDS:${NC}
    ${GREEN}status${NC}                    Show Resource Improver status and queue summary
    ${GREEN}list${NC}                      List all resources with improvement status  
    ${GREEN}analyze <resource>${NC}        Analyze a specific resource for improvements
    ${GREEN}submit${NC}                    Submit a new improvement request
        ${CYAN}--title <title>${NC}       Title of the improvement
        ${CYAN}--target <resource>${NC}   Target resource name
        ${CYAN}--type <type>${NC}         Type: v2-compliance, health-check, cli-enhancement, documentation
        ${CYAN}--priority <level>${NC}    Priority: critical, high, medium, low
        ${CYAN}--description <desc>${NC}  Description of the improvement
    
    ${GREEN}queue [action]${NC}            Manage improvement queue
        ${CYAN}status${NC}                Show queue status (default)
        ${CYAN}start${NC}                 Start processing next improvement
    
    ${GREEN}compliance [resource]${NC}     Check v2.0 compliance
        ${CYAN}all${NC}                   Check all resources (default)
        ${CYAN}<resource>${NC}           Check specific resource
    
    ${GREEN}validate <resource>${NC}       Validate resource v2.0 compliance locally
    
    ${GREEN}help${NC}                      Show this help message

${WHITE}EXAMPLES:${NC}
    # Check system status
    $CLI_NAME status
    
    # Analyze postgres for improvements  
    $CLI_NAME analyze postgres
    
    # Submit improvement request
    $CLI_NAME submit --title "Add timeout to health checks" --target ollama --type health-check
    
    # Check compliance for all resources
    $CLI_NAME compliance
    
    # Validate a specific resource
    $CLI_NAME validate redis
    
    # Start processing improvements
    $CLI_NAME queue start

${WHITE}ENVIRONMENT:${NC}
    API_PORT                     Resource Improver API port (auto-detected)
    RESOURCE_IMPROVER_API_URL    Full API URL override

${WHITE}FILES:${NC}
    ~/.vrooli/resources/         Resource directory
    ../queue/pending/            Pending improvements
    ../queue/completed/          Completed improvements
    
For more information, visit: https://github.com/Vrooli/Vrooli
EOF
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        status)
            cmd_status "$@"
            ;;
        list)
            cmd_list_resources "$@"
            ;;
        analyze)
            cmd_analyze "$@"
            ;;
        submit)
            cmd_submit "$@"
            ;;
        queue)
            cmd_queue "$@"
            ;;
        compliance)
            cmd_compliance "$@"
            ;;
        validate)
            cmd_validate "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            error "Unknown command: $command. Use '$CLI_NAME help' for usage information."
            ;;
    esac
}

# Run main function
main "$@"