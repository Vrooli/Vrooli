#!/bin/bash

# Agent Dashboard CLI
# Manages and monitors all active agents in the Vrooli system

set -e

# Configuration
SCENARIO_NAME="agent-dashboard"

# Dynamic port discovery
get_api_url() {
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}❌ Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# CLI version
VERSION="1.1.0"

# Function to display help
show_help() {
    cat << EOF
Agent Dashboard CLI v${VERSION}
Codex-native agent management for the Agent Dashboard scenario.

Usage: agent-dashboard <command> [options]

Commands:
    list                     List Codex agents with status summary
    status [id|name]         Show dashboard status or specific agent details
    logs <id|name> [--lines] View recent logs for an agent
    metrics <id|name>        Display process metrics for an agent
    start [options] [task]   Launch a new Codex task (see options below)
    restart <id|name>        Replay the last task for an existing agent
    stop <id|name>           Stop a running agent
    orchestrate [options]    Trigger orchestration task (auto|priority|balanced)
    scan                     Request a manual refresh of the snapshot
    health                   Check API health endpoint
    version                  Show API version information
    help                     Show this help message

Start options:
    --task "text"            Task description (if not provided as trailing args)
    --file path              Load task description from file
    --mode auto|approve|always  Execution mode (default: auto)
    --label "name"           Friendly name for the agent
    --timeout seconds        Override timeout in seconds
    --notes "text"           Additional context passed to Codex

Examples:
    agent-dashboard list
    agent-dashboard start --task "Investigate failing integration tests" --mode approve
    agent-dashboard logs codex:1234 --lines 100
    agent-dashboard orchestrate --mode priority --objective "Stabilize CI failures"

EOF
}

# Function to make API calls
api_call() {
    local endpoint="$1"
    local method="${2:-GET}"
    local data="${3:-}"
    local api_url
    
    api_url=$(get_api_url)
    
    if [ -n "$data" ]; then
        curl -s -X "$method" \
            -H "Content-Type: application/json" \
            -d "$data" \
            "${api_url}/api/v1${endpoint}" 2>/dev/null || echo "{\"error\": \"Failed to connect to API\"}"
    else
        curl -s -X "$method" \
            "${api_url}/api/v1${endpoint}" 2>/dev/null || echo "{\"error\": \"Failed to connect to API\"}"
    fi
}

# List all agents
list_agents() {
    echo -e "${CYAN}Fetching Codex agent snapshot...${NC}"
    response=$(api_call "/agents")

    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi

    total=$(echo "$response" | jq -r '.total // (.agents | length)')
    running=$(echo "$response" | jq -r '.running // 0')
    completed=$(echo "$response" | jq -r '.completed // 0')
    failed=$(echo "$response" | jq -r '.failed // 0')

    echo -e "\n${BLUE}Agents:${NC}"
    printf "%-24s %-10s %-6s %-8s %-22s %-22s\n" "NAME" "STATUS" "MODE" "PID" "UPTIME" "LAST SEEN"
    printf '%*s\n' 96 '' | tr ' ' '-'

    echo "$response" | jq -r '.agents[]? | "\(.name)|\(.status)|\(.mode // \"auto\")|\(.pid // \"-\")|\(.uptime // \"-\")|\(.last_seen // \"-\")"' |
        while IFS='|' read -r name status mode pid uptime last_seen; do
            if [ "$status" = "running" ]; then
                status_color="${GREEN}"
            elif [ "$status" = "completed" ]; then
                status_color="${CYAN}"
            elif [ "$status" = "failed" ]; then
                status_color="${RED}"
            else
                status_color="${YELLOW}"
            fi
            printf "%-24s ${status_color}%-10s${NC} %-6s %-8s %-22s %-22s\n" "$name" "${status^^}" "${mode^^}" "$pid" "$uptime" "$last_seen"
        done

    echo -e "\n${CYAN}Summary:${NC} running=${running} completed=${completed} failed=${failed} total=${total}"
}

# Get agent status
get_status() {
    local agent_name="$1"
    
    if [ -z "$agent_name" ]; then
        echo -e "${RED}Error: Agent name required${NC}"
        show_help
        exit 1
    fi
    
    echo -e "${CYAN}Fetching status for agent: $agent_name${NC}"
    response=$(api_call "/agents/$agent_name")
    
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi
    
    echo -e "\n${BLUE}Agent Status: $agent_name${NC}"
    echo "----------------------------------------"
    local status mode pid uptime start last log_path
    status=$(echo "$response" | jq -r '.status')
    mode=$(echo "$response" | jq -r '.mode // "auto"')
    pid=$(echo "$response" | jq -r '.pid // "-"')
    uptime=$(echo "$response" | jq -r '.uptime // "-"')
    start=$(echo "$response" | jq -r '.start_time // "-"')
    last=$(echo "$response" | jq -r '.last_seen // "-"')
    log_path=$(echo "$response" | jq -r '.log_path // "-"')

    echo "Status: ${status^^}"
    echo "Mode:   ${mode^^}"
    echo "PID:    ${pid}"
    echo "Uptime: ${uptime}"
    echo "Start:  ${start}"
    echo "Last:   ${last}"
    echo "Log:    ${log_path}"
    echo
    echo "Capabilities:"
    echo "$response" | jq -r '.capabilities[]? | "  - " + .' 2>/dev/null || echo "  - none"
}

# Get agent logs
get_logs() {
    local agent_name="$1"
    local lines="${2:-20}"
    
    if [ -z "$agent_name" ]; then
        echo -e "${RED}Error: Agent name required${NC}"
        show_help
        exit 1
    fi
    
    echo -e "${CYAN}Fetching logs for agent: $agent_name (last $lines lines)${NC}"
    response=$(api_call "/agents/$agent_name/logs?lines=$lines")
    
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi
    
    echo -e "\n${BLUE}Logs for $agent_name:${NC}"
    echo "----------------------------------------"
    echo "$response" | jq -r '.logs // .data.logs // [] | .[]'
}

# Get agent metrics
get_metrics() {
    local agent_name="$1"
    
    if [ -z "$agent_name" ]; then
        echo -e "${RED}Error: Agent name required${NC}"
        show_help
        exit 1
    fi
    
    echo -e "${CYAN}Fetching metrics for agent: $agent_name${NC}"
    response=$(api_call "/agents/$agent_name/metrics")
    
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi
    
    echo -e "\n${BLUE}Metrics for $agent_name:${NC}"
    echo "----------------------------------------"
    echo "$response" | jq -r 'to_entries[] | "  \(.key): \(.value)"'
}

# Orchestrate agents
orchestrate() {
    local mode="${1:-auto}"
    
    if [[ ! "$mode" =~ ^(auto|priority|balanced)$ ]]; then
        echo -e "${RED}Error: Invalid orchestration mode. Use: auto, priority, or balanced${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}Triggering agent orchestration in $mode mode...${NC}"
    
    data="{\"mode\": \"$mode\"}"
    response=$(api_call "/orchestrate" "POST" "$data")
    
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi

    echo -e "${GREEN}Orchestration triggered successfully!${NC}"
    echo "$response" | jq '.data // .' 2>/dev/null || echo "$response"
}

# Start agent
start_agent() {
    local mode="auto"
    local label=""
    local timeout=""
    local notes=""
    local task=""
    local task_file=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --mode)
                mode="$2"; shift 2 ;;
            --label)
                label="$2"; shift 2 ;;
            --timeout)
                timeout="$2"; shift 2 ;;
            --task)
                task="$2"; shift 2 ;;
            --file)
                task_file="$2"; shift 2 ;;
            --notes)
                notes="$2"; shift 2 ;;
            --help|-h)
                echo "Usage: agent-dashboard start [--task text] [--file path] [--mode auto] [--label name] [--timeout seconds] [--notes text] [task...]";
                return ;;
            *)
                task+=" $1"; shift ;;
        esac
    done

    task="${task# }"
    if [[ -n "$task_file" ]]; then
        if [[ ! -f "$task_file" ]]; then
            echo -e "${RED}File not found: ${task_file}${NC}"
            exit 1
        fi
        task="$(<"$task_file")"
    fi

    if [[ -z "$task" ]]; then
        echo -e "${RED}Task description required (--task, --file, or trailing args)${NC}"
        exit 1
    fi

    local payload
    payload=$(jq -n \
        --arg task "$task" \
        --arg mode "$mode" \
        --arg label "$label" \
        --arg timeout "$timeout" \
        --arg notes "$notes" '
            {
                task: $task,
                mode: ($mode | ascii_downcase),
                label: ($label | select(length > 0)),
                notes: ($notes | select(length > 0)),
                timeout_seconds: ($timeout | tonumber?)
            } | with_entries(select(.value != null))
        ')

    response=$(api_call "/agents" "POST" "$payload")
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi

    agent_id=$(echo "$response" | jq -r '.data.id')
    agent_name=$(echo "$response" | jq -r '.data.name // .data.id')
    echo -e "${GREEN}Codex agent started: ${agent_name} (${agent_id})${NC}"
}

restart_agent() {
    local agent_name="$1"
    if [ -z "$agent_name" ]; then
        echo -e "${RED}Error: Agent name required${NC}"
        show_help
        exit 1
    fi

    echo -e "${CYAN}Replaying task for agent: $agent_name${NC}"
    local details
    details=$(api_call "/agents/$agent_name")
    local error_msg
    error_msg=$(echo "$details" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi

    local task mode label
    task=$(echo "$details" | jq -r '.task // ""')
    mode=$(echo "$details" | jq -r '.mode // "auto"')
    label=$(echo "$details" | jq -r '.name // ""')

    if [ -z "$task" ]; then
        echo -e "${RED}Agent does not have a stored task to replay${NC}"
        exit 1
    fi

    start_agent --task "$task" --mode "$mode" --label "$label"
}

# Stop agent
stop_agent() {
    local agent_name="$1"
    
    if [ -z "$agent_name" ]; then
        echo -e "${RED}Error: Agent name required${NC}"
        show_help
        exit 1
    fi
    
    echo -e "${CYAN}Stopping agent: $agent_name${NC}"
    response=$(api_call "/agents/$agent_name/stop" "POST")
    
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${RED}Error: $error_msg${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}Agent $agent_name stopped${NC}"
}

# Trigger immediate agent discovery scan
scan_agents() {
    echo -e "${CYAN}Triggering agent discovery scan...${NC}"
    response=$(api_call "/agents/scan" "POST")
    
    error_msg=$(echo "$response" | jq -r '.error // empty')
    if [ -n "$error_msg" ]; then
        echo -e "${YELLOW}$error_msg${NC}"
        exit 0
    fi

    message=$(echo "$response" | jq -r '.data.message // .message // "Scan request processed"')
    echo -e "${CYAN}${message}${NC}"
}

# Check system health
check_health() {
    echo -e "${CYAN}Checking dashboard system health...${NC}"
    local api_url
    api_url=$(get_api_url)
    response=$(curl -s "${api_url}/health" 2>/dev/null || echo "{\"error\": \"Failed to connect to API\"}")
    
    if echo "$response" | grep -q "\"status\":\"healthy\""; then
        echo -e "${GREEN}✓ Dashboard API is healthy${NC}"
        
        # Check resources
        echo -e "\n${BLUE}Resource Status:${NC}"
        echo "$response" | jq -r '
            .resources | to_entries[] | 
            "  \(.key): \(.value.status) (v\(.value.version))"
        ' 2>/dev/null || echo "  No resource data available"
        
    else
        echo -e "${RED}✗ Dashboard API is not healthy${NC}"
        echo "$response" | jq . 2>/dev/null || echo "$response"
        exit 1
    fi
}

# Show version
show_version() {
    echo "Agent Dashboard CLI"
    echo "Version: ${VERSION}"
    echo "Part of the Vrooli automation platform"
}

# Show dashboard status
show_dashboard_status() {
    echo -e "${CYAN}Dashboard Status${NC}"
    echo "----------------------------------------"
    local api_url
    api_url=$(get_api_url 2>/dev/null)
    
    if [ $? -eq 0 ] && [ -n "$api_url" ]; then
        echo -e "API: ${GREEN}Running${NC} at $api_url"
        
        # Check health endpoint
        response=$(curl -s "${api_url}/health" 2>/dev/null)
        if echo "$response" | grep -q "\"status\":\"healthy\""; then
            echo -e "Health: ${GREEN}Healthy${NC}"
        else
            echo -e "Health: ${YELLOW}Degraded${NC}"
        fi
        
        # Get agent count
        agents_response=$(api_call "/agents" 2>/dev/null)
        running=$(echo "$agents_response" | jq -r '.running // 0' 2>/dev/null || echo "0")
        total=$(echo "$agents_response" | jq -r '.total // (.agents | length)' 2>/dev/null || echo "0")
        echo -e "Agents: ${BLUE}${running} running / ${total} total${NC}"
    else
        echo -e "API: ${RED}Not Running${NC}"
        echo "Start with: vrooli scenario run ${SCENARIO_NAME}"
    fi
}

# Main command handler
command="${1:-help}"
shift || true

case "$command" in
    list)
        list_agents
        ;;
    status)
        if [ $# -eq 0 ]; then
            show_dashboard_status
        else
            get_status "$1"
        fi
        ;;
    logs)
        lines=50
        identifier=""
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --lines)
                    lines="$2"; shift 2 ;;
                --help|-h)
                    echo "Usage: agent-dashboard logs <id|name> [--lines N]"
                    exit 0 ;;
                *)
                    identifier="$1"; shift ;;
            esac
        done
        get_logs "$identifier" "$lines"
        ;;
    metrics)
        get_metrics "${1:-}"
        ;;
    start)
        start_agent "$@"
        ;;
    restart)
        restart_agent "${1:-}"
        ;;
    stop)
        stop_agent "${1:-}"
        ;;
    orchestrate)
        orchestrate "$@"
        ;;
    scan)
        scan_agents
        ;;
    health)
        check_health
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h|'')
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$command'${NC}"
        show_help
        exit 1
        ;;
esac
