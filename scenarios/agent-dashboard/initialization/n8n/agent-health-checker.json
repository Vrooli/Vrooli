{
  "name": "Agent Health Checker",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule_trigger",
      "name": "Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "agent-dashboard/health-check",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 500]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 700]
    },
    {
      "parameters": {
        "jsCode": "// Merge all trigger types and set defaults\nconst defaults = {\n  check_type: $json.check_type || 'comprehensive',  // comprehensive, quick, diagnostic\n  agents_to_check: $json.agents_to_check || 'all',  // all, active, specific list\n  include_diagnostics: $json.include_diagnostics !== false,\n  auto_remediation: $json.auto_remediation !== false,\n  alert_threshold: $json.alert_threshold || 'warning'  // info, warning, critical\n};\n\nreturn [{json: defaults}];"
      },
      "id": "prepare_check",
      "name": "Prepare Health Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  a.name,\n  a.type,\n  a.status,\n  a.last_heartbeat,\n  a.metrics::jsonb as metrics,\n  a.resource_usage::jsonb as resource_usage,\n  a.error_count,\n  a.config::jsonb as config,\n  EXTRACT(EPOCH FROM (NOW() - a.last_heartbeat)) as seconds_since_heartbeat\nFROM agent_dashboard.agents a\nWHERE \n  CASE \n    WHEN '{{ $json.agents_to_check }}' = 'all' THEN true\n    WHEN '{{ $json.agents_to_check }}' = 'active' THEN a.status = 'active'\n    ELSE a.name = ANY(STRING_TO_ARRAY('{{ $json.agents_to_check }}', ','))\n  END\nORDER BY a.priority DESC, a.name",
        "options": {}
      },
      "id": "get_agents",
      "name": "Get Agent Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [650, 500],
      "credentials": {
        "postgres": {
          "id": "postgres-agent-dashboard",
          "name": "Agent Dashboard DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const agents = items[0].json;\nconst checkConfig = $('prepare_check').first().json;\n\n// Prepare health check analysis prompt for Ollama\nconst agentSummary = agents.map(a => {\n  const offlineMinutes = Math.round((a.seconds_since_heartbeat || 0) / 60);\n  const status = determineHealthStatus(a);\n  \n  return `- ${a.name} (${a.type}): ${status.toUpperCase()}\n` +\n    `  Status: ${a.status}, Last seen: ${offlineMinutes > 0 ? offlineMinutes + ' min ago' : 'Online'}\n` +\n    `  Errors: ${a.error_count || 0}, CPU: ${a.resource_usage?.cpu || 0}%, Memory: ${a.resource_usage?.memory || 0}%`;\n}).join('\\n');\n\nconst healthPrompt = `You are an agent health monitor performing a ${checkConfig.check_type} health check.\n\nCurrent Agent Status:\n${agentSummary}\n\nBased on this information, provide a health analysis with:\n1. Critical issues that need immediate attention\n2. Recommended actions (restart agents, scale resources, send alerts)\n3. Overall system health score (0-100)\n4. Specific remediation steps for unhealthy agents\n\nProvide response in JSON format with structure:\n{\n  \"critical_issues\": [],\n  \"recommended_actions\": [],\n  \"health_score\": 0,\n  \"remediations\": {},\n  \"summary\": \"\"\n}`;\n\nfunction determineHealthStatus(agent) {\n  const offlineThreshold = 300; // 5 minutes\n  const errorThreshold = 10;\n  const cpuThreshold = 90;\n  const memoryThreshold = 85;\n  \n  if (agent.seconds_since_heartbeat > offlineThreshold) {\n    return 'critical';\n  }\n  if (agent.error_count > errorThreshold) {\n    return 'warning';\n  }\n  if (agent.resource_usage?.cpu > cpuThreshold || agent.resource_usage?.memory > memoryThreshold) {\n    return 'warning';\n  }\n  if (agent.status !== 'active') {\n    return 'info';\n  }\n  return 'healthy';\n}\n\nreturn [{\n  json: {\n    prompt: healthPrompt,\n    model: 'llama3.2:3b',\n    type: 'reasoning',\n    agents_data: agents,\n    check_config: checkConfig\n  }\n}];"
      },
      "id": "prepare_health_analysis",
      "name": "Prepare Health Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 500]
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_ollama', 'string') }}",
        "workflowData": "={{ JSON.stringify({\n  prompt: $json.prompt,\n  model: $json.model,\n  type: $json.type,\n  quiet: true,\n  timeout_seconds: 120\n}) }}",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "call_ollama",
      "name": "Call Shared Ollama",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "jsCode": "const ollamaResponse = items[0].json;\nconst agents = $('get_agents').all()[0].json;\nconst checkConfig = $('prepare_check').first().json;\nconst analysisInput = $('prepare_health_analysis').first().json;\n\n// Parse Ollama response\nlet healthReport;\nlet aiAnalysis = {};\n\ntry {\n  // Extract the actual response from Ollama\n  const responseText = ollamaResponse.response || ollamaResponse.result || ollamaResponse.output || '';\n  \n  // Try to parse JSON from the response\n  const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);  \n  if (jsonMatch) {\n    aiAnalysis = JSON.parse(jsonMatch[0]);\n  }\n} catch (e) {\n  console.error('Failed to parse AI response:', e);\n  aiAnalysis = {\n    critical_issues: [],\n    recommended_actions: [],\n    health_score: 50,\n    remediations: {},\n    summary: 'Analysis failed - using default assessment'\n  };\n}\n\n// Build health status for each agent\nconst agentHealthStatus = agents.map(agent => {\n  const status = determineHealthStatus(agent);\n  const issues = [];\n  const remediations = aiAnalysis.remediations?.[agent.name] || [];\n  \n  // Check for issues\n  if (agent.seconds_since_heartbeat > 300) {\n    issues.push(`Offline for ${Math.round(agent.seconds_since_heartbeat / 60)} minutes`);\n  }\n  if (agent.error_count > 10) {\n    issues.push(`High error count: ${agent.error_count}`);\n  }\n  if (agent.resource_usage?.cpu > 90) {\n    issues.push(`High CPU usage: ${agent.resource_usage.cpu}%`);\n  }\n  if (agent.resource_usage?.memory > 85) {\n    issues.push(`High memory usage: ${agent.resource_usage.memory}%`);\n  }\n  \n  return {\n    name: agent.name,\n    type: agent.type,\n    status: status,\n    operational: status === 'healthy' || status === 'info',\n    issues: issues,\n    remediations_applied: remediations,\n    last_check: new Date().toISOString(),\n    metrics: {\n      uptime_percentage: agent.seconds_since_heartbeat < 300 ? 100 : 0,\n      error_rate: agent.error_count || 0,\n      resource_efficiency: calculateEfficiency(agent.resource_usage)\n    }\n  };\n});\n\n// Generate summary statistics\nconst totalAgents = agentHealthStatus.length;\nconst healthyAgents = agentHealthStatus.filter(a => a.status === 'healthy').length;\nconst warningAgents = agentHealthStatus.filter(a => a.status === 'warning').length;\nconst criticalAgents = agentHealthStatus.filter(a => a.status === 'critical').length;\n\n// Combine AI analysis with actual metrics\nhealthReport = {\n  check_id: crypto.randomUUID(),\n  timestamp: new Date().toISOString(),\n  check_type: checkConfig.check_type,\n  summary: {\n    total_agents: totalAgents,\n    healthy: healthyAgents,\n    warning: warningAgents,\n    critical: criticalAgents,\n    health_score: aiAnalysis.health_score || Math.round((healthyAgents / totalAgents) * 100),\n    all_operational: criticalAgents === 0,\n    ai_summary: aiAnalysis.summary || ''\n  },\n  agent_status: agentHealthStatus,\n  actions_taken: aiAnalysis.recommended_actions || [],\n  recommendations: generateRecommendations(agentHealthStatus, aiAnalysis),\n  next_check: new Date(Date.now() + 5 * 60 * 1000).toISOString()\n};\n\nfunction determineHealthStatus(agent) {\n  const offlineThreshold = 300; // 5 minutes\n  const errorThreshold = 10;\n  const cpuThreshold = 90;\n  const memoryThreshold = 85;\n  \n  if (agent.seconds_since_heartbeat > offlineThreshold) {\n    return 'critical';\n  }\n  if (agent.error_count > errorThreshold) {\n    return 'warning';\n  }\n  if (agent.resource_usage?.cpu > cpuThreshold || agent.resource_usage?.memory > memoryThreshold) {\n    return 'warning';\n  }\n  if (agent.status !== 'active') {\n    return 'info';\n  }\n  return 'healthy';\n}\n\nfunction calculateEfficiency(resourceUsage) {\n  if (!resourceUsage) return 100;\n  const cpu = resourceUsage.cpu || 0;\n  const memory = resourceUsage.memory || 0;\n  // Efficiency is inverse of resource usage\n  return Math.round(100 - ((cpu + memory) / 2));\n}\n\nfunction generateRecommendations(agentStatus, aiAnalysis) {\n  const recommendations = [];\n  \n  // Add AI-generated critical issues as high priority\n  if (aiAnalysis.critical_issues && aiAnalysis.critical_issues.length > 0) {\n    aiAnalysis.critical_issues.forEach(issue => {\n      recommendations.push({\n        priority: 'high',\n        action: issue,\n        reason: 'AI-identified critical issue'\n      });\n    });\n  }\n  \n  const criticalAgents = agentStatus.filter(a => a.status === 'critical');\n  if (criticalAgents.length > 0) {\n    recommendations.push({\n      priority: 'high',\n      action: 'Investigate critical agents',\n      agents: criticalAgents.map(a => a.name),\n      reason: 'Agents are offline or unresponsive'\n    });\n  }\n  \n  const highResourceAgents = agentStatus.filter(a => \n    a.metrics.resource_efficiency < 30\n  );\n  if (highResourceAgents.length > 0) {\n    recommendations.push({\n      priority: 'medium',\n      action: 'Optimize resource allocation',\n      agents: highResourceAgents.map(a => a.name),\n      reason: 'High resource consumption detected'\n    });\n  }\n  \n  const errorProneAgents = agentStatus.filter(a => \n    a.metrics.error_rate > 10\n  );\n  if (errorProneAgents.length > 0) {\n    recommendations.push({\n      priority: 'medium',\n      action: 'Review error logs',\n      agents: errorProneAgents.map(a => a.name),\n      reason: 'Elevated error rates detected'\n    });\n  }\n  \n  return recommendations;\n}\n\nreturn [{json: healthReport}];"
      },
      "id": "compile_health_report",
      "name": "Compile Health Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_dashboard.health_checks \n  (id, check_type, summary, agent_status, actions_taken, recommendations, created_at) \nVALUES \n  ($1, $2, $3, $4, $5, $6, CURRENT_TIMESTAMP) \nRETURNING id",
        "additionalFields": {
          "queryParams": "={{ $json.check_id }},={{ $json.check_type }},={{ JSON.stringify($json.summary) }},={{ JSON.stringify($json.agent_status) }},={{ JSON.stringify($json.actions_taken) }},={{ JSON.stringify($json.recommendations) }}"
        },
        "options": {}
      },
      "id": "log_health_check",
      "name": "Log Health Check",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1450, 500],
      "credentials": {
        "postgres": {
          "id": "postgres-agent-dashboard",
          "name": "Agent Dashboard DB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.summary.health_score }}",
              "rightValue": 50,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "check_alert_needed",
      "name": "Alert Needed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1650, 500]
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_smart-notification-router', 'string') }}",
        "workflowData": "={{ JSON.stringify({\n  notification: {\n    type: 'health_alert',\n    priority: $json.summary.critical > 0 ? 'critical' : 'warning',\n    title: `Agent Health Alert: ${$json.summary.critical} critical, ${$json.summary.warning} warning`,\n    message: `Health check detected issues. Score: ${$json.summary.health_score}%`,\n    details: {\n      check_id: $json.check_id,\n      summary: $json.summary,\n      critical_agents: $json.agent_status.filter(a => a.status === 'critical'),\n      recommendations: $json.recommendations\n    },\n    channels: ['dashboard', 'slack', 'pagerduty'],\n    recipients: ['ops-team', 'on-call']\n  }\n}) }}",
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "send_alert",
      "name": "Send Alert",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "set",
        "key": "agent_health:latest",
        "value": "={{ JSON.stringify($json) }}",
        "keyType": "automatic",
        "expire": true,
        "ttl": 600,
        "options": {}
      },
      "id": "cache_health_status",
      "name": "Cache Health Status",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1850, 600],
      "credentials": {
        "redis": {
          "id": "redis-agent-dashboard",
          "name": "Agent Dashboard Redis"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const healthReport = $('compile_health_report').first().json;\nconst alertSent = $('send_alert').first()?.json?.success || false;\n\nreturn [{\n  json: {\n    success: true,\n    check_id: healthReport.check_id,\n    message: `Health check completed: ${healthReport.summary.healthy} healthy, ${healthReport.summary.warning} warning, ${healthReport.summary.critical} critical agents`,\n    health_score: healthReport.summary.health_score,\n    all_operational: healthReport.summary.all_operational,\n    alert_sent: alertSent,\n    summary: healthReport.summary,\n    recommendations: healthReport.recommendations.slice(0, 3),\n    next_check: healthReport.next_check,\n    dashboard_url: `/dashboard/health/${healthReport.check_id}`,\n    timestamp: healthReport.timestamp\n  }\n}];"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 500]
    },
    {
      "parameters": {},
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2250, 500]
    }
  ],
  "connections": {
    "Schedule": {
      "main": [
        [
          {
            "node": "Prepare Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Prepare Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Prepare Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Health Check": {
      "main": [
        [
          {
            "node": "Get Agent Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Agent Status": {
      "main": [
        [
          {
            "node": "Prepare Health Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Health Analysis": {
      "main": [
        [
          {
            "node": "Call Shared Ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Shared Ollama": {
      "main": [
        [
          {
            "node": "Compile Health Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compile Health Report": {
      "main": [
        [
          {
            "node": "Log Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Health Check": {
      "main": [
        [
          {
            "node": "Alert Needed?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cache Health Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert Needed?": {
      "main": [
        [
          {
            "node": "Send Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Alert": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Health Status": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "agent-dashboard"
  },
  "id": "agent-health-checker",
  "tags": []
}