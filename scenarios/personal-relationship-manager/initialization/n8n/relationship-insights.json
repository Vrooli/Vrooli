{
  "name": "Relationship Insights",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "relationship-insights"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "contact_id",
              "value": "1"
            }
          ]
        }
      },
      "id": "defaults",
      "name": "Manual Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "command": "vrooli resource postgres query \"SELECT * FROM interactions WHERE contact_id = {{$json.contact_id}} ORDER BY interaction_date DESC LIMIT 50\""
      },
      "id": "get-interactions",
      "name": "Get Interaction History",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const interactions = $input.all().map(item => item.json);\nconst contact_id = $node[\"Webhook\"].json.contact_id || $node[\"Manual Defaults\"].json.contact_id;\n\n// Calculate interaction frequency\nconst now = new Date();\nconst threeMonthsAgo = new Date(now.setMonth(now.getMonth() - 3));\n\nconst recentInteractions = interactions.filter(i => \n  new Date(i.interaction_date) > threeMonthsAgo\n);\n\nconst frequency = recentInteractions.length / 3; // per month\n\n// Analyze sentiment\nconst sentimentCounts = interactions.reduce((acc, i) => {\n  acc[i.sentiment || 'neutral'] = (acc[i.sentiment || 'neutral'] || 0) + 1;\n  return acc;\n}, {});\n\n// Find patterns\nconst interactionTypes = interactions.reduce((acc, i) => {\n  acc[i.interaction_type] = (acc[i.interaction_type] || 0) + 1;\n  return acc;\n}, {});\n\n// Calculate days since last interaction\nconst lastInteraction = interactions[0];\nconst daysSinceContact = lastInteraction ? \n  Math.floor((new Date() - new Date(lastInteraction.interaction_date)) / (1000 * 60 * 60 * 24)) : \n  999;\n\nconst insights = {\n  contact_id: contact_id,\n  total_interactions: interactions.length,\n  monthly_frequency: frequency.toFixed(1),\n  days_since_contact: daysSinceContact,\n  sentiment_breakdown: sentimentCounts,\n  preferred_interaction: Object.keys(interactionTypes).reduce((a, b) => \n    interactionTypes[a] > interactionTypes[b] ? a : b, ''),\n  interaction_types: interactionTypes,\n  recommendation: daysSinceContact > 30 ? \n    \"It's been a while! Consider reaching out.\" : \n    frequency < 1 ? \n      \"Try to connect more frequently to strengthen this relationship.\" :\n      \"You're maintaining regular contact. Keep it up!\"\n};\n\nreturn insights;"
      },
      "id": "analyze-patterns",
      "name": "Analyze Patterns",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "command": "vrooli resource postgres query \"SELECT * FROM milestones WHERE contact_id = {{$json.contact_id}} ORDER BY milestone_date DESC LIMIT 10\""
      },
      "id": "get-milestones",
      "name": "Get Milestones",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            }
          ]
        }
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1050, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get Interaction History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Defaults": {
      "main": [
        [
          {
            "node": "Get Interaction History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Interaction History": {
      "main": [
        [
          {
            "node": "Analyze Patterns",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Patterns": {
      "main": [
        [
          {
            "node": "Get Milestones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Milestones": {
      "main": [
        [
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "relationship-insights"
}