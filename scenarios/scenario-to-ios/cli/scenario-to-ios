#!/bin/bash

# scenario-to-ios - Convert Vrooli scenarios to iOS apps
# Generated by scenario-to-ios

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCENARIO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
API_PORT="${API_PORT:-3670}"
API_URL="http://localhost:${API_PORT}/api/v1/ios"

# Function to display help
show_help() {
    cat << EOF
scenario-to-ios - Convert Vrooli scenarios to native iOS applications

USAGE:
    scenario-to-ios <command> [options]

COMMANDS:
    build <scenario>      Build iOS app from scenario
    testflight <ipa>      Submit IPA to TestFlight
    validate <ipa>        Validate IPA against App Store requirements
    simulator <scenario>  Test scenario in iOS Simulator
    status [build-id]     Show build status
    help                  Show this help message
    version              Show version information

OPTIONS:
    --output <path>       Output path for generated IPA
    --config <path>       Path to custom build configuration
    --device <type>       Target device (iphone/ipad/universal)
    --sign <identity>     Code signing identity
    --provision <path>    Provisioning profile path
    --notes <text>        Release notes for TestFlight
    --groups <list>       TestFlight groups (comma-separated)
    --json               Output in JSON format
    --verbose            Verbose output
    --check-signing      Check code signing status

EXAMPLES:
    # Build iOS app from scenario
    scenario-to-ios build my-scenario --output ./build/

    # Submit to TestFlight
    scenario-to-ios testflight ./build/MyApp.ipa --notes "Bug fixes"

    # Test in simulator
    scenario-to-ios simulator my-scenario --device "iPhone 14"

    # Check build status
    scenario-to-ios status abc123 --json

ENVIRONMENT VARIABLES:
    API_PORT            API server port (default: 3670)
    DEVELOPER_TEAM      Apple Developer Team ID
    XCODE_PATH          Path to Xcode (default: /Applications/Xcode.app)

For more information, visit: https://github.com/Vrooli/scenarios/scenario-to-ios
EOF
}

# Function to check prerequisites
check_prerequisites() {
    echo -e "${BLUE}Checking prerequisites...${NC}"
    
    # Check for Xcode
    if ! command -v xcodebuild &> /dev/null; then
        echo -e "${RED}Error: Xcode is not installed${NC}"
        echo "Please install Xcode from the Mac App Store"
        exit 1
    fi
    
    # Check Xcode version
    XCODE_VERSION=$(xcodebuild -version | head -n 1 | awk '{print $2}')
    echo -e "${GREEN}✓ Xcode ${XCODE_VERSION} found${NC}"
    
    # Check for Swift
    if ! command -v swift &> /dev/null; then
        echo -e "${RED}Error: Swift is not installed${NC}"
        exit 1
    fi
    
    SWIFT_VERSION=$(swift --version | head -n 1 | awk '{print $4}')
    echo -e "${GREEN}✓ Swift ${SWIFT_VERSION} found${NC}"
    
    # Check for valid developer certificate
    if security find-identity -p codesigning -v | grep -q "valid identities found"; then
        echo -e "${GREEN}✓ Valid code signing certificates found${NC}"
    else
        echo -e "${YELLOW}Warning: No valid code signing certificates found${NC}"
        echo "You may need to set up certificates for App Store distribution"
    fi
}

# Function to build iOS app
build_ios_app() {
    local scenario_name="$1"
    shift
    
    local output_path="./build"
    local config_path=""
    local device_type="universal"
    local signing_identity=""
    local provision_profile=""
    
    # Parse additional options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --output)
                output_path="$2"
                shift 2
                ;;
            --config)
                config_path="$2"
                shift 2
                ;;
            --device)
                device_type="$2"
                shift 2
                ;;
            --sign)
                signing_identity="$2"
                shift 2
                ;;
            --provision)
                provision_profile="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}Building iOS app for scenario: ${scenario_name}${NC}"
    
    # Check if scenario exists
    if [ ! -d "../../${scenario_name}" ]; then
        echo -e "${RED}Error: Scenario '${scenario_name}' not found${NC}"
        exit 1
    fi
    
    # Create output directory
    mkdir -p "$output_path"
    
    # Copy template to temporary build directory
    TEMP_DIR=$(mktemp -d)
    cp -r "$SCENARIO_DIR/initialization/templates/ios/" "$TEMP_DIR/"
    
    # Replace placeholders in template
    find "$TEMP_DIR" -type f -name "*.swift" -o -name "*.plist" -o -name "*.html" -o -name "*.pbxproj" | while read file; do
        sed -i '' "s/{{SCENARIO_NAME}}/${scenario_name}/g" "$file"
        sed -i '' "s/{{APP_NAME}}/${scenario_name}/g" "$file"
        sed -i '' "s/{{APP_VERSION}}/1.0.0/g" "$file"
        sed -i '' "s/{{BUILD_NUMBER}}/1/g" "$file"
        sed -i '' "s/{{SCENARIO_URL}}/http:\/\/localhost:3000/g" "$file"
    done
    
    # Copy scenario UI files to www directory
    if [ -d "../../${scenario_name}/ui" ]; then
        cp -r "../../${scenario_name}/ui/"* "$TEMP_DIR/project/www/"
    fi
    
    # Build the Xcode project
    cd "$TEMP_DIR"
    
    echo -e "${BLUE}Running xcodebuild...${NC}"
    
    # Build for simulator first (faster, no signing required)
    xcodebuild -project project.xcodeproj \
        -scheme VrooliScenario \
        -configuration Debug \
        -sdk iphonesimulator \
        -derivedDataPath ./build \
        build
    
    # If signing identity provided, build for device
    if [ -n "$signing_identity" ]; then
        echo -e "${BLUE}Building for device with signing...${NC}"
        
        xcodebuild -project project.xcodeproj \
            -scheme VrooliScenario \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            -archivePath "./build/${scenario_name}.xcarchive" \
            CODE_SIGN_IDENTITY="$signing_identity" \
            archive
        
        # Export IPA
        cat > ExportOptions.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>teamID</key>
    <string>${DEVELOPER_TEAM}</string>
</dict>
</plist>
EOF
        
        xcodebuild -exportArchive \
            -archivePath "./build/${scenario_name}.xcarchive" \
            -exportPath "$output_path" \
            -exportOptionsPlist ExportOptions.plist
        
        echo -e "${GREEN}✓ IPA generated at: ${output_path}/${scenario_name}.ipa${NC}"
    else
        echo -e "${GREEN}✓ Simulator build completed${NC}"
        echo -e "${YELLOW}Note: To create an IPA for device, provide signing identity with --sign${NC}"
    fi
    
    # Cleanup
    cd - > /dev/null
    rm -rf "$TEMP_DIR"
}

# Function to submit to TestFlight
submit_testflight() {
    local ipa_path="$1"
    shift
    
    local release_notes="Bug fixes and improvements"
    local test_groups=""
    
    # Parse additional options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --notes)
                release_notes="$2"
                shift 2
                ;;
            --groups)
                test_groups="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}Submitting to TestFlight: ${ipa_path}${NC}"
    
    # Check if IPA exists
    if [ ! -f "$ipa_path" ]; then
        echo -e "${RED}Error: IPA file not found: ${ipa_path}${NC}"
        exit 1
    fi
    
    # Use altool or Transporter for upload
    if command -v xcrun altool &> /dev/null; then
        echo -e "${BLUE}Uploading with altool...${NC}"
        xcrun altool --upload-app \
            --type ios \
            --file "$ipa_path" \
            --username "${APPLE_ID}" \
            --password "${APP_PASSWORD}"
        
        echo -e "${GREEN}✓ Upload complete. Check App Store Connect for processing status${NC}"
    else
        echo -e "${YELLOW}altool not found. Please use Transporter app for manual upload${NC}"
        echo "Download Transporter from: https://apps.apple.com/app/transporter/id1450874784"
    fi
}

# Function to validate IPA
validate_ipa() {
    local ipa_path="$1"
    
    echo -e "${BLUE}Validating IPA: ${ipa_path}${NC}"
    
    # Check if IPA exists
    if [ ! -f "$ipa_path" ]; then
        echo -e "${RED}Error: IPA file not found: ${ipa_path}${NC}"
        exit 1
    fi
    
    # Unzip IPA to check contents
    TEMP_DIR=$(mktemp -d)
    unzip -q "$ipa_path" -d "$TEMP_DIR"
    
    # Check for required files
    echo -e "${BLUE}Checking IPA structure...${NC}"
    
    if [ -d "$TEMP_DIR/Payload" ]; then
        echo -e "${GREEN}✓ Payload directory found${NC}"
    else
        echo -e "${RED}✗ Payload directory missing${NC}"
    fi
    
    # Find app bundle
    APP_BUNDLE=$(find "$TEMP_DIR/Payload" -name "*.app" -type d | head -n 1)
    
    if [ -n "$APP_BUNDLE" ]; then
        echo -e "${GREEN}✓ App bundle found${NC}"
        
        # Check Info.plist
        if [ -f "$APP_BUNDLE/Info.plist" ]; then
            echo -e "${GREEN}✓ Info.plist found${NC}"
            
            # Extract version info
            /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$APP_BUNDLE/Info.plist"
        else
            echo -e "${RED}✗ Info.plist missing${NC}"
        fi
        
        # Check code signature
        codesign -dvv "$APP_BUNDLE" 2>&1 | grep -E "Signature|TeamIdentifier"
    else
        echo -e "${RED}✗ App bundle not found${NC}"
    fi
    
    # Cleanup
    rm -rf "$TEMP_DIR"
    
    echo -e "${BLUE}Validation complete${NC}"
}

# Function to test in simulator
test_simulator() {
    local scenario_name="$1"
    shift
    
    local device_type="iPhone 14"
    local ios_version=""
    
    # Parse additional options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --device)
                device_type="$2"
                shift 2
                ;;
            --ios-version)
                ios_version="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}Testing ${scenario_name} in iOS Simulator${NC}"
    
    # List available simulators
    echo -e "${BLUE}Available simulators:${NC}"
    xcrun simctl list devices
    
    # Find or create simulator
    SIMULATOR_ID=$(xcrun simctl list devices | grep "$device_type" | head -n 1 | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}')
    
    if [ -z "$SIMULATOR_ID" ]; then
        echo -e "${RED}Error: Simulator '${device_type}' not found${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}Using simulator: ${device_type} (${SIMULATOR_ID})${NC}"
    
    # Boot simulator
    xcrun simctl boot "$SIMULATOR_ID" 2>/dev/null || true
    
    # Build and install app
    build_ios_app "$scenario_name" --output /tmp/ios-build
    
    # Open Simulator app
    open -a Simulator
    
    echo -e "${GREEN}✓ Simulator launched. App should be installing...${NC}"
}

# Function to show status
show_status() {
    local build_id="$1"
    
    if [ -n "$build_id" ]; then
        echo -e "${BLUE}Checking status for build: ${build_id}${NC}"
        curl -s "${API_URL}/status/${build_id}" | jq .
    else
        echo -e "${BLUE}iOS Builder Status${NC}"
        check_prerequisites
    fi
}

# Function to show version
show_version() {
    echo "scenario-to-ios version 1.0.0"
    echo "Xcode: $(xcodebuild -version | head -n 1)"
    echo "Swift: $(swift --version | head -n 1)"
}

# Main command dispatcher
case "${1:-}" in
    build)
        check_prerequisites
        build_ios_app "$2" "${@:3}"
        ;;
    testflight)
        submit_testflight "$2" "${@:3}"
        ;;
    validate)
        validate_ipa "$2"
        ;;
    simulator)
        check_prerequisites
        test_simulator "$2" "${@:3}"
        ;;
    status)
        show_status "$2"
        ;;
    version)
        show_version
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '${1}'${NC}"
        echo "Run 'scenario-to-ios help' for usage information"
        exit 1
        ;;
esac