{
  "name": "Semantic Analyzer",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "semantic-analyzer"
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "query",
              "value": "={{ $json[\"query\"] }}"
            },
            {
              "name": "collection",
              "value": "={{ $json[\"collection\"] || \"vrooli_knowledge\" }}"
            },
            {
              "name": "limit",
              "value": "={{ $json[\"limit\"] || 10 }}"
            }
          ]
        }
      },
      "id": "prepare-query",
      "name": "Prepare Query",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.WORKFLOW_IDS.ollama }}",
        "body": {
          "text": "={{ $json[\"query\"] }}",
          "model": "nomic-embed-text",
          "task": "embedding"
        }
      },
      "id": "get-embedding",
      "name": "Get Query Embedding",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://localhost:{{ $env.RESOURCE_PORTS.qdrant }}/collections/{{ $json[\"collection\"] }}/points/search",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "vector",
              "value": "={{ $json[\"embedding\"] }}"
            },
            {
              "name": "limit",
              "value": "={{ $json[\"limit\"] }}"
            },
            {
              "name": "with_payload",
              "value": "true"
            },
            {
              "name": "with_vector",
              "value": "false"
            }
          ]
        }
      },
      "id": "search-qdrant",
      "name": "Search Qdrant",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Process search results\nconst results = $input.all()[0].json.result || [];\nconst query = items[0].json.query;\n\n// Analyze semantic relationships\nconst processedResults = results.map(result => {\n  const score = result.score || 0;\n  const payload = result.payload || {};\n  \n  // Determine relationship type based on score\n  let relationship = 'related';\n  if (score > 0.9) relationship = 'highly_similar';\n  else if (score > 0.8) relationship = 'similar';\n  else if (score > 0.7) relationship = 'somewhat_related';\n  else if (score > 0.5) relationship = 'loosely_related';\n  \n  return {\n    id: result.id,\n    score: Number(score.toFixed(3)),\n    content: payload.content || '',\n    metadata: {\n      source: payload.source || 'unknown',\n      scenario: payload.scenario || null,\n      timestamp: payload.timestamp || null,\n      quality: payload.quality_score || null\n    },\n    semantic_relationship: relationship,\n    relevance_explanation: `Score ${score.toFixed(2)} indicates ${relationship} to query \"${query}\"`\n  };\n});\n\n// Calculate aggregated insights\nconst avgScore = processedResults.reduce((sum, r) => sum + r.score, 0) / Math.max(1, processedResults.length);\nconst sources = [...new Set(processedResults.map(r => r.metadata.source))];\nconst scenarios = [...new Set(processedResults.map(r => r.metadata.scenario).filter(s => s))];\n\nreturn [{\n  json: {\n    query: query,\n    results: processedResults,\n    insights: {\n      total_results: processedResults.length,\n      average_relevance: Number(avgScore.toFixed(3)),\n      unique_sources: sources.length,\n      involved_scenarios: scenarios,\n      knowledge_coverage: sources.length > 3 ? 'comprehensive' : sources.length > 1 ? 'moderate' : 'limited'\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "analyze-results",
      "name": "Analyze Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO knowledge_observatory.search_history \n  (query, collection, result_count, avg_score, response_time_ms)\nVALUES ($1, $2, $3, $4, $5);",
        "additionalFields": {
          "queryParams": "={{ $json[\"query\"] }},{{ $json[\"collection\"] }},={{ $json[\"insights\"][\"total_results\"] }},{{ $json[\"insights\"][\"average_relevance\"] }},{{ $json[\"response_time\"] || 0 }}"
        }
      },
      "id": "log-search",
      "name": "Log Search",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1250, 300],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Postgres"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            }
          ]
        },
        "options": {}
      },
      "id": "format-output",
      "name": "Format Output",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1450, 300]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [[{"node": "prepare-query", "type": "main", "index": 0}]]
    },
    "prepare-query": {
      "main": [[{"node": "get-embedding", "type": "main", "index": 0}]]
    },
    "get-embedding": {
      "main": [[{"node": "search-qdrant", "type": "main", "index": 0}]]
    },
    "search-qdrant": {
      "main": [[{"node": "analyze-results", "type": "main", "index": 0}]]
    },
    "analyze-results": {
      "main": [[{"node": "log-search", "type": "main", "index": 0}]]
    },
    "log-search": {
      "main": [[{"node": "format-output", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {},
  "id": "semantic-analyzer"
}