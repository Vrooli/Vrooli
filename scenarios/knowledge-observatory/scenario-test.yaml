version: 1.0
scenario: knowledge-observatory

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/knowledge-observatory
    - cli/install.sh
    - initialization/postgres/schema.sql
    - initialization/postgres/seed.sql
    - initialization/n8n/knowledge-quality-monitor.json
    - initialization/n8n/semantic-analyzer.json
    - initialization/n8n/knowledge-graph-builder.json
    - ui/index.html
    - ui/script.js
    - ui/server.js
    - ui/package.json
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/n8n
    - initialization/postgres
    - ui
    - data
    - test

# Resource validation
resources:
  required: 
    - qdrant
    - postgres
  optional: 
    - n8n
    - ollama
  health_timeout: 60

# Declarative tests
tests:
  # Resource health checks
  - name: "Qdrant is accessible"
    type: http
    service: qdrant
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "PostgreSQL is accessible"
    type: sql
    service: postgres
    query: "SELECT 1"
    expect:
      rows:
        - "?column?": 1
      
  # API endpoint tests
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  - name: "API search endpoint accepts POST"
    type: http
    service: api
    endpoint: /api/v1/knowledge/search
    method: POST
    body:
      query: "test knowledge query"
      limit: 5
    expect:
      status: 200
      body:
        results: []
        
  - name: "API graph endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/knowledge/graph
    method: GET
    expect:
      status: 200
      body:
        nodes: []
        edges: []
        
  - name: "API metrics endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/knowledge/metrics
    method: POST
    body: {}
    expect:
      status: 200
      body:
        metrics: {}
        
  # CLI command tests
  - name: "CLI status command executes"
    type: exec
    command: ./cli/knowledge-observatory status --json
    expect:
      exit_code: 0
      output_contains: ["status", "total_entries"]
      
  - name: "CLI help command works"
    type: exec
    command: ./cli/knowledge-observatory help
    expect:
      exit_code: 0
      output_contains: ["Knowledge Observatory CLI", "Commands:", "search"]
      
  - name: "CLI version command works"
    type: exec
    command: ./cli/knowledge-observatory version
    expect:
      exit_code: 0
      output_contains: ["1.0.0"]
      
  # Database tests
  - name: "Knowledge Observatory schema exists"
    type: sql
    service: postgres
    query: "SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'knowledge_observatory'"
    expect:
      rows:
        - schema_name: knowledge_observatory
        
  - name: "Quality metrics table exists"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = 'knowledge_observatory' AND table_name = 'quality_metrics'"
    expect:
      rows:
        - count: 1
        
  - name: "Initial collections are seeded"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) as count FROM knowledge_observatory.collection_stats"
    expect:
      rows:
        - count: 5  # Based on seed.sql
        
  # UI tests
  - name: "UI server is accessible"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body_contains: ["Knowledge Observatory", "dashboard"]
      
  - name: "UI health endpoint responds"
    type: http
    service: ui
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  # N8n workflow tests (if n8n is available)
  - name: "Knowledge quality monitor workflow exists"
    type: n8n
    workflow: knowledge-quality-monitor
    expect:
      exists: true
      node_count: 8
    condition:
      resource_available: n8n
      
  - name: "Semantic analyzer workflow exists"
    type: n8n
    workflow: semantic-analyzer
    expect:
      exists: true
      node_count: 7
    condition:
      resource_available: n8n
      
  - name: "Knowledge graph builder workflow exists"
    type: n8n
    workflow: knowledge-graph-builder
    expect:
      exists: true
      node_count: 6
    condition:
      resource_available: n8n

# Performance validation
performance:
  - name: "API search response time"
    type: http
    service: api
    endpoint: /api/v1/knowledge/search
    method: POST
    body:
      query: "performance test"
    expect:
      response_time_ms: 500
      
  - name: "Graph generation time"
    type: http
    service: api
    endpoint: /api/v1/knowledge/graph
    method: POST
    body:
      max_nodes: 100
    expect:
      response_time_ms: 2000

# Integration tests
integration:
  - name: "End-to-end search flow"
    steps:
      - type: http
        service: api
        endpoint: /api/v1/knowledge/search
        method: POST
        body:
          query: "integration test"
        expect:
          status: 200
      - type: sql
        service: postgres
        query: "SELECT COUNT(*) as count FROM knowledge_observatory.search_history WHERE query LIKE '%integration%'"
        expect:
          rows:
            - count: 1