#!/bin/bash
# knowledge-observatory - Command-line interface for Knowledge Observatory

set -euo pipefail

readonly CLI_NAME="knowledge-observatory"
readonly CLI_VERSION="1.0.0"
readonly CONFIG_DIR="$HOME/.${CLI_NAME}"
readonly CONFIG_FILE="$CONFIG_DIR/config.json"
readonly SCENARIO_ID="knowledge-observatory"
readonly DEFAULT_TOKEN=""
CONFIG_API_BASE=""
API_BASE=""

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi
    
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" <<JSON
{
  "api_base": "",
  "api_token": "$DEFAULT_TOKEN",
  "output_format": "json",
  "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
JSON
        echo -e "${GREEN}✓${NC} Configuration created at $CONFIG_FILE"
    fi
}

load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        CONFIG_API_BASE=$(jq -r '.api_base // ""' "$CONFIG_FILE" 2>/dev/null || echo "")
        API_TOKEN=$(jq -r '.api_token // ""' "$CONFIG_FILE" 2>/dev/null || echo "")
    else
        CONFIG_API_BASE=""
        API_TOKEN=""
    fi
}

detect_api_port() {
    if command -v vrooli >/dev/null 2>&1; then
        vrooli scenario port "$SCENARIO_ID" API_PORT 2>/dev/null || true
    fi
}

detect_api_base() {
    if [[ -n "${API_BASE_URL:-}" ]]; then
        echo "${API_BASE_URL%/}"
        return 0
    fi

    if [[ -n "${API_PORT:-}" ]]; then
        echo "http://${API_HOST:-localhost}:${API_PORT}/api/v1"
        return 0
    fi

    local detected_port
    detected_port="$(detect_api_port)"
    if [[ -n "$detected_port" ]]; then
        echo "http://localhost:${detected_port}/api/v1"
        return 0
    fi

    return 1
}

normalize_api_base() {
    local value="$1"
    if [[ -z "$value" || "$value" == "null" ]]; then
        return 1
    fi
    echo "${value%/}"
}

resolve_api_base() {
    local candidate

    if candidate=$(normalize_api_base "$1" 2>/dev/null); then
        echo "$candidate"
        return 0
    fi

    local detected
    if detected=$(detect_api_base); then
        echo "$detected"
        return 0
    fi

    return 1
}

api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local url="${API_BASE}${endpoint}"

    if [[ -z "$API_BASE" ]]; then
        echo -e "${RED}✗${NC} API base URL is not configured. Start the scenario via 'vrooli scenario run knowledge-observatory' or run '$CLI_NAME configure api_base <url>'." >&2
        return 1
    fi

    local headers=(-H 'Content-Type: application/json')
    if [[ -n "${API_TOKEN:-}" ]]; then
        headers+=(-H "Authorization: Bearer $API_TOKEN")
    fi

    if [[ -n "$data" ]]; then
        curl -s -X "$method" "${headers[@]}" -d "$data" "$url"
    else
        curl -s -X "$method" "${headers[@]}" "$url"
    fi
}

cmd_status() {
    echo -e "${BLUE}Checking system health...${NC}"
    response=$(api_request GET "/health" || true)
    if [[ -z "$response" ]]; then
        echo -e "${RED}✗${NC} API is not reachable"
        return 1
    fi

    status=$(echo "$response" | jq -r '.status // "unknown"' 2>/dev/null || echo "unknown")
    if [[ "$status" == "healthy" ]]; then
        echo -e "${GREEN}✓${NC} Service is healthy"
    else
        echo -e "${YELLOW}⚠${NC} Service status: $status"
    fi

    echo "$response" | jq -r '
        "  Service: \(.service // "unknown")",
        "  Version: \(.version // "unknown")",
        "  Database: \(.dependencies.database // "unknown")"
    ' 2>/dev/null || true
}

cmd_search() {
    local query="${1:-}"
    shift || true

    local collection=""
    local limit=""
    local threshold=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --collection)
                collection="${2:-}"
                shift 2
                ;;
            --limit)
                limit="${2:-}"
                shift 2
                ;;
            --threshold)
                threshold="${2:-}"
                shift 2
                ;;
            *)
                echo -e "${RED}✗${NC} Unknown option: $1" >&2
                return 1
                ;;
        esac
    done

    if [[ -z "$query" ]]; then
        echo -e "${RED}✗${NC} Query is required" >&2
        return 1
    fi

    local payload
    payload="$(jq -n \
        --arg query "$query" \
        --arg collection "$collection" \
        --arg limit "$limit" \
        --arg threshold "$threshold" \
        '{
            query: $query
        }
        + ( ($collection | length) > 0 ? {collection: $collection} : {} )
        + ( ($limit | length) > 0 ? {limit: ($limit | tonumber)} : {} )
        + ( ($threshold | length) > 0 ? {threshold: ($threshold | tonumber)} : {} )
        ')"

    api_request POST "/knowledge/search" "$payload"
}

cmd_ingest() {
    local namespace=""
    local collection=""
    local visibility=""
    local source=""
    local source_type=""
    local metadata="{}"
    local content=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --namespace)
                namespace="${2:-}"
                shift 2
                ;;
            --collection)
                collection="${2:-}"
                shift 2
                ;;
            --visibility)
                visibility="${2:-}"
                shift 2
                ;;
            --source)
                source="${2:-}"
                shift 2
                ;;
            --source-type)
                source_type="${2:-}"
                shift 2
                ;;
            --metadata)
                metadata="${2:-}"
                shift 2
                ;;
            --content)
                content="${2:-}"
                shift 2
                ;;
            *)
                if [[ -z "$content" ]]; then
                    content="$1"
                    shift
                else
                    echo -e "${RED}✗${NC} Unknown option/extra argument: $1" >&2
                    return 1
                fi
                ;;
        esac
    done

    if [[ -z "$content" && ! -t 0 ]]; then
        content="$(cat)"
    fi

    if [[ -z "$namespace" ]]; then
        echo -e "${RED}✗${NC} --namespace is required" >&2
        return 1
    fi
    if [[ -z "$content" ]]; then
        echo -e "${RED}✗${NC} Content is required (use --content or pipe stdin)" >&2
        return 1
    fi

    local payload
    payload="$(jq -n \
        --arg namespace "$namespace" \
        --arg content "$content" \
        --arg collection "$collection" \
        --arg visibility "$visibility" \
        --arg source "$source" \
        --arg source_type "$source_type" \
        --argjson metadata "$metadata" \
        '{
            namespace: $namespace,
            content: $content,
            metadata: $metadata
        }
        + ( ($collection | length) > 0 ? {collection: $collection} : {} )
        + ( ($visibility | length) > 0 ? {visibility: $visibility} : {} )
        + ( ($source | length) > 0 ? {source: $source} : {} )
        + ( ($source_type | length) > 0 ? {source_type: $source_type} : {} )
        ')"

    api_request POST "/knowledge/records/upsert" "$payload"
}

cmd_ingest_job() {
    local namespace=""
    local collection=""
    local visibility=""
    local source=""
    local source_type=""
    local metadata="{}"
    local content=""
    local chunk_size=""
    local chunk_overlap=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --namespace)
                namespace="${2:-}"
                shift 2
                ;;
            --collection)
                collection="${2:-}"
                shift 2
                ;;
            --visibility)
                visibility="${2:-}"
                shift 2
                ;;
            --source)
                source="${2:-}"
                shift 2
                ;;
            --source-type)
                source_type="${2:-}"
                shift 2
                ;;
            --metadata)
                metadata="${2:-}"
                shift 2
                ;;
            --chunk-size)
                chunk_size="${2:-}"
                shift 2
                ;;
            --chunk-overlap)
                chunk_overlap="${2:-}"
                shift 2
                ;;
            --content)
                content="${2:-}"
                shift 2
                ;;
            *)
                if [[ -z "$content" ]]; then
                    content="$1"
                    shift
                else
                    echo -e "${RED}✗${NC} Unknown option/extra argument: $1" >&2
                    return 1
                fi
                ;;
        esac
    done

    if [[ -z "$content" && ! -t 0 ]]; then
        content="$(cat)"
    fi

    if [[ -z "$namespace" ]]; then
        echo -e "${RED}✗${NC} --namespace is required" >&2
        return 1
    fi
    if [[ -z "$content" ]]; then
        echo -e "${RED}✗${NC} Content is required (use --content or pipe stdin)" >&2
        return 1
    fi

    local payload
    payload="$(jq -n \
        --arg namespace "$namespace" \
        --arg content "$content" \
        --arg collection "$collection" \
        --arg visibility "$visibility" \
        --arg source "$source" \
        --arg source_type "$source_type" \
        --arg chunk_size "$chunk_size" \
        --arg chunk_overlap "$chunk_overlap" \
        --argjson metadata "$metadata" \
        '{
            namespace: $namespace,
            content: $content,
            metadata: $metadata
        }
        + ( ($collection | length) > 0 ? {collection: $collection} : {} )
        + ( ($visibility | length) > 0 ? {visibility: $visibility} : {} )
        + ( ($source | length) > 0 ? {source: $source} : {} )
        + ( ($source_type | length) > 0 ? {source_type: $source_type} : {} )
        + ( ($chunk_size | length) > 0 ? {chunk_size: ($chunk_size | tonumber)} : {} )
        + ( ($chunk_overlap | length) > 0 ? {chunk_overlap: ($chunk_overlap | tonumber)} : {} )
        ')"

    api_request POST "/ingest/jobs" "$payload"
}

cmd_job_status() {
    local job_id="${1:-}"
    if [[ -z "$job_id" ]]; then
        echo -e "${RED}✗${NC} job_id is required" >&2
        return 1
    fi
    api_request GET "/ingest/jobs/${job_id}"
}

cmd_configure() {
    local key="${1:-}"
    local value="${2:-}"

    if [[ -z "$key" ]]; then
        cat "$CONFIG_FILE" | jq '.' 2>/dev/null || cat "$CONFIG_FILE"
        return 0
    fi

    case "$key" in
        api|api_base)
            jq --arg v "$value" '.api_base = $v' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            echo -e "${GREEN}✓${NC} API base set to: $value"
            CONFIG_API_BASE="$value"
            ;;
        token|api_token)
            jq --arg v "$value" '.api_token = $v' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            echo -e "${GREEN}✓${NC} API token updated"
            API_TOKEN="$value"
            ;;
        *)
            echo -e "${RED}✗${NC} Unknown configuration key: $key"
            echo "Valid keys: api_base, api_token"
            return 1
            ;;
    esac
}

cmd_version() {
    echo "$CLI_NAME version $CLI_VERSION"
    if [[ -n "$API_BASE" ]]; then
        echo "API endpoint: $API_BASE"
    else
        echo "API endpoint: (auto-detect when scenario is running)"
    fi
}

cmd_help() {
    cat <<'EOF'
knowledge-observatory - Command-line interface for Knowledge Observatory

Usage: knowledge-observatory <command>

Commands:
    status          Check API and dependency health
    search          Semantic search (calls KO API)
    ingest          Ingest a record (calls KO API write path)
    ingest-job      Enqueue an async document ingest job
    job-status      Get async ingest job status
    configure       View or update CLI configuration
    version         Show CLI version
    help            Show this help message
EOF
}

main() {
    init_config
    load_config

    local command="${1:-help}"
    shift || true

    local env_prefix="$(echo "$CLI_NAME" | tr '[:lower:]' '[:upper:]' | tr -c 'A-Z0-9' '_')"
    local env_api_base_var="${env_prefix}_API_BASE"
    local env_api_token_var="${env_prefix}_API_TOKEN"

    local env_api_base="${!env_api_base_var:-}"
    local env_api_token="${!env_api_token_var:-}"

    if [[ -n "$env_api_token" ]]; then
        API_TOKEN="$env_api_token"
    fi

    if [[ -n "$env_api_base" ]]; then
        API_BASE="${env_api_base%/}"
    fi

    if [[ "$command" == "status" || "$command" == "search" || "$command" == "ingest" || "$command" == "ingest-job" || "$command" == "job-status" ]]; then
        if [[ -z "$API_BASE" ]]; then
            if ! API_BASE=$(resolve_api_base "$CONFIG_API_BASE"); then
                echo -e "${RED}✗${NC} Unable to determine API base URL. Ensure the scenario is running via 'vrooli scenario run $SCENARIO_ID' or configure it with '$CLI_NAME configure api_base <url>'."
                exit 1
            fi
        fi
    fi

    case "$command" in
        status)
            cmd_status
            ;;
        search)
            cmd_search "$@"
            ;;
        ingest)
            cmd_ingest "$@"
            ;;
        ingest-job)
            cmd_ingest_job "$@"
            ;;
        job-status)
            cmd_job_status "$@"
            ;;
        configure|config)
            cmd_configure "$@"
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo -e "${RED}✗${NC} Unknown command: $command"
            echo "Run '$CLI_NAME help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
