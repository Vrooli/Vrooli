{
  "module_id": "payments",
  "title": "Payments & Stripe Integration",
  "priority": "P0",
  "description": "Stripe checkout sessions and webhook handling",
  "requirements": [
    {
      "id": "STRIPE-CONFIG",
      "title": "Stripe environment config",
      "prd_ref": "OT-P0-025",
      "description": "Each landing page includes Stripe keys from environment variables",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service_test.go"
        },
        {
          "type": "code",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service.go (env var enforcement)"
        }
      ],
      "status": "complete",
      "notes": "Env vars: STRIPE_PUBLISHABLE_KEY, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET enforced in stripe_service.go constructor."
    },
    {
      "id": "STRIPE-ROUTES",
      "title": "Stripe routes",
      "prd_ref": "OT-P0-025",
      "description": "Each landing page includes routes for creating checkout sessions and handling webhook events",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service_test.go"
        },
        {
          "type": "code",
          "phase": "business",
          "status": "implemented",
          "ref": "api/stripe_handlers.go"
        }
      ],
      "status": "complete",
      "dependencies": [
        "STRIPE-CONFIG"
      ],
      "notes": "Routes: POST /api/checkout/create, POST /api/webhooks/stripe - implemented with handlers and endpoints"
    },
    {
      "id": "STRIPE-SIG",
      "title": "Webhook signature verification",
      "prd_ref": "OT-P0-025",
      "description": "All webhook endpoints verify Stripe signature before processing",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service_test.go"
        },
        {
          "type": "code",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service.go"
        }
      ],
      "status": "complete",
      "dependencies": [
        "STRIPE-ROUTES"
      ],
      "notes": "HMAC-SHA256 signature verification implemented with proper timing attack protection"
    },
    {
      "id": "SUB-VERIFY",
      "title": "Subscription verification endpoint",
      "prd_ref": "OT-P0-028",
      "description": "Each landing page exposes GET /api/subscription/verify accepting user identity, returning active/inactive/trial/canceled",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service_test.go"
        },
        {
          "type": "code",
          "phase": "business",
          "status": "implemented",
          "ref": "api/stripe_handlers.go & api/stripe_service.go"
        }
      ],
      "status": "complete",
      "notes": "GET /api/subscription/verify endpoint implemented with user identity lookup (email or customer ID)"
    },
    {
      "id": "SUB-CACHE",
      "title": "Verification caching",
      "prd_ref": "OT-P0-028",
      "description": "Subscription verification responses cacheable (short TTL) with max 60s lag from webhook changes",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service_test.go"
        },
        {
          "type": "code",
          "phase": "business",
          "status": "implemented",
          "ref": "api/stripe_service.go (cache age check)"
        }
      ],
      "status": "complete",
      "dependencies": [
        "SUB-VERIFY"
      ],
      "notes": "Cache metadata (cached_at, cache_age_ms) included in response. Warning logged if cache > 60s old"
    },
    {
      "id": "SUB-CANCEL",
      "title": "Subscription cancellation endpoint",
      "prd_ref": "OT-P0-028",
      "description": "API exposes POST /api/subscription/cancel validating user and returning status",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/stripe_service_test.go"
        },
        {
          "type": "code",
          "phase": "business",
          "status": "implemented",
          "ref": "api/stripe_service.go & api/stripe_handlers.go"
        }
      ],
      "status": "complete",
      "dependencies": [
        "SUB-VERIFY"
      ],
      "notes": "POST /api/subscription/cancel endpoint implemented with user validation and status update"
    }
  ],
  "_metadata": {}
}
