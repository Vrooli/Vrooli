#!/bin/bash

# Chart Generator CLI
# Professional data visualization command-line interface

set -euo pipefail

# Configuration
DEFAULT_API_PORT="${CHART_API_PORT:-20300}"
DEFAULT_API_HOST="${CHART_API_HOST:-localhost}"
API_BASE="http://${DEFAULT_API_HOST}:${DEFAULT_API_PORT}/api/v1"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored output
print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_success() { echo -e "${GREEN}âœ“${NC} $1"; }
print_warning() { echo -e "${YELLOW}âš ${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }

# Show usage information
show_help() {
    cat << EOF
ðŸ“Š Chart Generator CLI - Professional Data Visualization

USAGE:
    chart-generator [COMMAND] [OPTIONS]

COMMANDS:
    generate <type>     Generate a chart of specified type
    styles              List available chart styles
    templates           List available chart templates
    status              Show service status
    version             Show CLI version
    help                Show this help message

CHART TYPES:
    bar                 Bar chart (default)
    line                Line chart  
    pie                 Pie chart
    scatter             Scatter plot
    area                Area chart
    gantt               Gantt chart (future)

GENERATE OPTIONS:
    --data <file>       Data file (JSON/CSV) or '-' for stdin
    --style <style>     Chart style (professional, minimal, vibrant)
    --output <dir>      Output directory (default: current directory)
    --format <formats>  Export formats: png,svg,pdf (default: png)
    --width <pixels>    Chart width (default: 800)
    --height <pixels>   Chart height (default: 600)
    --title <text>      Chart title
    --json              Output response as JSON

EXAMPLES:
    # Generate bar chart from JSON file
    chart-generator generate bar --data sales.json --format png,svg

    # Generate line chart from stdin with custom styling
    echo '[{"x":"Jan","y":100},{"x":"Feb","y":150}]' | chart-generator generate line --data - --style vibrant

    # List available styles
    chart-generator styles

    # Check service status
    chart-generator status

    # Generate pie chart with title
    chart-generator generate pie --data market-share.json --title "Market Share 2024"

EOF
}

# Check if API is available
check_api() {
    if ! curl -sf "${API_BASE}/health" >/dev/null 2>&1; then
        print_error "Chart Generator API is not available at ${API_BASE}"
        print_info "Please ensure the service is running: vrooli scenario run chart-generator"
        exit 1
    fi
}

# Get service status
get_status() {
    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    if ! response=$(curl -sf "${API_BASE}/health" 2>/dev/null); then
        if $json_output; then
            echo '{"status":"unavailable","error":"API not responding"}'
        else
            print_error "Chart Generator API is unavailable"
        fi
        exit 1
    fi

    if $json_output; then
        echo "$response"
    else
        local status=$(echo "$response" | jq -r '.status // "unknown"')
        local service=$(echo "$response" | jq -r '.service // "chart-generator"')
        local timestamp=$(echo "$response" | jq -r '.timestamp // "unknown"')
        
        print_success "Chart Generator API is $status"
        print_info "Service: $service"
        print_info "Last check: $timestamp"
        
        # Test generation capability
        if response2=$(curl -sf "${API_BASE}/health/generation" 2>/dev/null); then
            local capabilities=$(echo "$response2" | jq -r '.capabilities[]?' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
            print_info "Capabilities: $capabilities"
        fi
    fi
}

# List available styles
list_styles() {
    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    check_api
    
    if ! response=$(curl -sf "${API_BASE}/styles" 2>/dev/null); then
        print_error "Failed to fetch styles"
        exit 1
    fi

    if $json_output; then
        echo "$response"
    else
        local count=$(echo "$response" | jq -r '.count // 0')
        print_info "Available Chart Styles ($count):"
        echo
        
        echo "$response" | jq -r '.styles[]? | "  \(.name) (\(.id))\n    Category: \(.category)\n    Description: \(.description)\n    Default: \(.is_default)\n"'
    fi
}

# List available templates
list_templates() {
    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    check_api
    
    if ! response=$(curl -sf "${API_BASE}/templates" 2>/dev/null); then
        print_error "Failed to fetch templates"
        exit 1
    fi

    if $json_output; then
        echo "$response"
    else
        local count=$(echo "$response" | jq -r '.count // 0')
        print_info "Available Chart Templates ($count):"
        echo
        
        echo "$response" | jq -r '.templates[]? | "  \(.name) (\(.id))\n    Type: \(.chart_type)\n    Category: \(.category // "general")\n    Description: \(.description)\n"'
    fi
}

# Generate a chart
generate_chart() {
    local chart_type="$1"
    shift

    # Parse arguments
    local data_file=""
    local style="professional"
    local output_dir="."
    local formats="png"
    local width=800
    local height=600
    local title=""
    local json_output=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            --data)
                data_file="$2"
                shift 2
                ;;
            --style)
                style="$2"
                shift 2
                ;;
            --output)
                output_dir="$2"
                shift 2
                ;;
            --format)
                formats="$2"
                shift 2
                ;;
            --width)
                width="$2"
                shift 2
                ;;
            --height)
                height="$2"
                shift 2
                ;;
            --title)
                title="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Validate required parameters
    if [[ -z "$data_file" ]]; then
        print_error "Data file is required. Use --data <file> or --data - for stdin"
        exit 1
    fi

    # Validate chart type
    case "$chart_type" in
        bar|line|pie|scatter|area|gantt|heatmap|treemap)
            ;;
        *)
            print_error "Invalid chart type: $chart_type"
            print_info "Supported types: bar, line, pie, scatter, area, gantt, heatmap, treemap"
            exit 1
            ;;
    esac

    # Read data
    local data
    if [[ "$data_file" == "-" ]]; then
        data=$(cat)
    else
        if [[ ! -f "$data_file" ]]; then
            print_error "Data file not found: $data_file"
            exit 1
        fi
        data=$(cat "$data_file")
    fi

    # Validate JSON data
    if ! echo "$data" | jq . >/dev/null 2>&1; then
        print_error "Invalid JSON data"
        exit 1
    fi

    # Ensure output directory exists
    mkdir -p "$output_dir"

    # Convert formats string to array
    IFS=',' read -ra format_array <<< "$formats"
    local format_json=$(printf '%s\n' "${format_array[@]}" | jq -R . | jq -s .)

    # Build request payload
    local payload=$(jq -n \
        --arg chart_type "$chart_type" \
        --argjson data "$data" \
        --arg style "$style" \
        --argjson export_formats "$format_json" \
        --argjson width "$width" \
        --argjson height "$height" \
        --arg title "$title" \
        '{
            chart_type: $chart_type,
            data: $data,
            style: $style,
            export_formats: $export_formats,
            width: $width,
            height: $height,
            title: $title
        }')

    check_api

    # Make API request
    if ! response=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "${API_BASE}/charts/generate" 2>/dev/null); then
        print_error "Chart generation failed"
        exit 1
    fi

    # Check if generation was successful
    local success=$(echo "$response" | jq -r '.success // false')
    if [[ "$success" != "true" ]]; then
        local error_msg=$(echo "$response" | jq -r '.error.message // "Unknown error"')
        print_error "Chart generation failed: $error_msg"
        exit 1
    fi

    if $json_output; then
        echo "$response"
    else
        local chart_id=$(echo "$response" | jq -r '.chart_id')
        local generation_time=$(echo "$response" | jq -r '.metadata.generation_time_ms // 0')
        local data_points=$(echo "$response" | jq -r '.metadata.data_point_count // 0')
        
        print_success "Chart generated successfully!"
        print_info "Chart ID: $chart_id"
        print_info "Generation time: ${generation_time}ms"
        print_info "Data points: $data_points"
        print_info "Style applied: $style"
        print_info "Output directory: $output_dir"
        
        # List generated files
        echo "$response" | jq -r '.files | to_entries[]? | "  \(.key | ascii_upcase): \(.value)"' | while read -r line; do
            print_info "$line"
        done
    fi
}

# Show version
show_version() {
    echo "Chart Generator CLI v1.0.0"
    echo "Professional data visualization tool"
    
    # Try to get API version
    if response=$(curl -sf "${API_BASE}/health" 2>/dev/null); then
        local api_version=$(echo "$response" | jq -r '.version // "unknown"')
        echo "API version: $api_version"
    fi
}

# Main command dispatcher
main() {
    # Check for required tools
    if ! command -v curl >/dev/null 2>&1; then
        print_error "curl is required but not installed"
        exit 1
    fi
    
    if ! command -v jq >/dev/null 2>&1; then
        print_error "jq is required but not installed"
        exit 1
    fi

    # Handle no arguments
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    # Parse command
    case "$1" in
        generate)
            if [[ $# -lt 2 ]]; then
                print_error "Chart type is required for generate command"
                print_info "Usage: chart-generator generate <type> [options]"
                exit 1
            fi
            generate_chart "${@:2}"
            ;;
        styles)
            list_styles "${@:2}"
            ;;
        templates)
            list_templates "${@:2}"
            ;;
        status)
            get_status "${@:2}"
            ;;
        version)
            show_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $1"
            print_info "Use 'chart-generator help' for usage information"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"