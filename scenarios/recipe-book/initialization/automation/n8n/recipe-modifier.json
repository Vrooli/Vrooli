{
  "name": "Recipe Modifier",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "recipe-modifier"
    },
    {
      "parameters": {
        "content": "## Recipe Modification\nModify recipes for dietary needs",
        "height": 80
      },
      "id": "input-note",
      "name": "Input Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [220, 200]
    },
    {
      "parameters": {
        "functionCode": "const recipe = $input.first().json.recipe;\nconst modificationType = $input.first().json.modification_type || 'vegan';\n\nconst modificationGuides = {\n  vegan: {\n    system: 'You are an expert in vegan cooking. Convert recipes to be 100% plant-based.',\n    instructions: 'Replace all animal products with plant-based alternatives. Maintain flavor and texture as much as possible.'\n  },\n  'gluten-free': {\n    system: 'You are an expert in gluten-free cooking. Adapt recipes to be safe for celiac disease.',\n    instructions: 'Replace all gluten-containing ingredients with gluten-free alternatives. Ensure no cross-contamination risks.'\n  },\n  keto: {\n    system: 'You are an expert in ketogenic cooking. Adapt recipes to be very low carb, high fat.',\n    instructions: 'Reduce carbs to under 20g per serving. Increase healthy fats. Maintain protein levels.'\n  },\n  'dairy-free': {\n    system: 'You are an expert in dairy-free cooking. Remove all dairy products from recipes.',\n    instructions: 'Replace all dairy with non-dairy alternatives like nut milks, coconut cream, or oil.'\n  },\n  'instant-pot': {\n    system: 'You are an expert in pressure cooking. Adapt recipes for Instant Pot.',\n    instructions: 'Convert cooking methods to pressure cooking. Adjust liquid amounts and cooking times appropriately.'\n  },\n  'air-fryer': {\n    system: 'You are an expert in air fryer cooking. Adapt recipes for air fryer.',\n    instructions: 'Convert to air fryer method. Reduce oil, adjust temperature and time for crispy results.'\n  }\n};\n\nconst guide = modificationGuides[modificationType] || modificationGuides.vegan;\n\nconst systemPrompt = guide.system + ' Return the modified recipe in the exact same JSON format as the input.';\n\nconst userPrompt = `Modify this recipe to be ${modificationType}:\\n\\n` +\n  `Original Recipe: ${JSON.stringify(recipe, null, 2)}\\n\\n` +\n  `Instructions: ${guide.instructions}\\n\\n` +\n  `List the changes made in a \"changes_made\" array field.`;\n\nreturn {\n  systemPrompt,\n  userPrompt,\n  originalRecipe: recipe,\n  modificationType\n};"
      },
      "id": "prepare-modification",
      "name": "Prepare Modification",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "${service.n8n.url}/webhook/ollama",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "llama3.2"
            },
            {
              "name": "prompt",
              "value": "={{ $json.userPrompt }}"
            },
            {
              "name": "system",
              "value": "={{ $json.systemPrompt }}"
            },
            {
              "name": "temperature",
              "value": "0.5"
            },
            {
              "name": "format",
              "value": "json"
            }
          ]
        },
        "options": {}
      },
      "id": "call-ollama",
      "name": "Call Ollama Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "const response = $input.first().json;\nconst originalRecipe = $node[\"prepare-modification\"].json.originalRecipe;\nconst modificationType = $node[\"prepare-modification\"].json.modificationType;\n\ntry {\n  // Parse the AI response\n  let modifiedRecipe;\n  if (typeof response === 'string') {\n    modifiedRecipe = JSON.parse(response);\n  } else if (response.response) {\n    modifiedRecipe = JSON.parse(response.response);\n  } else {\n    modifiedRecipe = response;\n  }\n  \n  // Add metadata\n  modifiedRecipe.source = 'modified';\n  modifiedRecipe.parent_recipe_id = originalRecipe.id;\n  modifiedRecipe.modification_type = modificationType;\n  modifiedRecipe.created_at = new Date().toISOString();\n  modifiedRecipe.updated_at = new Date().toISOString();\n  \n  // Update dietary info\n  if (!modifiedRecipe.dietary_info) {\n    modifiedRecipe.dietary_info = [];\n  }\n  \n  // Add modification type to dietary info if not present\n  const dietaryMappings = {\n    'vegan': 'vegan',\n    'gluten-free': 'gluten-free',\n    'keto': 'keto',\n    'dairy-free': 'dairy-free'\n  };\n  \n  if (dietaryMappings[modificationType] && !modifiedRecipe.dietary_info.includes(dietaryMappings[modificationType])) {\n    modifiedRecipe.dietary_info.push(dietaryMappings[modificationType]);\n  }\n  \n  // Extract changes if not already present\n  if (!modifiedRecipe.changes_made) {\n    modifiedRecipe.changes_made = [`Adapted to be ${modificationType}`];\n  }\n  \n  return {\n    success: true,\n    original_recipe: originalRecipe,\n    modified_recipe: modifiedRecipe,\n    modification_type: modificationType,\n    changes_made: modifiedRecipe.changes_made\n  };\n} catch (error) {\n  return {\n    success: false,\n    error: error.message,\n    raw_response: response\n  };\n}"
      },
      "id": "parse-modified",
      "name": "Parse Modified Recipe",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.success }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-success",
      "name": "Check Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "prepare-modification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-modification": {
      "main": [
        [
          {
            "node": "call-ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "call-ollama": {
      "main": [
        [
          {
            "node": "parse-modified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parse-modified": {
      "main": [
        [
          {
            "node": "check-success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-success": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "saveDataSuccessExecution": "all",
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "any"
  },
  "versionId": "1.0.0",
  "id": "recipe-modifier",
  "meta": {
    "templateId": "recipe-modifier"
  },
  "tags": []
}