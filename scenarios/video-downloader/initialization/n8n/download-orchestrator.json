{
  "name": "Download Orchestrator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "orchestrate-downloads",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  action: 'process_queue'\n};"
      },
      "id": "test_defaults",
      "name": "Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  dq.id as queue_id,\n  dq.download_id,\n  dq.position,\n  dq.priority,\n  dq.retry_count,\n  d.url,\n  d.title,\n  d.format,\n  d.quality,\n  d.user_id\nFROM download_queue dq\nJOIN downloads d ON d.id = dq.download_id\nWHERE d.status = 'pending'\nORDER BY dq.priority DESC, dq.position ASC\nLIMIT 5",
        "options": {}
      },
      "id": "get_queue",
      "name": "Get Queue",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [800, 400],
      "credentials": {
        "postgres": {
          "id": "${service.postgres.credentialId}",
          "name": "Postgres"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const queueItem = $input.item.json;\n\nif (!queueItem.download_id) {\n  return { skip: true };\n}\n\nreturn {\n  download_id: queueItem.download_id,\n  url: queueItem.url,\n  quality: queueItem.quality || 'best',\n  format: queueItem.format || 'mp4',\n  user_id: queueItem.user_id,\n  queue_id: queueItem.queue_id,\n  retry_count: queueItem.retry_count\n};"
      },
      "id": "prepare_download",
      "name": "Prepare Download",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "url": "${service.n8n.url}/webhook/process-video",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "download_id",
              "value": "={{ $json.download_id }}"
            },
            {
              "name": "url",
              "value": "={{ $json.url }}"
            },
            {
              "name": "quality",
              "value": "={{ $json.quality }}"
            },
            {
              "name": "format",
              "value": "={{ $json.format }}"
            },
            {
              "name": "user_id",
              "value": "={{ $json.user_id }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "trigger_processor",
      "name": "Trigger Video Processor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const response = $input.item.json;\nconst queueData = $node[\"prepare_download\"].json;\n\nif (response.success) {\n  // Remove from queue on success\n  return {\n    action: 'remove_from_queue',\n    queue_id: queueData.queue_id,\n    download_id: queueData.download_id,\n    status: 'completed'\n  };\n} else if (queueData.retry_count < 3) {\n  // Retry on failure\n  return {\n    action: 'increment_retry',\n    queue_id: queueData.queue_id,\n    download_id: queueData.download_id,\n    retry_count: queueData.retry_count + 1,\n    status: 'retry_scheduled'\n  };\n} else {\n  // Max retries reached\n  return {\n    action: 'mark_failed',\n    queue_id: queueData.queue_id,\n    download_id: queueData.download_id,\n    status: 'failed',\n    error: response.error || 'Max retries exceeded'\n  };\n}"
      },
      "id": "handle_result",
      "name": "Handle Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "value2": "remove_from_queue"
            }
          ]
        }
      },
      "id": "if_remove",
      "name": "If Remove",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1600, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM download_queue WHERE id = {{ $json.queue_id }}",
        "options": {}
      },
      "id": "remove_from_queue",
      "name": "Remove from Queue",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1800, 200],
      "credentials": {
        "postgres": {
          "id": "${service.postgres.credentialId}",
          "name": "Postgres"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE download_queue \nSET retry_count = {{ $json.retry_count }}, \n    scheduled_at = NOW() + INTERVAL '{{ $json.retry_count }} minutes'\nWHERE id = {{ $json.queue_id }}",
        "options": {}
      },
      "id": "update_retry",
      "name": "Update Retry Count",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1800, 400],
      "credentials": {
        "postgres": {
          "id": "${service.postgres.credentialId}",
          "name": "Postgres"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{ "node": "merge", "type": "main", "index": 0 }]]
    },
    "manual_trigger": {
      "main": [[{ "node": "test_defaults", "type": "main", "index": 0 }]]
    },
    "test_defaults": {
      "main": [[{ "node": "merge", "type": "main", "index": 1 }]]
    },
    "merge": {
      "main": [[{ "node": "get_queue", "type": "main", "index": 0 }]]
    },
    "get_queue": {
      "main": [[{ "node": "prepare_download", "type": "main", "index": 0 }]]
    },
    "prepare_download": {
      "main": [[{ "node": "trigger_processor", "type": "main", "index": 0 }]]
    },
    "trigger_processor": {
      "main": [[{ "node": "handle_result", "type": "main", "index": 0 }]]
    },
    "handle_result": {
      "main": [[{ "node": "if_remove", "type": "main", "index": 0 }]]
    },
    "if_remove": {
      "main": [
        [{ "node": "remove_from_queue", "type": "main", "index": 0 }],
        [{ "node": "update_retry", "type": "main", "index": 0 }]
      ]
    },
    "remove_from_queue": {
      "main": [[{ "node": "respond", "type": "main", "index": 0 }]]
    },
    "update_retry": {
      "main": [[{ "node": "respond", "type": "main", "index": 0 }]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "01234567-89ab-cdef-0123-456789abcdef",
  "id": "video-downloader-orchestrator",
  "meta": {
    "instanceId": "${service.n8n.instanceId}"
  },
  "tags": []
}