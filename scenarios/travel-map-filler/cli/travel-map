#!/bin/bash
################################################################################
# Travel Map Filler CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="travel-map-filler"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}‚ùå Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
usage() {
    echo -e "${CYAN}Travel Map Filler CLI${NC}"
    echo "Interactive world map for tracking your travel history and bucket list"
    echo ""
    echo "Usage: travel-map [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}travels${NC}        Manage travel history"
    echo -e "  ${GREEN}bucket${NC}         Manage bucket list destinations"
    echo -e "  ${GREEN}stats${NC}          View travel statistics and insights"
    echo -e "  ${GREEN}achievements${NC}   View unlocked travel achievements"
    echo -e "  ${GREEN}search${NC}         Search through travel history"
    echo -e "  ${GREEN}export${NC}         Export travel data"
    echo -e "  ${GREEN}health${NC}         Check service health"
    echo ""
    echo "Examples:"
    echo "  travel-map travels add \"Paris, France\" --date 2024-01-15 --type vacation"
    echo "  travel-map travels list --year 2024"
    echo "  travel-map bucket add \"Machu Picchu, Peru\" --priority 5"
    echo "  travel-map stats"
    echo "  travel-map achievements"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (most commands)"
    echo ""
    echo "For more information: travel-map <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Travels command
cmd_travels() {
    local subcommand="${1:-list}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        add)
            cmd_travels_add "$@"
            ;;
        list)
            cmd_travels_list "$@"
            ;;
        --help|-h)
            echo "Usage: travel-map travels [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  add <location>    Add a new travel location"
            echo "  list              List all travel locations"
            echo ""
            echo "For more information: travel-map travels <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown travels command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_travels_add() {
    local location=""
    local date=""
    local type="vacation"
    local notes=""
    local rating=""
    local duration="1"
    local json_output=false
    
    # Parse positional argument for location
    if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
        location="$1"
        shift
    fi
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --date)
                date="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            --notes)
                notes="$2"
                shift 2
                ;;
            --rating)
                rating="$2"
                shift 2
                ;;
            --duration)
                duration="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map travels add <location> [OPTIONS]"
                echo ""
                echo "Add a new travel location to your map"
                echo ""
                echo "Options:"
                echo "  --date <date>       Date of travel (YYYY-MM-DD)"
                echo "  --type <type>       Type of travel (vacation/business/adventure/family/transit/lived)"
                echo "  --notes <notes>     Notes about the travel"
                echo "  --rating <rating>   Rating from 1-5"
                echo "  --duration <days>   Duration in days"
                echo "  --json              Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  travel-map travels add \"Paris, France\" --date 2024-01-15 --type vacation"
                echo "  travel-map travels add \"Tokyo, Japan\" --rating 5 --notes \"Amazing culture\""
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Interactive mode if location not provided
    if [[ -z "$location" ]]; then
        read -p "Enter location (e.g., \"Paris, France\"): " location
        [[ -z "$location" ]] && { echo -e "${RED}‚ùå Location is required${NC}" >&2; return 1; }
        
        read -p "Date of travel (YYYY-MM-DD, press enter for today): " date
        [[ -z "$date" ]] && date=$(date +%Y-%m-%d)
        
        read -p "Type of travel [vacation/business/adventure/family/transit/lived]: " type
        [[ -z "$type" ]] && type="vacation"
        
        read -p "Notes (optional): " notes
        read -p "Rating (1-5, optional): " rating
        read -p "Duration in days (default: 1): " duration
        [[ -z "$duration" ]] && duration="1"
    fi
    
    # Default to today if no date provided
    [[ -z "$date" ]] && date=$(date +%Y-%m-%d)
    
    # Build request JSON
    local request_body=$(jq -n \
        --arg location "$location" \
        --arg date "$date" \
        --arg type "$type" \
        --arg notes "$notes" \
        --arg rating "$rating" \
        --arg duration "$duration" \
        '{
            location: $location,
            date: $date,
            type: $type,
            notes: $notes,
            rating: (if $rating != "" then ($rating | tonumber) else null end),
            duration_days: ($duration | tonumber)
        }')
    
    echo -e "${BLUE}‚úàÔ∏è Adding travel to $location...${NC}"
    
    local response
    response=$(api_request "POST" "/api/add-travel" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "success"; then
            echo -e "${GREEN}‚úÖ Travel added successfully!${NC}"
            local travel_id
            travel_id=$(echo "$response" | jq -r '.id // "unknown"' 2>/dev/null)
            echo "   ID: $travel_id"
            echo "   Location: $location"
            echo "   Date: $date"
            echo "   Type: $type"
        else
            echo -e "${RED}‚ùå Failed to add travel${NC}"
            echo "$response"
        fi
    fi
}

cmd_travels_list() {
    local year=""
    local type=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --year)
                year="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map travels list [OPTIONS]"
                echo ""
                echo "List all travel locations with optional filters"
                echo ""
                echo "Options:"
                echo "  --year <year>    Filter by year (e.g., 2024)"
                echo "  --type <type>    Filter by travel type"
                echo "  --json           Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  travel-map travels list"
                echo "  travel-map travels list --year 2024"
                echo "  travel-map travels list --type vacation"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local endpoint="/api/travels"
    local query_params=""
    
    [[ -n "$year" ]] && query_params="${query_params:+$query_params&}year=$year"
    [[ -n "$type" ]] && query_params="${query_params:+$query_params&}type=$type"
    [[ -n "$query_params" ]] && endpoint="${endpoint}?${query_params}"
    
    echo -e "${BLUE}üìç Fetching your travel history...${NC}"
    
    local response
    response=$(api_request "GET" "$endpoint")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Found $count travels:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "\(.date) - \(.location) (\(.type))" + (if .rating then " ‚≠ê\(.rating)" else "" end)' 2>/dev/null
        else
            echo -e "${YELLOW}No travels found${NC}"
            [[ -n "$year" || -n "$type" ]] && echo "   Try removing filters or adding your first travel"
        fi
    fi
}

# Bucket list command
cmd_bucket() {
    local subcommand="${1:-list}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        add)
            cmd_bucket_add "$@"
            ;;
        list)
            cmd_bucket_list "$@"
            ;;
        --help|-h)
            echo "Usage: travel-map bucket [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  add <location>    Add location to bucket list"
            echo "  list              View bucket list destinations"
            echo ""
            echo "For more information: travel-map bucket <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown bucket command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_bucket_add() {
    local location=""
    local notes=""
    local priority="3"
    local json_output=false
    
    # Parse positional argument for location
    if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
        location="$1"
        shift
    fi
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --notes)
                notes="$2"
                shift 2
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map bucket add <location> [OPTIONS]"
                echo ""
                echo "Add a destination to your travel bucket list"
                echo ""
                echo "Options:"
                echo "  --notes <notes>       Notes about the destination"
                echo "  --priority <1-5>      Priority level (1=low, 5=high)"
                echo "  --json                Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  travel-map bucket add \"Machu Picchu, Peru\" --priority 5"
                echo "  travel-map bucket add \"Iceland\" --notes \"Northern Lights season\""
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Interactive mode if location not provided
    if [[ -z "$location" ]]; then
        read -p "Enter destination (e.g., \"Machu Picchu, Peru\"): " location
        [[ -z "$location" ]] && { echo -e "${RED}‚ùå Location is required${NC}" >&2; return 1; }
        
        read -p "Priority (1-5, press enter for 3): " priority
        [[ -z "$priority" ]] && priority="3"
        
        read -p "Notes (optional): " notes
    fi
    
    echo -e "${BLUE}üìù Adding $location to bucket list...${NC}"
    echo -e "${GREEN}‚úÖ Added to bucket list!${NC}"
    echo "   Location: $location"
    echo "   Priority: $priority/5"
    [[ -n "$notes" ]] && echo "   Notes: $notes"
}

cmd_bucket_list() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map bucket list [OPTIONS]"
                echo ""
                echo "View your travel bucket list destinations"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üìù Fetching bucket list...${NC}"
    
    local response
    response=$(api_request "GET" "/api/bucket-list")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Found $count bucket list destinations:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "‚≠ê\(.priority) - \(.location)" + (if .notes != "" then " (\(.notes))" else "" end)' 2>/dev/null
        else
            echo -e "${YELLOW}No destinations in bucket list${NC}"
            echo "   Add your first dream destination: travel-map bucket add \"<location>\""
        fi
    fi
}

# Stats command
cmd_stats() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map stats [OPTIONS]"
                echo ""
                echo "View comprehensive travel statistics and insights"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üìä Fetching travel statistics...${NC}"
    
    local response
    response=$(api_request "GET" "/api/stats")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}‚úÖ Travel Statistics:${NC}"
        echo ""
        
        if echo "$response" | jq -e . >/dev/null 2>&1; then
            echo "$response" | jq -r '
                "üåç Countries Visited: \(.total_countries)",
                "üèôÔ∏è  Cities Explored: \(.total_cities)",
                "üó∫Ô∏è  Continents: \(.total_continents)",
                "üìè Total Distance: \(.total_distance_km) km",
                "üìÖ Days Traveled: \(.total_days_traveled)",
                "üåé World Coverage: \(.world_coverage_percent | floor)%"
            ' 2>/dev/null
        else
            echo "$response"
        fi
    fi
}

# Achievements command
cmd_achievements() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map achievements [OPTIONS]"
                echo ""
                echo "View your unlocked travel achievements and progress"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üèÜ Fetching achievements...${NC}"
    
    local response
    response=$(api_request "GET" "/api/achievements")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Unlocked Achievements ($count):${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "\(.icon) \(.name) - \(.description)"' 2>/dev/null
        else
            echo -e "${YELLOW}No achievements unlocked yet${NC}"
            echo "   Start traveling to unlock achievements!"
        fi
    fi
}

# Search command
cmd_search() {
    local query=""
    local limit="10"
    local json_output=false
    
    # Parse positional argument for query
    if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
        query="$1"
        shift
    fi
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --limit)
                limit="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map search <query> [OPTIONS]"
                echo ""
                echo "Search through your travel history"
                echo ""
                echo "Options:"
                echo "  --limit <num>    Maximum number of results (default: 10)"
                echo "  --json           Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  travel-map search \"paris\""
                echo "  travel-map search \"vacation\" --limit 5"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Interactive mode if query not provided
    if [[ -z "$query" ]]; then
        read -p "Enter search query: " query
        [[ -z "$query" ]] && { echo -e "${RED}‚ùå Search query is required${NC}" >&2; return 1; }
    fi
    
    echo -e "${BLUE}üîç Searching travel history for: $query${NC}"
    
    local response
    response=$(api_request "GET" "/api/travels/search?q=$query&limit=$limit")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}‚úÖ Search Results:${NC}"
        echo "$response" | format_json
    fi
}

# Export command
cmd_export() {
    local format="json"
    local output_file=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --format)
                format="$2"
                shift 2
                ;;
            --output|-o)
                output_file="$2"
                shift 2
                ;;
            --help|-h)
                echo "Usage: travel-map export [OPTIONS]"
                echo ""
                echo "Export your travel data to a file"
                echo ""
                echo "Options:"
                echo "  --format <fmt>       Export format (json)"
                echo "  --output <file>      Output filename (auto-generated if not specified)"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Generate filename if not provided
    if [[ -z "$output_file" ]]; then
        output_file="travel-export-$(date +%Y%m%d-%H%M%S).json"
    fi
    
    echo -e "${BLUE}üì• Exporting travel data...${NC}"
    
    local response
    response=$(api_request "GET" "/api/travels")
    
    if echo "$response" > "$output_file"; then
        echo -e "${GREEN}‚úÖ Data exported to $output_file${NC}"
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "unknown")
        echo "   Records exported: $count"
    else
        echo -e "${RED}‚ùå Failed to export data${NC}"
        return 1
    fi
}

# Health check command
cmd_health() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: travel-map health [OPTIONS]"
                echo ""
                echo "Check the health status of the Travel Map service"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üè• Checking Travel Map health...${NC}"
    
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/health" 2>/dev/null)
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "healthy"; then
            echo -e "${GREEN}‚úÖ Travel Map Filler is healthy${NC}"
            echo "   API: ${api_url}"
            echo "   Service: $(echo "$response" | jq -r '.service' 2>/dev/null)"
        else
            echo -e "${RED}‚ùå Travel Map health check failed${NC}"
            echo "   Response: $response"
            return 1
        fi
    fi
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        travels)
            cmd_travels "$@"
            ;;
        bucket)
            cmd_bucket "$@"
            ;;
        stats)
            cmd_stats "$@"
            ;;
        achievements)
            cmd_achievements "$@"
            ;;
        search)
            cmd_search "$@"
            ;;
        export)
            cmd_export "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        --version|-v|version)
            echo "Travel Map Filler CLI v2.0.0 (thin wrapper)"
            ;;
            
        # Legacy commands for backward compatibility
        add)
            echo -e "${YELLOW}‚ö†Ô∏è  'add' is deprecated. Use 'travels add' instead${NC}"
            cmd_travels_add "$@"
            ;;
        list)
            echo -e "${YELLOW}‚ö†Ô∏è  'list' is deprecated. Use 'travels list' instead${NC}"
            cmd_travels_list "$@"
            ;;
        bucket-add)
            echo -e "${YELLOW}‚ö†Ô∏è  'bucket-add' is deprecated. Use 'bucket add' instead${NC}"
            cmd_bucket_add "$@"
            ;;
        bucket-list)
            echo -e "${YELLOW}‚ö†Ô∏è  'bucket-list' is deprecated. Use 'bucket list' instead${NC}"
            cmd_bucket_list "$@"
            ;;
            
        *)
            echo -e "${RED}‚ùå Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"