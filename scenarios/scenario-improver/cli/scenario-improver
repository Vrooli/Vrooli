#!/bin/bash

# Scenario Improver CLI
# Provides command-line interface to the Scenario Improver API

# Build API URL using environment variables
API_PORT="${SCENARIO_IMPROVER_API_PORT:-${API_PORT}}"
API_HOST="${SCENARIO_IMPROVER_API_HOST:-localhost}"

# Check if port is configured or try to discover it
if [[ -z "$API_PORT" ]]; then
    echo "No API port specified, attempting auto-discovery..."
    
    # Method 1: Check for running scenario-improver-api processes
    DISCOVERED_PORT=$(ps aux | grep scenario-improver-api | grep -o 'API_PORT=[0-9]*' | cut -d'=' -f2 | head -1)
    
    # Method 2: Check common ports for scenario-improver health endpoint
    if [[ -z "$DISCOVERED_PORT" ]]; then
        for port in {30150..30159}; do
            if curl -s --max-time 2 "http://localhost:$port/health" 2>/dev/null | grep -q "scenario-improver\|improver"; then
                DISCOVERED_PORT="$port"
                break
            fi
        done
    fi
    
    # Method 3: Check for any service responding with "healthy" status
    if [[ -z "$DISCOVERED_PORT" ]]; then
        for port in {30150..30159}; do
            if curl -s --max-time 1 "http://localhost:$port/health" 2>/dev/null | grep -q '"status".*"healthy"'; then
                # Verify it's the right service by checking if it has scenario endpoints
                if curl -s --max-time 1 "http://localhost:$port/api/scenarios/list" 2>/dev/null | grep -q "scenarios"; then
                    DISCOVERED_PORT="$port"
                    break
                fi
            fi
        done
    fi
    
    if [[ -n "$DISCOVERED_PORT" ]]; then
        API_PORT="$DISCOVERED_PORT"
        echo "✓ Discovered scenario-improver API on port $API_PORT"
    else
        echo "✗ Could not auto-discover API port."
        echo "Please set SCENARIO_IMPROVER_API_PORT or API_PORT environment variable."
        echo "Example: export SCENARIO_IMPROVER_API_PORT=30150"
        echo ""
        echo "Or start the API first with: cd api && ./start.sh"
        exit 1
    fi
fi

API_URL="${SCENARIO_IMPROVER_API_URL:-http://${API_HOST}:${API_PORT}}"

show_help() {
    cat << EOF
Scenario Improver CLI - Debug and improve Vrooli scenarios

Usage: scenario-improver [command] [options]

Commands:
    health               Check API health status
    scenarios            List all running scenarios  
    queue                Show queue status
    start                Start next improvement from queue
    analyze <scenario>   Analyze scenario for errors
    profile <scenario>   Profile scenario performance
    add <title>          Add improvement task to queue
    help                 Show this help message

Examples:
    scenario-improver scenarios
    scenario-improver analyze scenario-generator-v1
    scenario-improver profile resource-experimenter
    scenario-improver start

Environment:
    SCENARIO_IMPROVER_API_URL    Full API endpoint (overrides host/port)
    SCENARIO_IMPROVER_API_HOST   API host (default: localhost)  
    SCENARIO_IMPROVER_API_PORT   API port (required if not auto-discovered)
    API_PORT                     Alternative API port variable
EOF
}

check_health() {
    echo "Checking Scenario Improver API health..."
    curl -s "${API_URL}/health" | jq '.' 2>/dev/null || echo "API is not responding"
}

list_scenarios() {
    echo "Fetching running scenarios..."
    curl -s "${API_URL}/api/scenarios/list" | jq '.' 2>/dev/null || echo "Failed to fetch scenarios"
}

show_queue_status() {
    echo "Fetching queue status..."
    curl -s "${API_URL}/api/queue/status" | jq '.' 2>/dev/null || echo "Failed to fetch queue status"
}

start_improvement() {
    echo "Starting next improvement from queue..."
    curl -s -X POST "${API_URL}/api/improvement/start" | jq '.' 2>/dev/null || echo "Failed to start improvement"
}

analyze_scenario() {
    local scenario_name="$1"
    
    if [[ -z "$scenario_name" ]]; then
        echo "Error: Scenario name is required"
        echo "Usage: scenario-improver analyze <scenario>"
        exit 1
    fi
    
    echo "Analyzing scenario: $scenario_name..."
    
    # Simulate error report for analysis
    local error_data='{
        "app_name": "'$scenario_name'",
        "error_message": "Manual analysis request",
        "stack_trace": "",
        "context": {"analysis_type": "manual"}
    }'
    
    curl -s -X POST "${API_URL}/api/error/analyze" \
        -H "Content-Type: application/json" \
        -d "$error_data" | \
        jq '.' 2>/dev/null || echo "Failed to analyze scenario"
}

profile_performance() {
    local scenario_name="$1"
    
    if [[ -z "$scenario_name" ]]; then
        echo "Error: Scenario name is required"
        echo "Usage: scenario-improver profile <scenario>"
        exit 1
    fi
    
    echo "Profiling performance for: $scenario_name..."
    curl -s "${API_URL}/api/performance/profile?app=$scenario_name" | jq '.' 2>/dev/null || echo "Failed to profile performance"
}

add_improvement() {
    local title="$1"
    
    if [[ -z "$title" ]]; then
        echo "Error: Improvement title is required"
        echo "Usage: scenario-improver add <title>"
        exit 1
    fi
    
    echo "Adding improvement task: $title"
    echo "Enter description (press Ctrl+D when done):"
    local description
    description=$(cat)
    
    echo "Enter target scenario:"
    read -r target
    
    if [[ -z "$target" ]]; then
        echo "Error: Target scenario is required"
        exit 1
    fi
    
    echo "Enter priority (critical/high/medium/low):"
    read -r priority
    
    echo "Enter type (fix/optimization/feature/documentation):"
    read -r type
    
    # Create JSON payload for API submission
    local json_payload
    json_payload=$(cat << EOF
{
    "title": "$title",
    "description": "$description",
    "type": "${type:-improvement}",
    "target": "$target",
    "priority": "${priority:-medium}",
    "estimates": {
        "impact": 5,
        "urgency": "${priority:-medium}",
        "success_prob": 0.7,
        "resource_cost": "moderate"
    }
}
EOF
)
    
    echo "Submitting improvement to API..."
    
    # Submit via API endpoint
    local response
    response=$(curl -s -X POST "${API_URL}/api/improvement/submit" \
        -H "Content-Type: application/json" \
        -d "$json_payload")
    
    if [[ $? -eq 0 ]]; then
        echo "✅ Improvement submitted successfully!"
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    else
        echo "❌ Failed to submit improvement. Check that the API is running."
        echo "API URL: ${API_URL}/api/improvement/submit"
        exit 1
    fi
}

# Main command handler
case "$1" in
    health)
        check_health
        ;;
    scenarios)
        list_scenarios
        ;;
    queue)
        show_queue_status
        ;;
    start)
        start_improvement
        ;;
    analyze)
        analyze_scenario "$2"
        ;;
    profile)
        profile_performance "$2"
        ;;
    add)
        add_improvement "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [[ -n "$1" ]]; then
            echo "Unknown command: $1"
        fi
        show_help
        exit 1
        ;;
esac