<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tools - Duration Calculator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>⏰ Time Tools</h1>
            <nav>
                <a href="index.html">Dashboard</a>
                <a href="converter.html">Timezone Converter</a>
                <a href="calculator.html" class="active">Duration Calculator</a>
                <a href="scheduler.html">Meeting Scheduler</a>
                <a href="events.html">Events</a>
            </nav>
        </header>

        <main>
            <div class="page-content">
                <h2>⏱️ Duration Calculator</h2>
                
                <div class="calculator-container">
                    <form id="duration-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="start-time">Start Date & Time</label>
                                <input type="datetime-local" id="start-time" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="end-time">End Date & Time</label>
                                <input type="datetime-local" id="end-time" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <select id="timezone" class="form-control">
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">Eastern Time (New York)</option>
                                <option value="America/Chicago">Central Time (Chicago)</option>
                                <option value="America/Denver">Mountain Time (Denver)</option>
                                <option value="America/Los_Angeles">Pacific Time (Los Angeles)</option>
                                <option value="Europe/London">London</option>
                                <option value="Europe/Paris">Paris</option>
                                <option value="Europe/Berlin">Berlin</option>
                                <option value="Asia/Tokyo">Tokyo</option>
                                <option value="Asia/Shanghai">Shanghai</option>
                                <option value="Australia/Sydney">Sydney</option>
                            </select>
                        </div>
                        
                        <div class="form-options">
                            <h3>Calculation Options</h3>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exclude-weekends">
                                    <span class="checkbox-custom"></span>
                                    Exclude weekends
                                </label>
                                
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exclude-holidays">
                                    <span class="checkbox-custom"></span>
                                    Exclude holidays
                                </label>
                                
                                <label class="checkbox-label">
                                    <input type="checkbox" id="business-hours-only">
                                    <span class="checkbox-custom"></span>
                                    Business hours only (9 AM - 5 PM)
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Calculate Duration</button>
                    </form>
                    
                    <div id="duration-result" class="result-container" style="display: none;">
                        <h3>Duration Result</h3>
                        <div class="result-grid">
                            <div class="result-item">
                                <label>Total Time</label>
                                <div id="total-duration" class="result-value">--</div>
                            </div>
                            <div class="result-item">
                                <label>Total Hours</label>
                                <div id="total-hours" class="result-value">--</div>
                            </div>
                            <div class="result-item">
                                <label>Total Days</label>
                                <div id="total-days" class="result-value">--</div>
                            </div>
                            <div class="result-item" id="business-hours-result" style="display: none;">
                                <label>Business Hours</label>
                                <div id="business-hours" class="result-value">--</div>
                            </div>
                            <div class="result-item" id="business-days-result" style="display: none;">
                                <label>Business Days</label>
                                <div id="business-days" class="result-value">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Calculations -->
                    <div class="quick-calculations">
                        <h3>Quick Calculations</h3>
                        <div class="quick-calc-grid">
                            <button class="quick-calc-btn" data-duration="1h">Add 1 Hour</button>
                            <button class="quick-calc-btn" data-duration="1d">Add 1 Day</button>
                            <button class="quick-calc-btn" data-duration="1w">Add 1 Week</button>
                            <button class="quick-calc-btn" data-duration="1m">Add 1 Month</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Time Tools v1.0.0 | <span id="api-status">Checking API...</span></p>
        </footer>
    </div>

    <script>
        // Dynamic API discovery
        let API_BASE = null;

        async function discoverApiPort() {
            if (window.TIME_TOOLS_API_URL) {
                return window.TIME_TOOLS_API_URL;
            }
            
            const portRanges = [
                { start: 8000, end: 8100 },
                { start: 3000, end: 3100 },
                { start: 5000, end: 5100 }
            ];
            
            for (const range of portRanges) {
                for (let port = range.start; port <= range.end; port++) {
                    try {
                        const url = `http://localhost:${port}`;
                        const response = await fetch(`${url}/api/v1/health`, {
                            method: 'GET',
                            signal: AbortSignal.timeout(500)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.service === 'time-tools') {
                                return url;
                            }
                        }
                    } catch (e) {
                        // Port not available, continue
                    }
                }
            }
            
            throw new Error('Time-tools API not found. Please ensure it is running.');
        }

        // Initialize calculator
        document.addEventListener('DOMContentLoaded', async function() {
            // Discover API first
            try {
                API_BASE = await discoverApiPort();
                document.getElementById('api-status').textContent = 'API Connected';
                document.getElementById('api-status').className = 'online';
            } catch (error) {
                document.getElementById('api-status').textContent = 'API Not Found';
                document.getElementById('api-status').className = 'offline';
                document.body.insertAdjacentHTML('afterbegin', 
                    '<div style="background: #ff6b6b; color: white; padding: 10px; text-align: center;">' +
                    'Time-tools API not found. Please ensure it is running.' +
                    '</div>'
                );
                return;
            }

            setupDurationForm();
            setupQuickCalculations();
            
            // Set default times (current time and 1 hour later)
            const now = new Date();
            const later = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour later
            
            document.getElementById('start-time').value = formatDateTimeLocal(now);
            document.getElementById('end-time').value = formatDateTimeLocal(later);
            
            // Set default timezone to user's timezone
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const timezoneSelect = document.getElementById('timezone');
            if ([...timezoneSelect.options].some(opt => opt.value === userTimezone)) {
                timezoneSelect.value = userTimezone;
            }
        });

        function setupDurationForm() {
            const form = document.getElementById('duration-form');
            if (!form) return;
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const startTime = document.getElementById('start-time').value;
                const endTime = document.getElementById('end-time').value;
                const timezone = document.getElementById('timezone').value;
                const excludeWeekends = document.getElementById('exclude-weekends').checked;
                const excludeHolidays = document.getElementById('exclude-holidays').checked;
                const businessHoursOnly = document.getElementById('business-hours-only').checked;
                
                if (!startTime || !endTime) {
                    alert('Please fill in both start and end times');
                    return;
                }
                
                const startISO = new Date(startTime).toISOString();
                const endISO = new Date(endTime).toISOString();
                
                try {
                    const response = await fetch(`${API_BASE}/api/v1/time/duration`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            start_time: startISO,
                            end_time: endISO,
                            timezone: timezone,
                            exclude_weekends: excludeWeekends,
                            exclude_holidays: excludeHolidays,
                            business_hours_only: businessHoursOnly
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        displayDurationResult(data);
                    } else {
                        const error = await response.json();
                        alert(`Calculation failed: ${error.error}`);
                    }
                } catch (error) {
                    alert('Failed to connect to API');
                    console.error(error);
                }
            });
        }

        function displayDurationResult(data) {
            const resultContainer = document.getElementById('duration-result');
            if (!resultContainer) return;
            
            resultContainer.style.display = 'block';
            
            // Format total duration as human readable
            const totalHours = Math.floor(data.total_hours);
            const totalMinutes = Math.floor((data.total_hours % 1) * 60);
            const durationText = `${totalHours}h ${totalMinutes}m`;
            
            document.getElementById('total-duration').textContent = durationText;
            document.getElementById('total-hours').textContent = `${data.total_hours.toFixed(2)} hours`;
            document.getElementById('total-days').textContent = `${data.total_days.toFixed(2)} days`;
            
            // Show business time results if applicable
            if (data.business_hours !== undefined) {
                document.getElementById('business-hours-result').style.display = 'block';
                document.getElementById('business-hours').textContent = `${data.business_hours.toFixed(2)} hours`;
            }
            
            if (data.business_days !== undefined) {
                document.getElementById('business-days-result').style.display = 'block';
                document.getElementById('business-days').textContent = `${data.business_days} days`;
            }
        }

        function setupQuickCalculations() {
            const quickButtons = document.querySelectorAll('.quick-calc-btn');
            quickButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const duration = this.dataset.duration;
                    const startTimeInput = document.getElementById('start-time');
                    const endTimeInput = document.getElementById('end-time');
                    
                    if (!startTimeInput.value) {
                        startTimeInput.value = formatDateTimeLocal(new Date());
                    }
                    
                    const startTime = new Date(startTimeInput.value);
                    let endTime = new Date(startTime);
                    
                    // Parse duration
                    const match = duration.match(/^(\d+)([hdwm])$/);
                    if (match) {
                        const amount = parseInt(match[1]);
                        const unit = match[2];
                        
                        switch (unit) {
                            case 'h':
                                endTime.setHours(endTime.getHours() + amount);
                                break;
                            case 'd':
                                endTime.setDate(endTime.getDate() + amount);
                                break;
                            case 'w':
                                endTime.setDate(endTime.getDate() + amount * 7);
                                break;
                            case 'm':
                                endTime.setMonth(endTime.getMonth() + amount);
                                break;
                        }
                        
                        endTimeInput.value = formatDateTimeLocal(endTime);
                    }
                });
            });
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
    </script>
</body>
</html>