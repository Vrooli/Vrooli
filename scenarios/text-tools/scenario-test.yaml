version: 1.0
scenario: text-tools

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/text-tools
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - initialization/storage/postgres/seed.sql
    - initialization/n8n/text-processing-pipeline.json
    - ui/index.html
    - ui/styles.css
    - ui/app.js
    - ui/package.json
    - ui/server.js
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/n8n
    - initialization/storage
    - initialization/storage/postgres
    - ui
    - plugins
    - tests
    - docs

# Resource validation
resources:
  required: 
    - postgres
    - minio
  optional: 
    - ollama
    - redis
    - qdrant
    - n8n
  health_timeout: 60  # Seconds to wait for resources to be healthy

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL is accessible"
    type: resource_health
    service: postgres
    expect:
      status: healthy
      
  - name: "MinIO is accessible"
    type: resource_health
    service: minio
    expect:
      status: healthy
      
  # API endpoint tests
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  - name: "API diff endpoint accepts requests"
    type: http
    service: api
    endpoint: /api/v1/text/diff
    method: POST
    headers:
      Content-Type: application/json
    body:
      text1: "Hello world"
      text2: "Hello Vrooli"
      options:
        type: line
    expect:
      status: 200
      body:
        changes: [type: object]
        similarity_score: [type: number]
        
  - name: "API search endpoint works"
    type: http
    service: api
    endpoint: /api/v1/text/search
    method: POST
    headers:
      Content-Type: application/json
    body:
      text: "The quick brown fox jumps over the lazy dog"
      pattern: "fox"
      options:
        regex: false
    expect:
      status: 200
      body:
        matches: [type: array]
        total_matches: [type: number]
        
  - name: "API transform endpoint processes text"
    type: http
    service: api
    endpoint: /api/v1/text/transform
    method: POST
    headers:
      Content-Type: application/json
    body:
      text: "hello world"
      transformations:
        - type: case
          parameters:
            type: upper
    expect:
      status: 200
      body:
        result: "HELLO WORLD"
        transformations_applied: ["case_upper"]
        
  - name: "API extract endpoint handles text"
    type: http
    service: api
    endpoint: /api/v1/text/extract
    method: POST
    headers:
      Content-Type: application/json
    body:
      source: "Plain text content"
      format: auto
    expect:
      status: 200
      body:
        text: [type: string]
        
  - name: "API analyze endpoint performs NLP"
    type: http
    service: api
    endpoint: /api/v1/text/analyze
    method: POST
    headers:
      Content-Type: application/json
    body:
      text: "This is a test email: test@example.com"
      analyses: ["entities"]
    expect:
      status: 200
      body:
        entities: [type: array]
        
  # CLI command tests
  - name: "CLI help command works"
    type: exec
    command: ./cli/text-tools help
    expect:
      exit_code: 0
      output_contains: 
        - "Text Tools CLI"
        - "COMMANDS"
        - "diff"
        - "search"
        
  - name: "CLI version command works"
    type: exec
    command: ./cli/text-tools version
    expect:
      exit_code: 0
      output_contains: ["Text Tools CLI v1.0.0"]
      
  - name: "CLI status command checks API"
    type: exec
    command: ./cli/text-tools status
    expect:
      exit_code: [0, 1]  # May fail if API not running
      output_contains: ["Text Tools"]
      
  # Database tests
  - name: "Database schema is initialized"
    type: sql
    service: postgres
    database: postgres
    query: "SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = 'text_tools'"
    expect:
      rows: 
        - count: [min: 8]  # At least 8 tables
        
  - name: "Text templates are seeded"
    type: sql
    service: postgres
    database: postgres
    query: "SELECT COUNT(*) as count FROM text_tools.text_templates"
    expect:
      rows:
        - count: [min: 4]  # At least 4 default templates
        
  # UI tests
  - name: "UI server responds"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      headers:
        content-type: [contains: "text/html"]
        
  - name: "UI health endpoint works"
    type: http
    service: ui
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  # N8n workflow tests (if n8n is available)
  - name: "Text processing workflow exists"
    type: n8n
    workflow: text-processing-pipeline
    condition:
      resource_available: n8n
    expect:
      exists: true
      nodes: [min: 5]
      
# Performance validation
performance:
  - name: "API response time"
    type: http
    service: api
    endpoint: /api/v1/text/diff
    method: POST
    body:
      text1: "test"
      text2: "test"
    expect:
      response_time: [max: 500]  # Max 500ms
      
  - name: "Large text handling"
    type: http
    service: api
    endpoint: /api/v1/text/transform
    method: POST
    body:
      text: [generate: 10000]  # 10KB of text
      transformations:
        - type: case
          parameters:
            type: upper
    expect:
      status: 200
      response_time: [max: 1000]  # Max 1 second

# Integration validation
integration:
  - name: "Cross-scenario compatibility"
    type: cli
    commands:
      - text-tools diff --help
      - text-tools search --help
      - text-tools transform --help
    expect:
      all_exit_code: 0
      
  - name: "API discoverable"
    type: http
    service: api
    endpoint: /health
    expect:
      status: 200
      
# Smoke tests for quick validation
smoke_tests:
  - name: "Quick API check"
    type: http
    service: api
    endpoint: /health
    expect:
      status: 200
      
  - name: "Quick CLI check"
    type: exec
    command: ./cli/text-tools --version
    expect:
      exit_code: 0