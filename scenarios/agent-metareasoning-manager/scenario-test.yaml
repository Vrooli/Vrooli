name: agent-metareasoning-manager
description: Test suite for simplified metareasoning discovery and coordination service
version: 2.0.0

prerequisites:
  resources:
    - ollama
    - n8n
    - windmill
    - postgres
    - qdrant
    - go
  environment:
    N8N_BASE_URL: http://localhost:${RESOURCE_PORTS[n8n]}
    WINDMILL_BASE_URL: http://localhost:${RESOURCE_PORTS[windmill]}
    SERVICE_PORT: ${SERVICE_PORT:-dynamic}

tests:
  - name: resource_availability
    description: Verify all required resources are running
    steps:
      - check: ollama_api
        command: curl -f http://localhost:${RESOURCE_PORTS[ollama]}/api/version
        expected_status: 200
      - check: n8n_health
        command: curl -f http://localhost:${RESOURCE_PORTS[n8n]}/healthz
        expected_status: 200
      - check: windmill_health
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]}/api/version
        expected_status: 200
      - check: go_runtime
        command: go version
        contains: go1.21

  - name: go_api_service
    description: Verify simplified Go coordinator API is built and running
    steps:
      - check: api_binary_exists
        command: test -f api/agent-metareasoning-manager-api
        expected_status: 0
      - check: api_health
        command: curl -f http://localhost:${SERVICE_PORT}/health
        expected_status: 200
        contains: "status":"healthy"
      - check: api_workflows_endpoint
        command: curl -f http://localhost:${SERVICE_PORT}/workflows
        expected_status: 200

  - name: n8n_workflow_deployment
    description: Verify all metareasoning workflows are deployed to n8n
    steps:
      - check: pros_cons_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows
        contains: pros-cons-analyzer
      - check: swot_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows
        contains: swot-analysis
      - check: risk_assessment_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows
        contains: risk-assessment
      - check: self_review_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows
        contains: self-review
      - check: reasoning_chain_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows
        contains: reasoning-chain
      - check: vector_conversion_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows
        contains: vector-conversion-service

  - name: go_api_endpoints
    description: Test simplified Go coordinator API endpoints
    steps:
      - check: health_endpoint
        command: curl -f http://localhost:${SERVICE_PORT}/health
        expected_status: 200
        contains: "status":"healthy"
      - check: workflows_discovery
        command: curl -f http://localhost:${SERVICE_PORT}/workflows
        expected_status: 200
      - check: workflow_search
        command: curl -X POST http://localhost:${SERVICE_PORT}/workflows/search -H "Content-Type: application/json" -d '{"query":"risk"}'  
        expected_status: 200
      - check: execute_n8n_workflow
        method: POST
        url: http://localhost:${SERVICE_PORT}/execute/n8n/pros-cons-analyzer
        headers:
          Content-Type: application/json
        body:
          input: Should we implement feature X?
          context: Technical decision
        expected_status: 200
        timeout: 60

  - name: end_to_end_reasoning_flow
    description: Test complete reasoning flow through simplified coordinator -> n8n -> Ollama
    steps:
      - check: pros_cons_execution
        method: POST
        url: http://localhost:${SERVICE_PORT}/execute/n8n/pros-cons-analyzer
        headers:
          Content-Type: application/json
        body:
          input: Implementing a new microservice architecture
          model: llama3.2
        expected_status: 200
        timeout: 60
      - check: risk_assessment_execution
        method: POST
        url: http://localhost:${SERVICE_PORT}/execute/n8n/risk-assessment
        headers:
          Content-Type: application/json
        body:
          action: Migrating to cloud infrastructure
          constraints: Limited budget and timeline
        expected_status: 200
        timeout: 60

  - name: windmill_apps_deployment
    description: Verify Windmill metareasoning apps are deployed
    steps:
      - check: windmill_api
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]}/api/version
        expected_status: 200
      - check: metareasoning_orchestrator_app
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]}/api/w/main/apps
        expected_status: 200
        contains: metareasoning-orchestrator
      - check: prompt_tester_app
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]}/api/w/main/apps
        expected_status: 200
        contains: prompt-tester

  - name: cli_functionality
    description: Verify simplified metareasoning CLI is installed and functional
    steps:
      - check: cli_installed
        command: which agent-metareasoning-manager
        expected: /usr/local/bin/agent-metareasoning-manager
      - check: cli_health
        command: agent-metareasoning-manager health
        expected_status: 0
        contains: healthy
      - check: cli_workflow_list
        command: agent-metareasoning-manager list
        expected_status: 0
      - check: cli_search
        command: agent-metareasoning-manager search "risk"
        expected_status: 0
      - check: cli_analyze_command
        command: agent-metareasoning-manager analyze pros-cons "Should we adopt TypeScript?"
        expected_status: 0
        timeout: 30

  - name: model_availability
    description: Verify required AI models are available in Ollama
    steps:
      - check: llama_model
        command: ollama list | grep llama3.2
        expected: llama3.2
      - check: mistral_model
        command: ollama list | grep mistral
        expected: mistral
      - check: codellama_model
        command: ollama list | grep codellama
        expected: codellama
      - check: embedding_model
        command: ollama list | grep nomic-embed-text
        expected: nomic-embed-text

  - name: postgres_database
    description: Verify simplified PostgreSQL database schema is initialized
    steps:
      - check: database_exists
        command: psql -h localhost -p ${RESOURCE_PORTS[postgres]} -U postgres -lqt | cut -d \| -f 1 | grep -qw metareasoning
        expected_status: 0
      - check: workflow_registry_table
        command: psql -h localhost -p ${RESOURCE_PORTS[postgres]} -U postgres -d metareasoning -c "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'workflow_registry')"
        contains: "t"
      - check: execution_log_table
        command: psql -h localhost -p ${RESOURCE_PORTS[postgres]} -U postgres -d metareasoning -c "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'execution_log')"
        contains: "t"
      - check: agent_preferences_table
        command: psql -h localhost -p ${RESOURCE_PORTS[postgres]} -U postgres -d metareasoning -c "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'agent_preferences')"
        contains: "t"
      - check: seed_data_loaded
        command: psql -h localhost -p ${RESOURCE_PORTS[postgres]} -U postgres -d metareasoning -t -c "SELECT COUNT(*) FROM workflow_registry"
        min_value: 5

  - name: qdrant_collections
    description: Verify Qdrant vector collections are initialized
    steps:
      - check: qdrant_health
        command: curl -f http://localhost:${RESOURCE_PORTS[qdrant]}/collections
        expected_status: 200
      - check: reasoning_patterns_collection
        command: curl -f http://localhost:${RESOURCE_PORTS[qdrant]}/collections/reasoning_patterns
        expected_status: 200
        contains: "reasoning_patterns"
      - check: execution_embeddings_collection
        command: curl -f http://localhost:${RESOURCE_PORTS[qdrant]}/collections/execution_embeddings
        expected_status: 200
        contains: "execution_embeddings"
      - check: prompt_templates_collection
        command: curl -f http://localhost:${RESOURCE_PORTS[qdrant]}/collections/prompt_templates
        expected_status: 200
        contains: "prompt_templates"

  - name: vector_conversion_service_tests
    description: Test the vector conversion service for embedding generation and storage
    steps:
      - check: vector_service_webhook_available
        command: curl -f http://localhost:${RESOURCE_PORTS[n8n]}/webhook/vector-conversion
        method: POST
        headers:
          Content-Type: application/json
        body:
          text: "test embedding generation"
          collection: "execution_embeddings"
        expected_status: 200
        timeout: 30
      - check: vector_service_workflow_embeddings
        command: curl -X POST http://localhost:${RESOURCE_PORTS[n8n]}/webhook/vector-conversion -H "Content-Type: application/json" -d '{"text": "test workflow pattern", "collection": "workflow_embeddings", "pattern_type": "test", "pattern_name": "Test Pattern"}'
        expected_status: 200
        contains: "success"
        timeout: 30
      - check: vector_service_prompt_templates
        command: curl -X POST http://localhost:${RESOURCE_PORTS[n8n]}/webhook/vector-conversion -H "Content-Type: application/json" -d '{"text": "analyze this prompt template", "collection": "prompt_templates", "prompt_pattern": "analysis"}'
        expected_status: 200
        contains: "point_id"
        timeout: 30
      - check: vector_service_invalid_collection
        command: curl -X POST http://localhost:${RESOURCE_PORTS[n8n]}/webhook/vector-conversion -H "Content-Type: application/json" -d '{"text": "test", "collection": "invalid_collection"}'
        expected_status: 400
        timeout: 15
      - check: vector_service_missing_text
        command: curl -X POST http://localhost:${RESOURCE_PORTS[n8n]}/webhook/vector-conversion -H "Content-Type: application/json" -d '{"collection": "execution_embeddings"}'
        expected_status: 400
        timeout: 15
      - check: vector_service_execution_logging
        description: Verify vector conversion executions are logged to PostgreSQL
        command: psql -h localhost -p ${RESOURCE_PORTS[postgres]} -U postgres -d metareasoning -t -c "SELECT COUNT(*) FROM execution_log WHERE platform = 'n8n_vector_service'"
        min_value: 1

validation:
  timeout: 300
  retry_count: 3
  success_threshold: 0.95