#!/bin/bash
################################################################################
# Scenario Auditor CLI - Lightweight API Wrapper
# 
# Standards enforcement for Vrooli scenarios
# Port discovery uses vrooli scenario port command for dynamic allocation
################################################################################

set -e

# Configuration
SCENARIO_NAME="scenario-auditor"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Dynamic port lookup
################################################################################
get_api_url() {
    # Use vrooli scenario port command for dynamic port lookup
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}‚ùå Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
show_help() {
    echo -e "${CYAN}üîç Scenario Auditor CLI${NC}"
    echo "Standards enforcement for Vrooli scenarios"
    echo ""
    echo "Usage: scenario-auditor [command] [options]"
    echo ""
    echo "Commands:"
    echo "  scan [scenario]        Scan scenario for standards violations"
    echo "  rules [--category]     List available rules"
    echo "  fix [scenario] [--auto] Generate fixes for violations"
    echo "  test <rule-id>         Run tests for a specific rule"
    echo "  validate <rule-id>     Validate custom code against a rule (reads stdin)"
    echo "  test-coverage          Show test coverage metrics"
    echo "  test-cache clear [rule] Clear test cache"
    echo "  health                 Check API health"
    echo "  version                Show version"
    echo "  help                   Show this help"
    echo ""
    echo "Examples:"
    echo "  scenario-auditor scan ecosystem-manager"
    echo "  scenario-auditor rules --category config"
    echo "  scenario-auditor test content_type_headers"
    echo "  echo 'func handler(w http.ResponseWriter, r *http.Request) {...}' | scenario-auditor validate security_headers"
    echo "  scenario-auditor test-cache clear content_type_headers"
}

show_version() {
    local api_url
    api_url=$(get_api_url 2>/dev/null || echo "API not running")
    echo "scenario-auditor CLI v1.0.0"
    echo "API: ${api_url}"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL
    api_url=$(get_api_url)
    
    local curl_args=(-sS)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi

    local tmp_body
    tmp_body=$(mktemp)
    local http_code
    
    # Make request and capture both body and status code
    if ! http_code=$(curl "${curl_args[@]}" -w "%{http_code}" -o "$tmp_body" "${api_url}${endpoint}"); then
        echo -e "${RED}‚ùå Error: Failed to connect to API${NC}" >&2
        rm -f "$tmp_body"
        exit 1
    fi
    
    # Check status code
    if [[ "$http_code" -ge 400 ]]; then
        echo -e "${RED}‚ùå Error: HTTP $http_code${NC}" >&2
        cat "$tmp_body" >&2
        rm -f "$tmp_body"
        exit 1
    fi
    
    # Output response body
    cat "$tmp_body"
    rm -f "$tmp_body"
}

################################################################################
# Command Handlers
################################################################################

cmd_scan() {
    local scenario="${1:-current}"
    api_request "POST" "/api/v1/scenarios/$scenario/scan" "{}"
}

cmd_rules() {
    local endpoint="/api/v1/rules"
    if [[ "$1" == "--category" && -n "$2" ]]; then
        endpoint="/api/v1/rules?category=$2"
    fi
    api_request "GET" "$endpoint"
}

cmd_fix() {
    local scenario="${1:-current}"
    local auto_apply="false"
    if [[ "$2" == "--auto" ]]; then
        auto_apply="true"
    fi
    api_request "POST" "/api/v1/ai/fix/$scenario" "{\"auto_apply\": $auto_apply}"
}

cmd_test() {
    local rule_id="$1"
    if [[ -z "$rule_id" ]]; then
        echo -e "${RED}‚ùå Error: Rule ID is required${NC}" >&2
        echo "Usage: scenario-auditor test <rule-id>" >&2
        exit 1
    fi
    api_request "POST" "/api/v1/rules/$rule_id/test" "{}"
}

cmd_validate() {
    local rule_id="$1"
    if [[ -z "$rule_id" ]]; then
        echo -e "${RED}‚ùå Error: Rule ID is required${NC}" >&2
        echo "Usage: scenario-auditor validate <rule-id>" >&2
        echo "Note: Code input will be read from stdin" >&2
        exit 1
    fi
    
    # Read code from stdin
    local code
    code=$(cat)
    if [[ -z "$code" ]]; then
        echo -e "${RED}‚ùå Error: No code provided via stdin${NC}" >&2
        exit 1
    fi
    
    # Prepare JSON request
    local json_data
    json_data=$(jq -n --arg code "$code" --arg language "go" '{code: $code, language: $language}')
    
    api_request "POST" "/api/v1/rules/$rule_id/validate" "$json_data"
}

cmd_test_coverage() {
    api_request "GET" "/api/v1/rules/test-coverage"
}

cmd_test_cache() {
    if [[ "$1" != "clear" ]]; then
        echo -e "${RED}‚ùå Error: Invalid test-cache command${NC}" >&2
        echo "Usage: scenario-auditor test-cache clear [rule-id]" >&2
        exit 1
    fi
    
    local endpoint="/api/v1/rules/test-cache"
    if [[ -n "$2" ]]; then
        endpoint="/api/v1/rules/$2/test-cache"
    fi
    
    api_request "DELETE" "$endpoint"
}

cmd_health() {
    api_request "GET" "/api/v1/health"
}

################################################################################
# Main
################################################################################

main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 1
    fi

    local command="$1"
    shift

    case "$command" in
        scan)
            cmd_scan "$@"
            ;;
        rules)
            cmd_rules "$@"
            ;;
        fix)
            cmd_fix "$@"
            ;;
        test)
            cmd_test "$@"
            ;;
        validate)
            cmd_validate "$@"
            ;;
        test-coverage)
            cmd_test_coverage
            ;;
        test-cache)
            cmd_test_cache "$@"
            ;;
        health)
            cmd_health
            ;;
        version)
            show_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}‚ùå Error: Unknown command: $command${NC}" >&2
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"