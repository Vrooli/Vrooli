{
  "name": "Implementation Phase Workflow", 
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "implementation-workflow",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_implementation",
      "name": "Implementation Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Generate implementation prompt from planning output\nconst request = $json;\nconst planData = request.plan_data || request.plan_final || '';\n\nif (!planData) {\n  throw new Error('No plan data available for implementation');\n}\n\nconst implementationPrompt = `# Scenario Generation - Implementation Phase\n\nYou are an expert Vrooli scenario developer. Based on the approved plan below, generate all necessary files and code to create a complete, deployable scenario.\n\n## Approved Plan:\n${planData}\n\n## Scenario Details:\n**Name:** ${request.scenario_name}\n**Description:** ${request.description}\n**Complexity:** ${request.complexity}\n**Category:** ${request.category}\n**Resources:** ${(request.resources || []).join(', ')}\n\n## Implementation Requirements:\n\nGenerate a complete Vrooli scenario that includes:\n\n### 1. Service Configuration\n- Complete .vrooli/service.json with all resource dependencies\n- Proper lifecycle configuration (setup, develop, test, stop)\n- Port assignments and environment variables\n- Resource initialization file references\n\n### 2. Database Schema (if using postgres)\n- initialization/postgres/schema.sql with complete database design\n- initialization/postgres/seed.sql with sample/default data\n- Proper indexes, constraints, and relationships\n- Data validation and business rules\n\n### 3. API Implementation (if applicable)\n- Complete API server code in appropriate language\n- RESTful endpoints with proper error handling\n- Authentication and authorization if needed\n- API documentation and examples\n\n### 4. User Interface (if applicable)\n- Complete UI implementation matching the plan\n- Responsive design and modern UX patterns\n- Integration with API endpoints\n- Real-time updates and error handling\n\n### 5. Workflows & Automation\n- N8N workflows for business processes\n- Windmill apps and scripts if specified\n- Automation triggers and event handling\n- Integration between components\n\n### 6. Configuration & Deployment\n- Environment-specific configuration files\n- Deployment scripts and startup sequences\n- Health checks and monitoring setup\n- Documentation and usage guides\n\n### 7. Testing & Validation\n- Test scripts and validation procedures\n- Integration tests for critical workflows\n- Performance and load testing considerations\n- Error handling and recovery procedures\n\n## Output Format:\n\nProvide the implementation as a structured response with:\n\n1. **File Structure**: Complete directory and file organization\n2. **File Contents**: Full content for each file (use \\`\\`\\`filename markers)\n3. **Configuration**: All necessary configuration values\n4. **Setup Instructions**: Step-by-step deployment guide\n5. **Testing Guide**: How to validate the implementation\n\n**Important**: Generate production-ready, well-documented code that follows Vrooli conventions and best practices. Ensure all components integrate properly and the scenario provides real business value.\n\n**Focus on**: Practical functionality, error handling, scalability, and maintainability.`;\n\nreturn {\n  ...request,\n  phase: 'implementation',\n  prompt: implementationPrompt,\n  iteration: (request.current_iteration?.implementation || 0) + 1,\n  max_iterations: request.iteration_limits?.implementation || 2\n};"
      },
      "id": "generate_implementation_prompt", 
      "name": "Generate Implementation Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "command": "echo '{{ $json.prompt }}' | claude chat",
        "options": {}
      },
      "id": "claude_implementation",
      "name": "Claude Implementation",
      "type": "n8n-nodes-base.executeCommand", 
      "typeVersion": 1,
      "position": [600, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Parse Claude's implementation response and extract files\nconst claudeOutput = $json.stdout || $json.output || '';\nconst request = $json;\n\nif (!claudeOutput.trim()) {\n  throw new Error('Claude Code returned empty implementation');\n}\n\n// Extract file contents from Claude's response\nconst fileMatches = claudeOutput.match(/```([\\w\\/.\\-]+)\\n([\\s\\S]*?)\\n```/g) || [];\nconst generatedFiles = {};\n\nfileMatches.forEach(match => {\n  const fileMatch = match.match(/```([\\w\\/.\\-]+)\\n([\\s\\S]*?)\\n```/);\n  if (fileMatch) {\n    const filename = fileMatch[1];\n    const content = fileMatch[2];\n    generatedFiles[filename] = content;\n  }\n});\n\n// Analyze implementation quality\nconst implementationAnalysis = {\n  files_generated: Object.keys(generatedFiles).length,\n  has_service_json: generatedFiles['.vrooli/service.json'] || generatedFiles['service.json'],\n  has_database_schema: generatedFiles['initialization/postgres/schema.sql'] || generatedFiles['schema.sql'],\n  has_api: claudeOutput.toLowerCase().includes('api') || claudeOutput.toLowerCase().includes('server'),\n  has_ui: claudeOutput.toLowerCase().includes('ui') || claudeOutput.toLowerCase().includes('interface'),\n  has_documentation: claudeOutput.toLowerCase().includes('readme') || claudeOutput.toLowerCase().includes('documentation'),\n  completeness_score: 0\n};\n\n// Calculate completeness score\nlet score = 0;\nif (implementationAnalysis.has_service_json) score += 25;\nif (implementationAnalysis.has_database_schema) score += 20;\nif (implementationAnalysis.has_api) score += 20;\nif (implementationAnalysis.has_ui) score += 20;\nif (implementationAnalysis.has_documentation) score += 15;\nif (implementationAnalysis.files_generated >= 5) score += 10;\nelse if (implementationAnalysis.files_generated >= 3) score += 5;\n\nimplementationAnalysis.completeness_score = Math.min(score, 100);\n\n// Determine if implementation needs refinement\nconst needsRefinement = implementationAnalysis.completeness_score < 70 && \n                       request.iteration < request.max_iterations;\n\nreturn {\n  ...request,\n  implementation_output: claudeOutput,\n  generated_files: generatedFiles,\n  implementation_analysis: implementationAnalysis,\n  needs_refinement: needsRefinement,\n  implementation_quality: implementationAnalysis.completeness_score >= 80 ? 'excellent' : \n                         implementationAnalysis.completeness_score >= 60 ? 'good' : 'needs_work'\n};"
      },
      "id": "analyze_implementation_quality",
      "name": "Analyze Implementation Quality",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 300]
    },
    {
      "parameters": {},
      "id": "implementation_decision",
      "name": "Implementation Quality Decision",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1000, 300],
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.needs_refinement }}",
              "operation": "equal",
              "value2": "true"
            }
          ]
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Generate refinement prompt for improving implementation\nconst request = $json;\n\nconst refinementPrompt = `# Scenario Generation - Implementation Refinement (Iteration ${request.iteration})\n\nThe implementation needs improvement. Please refine the following implementation based on the analysis:\n\n## Current Implementation:\n${request.implementation_output}\n\n## Quality Analysis:\n- Files Generated: ${request.implementation_analysis.files_generated}\n- Service Configuration: ${request.implementation_analysis.has_service_json ? '✓' : '✗'}\n- Database Schema: ${request.implementation_analysis.has_database_schema ? '✓' : '✗'}\n- API Implementation: ${request.implementation_analysis.has_api ? '✓' : '✗'}\n- User Interface: ${request.implementation_analysis.has_ui ? '✓' : '✗'}\n- Documentation: ${request.implementation_analysis.has_documentation ? '✓' : '✗'}\n- Completeness Score: ${request.implementation_analysis.completeness_score}%\n\n## Refinement Focus:\n${!request.implementation_analysis.has_service_json ? '- Add complete .vrooli/service.json with proper resource configuration\\n' : ''}\n${!request.implementation_analysis.has_database_schema ? '- Include database schema with tables, indexes, and constraints\\n' : ''}\n${!request.implementation_analysis.has_api ? '- Implement API endpoints with proper error handling\\n' : ''}\n${!request.implementation_analysis.has_ui ? '- Add user interface components and styling\\n' : ''}\n${!request.implementation_analysis.has_documentation ? '- Include README and setup documentation\\n' : ''}\n${request.implementation_analysis.files_generated < 5 ? '- Generate more essential files for completeness\\n' : ''}\n\n## Requirements for Improved Implementation:\n- Ensure all critical files are present and complete\n- Add proper error handling and validation\n- Include comprehensive documentation\n- Follow Vrooli best practices and conventions\n- Make the scenario production-ready\n\nPlease provide an improved, more complete implementation.\n\n**Output Format:** Complete file contents with proper structure and comprehensive functionality.`;\n\nreturn {\n  ...request,\n  prompt: refinementPrompt,\n  iteration: request.iteration + 1\n};"
      },
      "id": "generate_refinement_prompt",
      "name": "Generate Refinement Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 450]
    },
    {
      "parameters": {
        "command": "echo '{{ $json.prompt }}' | claude chat",
        "options": {}
      },
      "id": "claude_refinement",
      "name": "Claude Refinement", 
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [600, 450]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Finalize implementation phase with completed files\nconst request = $json;\nconst finalImplementation = request.implementation_output;\nconst generatedFiles = request.generated_files || {};\n\n// Extract scenario structure information\nconst scenarioStructure = {\n  service_config: !!generatedFiles['.vrooli/service.json'] || !!generatedFiles['service.json'],\n  database_schema: !!generatedFiles['initialization/postgres/schema.sql'],\n  api_endpoints: finalImplementation.toLowerCase().includes('api') && \n                (finalImplementation.includes('router') || finalImplementation.includes('endpoint')),\n  ui_components: finalImplementation.toLowerCase().includes('ui') || \n                finalImplementation.toLowerCase().includes('component'),\n  workflows: finalImplementation.toLowerCase().includes('workflow') || \n            finalImplementation.toLowerCase().includes('n8n'),\n  documentation: !!generatedFiles['README.md'] || finalImplementation.toLowerCase().includes('readme')\n};\n\n// Calculate business value metrics\nconst businessMetrics = {\n  estimated_development_hours: request.complexity === 'simple' ? 20 : \n                              request.complexity === 'advanced' ? 80 : 40,\n  resource_utilization: Object.keys(request.resources || []).length,\n  feature_completeness: request.implementation_analysis?.completeness_score || 100,\n  deployment_readiness: scenarioStructure.service_config && \n                       (scenarioStructure.database_schema || scenarioStructure.api_endpoints)\n};\n\nreturn {\n  ...request,\n  status: 'implementation_complete',\n  implementation_final: finalImplementation,\n  files: generatedFiles,\n  structure: scenarioStructure,\n  business_metrics: businessMetrics,\n  implementation_metrics: {\n    total_iterations: request.iteration,\n    final_quality_score: request.implementation_analysis?.completeness_score || 100,\n    files_generated: Object.keys(generatedFiles).length,\n    implementation_length: finalImplementation.length\n  },\n  completed_at: new Date().toISOString()\n};"
      },
      "id": "finalize_implementation",
      "name": "Finalize Implementation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "implementation_response",
      "name": "Implementation Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1400, 300]
    }
  ],
  "connections": {
    "webhook_implementation": {
      "main": [
        [
          {
            "node": "generate_implementation_prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_implementation_prompt": {
      "main": [
        [
          {
            "node": "claude_implementation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "claude_implementation": {
      "main": [
        [
          {
            "node": "analyze_implementation_quality",
            "type": "main", 
            "index": 0
          }
        ]
      ]
    },
    "analyze_implementation_quality": {
      "main": [
        [
          {
            "node": "implementation_decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "implementation_decision": {
      "main": [
        [
          {
            "node": "generate_refinement_prompt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "finalize_implementation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_refinement_prompt": {
      "main": [
        [
          {
            "node": "claude_refinement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "claude_refinement": {
      "main": [
        [
          {
            "node": "analyze_implementation_quality",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "finalize_implementation": {
      "main": [
        [
          {
            "node": "implementation_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-08-28T12:00:00.000Z",
      "updatedAt": "2024-08-28T12:00:00.000Z",
      "id": "implementation-phase",
      "name": "implementation-phase"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-08-28T12:00:00.000Z",
  "versionId": "1"
}