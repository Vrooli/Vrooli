{
  "name": "Scenario Generator Orchestrator Enhanced",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-scenario",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        200,
        300
      ]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        200,
        500
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Test defaults for manual trigger\nreturn {\n  scenario_name: 'test-scenario',\n  description: 'A test scenario for validating the generation pipeline',\n  business_value: 'Demonstrates automated scenario generation capabilities',\n  target_market: 'Software development teams',\n  revenue_range: { min: 10000, max: 25000 },\n  resources_needed: ['postgres', 'n8n'],\n  ui_type: 'javascript',\n  complexity: 'intermediate'\n};"
      },
      "id": "set_test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        400,
        500
      ]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        600,
        400
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Validate and prepare scenario generation inputs\nconst input = $input.item.json;\n\n// Required fields validation\nif (!input.scenario_name) {\n  throw new Error('Missing required field: scenario_name');\n}\n\nif (!input.description) {\n  throw new Error('Missing required field: description');\n}\n\n// Clean and validate scenario name\nconst scenarioName = input.scenario_name.toLowerCase()\n  .replace(/[^a-z0-9-]/g, '-')\n  .replace(/-+/g, '-')\n  .replace(/^-|-$/g, '')\n  .substring(0, 50);\n\nif (scenarioName.length < 3) {\n  throw new Error('Scenario name too short (min 3 characters)');\n}\n\n// Prepare configuration\nconst config = {\n  scenario_name: scenarioName,\n  display_name: input.display_name || input.scenario_name,\n  description: input.description.substring(0, 500),\n  business_value: input.business_value || 'To be determined',\n  target_market: input.target_market || 'General business',\n  revenue_range: input.revenue_range || { min: 10000, max: 25000, currency: 'USD' },\n  resources_needed: input.resources_needed || ['postgres', 'n8n'],\n  ui_type: input.ui_type || 'javascript',\n  complexity: input.complexity || 'intermediate',\n  category: input.category || 'saas-applications',\n  tags: input.tags || ['ai-generated', 'business-automation']\n};\n\n// Initialize generation metadata\nconst metadata = {\n  generation_id: `gen_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n  started_at: new Date().toISOString(),\n  status: 'initializing',\n  steps_completed: [],\n  errors: [],\n  warnings: []\n};\n\nreturn {\n  config: config,\n  metadata: metadata\n};"
      },
      "id": "validate_input",
      "name": "Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        800,
        400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || 'http://localhost:5678' }}/webhook/ollama",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"prompt\": \"Generate a detailed service.json configuration for a Vrooli scenario with these requirements:\\n\\nScenario Name: {{ $json.config.scenario_name }}\\nDescription: {{ $json.config.description }}\\nBusiness Value: {{ $json.config.business_value }}\\nTarget Market: {{ $json.config.target_market }}\\nRevenue Range: {{ JSON.stringify($json.config.revenue_range) }}\\nResources Needed: {{ JSON.stringify($json.config.resources_needed) }}\\nUI Type: {{ $json.config.ui_type }}\\nComplexity: {{ $json.config.complexity }}\\n\\nGenerate a complete service.json following the Vrooli schema with:\\n1. Complete service metadata\\n2. Port configuration\\n3. Resource dependencies with proper types and shared workflows where applicable\\n4. Full lifecycle hooks (setup, develop, test, stop)\\n5. Initialization steps for resources\\n\\nRespond with ONLY valid JSON, no explanations.\",\n  \"model\": \"llama3.2\",\n  \"type\": \"code\",\n  \"quiet\": true,\n  \"timeout_seconds\": 120\n}",
        "options": {
          "timeout": 125000
        }
      },
      "id": "generate_service_json",
      "name": "Generate service.json",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1000,
        400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || 'http://localhost:5678' }}/webhook/ollama",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"prompt\": \"Generate a PostgreSQL schema for a Vrooli scenario with these requirements:\\n\\nScenario: {{ $json.config.scenario_name }}\\nDescription: {{ $json.config.description }}\\nBusiness Focus: {{ $json.config.business_value }}\\n\\nCreate a PostgreSQL schema that includes:\\n1. Core business entity tables\\n2. User/authentication tables if needed\\n3. Audit/logging tables\\n4. Proper indexes and constraints\\n5. Initial seed data for demo purposes\\n\\nRespond with valid PostgreSQL SQL statements only.\",\n  \"model\": \"llama3.2\",\n  \"type\": \"code\",\n  \"quiet\": true,\n  \"timeout_seconds\": 120\n}",
        "options": {
          "timeout": 125000
        }
      },
      "id": "generate_schema",
      "name": "Generate Database Schema",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1000,
        550
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || 'http://localhost:5678' }}/webhook/workflow-creator-fixer",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"purpose\": \"Main workflow for {{ $json.config.scenario_name }} that {{ $json.config.description }}\",\n  \"description\": \"{{ $json.config.description }}\",\n  \"trigger_type\": \"webhook\",\n  \"resources_needed\": {{ JSON.stringify($json.config.resources_needed) }},\n  \"expected_inputs\": {\n    \"action\": \"string\",\n    \"data\": \"object\"\n  },\n  \"expected_outputs\": {\n    \"success\": \"boolean\",\n    \"result\": \"object\",\n    \"message\": \"string\"\n  },\n  \"optimization_goals\": [\"reliability\", \"performance\", \"error_handling\"],\n  \"use_shared_workflows\": true\n}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "generate_workflow",
      "name": "Generate Main Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1000,
        700
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || 'http://localhost:5678' }}/webhook/claude-code-executor",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"task\": \"generate_ui_code\",\n  \"description\": \"Generate {{ $json.config.ui_type }} UI code for {{ $json.config.scenario_name }}\",\n  \"requirements\": {\n    \"scenario_name\": \"{{ $json.config.scenario_name }}\",\n    \"display_name\": \"{{ $json.config.display_name }}\",\n    \"description\": \"{{ $json.config.description }}\",\n    \"ui_type\": \"{{ $json.config.ui_type }}\",\n    \"features\": [\n      \"Modern, engaging design\",\n      \"Responsive layout\",\n      \"API integration with backend\",\n      \"Error handling\",\n      \"Loading states\"\n    ]\n  },\n  \"output_format\": \"code_files\"\n}",
        "options": {
          "timeout": 300000
        }
      },
      "id": "generate_ui",
      "name": "Generate UI Code",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1000,
        850
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Parse and validate all generated components\nconst config = $('Validate Input').item.json.config;\nconst metadata = $('Validate Input').item.json.metadata;\n\n// Parse service.json\nlet serviceJson;\ntry {\n  const response = $('Generate service.json').item.json;\n  const responseText = response.response || response.text || '';\n  const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\n  \n  if (jsonMatch) {\n    serviceJson = JSON.parse(jsonMatch[0]);\n    serviceJson.service.name = config.scenario_name;\n    serviceJson.service.displayName = config.display_name;\n    serviceJson.service.description = config.description;\n    metadata.steps_completed.push('service_json_generated');\n  }\n} catch (error) {\n  metadata.errors.push({\n    step: 'service_json_generation',\n    error: error.message\n  });\n}\n\n// Parse database schema\nlet schemaSQL;\ntry {\n  const response = $('Generate Database Schema').item.json;\n  const responseText = response.response || response.text || '';\n  schemaSQL = responseText.replace(/```sql/gi, '').replace(/```/g, '').trim();\n  if (schemaSQL.includes('CREATE TABLE')) {\n    metadata.steps_completed.push('schema_generated');\n  }\n} catch (error) {\n  metadata.errors.push({\n    step: 'schema_generation',\n    error: error.message\n  });\n}\n\n// Parse workflow\nlet workflowJson;\ntry {\n  const response = $('Generate Main Workflow').item.json;\n  if (response.success) {\n    workflowJson = response.workflow_json || response.result || {};\n    metadata.steps_completed.push('workflow_generated');\n  }\n} catch (error) {\n  metadata.errors.push({\n    step: 'workflow_generation',\n    error: error.message\n  });\n}\n\n// Parse UI code if applicable\nlet uiFiles = {};\nif (config.ui_type === 'javascript' || config.ui_type === 'react') {\n  try {\n    const response = $('Generate UI Code').item.json;\n    if (response.success && response.files) {\n      uiFiles = response.files;\n      metadata.steps_completed.push('ui_generated');\n    }\n  } catch (error) {\n    metadata.warnings.push({\n      step: 'ui_generation',\n      warning: 'UI generation not available or failed',\n      error: error.message\n    });\n  }\n}\n\n// Update metadata\nmetadata.completed_at = new Date().toISOString();\nmetadata.status = metadata.errors.length > 0 ? 'completed_with_errors' : 'success';\n\n// Create fallback values if needed\nif (!serviceJson) {\n  serviceJson = {\n    \"$schema\": \"../../../../.vrooli/schemas/service.schema.json\",\n    \"version\": \"1.0.0\",\n    \"service\": {\n      \"parent\": \"vrooli\",\n      \"name\": config.scenario_name,\n      \"displayName\": config.display_name,\n      \"description\": config.description,\n      \"version\": \"1.0.0\",\n      \"type\": \"business-application\",\n      \"category\": config.category,\n      \"tags\": config.tags\n    },\n    \"ports\": {\n      \"api\": {\n        \"env_var\": \"SERVICE_PORT\",\n        \"range\": \"8090-8999\",\n        \"fallback\": \"auto\"\n      }\n    },\n    \"resources\": {\n      \"automation\": {\n        \"n8n\": {\n          \"type\": \"n8n\",\n          \"enabled\": true,\n          \"required\": true,\n          \"shared_workflows\": [\"ollama\"],\n          \"initialization\": []\n        }\n      },\n      \"storage\": {\n        \"postgres\": {\n          \"type\": \"postgres\",\n          \"enabled\": true,\n          \"required\": true,\n          \"initialization\": []\n        }\n      }\n    },\n    \"lifecycle\": {\n      \"version\": \"1.0.0\",\n      \"setup\": { \"steps\": [] },\n      \"develop\": { \"steps\": [] },\n      \"test\": { \"steps\": [] },\n      \"stop\": { \"steps\": [] }\n    }\n  };\n}\n\nif (!schemaSQL) {\n  schemaSQL = `-- Database schema for ${config.scenario_name}\\nCREATE TABLE IF NOT EXISTS data (\\n    id SERIAL PRIMARY KEY,\\n    content JSONB,\\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\\n);`;\n}\n\nif (!workflowJson) {\n  workflowJson = {\n    \"name\": `${config.display_name} Main Workflow`,\n    \"nodes\": [\n      {\n        \"parameters\": {\n          \"httpMethod\": \"POST\",\n          \"path\": config.scenario_name,\n          \"responseMode\": \"responseNode\"\n        },\n        \"id\": \"webhook_trigger\",\n        \"name\": \"Webhook Trigger\",\n        \"type\": \"n8n-nodes-base.webhook\",\n        \"typeVersion\": 1.1,\n        \"position\": [250, 300]\n      },\n      {\n        \"parameters\": {},\n        \"id\": \"manual_trigger\",\n        \"name\": \"Manual Trigger\",\n        \"type\": \"n8n-nodes-base.manualTrigger\",\n        \"typeVersion\": 1,\n        \"position\": [250, 150]\n      },\n      {\n        \"parameters\": {\n          \"respondWith\": \"json\",\n          \"responseBody\": \"{\\\"success\\\": true, \\\"message\\\": \\\"Workflow executed\\\"}\"\n        },\n        \"id\": \"respond\",\n        \"name\": \"Respond\",\n        \"type\": \"n8n-nodes-base.respondToWebhook\",\n        \"typeVersion\": 1,\n        \"position\": [650, 300]\n      }\n    ],\n    \"connections\": {\n      \"webhook_trigger\": {\n        \"main\": [[{\"node\": \"respond\", \"type\": \"main\", \"index\": 0}]]\n      }\n    }\n  };\n}\n\n// Build file structure\nconst fileStructure = {\n  '.vrooli': {\n    'service.json': serviceJson\n  },\n  'initialization': {\n    'postgres': {\n      'schema.sql': schemaSQL\n    },\n    'n8n': {\n      'main-workflow.json': workflowJson\n    }\n  },\n  'api': {\n    'main.go': `package main\\n\\nimport (\\n    \"fmt\"\\n    \"net/http\"\\n    \"os\"\\n)\\n\\nfunc main() {\\n    http.HandleFunc(\"/health\", func(w http.ResponseWriter, r *http.Request) {\\n        w.WriteHeader(http.StatusOK)\\n        fmt.Fprintf(w, \"{\\\\\"status\\\\\":\\\\\"healthy\\\\\"}\\\\n\")\\n    })\\n    \\n    port := os.Getenv(\"SERVICE_PORT\")\\n    if port == \"\" {\\n        port = \"8090\"\\n    }\\n    \\n    fmt.Printf(\"Starting ${config.display_name} API on port %s\\\\n\", port)\\n    http.ListenAndServe(\":\" + port, nil)\\n}`,\n    'go.mod': `module ${config.scenario_name}\\n\\ngo 1.19`\n  }\n};\n\n// Add UI files if generated\nif (Object.keys(uiFiles).length > 0) {\n  fileStructure.ui = uiFiles;\n}\n\n// Add README\nfileStructure['README.md'] = `# ${config.display_name}\\n\\n${config.description}\\n\\n## Business Value\\n${config.business_value}\\n\\n## Target Market\\n${config.target_market}\\n\\n## Revenue Potential\\n$${config.revenue_range.min} - $${config.revenue_range.max} ${config.revenue_range.currency || 'USD'}\\n\\n## Resources Used\\n${config.resources_needed.map(r => '- ' + r).join('\\n')}\\n\\n## Generated\\nGenerated on ${metadata.completed_at} by Scenario Generator V1\\nGeneration ID: ${metadata.generation_id}`;\n\n// Create summary\nconst summary = {\n  success: metadata.status === 'success',\n  scenario_name: config.scenario_name,\n  display_name: config.display_name,\n  generation_id: metadata.generation_id,\n  files_generated: Object.keys(fileStructure).length,\n  warnings: metadata.warnings,\n  errors: metadata.errors,\n  next_steps: [\n    `1. Review generated files in scenarios/${config.scenario_name}/`,\n    `2. Run 'vrooli scenario convert ${config.scenario_name}' to test the scenario`,\n    `3. Customize the generated files as needed`,\n    `4. Add UI components if required (${config.ui_type} type selected)`\n  ]\n};\n\nreturn {\n  summary: summary,\n  file_structure: fileStructure,\n  metadata: metadata,\n  config: config\n};"
      },
      "id": "compile_result",
      "name": "Compile Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1400,
        550
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_BASE_URL || 'http://localhost:5678' }}/webhook/file-list-writer",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"base_path\": \"/home/matthalloran8/Vrooli/scenarios/{{ $json.config.scenario_name }}\",\n  \"files\": {{ JSON.stringify($json.file_structure) }},\n  \"create_directories\": true,\n  \"overwrite\": false\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "write_files",
      "name": "Write Files to Disk",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1600,
        550
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json, null, 2) }}"
      },
      "id": "respond_success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1800,
        550
      ]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "set_test_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_test_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "validate_input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validate_input": {
      "main": [
        [
          {
            "node": "generate_service_json",
            "type": "main",
            "index": 0
          },
          {
            "node": "generate_schema",
            "type": "main",
            "index": 0
          },
          {
            "node": "generate_workflow",
            "type": "main",
            "index": 0
          },
          {
            "node": "generate_ui",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_service_json": {
      "main": [
        [
          {
            "node": "compile_result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_schema": {
      "main": [
        [
          {
            "node": "compile_result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_workflow": {
      "main": [
        [
          {
            "node": "compile_result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_ui": {
      "main": [
        [
          {
            "node": "compile_result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "compile_result": {
      "main": [
        [
          {
            "node": "write_files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "write_files": {
      "main": [
        [
          {
            "node": "respond_success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {},
  "staticData": null,
  "pinData": {}
}