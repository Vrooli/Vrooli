{
  "name": "Schedule Monitor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Every 15 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Get schedules with health issues\nWITH schedule_health AS (\n  SELECT \n    s.id,\n    s.name,\n    s.enabled,\n    s.status,\n    s.consecutive_failures,\n    s.total_executions,\n    s.successful_executions,\n    s.failed_executions,\n    CASE \n      WHEN s.total_executions = 0 THEN 100\n      ELSE ROUND((s.successful_executions::numeric / s.total_executions) * 100, 2)\n    END as success_rate,\n    se.last_status,\n    se.last_run_at,\n    se.avg_execution_time_ms,\n    CASE\n      WHEN s.consecutive_failures >= 10 THEN 'critical'\n      WHEN s.consecutive_failures >= 5 THEN 'warning'\n      WHEN s.total_executions > 0 AND (s.successful_executions::numeric / s.total_executions) < 0.5 THEN 'degraded'\n      WHEN se.last_run_at < NOW() - INTERVAL '2 days' AND s.enabled = true THEN 'stale'\n      ELSE 'healthy'\n    END as health_status\n  FROM schedules s\n  LEFT JOIN (\n    SELECT \n      schedule_id,\n      MAX(completed_at) as last_run_at,\n      (array_agg(status ORDER BY completed_at DESC))[1] as last_status,\n      AVG(execution_time_ms) as avg_execution_time_ms\n    FROM schedule_executions\n    WHERE completed_at IS NOT NULL\n    GROUP BY schedule_id\n  ) se ON s.id = se.schedule_id\n)\nSELECT *\nFROM schedule_health\nWHERE health_status != 'healthy'\nORDER BY \n  CASE health_status\n    WHEN 'critical' THEN 1\n    WHEN 'warning' THEN 2\n    WHEN 'degraded' THEN 3\n    WHEN 'stale' THEN 4\n  END,\n  consecutive_failures DESC;",
        "options": {}
      },
      "id": "check-health",
      "name": "Check Schedule Health",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-issues",
              "leftValue": "={{ $json.length > 0 }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "has-issues",
      "name": "Has Health Issues?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "=// Group issues by severity and prepare notifications\nconst issues = $input.all();\nconst grouped = {\n  critical: [],\n  warning: [],\n  degraded: [],\n  stale: []\n};\n\nfor (const item of issues) {\n  const schedule = item.json;\n  grouped[schedule.health_status].push({\n    id: schedule.id,\n    name: schedule.name,\n    consecutive_failures: schedule.consecutive_failures,\n    success_rate: schedule.success_rate,\n    last_status: schedule.last_status,\n    last_run: schedule.last_run_at\n  });\n}\n\n// Prepare notification payload\nconst notification = {\n  timestamp: new Date().toISOString(),\n  total_issues: issues.length,\n  critical_count: grouped.critical.length,\n  warning_count: grouped.warning.length,\n  issues: grouped,\n  action_required: grouped.critical.length > 0,\n  suggested_actions: []\n};\n\n// Add suggested actions\nif (grouped.critical.length > 0) {\n  notification.suggested_actions.push('Immediately review critical schedules - they may need to be disabled or fixed');\n}\nif (grouped.warning.length > 0) {\n  notification.suggested_actions.push('Review warning schedules - consecutive failures detected');\n}\nif (grouped.stale.length > 0) {\n  notification.suggested_actions.push('Check stale schedules - they haven\\'t run in over 2 days');\n}\n\nreturn [{ json: notification }];"
      },
      "id": "prepare-notification",
      "name": "Prepare Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 250]
    },
    {
      "parameters": {
        "url": "=http://localhost:${service.n8n.port}/webhook/notification-router",
        "sendBody": true,
        "bodyParameters": {
          "parameters": "={{ $json }}"
        },
        "options": {}
      },
      "id": "send-notification",
      "name": "Send Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 250],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Calculate global metrics\nSELECT \n  COUNT(DISTINCT s.id) as total_schedules,\n  COUNT(DISTINCT CASE WHEN s.enabled = true THEN s.id END) as active_schedules,\n  COUNT(DISTINCT se.id) as total_executions_24h,\n  COUNT(DISTINCT CASE WHEN se.status = 'success' THEN se.id END) as successful_24h,\n  COUNT(DISTINCT CASE WHEN se.status IN ('failed', 'failed_permanent') THEN se.id END) as failed_24h,\n  COUNT(DISTINCT CASE WHEN se.status = 'running' THEN se.id END) as currently_running,\n  COUNT(DISTINCT CASE WHEN se.is_catch_up = true THEN se.id END) as catch_up_24h,\n  AVG(se.execution_time_ms)::integer as avg_execution_time_ms,\n  MAX(se.execution_time_ms) as max_execution_time_ms,\n  MIN(se.execution_time_ms) as min_execution_time_ms,\n  PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY se.execution_time_ms) as p95_execution_time_ms,\n  PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY se.execution_time_ms) as p99_execution_time_ms\nFROM schedules s\nLEFT JOIN schedule_executions se ON s.id = se.schedule_id\n  AND se.started_at >= NOW() - INTERVAL '24 hours';",
        "options": {}
      },
      "id": "calculate-metrics",
      "name": "Calculate Global Metrics",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [450, 500],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Store metrics snapshot\nINSERT INTO metrics_history (\n  timestamp,\n  metric_type,\n  metrics\n) VALUES (\n  NOW(),\n  'global_snapshot',\n  '{{ JSON.stringify($json) }}'::jsonb\n);\n\n-- Clean old metrics (keep 30 days)\nDELETE FROM metrics_history\nWHERE timestamp < NOW() - INTERVAL '30 days';",
        "options": {}
      },
      "id": "store-metrics",
      "name": "Store Metrics Snapshot",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [650, 500],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Auto-disable consistently failing schedules\nUPDATE schedules\nSET \n  status = 'disabled',\n  enabled = false,\n  metadata = jsonb_set(\n    COALESCE(metadata, '{}'::jsonb),\n    '{auto_disabled_at}',\n    to_jsonb(NOW()::text)\n  )\nWHERE consecutive_failures >= 20\nAND enabled = true\nRETURNING id, name;",
        "options": {}
      },
      "id": "auto-disable",
      "name": "Auto-Disable Failed Schedules",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1250, 250],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "disabled-any",
              "leftValue": "={{ $json.length > 0 }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-disabled",
      "name": "Any Auto-Disabled?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1450, 250]
    },
    {
      "parameters": {
        "jsCode": "=// Prepare auto-disable notification\nconst disabled = $input.all();\nconst notification = {\n  type: 'auto_disable',\n  severity: 'critical',\n  timestamp: new Date().toISOString(),\n  message: `Auto-disabled ${disabled.length} failing schedule(s)`,\n  schedules: disabled.map(item => ({\n    id: item.json.id,\n    name: item.json.name\n  })),\n  action: 'Schedules have been automatically disabled due to excessive consecutive failures (20+)'\n};\n\nreturn [{ json: notification }];"
      },
      "id": "prepare-disable-notification",
      "name": "Prepare Disable Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "url": "=http://localhost:${service.n8n.port}/webhook/notification-router",
        "sendBody": true,
        "bodyParameters": {
          "parameters": "={{ $json }}"
        },
        "options": {}
      },
      "id": "send-disable-notification",
      "name": "Send Disable Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1850, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Clean up old execution records (keep 90 days)\nDELETE FROM schedule_executions\nWHERE completed_at < NOW() - INTERVAL '90 days'\nAND status != 'running';\n\n-- Clean up orphaned retry queue entries\nDELETE FROM retry_queue\nWHERE created_at < NOW() - INTERVAL '7 days';\n\n-- Update execution statistics view\nREFRESH MATERIALIZED VIEW CONCURRENTLY IF EXISTS execution_statistics;",
        "options": {}
      },
      "id": "cleanup",
      "name": "Cleanup Old Records",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 500],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    }
  ],
  "connections": {
    "cron-trigger": {
      "main": [
        [
          {
            "node": "check-health",
            "type": "main",
            "index": 0
          },
          {
            "node": "calculate-metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-health": {
      "main": [
        [
          {
            "node": "has-issues",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has-issues": {
      "main": [
        [
          {
            "node": "prepare-notification",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "prepare-notification": {
      "main": [
        [
          {
            "node": "send-notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send-notification": {
      "main": [
        [
          {
            "node": "auto-disable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "auto-disable": {
      "main": [
        [
          {
            "node": "check-disabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-disabled": {
      "main": [
        [
          {
            "node": "prepare-disable-notification",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "prepare-disable-notification": {
      "main": [
        [
          {
            "node": "send-disable-notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calculate-metrics": {
      "main": [
        [
          {
            "node": "store-metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "store-metrics": {
      "main": [
        [
          {
            "node": "cleanup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "workflow-scheduler-monitor"
  },
  "tags": [
    {
      "name": "workflow-scheduler"
    }
  ]
}