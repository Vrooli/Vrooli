{
  "name": "Schedule Executor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Every Minute",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 250]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide test data for manual trigger\nconst input = $input.item.json;\nif (!input || Object.keys(input).length === 0) {\n  return {\n    test_mode: true,\n    test_timestamp: new Date().toISOString()\n  };\n}\nreturn input;"
      },
      "id": "manual-defaults",
      "name": "Manual Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 400]
    },
    {
      "parameters": {},
      "id": "merge-triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT s.*, se.last_run, se.next_run, se.consecutive_failures\nFROM schedules s\nLEFT JOIN schedule_executions se ON s.id = se.schedule_id\nAND se.id = (SELECT id FROM schedule_executions WHERE schedule_id = s.id ORDER BY started_at DESC LIMIT 1)\nWHERE s.enabled = true\nAND s.status = 'active'\nAND (se.next_run IS NULL OR se.next_run <= NOW())\nORDER BY se.next_run ASC, s.priority DESC",
        "options": {}
      },
      "id": "get-schedules",
      "name": "Get Due Schedules",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 300],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "=// Process each schedule to check if it should run\nconst schedules = $input.all();\nconst outputSchedules = [];\n\nfor (const item of schedules) {\n  const schedule = item.json;\n  const now = new Date();\n  \n  // Parse cron expression and calculate next run\n  const cronParts = schedule.cron_expression.split(' ');\n  const shouldRun = checkIfDue(schedule, now);\n  \n  if (shouldRun) {\n    // Check overlap policy\n    if (schedule.overlap_policy === 'skip' && schedule.is_running) {\n      console.log(`Skipping ${schedule.name} - already running`);\n      continue;\n    }\n    \n    // Add execution metadata\n    schedule.execution_id = generateExecutionId();\n    schedule.scheduled_time = now.toISOString();\n    outputSchedules.push({ json: schedule });\n  }\n}\n\nreturn outputSchedules;\n\nfunction checkIfDue(schedule, now) {\n  if (!schedule.next_run) return true;\n  const nextRun = new Date(schedule.next_run);\n  return nextRun <= now;\n}\n\nfunction generateExecutionId() {\n  return 'exec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n}"
      },
      "id": "process-schedules",
      "name": "Process Schedules",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-schedules",
              "leftValue": "={{ $json.length > 0 }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-schedules",
      "name": "Has Schedules?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO schedule_executions (\n  id, schedule_id, status, scheduled_time, started_at\n) VALUES (\n  '{{ $json.execution_id }}',\n  '{{ $json.id }}',\n  'running',\n  '{{ $json.scheduled_time }}',\n  NOW()\n)\nON CONFLICT (id) DO NOTHING\nRETURNING *",
        "options": {}
      },
      "id": "create-execution",
      "name": "Create Execution Record",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1450, 250],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "method": "={{ $json.target_method || 'POST' }}",
        "url": "={{ $json.target_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Schedule-ID",
              "value": "={{ $json.id }}"
            },
            {
              "name": "X-Execution-ID",
              "value": "={{ $json.execution_id }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": "={{ $json.target_payload || {} }}"
        },
        "options": {
          "timeout": "={{ $json.timeout_seconds || 300 }}",
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "execute-target",
      "name": "Execute Target",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 250],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "=// Process execution result\nconst execution = $input.all()[0].json;\nconst response = $input.all()[0];\nconst success = !response.error && response.statusCode >= 200 && response.statusCode < 300;\n\nconst result = {\n  execution_id: execution.execution_id,\n  schedule_id: execution.id,\n  status: success ? 'success' : 'failed',\n  completed_at: new Date().toISOString(),\n  response_code: response.statusCode || 0,\n  response_body: response.body ? JSON.stringify(response.body).slice(0, 5000) : null,\n  error_message: response.error ? response.error.message : null,\n  execution_time_ms: Date.now() - new Date(execution.started_at).getTime()\n};\n\nreturn [{ json: result }];"
      },
      "id": "process-result",
      "name": "Process Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 250]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE schedule_executions\nSET \n  status = '{{ $json.status }}',\n  completed_at = '{{ $json.completed_at }}',\n  response_code = {{ $json.response_code }},\n  response_body = '{{ $json.response_body }}',\n  error_message = '{{ $json.error_message }}',\n  execution_time_ms = {{ $json.execution_time_ms }}\nWHERE id = '{{ $json.execution_id }}';\n\n-- Update schedule metrics\nUPDATE schedules\nSET \n  last_run = '{{ $json.completed_at }}',\n  next_run = calculate_next_run(cron_expression, timezone),\n  total_executions = total_executions + 1,\n  {{ $json.status === 'success' ? 'successful_executions = successful_executions + 1, consecutive_failures = 0' : 'failed_executions = failed_executions + 1, consecutive_failures = consecutive_failures + 1' }}\nWHERE id = '{{ $json.schedule_id }}';",
        "options": {}
      },
      "id": "update-execution",
      "name": "Update Execution",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2050, 250],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "failed",
              "leftValue": "={{ $json.status }}",
              "rightValue": "failed",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "has-retries",
              "leftValue": "={{ $json.max_retries > 0 }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-retry",
      "name": "Should Retry?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2250, 250]
    },
    {
      "parameters": {
        "command": "=bash -c \"vrooli resource n8n execute-workflow 'retry-handler' '{\\\"execution_id\\\":\\\"{{ $json.execution_id }}\\\",\\\"schedule_id\\\":\\\"{{ $json.schedule_id }}\\\",\\\"retry_count\\\":1,\\\"max_retries\\\":{{ $json.max_retries }},\\\"retry_strategy\\\":\\\"{{ $json.retry_strategy }}\\\"}' --quiet 2>&1\"",
        "options": {
          "timeout": 30000
        }
      },
      "id": "trigger-retry",
      "name": "Trigger Retry Handler",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [2450, 200],
      "continueOnFail": true
    }
  ],
  "connections": {
    "cron-trigger": {
      "main": [
        [
          {
            "node": "merge-triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual-trigger": {
      "main": [
        [
          {
            "node": "manual-defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual-defaults": {
      "main": [
        [
          {
            "node": "merge-triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge-triggers": {
      "main": [
        [
          {
            "node": "get-schedules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-schedules": {
      "main": [
        [
          {
            "node": "process-schedules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-schedules": {
      "main": [
        [
          {
            "node": "check-schedules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-schedules": {
      "main": [
        [
          {
            "node": "create-execution",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "create-execution": {
      "main": [
        [
          {
            "node": "execute-target",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "execute-target": {
      "main": [
        [
          {
            "node": "process-result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-result": {
      "main": [
        [
          {
            "node": "update-execution",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update-execution": {
      "main": [
        [
          {
            "node": "check-retry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-retry": {
      "main": [
        [
          {
            "node": "trigger-retry",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "workflow-scheduler-executor"
  },
  "tags": [
    {
      "name": "workflow-scheduler"
    }
  ]
}