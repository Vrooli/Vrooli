{
  "name": "Notification Router",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "notification-router",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "notification-router-webhook"
    },
    {
      "parameters": {
        "jsCode": "=// Process and categorize notification\nconst notification = $input.all()[0].json;\n\n// Determine notification channels based on severity\nconst channels = [];\nconst severity = notification.severity || (notification.critical_count > 0 ? 'critical' : 'warning');\n\nswitch (severity) {\n  case 'critical':\n    channels.push('email', 'slack', 'webhook', 'log');\n    break;\n  case 'warning':\n    channels.push('email', 'log');\n    break;\n  case 'info':\n    channels.push('log');\n    break;\n  default:\n    channels.push('log');\n}\n\n// Format notification for different channels\nconst formatted = {\n  ...notification,\n  severity,\n  channels,\n  formatted_message: formatMessage(notification),\n  formatted_html: formatHtml(notification),\n  formatted_slack: formatSlack(notification)\n};\n\nreturn [{ json: formatted }];\n\nfunction formatMessage(notif) {\n  let msg = `ðŸ”” Workflow Scheduler Alert\\n`;\n  msg += `Severity: ${severity.toUpperCase()}\\n`;\n  msg += `Time: ${notif.timestamp}\\n\\n`;\n  \n  if (notif.type === 'auto_disable') {\n    msg += notif.message + '\\n';\n    msg += 'Disabled schedules:\\n';\n    notif.schedules.forEach(s => {\n      msg += `  - ${s.name} (${s.id})\\n`;\n    });\n  } else if (notif.issues) {\n    msg += `Total Issues: ${notif.total_issues}\\n`;\n    if (notif.critical_count > 0) {\n      msg += `âš ï¸ Critical: ${notif.critical_count}\\n`;\n    }\n    if (notif.warning_count > 0) {\n      msg += `âš ï¸ Warnings: ${notif.warning_count}\\n`;\n    }\n    \n    if (notif.suggested_actions && notif.suggested_actions.length > 0) {\n      msg += '\\nSuggested Actions:\\n';\n      notif.suggested_actions.forEach(action => {\n        msg += `  â€¢ ${action}\\n`;\n      });\n    }\n  }\n  \n  return msg;\n}\n\nfunction formatHtml(notif) {\n  // HTML formatted version for emails\n  return `\n    <h2>Workflow Scheduler Alert</h2>\n    <p><strong>Severity:</strong> ${severity.toUpperCase()}</p>\n    <p><strong>Time:</strong> ${notif.timestamp}</p>\n    ${notif.message ? `<p>${notif.message}</p>` : ''}\n    ${notif.total_issues ? `<p><strong>Total Issues:</strong> ${notif.total_issues}</p>` : ''}\n  `;\n}\n\nfunction formatSlack(notif) {\n  // Slack block format\n  return {\n    blocks: [\n      {\n        type: 'header',\n        text: {\n          type: 'plain_text',\n          text: 'ðŸ”” Workflow Scheduler Alert'\n        }\n      },\n      {\n        type: 'section',\n        fields: [\n          {\n            type: 'mrkdwn',\n            text: `*Severity:* ${severity.toUpperCase()}`\n          },\n          {\n            type: 'mrkdwn',\n            text: `*Time:* ${notif.timestamp}`\n          }\n        ]\n      }\n    ]\n  };\n}"
      },
      "id": "process-notification",
      "name": "Process Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-email",
              "leftValue": "={{ $json.channels.includes('email') }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-email",
      "name": "Send Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 250]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Get email recipients from notification settings\nSELECT \n  ns.recipient_email,\n  ns.recipient_name\nFROM notification_settings ns\nWHERE ns.enabled = true\nAND ns.channel = 'email'\nAND (\n  ns.severity_filter IS NULL OR\n  ns.severity_filter @> '\"{{ $json.severity }}\"'\n);",
        "options": {}
      },
      "id": "get-recipients",
      "name": "Get Email Recipients",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 200],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.recipient_email }}",
        "subject": "=Workflow Scheduler Alert - {{ $('process-notification').item.json.severity.toUpperCase() }}",
        "emailType": "html",
        "htmlBody": "={{ $('process-notification').item.json.formatted_html }}",
        "options": {
          "allowUnauthorizedCerts": true
        }
      },
      "id": "send-email",
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1050, 200],
      "continueOnFail": true,
      "credentials": {
        "smtp": {
          "id": "smtp_workflow_scheduler",
          "name": "SMTP"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-slack",
              "leftValue": "={{ $json.channels.includes('slack') }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-slack",
      "name": "Send Slack?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 350]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Get Slack webhook URLs from settings\nSELECT \n  ns.webhook_url,\n  ns.channel_name\nFROM notification_settings ns\nWHERE ns.enabled = true\nAND ns.channel = 'slack'\nAND (\n  ns.severity_filter IS NULL OR\n  ns.severity_filter @> '\"{{ $json.severity }}\"'\n);",
        "options": {}
      },
      "id": "get-slack-webhooks",
      "name": "Get Slack Webhooks",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 300],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.webhook_url }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": "={{ $('process-notification').item.json.formatted_slack }}"
        },
        "options": {}
      },
      "id": "send-slack",
      "name": "Send to Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-webhook",
              "leftValue": "={{ $json.channels.includes('webhook') }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-webhook",
      "name": "Send Webhook?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 450]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Get custom webhook endpoints\nSELECT \n  ns.webhook_url,\n  ns.webhook_headers,\n  ns.webhook_method\nFROM notification_settings ns\nWHERE ns.enabled = true\nAND ns.channel = 'webhook'\nAND (\n  ns.severity_filter IS NULL OR\n  ns.severity_filter @> '\"{{ $json.severity }}\"'\n);",
        "options": {}
      },
      "id": "get-webhooks",
      "name": "Get Custom Webhooks",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "method": "={{ $json.webhook_method || 'POST' }}",
        "url": "={{ $json.webhook_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": "={{ JSON.parse($json.webhook_headers || '[]') }}"
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": "={{ $('process-notification').item.json }}"
        },
        "options": {}
      },
      "id": "send-webhook",
      "name": "Send to Webhook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=-- Log notification to database\nINSERT INTO notification_logs (\n  notification_type,\n  severity,\n  channels,\n  payload,\n  created_at\n) VALUES (\n  '{{ $json.type || \"health_check\" }}',\n  '{{ $json.severity }}',\n  ARRAY[{{ $json.channels.map(c => \"'\" + c + \"'\").join(\",\") }}],\n  '{{ JSON.stringify($json) }}'::jsonb,\n  NOW()\n);",
        "options": {}
      },
      "id": "log-notification",
      "name": "Log Notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 550],
      "credentials": {
        "postgres": {
          "id": "postgres_workflow_scheduler",
          "name": "Workflow Scheduler DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "=// Summarize notification delivery\nconst results = {\n  notification_id: generateNotificationId(),\n  timestamp: new Date().toISOString(),\n  severity: $('process-notification').item.json.severity,\n  channels_attempted: $('process-notification').item.json.channels,\n  delivery_status: {\n    email: $('send-email').item ? 'sent' : 'skipped',\n    slack: $('send-slack').item ? 'sent' : 'skipped',\n    webhook: $('send-webhook').item ? 'sent' : 'skipped',\n    log: 'recorded'\n  },\n  message: 'Notification processed successfully'\n};\n\nreturn [{ json: results }];\n\nfunction generateNotificationId() {\n  return 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n}"
      },
      "id": "summarize",
      "name": "Summarize Delivery",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 550]
    },
    {
      "parameters": {
        "content": "={{ JSON.stringify($json, null, 2) }}",
        "respondWith": "json",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1450, 550]
    }
  ],
  "connections": {
    "webhook": {
      "main": [
        [
          {
            "node": "process-notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-notification": {
      "main": [
        [
          {
            "node": "check-email",
            "type": "main",
            "index": 0
          },
          {
            "node": "check-slack",
            "type": "main",
            "index": 0
          },
          {
            "node": "check-webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "log-notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-email": {
      "main": [
        [
          {
            "node": "get-recipients",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "get-recipients": {
      "main": [
        [
          {
            "node": "send-email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-slack": {
      "main": [
        [
          {
            "node": "get-slack-webhooks",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "get-slack-webhooks": {
      "main": [
        [
          {
            "node": "send-slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-webhook": {
      "main": [
        [
          {
            "node": "get-webhooks",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "get-webhooks": {
      "main": [
        [
          {
            "node": "send-webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "log-notification": {
      "main": [
        [
          {
            "node": "summarize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "summarize": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "workflow-scheduler-notifications"
  },
  "tags": [
    {
      "name": "workflow-scheduler"
    }
  ]
}