name: workflow-scheduler
description: Test suite for Workflow Scheduler scenario
version: 1.0.0

resources:
  postgres: required
  redis: required
  n8n: required
  windmill: optional

setup:
  - name: Build API server
    run: cd api && go build -o workflow-scheduler-api main.go
    timeout: 60

  - name: Initialize database
    run: |
      PGPASSWORD=postgres psql -h localhost -p ${RESOURCE_PORTS[postgres]} \
        -U postgres -c "CREATE DATABASE workflow_scheduler;" || true
      PGPASSWORD=postgres psql -h localhost -p ${RESOURCE_PORTS[postgres]} \
        -U postgres -d workflow_scheduler \
        -f initialization/storage/postgres/schema.sql
    timeout: 30

tests:
  - name: API compilation
    description: Verify Go API compiles successfully
    run: cd api && go build -o test-build main.go && rm test-build
    expected: success
    timeout: 30

  - name: API health check
    description: Verify API server is healthy
    run: curl -sf http://localhost:${SERVICE_PORT}/health
    expected: success
    timeout: 10
    retry: 5

  - name: Database connectivity
    description: Verify database connection works
    run: curl -sf http://localhost:${SERVICE_PORT}/api/system/db-status
    expected: success
    timeout: 10

  - name: Redis connectivity
    description: Verify Redis connection works  
    run: curl -sf http://localhost:${SERVICE_PORT}/api/system/redis-status
    expected: success
    timeout: 10

  - name: Schedule CRUD operations
    description: Test create, read, update, delete schedule
    run: |
      # Create schedule
      SCHEDULE_ID=$(curl -sf -X POST http://localhost:${SERVICE_PORT}/api/schedules \
        -H "Content-Type: application/json" \
        -d '{
          "name": "Test Schedule",
          "cron_expression": "0 * * * *",
          "target_type": "webhook",
          "target_url": "http://localhost:5678/webhook/test"
        }' | jq -r '.id')
      
      # Read schedule
      curl -sf http://localhost:${SERVICE_PORT}/api/schedules/${SCHEDULE_ID}
      
      # Update schedule
      curl -sf -X PUT http://localhost:${SERVICE_PORT}/api/schedules/${SCHEDULE_ID} \
        -H "Content-Type: application/json" \
        -d '{"description": "Updated"}'
      
      # Delete schedule
      curl -sf -X DELETE http://localhost:${SERVICE_PORT}/api/schedules/${SCHEDULE_ID}
    expected: success
    timeout: 20

  - name: Cron validation
    description: Test cron expression validation
    run: |
      curl -sf "http://localhost:${SERVICE_PORT}/api/cron/validate?expression=0%209%20*%20*%20*" | \
        jq -e '.valid == true'
    expected: success
    timeout: 10

  - name: CLI functionality
    description: Test CLI commands work
    run: |
      scheduler-cli --version
      scheduler-cli list
      scheduler-cli presets
    expected: success
    timeout: 10

  - name: n8n workflow availability
    description: Verify n8n workflows are loaded
    run: |
      curl -sf http://localhost:${RESOURCE_PORTS[n8n]}/rest/workflows | \
        jq -e '.data | length > 0'
    expected: success
    timeout: 10
    retry: 3

  - name: PostgreSQL schema validation
    description: Verify all database tables exist
    run: |
      PGPASSWORD=postgres psql -h localhost -p ${RESOURCE_PORTS[postgres]} \
        -U postgres -d workflow_scheduler -c "\dt" | \
        grep -E "(schedules|schedule_executions|retry_queue|notification_settings|metrics_history)"
    expected: success
    timeout: 10

  - name: Integration test suite
    description: Run comprehensive integration tests
    run: bash test.sh
    expected: success
    timeout: 60

cleanup:
  - name: Stop API server
    run: pkill -f 'workflow-scheduler-api' || true

  - name: Clean test data
    run: |
      PGPASSWORD=postgres psql -h localhost -p ${RESOURCE_PORTS[postgres]} \
        -U postgres -d workflow_scheduler \
        -c "DELETE FROM schedules WHERE name LIKE 'Test%';" || true