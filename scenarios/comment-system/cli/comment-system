#!/bin/bash
################################################################################
# Comment System CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="comment-system"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the new ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}âŒ Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
usage() {
    echo -e "${CYAN}Comment System CLI${NC}"
    echo "Universal comment management for Vrooli scenarios"
    echo ""
    echo "Usage: comment-system [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}health${NC}      Check system health and connectivity"
    echo -e "  ${GREEN}list${NC}        List comments for a scenario"
    echo -e "  ${GREEN}create${NC}      Create a new comment"
    echo -e "  ${GREEN}update${NC}      Update an existing comment"
    echo -e "  ${GREEN}delete${NC}      Delete a comment"
    echo -e "  ${GREEN}config${NC}      Manage scenario configurations"
    echo -e "  ${GREEN}moderate${NC}    Moderate comments (admin)"
    echo -e "  ${GREEN}stats${NC}       Show admin statistics"
    echo -e "  ${GREEN}docs${NC}        Show API documentation"
    echo ""
    echo "Examples:"
    echo "  comment-system health"
    echo "  comment-system list picker-wheel"
    echo "  comment-system create study-buddy \"Great scenario!\""
    echo "  comment-system config picker-wheel get"
    echo "  comment-system moderate abc123 approve"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (where applicable)"
    echo "  --verbose        Show detailed information"
    echo ""
    echo "For more information: comment-system <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL from orchestrator
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Health check command
cmd_health() {
    local json_output=false
    local verbose=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --verbose)
                verbose=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system health [OPTIONS]"
                echo ""
                echo "Check Comment System health and connectivity"
                echo ""
                echo "Options:"
                echo "  --json      Output status in JSON format"
                echo "  --verbose   Show detailed health information"
                echo ""
                echo "Examples:"
                echo "  comment-system health"
                echo "  comment-system health --json --verbose"
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    echo -e "${BLUE}ðŸ¥ Checking Comment System status...${NC}"
    
    local response
    response=$(api_request "GET" "/health")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local status
        status=$(echo "$response" | jq -r '.status // "unknown"' 2>/dev/null)
        
        case $status in
            "healthy")
                echo -e "${GREEN}âœ… Comment System is healthy${NC}"
                ;;
            "unhealthy")
                echo -e "${RED}âŒ Comment System is unhealthy${NC}"
                ;;
            *)
                echo -e "${YELLOW}âš ï¸  Comment System status unknown${NC}"
                ;;
        esac
        
        if [[ $verbose == true ]]; then
            echo ""
            echo -e "${CYAN}Detailed Status:${NC}"
            echo "$response" | jq -r '
                "  Database: \(.database // "unknown")",
                "  Version: \(.version // "unknown")",
                "  Dependencies:",
                "    Session Auth: \(.dependencies.session_authenticator // "unknown")",
                "    Notifications: \(.dependencies.notification_hub // "unknown")"
            ' 2>/dev/null || echo "$response" | format_json
        fi
    fi
}

# List comments command
cmd_list() {
    local scenario="$1"
    local format="${2:-table}"
    local limit=""
    local offset=""
    local parent_id=""
    local sort=""
    local json_output=false
    
    if [[ -z "$scenario" || "$scenario" == "--help" || "$scenario" == "-h" ]]; then
        echo "Usage: comment-system list <scenario> [OPTIONS]"
        echo ""
        echo "List comments for a scenario"
        echo ""
        echo "Arguments:"
        echo "  scenario    Name of the scenario"
        echo ""
        echo "Options:"
        echo "  --format <fmt>     Output format (table, json, tree) [default: table]"  
        echo "  --limit <num>      Maximum number of comments [default: 20]"
        echo "  --offset <num>     Skip this many comments [default: 0]"
        echo "  --parent-id <id>   Filter by parent comment ID"
        echo "  --sort <type>      Sort order (newest, oldest, threaded) [default: newest]"
        echo "  --json             Output in JSON format"
        echo ""
        echo "Examples:"
        echo "  comment-system list picker-wheel"
        echo "  comment-system list study-buddy --format json --limit 50"
        echo "  comment-system list retro-game --format tree --sort threaded"
        return 0
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --format)
                format="$2"
                shift 2
                ;;
            --limit)
                limit="$2"
                shift 2
                ;;
            --offset)
                offset="$2"
                shift 2
                ;;
            --parent-id)
                parent_id="$2"
                shift 2
                ;;
            --sort)
                sort="$2"
                shift 2
                ;;
            --json)
                json_output=true
                format="json"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Build query parameters
    local query_params=""
    [[ -n "$limit" ]] && query_params="${query_params:+$query_params&}limit=$limit"
    [[ -n "$offset" ]] && query_params="${query_params:+$query_params&}offset=$offset"
    [[ -n "$parent_id" ]] && query_params="${query_params:+$query_params&}parent_id=$parent_id"
    [[ -n "$sort" ]] && query_params="${query_params:+$query_params&}sort=$sort"
    
    local endpoint="/api/v1/comments/$scenario"
    [[ -n "$query_params" ]] && endpoint="${endpoint}?${query_params}"
    
    local response
    response=$(api_request "GET" "$endpoint")
    
    if [[ $format == "json" || $json_output == true ]]; then
        echo "$response" | format_json
    elif [[ $format == "tree" ]]; then
        # Tree format for threaded comments
        local count=$(echo "$response" | jq -r '.comments | length' 2>/dev/null || echo "0")
        echo -e "${CYAN}ðŸ’¬ Comments ($scenario): $count${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.comments[] | [(.depth // 0), .id[0:8], (.author_name // "Anonymous"), .content[0:40]] | @tsv' 2>/dev/null | \
            while IFS=$'\t' read -r depth id author content; do
                local indent=""
                for ((i=0; i<depth; i++)); do
                    indent="  $indent"
                done
                echo "${indent}â”œâ”€ [$id] $author: $content"
            done
        else
            echo "No comments found."
        fi
    else
        # Table format (default)
        local count=$(echo "$response" | jq -r '.comments | length' 2>/dev/null || echo "0")
        local total=$(echo "$response" | jq -r '.total_count // 0' 2>/dev/null)
        echo -e "${CYAN}ðŸ’¬ Comments ($scenario): $count/$total${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.comments[] | [.id[0:8], (.author_name // "Anonymous"), .content[0:50], .created_at[0:19]] | @tsv' 2>/dev/null | \
            {
                printf "%-10s %-15s %-50s %s\n" "ID" "AUTHOR" "CONTENT" "CREATED"
                printf "%-10s %-15s %-50s %s\n" "----------" "---------------" "--------------------------------------------------" "-------------------"
                while IFS=$'\t' read -r id author content created; do
                    printf "%-10s %-15s %-50s %s\n" "$id" "$author" "$content" "$created"
                done
            }
        else
            echo "No comments found."
        fi
    fi
}

# Create comment command
cmd_create() {
    local scenario="$1"
    local content="$2"
    local parent_id=""
    local content_type="markdown"
    local author_token=""
    local json_output=false
    
    if [[ -z "$scenario" || -z "$content" ]]; then
        echo -e "${RED}âŒ Error: Scenario and content are required${NC}" >&2
        echo "Usage: comment-system create <scenario> <content> [OPTIONS]" >&2
        return 1
    fi
    
    shift 2
    while [[ $# -gt 0 ]]; do
        case $1 in
            --parent-id)
                parent_id="$2"
                shift 2
                ;;
            --content-type)
                content_type="$2"
                shift 2
                ;;
            --author-token)
                author_token="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system create <scenario> <content> [OPTIONS]"
                echo ""
                echo "Create a new comment"
                echo ""
                echo "Arguments:"
                echo "  scenario      Target scenario name"
                echo "  content       Comment content"
                echo ""
                echo "Options:"
                echo "  --parent-id <id>        Parent comment ID for replies"
                echo "  --content-type <type>   Content format (markdown, plaintext) [default: markdown]"
                echo "  --author-token <token>  Author authentication token"
                echo "  --json                  Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  comment-system create picker-wheel \"Great tool!\""
                echo "  comment-system create study-buddy \"Very helpful\" --parent-id abc123"
                echo "  comment-system create notes \"Simple comment\" --content-type plaintext"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Build request JSON
    local request_body
    request_body=$(jq -n \
        --arg content "$content" \
        --arg content_type "$content_type" \
        --arg author_token "$author_token" \
        --arg parent_id "$parent_id" \
        '{
            content: $content,
            content_type: $content_type,
            author_token: $author_token
        } + (if $parent_id != "" then {parent_id: $parent_id} else {} end)')
    
    echo -e "${BLUE}ðŸ’¬ Creating comment in $scenario...${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/comments/$scenario" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
            local comment_id
            comment_id=$(echo "$response" | jq -r '.comment.id[0:8] // "unknown"' 2>/dev/null)
            echo -e "${GREEN}âœ… Comment created: $comment_id${NC}"
        else
            echo -e "${RED}âŒ Failed to create comment${NC}"
            echo "$response" | jq -r '.error // "Unknown error"' 2>/dev/null || echo "$response"
            return 1
        fi
    fi
}

# Update comment command
cmd_update() {
    local comment_id="$1"
    local content=""
    local content_type=""
    local author_token=""
    local json_output=false
    
    if [[ -z "$comment_id" ]]; then
        echo -e "${RED}âŒ Error: Comment ID is required${NC}" >&2
        echo "Usage: comment-system update <comment_id> [OPTIONS]" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --content)
                content="$2"
                shift 2
                ;;
            --content-type)
                content_type="$2"
                shift 2
                ;;
            --author-token)
                author_token="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system update <comment_id> [OPTIONS]"
                echo ""
                echo "Update an existing comment"
                echo ""
                echo "Arguments:"
                echo "  comment_id    ID of the comment to update"
                echo ""
                echo "Options:"
                echo "  --content <text>        New comment content"
                echo "  --content-type <type>   New content format"
                echo "  --author-token <token>  Author authentication token (required)"
                echo "  --json                  Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  comment-system update abc123 --content \"Updated content\" --author-token token123"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    if [[ -z "$author_token" ]]; then
        echo -e "${RED}âŒ Error: Author token is required for updates${NC}" >&2
        return 1
    fi
    
    # Build request JSON
    local request_body
    request_body=$(jq -n \
        --arg content "$content" \
        --arg content_type "$content_type" \
        --arg author_token "$author_token" \
        '{
            author_token: $author_token
        } + (if $content != "" then {content: $content} else {} end)
          + (if $content_type != "" then {content_type: $content_type} else {} end)')
    
    echo -e "${BLUE}ðŸ“ Updating comment: $comment_id${NC}"
    
    local response
    response=$(api_request "PUT" "/api/v1/comments/$comment_id" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… Comment updated: $comment_id${NC}"
        else
            echo -e "${RED}âŒ Failed to update comment${NC}"
            echo "$response" | jq -r '.error // .message // "Unknown error"' 2>/dev/null || echo "$response"
            return 1
        fi
    fi
}

# Delete comment command
cmd_delete() {
    local comment_id="$1"
    local author_token=""
    local confirm=false
    local json_output=false
    
    if [[ -z "$comment_id" ]]; then
        echo -e "${RED}âŒ Error: Comment ID is required${NC}" >&2
        echo "Usage: comment-system delete <comment_id> [OPTIONS]" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --author-token)
                author_token="$2"
                shift 2
                ;;
            --confirm)
                confirm=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system delete <comment_id> [OPTIONS]"
                echo ""
                echo "Delete a comment (soft delete)"
                echo ""
                echo "Arguments:"
                echo "  comment_id    ID of the comment to delete"
                echo ""
                echo "Options:"
                echo "  --author-token <token>  Author authentication token (required)"
                echo "  --confirm               Skip confirmation prompt"
                echo "  --json                  Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  comment-system delete abc123 --author-token token123"
                echo "  comment-system delete abc123 --author-token token123 --confirm"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    if [[ -z "$author_token" ]]; then
        echo -e "${RED}âŒ Error: Author token is required for deletion${NC}" >&2
        return 1
    fi
    
    if [[ "$confirm" != true ]]; then
        echo -e "${YELLOW}âš ï¸  Are you sure you want to delete comment $comment_id? (y/N)${NC}"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            return 0
        fi
    fi
    
    echo -e "${BLUE}ðŸ—‘ï¸  Deleting comment: $comment_id${NC}"
    
    local response
    response=$(api_request "DELETE" "/api/v1/comments/$comment_id")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… Comment deleted: $comment_id${NC}"
        else
            echo -e "${RED}âŒ Failed to delete comment${NC}"
            echo "$response" | jq -r '.error // .message // "Unknown error"' 2>/dev/null || echo "$response"
            return 1
        fi
    fi
}

# Configuration management command
cmd_config() {
    local scenario="$1"
    local action="${2:-get}"
    local json_output=false
    
    if [[ -z "$scenario" ]]; then
        echo -e "${RED}âŒ Error: Scenario name is required${NC}" >&2
        echo "Usage: comment-system config <scenario> [get|set] [OPTIONS]" >&2
        return 1
    fi
    
    case $action in
        get)
            shift 2
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --json)
                        json_output=true
                        shift
                        ;;
                    --help|-h)
                        echo "Usage: comment-system config <scenario> get [OPTIONS]"
                        echo ""
                        echo "Get scenario configuration"
                        echo ""
                        echo "Arguments:"
                        echo "  scenario    Scenario name"
                        echo ""
                        echo "Options:"
                        echo "  --json      Output in JSON format"
                        echo ""
                        echo "Examples:"
                        echo "  comment-system config picker-wheel get"
                        echo "  comment-system config study-buddy get --json"
                        return 0
                        ;;
                    *)
                        shift
                        ;;
                esac
            done
            
            local response
            response=$(api_request "GET" "/api/v1/config/$scenario")
            
            if [[ $json_output == true ]]; then
                echo "$response" | format_json
            else
                echo -e "${CYAN}âš™ï¸  Configuration for $scenario:${NC}"
                echo "$response" | jq '.config' 2>/dev/null || echo "$response"
            fi
            ;;
            
        set)
            shift 2
            local config_data="{}"
            
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --auth-required)
                        config_data=$(echo "$config_data" | jq '. + {auth_required: true}')
                        shift
                        ;;
                    --no-auth-required)
                        config_data=$(echo "$config_data" | jq '. + {auth_required: false}')
                        shift
                        ;;
                    --allow-anonymous)
                        config_data=$(echo "$config_data" | jq '. + {allow_anonymous: true}')
                        shift
                        ;;
                    --no-allow-anonymous)
                        config_data=$(echo "$config_data" | jq '. + {allow_anonymous: false}')
                        shift
                        ;;
                    --rich-media)
                        config_data=$(echo "$config_data" | jq '. + {allow_rich_media: true}')
                        shift
                        ;;
                    --no-rich-media)
                        config_data=$(echo "$config_data" | jq '. + {allow_rich_media: false}')
                        shift
                        ;;
                    --moderation)
                        local level="$2"
                        config_data=$(echo "$config_data" | jq --arg level "$level" '. + {moderation_level: $level}')
                        shift 2
                        ;;
                    --json)
                        json_output=true
                        shift
                        ;;
                    --help|-h)
                        echo "Usage: comment-system config <scenario> set [OPTIONS]"
                        echo ""
                        echo "Set scenario configuration"
                        echo ""
                        echo "Arguments:"
                        echo "  scenario    Scenario name"
                        echo ""
                        echo "Options:"
                        echo "  --auth-required         Require user authentication"
                        echo "  --no-auth-required      Don't require authentication"  
                        echo "  --allow-anonymous       Allow anonymous comments"
                        echo "  --no-allow-anonymous    Disable anonymous comments"
                        echo "  --rich-media           Enable rich media attachments"
                        echo "  --no-rich-media        Disable rich media"
                        echo "  --moderation <level>   Set moderation level (none, manual, ai_assisted)"
                        echo "  --json                 Output in JSON format"
                        echo ""
                        echo "Examples:"
                        echo "  comment-system config study-buddy set --auth-required --moderation manual"
                        echo "  comment-system config notes set --allow-anonymous --no-rich-media"
                        return 0
                        ;;
                    *)
                        echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                        return 1
                        ;;
                esac
            done
            
            echo -e "${BLUE}âš™ï¸  Updating configuration for $scenario...${NC}"
            
            local response
            response=$(api_request "POST" "/api/v1/config/$scenario" "$config_data")
            
            if [[ $json_output == true ]]; then
                echo "$response" | format_json
            else
                if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
                    echo -e "${GREEN}âœ… Configuration updated for scenario: $scenario${NC}"
                    echo "$response" | jq '.config' 2>/dev/null
                else
                    echo -e "${RED}âŒ Failed to update configuration${NC}"
                    echo "$response" | jq -r '.error // .message // "Unknown error"' 2>/dev/null || echo "$response"
                    return 1
                fi
            fi
            ;;
            
        --help|-h)
            echo "Usage: comment-system config <scenario> [get|set] [OPTIONS]"
            echo ""
            echo "Manage scenario configurations"
            echo ""
            echo "Actions:"
            echo "  get     Show current configuration (default)"
            echo "  set     Update configuration with options"
            echo ""
            echo "Examples:"
            echo "  comment-system config picker-wheel get"
            echo "  comment-system config study-buddy set --auth-required --moderation manual"
            return 0
            ;;
            
        *)
            echo -e "${RED}âŒ Invalid action: $action. Use 'get' or 'set'${NC}" >&2
            return 1
            ;;
    esac
}

# Moderate comment command
cmd_moderate() {
    local comment_id="$1"
    local action="$2"
    local json_output=false
    
    if [[ -z "$comment_id" || -z "$action" ]]; then
        echo -e "${RED}âŒ Error: Comment ID and action are required${NC}" >&2
        echo "Usage: comment-system moderate <comment_id> <action> [OPTIONS]" >&2
        return 1
    fi
    
    shift 2
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system moderate <comment_id> <action> [OPTIONS]"
                echo ""
                echo "Moderate comments (admin only)"
                echo ""
                echo "Arguments:"
                echo "  comment_id  ID of the comment to moderate"
                echo "  action      Moderation action (approve, delete, flag)"
                echo ""
                echo "Options:"
                echo "  --json      Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  comment-system moderate abc123def456 approve"
                echo "  comment-system moderate spam-comment-id delete"
                echo "  comment-system moderate questionable-id flag"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    case $action in
        approve|delete|flag)
            ;;
        *)
            echo -e "${RED}âŒ Invalid action: $action. Use: approve, delete, flag${NC}" >&2
            return 1
            ;;
    esac
    
    local request_body
    request_body=$(jq -n --arg action "$action" '{action: $action}')
    
    echo -e "${BLUE}ðŸ›¡ï¸  Moderating comment $comment_id: $action${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/admin/moderate/$comment_id" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… Comment $comment_id has been ${action}d${NC}"
        else
            echo -e "${RED}âŒ Failed to moderate comment${NC}"
            echo "$response" | jq -r '.error // .message // "Unknown error"' 2>/dev/null || echo "$response"
            return 1
        fi
    fi
}

# Admin statistics command
cmd_stats() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system stats [OPTIONS]"
                echo ""
                echo "Show admin statistics"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  comment-system stats"
                echo "  comment-system stats --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}ðŸ“Š Fetching admin statistics...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/admin/stats")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${CYAN}ðŸ“ˆ Comment System Statistics:${NC}"
        echo "$response" | format_json
    fi
}

# API documentation command
cmd_docs() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: comment-system docs [OPTIONS]"
                echo ""
                echo "Show API documentation"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  comment-system docs"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/docs" 2>/dev/null)
    
    echo -e "${CYAN}ðŸ“š Comment System API Documentation:${NC}"
    echo "   API Endpoint: $api_url"
    echo ""
    echo "$response"
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        health)
            cmd_health "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        create|add|post)
            cmd_create "$@"
            ;;
        update|edit)
            cmd_update "$@"
            ;;
        delete|remove|rm)
            cmd_delete "$@"
            ;;
        config|configure)
            cmd_config "$@"
            ;;
        moderate|mod)
            cmd_moderate "$@"
            ;;
        stats|statistics)
            cmd_stats "$@"
            ;;
        docs|documentation)
            cmd_docs "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        --version|-v|version)
            echo "Comment System CLI v2.0.0 (thin wrapper)"
            ;;
        *)
            echo -e "${RED}âŒ Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"