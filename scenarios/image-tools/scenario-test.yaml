version: 1.0
scenario: image-tools

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/image-tools
    - cli/install.sh
    - plugins/plugin.go
    - plugins/jpeg/handler.go
    - plugins/png/handler.go
    - ui/index.html
    - ui/styles.css
    - ui/app.js
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - plugins
    - ui
    - initialization

# Resource validation
resources:
  required: [minio]
  optional: [redis, ollama]
  health_timeout: 60

# Declarative tests
tests:
  # Resource health checks
  - name: "Minio is accessible"
    type: http
    service: minio
    endpoint: /minio/health/ready
    method: GET
    expect:
      status: 200
      
  # API endpoint tests
  - name: "API health check"
    type: http
    service: api
    endpoint: /api/v1/health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  - name: "Plugins are loaded"
    type: http
    service: api
    endpoint: /api/v1/plugins
    method: GET
    expect:
      status: 200
      body:
        plugins:
          jpeg-optimizer: ["jpeg", "jpg"]
          png-optimizer: ["png"]
          
  - name: "Compress endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/image/compress
    method: POST
    headers:
      Content-Type: multipart/form-data
    expect:
      status: [200, 400]  # 400 if no image provided
      
  - name: "Resize endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/image/resize
    method: POST
    headers:
      Content-Type: multipart/form-data
    expect:
      status: [200, 400]
      
  - name: "Convert endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/image/convert
    method: POST
    headers:
      Content-Type: multipart/form-data
    expect:
      status: [200, 400]
      
  - name: "Metadata endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/image/metadata
    method: POST
    headers:
      Content-Type: multipart/form-data
    expect:
      status: [200, 400]
      
  - name: "Batch endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/image/batch
    method: POST
    headers:
      Content-Type: multipart/form-data
    expect:
      status: [200, 400]
      
  # CLI command tests
  - name: "CLI shows help"
    type: exec
    command: ./cli/image-tools help
    expect:
      exit_code: 0
      output_contains: ["Image Tools CLI", "COMMANDS", "compress", "resize"]
      
  - name: "CLI shows version"
    type: exec
    command: ./cli/image-tools version
    expect:
      exit_code: 0
      output_contains: ["image-tools", "v1.0.0"]
      
  - name: "CLI status command works"
    type: exec
    command: ./cli/image-tools status --json
    expect:
      exit_code: 0
      output_json:
        status: healthy

# Performance validation
performance:
  - name: "Compression under 2s for small image"
    type: http
    service: api
    endpoint: /api/v1/image/compress
    method: POST
    timeout: 2000
    expect:
      status: [200, 400]
      
  - name: "Resize under 2s"
    type: http
    service: api
    endpoint: /api/v1/image/resize
    method: POST
    timeout: 2000
    expect:
      status: [200, 400]

# UI validation
ui:
  - name: "UI loads successfully"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      content_type: text/html
      
  - name: "CSS loads"
    type: http
    service: ui
    endpoint: /styles.css
    method: GET
    expect:
      status: 200
      content_type: text/css
      
  - name: "JavaScript loads"
    type: http
    service: ui
    endpoint: /app.js
    method: GET
    expect:
      status: 200
      content_type: application/javascript