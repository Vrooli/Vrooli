{
  "name": "Algorithm Executor",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "algorithm/execute",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Return test defaults for manual trigger\nreturn {\n  code: 'def quicksort(arr):\\n    if len(arr) <= 1:\\n        return arr\\n    pivot = arr[len(arr) // 2]\\n    left = [x for x in arr if x < pivot]\\n    middle = [x for x in arr if x == pivot]\\n    right = [x for x in arr if x > pivot]\\n    return quicksort(left) + middle + quicksort(right)\\n\\nprint(quicksort([3, 7, 1, 4, 6, 2, 5]))',\n  language: 'python',\n  stdin: '',\n  expected_output: '[1, 2, 3, 4, 5, 6, 7]',\n  timeout: 5\n};"
      },
      "id": "set_test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Validate and prepare input for Judge0\nconst input = $input.item.json;\n\n// Validate required fields\nif (!input.code || typeof input.code !== 'string' || input.code.trim().length === 0) {\n  throw new Error('Missing required parameter: code');\n}\n\nif (!input.language || typeof input.language !== 'string') {\n  throw new Error('Missing required parameter: language');\n}\n\n// Language ID mapping for Judge0\nconst languageMap = {\n  'python': 71,      // Python 3.8\n  'javascript': 63,  // JavaScript (Node.js)\n  'java': 62,        // Java (OpenJDK)\n  'cpp': 54,         // C++ (GCC)\n  'c': 50,           // C (GCC)\n  'go': 60,          // Go\n  'rust': 73,        // Rust\n  'ruby': 72,        // Ruby\n  'typescript': 74,  // TypeScript\n  'csharp': 51       // C#\n};\n\nconst languageId = languageMap[input.language.toLowerCase()];\nif (!languageId) {\n  throw new Error('Unsupported language: ' + input.language);\n}\n\n// Get optional parameters with defaults\nconst stdin = input.stdin || '';\nconst expectedOutput = input.expected_output || null;\nconst timeout = Math.min(Math.max(input.timeout || 5, 1), 30); // Between 1 and 30 seconds\n\n// Build Judge0 submission\nconst submission = {\n  source_code: input.code,\n  language_id: languageId,\n  stdin: stdin,\n  cpu_time_limit: timeout,\n  memory_limit: 128000, // 128MB\n  expected_output: expectedOutput\n};\n\nreturn {\n  submission: submission,\n  language: input.language,\n  has_expected_output: expectedOutput !== null,\n  execution_id: 'algo_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8)\n};"
      },
      "id": "prepare_submission",
      "name": "Prepare Submission",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://localhost:${service.judge0.port}/submissions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "source_code",
              "value": "={{ $json.submission.source_code }}"
            },
            {
              "name": "language_id",
              "value": "={{ $json.submission.language_id }}"
            },
            {
              "name": "stdin",
              "value": "={{ $json.submission.stdin }}"
            },
            {
              "name": "cpu_time_limit",
              "value": "={{ $json.submission.cpu_time_limit }}"
            },
            {
              "name": "memory_limit",
              "value": "={{ $json.submission.memory_limit }}"
            },
            {
              "name": "expected_output",
              "value": "={{ $json.submission.expected_output }}"
            }
          ]
        },
        "options": {}
      },
      "id": "submit_to_judge0",
      "name": "Submit to Judge0",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "seconds"
      },
      "id": "wait_for_execution",
      "name": "Wait for Execution",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://localhost:${service.judge0.port}/submissions/{{ $json.token }}",
        "options": {}
      },
      "id": "get_result",
      "name": "Get Result",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process Judge0 results\nconst result = $input.item.json;\nconst submissionData = $('Prepare Submission').item.json;\n\n// Status mapping\nconst statusMap = {\n  1: 'In Queue',\n  2: 'Processing',\n  3: 'Accepted',\n  4: 'Wrong Answer',\n  5: 'Time Limit Exceeded',\n  6: 'Compilation Error',\n  7: 'Runtime Error (SIGSEGV)',\n  8: 'Runtime Error (SIGXFSZ)',\n  9: 'Runtime Error (SIGFPE)',\n  10: 'Runtime Error (SIGABRT)',\n  11: 'Runtime Error (NZEC)',\n  12: 'Runtime Error (Other)',\n  13: 'Internal Error',\n  14: 'Exec Format Error'\n};\n\nconst statusDescription = statusMap[result.status.id] || 'Unknown Status';\nconst passed = result.status.id === 3;\nconst executionComplete = result.status.id > 2;\n\n// Build comprehensive response\nconst response = {\n  // Core results\n  success: passed,\n  status: statusDescription,\n  status_id: result.status.id,\n  execution_complete: executionComplete,\n  \n  // Output data\n  output: result.stdout || '',\n  error_output: result.stderr || '',\n  compile_output: result.compile_output || '',\n  message: result.message || '',\n  \n  // Performance metrics\n  execution_time: result.time ? parseFloat(result.time) * 1000 + ' ms' : null,\n  memory_used: result.memory ? result.memory + ' KB' : null,\n  \n  // Test comparison (if expected output provided)\n  test_result: submissionData.has_expected_output ? {\n    expected: submissionData.submission.expected_output,\n    actual: result.stdout ? result.stdout.trim() : '',\n    match: passed\n  } : null,\n  \n  // Metadata\n  language: submissionData.language,\n  execution_id: submissionData.execution_id,\n  submission_token: result.token,\n  \n  // Error details (if failed)\n  error_details: !passed && executionComplete ? {\n    status: statusDescription,\n    compile_error: result.compile_output || null,\n    runtime_error: result.stderr || null,\n    message: result.message || null\n  } : null\n};\n\nreturn response;"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.execution_complete }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check_complete",
      "name": "Check Complete",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1800, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json, null, 2) }}",
        "responseHeaders": {
          "values": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "respond_success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ error: 'Execution not complete, please retry', status: $json.status, execution_id: $json.execution_id }, null, 2) }}",
        "responseCode": 202,
        "responseHeaders": {
          "values": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "respond_pending",
      "name": "Respond Pending",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 500]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{"node": "merge_triggers", "type": "main", "index": 0}]]
    },
    "manual_trigger": {
      "main": [[{"node": "set_test_defaults", "type": "main", "index": 0}]]
    },
    "set_test_defaults": {
      "main": [[{"node": "merge_triggers", "type": "main", "index": 1}]]
    },
    "merge_triggers": {
      "main": [[{"node": "prepare_submission", "type": "main", "index": 0}]]
    },
    "prepare_submission": {
      "main": [[{"node": "submit_to_judge0", "type": "main", "index": 0}]]
    },
    "submit_to_judge0": {
      "main": [[{"node": "wait_for_execution", "type": "main", "index": 0}]]
    },
    "wait_for_execution": {
      "main": [[{"node": "get_result", "type": "main", "index": 0}]]
    },
    "get_result": {
      "main": [[{"node": "format_response", "type": "main", "index": 0}]]
    },
    "format_response": {
      "main": [[{"node": "check_complete", "type": "main", "index": 0}]]
    },
    "check_complete": {
      "main": [
        [{"node": "respond_success", "type": "main", "index": 0}],
        [{"node": "respond_pending", "type": "main", "index": 0}]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "id": "algorithm-executor",
  "meta": {
    "templateVersion": 1
  },
  "tags": []
}