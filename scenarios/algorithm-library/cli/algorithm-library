#!/bin/bash

# Algorithm Library CLI
# Provides command-line access to the algorithm library

set -e

# Configuration
API_HOST="${ALGORITHM_LIBRARY_API_HOST:-localhost}"
API_PORT="${ALGORITHM_LIBRARY_API_PORT:-3250}"
API_URL="http://${API_HOST}:${API_PORT}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat << EOF
Algorithm Library CLI - Validated algorithm and data structure reference

USAGE:
    algorithm-library <command> [arguments] [options]

COMMANDS:
    search <query>           Search for algorithms by name or description
    get <algorithm>          Get details and implementations for an algorithm
    validate <algorithm> <file>  Validate your implementation against test cases
    categories               List all algorithm categories
    stats                    Show library statistics
    status                   Check service health status
    help                     Show this help message
    version                  Show version information

OPTIONS:
    --category <name>        Filter by category (sorting, graph, etc.)
    --language <lang>        Filter by programming language
    --complexity <O(n)>      Filter by time complexity
    --difficulty <level>     Filter by difficulty (easy, medium, hard)
    --json                   Output in JSON format
    --benchmark             Include performance benchmarking (for validate)
    --all-languages         Get all language implementations (for get)

EXAMPLES:
    algorithm-library search quicksort
    algorithm-library search --category sorting --language python
    algorithm-library get binary_search --all-languages
    algorithm-library validate quicksort my_quicksort.py
    algorithm-library stats --json

For more information, visit the Algorithm Library documentation.
EOF
}

# Version function
show_version() {
    echo "Algorithm Library CLI v1.0.0"
    echo "API: ${API_URL}"
}

# Status function
check_status() {
    echo -e "${BLUE}Checking Algorithm Library status...${NC}"
    
    response=$(curl -s "${API_URL}/health" 2>/dev/null || echo '{"status":"unreachable"}')
    
    if echo "$response" | grep -q '"status":"healthy"'; then
        echo -e "${GREEN}✓ Algorithm Library is healthy${NC}"
        if [[ "$1" == "--json" ]]; then
            echo "$response" | jq '.' 2>/dev/null || echo "$response"
        else
            echo "  API: Running at ${API_URL}"
            echo "  Database: Connected"
        fi
    else
        echo -e "${RED}✗ Algorithm Library is not healthy${NC}"
        if [[ "$1" == "--json" ]]; then
            echo "$response"
        else
            echo "  Status: Service unavailable"
            echo "  Try: vrooli scenario run algorithm-library"
        fi
        exit 1
    fi
}

# Search function
search_algorithms() {
    local query="$1"
    shift
    
    # Build query parameters
    local params=""
    while [[ $# -gt 0 ]]; do
        case $1 in
            --category)
                params="${params}&category=$2"
                shift 2
                ;;
            --language)
                params="${params}&language=$2"
                shift 2
                ;;
            --complexity)
                params="${params}&complexity=$2"
                shift 2
                ;;
            --difficulty)
                params="${params}&difficulty=$2"
                shift 2
                ;;
            --json)
                JSON_OUTPUT=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Make API request
    local url="${API_URL}/api/v1/algorithms/search?query=${query}${params}"
    local response=$(curl -s "$url" 2>/dev/null)
    
    if [[ "$JSON_OUTPUT" == "true" ]]; then
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    else
        # Parse and format output
        local total=$(echo "$response" | jq -r '.total // 0' 2>/dev/null)
        
        if [[ "$total" == "0" ]]; then
            echo -e "${YELLOW}No algorithms found matching your search.${NC}"
        else
            echo -e "${GREEN}Found ${total} algorithm(s):${NC}\n"
            
            echo "$response" | jq -r '.algorithms[]? | 
                "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n" +
                "Name: \(.name)\n" +
                "Display: \(.display_name)\n" +
                "Category: \(.category)\n" +
                "Complexity: Time \(.complexity_time), Space \(.complexity_space)\n" +
                "Difficulty: \(.difficulty)\n" +
                "Languages: \(.language_count) available\n" +
                "Tests: \(.test_case_count) test cases\n" +
                "Validated: \(if .has_validated_impl then "✓" else "✗" end)\n" +
                "Description: \(.description)"' 2>/dev/null
        fi
    fi
}

# Get algorithm function
get_algorithm() {
    local algorithm="$1"
    shift
    
    local language=""
    local all_languages=false
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --language)
                language="$2"
                shift 2
                ;;
            --all-languages)
                all_languages=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Make API request
    local url="${API_URL}/api/v1/algorithms/${algorithm}/implementations"
    if [[ -n "$language" ]]; then
        url="${url}?language=${language}"
    fi
    
    local response=$(curl -s "$url" 2>/dev/null)
    
    if echo "$response" | grep -q "not found"; then
        echo -e "${RED}Algorithm '${algorithm}' not found.${NC}"
        exit 1
    fi
    
    if [[ "$json_output" == "true" ]]; then
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    else
        # Format output
        echo -e "${GREEN}Algorithm Details:${NC}"
        echo "$response" | jq -r '.algorithm | 
            "\nName: \(.name)" +
            "\nDisplay: \(.display_name)" +
            "\nCategory: \(.category)" +
            "\nComplexity: Time \(.complexity_time), Space \(.complexity_space)" +
            "\nDifficulty: \(.difficulty)" +
            "\nDescription: \(.description)\n"' 2>/dev/null
        
        echo -e "${BLUE}Implementations:${NC}"
        echo "$response" | jq -r '.implementations[]? |
            "\n━━━ \(.language) (v\(.version)) ━━━" +
            "\nPrimary: \(if .is_primary then "Yes" else "No" end)" +
            "\nValidated: \(if .validated then "✓" else "✗" end)" +
            "\nValidation Count: \(.validation_count)" +
            "\nPerformance Score: \(.performance_score)\n" +
            "\nCode:\n\(.code)\n"' 2>/dev/null
    fi
}

# Validate function
validate_algorithm() {
    local algorithm="$1"
    local file="$2"
    shift 2
    
    if [[ ! -f "$file" ]]; then
        echo -e "${RED}Error: File '$file' not found.${NC}"
        exit 1
    fi
    
    # Detect language from file extension
    local language=""
    case "${file##*.}" in
        py) language="python" ;;
        js) language="javascript" ;;
        java) language="java" ;;
        cpp|cc|cxx) language="cpp" ;;
        c) language="c" ;;
        go) language="go" ;;
        rs) language="rust" ;;
        rb) language="ruby" ;;
        ts) language="typescript" ;;
        cs) language="csharp" ;;
        *)
            echo -e "${RED}Cannot detect language from file extension. Please specify with --language${NC}"
            exit 1
            ;;
    esac
    
    local code=$(cat "$file")
    local benchmark=false
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --language)
                language="$2"
                shift 2
                ;;
            --benchmark)
                benchmark=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}Validating ${language} implementation of ${algorithm}...${NC}"
    
    # Create JSON payload
    local payload=$(jq -n \
        --arg alg "$algorithm" \
        --arg lang "$language" \
        --arg code "$code" \
        '{algorithm_id: $alg, language: $lang, code: $code}')
    
    # Make API request
    local response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "${API_URL}/api/v1/algorithms/validate" 2>/dev/null)
    
    if [[ "$json_output" == "true" ]]; then
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    else
        local valid=$(echo "$response" | jq -r '.valid // false' 2>/dev/null)
        
        if [[ "$valid" == "true" ]]; then
            echo -e "${GREEN}✓ Implementation is valid!${NC}"
        else
            echo -e "${RED}✗ Implementation failed validation.${NC}"
        fi
        
        # Show test results
        echo -e "\n${BLUE}Test Results:${NC}"
        echo "$response" | jq -r '.test_results[]? |
            "\n Test: \(.test_case_id)" +
            "\n Result: \(if .passed then "✓ PASSED" else "✗ FAILED" end)" +
            "\n Execution Time: \(.execution_time_ms)ms" +
            (if .error_message then "\n Error: \(.error_message)" else "" end)' 2>/dev/null
        
        # Show performance if requested
        if [[ "$benchmark" == "true" ]]; then
            echo -e "\n${BLUE}Performance Metrics:${NC}"
            echo "$response" | jq -r '.performance' 2>/dev/null
        fi
    fi
}

# Categories function
list_categories() {
    local response=$(curl -s "${API_URL}/api/v1/algorithms/categories" 2>/dev/null)
    
    if [[ "$1" == "--json" ]]; then
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    else
        echo -e "${GREEN}Algorithm Categories:${NC}\n"
        echo "$response" | jq -r '.[]? | "  • \(.name): \(.count) algorithms"' 2>/dev/null
    fi
}

# Stats function
show_stats() {
    local response=$(curl -s "${API_URL}/api/v1/algorithms/stats" 2>/dev/null)
    
    if [[ "$1" == "--json" ]]; then
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    else
        echo -e "${GREEN}Algorithm Library Statistics:${NC}\n"
        echo "$response" | jq -r '.statistics |
            "  Total Algorithms: \(.total_algorithms)" +
            "\n  Total Implementations: \(.total_implementations)" +
            "\n  Total Test Cases: \(.total_test_cases)" +
            "\n  Validated Implementations: \(.validated_implementations)"' 2>/dev/null
        
        echo -e "\n${BLUE}Language Distribution:${NC}"
        echo "$response" | jq -r '.languages | to_entries[] | "  • \(.key): \(.value) implementations"' 2>/dev/null
    fi
}

# Main command handler
case "${1:-}" in
    search)
        shift
        if [[ -z "${1:-}" ]]; then
            echo -e "${RED}Error: Search query required${NC}"
            echo "Usage: algorithm-library search <query> [options]"
            exit 1
        fi
        search_algorithms "$@"
        ;;
    
    get)
        shift
        if [[ -z "${1:-}" ]]; then
            echo -e "${RED}Error: Algorithm name required${NC}"
            echo "Usage: algorithm-library get <algorithm> [options]"
            exit 1
        fi
        get_algorithm "$@"
        ;;
    
    validate)
        shift
        if [[ -z "${1:-}" ]] || [[ -z "${2:-}" ]]; then
            echo -e "${RED}Error: Algorithm name and file path required${NC}"
            echo "Usage: algorithm-library validate <algorithm> <file> [options]"
            exit 1
        fi
        validate_algorithm "$@"
        ;;
    
    categories)
        shift
        list_categories "$@"
        ;;
    
    stats)
        shift
        show_stats "$@"
        ;;
    
    status)
        shift
        check_status "$@"
        ;;
    
    version|--version|-v)
        show_version
        ;;
    
    help|--help|-h|"")
        show_help
        ;;
    
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'algorithm-library help' for usage information"
        exit 1
        ;;
esac