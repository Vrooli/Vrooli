{
  "name": "Issue Investigation Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "investigate-issue",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT i.*, p.name as project_name, p.path as project_path, a.prompt_template FROM issues i JOIN projects p ON i.project_id = p.id LEFT JOIN agents a ON i.assigned_agent_id = a.id WHERE i.id = '{{ $json.issue_id }}'"
      },
      "id": "get_issue_details",
      "name": "Get Issue Details",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "const issue = items[0].json;\n\n// Build context for Claude Code\nconst context = {\n  issue_title: issue.title,\n  issue_description: issue.description,\n  project_path: issue.project_path,\n  error_logs: issue.error_logs || '',\n  stack_trace: issue.stack_trace || '',\n  affected_files: issue.affected_files || [],\n  prompt_template: issue.prompt_template || 'Investigate this issue and provide a detailed report'\n};\n\n// Create investigation prompt\nconst prompt = `\n${context.prompt_template}\n\nIssue: ${context.issue_title}\nDescription: ${context.issue_description}\nProject Path: ${context.project_path}\n\n${context.error_logs ? 'Error Logs:\\n' + context.error_logs : ''}\n${context.stack_trace ? 'Stack Trace:\\n' + context.stack_trace : ''}\n${context.affected_files.length > 0 ? 'Affected Files: ' + context.affected_files.join(', ') : ''}\n\nPlease:\n1. Analyze the codebase at the specified path\n2. Identify the root cause of the issue\n3. Provide a detailed investigation report\n4. Suggest potential fixes\n5. List any related issues or dependencies\n`;\n\nreturn [{json: {prompt, context, issue_id: issue.id}}];"
      },
      "id": "prepare_investigation",
      "name": "Prepare Investigation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "command": "/home/matthalloran8/Vrooli/scenarios/app-issue-tracker/scripts/claude-investigator.sh investigate '{{ $json.issue_id }}' '{{ $json.agent_id }}' '{{ $json.project_path }}' '{{ $json.prompt_template }}'",
        "options": {
          "timeout": 300
        }
      },
      "id": "claude_investigation",
      "name": "Claude Code Investigation",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "functionCode": "// Parse output from claude-investigator.sh script\nconst commandOutput = items[0].json.stdout || items[0].json.output || '';\n\nlet investigationData;\ntry {\n  // The script outputs JSON, so parse it directly\n  investigationData = JSON.parse(commandOutput);\n} catch (e) {\n  // Fallback: treat as plain text if JSON parsing fails\n  console.log('Failed to parse JSON output, treating as text:', e);\n  investigationData = {\n    issue_id: 'unknown',\n    investigation_report: commandOutput,\n    root_cause: 'Parse error - see investigation report',\n    suggested_fix: 'Manual review required',\n    confidence_score: 3,\n    affected_files: [],\n    status: 'completed'\n  };\n}\n\n// Ensure all required fields are present\nconst result = {\n  issue_id: investigationData.issue_id || 'unknown',\n  investigation_report: investigationData.investigation_report || 'No report generated',\n  root_cause: investigationData.root_cause || 'Unable to determine root cause',\n  suggested_fix: investigationData.suggested_fix || 'No specific fix identified',\n  confidence_score: investigationData.confidence_score || 5,\n  affected_files: investigationData.affected_files || [],\n  timestamp: investigationData.investigation_completed_at || new Date().toISOString(),\n  status: investigationData.status || 'completed'\n};\n\nreturn [{json: result}];"
      },
      "id": "parse_response",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE issues SET investigation_report = '{{ $json.investigation_report }}', root_cause = '{{ $json.root_cause }}', suggested_fix = '{{ $json.suggested_fix }}', affected_files = ARRAY{{ $json.affected_files }}, status = 'investigating', updated_at = CURRENT_TIMESTAMP WHERE id = '{{ $json.issue_id }}' RETURNING *"
      },
      "id": "update_issue",
      "name": "Update Issue",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "url": "{{ $env.QDRANT_URL || 'http://localhost:6333' }}/collections/issues/points",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "httpMethod": "PUT",
        "body": "{\n  \"points\": [\n    {\n      \"id\": \"{{ $json.issue_id }}\",\n      \"vector\": {{ $json.embedding }},\n      \"payload\": {\n        \"title\": \"{{ $json.title }}\",\n        \"description\": \"{{ $json.description }}\",\n        \"investigation_report\": \"{{ $json.investigation_report }}\",\n        \"root_cause\": \"{{ $json.root_cause }}\",\n        \"status\": \"{{ $json.status }}\"\n      }\n    }\n  ]\n}"
      },
      "id": "update_vector_db",
      "name": "Update Vector DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "issue_id",
              "value": "={{ $json.issue_id }}"
            },
            {
              "name": "investigation_complete",
              "value": "true"
            }
          ]
        }
      },
      "id": "webhook_response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1650, 300]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{"node": "get_issue_details", "type": "main", "index": 0}]]
    },
    "get_issue_details": {
      "main": [[{"node": "prepare_investigation", "type": "main", "index": 0}]]
    },
    "prepare_investigation": {
      "main": [[{"node": "claude_investigation", "type": "main", "index": 0}]]
    },
    "claude_investigation": {
      "main": [[{"node": "parse_response", "type": "main", "index": 0}]]
    },
    "parse_response": {
      "main": [[{"node": "update_issue", "type": "main", "index": 0}]]
    },
    "update_issue": {
      "main": [[{"node": "update_vector_db", "type": "main", "index": 0}]]
    },
    "update_vector_db": {
      "main": [[{"node": "webhook_response", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "pinData": {},
  "versionId": "v1.0.0",
  "triggerCount": 1
}