name: document-manager
description: Modern test suite for AI-powered documentation management SaaS platform
version: 2.0.0

metadata:
  category: productivity
  tags: [documentation, ai, automation, saas, testing, lifecycle]
  author: Vrooli Core Team
  estimated_runtime: "10-15 minutes"
  lifecycle_version: "1.0.0"
  
setup:
  - name: Run lifecycle setup
    type: lifecycle
    action: setup
    description: Initialize all resources using modern lifecycle system
    timeout: 300

tests:
  # Lifecycle Tests
  - name: Test lifecycle phases
    description: Verify all lifecycle phases work correctly
    category: lifecycle
    timeout: 180
    steps:
      - action: verify_lifecycle_completion
        phase: setup
        expected: success
      - action: run_lifecycle_phase
        phase: develop
        timeout: 120
      - action: verify_lifecycle_completion
        phase: develop
        expected: success

  # API Health Tests
  - name: API health and connectivity
    description: Verify API server and all integrations are healthy
    category: api
    timeout: 120
    steps:
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/health"
        expected_status: 200
        expected_json: 
          status: "healthy"
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/api/system/db-status"
        expected_status: 200
        expected_json:
          status: "healthy"
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/api/system/vector-status"
        expected_status: 200
        expected_json:
          status: "healthy"
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/api/system/ai-status"
        expected_status: 200
        expected_json:
          status: "healthy"

  # Application Management Tests
  - name: Application CRUD operations
    description: Test complete application lifecycle management via API
    category: application_management
    timeout: 120
    steps:
      - action: http_post
        url: "http://localhost:${SERVICE_PORT}/api/applications"
        json_data:
          name: "Test Documentation Project"
          repository_url: "https://github.com/test/test-docs"
          documentation_path: "/docs"
        expected_status: 201
        store_response_as: created_application
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/api/applications"
        expected_status: 200
        assert_json_contains:
          name: "Test Documentation Project"
          repository_url: "https://github.com/test/test-docs"

  # Agent Management Tests
  - name: Agent lifecycle management
    description: Test agent creation and management via API
    category: agent_management
    timeout: 180
    steps:
      - action: http_post
        url: "http://localhost:${SERVICE_PORT}/api/agents"
        json_data:
          name: "Test Drift Detector"
          type: "drift_detector"
          application_id: 1
          schedule_cron: "0 */6 * * *"
          auto_apply_threshold: 0.8
          configuration: "{\"drift_threshold\": 0.25}"
        expected_status: 201
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/api/agents"
        expected_status: 200
        assert_json_contains:
          name: "Test Drift Detector"
          type: "drift_detector"

  # Queue Management Tests
  - name: Improvement queue operations
    description: Test queue item creation and management
    category: queue_management
    timeout: 120
    steps:
      - action: http_post
        url: "http://localhost:${SERVICE_PORT}/api/queue"
        json_data:
          agent_id: 1
          application_id: 1
          type: "broken_link"
          title: "Test queue item"
          description: "Test improvement suggestion"
          severity: "medium"
        expected_status: 201
      - action: http_get
        url: "http://localhost:${SERVICE_PORT}/api/queue"
        expected_status: 200
        assert_json_contains:
          title: "Test queue item"
          severity: "medium"

  # CLI Integration Tests
  - name: CLI functionality
    description: Test CLI commands and integration with API
    category: cli_testing
    timeout: 180
    steps:
      - action: shell_command
        command: "document-manager version"
        expected_exit_code: 0
        expected_output_contains: "Document Manager CLI"
      - action: shell_command
        command: "document-manager health"
        expected_exit_code: 0
        expected_output_contains: "healthy"
      - action: shell_command
        command: "document-manager status"
        expected_exit_code: 0
        expected_output_contains: "Document Manager Status"
      - action: shell_command
        command: "document-manager applications list"
        expected_exit_code: 0
      - action: shell_command
        command: "document-manager agents list"
        expected_exit_code: 0

  # Windmill Dashboard Tests
  - name: Windmill dashboard accessibility
    description: Test dashboard is accessible and responsive
    category: ui_testing
    timeout: 120
    steps:
      - action: http_get
        url: "http://localhost:${RESOURCE_PORTS[windmill]}"
        expected_status: 200
      - action: http_get
        url: "http://localhost:${RESOURCE_PORTS[windmill]}/api/version"
        expected_status: 200
      - action: http_get
        url: "http://localhost:${RESOURCE_PORTS[windmill]}/api/w/document_manager/apps"
        expected_status: 200

  # n8n Integration Tests
  - name: n8n workflow availability
    description: Test n8n workflows are deployed and accessible
    category: workflow_testing
    timeout: 120
    steps:
      - action: http_get
        url: "http://localhost:${RESOURCE_PORTS[n8n]}/healthz"
        expected_status: 200
      - action: http_get
        url: "http://localhost:${RESOURCE_PORTS[n8n]}/api/v1/workflows"
        expected_status: 200

validation:
  # Resource Validation
  resources:
    - name: postgres
      checks: [connection, schema_loaded]
      required: true
    - name: redis
      checks: [connection]
      required: true
    - name: qdrant
      checks: [connection, collections_created]
      required: true
    - name: ollama
      checks: [connection, models_available]
      required: true
    - name: n8n
      checks: [connection, workflows_deployed]
      required: true
    - name: windmill
      checks: [connection, app_deployed]
      required: true

  # API Endpoint Validation
  api_endpoints:
    api_server:
      - endpoint: /health
        method: GET
        expected_status: 200
      - endpoint: /api/applications
        method: GET
        expected_status: 200
      - endpoint: /api/agents
        method: GET
        expected_status: 200
      - endpoint: /api/queue
        method: GET
        expected_status: 200
    windmill:
      - endpoint: /api/version
        method: GET
        expected_status: 200
    n8n:
      - endpoint: /healthz
        method: GET
        expected_status: 200

# Cleanup procedures
cleanup:
  - name: Run lifecycle stop
    type: lifecycle
    action: stop
    description: Clean shutdown of all services
    
  - name: Remove test data
    type: postgres
    action: delete_test_records
    tables: [applications, agents, improvement_queue]

# Reporting configuration
reporting:
  format: [json, html]
  include_metrics: true
  include_logs: true
  output_directory: "test-results"