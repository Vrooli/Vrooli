version: 1.0
scenario: graph-studio
description: Test suite for Graph Studio scenario

structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - README.md
    - Makefile
    - api/main.go
    - api/types.go
    - api/handlers.go
    - api/middleware.go
    - api/database.go
    - api/go.mod
    - cli/graph-studio
    - cli/install.sh
    - ui/package.json
    - ui/index.html
    - ui/src/main.tsx
    - ui/src/App.tsx
    - initialization/postgres/schema.sql
    
  required_dirs:
    - api
    - cli
    - ui/src/components
    - ui/src/pages
    - ui/src/api
    - initialization/postgres

services:
  - name: api
    health_endpoint: /health
    expected_status: 200
    startup_timeout: 60
    
  - name: ui
    health_endpoint: /
    expected_status: 200
    startup_timeout: 60

tests:
  - name: "API Health Check"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        version: "1.0.0"
    
  - name: "List Plugins"
    type: http
    service: api
    endpoint: /api/v1/plugins
    method: GET
    expect:
      status: 200
      body_contains:
        - mind-maps
        - bpmn
        - network-graphs
        - mermaid
    
  - name: "Create Mind Map"
    type: http
    service: api
    endpoint: /api/v1/graphs
    method: POST
    headers:
      Content-Type: application/json
      X-User-ID: test-user
    body:
      name: "Test Mind Map"
      type: "mind-maps"
      description: "A test mind map"
      data:
        root:
          text: "Central Idea"
          children:
            - text: "Branch 1"
            - text: "Branch 2"
    expect:
      status: 201
      body:
        name: "Test Mind Map"
        type: "mind-maps"
    capture:
      graph_id: id
    
  - name: "Get Created Graph"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}
    method: GET
    depends_on: ["Create Mind Map"]
    expect:
      status: 200
      body:
        name: "Test Mind Map"
        type: "mind-maps"
    
  - name: "Validate Graph"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}/validate
    method: POST
    depends_on: ["Create Mind Map"]
    expect:
      status: 200
      body:
        valid: true
    
  - name: "List Graphs"
    type: http
    service: api
    endpoint: /api/v1/graphs
    method: GET
    expect:
      status: 200
      body_type: object
      body_has_keys:
        - data
        - total
    
  - name: "Convert Mind Map to Mermaid"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}/convert
    method: POST
    depends_on: ["Create Mind Map"]
    headers:
      Content-Type: application/json
    body:
      target_format: mermaid
    expect:
      status: 200
      body:
        success: true
        format: mermaid
    
  - name: "Render Graph as SVG"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}/render
    method: POST
    depends_on: ["Create Mind Map"]
    headers:
      Content-Type: application/json
    body:
      format: svg
    expect:
      status: 200
      headers:
        Content-Type: image/svg+xml
    
  - name: "Update Graph"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}
    method: PUT
    depends_on: ["Create Mind Map"]
    headers:
      Content-Type: application/json
    body:
      name: "Updated Mind Map"
      tags: ["test", "updated"]
    expect:
      status: 200
      body:
        success: true
    
  - name: "Delete Graph"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}
    method: DELETE
    depends_on: ["Update Graph"]
    expect:
      status: 200
      body:
        success: true
    
  - name: "Verify Graph Deleted"
    type: http
    service: api
    endpoint: /api/v1/graphs/${graph_id}
    method: GET
    depends_on: ["Delete Graph"]
    expect:
      status: 404
      body:
        error: "Graph not found"

  - name: "UI Health Check"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body_contains:
        - "Graph Studio"

database_tests:
  - name: "Verify Schema Creation"
    type: sql
    database: graph_studio
    query: |
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name IN ('graphs', 'plugins', 'graph_versions')
    expect:
      row_count: 3
      
  - name: "Verify Plugins Loaded"
    type: sql
    database: graph_studio
    query: |
      SELECT COUNT(*) as count 
      FROM plugins 
      WHERE enabled = true
    expect:
      rows:
        - count: 4

cli_tests:
  - name: "CLI Status Command"
    type: command
    command: graph-studio status
    expect:
      exit_code: 0
      stdout_contains:
        - healthy
        
  - name: "CLI List Command"
    type: command
    command: graph-studio list
    expect:
      exit_code: 0
      
  - name: "CLI Plugins Command"
    type: command
    command: graph-studio plugins
    expect:
      exit_code: 0
      stdout_contains:
        - mind-maps
        - bpmn

performance:
  - name: "API Response Time"
    type: http
    service: api
    endpoint: /api/v1/graphs
    method: GET
    iterations: 10
    expect:
      avg_response_time_ms: 200
      max_response_time_ms: 500
      
  - name: "Concurrent Graph Creation"
    type: http
    service: api
    endpoint: /api/v1/graphs
    method: POST
    concurrent: 5
    body:
      name: "Perf Test Graph"
      type: "mind-maps"
    expect:
      success_rate: 1.0
      avg_response_time_ms: 500

cleanup:
  - type: sql
    database: graph_studio
    query: "DELETE FROM graphs WHERE name LIKE 'Test%' OR name LIKE 'Perf%'"
    
  - type: sql
    database: graph_studio
    query: "DELETE FROM graph_conversions WHERE created_at < NOW()"