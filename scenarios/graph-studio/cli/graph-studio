#!/bin/bash
################################################################################
# Graph Studio CLI - Lightweight API Wrapper
# 
# Thin wrapper that delegates all operations to the Graph Studio API
################################################################################

set -e

SCENARIO_NAME="graph-studio"
VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Get API URL using fast port lookup
get_api_url() {
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    api_url=$(get_api_url)
    
    if [[ "$method" == "GET" ]]; then
        curl -s "${api_url}${endpoint}"
    else
        curl -s -X "$method" \
             -H "Content-Type: application/json" \
             ${data:+-d "$data"} \
             "${api_url}${endpoint}"
    fi
}

# Format JSON output
format_output() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Show usage
usage() {
    echo -e "${CYAN}Graph Studio CLI v${VERSION}${NC}"
    echo ""
    echo "Usage: graph-studio <command> [options]"
    echo ""
    echo "Commands:"
    echo "  status       Check service health"
    echo "  list         List graphs"
    echo "  create       Create a new graph"
    echo "  get <id>     Get graph details"
    echo "  delete <id>  Delete a graph"
    echo "  validate <id> Validate a graph"
    echo "  convert <id> <format> Convert graph format"
    echo "  plugins      List available plugins"
    echo "  help         Show this help"
    echo ""
    echo "Examples:"
    echo "  graph-studio status"
    echo "  graph-studio list"
    echo "  graph-studio create \"My Graph\" mind-maps"
    echo "  graph-studio validate abc-123"
    exit 0
}

# Parse command
COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
    status|health)
        echo -e "${BLUE}Checking status...${NC}"
        api_request GET "/health" | format_output
        ;;
        
    list|ls)
        api_request GET "/api/v1/graphs" | format_output
        ;;
        
    create)
        if [[ $# -lt 2 ]]; then
            echo -e "${RED}Usage: graph-studio create <name> <type>${NC}"
            exit 1
        fi
        NAME="$1"
        TYPE="$2"
        DATA="{\"name\":\"$NAME\",\"type\":\"$TYPE\"}"
        api_request POST "/api/v1/graphs" "$DATA" | format_output
        ;;
        
    get|show)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Usage: graph-studio get <id>${NC}"
            exit 1
        fi
        api_request GET "/api/v1/graphs/$1" | format_output
        ;;
        
    delete|rm)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Usage: graph-studio delete <id>${NC}"
            exit 1
        fi
        api_request DELETE "/api/v1/graphs/$1" | format_output
        ;;
        
    validate)
        if [[ -z "$1" ]]; then
            echo -e "${RED}Usage: graph-studio validate <id>${NC}"
            exit 1
        fi
        api_request POST "/api/v1/graphs/$1/validate" | format_output
        ;;
        
    convert)
        if [[ $# -lt 2 ]]; then
            echo -e "${RED}Usage: graph-studio convert <id> <format>${NC}"
            exit 1
        fi
        DATA="{\"target_format\":\"$2\"}"
        api_request POST "/api/v1/graphs/$1/convert" "$DATA" | format_output
        ;;
        
    plugins)
        api_request GET "/api/v1/plugins" | format_output
        ;;
        
    help|--help|-h)
        usage
        ;;
        
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        echo "Run 'graph-studio help' for usage"
        exit 1
        ;;
esac