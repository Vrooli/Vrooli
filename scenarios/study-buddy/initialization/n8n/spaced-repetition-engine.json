{
  "name": "Spaced Repetition Engine",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "flashcards/spaced-repetition",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  flashcard_id: 'test-card-001',\n  user_id: 'test-user',\n  quality: 3, // 0-5 rating (0=complete blackout, 5=perfect recall)\n  ease_factor: 2.5, // Current ease factor\n  interval: 1, // Current interval in days\n  repetitions: 0, // Number of correct responses in a row\n  last_reviewed: new Date(Date.now() - 86400000).toISOString() // Yesterday\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $('Manual').first() !== undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Implement SuperMemo 2 (SM-2) algorithm for spaced repetition\n// This is the core algorithm used by many flashcard apps\n\n// Merge webhook or default data\nconst isManual = $('Manual').first() !== undefined;\nconst input = isManual ? $json : $('Webhook').first().json;\nconst quality = input.quality; // 0-5 rating\nlet easeFactor = input.ease_factor || 2.5;\nlet interval = input.interval || 1;\nlet repetitions = input.repetitions || 0;\n\n// SM-2 Algorithm implementation\nif (quality >= 3) {\n  // Correct response\n  if (repetitions === 0) {\n    interval = 1;\n  } else if (repetitions === 1) {\n    interval = 6;\n  } else {\n    interval = Math.round(interval * easeFactor);\n  }\n  repetitions++;\n} else {\n  // Incorrect response - reset\n  repetitions = 0;\n  interval = 1;\n}\n\n// Update ease factor\neaseFactor = easeFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));\n\n// Ensure ease factor doesn't go below 1.3\nif (easeFactor < 1.3) {\n  easeFactor = 1.3;\n}\n\n// Calculate next review date\nconst nextReviewDate = new Date();\nnextReviewDate.setDate(nextReviewDate.getDate() + interval);\n\n// Calculate retention probability (approximate)\nconst daysSinceReview = (Date.now() - new Date(input.last_reviewed).getTime()) / (1000 * 60 * 60 * 24);\nconst retentionProbability = Math.exp(-daysSinceReview / interval) * 100;\n\n// Determine learning phase\nlet learningPhase = 'learning';\nif (repetitions >= 5 && interval >= 21) {\n  learningPhase = 'mature';\n} else if (repetitions >= 2) {\n  learningPhase = 'young';\n}\n\n// Calculate priority score for review ordering\nconst overdue = Math.max(0, daysSinceReview - interval);\nconst priorityScore = overdue * (1 / easeFactor) * (quality < 3 ? 2 : 1);\n\nreturn [{\n  json: {\n    flashcard_id: input.flashcard_id,\n    user_id: input.user_id,\n    updated_values: {\n      ease_factor: Math.round(easeFactor * 100) / 100,\n      interval: interval,\n      repetitions: repetitions,\n      next_review: nextReviewDate.toISOString(),\n      last_reviewed: new Date().toISOString(),\n      quality_rating: quality,\n      learning_phase: learningPhase,\n      retention_probability: Math.round(retentionProbability),\n      priority_score: Math.round(priorityScore * 100) / 100\n    },\n    statistics: {\n      streak: repetitions,\n      days_until_review: interval,\n      difficulty_adjustment: easeFactor < input.ease_factor ? 'increased' : easeFactor > input.ease_factor ? 'decreased' : 'unchanged',\n      performance: quality >= 4 ? 'excellent' : quality === 3 ? 'good' : quality === 2 ? 'hard' : 'again'\n    },\n    recommendations: {\n      review_today: priorityScore > 1,\n      suggested_time: learningPhase === 'learning' ? 'morning' : 'any',\n      practice_mode: quality < 3 ? 'focused' : 'normal'\n    }\n  }\n}];"
      },
      "id": "calculate-sm2",
      "name": "Calculate SM-2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "jsCode": "// Prepare prompt for learning insights\nconst data = $json;\n\nconst prompt = `You are an expert learning coach analyzing a student's flashcard review performance.\n\nCard Performance:\n- Quality Rating: ${data.statistics.performance} (${data.updated_values.quality_rating}/5)\n- Current Streak: ${data.statistics.streak} correct in a row\n- Learning Phase: ${data.updated_values.learning_phase}\n- Retention Probability: ${data.updated_values.retention_probability}%\n- Next Review: ${data.statistics.days_until_review} days\n\nProvide a brief, encouraging insight (2-3 sentences) about their progress and one specific tip to improve retention for this card.\n\nRespond in JSON format:\n{\n  \"insight\": \"encouragement message\",\n  \"tip\": \"specific actionable tip\",\n  \"emoji\": \"single relevant emoji\"\n}`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    model: \"llama3.2\",\n    type: \"generation\",\n    temperature: 0.8,\n    format: \"json\",\n    quiet: true,\n    spaced_data: data\n  }\n}];"
      },
      "id": "prepare-insight",
      "name": "Prepare Insight",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "workflow": "Ollama Universal Executor",
        "workflowData": "={{ JSON.stringify($json) }}",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "generate-insight",
      "name": "Call Shared Ollama",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "// Combine spaced repetition data with AI insights\nconst spacedData = $json.spaced_data;\nconst aiResponse = $json.response;\n\nlet insight = {};\ntry {\n  insight = typeof aiResponse === 'string' ? JSON.parse(aiResponse) : aiResponse;\n} catch (e) {\n  insight = {\n    insight: \"Keep up the great work! Your consistency is building strong memory pathways.\",\n    tip: \"Try visualizing this concept or creating a mental story around it.\",\n    emoji: \"ðŸŒŸ\"\n  };\n}\n\nreturn [{\n  json: {\n    success: true,\n    flashcard_id: spacedData.flashcard_id,\n    user_id: spacedData.user_id,\n    algorithm: \"SM-2\",\n    updated_values: spacedData.updated_values,\n    statistics: spacedData.statistics,\n    recommendations: spacedData.recommendations,\n    learning_insight: {\n      message: insight.insight,\n      tip: insight.tip,\n      emoji: insight.emoji || \"ðŸ“š\"\n    },\n    metadata: {\n      processed_at: new Date().toISOString(),\n      algorithm_version: \"2.0\"\n    }\n  }\n}];"
      },
      "id": "combine-results",
      "name": "Combine Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1450, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Calculate SM-2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual": {
      "main": [
        [
          {
            "node": "Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Defaults": {
      "main": [
        [
          {
            "node": "Calculate SM-2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate SM-2": {
      "main": [
        [
          {
            "node": "Prepare Insight",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Insight": {
      "main": [
        [
          {
            "node": "Call Shared Ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Shared Ollama": {
      "main": [
        [
          {
            "node": "Combine Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Results": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "spaced-rep-v1",
  "meta": {
    "templateId": "study-buddy-spaced-repetition"
  },
  "id": "study-buddy-spaced-repetition",
  "tags": []
}