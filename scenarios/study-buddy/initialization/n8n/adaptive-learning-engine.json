{
  "name": "Adaptive Learning Engine",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "learning/adapt",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  user_id: 'test-user',\n  subject_id: 'biology-101',\n  performance_data: {\n    recent_scores: [0.85, 0.72, 0.90, 0.68],\n    time_spent: [120, 180, 150, 200],\n    difficulty_ratings: [2, 3, 2, 4],\n    topics_covered: ['cells', 'mitosis', 'DNA', 'evolution']\n  },\n  learning_style: 'visual',\n  goals: {\n    target_score: 0.85,\n    deadline: '2024-06-01',\n    focus_areas: ['evolution', 'genetics']\n  }\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $execution.resumeUrl === undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ `SELECT \n  u.learning_preferences,\n  u.strengths,\n  u.weaknesses,\n  ss.total_study_time,\n  ss.average_score,\n  ss.last_activity,\n  COUNT(DISTINCT f.id) as total_flashcards,\n  COUNT(DISTINCT q.id) as quizzes_taken,\n  AVG(qr.score) as avg_quiz_score\nFROM users u\nLEFT JOIN study_stats ss ON u.id = ss.user_id AND ss.subject_id = '${$json.subject_id}'\nLEFT JOIN flashcards f ON f.user_id = u.id AND f.subject_id = '${$json.subject_id}'\nLEFT JOIN quiz_results qr ON qr.user_id = u.id\nLEFT JOIN quizzes q ON q.id = qr.quiz_id AND q.subject_id = '${$json.subject_id}'\nWHERE u.id = '${$json.user_id}'\nGROUP BY u.id, ss.total_study_time, ss.average_score, ss.last_activity` }}",
        "options": {}
      },
      "id": "fetch-user-history",
      "name": "Fetch User History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [650, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-study-buddy",
          "name": "Study Buddy DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare comprehensive context for Chain of Thought analysis\nconst input = $input.first().json;\nconst userHistory = items[0]?.json || {};\n\n// Calculate performance trends\nconst scores = input.performance_data.recent_scores;\nconst avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;\nconst scoresTrend = scores[scores.length - 1] - scores[0];\n\n// Identify struggling areas\nconst strugglingTopics = input.performance_data.topics_covered\n  .map((topic, i) => ({\n    topic,\n    score: scores[i],\n    difficulty: input.performance_data.difficulty_ratings[i]\n  }))\n  .filter(t => t.score < 0.75)\n  .sort((a, b) => a.score - b.score);\n\nreturn [{\n  json: {\n    user_context: {\n      user_id: input.user_id,\n      subject_id: input.subject_id,\n      learning_style: input.learning_style,\n      current_performance: {\n        average_score: avgScore,\n        trend: scoresTrend > 0 ? 'improving' : scoresTrend < 0 ? 'declining' : 'stable',\n        struggling_topics: strugglingTopics,\n        strong_topics: input.performance_data.topics_covered.filter((t, i) => scores[i] >= 0.85)\n      },\n      historical_data: userHistory,\n      goals: input.goals\n    },\n    analysis_request: {\n      task: 'Generate personalized adaptive learning plan',\n      considerations: [\n        'Current performance trends',\n        'Learning style preferences',\n        'Time constraints and goals',\n        'Identified weak areas',\n        'Optimal difficulty progression'\n      ]\n    }\n  }\n}];"
      },
      "id": "prepare-context",
      "name": "Prepare Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_chain-of-thought-orchestrator', 'string') }}",
        "workflowData": "={{ JSON.stringify({\n  task: 'Analyze student learning patterns and create adaptive study plan',\n  context: $json.user_context,\n  reasoning_steps: [\n    'Analyze current performance metrics and trends',\n    'Identify knowledge gaps and struggling areas',\n    'Consider learning style and preferences',\n    'Calculate optimal difficulty progression',\n    'Design personalized study schedule',\n    'Select appropriate learning materials and methods',\n    'Set measurable milestones'\n  ],\n  output_format: {\n    analysis: 'Performance analysis summary',\n    recommendations: {\n      immediate_actions: ['action1', 'action2'],\n      study_schedule: {},\n      difficulty_adjustment: 'number',\n      focus_topics: [],\n      learning_methods: []\n    },\n    adaptive_parameters: {\n      repetition_interval: 'number',\n      session_duration: 'number',\n      break_frequency: 'number',\n      difficulty_curve: 'string'\n    }\n  },\n  validation_rules: [\n    'Difficulty must be appropriate for current level',\n    'Schedule must be realistic given goals',\n    'Methods must match learning style'\n  ],\n  model: 'llama3.2',\n  temperature: 0.7,\n  max_iterations: 3\n}) }}",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "chain-of-thought-analysis",
      "name": "Chain of Thought Analysis",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "const analysis = items[0].json;\nconst input = $input.all()[0].json;\n\n// Extract the analysis results\nlet adaptivePlan = {};\ntry {\n  // Handle different response formats from Chain of Thought\n  if (analysis.final_output) {\n    adaptivePlan = analysis.final_output;\n  } else if (analysis.response) {\n    adaptivePlan = typeof analysis.response === 'string' ? JSON.parse(analysis.response) : analysis.response;\n  } else {\n    adaptivePlan = analysis;\n  }\n} catch (e) {\n  console.error('Parse error:', e);\n  // Fallback to basic adaptive plan\n  adaptivePlan = {\n    analysis: 'Performance analysis pending',\n    recommendations: {\n      immediate_actions: [\n        'Review struggling topics',\n        'Increase practice frequency'\n      ],\n      difficulty_adjustment: -0.5,\n      focus_topics: input.user_context.current_performance.struggling_topics.map(t => t.topic)\n    },\n    adaptive_parameters: {\n      repetition_interval: 1,\n      session_duration: 25,\n      break_frequency: 5,\n      difficulty_curve: 'gradual'\n    }\n  };\n}\n\n// Generate specific study materials based on analysis\nconst studyMaterials = {\n  flashcards_needed: adaptivePlan.recommendations.focus_topics?.length * 10 || 30,\n  quiz_difficulty: Math.max(1, Math.min(5, \n    Math.round(3 + (adaptivePlan.recommendations.difficulty_adjustment || 0)))),\n  session_goals: adaptivePlan.recommendations.immediate_actions || [],\n  estimated_improvement: Math.round((1 - input.user_context.current_performance.average_score) * 30) + '%'\n};\n\nreturn [{\n  json: {\n    user_id: input.user_context.user_id,\n    subject_id: input.user_context.subject_id,\n    adaptive_plan: adaptivePlan,\n    study_materials: studyMaterials,\n    next_review_date: new Date(Date.now() + \n      (adaptivePlan.adaptive_parameters?.repetition_interval || 1) * 24 * 60 * 60 * 1000)\n      .toISOString().split('T')[0],\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "generate-adaptive-plan",
      "name": "Generate Adaptive Plan",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "content": "={{ JSON.stringify($json, null, 2) }}",
        "key": "={{ `study-buddy:adaptive-plan:${$json.user_id}:${$json.subject_id}` }}",
        "ttl": 86400,
        "options": {}
      },
      "id": "cache-plan",
      "name": "Cache Plan",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1450, 400],
      "credentials": {
        "redis": {
          "id": "redis-study-buddy",
          "name": "Study Buddy Cache"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const plan = items[0].json;\n\nreturn [{\n  json: {\n    success: true,\n    message: 'Adaptive learning plan generated successfully',\n    data: {\n      user_id: plan.user_id,\n      subject_id: plan.subject_id,\n      analysis_summary: plan.adaptive_plan.analysis,\n      recommendations: plan.adaptive_plan.recommendations,\n      adaptive_settings: plan.adaptive_plan.adaptive_parameters,\n      study_materials: plan.study_materials,\n      next_review: plan.next_review_date\n    },\n    metadata: {\n      generated_at: plan.timestamp,\n      cached: true,\n      ttl: '24 hours'\n    }\n  }\n}];"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 400]
    },
    {
      "parameters": {},
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1850, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Fetch User History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual": {
      "main": [
        [
          {
            "node": "Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Defaults": {
      "main": [
        [
          {
            "node": "Fetch User History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch User History": {
      "main": [
        [
          {
            "node": "Prepare Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Context": {
      "main": [
        [
          {
            "node": "Chain of Thought Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chain of Thought Analysis": {
      "main": [
        [
          {
            "node": "Generate Adaptive Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Adaptive Plan": {
      "main": [
        [
          {
            "node": "Cache Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Plan": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e8f8c7d2-3a4b-4f6e-9d1c-2b5a8f9e7c3d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "study-buddy-adaptive-learning"
  },
  "id": "adaptive-learning-engine",
  "tags": []
}