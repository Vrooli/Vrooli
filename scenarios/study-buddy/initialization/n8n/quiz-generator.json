{
  "name": "study-buddy-quiz-generator",
  "nodes": [
    {
      "parameters": {
        "path": "study-buddy/generate-quiz",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "material_id",
              "name": "material_id",
              "value": "={{ $json.material_id || '' }}",
              "type": "string"
            },
            {
              "id": "subject",
              "name": "subject",
              "value": "={{ $json.subject || 'General Knowledge' }}",
              "type": "string"
            },
            {
              "id": "difficulty",
              "name": "difficulty",
              "value": "={{ $json.difficulty || 'medium' }}",
              "type": "string"
            },
            {
              "id": "question_count",
              "name": "question_count",
              "value": "={{ $json.question_count || 10 }}",
              "type": "number"
            },
            {
              "id": "question_types",
              "name": "question_types",
              "value": "={{ $json.question_types || ['multiple_choice', 'true_false'] }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "id": "set-defaults",
      "name": "Set Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-inputs",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [650, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.material_id }}",
              "operation": "notEmpty"
            }
          ]
        }
      },
      "id": "check-material",
      "name": "Has Material ID?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "study_materials",
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $json.material_id }}"
            }
          ]
        }
      },
      "id": "fetch-material",
      "name": "Fetch Study Material",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1050, 300],
      "credentials": {
        "postgres": {
          "id": "study-buddy-postgres",
          "name": "Study Buddy PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare prompt for shared Ollama workflow\nconst mergedData = $('merge-inputs').item.json;\nconst materialContent = $json.content || '';\n\nconst prompt = `Generate a quiz based on the following study material:\n\n${materialContent}\n\nCreate ${mergedData.question_count} questions with these requirements:\n- Difficulty: ${mergedData.difficulty}\n- Question types: ${mergedData.question_types.join(', ')}\n- Each question should test understanding, not just memorization\n- Include explanations for correct answers\n\nFormat as JSON array with structure:\n[\n  {\n    \"question\": \"...\",\n    \"type\": \"multiple_choice|true_false|fill_blank\",\n    \"options\": [\"A\", \"B\", \"C\", \"D\"],\n    \"correct_answer\": \"A\",\n    \"explanation\": \"...\",\n    \"difficulty\": 1-5,\n    \"points\": 1-3\n  }\n]`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    model: 'llama3.2',\n    type: 'reasoning',\n    quiet: true,\n    timeout_seconds: 120,\n    original_input: mergedData\n  }\n}];"
      },
      "id": "prepare-material-prompt",
      "name": "Prepare Material Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "workflowId": "ollama",
        "mode": "once",
        "source": "db",
        "passThrough": false
      },
      "id": "generate-from-material",
      "name": "Call Shared Ollama Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "jsCode": "// Process response from shared Ollama workflow\nconst response = $json;\nconst originalInput = $node[\"prepare-material-prompt\"].json.original_input;\n\n// Get the response from shared workflow\nconst responseText = response.response || '';\nconst success = response.success === true;\n\nlet processedResponse = '';\nif (success && responseText) {\n  processedResponse = responseText;\n} else {\n  // Handle error case\n  processedResponse = JSON.stringify({\n    error: 'Failed to generate quiz from material',\n    details: response.error ? response.error.message : 'Unknown error'\n  });\n}\n\nreturn [{\n  json: {\n    response: processedResponse,\n    success: success,\n    original_input: originalInput\n  }\n}];"
      },
      "id": "process-material-output",
      "name": "Process Material Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Prepare prompt for shared Ollama workflow\nconst inputData = $json;\n\nconst prompt = `Generate a quiz about ${inputData.subject} with ${inputData.question_count} questions.\n\nRequirements:\n- Difficulty: ${inputData.difficulty}\n- Question types: ${inputData.question_types.join(', ')}\n- Cover fundamental concepts and practical applications\n- Include explanations for learning\n\nFormat as JSON array with structure:\n[\n  {\n    \"question\": \"...\",\n    \"type\": \"multiple_choice|true_false|fill_blank\",\n    \"options\": [\"A\", \"B\", \"C\", \"D\"],\n    \"correct_answer\": \"A\",\n    \"explanation\": \"...\",\n    \"difficulty\": 1-5,\n    \"points\": 1-3\n  }\n]`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    model: 'llama3.2',\n    type: 'reasoning',\n    quiet: true,\n    timeout_seconds: 120,\n    original_input: inputData\n  }\n}];"
      },
      "id": "prepare-generic-prompt",
      "name": "Prepare Generic Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "workflowId": "ollama",
        "mode": "once",
        "source": "db",
        "passThrough": false
      },
      "id": "generate-generic",
      "name": "Call Shared Ollama Workflow (Generic)",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Process response from shared Ollama workflow\nconst response = $json;\nconst originalInput = $node[\"prepare-generic-prompt\"].json.original_input;\n\n// Get the response from shared workflow\nconst responseText = response.response || '';\nconst success = response.success === true;\n\nlet processedResponse = '';\nif (success && responseText) {\n  processedResponse = responseText;\n} else {\n  // Handle error case\n  processedResponse = JSON.stringify({\n    error: 'Failed to generate generic quiz',\n    details: response.error ? response.error.message : 'Unknown error'\n  });\n}\n\nreturn [{\n  json: {\n    response: processedResponse,\n    success: success,\n    original_input: originalInput\n  }\n}];"
      },
      "id": "process-generic-output",
      "name": "Process Generic Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-quiz-results",
      "name": "Merge Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "jsCode": "const quizData = $input.first().json;\nconst userId = $('merge-inputs').first().json.user_id || 'default-user';\nconst subjectId = $('merge-inputs').first().json.subject_id;\n\n// Parse the quiz questions from Ollama workflow response\nlet questions = [];\ntry {\n  // The shared Ollama workflow returns the response in various possible formats\n  const response = quizData.response || quizData.result || quizData.output || quizData;\n  \n  if (typeof response === 'string') {\n    // Try to extract JSON from the response\n    const jsonMatch = response.match(/\[.*\]/s);\n    if (jsonMatch) {\n      questions = JSON.parse(jsonMatch[0]);\n    } else {\n      questions = JSON.parse(response);\n    }\n  } else if (Array.isArray(response)) {\n    questions = response;\n  } else if (response && typeof response === 'object') {\n    // Check if the response has a data or questions property\n    questions = response.data || response.questions || [];\n  }\n} catch (e) {\n  // Handle parsing error\n  console.error('Failed to parse quiz questions:', e);\n  questions = [];\n}\n\n// Format for database insertion\nconst formattedQuestions = questions.map(q => ({\n  id: crypto.randomUUID(),\n  user_id: userId,\n  subject_id: subjectId,\n  question: q.question,\n  question_type: q.type,\n  options: JSON.stringify(q.options || []),\n  correct_answer: q.correct_answer,\n  explanation: q.explanation,\n  difficulty_level: q.difficulty || 2,\n  points: q.points || 1,\n  created_at: new Date().toISOString()\n}));\n\nreturn formattedQuestions;"
      },
      "id": "format-quiz",
      "name": "Format Quiz Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 400]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "quiz_questions",
        "columns": "user_id,subject_id,question,question_type,options,correct_answer,explanation,difficulty_level,points",
        "additionalFields": {}
      },
      "id": "save-questions",
      "name": "Save Quiz Questions",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2450, 400],
      "credentials": {
        "postgres": {
          "id": "study-buddy-postgres",
          "name": "Study Buddy PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2650, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "merge-inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual-trigger": {
      "main": [
        [
          {
            "node": "set-defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set-defaults": {
      "main": [
        [
          {
            "node": "merge-inputs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge-inputs": {
      "main": [
        [
          {
            "node": "check-material",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-material": {
      "main": [
        [
          {
            "node": "fetch-material",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "prepare-generic-prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch-material": {
      "main": [
        [
          {
            "node": "prepare-material-prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-material-prompt": {
      "main": [
        [
          {
            "node": "prep-material-ollama-cmd",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prep-material-ollama-cmd": {
      "main": [
        [
          {
            "node": "generate-from-material",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate-from-material": {
      "main": [
        [
          {
            "node": "process-material-output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-material-output": {
      "main": [
        [
          {
            "node": "merge-quiz-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-generic-prompt": {
      "main": [
        [
          {
            "node": "prep-generic-ollama-cmd",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prep-generic-ollama-cmd": {
      "main": [
        [
          {
            "node": "generate-generic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate-generic": {
      "main": [
        [
          {
            "node": "process-generic-output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-generic-output": {
      "main": [
        [
          {
            "node": "merge-quiz-results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge-quiz-results": {
      "main": [
        [
          {
            "node": "format-quiz",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format-quiz": {
      "main": [
        [
          {
            "node": "save-questions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save-questions": {
      "main": [
        [
          {
            "node": "webhook-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "study-buddy"
  },
  "tags": []
}