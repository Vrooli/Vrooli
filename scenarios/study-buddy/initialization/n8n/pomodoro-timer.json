{
  "name": "Pomodoro Study Timer",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "timer/pomodoro",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  user_id: 'test-user',\n  subject_id: 'test-subject',\n  action: 'start', // start, pause, complete, skip_break, get_status\n  session_type: 'study', // study, short_break, long_break\n  custom_duration: null, // Optional: override default duration in minutes\n  current_topic: 'General Study',\n  difficulty_level: 3,\n  energy_level: 7, // 1-10 scale for adaptive timing\n  previous_sessions_today: 2\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $execution.resumeUrl === undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 400]
    },
    {
      "parameters": {
        "jsCode": "// Get user's adaptive parameters from cache first\nconst input = items[0].json;\nconst cacheKey = `study-buddy:pomodoro:${input.user_id}:${input.subject_id}`;\n\n// Default Pomodoro settings (can be personalized)\nconst defaultSettings = {\n  study_duration: 25, // minutes\n  short_break: 5,\n  long_break: 15,\n  sessions_until_long_break: 4,\n  auto_start_breaks: true,\n  auto_start_sessions: false,\n  ambient_sounds: 'rain', // rain, cafe, library, forest, ocean, silence\n  notification_style: 'gentle' // gentle, motivational, minimal\n};\n\n// Adaptive adjustments based on energy and performance\nconst adaptiveMultiplier = {\n  low_energy: (input.energy_level < 4) ? 0.8 : 1.0, // Shorter sessions when tired\n  high_focus: (input.difficulty_level > 7) ? 1.2 : 1.0, // Longer for difficult material\n  late_day: (input.previous_sessions_today > 5) ? 0.9 : 1.0 // Shorter later in day\n};\n\n// Calculate adaptive durations\nconst finalMultiplier = Object.values(adaptiveMultiplier).reduce((a, b) => a * b, 1.0);\nconst adaptedSettings = {\n  ...defaultSettings,\n  study_duration: Math.round(defaultSettings.study_duration * finalMultiplier),\n  short_break: Math.round(defaultSettings.short_break * (2 - finalMultiplier)), // Inverse for breaks\n  long_break: Math.round(defaultSettings.long_break * (2 - finalMultiplier))\n};\n\n// Override with custom duration if provided\nif (input.custom_duration) {\n  adaptedSettings[input.session_type + '_duration'] = input.custom_duration;\n}\n\nreturn [{\n  json: {\n    ...input,\n    settings: adaptedSettings,\n    session_id: `session_${Date.now()}`,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "calculate-adaptive-timing",
      "name": "Calculate Adaptive Timing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "action-start",
              "leftValue": "={{ $json.action }}",
              "rightValue": "start",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "action-pause",
              "leftValue": "={{ $json.action }}",
              "rightValue": "pause",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "action-complete",
              "leftValue": "={{ $json.action }}",
              "rightValue": "complete",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "action-status",
              "leftValue": "={{ $json.action }}",
              "rightValue": "get_status",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "action-router",
      "name": "Route by Action",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [850, 400]
    },
    {
      "parameters": {
        "content": "={{ JSON.stringify($json, null, 2) }}",
        "key": "={{ `study-buddy:pomodoro:active:${$json.user_id}:${$json.subject_id}` }}",
        "ttl": 7200,
        "options": {}
      },
      "id": "cache-session-start",
      "name": "Cache Session",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1050, 200],
      "credentials": {
        "redis": {
          "id": "redis-study-buddy",
          "name": "Study Buddy Redis"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ `study-buddy:pomodoro:active:${$json.user_id}:${$json.subject_id}` }}",
        "options": {}
      },
      "id": "get-session-status",
      "name": "Get Session Status",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1050, 600],
      "credentials": {
        "redis": {
          "id": "redis-study-buddy",
          "name": "Study Buddy Redis"
        }
      }
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_ollama', 'string') }}",
        "workflowData": "={{ '{\"prompt\": \"' + `You are a supportive study buddy providing encouragement. The student is ${$json.action === 'start' ? 'starting' : $json.action === 'complete' ? 'completing' : 'taking action on'} a ${$json.session_type} session.\n\nContext:\n- Topic: ${$json.current_topic}\n- Energy level: ${$json.energy_level}/10\n- Sessions today: ${$json.previous_sessions_today}\n- Session duration: ${$json.settings?.study_duration || 25} minutes\n\nProvide a brief, encouraging message (max 2 sentences) that:\n- Acknowledges their effort\n- Offers gentle motivation\n- Matches a ${$json.settings?.notification_style || 'gentle'} tone\n- Includes a relevant emoji\n\nExample gentle: \"You're doing great! ðŸŒ± Take it one step at a time.\"\nExample motivational: \"Let's crush this session! ðŸ’ª You've got this!\"\nExample minimal: \"Session started. ðŸ“š\"`.replace(/\"/g, '\\\\\"').replace(/\n/g, '\\\\n') + '\", \"model\": \"llama3.2\", \"type\": \"generation\", \"temperature\": 0.8, \"max_tokens\": 50}' }}",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "generate-encouragement",
      "name": "Generate Encouragement",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ `INSERT INTO pomodoro_sessions \n  (user_id, subject_id, session_type, duration_minutes, \n   topic, energy_level, started_at, status)\nVALUES \n  ('${$json.user_id}', '${$json.subject_id}', '${$json.session_type}',\n   ${$json.settings?.study_duration || 25}, '${$json.current_topic}',\n   ${$json.energy_level}, '${$json.timestamp}', 'active')\nON CONFLICT (user_id, subject_id, started_at) \nDO UPDATE SET \n  status = CASE \n    WHEN '${$json.action}' = 'complete' THEN 'completed'\n    WHEN '${$json.action}' = 'pause' THEN 'paused'\n    ELSE pomodoro_sessions.status\n  END,\n  completed_at = CASE\n    WHEN '${$json.action}' = 'complete' THEN '${new Date().toISOString()}'\n    ELSE pomodoro_sessions.completed_at\n  END\nRETURNING *` }}",
        "options": {}
      },
      "id": "log-session",
      "name": "Log Session",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1250, 450],
      "credentials": {
        "postgres": {
          "id": "postgres-study-buddy",
          "name": "Study Buddy DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Compile final response with all relevant data\nconst input = $input.all()[0].json;\nconst encouragement = $input.all().find(i => i.json.response)?.json.response || \n  'Keep up the great work! ðŸŒŸ';\nconst sessionData = $input.all().find(i => i.json.session_id)?.json || {};\n\n// Calculate end time for active sessions\nlet endTime = null;\nif (input.action === 'start') {\n  const duration = input.settings?.[input.session_type + '_duration'] || \n    (input.session_type === 'study' ? 25 : 5);\n  endTime = new Date(Date.now() + duration * 60 * 1000).toISOString();\n}\n\n// Determine next session type\nconst nextSessionType = (() => {\n  if (input.session_type === 'study') {\n    const sessionCount = (input.previous_sessions_today + 1) % \n      (input.settings?.sessions_until_long_break || 4);\n    return sessionCount === 0 ? 'long_break' : 'short_break';\n  }\n  return 'study';\n})();\n\n// Get ambient sound URL based on preference\nconst ambientSounds = {\n  rain: 'https://example.com/sounds/rain.mp3',\n  cafe: 'https://example.com/sounds/cafe.mp3',\n  library: 'https://example.com/sounds/library.mp3',\n  forest: 'https://example.com/sounds/forest.mp3',\n  ocean: 'https://example.com/sounds/ocean.mp3',\n  silence: null\n};\n\nreturn [{\n  json: {\n    success: true,\n    action: input.action,\n    session: {\n      id: input.session_id,\n      type: input.session_type,\n      status: input.action === 'complete' ? 'completed' : \n              input.action === 'pause' ? 'paused' : 'active',\n      duration_minutes: input.settings?.[input.session_type + '_duration'] || 25,\n      started_at: input.timestamp,\n      ends_at: endTime,\n      topic: input.current_topic\n    },\n    settings: input.settings,\n    encouragement: encouragement,\n    next_session: {\n      type: nextSessionType,\n      duration_minutes: input.settings?.[nextSessionType + '_duration'] || 5,\n      auto_start: input.session_type !== 'study' && \n                   input.settings?.auto_start_sessions\n    },\n    ambient_sound: ambientSounds[input.settings?.ambient_sounds],\n    stats: {\n      sessions_today: input.previous_sessions_today + \n        (input.action === 'start' ? 1 : 0),\n      total_focus_time: (input.previous_sessions_today * 25) + \n        (input.action === 'start' ? input.settings?.study_duration || 25 : 0),\n      streak_days: 1 // Would need to calculate from DB\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "prepare-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "calculate-adaptive-timing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual-trigger": {
      "main": [
        [
          {
            "node": "defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "defaults": {
      "main": [
        [
          {
            "node": "calculate-adaptive-timing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calculate-adaptive-timing": {
      "main": [
        [
          {
            "node": "action-router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "action-router": {
      "main": [
        [
          {
            "node": "cache-session-start",
            "type": "main",
            "index": 0
          },
          {
            "node": "generate-encouragement",
            "type": "main",
            "index": 0
          },
          {
            "node": "log-session",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "generate-encouragement",
            "type": "main",
            "index": 0
          },
          {
            "node": "log-session",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "generate-encouragement",
            "type": "main",
            "index": 0
          },
          {
            "node": "log-session",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get-session-status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cache-session-start": {
      "main": [
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-session-status": {
      "main": [
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate-encouragement": {
      "main": [
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "log-session": {
      "main": [
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-response": {
      "main": [
        [
          {
            "node": "respond-webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "pomodoro-study-timer"
  },
  "pinData": {},
  "versionId": "1.0.0",
  "triggerCount": 2,
  "tags": []
}