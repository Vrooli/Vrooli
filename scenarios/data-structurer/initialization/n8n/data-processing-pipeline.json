{
  "name": "Data Processing Pipeline",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "data-processing-webhook"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "schema_id",
              "value": "={{ $json.schema_id }}"
            },
            {
              "name": "input_type", 
              "value": "={{ $json.input_type }}"
            },
            {
              "name": "input_data",
              "value": "={{ $json.input_data }}"
            }
          ]
        }
      },
      "id": "extract-parameters",
      "name": "Extract Parameters",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $node[\"Extract Parameters\"].json[\"input_type\"] }}",
              "operation": "equal",
              "value2": "file"
            }
          ]
        }
      },
      "id": "check-input-type",
      "name": "Check Input Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "command": "resource-unstructured-io process --input \"{{ $node[\"Extract Parameters\"].json[\"input_data\"] }}\" --output json"
      },
      "id": "extract-file-content",
      "name": "Extract File Content",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [900, 200]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "raw_content",
              "value": "={{ $node[\"Extract Parameters\"].json[\"input_data\"] }}"
            }
          ]
        }
      },
      "id": "use-text-input",
      "name": "Use Text Input",
      "type": "n8n-nodes-base.set", 
      "typeVersion": 1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "url": "http://localhost:${RESOURCE_PORTS[ollama]}/api/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "llama3.2"
            },
            {
              "name": "prompt",
              "value": "Extract structured data from the following text according to this schema: {{ $node[\"Get Schema\"].json[\"schema_definition\"] }}\\n\\nText to process:\\n{{ $json.raw_content }}\\n\\nReturn only valid JSON that matches the schema."
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "ollama-processing",
      "name": "Ollama Processing",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:${API_PORT}/api/v1/schemas/{{ $node[\"Extract Parameters\"].json[\"schema_id\"] }}",
        "options": {}
      },
      "id": "get-schema",
      "name": "Get Schema",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse Ollama response and extract JSON\nconst ollamaResponse = $input.first().json.response;\n\ntry {\n  // Try to extract JSON from the response\n  const jsonMatch = ollamaResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    const extractedData = JSON.parse(jsonMatch[0]);\n    \n    // Calculate a simple confidence score based on completeness\n    const schemaProps = Object.keys($node[\"Get Schema\"].first().json.schema_definition.properties || {});\n    const extractedProps = Object.keys(extractedData);\n    const completeness = extractedProps.length / Math.max(schemaProps.length, 1);\n    \n    return [{\n      structured_data: extractedData,\n      confidence_score: Math.min(completeness * 0.9, 0.95), // Cap at 95%\n      processing_status: 'completed',\n      raw_response: ollamaResponse\n    }];\n  } else {\n    throw new Error('No valid JSON found in response');\n  }\n} catch (error) {\n  return [{\n    structured_data: {},\n    confidence_score: 0,\n    processing_status: 'failed',\n    error_message: error.message,\n    raw_response: ollamaResponse\n  }];\n}"
      },
      "id": "parse-response",
      "name": "Parse Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "url": "resource-postgres exec --query \"INSERT INTO processed_data (id, schema_id, raw_content, structured_data, confidence_score, processing_status, error_message, processed_at) VALUES (uuid_generate_v4(), '{{ $node[\"Extract Parameters\"].json[\"schema_id\"] }}', '{{ $json.raw_content }}', '{{ JSON.stringify($json.structured_data) }}', {{ $json.confidence_score }}, '{{ $json.processing_status }}', '{{ $json.error_message || \"\" }}', NOW())\"",
        "options": {}
      },
      "id": "store-result",
      "name": "Store Result",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"processing_id\": \"{{ $json.processing_id || 'generated-uuid' }}\",\n  \"status\": \"{{ $json.processing_status }}\",\n  \"structured_data\": {{ JSON.stringify($json.structured_data) }},\n  \"confidence_score\": {{ $json.confidence_score }},\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}"
      },
      "id": "return-response",
      "name": "Return Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 120]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "schema_id",
              "value": "test-schema-id"
            },
            {
              "name": "input_type",
              "value": "text"
            },
            {
              "name": "input_data",
              "value": "John Smith is the CEO of TechCorp. His email is john@techcorp.com and he can be reached at +1-555-123-4567. The company is based in San Francisco, CA."
            }
          ]
        }
      },
      "id": "test-data",
      "name": "Test Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [460, 120]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Extract Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Parameters": {
      "main": [
        [
          {
            "node": "Check Input Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Input Type": {
      "main": [
        [
          {
            "node": "Extract File Content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Use Text Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract File Content": {
      "main": [
        [
          {
            "node": "Get Schema",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Use Text Input": {
      "main": [
        [
          {
            "node": "Get Schema",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Schema": {
      "main": [
        [
          {
            "node": "Ollama Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Processing": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Store Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Result": {
      "main": [
        [
          {
            "node": "Return Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Test Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Test Data": {
      "main": [
        [
          {
            "node": "Check Input Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "versionId": "1"
}