version: 1.0
scenario: data-structurer

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/data-structurer
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - initialization/storage/postgres/seed.sql
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/storage
    - examples
    - tests

# Resource validation
resources:
  required: [postgres, ollama, unstructured-io, n8n]
  optional: [qdrant]
  health_timeout: 90

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL is accessible and schema exists"
    type: http
    service: postgres
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "Ollama is responding to inference requests"
    type: http
    service: ollama
    endpoint: /api/generate
    method: POST
    body:
      model: llama3.2
      prompt: "test"
    expect:
      status: 200
      
  - name: "n8n workflows are available"
    type: http
    service: n8n
    endpoint: /health
    method: GET
    expect:
      status: 200

  # API endpoint tests
  - name: "API health endpoint responds correctly"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        service: "data-structurer-api"
        
  - name: "Schema creation API works"
    type: http
    service: api
    endpoint: /api/v1/schemas
    method: POST
    body:
      name: "test_validation_schema"
      description: "Schema for validation testing"
      schema_definition:
        type: "object"
        properties:
          name:
            type: "string"
          value:
            type: "number"
    expect:
      status: 201
      body:
        status: "created"
        
  - name: "Schema listing API works"
    type: http
    service: api
    endpoint: /api/v1/schemas
    method: GET
    expect:
      status: 200
      
  - name: "Schema templates API works"
    type: http
    service: api
    endpoint: /api/v1/schema-templates
    method: GET
    expect:
      status: 200
      
  - name: "Data processing API accepts requests"
    type: http
    service: api
    endpoint: /api/v1/process
    method: POST
    body:
      schema_id: "valid-uuid-here"
      input_type: "text"
      input_data: "Test input for processing"
    expect:
      status: 200

  # CLI command tests
  - name: "CLI status command executes"
    type: exec
    command: ./cli/data-structurer status --json
    expect:
      exit_code: 0
      output_contains: ["healthy"]
      
  - name: "CLI help command works"
    type: exec
    command: ./cli/data-structurer help
    expect:
      exit_code: 0
      output_contains: ["Data Structurer CLI", "USAGE", "COMMANDS"]
      
  - name: "CLI version command works"
    type: exec
    command: ./cli/data-structurer version --json
    expect:
      exit_code: 0
      output_contains: ["version", "1.0.0"]

  # Database tests
  - name: "Database schema is initialized"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('schemas', 'processed_data', 'processing_jobs', 'schema_templates')"
    expect:
      rows: 
        - count: 4
        
  - name: "Schema templates are seeded"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM schema_templates WHERE is_public = true"
    expect:
      rows_min: 5
      
  - name: "Database indexes exist"
    type: sql
    service: postgres  
    query: "SELECT COUNT(*) FROM pg_indexes WHERE schemaname = 'public' AND tablename IN ('schemas', 'processed_data')"
    expect:
      rows_min: 8

  # Integration tests
  - name: "Complete schema creation workflow"
    type: exec
    command: bash tests/test-schema-api.sh
    expect:
      exit_code: 0
      
  - name: "File structure validation"
    type: exec
    command: |
      set -e
      [[ -f "PRD.md" ]] || exit 1
      [[ -x "cli/data-structurer" ]] || exit 2
      [[ -f "api/go.mod" ]] || exit 3
      [[ -f "examples/contact-schema.json" ]] || exit 4
      echo "File structure validated"
    expect:
      exit_code: 0
      output_contains: ["File structure validated"]

# Performance validation targets
performance:
  api_response_time_ms: 1000
  schema_creation_time_ms: 500
  database_query_time_ms: 100
  concurrent_requests: 10