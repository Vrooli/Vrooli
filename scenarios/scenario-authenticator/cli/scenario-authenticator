#!/usr/bin/env bash

# Scenario Authenticator CLI
# Command-line interface for authentication service management

set -e

# Configuration
SCENARIO_NAME="scenario-authenticator"
AUTH_TOKEN="${AUTH_TOKEN:-}"
OUTPUT_FORMAT="${OUTPUT_FORMAT:-text}"

# Role normalization helpers
NORMALIZED_ROLES_JSON=""
NORMALIZED_ROLES_DISPLAY=""
NORMALIZED_ROLES_IS_DEFAULT="true"

normalize_roles_input() {
    local roles_input="$1"

    declare -A role_map=()
    local role_parts=()
    IFS=',' read -r -a role_parts <<< "$roles_input"
    for part in "${role_parts[@]}"; do
        local trimmed
        trimmed=$(echo "$part" | awk '{gsub(/^ +| +$/,"" ); print tolower($0)}')
        if [[ -n "$trimmed" ]]; then
            role_map["$trimmed"]=1
        fi
    done

    # Always ensure baseline access role is present
    role_map["user"]=1

    local tmp_roles=()
    for key in "${!role_map[@]}"; do
        tmp_roles+=("$key")
    done

    if [[ ${#tmp_roles[@]} -eq 0 ]]; then
        tmp_roles=("user")
    fi

    IFS=$'\n' tmp_roles=($(printf '%s\n' "${tmp_roles[@]}" | sort))

    NORMALIZED_ROLES_JSON=$(printf '%s\n' "${tmp_roles[@]}" | jq -R . | jq -c -s .)
    NORMALIZED_ROLES_DISPLAY=$(printf '%s\n' "${tmp_roles[@]}" | awk 'BEGIN{ORS=""}{if(NR>1)printf(", "); printf("%s", $0)}')

    if [[ ${#tmp_roles[@]} -eq 1 && "${tmp_roles[0]}" == "user" ]]; then
        NORMALIZED_ROLES_IS_DEFAULT="true"
    else
        NORMALIZED_ROLES_IS_DEFAULT="false"
    fi
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Port Discovery - Dynamic port lookup
get_api_url() {
    # Use vrooli scenario port command for dynamic port lookup
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}❌ Error: ${SCENARIO_NAME} is not running or not accessible${NC}" >&2
        echo -e "${YELLOW}   Troubleshooting:${NC}" >&2
        echo "   1. Start the service: vrooli scenario run ${SCENARIO_NAME}" >&2
        echo "   2. Or use: cd scenarios/${SCENARIO_NAME} && make run" >&2
        echo "   3. Check service status: vrooli scenario status ${SCENARIO_NAME}" >&2
        echo "   4. View logs: vrooli scenario logs ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

get_ui_url() {
    # Get UI port for integration code generation
    local ui_port
    ui_port=$(vrooli scenario port "${SCENARIO_NAME}" UI_PORT 2>/dev/null)
    
    if [[ -z "$ui_port" ]]; then
        echo ""
        return 1
    fi
    
    echo "http://localhost:${ui_port}"
}

# Initialize API URL on first use
API_URL=""
get_api_url_cached() {
    if [[ -z "$API_URL" ]]; then
        API_URL=$(get_api_url)
    fi
    echo "$API_URL"
}

# Helper functions
print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_info() {
    echo -e "${BLUE}→ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# API request helper
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    local api_url=$(get_api_url_cached)
    
    local curl_args=(-s -X "$method" -H "Content-Type: application/json")

    if [ -n "$AUTH_TOKEN" ]; then
        curl_args+=(-H "Authorization: Bearer $AUTH_TOKEN")
    fi

    if [ -n "$data" ]; then
        curl_args+=(-d "$data")
    fi

    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

# Commands

cmd_status() {
    local verbose="${1:-false}"
    
    print_info "Checking authentication service status..."
    
    response=$(api_request GET "/health")
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        status=$(echo "$response" | jq -r '.status')
        database=$(echo "$response" | jq -r '.database')
        redis=$(echo "$response" | jq -r '.redis')
        version=$(echo "$response" | jq -r '.version')
        
        echo "Service Status: $status"
        echo "Database: $([ "$database" == "true" ] && echo "✓ Connected" || echo "✗ Disconnected")"
        echo "Redis: $([ "$redis" == "true" ] && echo "✓ Connected" || echo "✗ Disconnected")"
        echo "Version: $version"
        
        if [ "$verbose" == "--verbose" ]; then
            echo ""
            echo "API URL: $(get_api_url_cached)"
            echo "Configuration:"
            echo "  - JWT tokens expire in 1 hour"
            echo "  - Refresh tokens expire in 7 days"
            echo "  - Session storage in Redis"
            echo "  - User data in PostgreSQL"
        fi
    fi
}


cmd_user_create() {
    local email="$1"
    local password="$2"
    local username="$3"
    local roles="${4:-user}"

    # Normalize requested roles for follow-up update (if provided)
    if [[ -n "$roles" ]]; then
        normalize_roles_input "$roles"
    fi

	if [ -z "$email" ] || [ -z "$password" ]; then
		print_error "Email and password are required"
		echo "Usage: $0 user create <email> <password> [username] [roles]"
		exit 1
	fi

	if [ ${#password} -lt 8 ]; then
		print_error "Password must be at least 8 characters"
		exit 1
	fi

	print_info "Creating user account..."

	if [[ "$username" == "-" ]]; then
		username=""
	fi

	data="{\"email\":\"$email\",\"password\":\"$password\""
	if [[ -n "$username" ]]; then
		data="${data},\"username\":\"$username\""
	fi
	data="${data}}"

	response=$(api_request POST "/api/v1/auth/register" "$data")
	success=$(echo "$response" | jq -r '.success')
    
	if [ "$success" == "true" ]; then
		if [ "$OUTPUT_FORMAT" == "json" ]; then
			echo "$response"
		else
			user_id=$(echo "$response" | jq -r '.user.id')
			user_email=$(echo "$response" | jq -r '.user.email')
			token=$(echo "$response" | jq -r '.token')

			print_success "User created successfully"
			echo "ID: $user_id"
			echo "Email: $user_email"
			echo "Initial Token: ${token:0:20}..."
			echo ""
			echo "Use this token for authenticated requests:"
			echo "export AUTH_TOKEN=\"$token\""

        if [[ "$NORMALIZED_ROLES_IS_DEFAULT" == "false" ]]; then
            if [[ -z "$AUTH_TOKEN" ]]; then
                print_warning "Requested roles (${NORMALIZED_ROLES_DISPLAY}) require an admin AUTH_TOKEN. User currently has default 'user' role."
            else
                update_payload=$(jq -n --argjson roles "$NORMALIZED_ROLES_JSON" '{roles: $roles}')
                update_response=$(api_request PUT "/api/v1/users/${user_id}" "$update_payload")
                update_success=$(echo "$update_response" | jq -r '.success // empty')
                if [[ "$update_success" == "true" ]]; then
                    print_success "Assigned roles: ${NORMALIZED_ROLES_DISPLAY}"
                else
                    update_error=$(echo "$update_response" | jq -r '.error // .message // "unknown error"')
                    print_warning "User created but role update failed: ${update_error}"
					fi
				fi
			fi
		fi
	else
		error=$(echo "$response" | jq -r '.error // .message')
		print_error "Failed to create user: $error"
		exit 1
    fi
}

cmd_user_list() {
    local role_filter="$1"
    local limit="${2:-10}"
    
    print_info "Listing users..."
    
    endpoint="/api/v1/users"
    if [ -n "$role_filter" ]; then
        endpoint="${endpoint}?role=$role_filter&limit=$limit"
    else
        endpoint="${endpoint}?limit=$limit"
    fi
    
    response=$(api_request GET "$endpoint")
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        users=$(echo "$response" | jq -r '.users[]')
        total=$(echo "$response" | jq -r '.total')
        
        if [ -z "$users" ]; then
            echo "No users found"
        else
            echo "Users (showing up to $limit of $total):"
            echo "$response" | jq -r '.users[] | "  - \(.email) (\(.id)) - Roles: \(.roles | join(", "))"'
        fi
    fi
}

cmd_user_delete() {
    local user_id="$1"

    if [ -z "$user_id" ]; then
        print_error "User ID is required"
        echo "Usage: $0 user delete <user_id>"
        exit 1
    fi

    if [ -z "$AUTH_TOKEN" ]; then
        print_error "AUTH_TOKEN is required to delete users"
        echo "Export an admin token first, e.g. AUTH_TOKEN=\"$(echo 'login_response' | jq -r '.token')\""
        exit 1
    fi

    print_info "Deleting user $user_id..."

    local response
    response=$(api_request DELETE "/api/v1/users/${user_id}")
    local success
    success=$(echo "$response" | jq -r '.success // empty')

    if [[ "$success" == "true" ]]; then
        print_success "User deleted"
    else
        local error_message
        error_message=$(echo "$response" | jq -r '.error // .message // "unknown error"')
        print_error "Failed to delete user: ${error_message}"
        exit 1
    fi
}

cmd_user_get() {
    local user_id="$1"

    if [ -z "$user_id" ]; then
        print_error "User ID is required"
        echo "Usage: $0 user get <user_id>"
        exit 1
    fi

    local response
    response=$(api_request GET "/api/v1/users/${user_id}")

    if echo "$response" | jq -e '.error?' >/dev/null 2>&1; then
        local error_message
        error_message=$(echo "$response" | jq -r '.error // .message // "unknown error"')
        print_error "Failed to fetch user: ${error_message}"
        exit 1
    fi

    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        local email roles verified created last_login
        email=$(echo "$response" | jq -r '.email')
        roles=$(echo "$response" | jq -r '.roles | join(", ")')
        verified=$(echo "$response" | jq -r '.email_verified')
        created=$(echo "$response" | jq -r '.created_at')
        last_login=$(echo "$response" | jq -r '.last_login // "never"')

        echo "User: $email"
        echo "Roles: ${roles:-user}"
        echo "Email Verified: $verified"
        echo "Created: $created"
        echo "Last Login: $last_login"
    fi
}

cmd_user_update() {
    local user_id="$1"
    local field="$2"
    local value="$3"

    if [ -z "$user_id" ] || [ -z "$field" ]; then
        print_error "User ID and field are required"
        echo "Usage: $0 user update <user_id> <field> <value>"
        echo "Fields: roles, username, email_verified"
        exit 1
    fi

    if [ -z "$AUTH_TOKEN" ]; then
        print_error "AUTH_TOKEN is required to update users"
        echo "Export an admin token first, e.g. AUTH_TOKEN=\"$(echo 'login_response' | jq -r '.token')\""
        exit 1
    fi

    local payload=""
    case "$field" in
        roles)
            if [ -z "$value" ]; then
                print_error "Roles value is required"
                exit 1
            fi
            normalize_roles_input "$value"
            payload=$(jq -n --argjson roles "$NORMALIZED_ROLES_JSON" '{roles: $roles}')
            ;;
        username)
            if [ -z "$value" ]; then
                print_error "Username value is required"
                exit 1
            fi
            if [[ "$value" == "-" ]]; then
                payload=$(jq -n '{username: ""}')
            else
                payload=$(jq -n --arg username "$value" '{username: $username}')
            fi
            ;;
        email_verified)
            if [ -z "$value" ]; then
                print_error "email_verified value is required (true/false)"
                exit 1
            fi
            local bool_value
            case "${value,,}" in
                true|1|yes)
                    bool_value=true
                    ;;
                false|0|no)
                    bool_value=false
                    ;;
                *)
                    print_error "Invalid email_verified value. Use true/false"
                    exit 1
                    ;;
            esac
            payload=$(jq -n --argjson email_verified "$bool_value" '{email_verified: $email_verified}')
            ;;
        *)
            print_error "Unsupported field: $field"
            echo "Supported fields: roles, username, email_verified"
            exit 1
            ;;
    esac

    print_info "Updating user $user_id..."

    local response
    response=$(api_request PUT "/api/v1/users/${user_id}" "$payload")
    local success
    success=$(echo "$response" | jq -r '.success // empty')

    if [[ "$success" == "true" ]]; then
        print_success "User updated"
        if [ "$OUTPUT_FORMAT" == "json" ]; then
            echo "$response"
        else
            local updated_roles updated_username updated_verified
            updated_roles=$(echo "$response" | jq -r '.user.roles | join(", ")')
            updated_username=$(echo "$response" | jq -r '.user.username // ""')
            updated_verified=$(echo "$response" | jq -r '.user.email_verified')

            echo "Roles: ${updated_roles:-user}"
            if [ -n "$updated_username" ]; then
                echo "Username: $updated_username"
            fi
            echo "Email Verified: $updated_verified"
        fi
    else
        local error_message
        error_message=$(echo "$response" | jq -r '.error // .message // "unknown error"')
        print_error "Failed to update user: ${error_message}"
        exit 1
    fi
}

cmd_token_validate() {
    local token="$1"
    
    if [ -z "$token" ]; then
        print_error "Token is required"
        echo "Usage: $0 token validate <token>"
        exit 1
    fi
    
    print_info "Validating token..."
    
    AUTH_TOKEN="$token" response=$(api_request GET "/api/v1/auth/validate")
    valid=$(echo "$response" | jq -r '.valid')
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        if [ "$valid" == "true" ]; then
            user_id=$(echo "$response" | jq -r '.user_id')
            email=$(echo "$response" | jq -r '.email')
            roles=$(echo "$response" | jq -r '.roles | join(", ")')
            expires=$(echo "$response" | jq -r '.expires_at')
            
            print_success "Token is valid"
            echo "User ID: $user_id"
            echo "Email: $email"
            echo "Roles: $roles"
            echo "Expires: $expires"
        else
            print_error "Token is invalid or expired"
            exit 1
        fi
    fi
}

cmd_session_list() {
    local user_id="$1"
    
    print_info "Listing active sessions..."
    
    endpoint="/api/v1/sessions"
    if [ -n "$user_id" ]; then
        endpoint="${endpoint}?user_id=$user_id"
    fi
    
    response=$(api_request GET "$endpoint")
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        sessions=$(echo "$response" | jq -r '.sessions[]')
        total=$(echo "$response" | jq -r '.total')
        
        echo "Active Sessions: $total"
        if [ -n "$sessions" ]; then
            echo "$response" | jq -r '.sessions[] | "  - User: \(.user_id) | IP: \(.ip_address) | Created: \(.created_at)"'
        fi
    fi
}

cmd_protect() {
    local scenario="$1"
    local type="${2:-api}"
    
    if [ -z "$scenario" ]; then
        print_error "Scenario name is required"
        echo "Usage: $0 protect <scenario> [type]"
        echo "Types: api, ui"
        exit 1
    fi
    
    print_info "Generating integration code for $scenario..."
    
    # Get dynamic URLs
    local api_url=$(get_api_url_cached)
    local ui_url=$(get_ui_url)
    
    case "$type" in
        api)
            cat << EOF
// Add to your API handler
const validateAuth = async (req, res, next) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) {
        return res.status(401).json({ error: 'No token provided' });
    }
    
    try {
        // Get auth API port dynamically
        const authApiPort = process.env.API_PORT;
        const authApiUrl = \`http://localhost:\${authApiPort}\`;
        
        const response = await fetch(\`\${authApiUrl}/api/v1/auth/validate\`, {
            headers: { 'Authorization': \`Bearer \${token}\` }
        });
        
        const validation = await response.json();
        if (validation.valid) {
            req.user = {
                id: validation.user_id,
                email: validation.email,
                roles: validation.roles
            };
            next();
        } else {
            res.status(401).json({ error: 'Invalid token' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Auth service unavailable' });
    }
};

// Use: router.use(validateAuth);
EOF
            ;;
            
        ui)
            cat << EOF
// Add to your UI initialization
async function checkAuth() {
    const token = localStorage.getItem('auth_token');
    if (!token) {
        // Get auth UI port dynamically from environment or configuration
        const authUiPort = window.UI_PORT || '${ui_url##*:}';
        window.location.href = \`http://localhost:\${authUiPort}/login?redirect=\` + 
                              encodeURIComponent(window.location.href);
        return false;
    }
    
    try {
        // Get auth API port dynamically from environment or configuration
        const authApiPort = window.API_PORT || '${api_url##*:}';
        const authApiUrl = \`http://localhost:\${authApiPort}\`;
        
        const response = await fetch(\`\${authApiUrl}/api/v1/auth/validate\`, {
            headers: { 'Authorization': \`Bearer \${token}\` }
        });
        
        const validation = await response.json();
        if (!validation.valid) {
            localStorage.removeItem('auth_token');
            const authUiPort = window.UI_PORT || '${ui_url##*:}';
            window.location.href = \`http://localhost:\${authUiPort}/login?redirect=\` + 
                                  encodeURIComponent(window.location.href);
            return false;
        }
        
        window.currentUser = validation;
        return true;
    } catch (error) {
        console.error('Auth check failed:', error);
        return false;
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', checkAuth);
EOF
            ;;
            
        *)
            print_error "Unknown integration type: $type"
            echo "Valid types: api, ui"
            exit 1
            ;;
    esac
    
    echo ""
    print_success "Integration code generated for $scenario"
}

cmd_version() {
    echo "Scenario Authenticator CLI v1.0.0"
    response=$(api_request GET "/health" 2>/dev/null)
    if [ $? -eq 0 ]; then
        api_version=$(echo "$response" | jq -r '.version' 2>/dev/null || echo "unknown")
        echo "API Version: $api_version"
    fi
}

cmd_help() {
    cat << EOF
Scenario Authenticator CLI v1.0.0
Universal authentication service for Vrooli

Usage: $0 <command> [arguments]

CORE COMMANDS:
    status [--verbose]                      Show service health and statistics
    help                                    Show this help message  
    version                                 Show CLI and API versions

USER MANAGEMENT:
    user create <email> <pass> [username]   Create new user account
    user list [role] [limit]               List users with optional filters
    user get <id>                          Get user details by ID
    user update <id> <field> <value>       Update user field (admin token)
    user delete <id>                       Delete user (soft delete, admin token)

TOKEN OPERATIONS:
    token validate <token>                  Validate JWT token and show info
    token refresh <refresh_token>           Get new token from refresh token

SESSION MANAGEMENT:
    session list [user_id]                  List active user sessions
    session revoke <session_id>             Revoke specific session

INTEGRATION:
    protect <scenario> [type]               Generate integration code
                                           Types: api (default), ui

ENVIRONMENT VARIABLES:
    AUTH_TOKEN      Bearer token for authenticated API requests
    OUTPUT_FORMAT   Output format: text (default) or json

EXAMPLES:

    # Service Management
    $0 status --verbose                     # Detailed service status
    OUTPUT_FORMAT=json $0 status           # Status in JSON format

    # User Operations  
    $0 user create admin@company.com "Secure123!" admin
    $0 user list                           # List all users
    $0 user list admin 5                   # List 5 admin users
    export AUTH_TOKEN=\"...\"             # Admin login token required below
    $0 user update \$USER_ID roles admin,moderator
    $0 user delete \$USER_ID
    
    # Token Operations
    $0 token validate "\$AUTH_TOKEN"        # Validate current token
    export AUTH_TOKEN="\$(echo '\$LOGIN_RESPONSE' | jq -r '.token')"
    
    # Integration Code Generation
    $0 protect my-scenario api             # Generate API middleware
    $0 protect my-scenario ui              # Generate UI auth check
    
    # Session Management
    $0 session list                        # All active sessions
    $0 session list \$USER_ID              # Sessions for specific user

TROUBLESHOOTING:
    - Ensure service is running: vrooli scenario run scenario-authenticator
    - Check service logs: vrooli scenario logs scenario-authenticator  
    - Verify database connection: $0 status --verbose
    - Test API directly: curl \$(vrooli scenario port scenario-authenticator API_PORT)/health

For more information: https://docs.vrooli.com/scenarios/authentication
EOF
}

# Main command routing
case "${1:-}" in
    status)
        cmd_status "$2"
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    user)
        case "${2:-}" in
            create)
                cmd_user_create "$3" "$4" "$5" "$6"
                ;;
            list)
                cmd_user_list "$3" "$4"
                ;;
            get)
                cmd_user_get "$3"
                ;;
            delete)
                cmd_user_delete "$3"
                ;;
            update)
                cmd_user_update "$3" "$4" "$5"
                ;;
            *)
                print_error "Unknown user command: $2"
                echo "Available user commands:"
                echo "  - create <email> <password> [username]  Create new user"
                echo "  - list [role] [limit]                   List users"
                echo "  - get <id>                              Get user by ID"
                echo "  - update <id> <field> <value>           Update user (admin token required)"
                echo "  - delete <id>                           Delete user (admin token required)"
                echo ""
                echo "Use: $0 help for complete documentation"
                exit 1
                ;;
        esac
        ;;
    token)
        case "${2:-}" in
            validate)
                cmd_token_validate "$3"
                ;;
            refresh)
                print_warning "Token refresh not yet implemented"
                echo "Available token commands:"
                echo "  - validate <token>           Validate JWT token"
                echo "  - refresh <refresh_token>    Refresh token (coming soon)"
                exit 1
                ;;
            *)
                print_error "Unknown token command: $2"
                echo "Available token commands:"
                echo "  - validate <token>           Validate JWT token and show details"
                echo "  - refresh <refresh_token>    Get new token from refresh token (coming soon)"
                echo ""
                echo "Example: $0 token validate \"eyJhbGciOiJSUzI1NiIs...\""
                echo "Use: $0 help for complete documentation"
                exit 1
                ;;
        esac
        ;;
    session)
        case "${2:-}" in
            list)
                cmd_session_list "$3"
                ;;
            revoke)
                print_warning "Session revoke not yet implemented"
                echo "Available session commands:"
                echo "  - list [user_id]           List active sessions"
                echo "  - revoke <session_id>      Revoke session (coming soon)"
                exit 1
                ;;
            *)
                print_error "Unknown session command: $2"
                echo "Available session commands:"
                echo "  - list [user_id]           List active user sessions"
                echo "  - revoke <session_id>      Revoke specific session (coming soon)"
                echo ""
                echo "Examples:"
                echo "  $0 session list                     # All active sessions"
                echo "  $0 session list abc123...           # Sessions for specific user"
                echo "Use: $0 help for complete documentation"
                exit 1
                ;;
        esac
        ;;
    protect)
        cmd_protect "$2" "$3"
        ;;
    "")
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        echo "Available commands:"
        echo "  status      Show service status"
        echo "  version     Show version information"
        echo "  user        User management (create, list)"
        echo "  token       Token operations (validate)"
        echo "  session     Session management (list)"
        echo "  protect     Generate integration code"
        echo "  help        Show detailed help"
        echo ""
        echo "Examples:"
        echo "  $0 status                           # Check service health"
        echo "  $0 user create test@example.com     # Create new user"
        echo "  $0 help                            # Complete documentation"
        exit 1
        ;;
esac
