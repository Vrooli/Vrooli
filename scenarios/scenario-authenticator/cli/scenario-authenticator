#!/usr/bin/env bash

# Scenario Authenticator CLI
# Command-line interface for authentication service management

set -e

# Configuration
API_URL="${AUTH_API_URL:-http://localhost:3250}"
AUTH_TOKEN="${AUTH_TOKEN:-}"
OUTPUT_FORMAT="${OUTPUT_FORMAT:-text}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_info() {
    echo -e "${BLUE}→ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# API request helper
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    local auth_header=""
    
    if [ -n "$AUTH_TOKEN" ]; then
        auth_header="-H \"Authorization: Bearer $AUTH_TOKEN\""
    fi
    
    if [ -n "$data" ]; then
        curl -s -X "$method" \
             -H "Content-Type: application/json" \
             $auth_header \
             -d "$data" \
             "${API_URL}${endpoint}"
    else
        curl -s -X "$method" \
             -H "Content-Type: application/json" \
             $auth_header \
             "${API_URL}${endpoint}"
    fi
}

# Commands

cmd_status() {
    local verbose="${1:-false}"
    
    print_info "Checking authentication service status..."
    
    response=$(api_request GET "/health")
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        status=$(echo "$response" | jq -r '.status')
        database=$(echo "$response" | jq -r '.database')
        redis=$(echo "$response" | jq -r '.redis')
        version=$(echo "$response" | jq -r '.version')
        
        echo "Service Status: $status"
        echo "Database: $([ "$database" == "true" ] && echo "✓ Connected" || echo "✗ Disconnected")"
        echo "Redis: $([ "$redis" == "true" ] && echo "✓ Connected" || echo "✗ Disconnected")"
        echo "Version: $version"
        
        if [ "$verbose" == "--verbose" ]; then
            echo ""
            echo "API URL: $API_URL"
            echo "Configuration:"
            echo "  - JWT tokens expire in 1 hour"
            echo "  - Refresh tokens expire in 7 days"
            echo "  - Session storage in Redis"
            echo "  - User data in PostgreSQL"
        fi
    fi
}

cmd_user_create() {
    local email="$1"
    local password="$2"
    local username="$3"
    local roles="${4:-user}"
    
    if [ -z "$email" ] || [ -z "$password" ]; then
        print_error "Email and password are required"
        echo "Usage: $0 user create <email> <password> [username] [roles]"
        exit 1
    fi
    
    if [ ${#password} -lt 8 ]; then
        print_error "Password must be at least 8 characters"
        exit 1
    fi
    
    print_info "Creating user account..."
    
    data="{\"email\":\"$email\",\"password\":\"$password\""
    if [ -n "$username" ]; then
        data="${data},\"username\":\"$username\""
    fi
    data="${data}}"
    
    response=$(api_request POST "/api/v1/auth/register" "$data")
    success=$(echo "$response" | jq -r '.success')
    
    if [ "$success" == "true" ]; then
        if [ "$OUTPUT_FORMAT" == "json" ]; then
            echo "$response"
        else
            user_id=$(echo "$response" | jq -r '.user.id')
            user_email=$(echo "$response" | jq -r '.user.email')
            token=$(echo "$response" | jq -r '.token')
            
            print_success "User created successfully"
            echo "ID: $user_id"
            echo "Email: $user_email"
            echo "Initial Token: ${token:0:20}..."
            echo ""
            echo "Use this token for authenticated requests:"
            echo "export AUTH_TOKEN=\"$token\""
        fi
    else
        error=$(echo "$response" | jq -r '.error // .message')
        print_error "Failed to create user: $error"
        exit 1
    fi
}

cmd_user_list() {
    local role_filter="$1"
    local limit="${2:-10}"
    
    print_info "Listing users..."
    
    endpoint="/api/v1/users"
    if [ -n "$role_filter" ]; then
        endpoint="${endpoint}?role=$role_filter&limit=$limit"
    else
        endpoint="${endpoint}?limit=$limit"
    fi
    
    response=$(api_request GET "$endpoint")
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        users=$(echo "$response" | jq -r '.users[]')
        total=$(echo "$response" | jq -r '.total')
        
        if [ -z "$users" ]; then
            echo "No users found"
        else
            echo "Users (showing up to $limit of $total):"
            echo "$response" | jq -r '.users[] | "  - \(.email) (\(.id)) - Roles: \(.roles | join(", "))"'
        fi
    fi
}

cmd_token_validate() {
    local token="$1"
    
    if [ -z "$token" ]; then
        print_error "Token is required"
        echo "Usage: $0 token validate <token>"
        exit 1
    fi
    
    print_info "Validating token..."
    
    AUTH_TOKEN="$token" response=$(api_request GET "/api/v1/auth/validate")
    valid=$(echo "$response" | jq -r '.valid')
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        if [ "$valid" == "true" ]; then
            user_id=$(echo "$response" | jq -r '.user_id')
            email=$(echo "$response" | jq -r '.email')
            roles=$(echo "$response" | jq -r '.roles | join(", ")')
            expires=$(echo "$response" | jq -r '.expires_at')
            
            print_success "Token is valid"
            echo "User ID: $user_id"
            echo "Email: $email"
            echo "Roles: $roles"
            echo "Expires: $expires"
        else
            print_error "Token is invalid or expired"
            exit 1
        fi
    fi
}

cmd_session_list() {
    local user_id="$1"
    
    print_info "Listing active sessions..."
    
    endpoint="/api/v1/sessions"
    if [ -n "$user_id" ]; then
        endpoint="${endpoint}?user_id=$user_id"
    fi
    
    response=$(api_request GET "$endpoint")
    
    if [ "$OUTPUT_FORMAT" == "json" ]; then
        echo "$response"
    else
        sessions=$(echo "$response" | jq -r '.sessions[]')
        total=$(echo "$response" | jq -r '.total')
        
        echo "Active Sessions: $total"
        if [ -n "$sessions" ]; then
            echo "$response" | jq -r '.sessions[] | "  - User: \(.user_id) | IP: \(.ip_address) | Created: \(.created_at)"'
        fi
    fi
}

cmd_protect() {
    local scenario="$1"
    local type="${2:-api}"
    
    if [ -z "$scenario" ]; then
        print_error "Scenario name is required"
        echo "Usage: $0 protect <scenario> [type]"
        echo "Types: api, ui, workflow"
        exit 1
    fi
    
    print_info "Generating integration code for $scenario..."
    
    case "$type" in
        api)
            cat << 'EOF'
// Add to your API handler
const validateAuth = async (req, res, next) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) {
        return res.status(401).json({ error: 'No token provided' });
    }
    
    try {
        const response = await fetch('http://localhost:3250/api/v1/auth/validate', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const validation = await response.json();
        if (validation.valid) {
            req.user = {
                id: validation.user_id,
                email: validation.email,
                roles: validation.roles
            };
            next();
        } else {
            res.status(401).json({ error: 'Invalid token' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Auth service unavailable' });
    }
};

// Use: router.use(validateAuth);
EOF
            ;;
            
        ui)
            cat << 'EOF'
// Add to your UI initialization
async function checkAuth() {
    const token = localStorage.getItem('auth_token');
    if (!token) {
        window.location.href = 'http://localhost:3251/login?redirect=' + 
                              encodeURIComponent(window.location.href);
        return false;
    }
    
    try {
        const response = await fetch('http://localhost:3250/api/v1/auth/validate', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const validation = await response.json();
        if (!validation.valid) {
            localStorage.removeItem('auth_token');
            window.location.href = 'http://localhost:3251/login?redirect=' + 
                                  encodeURIComponent(window.location.href);
            return false;
        }
        
        window.currentUser = validation;
        return true;
    } catch (error) {
        console.error('Auth check failed:', error);
        return false;
    }
}

// Call on page load
document.addEventListener('DOMContentLoaded', checkAuth);
EOF
            ;;
            
        workflow)
            cat << 'EOF'
Use the shared n8n workflow: initialization/n8n/auth-validator.json

1. Import the workflow into your scenario
2. Set webhook URL to your endpoint
3. Configure to call auth validation
4. Check response.valid before proceeding

Example webhook node configuration:
{
  "webhookUrl": "/your-endpoint",
  "responseMode": "onReceived",
  "responseData": "allEntries",
  "options": {
    "validateAuth": true
  }
}
EOF
            ;;
            
        *)
            print_error "Unknown integration type: $type"
            echo "Valid types: api, ui, workflow"
            exit 1
            ;;
    esac
    
    echo ""
    print_success "Integration code generated for $scenario"
}

cmd_version() {
    echo "Scenario Authenticator CLI v1.0.0"
    response=$(api_request GET "/health" 2>/dev/null)
    if [ $? -eq 0 ]; then
        api_version=$(echo "$response" | jq -r '.version' 2>/dev/null || echo "unknown")
        echo "API Version: $api_version"
    fi
}

cmd_help() {
    cat << EOF
Scenario Authenticator CLI - Universal authentication service for Vrooli

Usage: $0 <command> [arguments]

Commands:
    status [--verbose]                      Show service status
    help                                    Show this help message
    version                                 Show CLI and API versions
    
    user create <email> <pass> [username]   Create new user account
    user list [role] [limit]               List users with optional filters
    user get <id>                          Get user details
    user update <id> <field> <value>       Update user field
    user delete <id>                       Delete user (soft delete)
    
    token validate <token>                  Validate JWT token
    token refresh <refresh_token>           Get new token from refresh token
    
    session list [user_id]                  List active sessions
    session revoke <session_id>             Revoke specific session
    
    protect <scenario> [type]               Generate integration code
    
Environment Variables:
    AUTH_API_URL    API endpoint (default: http://localhost:3250)
    AUTH_TOKEN      Bearer token for authenticated requests
    OUTPUT_FORMAT   Output format: text or json (default: text)

Examples:
    # Create admin user
    $0 user create admin@example.com SecurePass123! admin
    
    # Validate a token
    $0 token validate "eyJhbGciOiJSUzI1NiIs..."
    
    # Generate UI protection code
    $0 protect my-scenario ui
    
    # Get JSON output
    OUTPUT_FORMAT=json $0 status

For more information, see: https://github.com/vrooli/scenarios/scenario-authenticator
EOF
}

# Main command routing
case "${1:-}" in
    status)
        cmd_status "$2"
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        cmd_help
        ;;
    user)
        case "${2:-}" in
            create)
                cmd_user_create "$3" "$4" "$5" "$6"
                ;;
            list)
                cmd_user_list "$3" "$4"
                ;;
            *)
                print_error "Unknown user command: $2"
                echo "Use: $0 user [create|list|get|update|delete]"
                exit 1
                ;;
        esac
        ;;
    token)
        case "${2:-}" in
            validate)
                cmd_token_validate "$3"
                ;;
            refresh)
                print_warning "Not implemented yet"
                ;;
            *)
                print_error "Unknown token command: $2"
                echo "Use: $0 token [validate|refresh]"
                exit 1
                ;;
        esac
        ;;
    session)
        case "${2:-}" in
            list)
                cmd_session_list "$3"
                ;;
            revoke)
                print_warning "Not implemented yet"
                ;;
            *)
                print_error "Unknown session command: $2"
                echo "Use: $0 session [list|revoke]"
                exit 1
                ;;
        esac
        ;;
    protect)
        cmd_protect "$2" "$3"
        ;;
    "")
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo "Use: $0 help"
        exit 1
        ;;
esac