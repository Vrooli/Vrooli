<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authentication Control Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script type="module">
        import { initIframeBridgeChild } from '/node_modules/@vrooli/iframe-bridge/dist/iframeBridgeChild.js';

        if (typeof window !== 'undefined' && window.parent !== window && !window.__scenarioAuthenticatorBridgeInitialized) {
            let parentOrigin;
            try {
                if (document.referrer) {
                    parentOrigin = new URL(document.referrer).origin;
                }
            } catch (error) {
                console.warn('[ScenarioAuthenticator] Unable to parse parent origin for iframe bridge', error);
            }

            initIframeBridgeChild({ parentOrigin, appId: 'scenario-authenticator' });
            window.__scenarioAuthenticatorBridgeInitialized = true;
        }
    </script>
    <style>
        :root {
            --surface: #ffffff;
            --surface-subtle: #f8fafc;
            --surface-strong: #eef2ff;
            --border: #e2e8f0;
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --text-strong: #0f172a;
            --text-muted: #64748b;
            --muted-accent: #94a3b8;
            --shadow: 0 30px 60px rgba(15, 23, 42, 0.12);
            --success: #16a34a;
            --warning: #f97316;
            --error: #ef4444;
            --info: #0ea5e9;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 48px 24px;
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 55%, #0b1120 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: var(--text-strong);
        }

        .dashboard-shell {
            width: min(1120px, 100%);
            background: var(--surface);
            border-radius: 28px;
            box-shadow: var(--shadow);
            padding: 40px 48px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            position: relative;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 32px;
        }

        .title-group {
            max-width: 560px;
        }

        .app-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--primary-soft);
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--primary);
        }

        .title-group h1 {
            margin: 14px 0 12px;
            font-size: clamp(28px, 4vw, 36px);
            font-weight: 700;
            color: var(--text-strong);
        }

        .title-group p {
            margin: 0;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .user-summary {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 18px 22px;
            background: var(--surface-subtle);
            border: 1px solid var(--border);
            border-radius: 20px;
        }

        .user-summary__meta {
            display: flex;
            flex-direction: column;
            text-align: right;
            gap: 6px;
        }

        .user-summary__name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-strong);
        }

        .user-summary__roles {
            font-size: 13px;
            color: var(--muted-accent);
        }

        .user-summary__avatar {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            display: grid;
            place-items: center;
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
        }

        .session-panel {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(124, 58, 237, 0.08) 100%);
            border-radius: 24px;
            padding: 28px 32px;
            border: 1px solid rgba(37, 99, 235, 0.18);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .session-panel__status {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--text-strong);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: var(--muted-accent);
            box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.2);
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .status-dot--active {
            background: var(--success);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        .status-dot--inactive {
            background: var(--error);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.18);
        }

        .status-dot--checking {
            background: var(--warning);
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.18);
        }

        .session-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .meta-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted-accent);
        }

        .meta-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-strong);
            word-break: break-word;
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 24px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 22px 24px;
            background: var(--surface-subtle);
            border-radius: 22px;
            border: 1px solid var(--border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.08);
        }

        .stat-card__icon {
            width: 52px;
            height: 52px;
            border-radius: 18px;
            display: grid;
            place-items: center;
            background: rgba(37, 99, 235, 0.08);
            color: var(--primary);
        }

        .stat-card__icon svg {
            width: 26px;
            height: 26px;
        }

        .stat-card__meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .stat-card__value {
            font-size: 30px;
            font-weight: 700;
            color: var(--text-strong);
        }

        .stat-card__label {
            font-size: 14px;
            color: var(--text-muted);
        }

        .feature-section h2 {
            margin: 0 0 20px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-strong);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
        }

        .feature-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
            padding: 22px 24px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--surface-subtle);
            text-align: left;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .feature-card:hover,
        .feature-card:focus-visible {
            transform: translateY(-3px);
            border-color: rgba(37, 99, 235, 0.4);
            box-shadow: 0 18px 30px rgba(37, 99, 235, 0.12);
            outline: none;
        }

        .feature-card:active {
            transform: translateY(0);
        }

        .feature-card button {
            border: none;
            background: none;
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: rgba(37, 99, 235, 0.12);
            color: var(--primary);
            display: grid;
            place-items: center;
        }

        .feature-icon svg {
            width: 26px;
            height: 26px;
        }

        .feature-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-strong);
        }

        .feature-description {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-muted);
        }

        .action-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .action-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 22px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--surface-subtle);
            color: var(--text-strong);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .action-button svg {
            width: 22px;
            height: 22px;
        }

        .action-button:hover,
        .action-button:focus-visible {
            transform: translateY(-2px);
            border-color: rgba(37, 99, 235, 0.35);
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.12);
            outline: none;
        }

        .action-button--primary {
            background: linear-gradient(135deg, #2563eb 0%, #4338ca 100%);
            color: #ffffff;
            border: none;
        }

        .action-button--danger {
            background: #fee2e2;
            color: #b91c1c;
            border-color: #fecaca;
        }

        .action-button--danger:hover,
        .action-button--danger:focus-visible {
            box-shadow: 0 18px 30px rgba(248, 113, 113, 0.25);
        }

        .loading-layer {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.38);
            backdrop-filter: blur(2px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .loading-layer.active {
            display: flex;
        }

        .loading-panel {
            background: var(--surface);
            border-radius: 18px;
            padding: 28px 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            border: 1px solid var(--border);
        }

        .loading-spinner {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 3px solid rgba(37, 99, 235, 0.15);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        .loading-panel p {
            margin: 0;
            font-size: 14px;
            color: var(--text-muted);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .snackbar {
            display: none;
            position: fixed;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%) translateY(12px);
            padding: 16px 20px;
            border-radius: 18px;
            color: #ffffff;
            background: rgba(15, 23, 42, 0.9);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.28);
            z-index: 60;
            min-width: 280px;
            max-width: 420px;
            display: flex;
            align-items: center;
            gap: 14px;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .snackbar.show {
            display: flex;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .snackbar--success {
            background: rgba(22, 163, 74, 0.92);
        }

        .snackbar--error {
            background: rgba(239, 68, 68, 0.92);
        }

        .snackbar--warning {
            background: rgba(249, 115, 22, 0.95);
        }

        .snackbar--info {
            background: rgba(14, 165, 233, 0.95);
        }

        .snackbar-icon svg {
            width: 24px;
            height: 24px;
        }

        .snackbar-dismiss {
            margin-left: auto;
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            display: grid;
            place-items: center;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            transition: background 0.2s ease;
        }

        .snackbar-dismiss:hover,
        .snackbar-dismiss:focus-visible {
            background: rgba(255, 255, 255, 0.18);
            outline: none;
        }

        @media (max-width: 960px) {
            body {
                padding: 32px 16px;
            }

            .dashboard-shell {
                padding: 32px 24px;
                border-radius: 22px;
            }

            .app-header {
                flex-direction: column;
                align-items: stretch;
            }

            .user-summary {
                align-self: flex-start;
            }

            .stat-card {
                padding: 20px;
            }
        }

        @media (max-width: 640px) {
            .dashboard-shell {
                padding: 26px 20px;
            }

            .feature-grid,
            .stat-cards {
                grid-template-columns: 1fr;
            }

            .action-toolbar {
                flex-direction: column;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-shell">
        <header class="app-header">
            <div class="title-group">
                <span class="app-badge">Scenario Authenticator</span>
                <h1>Authentication Control Center</h1>
                <p>Monitor credential health, verify sessions, and keep your access layer resilient.</p>
            </div>
            <div class="user-summary">
                <div class="user-summary__meta">
                    <span class="user-summary__name" id="userEmail">Loading...</span>
                    <span class="user-summary__roles" id="userRole">...</span>
                </div>
                <div class="user-summary__avatar" id="userAvatar">?</div>
            </div>
        </header>

        <section class="session-panel" aria-labelledby="session-heading">
            <div class="session-panel__status" id="sessionStatus">
                <span class="status-dot status-dot--checking" id="sessionStatusDot" aria-hidden="true"></span>
                <span id="sessionStatusText">Validating session</span>
            </div>
            <div class="session-meta" role="list" id="sessionMetadata">
                <div class="meta-item" role="listitem">
                    <span class="meta-label">Login Time</span>
                    <span class="meta-value" id="loginTime">Just now</span>
                </div>
                <div class="meta-item" role="listitem">
                    <span class="meta-label">Session Identifier</span>
                    <span class="meta-value" id="sessionId">Loading...</span>
                </div>
                <div class="meta-item" role="listitem">
                    <span class="meta-label">Token Expiry</span>
                    <span class="meta-value" id="tokenExpiry">Loading...</span>
                </div>
            </div>
        </section>

        <section class="stat-cards" aria-label="Session metrics">
            <article class="stat-card">
                <div class="stat-card__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <polyline points="10 17 15 12 10 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <line x1="15" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-card__meta">
                    <span class="stat-card__value" id="loginCount">1</span>
                    <span class="stat-card__label">Total Logins</span>
                </div>
            </article>
            <article class="stat-card">
                <div class="stat-card__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <line x1="8" y1="21" x2="16" y2="21" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <line x1="12" y1="17" x2="12" y2="21" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-card__meta">
                    <span class="stat-card__value" id="activeSessions">1</span>
                    <span class="stat-card__label">Active Sessions</span>
                </div>
            </article>
            <article class="stat-card">
                <div class="stat-card__icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-card__meta">
                    <span class="stat-card__value" id="securityScore">100%</span>
                    <span class="stat-card__label">Security Score</span>
                </div>
            </article>
        </section>

        <section class="feature-section" aria-label="Security tools">
            <h2>Security Tools</h2>
            <div class="feature-grid">
                <button class="feature-card" type="button" onclick="window.testTokenValidation()">
                    <span class="feature-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                    <span class="feature-title">Validate Token</span>
                    <span class="feature-description">Verify the integrity of the active access token before performing high-trust actions.</span>
                </button>

                <button class="feature-card" type="button" onclick="window.refreshToken()">
                    <span class="feature-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M3 3v5h5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M16 16h5v5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                    <span class="feature-title">Refresh Credentials</span>
                    <span class="feature-description">Issue a new access token using the stored refresh token to extend the session securely.</span>
                </button>

                <button class="feature-card" type="button" onclick="window.viewProfile()">
                    <span class="feature-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="18" cy="15" r="3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M10 15H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m21.7 16.4-.9-.3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m15.2 13.9-.9-.3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m16.6 18.7.3-.9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m19.1 12.2.3-.9" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m19.6 18.7-.4-1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m16.8 12.3-.4-1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m14.3 16.6 1-.4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m20.7 13.8 1-.4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                    <span class="feature-title">Manage Profile</span>
                    <span class="feature-description">Review identity attributes and manage role assignments for the current principal.</span>
                </button>
            </div>
        </section>

        <section class="action-toolbar" aria-label="Primary actions">
            <button class="action-button action-button--primary" type="button" onclick="window.viewApiDocs()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M14 2v4a2 2 0 0 0 2 2h4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M10 9H8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 13H8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 17H8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                API Documentation
            </button>
            <button class="action-button" type="button" onclick="window.viewAuditLogs()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M15 12h-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M15 8h-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M19 17V5a2 2 0 0 0-2-2H4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Audit Logs
            </button>
            <button class="action-button action-button--danger" type="button" onclick="window.logout()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <polyline points="16 17 21 12 16 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                    <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Sign Out
            </button>
        </section>
    </div>

    <div class="loading-layer" id="loading" role="alert" aria-live="assertive" aria-busy="true">
        <div class="loading-panel">
            <div class="loading-spinner" aria-hidden="true"></div>
            <p>Processing request...</p>
        </div>
    </div>

    <div id="snackbar" class="snackbar" role="status" aria-live="polite">
        <span class="snackbar-icon" id="snackbar-icon" aria-hidden="true"></span>
        <span id="snackbar-message"></span>
        <button class="snackbar-dismiss" type="button" aria-label="Dismiss notification" onclick="window.hideSnackbar()">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6 6 18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                <path d="m6 6 12 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>
    </div>

    <script>
        (function () {
            'use strict';

            let authData;
            try {
                authData = JSON.parse(localStorage.getItem('authData') || sessionStorage.getItem('authData') || '{}');
            } catch (error) {
                console.warn('Unable to parse stored auth data', error);
                authData = {};
            }

            const token = authData.token || localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            const refreshTokenValue = authData.refreshToken || localStorage.getItem('refreshToken') || sessionStorage.getItem('refreshToken');
            let API_URL = '';

            const snackbar = document.getElementById('snackbar');
            const snackbarIcon = document.getElementById('snackbar-icon');
            const snackbarMessage = document.getElementById('snackbar-message');
            let snackbarTimer;

            const SNACKBAR_ICONS = {
                success: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="m9 12 2 2 4-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>',
                error: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="m15 9-6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="m9 9 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>',
                warning: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 9v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 17h.01" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>',
                info: '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 16v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /><path d="M12 8h.01" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>'
            };

            function formatDateFromValue(value) {
                if (!value) {
                    return new Date().toLocaleString();
                }

                if (typeof value === 'number' || !Number.isNaN(Number(value))) {
                    const numericValue = Number(value);
                    if (numericValue > 1e12) {
                        return new Date(numericValue).toLocaleString();
                    }
                    if (numericValue > 1e9) {
                        return new Date(numericValue * 1000).toLocaleString();
                    }
                }

                const parsed = new Date(value);
                if (!Number.isNaN(parsed.getTime())) {
                    return parsed.toLocaleString();
                }

                return new Date().toLocaleString();
            }

            function updateStatsFromPayload(payload) {
                if (!payload || typeof payload !== 'object') {
                    return;
                }

                if (typeof payload.loginCount === 'number') {
                    document.getElementById('loginCount').textContent = payload.loginCount.toString();
                }

                if (typeof payload.activeSessions === 'number') {
                    document.getElementById('activeSessions').textContent = payload.activeSessions.toString();
                }

                if (payload.securityScore !== undefined && payload.securityScore !== null) {
                    const value = typeof payload.securityScore === 'number' ? Math.round(payload.securityScore * 100) / 100 : payload.securityScore;
                    document.getElementById('securityScore').textContent = value.toString().endsWith('%') ? value : `${value}`;
                }
            }

            function setSessionStatus(state, label) {
                const dot = document.getElementById('sessionStatusDot');
                const text = document.getElementById('sessionStatusText');
                if (dot) {
                    dot.className = `status-dot status-dot--${state}`;
                }
                if (text && label) {
                    text.textContent = label;
                }
            }

            function showSnackbar(message, type = 'info') {
                if (!snackbar) return;

                const resolvedType = SNACKBAR_ICONS[type] ? type : 'info';
                snackbarIcon.innerHTML = SNACKBAR_ICONS[resolvedType];
                snackbarMessage.textContent = message;

                snackbar.classList.remove('snackbar--success', 'snackbar--error', 'snackbar--warning', 'snackbar--info');
                snackbar.classList.add(`snackbar--${resolvedType}`);
                snackbar.classList.add('show');

                if (snackbarTimer) {
                    clearTimeout(snackbarTimer);
                }
                snackbarTimer = window.setTimeout(hideSnackbar, 6000);
            }

            function hideSnackbar() {
                if (!snackbar) return;
                snackbar.classList.remove('show');
                if (snackbarTimer) {
                    clearTimeout(snackbarTimer);
                    snackbarTimer = undefined;
                }
            }

            window.hideSnackbar = hideSnackbar;

            function showLoading(show) {
                const loadingLayer = document.getElementById('loading');
                if (!loadingLayer) return;
                if (show) {
                    loadingLayer.classList.add('active');
                } else {
                    loadingLayer.classList.remove('active');
                }
            }

            function displayUserData(user) {
                const emailElement = document.getElementById('userEmail');
                const roleElement = document.getElementById('userRole');
                const avatarElement = document.getElementById('userAvatar');

                const email = user && user.email ? user.email : 'Unknown user';
                const roles = user && Array.isArray(user.roles) && user.roles.length ? user.roles.join(', ') : 'User';

                if (emailElement) emailElement.textContent = email;
                if (roleElement) roleElement.textContent = roles;

                if (avatarElement) {
                    const initial = email ? email.charAt(0).toUpperCase() : '?';
                    avatarElement.textContent = initial;
                }

                const sessionSpan = document.getElementById('sessionId');
                if (sessionSpan && authData.sessionId) {
                    sessionSpan.textContent = `${authData.sessionId.substring(0, 8)}...`;
                }

                const loginTimeElement = document.getElementById('loginTime');
                if (loginTimeElement) {
                    const loginTime = user && (user.loginTime || user.lastLoginAt || user.last_login_at || user.loggedInAt);
                    loginTimeElement.textContent = formatDateFromValue(loginTime);
                }

                const expiryElement = document.getElementById('tokenExpiry');
                if (expiryElement && token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        if (payload && payload.exp) {
                            const expiryDate = new Date(payload.exp * 1000);
                            expiryElement.textContent = expiryDate.toLocaleString();
                        } else {
                            expiryElement.textContent = 'Unknown';
                        }
                    } catch (error) {
                        expiryElement.textContent = 'Unknown';
                    }
                }

                setSessionStatus('active', 'Session active');
            }

            async function validateCurrentToken() {
                if (!token) {
                    showSnackbar('No active authentication token. Redirecting to login.', 'error');
                    setSessionStatus('inactive', 'Session inactive');
                    window.setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }

                setSessionStatus('checking', 'Validating session');

                try {
                    const response = await fetch(`${API_URL}/api/v1/auth/validate`, {
                        method: 'GET',
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (data.valid) {
                        const userDetails = {
                            email: data.email || (data.user && data.user.email) || (authData.user && authData.user.email),
                            roles: data.roles || (data.user && data.user.roles) || (authData.user && authData.user.roles),
                            loginTime: data.loginTime || (data.user && data.user.loginTime),
                            lastLoginAt: data.lastLoginAt || (data.user && data.user.lastLoginAt),
                            loggedInAt: data.loggedInAt || (data.user && data.user.loggedInAt),
                        };

                        displayUserData(userDetails);
                        updateStatsFromPayload(data.metrics || data);
                        setSessionStatus('active', 'Session active');
                    } else {
                        setSessionStatus('inactive', 'Session inactive');
                        showSnackbar('Session expired. Please log in again.', 'error');
                        window.setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Token validation failed:', error);
                    setSessionStatus('inactive', 'Validation unavailable');
                    showSnackbar('Unable to validate session at this time.', 'error');
                }
            }

            async function init() {
                try {
                    const configResponse = await fetch('/config');
                    const config = await configResponse.json();
                    API_URL = config.apiUrl;

                    if (authData.user) {
                        displayUserData(authData.user);
                        updateStatsFromPayload(authData.metrics || authData.user);
                    } else if (token) {
                        await validateCurrentToken();
                    } else {
                        window.location.href = '/';
                    }
                } catch (error) {
                    console.error('Failed to initialize dashboard:', error);
                    showSnackbar('Failed to load configuration.', 'error');
                    setSessionStatus('inactive', 'Configuration unavailable');
                }
            }

            async function testTokenValidation() {
                if (!token) {
                    showSnackbar('No authentication token available.', 'error');
                    return;
                }

                showLoading(true);
                try {
                    const response = await fetch(`${API_URL}/api/v1/auth/validate`, {
                        method: 'GET',
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (data.valid) {
                        showSnackbar('Token validated successfully.', 'success');
                        updateStatsFromPayload(data.metrics || data);
                        setSessionStatus('active', 'Session active');
                    } else {
                        setSessionStatus('inactive', 'Session inactive');
                        showSnackbar('Token is invalid or has expired.', 'error');
                    }
                } catch (error) {
                    console.error('Token validation check failed:', error);
                    showSnackbar('Unable to validate token right now.', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function refreshToken() {
                if (!refreshTokenValue) {
                    showSnackbar('No refresh token found for this session.', 'error');
                    return;
                }

                showLoading(true);
                try {
                    const response = await fetch(`${API_URL}/api/v1/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            refresh_token: refreshTokenValue,
                        }),
                    });

                    const data = await response.json();

                    if (data.success) {
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('refreshToken', data.refresh_token);

                        const newAuthData = {
                            ...authData,
                            token: data.token,
                            refreshToken: data.refresh_token,
                            user: data.user || authData.user,
                            metrics: data.metrics || authData.metrics,
                        };

                        localStorage.setItem('authData', JSON.stringify(newAuthData));
                        authData = newAuthData;

                        showSnackbar('Access token refreshed successfully.', 'success');
                        setSessionStatus('active', 'Session active');
                        window.setTimeout(() => window.location.reload(), 1400);
                    } else {
                        showSnackbar('Unable to refresh token. Please log in again.', 'error');
                    }
                } catch (error) {
                    console.error('Token refresh failed:', error);
                    showSnackbar('Refresh request failed.', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function logout() {
                const confirmed = window.confirm('Are you sure you want to sign out?');
                if (!confirmed) return;

                showLoading(true);
                try {
                    await fetch(`${API_URL}/api/v1/auth/logout`, {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        },
                    });
                } catch (error) {
                    console.warn('Logout request failed, clearing local credentials anyway.', error);
                } finally {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('authData');
                    sessionStorage.removeItem('authToken');
                    sessionStorage.removeItem('refreshToken');
                    sessionStorage.removeItem('authData');
                    setSessionStatus('inactive', 'Session ended');
                    showSnackbar('You have been signed out.', 'info');
                    window.setTimeout(() => {
                        window.location.href = '/';
                    }, 1200);
                    showLoading(false);
                }
            }

            function viewProfile() {
                showSnackbar('Profile management is coming soon.', 'warning');
            }

            function viewApiDocs() {
                showSnackbar('API documentation publishing is in progress.', 'info');
            }

            function viewAuditLogs() {
                showSnackbar('Audit log viewer is under development.', 'info');
            }

            window.testTokenValidation = testTokenValidation;
            window.refreshToken = refreshToken;
            window.logout = logout;
            window.viewProfile = viewProfile;
            window.viewApiDocs = viewApiDocs;
            window.viewAuditLogs = viewAuditLogs;

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    hideSnackbar();
                }
            });

            init();
        })();
    </script>
</body>
</html>
