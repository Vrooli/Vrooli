{
  "name": "Password Reset Handler",
  "description": "Handles password reset requests with email verification and secure token generation",
  "version": "1.0.0",
  "category": "Authentication",
  "tags": ["password-reset", "email", "security", "authentication"],
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "password-reset",
        "options": {
          "rawBody": true
        }
      },
      "id": "webhook-reset",
      "name": "Webhook - Password Reset",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [300, 200]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [300, 340]
    },
    {
      "parameters": {
        "jsCode": "// Extract and validate email from request\nconst email = $input.all()?.[0]?.body?.email || $input.all()?.[0]?.json?.email;\n\nif (!email) {\n  return {\n    json: {\n      success: false,\n      error: 'Email address is required',\n      code: 'MISSING_EMAIL'\n    }\n  };\n}\n\n// Basic email validation\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(email)) {\n  return {\n    json: {\n      success: false,\n      error: 'Invalid email format',\n      code: 'INVALID_EMAIL'\n    }\n  };\n}\n\nreturn {\n  json: {\n    email: email.toLowerCase(),\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "validate-email",
      "name": "Validate Email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 270]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.email }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            }
          ]
        },
        "combineOperation": "all"
      },
      "id": "is-valid-email",
      "name": "Is Valid Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [700, 270]
    },
    {
      "parameters": {
        "url": "http://localhost:{{ $vars.service.ports.auth_api || '3250' }}/api/v1/users/search",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $json.email }}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "check-user-exists",
      "name": "Check User Exists",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 200]
    },
    {
      "parameters": {
        "jsCode": "// Generate secure reset token and expiry\nconst crypto = require('crypto');\n\nconst resetToken = crypto.randomBytes(32).toString('hex');\nconst expiresAt = new Date(Date.now() + 3600000); // 1 hour from now\n\nreturn {\n  json: {\n    email: $input.all()[0].json.email,\n    user_id: $input.all()[0].json.user?.id || null,\n    reset_token: resetToken,\n    expires_at: expiresAt.toISOString(),\n    reset_link: `http://localhost:3251/reset-password?token=${resetToken}&email=${encodeURIComponent($input.all()[0].json.email)}`\n  }\n};"
      },
      "id": "generate-reset-token",
      "name": "Generate Reset Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "url": "http://localhost:{{ $vars.service.ports.auth_api || '3250' }}/api/v1/users/{{ $json.user_id }}/reset-token",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "reset_token",
              "value": "={{ $json.reset_token }}"
            },
            {
              "name": "expires_at",
              "value": "={{ $json.expires_at }}"
            }
          ]
        },
        "options": {
          "timeout": 5000\n        }\n      },\n      \"id\": \"store-reset-token\",\n      \"name\": \"Store Reset Token\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.1,\n      \"position\": [1300, 200]\n    },\n    {\n      \"parameters\": {\n        \"url\": \"http://localhost:{{ $vars.service.ports.mailpit || '1025' }}/api/v1/send\",\n        \"sendBody\": true,\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"to\",\n              \"value\": \"={{ $json.email }}\"\n            },\n            {\n              \"name\": \"subject\",\n              \"value\": \"Reset Your Vrooli Password\"\n            },\n            {\n              \"name\": \"html\",\n              \"value\": \"<html><body><h2>Password Reset Request</h2><p>You requested a password reset for your Vrooli account.</p><p>Click the link below to reset your password:</p><p><a href='{{ $json.reset_link }}' style='background: #4F46E5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;'>Reset Password</a></p><p>This link will expire in 1 hour.</p><p>If you didn't request this reset, you can safely ignore this email.</p></body></html>\"\n            }\n          ]\n        },\n        \"options\": {\n          \"timeout\": 10000\n        }\n      },\n      \"id\": \"send-reset-email\",\n      \"name\": \"Send Reset Email\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.1,\n      \"position\": [1500, 200]\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Log password reset attempt (even for non-existent emails for security)\\nconst email = $input.all()?.[0]?.json?.email;\\n\\nreturn {\\n  json: {\\n    success: true,\\n    message: 'If an account with that email exists, a password reset link has been sent.',\\n    email_attempted: email,\\n    timestamp: new Date().toISOString()\\n  }\\n};\"\n      },\n      \"id\": \"success-response\",\n      \"name\": \"Success Response\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [1700, 200]\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Always return success for security (don't reveal if email exists)\\n// But don't actually send email for non-existent accounts\\n\\nconst email = $input.all()?.[0]?.json?.email;\\n\\nreturn {\\n  json: {\\n    success: true,\\n    message: 'If an account with that email exists, a password reset link has been sent.',\\n    email_attempted: email,\\n    user_found: false,\\n    timestamp: new Date().toISOString()\\n  }\\n};\"\n      },\n      \"id\": \"no-user-response\",\n      \"name\": \"No User Response\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [1100, 340]\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Return validation error\\nconst error = $input.all()?.[0]?.json;\\n\\nreturn {\\n  json: {\\n    success: false,\\n    error: error?.error || 'Invalid request',\\n    code: error?.code || 'VALIDATION_ERROR'\\n  }\\n};\"\n      },\n      \"id\": \"validation-error\",\n      \"name\": \"Validation Error\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [900, 340]\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Handle email service errors gracefully\\nconst error = $input.all()?.[0]?.error;\\n\\nreturn {\\n  json: {\\n    success: false,\\n    error: 'Email service temporarily unavailable. Please try again later.',\\n    code: 'EMAIL_SERVICE_ERROR',\\n    details: error?.message || 'Connection failed'\\n  }\\n};\"\n      },\n      \"id\": \"email-error\",\n      \"name\": \"Email Service Error\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [1500, 340]\n    }\n  ],\n  \"connections\": {\n    \"Webhook - Password Reset\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Validate Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Manual Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Validate Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Validate Email\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Is Valid Email?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Is Valid Email?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Check User Exists\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Validation Error\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Check User Exists\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Generate Reset Token\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ],\n      \"error\": [\n        [\n          {\n            \"node\": \"No User Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Generate Reset Token\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Store Reset Token\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Store Reset Token\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Send Reset Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Send Reset Email\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Success Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ],\n      \"error\": [\n        [\n          {\n            \"node\": \"Email Error\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"pinData\": {},\n  \"settings\": {\n    \"executionOrder\": \"v1\",\n    \"saveManualExecutions\": false,\n    \"callerPolicy\": \"workflowsFromSameOwner\"\n  },\n  \"staticData\": {},\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true,\n    \"instanceId\": \"scenario-authenticator\"\n  },\n  \"documentation\": {\n    \"usage\": \"Handles secure password reset requests with email verification\",\n    \"security_features\": [\n      \"Secure token generation\",\n      \"Time-limited reset links (1 hour)\",\n      \"No user enumeration (same response for existing/non-existing emails)\",\n      \"Secure token storage in database\"\n    ],\n    \"integration\": \"Can be used by any scenario that needs password reset functionality\"\n  }\n}"
      },
      "id": "store-reset-token",
      "name": "Store Reset Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "url": "http://localhost:{{ $vars.service.ports.mailpit || '1025' }}/api/v1/send",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{ $json.email }}"
            },
            {
              "name": "subject",
              "value": "Reset Your Vrooli Password"
            },
            {
              "name": "html",
              "value": "<html><body><h2>Password Reset Request</h2><p>You requested a password reset for your Vrooli account.</p><p>Click the link below to reset your password:</p><p><a href='{{ $json.reset_link }}' style='background: #4F46E5; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;'>Reset Password</a></p><p>This link will expire in 1 hour.</p><p>If you didn't request this reset, you can safely ignore this email.</p></body></html>"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "send-reset-email",
      "name": "Send Reset Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "jsCode": "// Log password reset attempt (even for non-existent emails for security)\nconst email = $input.all()?.[0]?.json?.email;\n\nreturn {\n  json: {\n    success: true,\n    message: 'If an account with that email exists, a password reset link has been sent.',\n    email_attempted: email,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 200]
    },
    {
      "parameters": {
        "jsCode": "// Always return success for security (don't reveal if email exists)\n// But don't actually send email for non-existent accounts\n\nconst email = $input.all()?.[0]?.json?.email;\n\nreturn {\n  json: {\n    success: true,\n    message: 'If an account with that email exists, a password reset link has been sent.',\n    email_attempted: email,\n    user_found: false,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "no-user-response",
      "name": "No User Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 340]
    },
    {
      "parameters": {
        "jsCode": "// Return validation error\nconst error = $input.all()?.[0]?.json;\n\nreturn {\n  json: {\n    success: false,\n    error: error?.error || 'Invalid request',\n    code: error?.code || 'VALIDATION_ERROR'\n  }\n};"
      },
      "id": "validation-error",
      "name": "Validation Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 340]
    },
    {
      "parameters": {
        "jsCode": "// Handle email service errors gracefully\nconst error = $input.all()?.[0]?.error;\n\nreturn {\n  json: {\n    success: false,\n    error: 'Email service temporarily unavailable. Please try again later.',\n    code: 'EMAIL_SERVICE_ERROR',\n    details: error?.message || 'Connection failed'\n  }\n};"
      },
      "id": "email-error",
      "name": "Email Service Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 340]
    }
  ],
  "connections": {
    "Webhook - Password Reset": {
      "main": [
        [
          {
            "node": "Validate Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Validate Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Email": {
      "main": [
        [
          {
            "node": "Is Valid Email?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Valid Email?": {
      "main": [
        [
          {
            "node": "Check User Exists",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User Exists": {
      "main": [
        [
          {
            "node": "Generate Reset Token",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "No User Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Reset Token": {
      "main": [
        [
          {
            "node": "Store Reset Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Reset Token": {
      "main": [
        [
          {
            "node": "Send Reset Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reset Email": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Email Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": false,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "scenario-authenticator"
  },
  "documentation": {
    "usage": "Handles secure password reset requests with email verification",
    "security_features": [
      "Secure token generation",
      "Time-limited reset links (1 hour)",
      "No user enumeration (same response for existing/non-existing emails)",
      "Secure token storage in database"
    ],
    "integration": "Can be used by any scenario that needs password reset functionality"
  }
}