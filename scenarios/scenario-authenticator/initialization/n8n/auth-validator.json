{
  "name": "Auth Validator",
  "description": "Shared workflow for validating JWT tokens in any Vrooli scenario. Provides authentication middleware for n8n workflows.",
  "version": "1.0.0",
  "category": "Authentication",
  "tags": ["authentication", "jwt", "security", "validation", "shared"],
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "auth-validate",
        "options": {
          "rawBody": true
        }
      },
      "id": "webhook-auth-validate",
      "name": "Webhook - Auth Validate",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [300, 200]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [300, 340]
    },
    {
      "parameters": {
        "jsCode": "// Extract token from Authorization header or request body\nlet token = '';\n\n// Check Authorization header first\nif ($input.all()?.[0]?.headers?.authorization) {\n  const authHeader = $input.all()[0].headers.authorization;\n  token = authHeader.replace('Bearer ', '');\n} \n// Fallback to request body\nelse if ($input.all()?.[0]?.body?.token) {\n  token = $input.all()[0].body.token;\n}\n// For manual testing\nelse if ($input.all()?.[0]?.json?.token) {\n  token = $input.all()[0].json.token;\n}\n\nif (!token) {\n  return {\n    json: {\n      valid: false,\n      error: 'No token provided',\n      code: 'MISSING_TOKEN'\n    }\n  };\n}\n\n// Return the extracted token for validation\nreturn {\n  json: {\n    token: token,\n    extracted_from: $input.all()?.[0]?.headers?.authorization ? 'header' : 'body'\n  }\n};"
      },
      "id": "extract-token",
      "name": "Extract Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 270]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.token }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ]
        },
        "combineOperation": "all"
      },
      "id": "has-token",
      "name": "Has Token?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [700, 270]
    },
    {
      "parameters": {
        "url": "http://localhost:{{ $vars.service.ports.auth_api || '3250' }}/api/v1/auth/validate",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "httpHeaderAuth": "authToken",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.token }}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "validate-token",
      "name": "Validate Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 200]
    },
    {
      "parameters": {
        "jsCode": "// Process validation response from auth service\nconst response = $input.all()?.[0]?.json;\n\nif (!response) {\n  return {\n    json: {\n      valid: false,\n      error: 'No response from auth service',\n      code: 'AUTH_SERVICE_ERROR'\n    }\n  };\n}\n\nif (response.valid) {\n  // Token is valid - return user info\n  return {\n    json: {\n      valid: true,\n      user_id: response.user_id,\n      email: response.email,\n      roles: response.roles || [],\n      expires_at: response.expires_at,\n      validated_at: new Date().toISOString()\n    }\n  };\n} else {\n  // Token is invalid\n  return {\n    json: {\n      valid: false,\n      error: 'Invalid or expired token',\n      code: 'INVALID_TOKEN'\n    }\n  };\n}"
      },
      "id": "process-response",
      "name": "Process Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "jsCode": "// Return error for missing token\nreturn {\n  json: {\n    valid: false,\n    error: 'No authentication token provided',\n    code: 'MISSING_TOKEN',\n    help: 'Include token in Authorization header as \"Bearer <token>\" or in request body as {\"token\": \"<token>\"}'\n  }\n};"
      },
      "id": "no-token-error",
      "name": "No Token Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 340]
    },
    {
      "parameters": {
        "jsCode": "// Handle authentication service errors\nconst error = $input.all()?.[0]?.error;\n\nreturn {\n  json: {\n    valid: false,\n    error: 'Authentication service unavailable',\n    code: 'AUTH_SERVICE_UNAVAILABLE',\n    details: error?.message || 'Connection failed'\n  }\n};"
      },
      "id": "auth-service-error",
      "name": "Auth Service Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 340]
    },
    {
      "parameters": {
        "jsCode": "// Merge all possible outputs into a consistent response format\nconst input = $input.all()?.[0]?.json;\n\n// Add standard response headers\nconst response = {\n  ...input,\n  timestamp: new Date().toISOString(),\n  service: 'scenario-authenticator',\n  workflow: 'auth-validator'\n};\n\n// Set HTTP status code based on validity\nif (input?.valid) {\n  response.http_status = 200;\n} else if (input?.code === 'MISSING_TOKEN') {\n  response.http_status = 401;\n} else if (input?.code === 'INVALID_TOKEN') {\n  response.http_status = 401;\n} else if (input?.code === 'AUTH_SERVICE_UNAVAILABLE') {\n  response.http_status = 503;\n} else {\n  response.http_status = 500;\n}\n\nreturn {\n  json: response\n};"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 270]
    }
  ],
  "connections": {
    "Webhook - Auth Validate": {
      "main": [
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Token": {
      "main": [
        [
          {
            "node": "Has Token?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Token?": {
      "main": [
        [
          {
            "node": "Validate Token",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Token Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Token": {
      "main": [
        [
          {
            "node": "Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Auth Service Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Response": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Token Error": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auth Service Error": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": false,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "scenario-authenticator"
  },
  "documentation": {
    "usage": "This workflow validates JWT tokens for any Vrooli scenario. Include it in your workflows to add authentication middleware.",
    "examples": [
      {
        "name": "API Endpoint Protection",
        "description": "Use as first node in API workflows to validate incoming requests",
        "usage": "webhook -> auth-validator -> your-business-logic"
      },
      {
        "name": "User Context",
        "description": "Get user information from valid tokens for personalization",
        "usage": "Access user_id, email, and roles from the validation response"
      }
    ],
    "integration_guide": "To use in your scenario: 1) Import this workflow, 2) Connect your webhook to this workflow, 3) Use the validation response to allow/deny access",
    "response_format": {
      "valid": "boolean - whether token is valid",
      "user_id": "string - user UUID (if valid)",
      "email": "string - user email (if valid)",
      "roles": "array - user roles (if valid)",
      "error": "string - error message (if invalid)",
      "code": "string - error code for programmatic handling"
    }
  }
}