#!/bin/bash

# Mass Update Tracker CLI
# Campaign-based mass file operation tracking

set -e

APP_ROOT="${APP_ROOT:-$(builtin cd "${BASH_SOURCE[0]%/*}/../../.." && builtin pwd)}"
SCRIPT_DIR="${APP_ROOT}/scenarios/mass-update-tracker/cli"
API_PORT="${API_PORT:-20251}"
API_URL="${API_URL:-http://localhost:${API_PORT}}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}ðŸ“Š Mass Update Tracker CLI${NC}"
    echo
    echo "Campaign-based tracking for mass file operations with persistent state"
    echo
    echo "Usage: mass-update-tracker [command] [options]"
    echo
    echo "Commands:"
    echo "  create <name> <patterns...>   Create new campaign with file patterns"
    echo "  list [--status active]        List campaigns (optionally filtered)"
    echo "  files <campaign-id>          List files in campaign"
    echo "  update-file <campaign-id> <file-path> <status>"
    echo "                               Update specific file status"
    echo "  status [--campaign-id id]    Show system status or campaign progress"
    echo "  help                         Show this help message"
    echo "  version                      Show version information"
    echo
    echo "File Status Values:"
    echo "  pending, in_progress, completed, failed, skipped"
    echo
    echo "Options:"
    echo "  --description 'text'         Campaign description"
    echo "  --working-dir 'path'         Base directory (default: current)"
    echo "  --scenario 'name'            Scenario using this campaign"
    echo "  --status 'status'            Filter by status"
    echo "  --pending                    Show only pending files"
    echo "  --failed                     Show only failed files"
    echo "  --error 'message'            Error message for failed status"
    echo "  --metadata '{}'"             JSON metadata to store"
    echo "  --json                       Output raw JSON"
    echo
    echo "Examples:"
    echo "  mass-update-tracker create 'migrate-to-ts' 'src/**/*.js' 'tests/**/*.js'"
    echo "  mass-update-tracker list --status active"
    echo "  mass-update-tracker files abc-123 --pending"
    echo "  mass-update-tracker update-file abc-123 src/main.js completed"
    echo "  mass-update-tracker status --campaign-id abc-123"
}

show_version() {
    echo "mass-update-tracker CLI v1.0.0"
    echo "API: ${API_URL}"
}

check_api() {
    if ! curl -s "${API_URL}/health" >/dev/null 2>&1; then
        echo -e "${RED}Error: API server not responding at ${API_URL}${NC}" >&2
        echo "Please ensure the mass-update-tracker API is running" >&2
        exit 1
    fi
}

create_campaign() {
    local name="$1"
    shift
    local patterns=("$@")
    
    if [[ -z "$name" ]] || [[ ${#patterns[@]} -eq 0 ]]; then
        echo -e "${RED}Error: Campaign name and at least one pattern required${NC}" >&2
        echo "Usage: mass-update-tracker create <name> <pattern1> [pattern2...]" >&2
        exit 1
    fi
    
    # Parse global options
    local description=""
    local working_dir="$(pwd)"
    local scenario=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --description)
                description="$2"
                shift 2
                ;;
            --working-dir)
                working_dir="$2"
                shift 2
                ;;
            --scenario)
                scenario="$2"
                shift 2
                ;;
            *)
                # If it doesn't start with --, treat as file pattern
                if [[ ! "$1" =~ ^-- ]]; then
                    patterns+=("$1")
                fi
                shift
                ;;
        esac
    done
    
    # Build JSON payload
    local patterns_json
    patterns_json=$(printf '%s\n' "${patterns[@]}" | jq -R . | jq -s .)
    
    local payload
    payload=$(jq -n \
        --arg name "$name" \
        --arg description "$description" \
        --argjson file_patterns "$patterns_json" \
        --arg working_directory "$working_dir" \
        --arg scenario_name "$scenario" \
        '{
            name: $name,
            description: $description,
            file_patterns: $file_patterns,
            working_directory: $working_directory,
            scenario_name: $scenario_name,
            metadata: {}
        }')
    
    check_api
    
    response=$(curl -s -X POST "${API_URL}/api/v1/campaigns" \
        -H "Content-Type: application/json" \
        -d "$payload")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        echo -e "${RED}Error creating campaign:${NC}" >&2
        echo "$response" | jq -r '.error' >&2
        exit 1
    fi
    
    local campaign_id file_count
    campaign_id=$(echo "$response" | jq -r '.id')
    file_count=$(echo "$response" | jq -r '.file_count')
    
    echo -e "${GREEN}âœ“ Campaign created successfully${NC}"
    echo "ID: $campaign_id"
    echo "Files tracked: $file_count"
    echo
    echo "Next steps:"
    echo "  mass-update-tracker files $campaign_id --pending"
    echo "  mass-update-tracker update-file $campaign_id <file> in_progress"
}

list_campaigns() {
    local status_filter=""
    local scenario_filter=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                status_filter="$2"
                shift 2
                ;;
            --scenario)
                scenario_filter="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    check_api
    
    local query_params=""
    [[ -n "$status_filter" ]] && query_params="?status=$status_filter"
    [[ -n "$scenario_filter" ]] && query_params="${query_params:+$query_params&}scenario=$scenario_filter"
    [[ -n "$query_params" && ! "$query_params" =~ ^\? ]] && query_params="?$query_params"
    
    response=$(curl -s "${API_URL}/api/v1/campaigns${query_params}")
    
    if [[ "$json_output" == true ]]; then
        echo "$response"
        return
    fi
    
    local count
    count=$(echo "$response" | jq -r '.campaigns | length')
    
    if [[ "$count" -eq 0 ]]; then
        echo -e "${YELLOW}No campaigns found${NC}"
        return
    fi
    
    echo -e "${CYAN}ðŸ“Š Mass Update Campaigns${NC}"
    echo
    
    echo "$response" | jq -r '.campaigns[] | 
        "ID: " + .id + 
        "\nName: " + .name + 
        "\nStatus: " + .status + 
        "\nFiles: " + (.file_patterns | join(", ")) + 
        "\nWorking Dir: " + .working_directory +
        (if .scenario_name and .scenario_name != "" then "\nScenario: " + .scenario_name else "" end) +
        "\nCreated: " + (.created_at | sub("\\.[0-9]+Z$"; "Z") | strptime("%Y-%m-%dT%H:%M:%SZ") | strftime("%Y-%m-%d %H:%M")) +
        "\n---"'
}

list_files() {
    local campaign_id="$1"
    shift
    
    if [[ -z "$campaign_id" ]]; then
        echo -e "${RED}Error: Campaign ID required${NC}" >&2
        echo "Usage: mass-update-tracker files <campaign-id> [options]" >&2
        exit 1
    fi
    
    local status_filter=""
    local json_output=false
    local pending_only=false
    local failed_only=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                status_filter="$2"
                shift 2
                ;;
            --pending)
                pending_only=true
                shift
                ;;
            --failed)
                failed_only=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Set status filter based on flags
    if [[ "$pending_only" == true ]]; then
        status_filter="pending"
    elif [[ "$failed_only" == true ]]; then
        status_filter="failed"
    fi
    
    check_api
    
    local query_params=""
    [[ -n "$status_filter" ]] && query_params="?status=$status_filter"
    
    response=$(curl -s "${API_URL}/api/v1/campaigns/${campaign_id}/files${query_params}")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        echo -e "${RED}Error:${NC}" >&2
        echo "$response" | jq -r '.error' >&2
        exit 1
    fi
    
    if [[ "$json_output" == true ]]; then
        echo "$response"
        return
    fi
    
    local total remaining
    total=$(echo "$response" | jq -r '.total')
    remaining=$(echo "$response" | jq -r '.remaining')
    
    echo -e "${CYAN}ðŸ“ Campaign Files${NC}"
    echo "Total: $total | Remaining: $remaining"
    echo
    
    echo "$response" | jq -r '.files[] | 
        .status as $status |
        (if $status == "pending" then "â³"
         elif $status == "in_progress" then "ðŸ”„" 
         elif $status == "completed" then "âœ…"
         elif $status == "failed" then "âŒ"
         elif $status == "skipped" then "â­ï¸"
         else "â“" end) + " " +
        .file_path + 
        " (" + $status + ")" +
        (if .error_message then " - " + .error_message else "" end)'
}

update_file_status() {
    local campaign_id="$1"
    local file_path="$2" 
    local status="$3"
    shift 3
    
    if [[ -z "$campaign_id" ]] || [[ -z "$file_path" ]] || [[ -z "$status" ]]; then
        echo -e "${RED}Error: Campaign ID, file path, and status required${NC}" >&2
        echo "Usage: mass-update-tracker update-file <campaign-id> <file-path> <status>" >&2
        exit 1
    fi
    
    local error_message=""
    local metadata="{}"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --error)
                error_message="$2"
                shift 2
                ;;
            --metadata)
                metadata="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Build JSON payload
    local payload
    payload=$(jq -n \
        --arg status "$status" \
        --arg error_message "$error_message" \
        --argjson metadata "$metadata" \
        '{
            status: $status,
            error_message: (if $error_message != "" then $error_message else null end),
            metadata: $metadata
        }')
    
    check_api
    
    # URL encode the file path
    local encoded_path
    encoded_path=$(echo "$file_path" | jq -rR @uri)
    
    response=$(curl -s -X PATCH "${API_URL}/api/v1/campaigns/${campaign_id}/files/by-path/${encoded_path}/status" \
        -H "Content-Type: application/json" \
        -d "$payload")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        echo -e "${RED}Error updating file:${NC}" >&2
        echo "$response" | jq -r '.error' >&2
        exit 1
    fi
    
    echo -e "${GREEN}âœ“ File status updated${NC}"
    echo "File: $file_path"
    echo "Status: $status"
    if [[ -n "$error_message" ]]; then
        echo "Error: $error_message"
    fi
}

show_status() {
    local campaign_id=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --campaign-id)
                campaign_id="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    check_api
    
    if [[ -n "$campaign_id" ]]; then
        # Show specific campaign status
        response=$(curl -s "${API_URL}/api/v1/campaigns/${campaign_id}/files")
        
        if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
            echo -e "${RED}Error:${NC}" >&2
            echo "$response" | jq -r '.error' >&2
            exit 1
        fi
        
        if [[ "$json_output" == true ]]; then
            echo "$response"
            return
        fi
        
        local total remaining
        total=$(echo "$response" | jq -r '.total')
        remaining=$(echo "$response" | jq -r '.remaining')
        
        echo -e "${CYAN}ðŸ“Š Campaign Progress${NC}"
        echo "Total Files: $total"
        echo "Remaining: $remaining"
        echo "Completed: $((total - remaining))"
        echo
        
        # Show status breakdown
        echo "Status Breakdown:"
        echo "$response" | jq -r '.files | group_by(.status) | .[] | 
            .[0].status + ": " + (length | tostring) + " files"' | while read line; do
            echo "  $line"
        done
    else
        # Show system status
        health_response=$(curl -s "${API_URL}/health")
        campaigns_response=$(curl -s "${API_URL}/api/v1/campaigns")
        
        if [[ "$json_output" == true ]]; then
            jq -n \
                --argjson health "$health_response" \
                --argjson campaigns "$campaigns_response" \
                '{health: $health, campaigns: $campaigns}'
            return
        fi
        
        echo -e "${CYAN}ðŸ“Š Mass Update Tracker Status${NC}"
        echo
        echo "API Status: $(echo "$health_response" | jq -r '.status')"
        echo "Version: $(echo "$health_response" | jq -r '.version')"
        echo
        
        local total_campaigns active_campaigns
        total_campaigns=$(echo "$campaigns_response" | jq -r '.total // 0')
        active_campaigns=$(echo "$campaigns_response" | jq -r '.campaigns | map(select(.status == "active")) | length')
        
        echo "Total Campaigns: $total_campaigns"
        echo "Active Campaigns: $active_campaigns"
        
        if [[ "$active_campaigns" -gt 0 ]]; then
            echo
            echo "Active Campaigns:"
            echo "$campaigns_response" | jq -r '.campaigns[] | 
                select(.status == "active") | 
                "  " + .name + " (" + .id + ") - " + (.file_patterns | join(", "))'
        fi
    fi
}

# Main command dispatch
case "${1:-help}" in
    create)
        shift
        name="$1"
        shift
        create_campaign "$name" "$@"
        ;;
    list)
        shift
        list_campaigns "$@"
        ;;
    files)
        shift
        list_files "$@"
        ;;
    update-file)
        shift
        update_file_status "$@"
        ;;
    status)
        shift
        show_status "$@"
        ;;
    version)
        show_version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}" >&2
        echo "Run 'mass-update-tracker help' for usage information" >&2
        exit 1
        ;;
esac