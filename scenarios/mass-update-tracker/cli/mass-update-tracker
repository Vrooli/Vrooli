#!/bin/bash

# Mass Update Tracker CLI
# Campaign-based mass file operation tracking

set -e

APP_ROOT="${APP_ROOT:-$(builtin cd "${BASH_SOURCE[0]%/*}/../../.." && builtin pwd)}"
SCRIPT_DIR="${APP_ROOT}/scenarios/mass-update-tracker/cli"
API_PORT="${API_PORT:-20251}"
API_URL="${API_URL:-http://localhost:${API_PORT}}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

show_help() {
    echo -e "${CYAN}ðŸ“Š Mass Update Tracker CLI${NC}"
    echo
    echo "Campaign-based tracking for mass file operations with persistent state"
    echo
    echo "Usage: mass-update-tracker [command] [options]"
    echo
    echo "Commands:"
    echo "  create NAME PATTERNS...      Create new campaign with file patterns"
    echo "  list [--status active]       List campaigns (optionally filtered)"
    echo "  files CAMPAIGN-ID            List files in campaign"
    echo "  update-file CAMPAIGN-ID FILE-PATH STATUS"
    echo "                               Update specific file status"
    echo "  status [--campaign-id ID]    Show system status or campaign progress"
    echo "  help                         Show this help message"
    echo "  version                      Show version information"
    echo
    echo "File Status Values:"
    echo "  pending, in_progress, completed, failed, skipped"
    echo
    echo "Examples:"
    echo "  mass-update-tracker create migrate-to-ts 'src/**/*.js' 'tests/**/*.js'"
    echo "  mass-update-tracker list --status active"
    echo "  mass-update-tracker files abc-123 --pending"
    echo "  mass-update-tracker update-file abc-123 src/main.js completed"
}

show_version() {
    echo "mass-update-tracker CLI v1.0.0"
    echo "API: ${API_URL}"
}

check_api() {
    if ! curl -s "${API_URL}/health" >/dev/null 2>&1; then
        echo -e "${RED}Error: API server not responding at ${API_URL}${NC}" >&2
        echo "Please ensure the mass-update-tracker API is running" >&2
        exit 1
    fi
}

create_campaign() {
    local name="$1"
    shift
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: Campaign name required${NC}" >&2
        echo "Usage: mass-update-tracker create NAME PATTERN1 [PATTERN2...]" >&2
        exit 1
    fi
    
    # Parse patterns and options
    local patterns=()
    local description=""
    local working_dir="$(pwd)"
    local scenario=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --description)
                description="$2"
                shift 2
                ;;
            --working-dir)
                working_dir="$2"
                shift 2
                ;;
            --scenario)
                scenario="$2"
                shift 2
                ;;
            *)
                patterns+=("$1")
                shift
                ;;
        esac
    done
    
    if [[ ${#patterns[@]} -eq 0 ]]; then
        echo -e "${RED}Error: At least one file pattern required${NC}" >&2
        exit 1
    fi
    
    # Build JSON payload
    local patterns_json
    patterns_json=$(printf '%s\n' "${patterns[@]}" | jq -R . | jq -s .)
    
    local payload
    payload=$(jq -n \
        --arg name "$name" \
        --arg description "$description" \
        --argjson file_patterns "$patterns_json" \
        --arg working_directory "$working_dir" \
        --arg scenario_name "$scenario" \
        '{
            name: $name,
            description: $description,
            file_patterns: $file_patterns,
            working_directory: $working_directory,
            scenario_name: $scenario_name,
            metadata: {}
        }')
    
    check_api
    
    response=$(curl -s -X POST "${API_URL}/api/v1/campaigns" \
        -H "Content-Type: application/json" \
        -d "$payload")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        echo -e "${RED}Error creating campaign:${NC}" >&2
        echo "$response" | jq -r '.error' >&2
        exit 1
    fi
    
    local campaign_id file_count
    campaign_id=$(echo "$response" | jq -r '.id')
    file_count=$(echo "$response" | jq -r '.file_count')
    
    echo -e "${GREEN}âœ“ Campaign created successfully${NC}"
    echo "ID: $campaign_id"
    echo "Files tracked: $file_count"
}

list_campaigns() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    check_api
    
    response=$(curl -s "${API_URL}/api/v1/campaigns")
    
    if [[ "$json_output" == true ]]; then
        echo "$response"
        return
    fi
    
    local count
    count=$(echo "$response" | jq -r '.campaigns | length')
    
    if [[ "$count" -eq 0 ]]; then
        echo -e "${YELLOW}No campaigns found${NC}"
        return
    fi
    
    echo -e "${CYAN}ðŸ“Š Mass Update Campaigns${NC}"
    echo
    
    # Simple output without complex jq
    echo "$response" | jq -r '.campaigns[] | "ID: " + .id + " | Name: " + .name + " | Status: " + .status'
}

list_files() {
    local campaign_id="$1"
    shift
    
    if [[ -z "$campaign_id" ]]; then
        echo -e "${RED}Error: Campaign ID required${NC}" >&2
        exit 1
    fi
    
    local json_output=false
    local status_filter=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --pending)
                status_filter="pending"
                shift
                ;;
            --failed)
                status_filter="failed"
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    check_api
    
    local query_params=""
    [[ -n "$status_filter" ]] && query_params="?status=$status_filter"
    
    response=$(curl -s "${API_URL}/api/v1/campaigns/${campaign_id}/files${query_params}")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        echo -e "${RED}Error:${NC}" >&2
        echo "$response" | jq -r '.error' >&2
        exit 1
    fi
    
    if [[ "$json_output" == true ]]; then
        echo "$response"
        return
    fi
    
    local total remaining
    total=$(echo "$response" | jq -r '.total')
    remaining=$(echo "$response" | jq -r '.remaining')
    
    echo -e "${CYAN}ðŸ“ Campaign Files${NC}"
    echo "Total: $total | Remaining: $remaining"
    echo
    
    # Simple file listing
    echo "$response" | jq -r '.files[] | .file_path + " [" + .status + "]"'
}

update_file_status() {
    local campaign_id="$1"
    local file_path="$2" 
    local status="$3"
    shift 3
    
    if [[ -z "$campaign_id" ]] || [[ -z "$file_path" ]] || [[ -z "$status" ]]; then
        echo -e "${RED}Error: Campaign ID, file path, and status required${NC}" >&2
        exit 1
    fi
    
    local error_message=""
    local metadata="{}"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --error)
                error_message="$2"
                shift 2
                ;;
            --metadata)
                metadata="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Build JSON payload
    local payload
    if [[ -n "$error_message" ]]; then
        payload=$(jq -n \
            --arg status "$status" \
            --arg error_message "$error_message" \
            --argjson metadata "$metadata" \
            '{
                status: $status,
                error_message: $error_message,
                metadata: $metadata
            }')
    else
        payload=$(jq -n \
            --arg status "$status" \
            --argjson metadata "$metadata" \
            '{
                status: $status,
                error_message: null,
                metadata: $metadata
            }')
    fi
    
    check_api
    
    # URL encode the file path
    local encoded_path
    encoded_path=$(echo "$file_path" | jq -rR @uri)
    
    response=$(curl -s -X PATCH "${API_URL}/api/v1/campaigns/${campaign_id}/files/by-path/${encoded_path}/status" \
        -H "Content-Type: application/json" \
        -d "$payload")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        echo -e "${RED}Error updating file:${NC}" >&2
        echo "$response" | jq -r '.error' >&2
        exit 1
    fi
    
    echo -e "${GREEN}âœ“ File status updated${NC}"
    echo "File: $file_path"
    echo "Status: $status"
}

show_status() {
    check_api
    
    health_response=$(curl -s "${API_URL}/health")
    campaigns_response=$(curl -s "${API_URL}/api/v1/campaigns")
    
    echo -e "${CYAN}ðŸ“Š Mass Update Tracker Status${NC}"
    echo
    echo "API Status: $(echo "$health_response" | jq -r '.status')"
    echo "Version: $(echo "$health_response" | jq -r '.version')"
    echo
    
    local total_campaigns
    total_campaigns=$(echo "$campaigns_response" | jq -r '.total // 0')
    echo "Total Campaigns: $total_campaigns"
}

# Main command dispatch
case "${1:-help}" in
    create)
        shift
        create_campaign "$@"
        ;;
    list)
        shift
        list_campaigns "$@"
        ;;
    files)
        shift
        list_files "$@"
        ;;
    update-file)
        shift
        update_file_status "$@"
        ;;
    status)
        shift
        show_status "$@"
        ;;
    version)
        show_version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}" >&2
        echo "Run 'mass-update-tracker help' for usage information" >&2
        exit 1
        ;;
esac