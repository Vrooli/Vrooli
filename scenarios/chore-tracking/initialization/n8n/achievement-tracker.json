{
  "name": "Achievement Tracker",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chore-tracker/check-achievements",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide defaults for manual testing\nreturn {\n  user_id: 'test-user-001',\n  event_type: 'chore_completed',\n  event_data: {\n    chore_id: 'chore-001',\n    completion_time: 12,\n    quality_rating: 5\n  }\n};"
      },
      "id": "set_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  u.*,\n  COUNT(DISTINCT ca.id) as total_chores_completed,\n  COUNT(DISTINCT DATE(ca.completed_at)) as unique_days,\n  COUNT(CASE WHEN ca.completed_at::TIME < '12:00:00' THEN 1 END) as morning_completions,\n  COUNT(CASE WHEN ca.completed_at::TIME > '20:00:00' THEN 1 END) as evening_completions,\n  COUNT(CASE WHEN ca.quality_rating = 5 THEN 1 END) as perfect_quality_count,\n  COUNT(CASE WHEN ca.completion_time < c.estimated_minutes THEN 1 END) as speed_completions,\n  MAX(ca.completed_at) as last_activity\nFROM users u\nLEFT JOIN chore_assignments ca ON u.id = ca.user_id AND ca.status = 'completed'\nLEFT JOIN chores c ON ca.chore_id = c.id\nWHERE u.id = $1\nGROUP BY u.id",
        "additionalFields": {
          "queryParams": "={{ $json.user_id }}"
        }
      },
      "id": "fetch_user_stats",
      "name": "Fetch User Stats",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [800, 400],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  at.*,\n  COALESCE(ua.awarded_at, NULL) as already_earned\nFROM achievement_types at\nLEFT JOIN user_achievements ua ON at.id = ua.achievement_type AND ua.user_id = $1\nWHERE at.is_active = true",
        "additionalFields": {
          "queryParams": "={{ $json.user_id }}"
        }
      },
      "id": "fetch_achievement_types",
      "name": "Fetch Achievement Types",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1000, 400],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const userStats = $('fetch_user_stats').item.json;\nconst achievementTypes = $('fetch_achievement_types').all().map(a => a.json);\nconst eventType = $('merge_triggers').item.json.event_type;\n\nconst newAchievements = [];\n\n// Check each achievement type\nachievementTypes.forEach(achievement => {\n  // Skip if already earned\n  if (achievement.already_earned) return;\n  \n  let earned = false;\n  \n  switch(achievement.requirement_type) {\n    case 'total_chores':\n      earned = userStats.total_chores_completed >= achievement.requirement_value;\n      break;\n      \n    case 'streak':\n      earned = userStats.current_streak >= achievement.requirement_value;\n      break;\n      \n    case 'level':\n      earned = userStats.current_level >= achievement.requirement_value;\n      break;\n      \n    case 'morning_completions':\n      earned = userStats.morning_completions >= achievement.requirement_value;\n      break;\n      \n    case 'evening_completions':\n      earned = userStats.evening_completions >= achievement.requirement_value;\n      break;\n      \n    case 'perfect_quality':\n      earned = userStats.perfect_quality_count >= achievement.requirement_value;\n      break;\n      \n    case 'speed_completions':\n      earned = userStats.speed_completions >= achievement.requirement_value;\n      break;\n      \n    case 'unique_days':\n      earned = userStats.unique_days >= achievement.requirement_value;\n      break;\n      \n    case 'category_complete':\n      // Special logic for category achievements\n      // Would need additional query to check if all chores in a category were completed\n      break;\n  }\n  \n  if (earned) {\n    newAchievements.push({\n      achievement_id: achievement.id,\n      name: achievement.name,\n      description: achievement.description,\n      icon_emoji: achievement.icon_emoji,\n      points_value: achievement.points_value,\n      rarity: determineRarity(achievement)\n    });\n  }\n});\n\nfunction determineRarity(achievement) {\n  // Determine rarity based on requirement value and type\n  if (achievement.requirement_value >= 100) return 'legendary';\n  if (achievement.requirement_value >= 50) return 'epic';\n  if (achievement.requirement_value >= 20) return 'rare';\n  return 'common';\n}\n\nreturn {\n  user_id: userStats.id,\n  new_achievements: newAchievements,\n  total_new: newAchievements.length,\n  total_points: newAchievements.reduce((sum, a) => sum + a.points_value, 0)\n};"
      },
      "id": "check_achievements",
      "name": "Check Achievements",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.total_new }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "has_new_achievements",
      "name": "Has New Achievements?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split_achievements",
      "name": "Split Achievements",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 2,
      "position": [1600, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO user_achievements (user_id, achievement_type, achievement_name, description, points_awarded, rarity)\nVALUES ($1, $2, $3, $4, $5, $6)\nON CONFLICT (user_id, achievement_type) DO NOTHING\nRETURNING *",
        "additionalFields": {
          "queryParams": "={{ $json.user_id }},{{ $json.achievement_id }},{{ $json.name }},{{ $json.description }},{{ $json.points_value }},{{ $json.rarity }}"
        }
      },
      "id": "save_achievement",
      "name": "Save Achievement",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1800, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users \nSET total_points = total_points + $1,\n    achievements_earned = achievements_earned + $2,\n    updated_at = CURRENT_TIMESTAMP\nWHERE id = $3\nRETURNING *",
        "additionalFields": {
          "queryParams": "={{ $json.total_points }},{{ $json.total_new }},{{ $json.user_id }}"
        }
      },
      "id": "update_user_achievements",
      "name": "Update User Achievements",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2000, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "={{ $json.total_new > 0 ? `Unlocked ${$json.total_new} new achievement(s)!` : 'No new achievements' }}"
            }
          ],
          "number": [
            {
              "name": "achievements_unlocked",
              "value": "={{ $json.total_new }}"
            },
            {
              "name": "points_earned",
              "value": "={{ $json.total_points }}"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare_response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [2200, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2400, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "set_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "fetch_user_stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_user_stats": {
      "main": [
        [
          {
            "node": "fetch_achievement_types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_achievement_types": {
      "main": [
        [
          {
            "node": "check_achievements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_achievements": {
      "main": [
        [
          {
            "node": "has_new_achievements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has_new_achievements": {
      "main": [
        [
          {
            "node": "split_achievements",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split_achievements": {
      "main": [
        [
          {
            "node": "save_achievement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save_achievement": {
      "main": [
        [
          {
            "node": "update_user_achievements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update_user_achievements": {
      "main": [
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_response": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "achievement-tracker",
  "tags": []
}