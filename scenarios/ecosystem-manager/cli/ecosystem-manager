#!/bin/bash

# Ecosystem Manager CLI
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
API_BASE_URL="${API_BASE_URL:-http://localhost:30500/api}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Helper functions
usage() {
    echo -e "${CYAN}Ecosystem Manager CLI${NC}"
    echo "Unified interface for managing resources and scenarios"
    echo ""
    echo "Usage: ecosystem-manager [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}add${NC}        Create new task (resource or scenario generation/improvement)"
    echo -e "  ${GREEN}list${NC}       List tasks with optional filters"
    echo -e "  ${GREEN}show${NC}       Show detailed task information"
    echo -e "  ${GREEN}status${NC}     Update task status and progress"
    echo -e "  ${GREEN}queue${NC}      Show queue overview"
    echo -e "  ${GREEN}operations${NC} List available operation types"
    echo -e "  ${GREEN}health${NC}     Check service health"
    echo -e "  ${GREEN}logs${NC}       View service logs"
    echo ""
    echo "Examples:"
    echo "  ecosystem-manager add resource matrix-synapse --category communication"
    echo "  ecosystem-manager improve scenario system-monitor --priority high"
    echo "  ecosystem-manager list --status pending --type resource"
    echo "  ecosystem-manager show <task-id>"
    echo "  ecosystem-manager status <task-id> --progress 50 --phase implementation"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help"
    echo "  --json           Output in JSON format"
    echo "  --verbose, -v    Verbose output"
    echo ""
    echo "For more information: ecosystem-manager <command> --help"
}

# Check if API is available
check_api() {
    if ! curl -s "$API_BASE_URL/../health" > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Error: Ecosystem Manager API is not running${NC}" >&2
        echo "   Start it with: vrooli scenario ecosystem-manager develop" >&2
        exit 1
    fi
}

# Format JSON output nicely
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Add task command
cmd_add() {
    local type=""
    local operation=""
    local name=""
    local category=""
    local priority="medium"
    local title=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            resource)
                type="resource"
                operation="generator"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    name="$1"
                    title="Generate $1 resource"
                    shift
                fi
                ;;
            scenario)
                type="scenario"
                operation="generator"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    name="$1"
                    title="Generate $1 scenario"
                    shift
                fi
                ;;
            --category)
                category="$2"
                shift 2
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --title)
                title="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager add [resource|scenario] <name> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --category <cat>    Category (ai-ml, communication, data, security, etc.)"
                echo "  --priority <pri>    Priority (low, medium, high, critical)"
                echo "  --title <title>     Custom title for the task"
                echo "  --json              Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager add resource matrix-synapse --category communication"
                echo "  ecosystem-manager add scenario chat-analyzer --category ai-tools"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$type" || -z "$name" ]]; then
        echo -e "${RED}‚ùå Error: Must specify type (resource|scenario) and name${NC}" >&2
        echo "   Usage: ecosystem-manager add [resource|scenario] <name>" >&2
        return 1
    fi
    
    # Create task JSON
    local task_json=$(cat <<EOF
{
    "title": "${title:-Generate $name $type}",
    "type": "$type",
    "operation": "$operation",
    "category": "${category:-general}",
    "priority": "$priority"
}
EOF
)
    
    check_api
    
    echo -e "${BLUE}üìù Creating $type generation task: $name${NC}"
    
    local response=$(curl -s -X POST "$API_BASE_URL/tasks" \
        -H "Content-Type: application/json" \
        -d "$task_json")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local task_id=$(echo "$response" | jq -r '.id' 2>/dev/null || echo "unknown")
        echo -e "${GREEN}‚úÖ Task created: $task_id${NC}"
        echo "   View: ecosystem-manager show $task_id"
        echo "   Monitor: http://localhost:30500"
    fi
}

# Improve command (shorthand for improvement tasks)
cmd_improve() {
    local type=""
    local target=""
    local priority="medium"
    local areas=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            resource)
                type="resource"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    target="$1"
                    shift
                fi
                ;;
            scenario)
                type="scenario"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    target="$1"
                    shift
                fi
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --areas)
                areas="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager improve [resource|scenario] <target> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --priority <pri>    Priority (low, medium, high, critical)"
                echo "  --areas <areas>     Specific improvement areas"
                echo "  --json              Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager improve resource ollama --priority high"
                echo "  ecosystem-manager improve scenario system-monitor"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$type" || -z "$target" ]]; then
        echo -e "${RED}‚ùå Error: Must specify type (resource|scenario) and target${NC}" >&2
        return 1
    fi
    
    # Create improvement task JSON
    local task_json=$(cat <<EOF
{
    "title": "Improve $target $type",
    "type": "$type", 
    "operation": "improver",
    "category": "improvement",
    "priority": "$priority",
    "requirements": {
        "target_${type}": "$target"
    }
}
EOF
)
    
    check_api
    
    echo -e "${BLUE}üîß Creating $type improvement task: $target${NC}"
    
    local response=$(curl -s -X POST "$API_BASE_URL/tasks" \
        -H "Content-Type: application/json" \
        -d "$task_json")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local task_id=$(echo "$response" | jq -r '.id' 2>/dev/null || echo "unknown")
        echo -e "${GREEN}‚úÖ Improvement task created: $task_id${NC}"
        echo "   View: ecosystem-manager show $task_id"
    fi
}

# List tasks command
cmd_list() {
    local status="pending"
    local type=""
    local operation=""
    local category=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                status="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            --operation)
                operation="$2"
                shift 2
                ;;
            --category)
                category="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager list [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --status <status>       Filter by status (pending, in-progress, completed, failed)"
                echo "  --type <type>           Filter by type (resource, scenario)"
                echo "  --operation <op>        Filter by operation (generator, improver)"
                echo "  --category <cat>        Filter by category"
                echo "  --json                  Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager list --status pending"
                echo "  ecosystem-manager list --type resource --operation generator"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    check_api
    
    # Build query parameters
    local query_params=""
    [[ -n "$status" ]] && query_params+="status=$status&"
    [[ -n "$type" ]] && query_params+="type=$type&"
    [[ -n "$operation" ]] && query_params+="operation=$operation&"
    [[ -n "$category" ]] && query_params+="category=$category&"
    query_params=${query_params%&}  # Remove trailing &
    
    local url="$API_BASE_URL/tasks"
    [[ -n "$query_params" ]] && url+="?$query_params"
    
    local response=$(curl -s "$url")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq length 2>/dev/null || echo "0")
        echo -e "${CYAN}üìã Tasks ($status): $count${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "\(.id)|\(.type)|\(.operation)|\(.title)|\(.priority)|\(.progress_percentage)%"' 2>/dev/null | while IFS='|' read -r id type op title priority progress; do
                local color="$NC"
                case $priority in
                    critical) color="$RED" ;;
                    high) color="$YELLOW" ;;
                    medium) color="$BLUE" ;;
                    low) color="$NC" ;;
                esac
                
                local type_icon="üìÑ"
                [[ "$type" == "resource" ]] && type_icon="üîß"
                [[ "$type" == "scenario" ]] && type_icon="üéØ"
                
                local op_icon="‚ûï"
                [[ "$op" == "improver" ]] && op_icon="üîÑ"
                
                echo -e "  ${type_icon}${op_icon} ${color}$id${NC}"
                echo -e "     $title"
                echo -e "     Priority: $priority | Progress: $progress"
                echo ""
            done
        else
            echo "  No tasks found"
        fi
    fi
}

# Show task details
cmd_show() {
    local task_id="$1"
    local json_output=false
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager show <task-id> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --json              Output in JSON format"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$task_id" ]]; then
        echo -e "${RED}‚ùå Error: Task ID required${NC}" >&2
        echo "   Usage: ecosystem-manager show <task-id>" >&2
        return 1
    fi
    
    check_api
    
    local response=$(curl -s "$API_BASE_URL/tasks/$task_id")
    
    if echo "$response" | grep -q "not found" 2>/dev/null; then
        echo -e "${RED}‚ùå Task not found: $task_id${NC}" >&2
        return 1
    fi
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local title=$(echo "$response" | jq -r '.title' 2>/dev/null)
        local type=$(echo "$response" | jq -r '.type' 2>/dev/null)
        local operation=$(echo "$response" | jq -r '.operation' 2>/dev/null)
        local status=$(echo "$response" | jq -r '.status' 2>/dev/null)
        local priority=$(echo "$response" | jq -r '.priority' 2>/dev/null)
        local category=$(echo "$response" | jq -r '.category' 2>/dev/null)
        local progress=$(echo "$response" | jq -r '.progress_percentage' 2>/dev/null)
        local phase=$(echo "$response" | jq -r '.current_phase' 2>/dev/null)
        
        echo -e "${CYAN}üìÑ Task Details: $task_id${NC}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo -e "Title:      $title"
        echo -e "Type:       $type"
        echo -e "Operation:  $operation"
        echo -e "Status:     $status"
        echo -e "Priority:   $priority"
        echo -e "Category:   $category"
        echo -e "Progress:   $progress%"
        [[ "$phase" != "null" && -n "$phase" ]] && echo -e "Phase:      $phase"
        echo ""
        
        # Show additional details if available
        local created_at=$(echo "$response" | jq -r '.created_at' 2>/dev/null)
        [[ "$created_at" != "null" ]] && echo -e "Created:    $created_at"
        
        local started_at=$(echo "$response" | jq -r '.started_at' 2>/dev/null)
        [[ "$started_at" != "null" && "$started_at" != "" ]] && echo -e "Started:    $started_at"
    fi
}

# Update task status
cmd_status() {
    local task_id="$1"
    local new_status=""
    local progress=""
    local phase=""
    local json_output=false
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                new_status="$2"
                shift 2
                ;;
            --progress)
                progress="$2"
                shift 2
                ;;
            --phase)
                phase="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager status <task-id> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --status <status>       New status (pending, in-progress, completed, failed)"
                echo "  --progress <percent>    Progress percentage (0-100)"
                echo "  --phase <phase>         Current phase"
                echo "  --json                  Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager status abc123 --status in-progress"
                echo "  ecosystem-manager status abc123 --progress 75 --phase testing"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$task_id" ]]; then
        echo -e "${RED}‚ùå Error: Task ID required${NC}" >&2
        return 1
    fi
    
    # Build update JSON
    local update_json="{"
    [[ -n "$new_status" ]] && update_json+="\"status\":\"$new_status\","
    [[ -n "$progress" ]] && update_json+="\"progress_percentage\":$progress,"
    [[ -n "$phase" ]] && update_json+="\"current_phase\":\"$phase\","
    update_json="${update_json%,}}"  # Remove trailing comma
    
    if [[ "$update_json" == "{}" ]]; then
        echo -e "${RED}‚ùå Error: Must specify at least one update (status, progress, or phase)${NC}" >&2
        return 1
    fi
    
    check_api
    
    local response=$(curl -s -X PUT "$API_BASE_URL/tasks/$task_id/status" \
        -H "Content-Type: application/json" \
        -d "$update_json")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}‚úÖ Task status updated: $task_id${NC}"
    fi
}

# Queue overview
cmd_queue() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager queue [OPTIONS]"
                echo ""
                echo "Shows overview of all queues"
                echo ""
                echo "Options:"
                echo "  --json              Output in JSON format"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    check_api
    
    if [[ $json_output == true ]]; then
        local queue_data="{"
        for status in pending in-progress completed failed; do
            local response=$(curl -s "$API_BASE_URL/tasks?status=$status")
            local count=$(echo "$response" | jq length 2>/dev/null || echo "0")
            queue_data+="\"$status\":$count,"
        done
        queue_data="${queue_data%,}}"
        echo "$queue_data" | format_json
    else
        echo -e "${CYAN}üìä Queue Overview${NC}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        
        for status in pending in-progress completed failed; do
            local response=$(curl -s "$API_BASE_URL/tasks?status=$status")
            local count=$(echo "$response" | jq length 2>/dev/null || echo "0")
            
            local color="$NC"
            local icon="üìÑ"
            case $status in
                pending) color="$YELLOW"; icon="‚è≥" ;;
                in-progress) color="$BLUE"; icon="üîÑ" ;;
                completed) color="$GREEN"; icon="‚úÖ" ;;
                failed) color="$RED"; icon="‚ùå" ;;
            esac
            
            printf "${color}%s %-12s %3d${NC}\n" "$icon" "$status" "$count"
        done
        
        echo ""
        echo "Use 'ecosystem-manager list --status <status>' to see details"
    fi
}

# Operations list
cmd_operations() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager operations [OPTIONS]"
                echo ""
                echo "Lists available operation types"
                echo ""
                echo "Options:"
                echo "  --json              Output in JSON format"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    check_api
    
    local response=$(curl -s "$API_BASE_URL/operations")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${CYAN}üîß Available Operations${NC}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        
        echo "$response" | jq -r 'to_entries[] | "\(.key)|\(.value.type)|\(.value.target)|\(.value.description)"' 2>/dev/null | while IFS='|' read -r key type target description; do
            local icon="üîß"
            [[ "$type" == "improver" ]] && icon="üîÑ"
            [[ "$target" == "scenarios" ]] && icon="${icon}üéØ"
            
            echo -e "${GREEN}$icon $key${NC}"
            echo -e "   $description"
            echo ""
        done
    fi
}

# Health check
cmd_health() {
    if curl -s "$API_BASE_URL/../health" > /dev/null 2>&1; then
        local response=$(curl -s "$API_BASE_URL/../health")
        echo -e "${GREEN}‚úÖ Ecosystem Manager is healthy${NC}"
        echo "$response" | jq -r '"Service: " + .service + "\nVersion: " + .version + "\nUptime: " + (.timestamp|tostring)' 2>/dev/null || echo "$response"
    else
        echo -e "${RED}‚ùå Ecosystem Manager is not responding${NC}" >&2
        echo "   Start it with: vrooli scenario ecosystem-manager develop" >&2
        return 1
    fi
}

# Logs command
cmd_logs() {
    local follow=false
    local lines=50
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--follow)
                follow=true
                shift
                ;;
            -n|--lines)
                lines="$2"
                shift 2
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager logs [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  -f, --follow        Follow log output"
                echo "  -n, --lines <num>   Number of lines to show (default: 50)"
                return 0
                ;;
            *)
                echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    local log_file="$PROJECT_DIR/logs/api.log"
    
    if [[ ! -f "$log_file" ]]; then
        echo -e "${RED}‚ùå Log file not found: $log_file${NC}" >&2
        echo "   Make sure Ecosystem Manager is running" >&2
        return 1
    fi
    
    if [[ $follow == true ]]; then
        echo -e "${CYAN}üìù Following logs (Ctrl+C to stop)...${NC}"
        tail -f "$log_file"
    else
        echo -e "${CYAN}üìù Last $lines lines of logs:${NC}"
        tail -n "$lines" "$log_file"
    fi
}

# Main command dispatcher
case "${1:-}" in
    add)
        shift
        cmd_add "$@"
        ;;
    improve)
        shift
        cmd_improve "$@"
        ;;
    list)
        shift
        cmd_list "$@"
        ;;
    show)
        shift
        cmd_show "$@"
        ;;
    status)
        shift
        cmd_status "$@"
        ;;
    queue)
        shift
        cmd_queue "$@"
        ;;
    operations)
        shift
        cmd_operations "$@"
        ;;
    health)
        shift
        cmd_health "$@"
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    --help|-h|help|"")
        usage
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}" >&2
        echo "" >&2
        usage >&2
        exit 1
        ;;
esac