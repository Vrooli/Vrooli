#!/bin/bash
################################################################################
# Ecosystem Manager CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="ecosystem-manager"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the new ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}âŒ Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}/api"
}

################################################################################
# Helper Functions
################################################################################
usage() {
    echo -e "${CYAN}Ecosystem Manager CLI${NC}"
    echo "Unified interface for managing resources and scenarios"
    echo ""
    echo "Usage: ecosystem-manager [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}add${NC}        Create new generation task (resource or scenario)"
    echo -e "  ${GREEN}improve${NC}    Create improvement task for existing resource/scenario"
    echo -e "  ${GREEN}list${NC}       List tasks with optional filters"
    echo -e "  ${GREEN}show${NC}       Show detailed task information"
    echo -e "  ${GREEN}status${NC}     Update task status and progress"
    echo -e "  ${GREEN}queue${NC}      Show queue overview"
    echo -e "  ${GREEN}operations${NC} List available operation types"
    echo -e "  ${GREEN}health${NC}     Check service health"
    echo -e "  ${GREEN}logs${NC}       View service logs"
    echo ""
    echo "Examples:"
    echo "  ecosystem-manager add resource matrix-synapse --category communication"
    echo "  ecosystem-manager improve scenario system-monitor --priority high"
    echo "  ecosystem-manager list --status pending --type resource"
    echo "  ecosystem-manager status task-123 --progress 50 --phase implementation"
    echo "  ecosystem-manager logs -f"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (most commands)"
    echo ""
    echo "For more information: ecosystem-manager <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL from orchestrator
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Add task command
cmd_add() {
    local type=""
    local operation=""
    local name=""
    local category=""
    local priority="medium"
    local title=""
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            resource)
                type="resource"
                operation="generator"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    name="$1"
                    title="Generate $1 resource"
                    shift
                fi
                ;;
            scenario)
                type="scenario"
                operation="generator"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    name="$1"
                    title="Generate $1 scenario"
                    shift
                fi
                ;;
            --category)
                category="$2"
                shift 2
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --title)
                title="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager add [resource|scenario] <name> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --category <cat>    Category (ai-ml, communication, data, security, etc.)"
                echo "  --priority <pri>    Priority (low, medium, high, critical)"
                echo "  --title <title>     Custom title for the task"
                echo "  --json              Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager add resource matrix-synapse --category communication"
                echo "  ecosystem-manager add scenario chat-analyzer --category ai-tools"
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$type" || -z "$name" ]]; then
        echo -e "${RED}âŒ Error: Must specify type (resource|scenario) and name${NC}" >&2
        echo "   Usage: ecosystem-manager add [resource|scenario] <name>" >&2
        return 1
    fi
    
    # Build request JSON
    local request_body=$(cat <<EOF
{
    "title": "${title:-Generate $name $type}",
    "type": "$type",
    "operation": "$operation",
    "category": "${category:-general}",
    "priority": "$priority"
}
EOF
)
    
    echo -e "${BLUE}ðŸ“ Creating $type generation task: $name${NC}"
    
    local response
    response=$(api_request "POST" "/tasks" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local task_id
        task_id=$(echo "$response" | jq -r '.id // "unknown"' 2>/dev/null)
        echo -e "${GREEN}âœ… Task created: $task_id${NC}"
        echo "   View: ecosystem-manager show $task_id"
        echo "   Monitor: http://localhost:$(vrooli scenario port ecosystem-manager UI_PORT 2>/dev/null || echo '30500')"
    fi
}

# Improve command (shorthand for improvement tasks)
cmd_improve() {
    local type=""
    local target=""
    local priority="medium"
    local areas=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            resource)
                type="resource"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    target="$1"
                    shift
                fi
                ;;
            scenario)
                type="scenario"
                shift
                if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
                    target="$1"
                    shift
                fi
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --areas)
                areas="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager improve [resource|scenario] <name> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --priority <pri>    Priority (low, medium, high, critical)"
                echo "  --areas <areas>     Specific areas to improve"
                echo "  --json              Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager improve resource n8n --priority high"
                echo "  ecosystem-manager improve scenario system-monitor --areas \"health-checks,ui\""
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$type" || -z "$target" ]]; then
        echo -e "${RED}âŒ Error: Must specify type (resource|scenario) and target name${NC}" >&2
        echo "   Usage: ecosystem-manager improve [resource|scenario] <name>" >&2
        return 1
    fi
    
    # Build request JSON for improvement task
    local title="Improve $target $type"
    [[ -n "$areas" ]] && title="$title: $areas"
    
    local request_body=$(cat <<EOF
{
    "title": "$title",
    "type": "$type",
    "operation": "improver",
    "category": "improvement",
    "priority": "$priority",
    "notes": "${areas:-}"
}
EOF
)
    
    echo -e "${BLUE}ðŸ”§ Creating $type improvement task: $target${NC}"
    
    local response
    response=$(api_request "POST" "/tasks" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local task_id
        task_id=$(echo "$response" | jq -r '.id // "unknown"' 2>/dev/null)
        echo -e "${GREEN}âœ… Improvement task created: $task_id${NC}"
        echo "   View: ecosystem-manager show $task_id"
    fi
}

# List tasks command
cmd_list() {
    local json_output=false
    local query_params=""
    local status=""
    local type=""
    local operation=""
    local category=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --status)
                status="$2"
                query_params="${query_params:+$query_params&}status=$2"
                shift 2
                ;;
            --type)
                type="$2"
                query_params="${query_params:+$query_params&}type=$2"
                shift 2
                ;;
            --operation)
                operation="$2"
                query_params="${query_params:+$query_params&}operation=$2"
                shift 2
                ;;
            --category)
                category="$2"
                query_params="${query_params:+$query_params&}category=$2"
                shift 2
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager list [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --status <status>       Filter by status (pending, in-progress, completed, failed)"
                echo "  --type <type>           Filter by type (resource, scenario)"
                echo "  --operation <op>        Filter by operation (generator, improver)"
                echo "  --category <cat>        Filter by category"
                echo "  --json                  Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager list --status pending"
                echo "  ecosystem-manager list --type resource --operation generator"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local endpoint="/tasks"
    [[ -n "$query_params" ]] && endpoint="${endpoint}?${query_params}"
    
    local response
    response=$(api_request "GET" "$endpoint")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        # Pretty print tasks with more detail
        local count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
        echo -e "${CYAN}ðŸ“‹ Tasks${status:+ ($status)}: $count${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            # Show tasks in a formatted table
            echo "$response" | jq -r '.[] | "\(.id)|\(.type)|\(.operation)|\(.title)|\(.priority)|\(.progress_percentage)%"' 2>/dev/null | while IFS='|' read -r id type op title priority progress; do
                local color="$NC"
                case "$priority" in
                    critical) color="${RED}" ;;
                    high) color="${YELLOW}" ;;
                    medium) color="${BLUE}" ;;
                    low) color="${NC}" ;;
                esac
                
                # Truncate long titles
                if [[ ${#title} -gt 50 ]]; then
                    title="${title:0:47}..."
                fi
                
                printf "%s${color}%-25s${NC} %-8s %-10s %-50s %3s%%\n" "" "$id" "$type" "$op" "$title" "$progress"
            done
        else
            echo "No tasks found with the specified filters."
        fi
    fi
}

# Show task command
cmd_show() {
    local task_id="$1"
    local json_output=false
    
    if [[ -z "$task_id" ]]; then
        echo -e "${RED}âŒ Error: Task ID required${NC}" >&2
        echo "Usage: ecosystem-manager show <task-id>" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/tasks/${task_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        # Pretty print task details
        echo -e "${CYAN}ðŸ“‹ Task Details:${NC}"
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    fi
}

# Queue status command
cmd_queue() {
    local response
    response=$(api_request "GET" "/queue/status")
    
    echo -e "${CYAN}ðŸ“Š Queue Status:${NC}"
    echo "$response" | format_json
}

# Operations command
cmd_operations() {
    local response
    response=$(api_request "GET" "/operations")
    
    echo -e "${CYAN}ðŸ”§ Available Operations:${NC}"
    echo "$response" | format_json
}

# Health check command
cmd_health() {
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url%/api}/health" 2>/dev/null)
    
    if echo "$response" | grep -q "ok\|healthy"; then
        echo -e "${GREEN}âœ… Ecosystem Manager is healthy${NC}"
        echo "   API: ${api_url}"
    else
        echo -e "${RED}âŒ Ecosystem Manager health check failed${NC}"
        echo "   Response: $response"
        return 1
    fi
}

################################################################################
# Additional Commands
################################################################################

# Update task status command
cmd_status() {
    local task_id="$1"
    local new_status=""
    local progress=""
    local phase=""
    local json_output=false
    
    if [[ -z "$task_id" ]]; then
        echo -e "${RED}âŒ Error: Task ID required${NC}" >&2
        echo "Usage: ecosystem-manager status <task-id> [OPTIONS]" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                new_status="$2"
                shift 2
                ;;
            --progress)
                progress="$2"
                shift 2
                ;;
            --phase)
                phase="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager status <task-id> [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  --status <status>    New status (pending, in-progress, completed, failed)"
                echo "  --progress <num>     Progress percentage (0-100)"
                echo "  --phase <phase>      Current phase name"
                echo "  --json               Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  ecosystem-manager status task-123 --status in-progress --progress 50"
                echo "  ecosystem-manager status task-123 --phase implementation"
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    # Build update JSON
    local update_json="{"
    local updates=""
    [[ -n "$new_status" ]] && updates="${updates:+$updates,}\"status\":\"$new_status\""
    [[ -n "$progress" ]] && updates="${updates:+$updates,}\"progress_percentage\":$progress"
    [[ -n "$phase" ]] && updates="${updates:+$updates,}\"current_phase\":\"$phase\""
    update_json="${update_json}${updates}}"
    
    if [[ "$updates" == "" ]]; then
        echo -e "${YELLOW}âš ï¸  No updates specified${NC}"
        echo "   Use --status, --progress, or --phase to update task"
        return 1
    fi
    
    echo -e "${BLUE}ðŸ“ Updating task: $task_id${NC}"
    
    local response
    response=$(api_request "PUT" "/tasks/${task_id}/status" "$update_json")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… Task updated successfully${NC}"
            [[ -n "$new_status" ]] && echo "   Status: $new_status"
            [[ -n "$progress" ]] && echo "   Progress: $progress%"
            [[ -n "$phase" ]] && echo "   Phase: $phase"
        else
            echo -e "${RED}âŒ Failed to update task${NC}"
            echo "$response" | jq -r '.error // "Unknown error"' 2>/dev/null
        fi
    fi
}

# Logs command
cmd_logs() {
    local follow=false
    local lines=50
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--follow)
                follow=true
                shift
                ;;
            -n|--lines)
                lines="$2"
                shift 2
                ;;
            --help|-h)
                echo "Usage: ecosystem-manager logs [OPTIONS]"
                echo ""
                echo "Options:"
                echo "  -f, --follow        Follow log output"
                echo "  -n, --lines <num>   Number of lines to show (default: 50)"
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    # Get the log file path for the API process
    local log_file="$HOME/.vrooli/logs/scenarios/ecosystem-manager/vrooli.develop.ecosystem-manager.start-api.log"
    
    if [[ ! -f "$log_file" ]]; then
        echo -e "${YELLOW}âš ï¸  Log file not found${NC}"
        echo "   The ecosystem-manager may not be running"
        echo "   Start it with: vrooli scenario run ecosystem-manager"
        return 1
    fi
    
    echo -e "${CYAN}ðŸ“œ Ecosystem Manager Logs:${NC}"
    echo ""
    
    if [[ "$follow" == true ]]; then
        tail -f -n "$lines" "$log_file"
    else
        tail -n "$lines" "$log_file"
    fi
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        add)
            cmd_add "$@"
            ;;
        improve)
            cmd_improve "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        show)
            cmd_show "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        queue)
            cmd_queue "$@"
            ;;
        operations)
            cmd_operations "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        *)
            echo -e "${RED}âŒ Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"