{
  "name": "App Debugger - Performance Profiler",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "performance-profiler",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "return {\n  app_name: 'test-app',\n  metric_type: 'memory'\n};"
      },
      "id": "set_test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const input = $input.item.json;\nconst appName = input.app_name || 'unknown';\nconst metricType = input.metric_type || 'all';\n\n// Build metrics command\nlet command = '';\nif (metricType === 'memory' || metricType === 'all') {\n  command = `docker stats --no-stream --format '{{json .}}' ${appName}`;\n} else if (metricType === 'cpu') {\n  command = `top -b -n 1 | grep ${appName}`;\n}\n\nreturn {\n  command: command,\n  app_name: appName,\n  metric_type: metricType,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "build_metrics_cmd",
      "name": "Build Metrics Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "command": "={{ $json.command }}",
        "options": {}
      },
      "id": "fetch_metrics",
      "name": "Fetch Metrics",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const metricsOutput = $input.item.json.stdout || '{}';\nconst metadata = $('Build Metrics Command').item.json;\n\nlet metrics = {};\ntry {\n  metrics = JSON.parse(metricsOutput);\n} catch (e) {\n  metrics = { raw: metricsOutput };\n}\n\n// Calculate performance indicators\nconst memUsage = metrics.MemPerc ? parseFloat(metrics.MemPerc.replace('%', '')) : 0;\nconst cpuUsage = metrics.CPUPerc ? parseFloat(metrics.CPUPerc.replace('%', '')) : 0;\n\nconst analysis = {\n  app_name: metadata.app_name,\n  timestamp: metadata.timestamp,\n  memory_usage_percent: memUsage,\n  cpu_usage_percent: cpuUsage,\n  memory_limit: metrics.MemLimit || 'unknown',\n  memory_usage: metrics.MemUsage || 'unknown',\n  performance_status: memUsage > 80 || cpuUsage > 80 ? 'critical' : memUsage > 60 || cpuUsage > 60 ? 'warning' : 'healthy',\n  recommendations: []\n};\n\nif (memUsage > 80) {\n  analysis.recommendations.push('Consider increasing memory allocation');\n}\nif (cpuUsage > 80) {\n  analysis.recommendations.push('CPU usage is high - check for infinite loops or optimize algorithms');\n}\n\nreturn analysis;"
      },
      "id": "analyze_performance",
      "name": "Analyze Performance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const analysis = $input.item.json;\n\n// Only use AI if we have concerning metrics\nif (analysis.performance_status === 'critical' || analysis.performance_status === 'warning') {\n  const prompt = `Analyze these performance metrics and provide actionable recommendations:\n\nApp: ${analysis.app_name}\nMemory Usage: ${analysis.memory_usage_percent}%\nCPU Usage: ${analysis.cpu_usage_percent}%\nMemory Limit: ${analysis.memory_limit}\nStatus: ${analysis.performance_status}\n\nProvide:\n1. Root cause analysis\n2. Specific optimization strategies\n3. Code patterns to check\n4. Resource tuning recommendations\n\nFormat as JSON with fields: root_causes, optimizations, code_patterns, resource_tuning`;\n\n  return {\n    ...analysis,\n    needs_ai_analysis: true,\n    ai_prompt: prompt,\n    model: 'phi3.5:3.8b',\n    type: 'analysis',\n    quiet: true\n  };\n}\n\nreturn {\n  ...analysis,\n  needs_ai_analysis: false\n};"
      },
      "id": "prepare_ai_analysis",
      "name": "Prepare AI Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{
            "value1": "={{ $json.needs_ai_analysis }}",
            "value2": true
          }]
        }
      },
      "id": "check_ai_needed",
      "name": "Check AI Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.SHARED_WORKFLOW_OLLAMA_ID || 'ollama' }}",
        "waitForSubWorkflow": true,
        "data": {
          "prompt": "={{ $json.ai_prompt }}",
          "model": "={{ $json.model }}",
          "type": "={{ $json.type }}",
          "quiet": "={{ $json.quiet }}"
        }
      },
      "id": "get_ai_analysis",
      "name": "Get AI Analysis",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1800, 350]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const baseAnalysis = $('Prepare AI Analysis').item.json;\nconst aiResponse = $input.item.json;\n\n// Parse AI recommendations\nlet aiRecommendations = {};\ntry {\n  if (aiResponse.response) {\n    const jsonMatch = aiResponse.response.match(/\\{[\\s\\S]*\\}/);
    if (jsonMatch) {\n      aiRecommendations = JSON.parse(jsonMatch[0]);\n    }\n  }\n} catch (e) {\n  aiRecommendations = { error: 'Failed to parse AI response' };\n}\n\nreturn {\n  ...baseAnalysis,\n  ai_analysis: aiRecommendations,\n  enhanced_recommendations: [\n    ...baseAnalysis.recommendations,\n    ...(aiRecommendations.optimizations || [])\n  ]\n};"
      },
      "id": "merge_ai_analysis",
      "name": "Merge AI Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [2000, 350]
    },
    {
      "parameters": {},
      "id": "merge_results",
      "name": "Merge Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [2200, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json, null, 2) }}",
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2400, 300]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{"node": "merge_triggers", "type": "main", "index": 0}]]
    },
    "manual_trigger": {
      "main": [[{"node": "set_test_defaults", "type": "main", "index": 0}]]
    },
    "set_test_defaults": {
      "main": [[{"node": "merge_triggers", "type": "main", "index": 1}]]
    },
    "merge_triggers": {
      "main": [[{"node": "build_metrics_cmd", "type": "main", "index": 0}]]
    },
    "build_metrics_cmd": {
      "main": [[{"node": "fetch_metrics", "type": "main", "index": 0}]]
    },
    "fetch_metrics": {
      "main": [[{"node": "analyze_performance", "type": "main", "index": 0}]]
    },
    "analyze_performance": {
      "main": [[{"node": "prepare_ai_analysis", "type": "main", "index": 0}]]
    },
    "prepare_ai_analysis": {
      "main": [[{"node": "check_ai_needed", "type": "main", "index": 0}]]
    },
    "check_ai_needed": {
      "main": [
        [{"node": "get_ai_analysis", "type": "main", "index": 0}],
        [{"node": "merge_results", "type": "main", "index": 1}]
      ]
    },
    "get_ai_analysis": {
      "main": [[{"node": "merge_ai_analysis", "type": "main", "index": 0}]]
    },
    "merge_ai_analysis": {
      "main": [[{"node": "merge_results", "type": "main", "index": 0}]]
    },
    "merge_results": {
      "main": [[{"node": "respond", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {},
  "id": "app-debugger-performance-profiler"
}