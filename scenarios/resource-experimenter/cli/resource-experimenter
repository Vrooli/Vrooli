#!/bin/bash
################################################################################
# Resource Experimenter CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="resource-experimenter"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}âŒ Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  
    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
                                                                       
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
    â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•     â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•
                                                                                                       
                ðŸ§ª AI-Powered Resource Experimentation Platform v2.0.0 ðŸ§ª
EOF
    echo -e "${NC}"
}

usage() {
    echo -e "${CYAN}Resource Experimenter CLI${NC}"
    echo "AI-powered resource experimentation for scenarios"
    echo ""
    echo "Usage: resource-experimenter [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}start${NC}         Start a new experiment"
    echo -e "  ${GREEN}list${NC}          List all experiments"
    echo -e "  ${GREEN}view${NC}          View experiment details"
    echo -e "  ${GREEN}delete${NC}        Delete an experiment"
    echo -e "  ${GREEN}scenarios${NC}     List available scenarios"
    echo -e "  ${GREEN}templates${NC}     List experiment templates"
    echo -e "  ${GREEN}logs${NC}          View experiment logs"
    echo -e "  ${GREEN}status${NC}        Check service status"
    echo -e "  ${GREEN}health${NC}        Check service health"
    echo ""
    echo "Examples:"
    echo "  resource-experimenter start \"Add Redis to analytics-dashboard\""
    echo "  resource-experimenter list --status running"
    echo "  resource-experimenter view abc123"
    echo "  resource-experimenter delete abc123"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (most commands)"
    echo ""
    echo "For more information: resource-experimenter <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Start experiment command
cmd_start() {
    local prompt=""
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter start <prompt> [OPTIONS]"
                echo ""
                echo "Start a new resource experimentation"
                echo ""
                echo "Arguments:"
                echo "  <prompt>    Experiment description (e.g., \"Add Redis to analytics-dashboard\")"
                echo ""
                echo "Options:"
                echo "  --json      Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter start \"Add Redis to analytics-dashboard\""
                echo "  resource-experimenter start \"Add Elasticsearch to search-service\""
                echo ""
                echo "Supported formats:"
                echo "  - \"Add [resource] to [scenario]\""
                echo "  - \"Integrate [resource] with [scenario]\""
                return 0
                ;;
            -*)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
            *)
                prompt="$1"
                shift
                ;;
        esac
    done
    
    if [[ -z "$prompt" ]]; then
        echo -e "${RED}âŒ Error: Experiment prompt is required${NC}" >&2
        echo "Usage: resource-experimenter start <prompt>" >&2
        echo "Example: resource-experimenter start \"Add Redis to analytics-dashboard\"" >&2
        return 1
    fi
    
    # Parse prompt to extract target scenario and new resource
    local new_resource=""
    local target_scenario=""
    local experiment_name=""
    
    # Pattern: "Add [RESOURCE] to [SCENARIO]"
    if [[ $prompt =~ [Aa]dd[[:space:]]+([a-zA-Z0-9-]+)[[:space:]]+to[[:space:]]+([a-zA-Z0-9-]+) ]]; then
        new_resource="${BASH_REMATCH[1]}"
        target_scenario="${BASH_REMATCH[2]}"
        experiment_name="Add ${new_resource} to ${target_scenario}"
    # Pattern: "Integrate [RESOURCE] with [SCENARIO]"
    elif [[ $prompt =~ [Ii]ntegrate[[:space:]]+([a-zA-Z0-9-]+)[[:space:]]+with[[:space:]]+([a-zA-Z0-9-]+) ]]; then
        new_resource="${BASH_REMATCH[1]}"
        target_scenario="${BASH_REMATCH[2]}"
        experiment_name="Integrate ${new_resource} with ${target_scenario}"
    else
        echo -e "${RED}âŒ Error: Invalid prompt format${NC}" >&2
        echo "Use: 'Add [resource] to [scenario]' or 'Integrate [resource] with [scenario]'" >&2
        echo "Example: 'Add redis to analytics-dashboard'" >&2
        return 1
    fi
    
    echo -e "${BLUE}ðŸ§ª Creating experiment: ${experiment_name}${NC}"
    echo -e "${YELLOW}   Target scenario: ${target_scenario}${NC}"
    echo -e "${YELLOW}   New resource: ${new_resource}${NC}"
    echo ""
    
    # Build request JSON
    local request_data
    request_data=$(jq -n \
        --arg name "$experiment_name" \
        --arg description "$prompt" \
        --arg prompt "$prompt" \
        --arg target_scenario "$target_scenario" \
        --arg new_resource "$new_resource" \
        '{
            name: $name,
            description: $description,
            prompt: $prompt,
            target_scenario: $target_scenario,
            new_resource: $new_resource
        }')
    
    local response
    response=$(api_request "POST" "/api/experiments" "$request_data")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local experiment_id=$(echo "$response" | jq -r '.id // "null"' 2>/dev/null)
        
        if [[ "$experiment_id" != "null" && -n "$experiment_id" ]]; then
            echo -e "${GREEN}âœ… Experiment created: ${experiment_id}${NC}"
            echo -e "${CYAN}   Status: requested (processing will begin shortly)${NC}"
            echo ""
            echo -e "Use ${GREEN}resource-experimenter view ${experiment_id}${NC} to check progress"
        else
            echo -e "${RED}âŒ Failed to create experiment${NC}"
            echo "$response" | jq -r '.error // "Unknown error"' 2>/dev/null
            return 1
        fi
    fi
}

# List experiments command
cmd_list() {
    local status_filter=""
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                status_filter="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter list [OPTIONS]"
                echo ""
                echo "List all experiments"
                echo ""
                echo "Options:"
                echo "  --status <status>    Filter by status (requested, running, completed, failed)"
                echo "  --json               Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter list"
                echo "  resource-experimenter list --status running"
                echo "  resource-experimenter list --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}ðŸ§ª Resource Experiments${NC}"
    echo ""
    
    # Build query parameters
    local query_params=""
    if [[ -n "$status_filter" ]]; then
        query_params="?status=${status_filter}"
    fi
    
    local response
    response=$(api_request "GET" "/api/experiments${query_params}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
        echo -e "${CYAN}Found $count experiments:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            # Header
            printf "%-36s %-30s %-20s %-15s %-20s\n" "ID" "NAME" "SCENARIO" "RESOURCE" "STATUS"
            printf "%-36s %-30s %-20s %-15s %-20s\n" "----" "----" "--------" "--------" "------"
            
            # Data rows
            echo "$response" | jq -r '.[] | 
                [.id, .name, .target_scenario, .new_resource, .status] | 
                @tsv' 2>/dev/null | while IFS=$'\t' read -r id name scenario resource status; do
                
                # Truncate long fields
                name=$(echo "$name" | cut -c1-29)
                scenario=$(echo "$scenario" | cut -c1-19)
                resource=$(echo "$resource" | cut -c1-14)
                
                # Color code status
                case "$status" in
                    "completed") status_colored="${GREEN}${status}${NC}" ;;
                    "running") status_colored="${YELLOW}${status}${NC}" ;;
                    "failed") status_colored="${RED}${status}${NC}" ;;
                    *) status_colored="$status" ;;
                esac
                
                printf "%-36s %-30s %-20s %-15s %-20s\n" "$id" "$name" "$scenario" "$resource" "$(echo -e "$status_colored")"
            done
        else
            echo "No experiments found."
            if [[ -n "$status_filter" ]]; then
                echo "   Try without --status filter to see all experiments."
            fi
        fi
    fi
}

# View experiment command
cmd_view() {
    local experiment_id="$1"
    local json_output=false
    
    if [[ -z "$experiment_id" ]]; then
        echo -e "${RED}âŒ Error: Experiment ID required${NC}" >&2
        echo "Usage: resource-experimenter view <experiment-id>" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter view <experiment-id> [OPTIONS]"
                echo ""
                echo "View experiment details"
                echo ""
                echo "Arguments:"
                echo "  <experiment-id>    ID of the experiment to view"
                echo ""
                echo "Options:"
                echo "  --json             Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter view abc123-def456"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/api/experiments/${experiment_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        # Check if experiment exists
        local exp_id=$(echo "$response" | jq -r '.id // "null"' 2>/dev/null)
        if [[ "$exp_id" == "null" || -z "$exp_id" ]]; then
            echo -e "${RED}âŒ Experiment not found: ${experiment_id}${NC}"
            return 1
        fi
        
        # Display experiment details
        echo -e "${BLUE}â•â•â• EXPERIMENT DETAILS â•â•â•${NC}"
        echo ""
        echo -e "${WHITE}ID:${NC} $(echo "$response" | jq -r '.id // "N/A"')"
        echo -e "${WHITE}Name:${NC} $(echo "$response" | jq -r '.name // "N/A"')"
        echo -e "${WHITE}Description:${NC} $(echo "$response" | jq -r '.description // "N/A"')"
        echo -e "${WHITE}Target Scenario:${NC} $(echo "$response" | jq -r '.target_scenario // "N/A"')"
        echo -e "${WHITE}New Resource:${NC} $(echo "$response" | jq -r '.new_resource // "N/A"')"
        echo -e "${WHITE}Status:${NC} $(echo "$response" | jq -r '.status // "N/A"')"
        echo -e "${WHITE}Created:${NC} $(echo "$response" | jq -r '.created_at // "N/A"' | cut -c1-19)"
        
        local completed_at=$(echo "$response" | jq -r '.completed_at // "null"')
        if [[ "$completed_at" != "null" ]]; then
            echo -e "${WHITE}Completed:${NC} $(echo "$completed_at" | cut -c1-19)"
        fi
        
        # Show Claude prompt if available
        local claude_prompt=$(echo "$response" | jq -r '.claude_prompt // "null"')
        if [[ "$claude_prompt" != "null" && -n "$claude_prompt" ]]; then
            echo ""
            echo -e "${BLUE}â•â•â• CLAUDE PROMPT â•â•â•${NC}"
            echo "$claude_prompt" | head -10
            if [[ $(echo "$claude_prompt" | wc -l) -gt 10 ]]; then
                echo "... (truncated, full prompt available via JSON output)"
            fi
        fi
        
        # Show Claude response if available
        local claude_response=$(echo "$response" | jq -r '.claude_response // "null"')
        if [[ "$claude_response" != "null" && -n "$claude_response" ]]; then
            echo ""
            echo -e "${BLUE}â•â•â• CLAUDE RESPONSE â•â•â•${NC}"
            echo "$claude_response" | head -15
            if [[ $(echo "$claude_response" | wc -l) -gt 15 ]]; then
                echo "... (truncated, full response available via JSON output)"
            fi
        fi
        
        # Show error if failed
        local error_msg=$(echo "$response" | jq -r '.generation_error // "null"')
        if [[ "$error_msg" != "null" && -n "$error_msg" ]]; then
            echo ""
            echo -e "${RED}â•â•â• ERROR â•â•â•${NC}"
            echo "$error_msg"
        fi
    fi
}

# Delete experiment command
cmd_delete() {
    local experiment_id="$1"
    local json_output=false
    local force=false
    
    if [[ -z "$experiment_id" ]]; then
        echo -e "${RED}âŒ Error: Experiment ID required${NC}" >&2
        echo "Usage: resource-experimenter delete <experiment-id>" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --force)
                force=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter delete <experiment-id> [OPTIONS]"
                echo ""
                echo "Delete an experiment"
                echo ""
                echo "Arguments:"
                echo "  <experiment-id>    ID of the experiment to delete"
                echo ""
                echo "Options:"
                echo "  --force            Skip confirmation prompt"
                echo "  --json             Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter delete abc123-def456"
                echo "  resource-experimenter delete abc123-def456 --force"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Confirm deletion unless forced
    if [[ "$force" != true ]]; then
        echo -e "${YELLOW}âš ï¸  Are you sure you want to delete experiment ${experiment_id}? [y/N]${NC}"
        read -r confirm
        
        if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
            echo -e "${CYAN}â„¹ï¸  Deletion cancelled${NC}"
            return 0
        fi
    fi
    
    local response
    response=$(api_request "DELETE" "/api/experiments/${experiment_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "deleted"; then
            echo -e "${GREEN}âœ… Experiment deleted: ${experiment_id}${NC}"
        else
            echo -e "${RED}âŒ Failed to delete experiment${NC}"
            echo "$response"
            return 1
        fi
    fi
}

# List scenarios command
cmd_scenarios() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter scenarios [OPTIONS]"
                echo ""
                echo "List available scenarios for experimentation"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter scenarios"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}ðŸ“‹ Available Scenarios${NC}"
    echo ""
    
    local response
    response=$(api_request "GET" "/api/scenarios")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
        echo -e "${CYAN}Found $count scenarios:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | 
                "â€¢ \(.name): \(.description // "No description")"' 2>/dev/null
        else
            echo "No scenarios available for experimentation."
        fi
    fi
}

# List templates command
cmd_templates() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter templates [OPTIONS]"
                echo ""
                echo "List available experiment templates"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter templates"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}ðŸ“‹ Experiment Templates${NC}"
    echo ""
    
    local response
    response=$(api_request "GET" "/api/templates")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
        echo -e "${CYAN}Found $count templates:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | 
                "â€¢ \(.name): \(.description // "No description")"' 2>/dev/null
        else
            echo "No templates available."
        fi
    fi
}

# Experiment logs command
cmd_logs() {
    local experiment_id="$1"
    local json_output=false
    
    if [[ -z "$experiment_id" ]]; then
        echo -e "${RED}âŒ Error: Experiment ID required${NC}" >&2
        echo "Usage: resource-experimenter logs <experiment-id>" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: resource-experimenter logs <experiment-id> [OPTIONS]"
                echo ""
                echo "View experiment logs"
                echo ""
                echo "Arguments:"
                echo "  <experiment-id>    ID of the experiment"
                echo ""
                echo "Options:"
                echo "  --json             Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  resource-experimenter logs abc123-def456"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/api/experiments/${experiment_id}/logs")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq 'length' 2>/dev/null || echo "0")
        echo -e "${BLUE}ðŸ“‹ Experiment Logs: ${experiment_id}${NC}"
        echo -e "${CYAN}Found $count log entries:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | 
                "[\(.started_at | split("T")[0])] \(.step): \(.success)"' 2>/dev/null
        else
            echo "No logs found for this experiment."
        fi
    fi
}

# Health check command
cmd_health() {
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/health")
    
    if echo "$response" | grep -q "healthy"; then
        echo -e "${GREEN}âœ… Resource Experimenter is healthy${NC}"
        echo "   API: ${api_url}"
    else
        echo -e "${RED}âŒ Health check failed${NC}"
        echo "   Response: $response"
        return 1
    fi
}

# Status command
cmd_status() {
    echo -e "${CYAN}ðŸ§ª Resource Experimenter Status${NC}"
    echo ""
    
    # Check API
    if api_url=$(get_api_url 2>/dev/null); then
        echo -e "API Server: ${GREEN}âœ… Running${NC}"
        echo "   URL: $api_url"
        
        # Get health info
        local health_response
        health_response=$(curl -s "${api_url}/health" 2>/dev/null)
        if [[ -n "$health_response" ]]; then
            echo "   Health: $(echo "$health_response" | jq -r '.status // "unknown"' 2>/dev/null)"
        fi
        
        # Get experiment count
        local experiments_response
        experiments_response=$(curl -s "${api_url}/api/experiments" 2>/dev/null)
        if [[ -n "$experiments_response" ]]; then
            local count=$(echo "$experiments_response" | jq 'length' 2>/dev/null || echo "0")
            echo "   Total Experiments: $count"
        fi
    else
        echo -e "API Server: ${RED}âŒ Not Running${NC}"
        echo "   Start with: vrooli scenario run resource-experimenter"
    fi
    
    # Check UI if available
    local ui_port
    ui_port=$(vrooli scenario port "${SCENARIO_NAME}" UI_PORT 2>/dev/null)
    if [[ -n "$ui_port" ]]; then
        if curl -sf "http://localhost:${ui_port}" >/dev/null 2>&1; then
            echo -e "UI Server:  ${GREEN}âœ… Running${NC} (port $ui_port)"
            echo "   Web UI: http://localhost:${ui_port}"
        else
            echo -e "UI Server:  ${YELLOW}âš ï¸ Check connection${NC}"
        fi
    fi
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        show_banner
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        start)
            cmd_start "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        view)
            cmd_view "$@"
            ;;
        delete)
            cmd_delete "$@"
            ;;
        scenarios)
            cmd_scenarios "$@"
            ;;
        templates)
            cmd_templates "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        --help|-h|help)
            show_banner
            usage
            ;;
        version|--version|-v)
            echo "Resource Experimenter CLI v2.0.0 (thin wrapper)"
            ;;
        *)
            echo -e "${RED}âŒ Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Check dependencies
if ! command -v curl >/dev/null 2>&1; then
    echo -e "${RED}âŒ Error: curl is required but not installed${NC}" >&2
    exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
    echo -e "${RED}âŒ Error: jq is required but not installed${NC}" >&2
    exit 1
fi

# Run main function
main "$@"