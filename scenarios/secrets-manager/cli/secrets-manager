#!/usr/bin/env bash
# secrets-manager CLI - thin wrapper around the API for operators and CI runners

set -euo pipefail

readonly CLI_NAME="secrets-manager"
readonly SCENARIO_ID="secrets-manager"
readonly CLI_VERSION="1.1.0"
readonly CONFIG_DIR="$HOME/.${CLI_NAME}"
readonly CONFIG_FILE="$CONFIG_DIR/config.json"

CONFIG_API_BASE=""
API_BASE=""
API_TOKEN=""
OUTPUT_FORMAT="json"

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

error() {
    echo -e "${RED}✗${NC} $1" >&2
}

info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" <<JSON
{
  "api_base": "",
  "api_token": "",
  "output_format": "json",
  "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
JSON
    fi
}

load_config() {
    if [[ -f "$CONFIG_FILE" ]] && command -v jq >/dev/null 2>&1; then
        CONFIG_API_BASE=$(jq -r '.api_base // ""' "$CONFIG_FILE" 2>/dev/null || echo "")
        API_TOKEN=$(jq -r '.api_token // ""' "$CONFIG_FILE" 2>/dev/null || echo "")
        OUTPUT_FORMAT=$(jq -r '.output_format // "json"' "$CONFIG_FILE" 2>/dev/null || echo "json")
    else
        CONFIG_API_BASE=""
        API_TOKEN=""
        OUTPUT_FORMAT="json"
    fi
}

require_jq() {
    if ! command -v jq >/dev/null 2>&1; then
        error "jq is required for this command. Please install jq and retry."
        exit 1
    fi
}

normalize_api_base() {
    local value="$1"
    if [[ -z "$value" || "$value" == "null" ]]; then
        return 1
    fi
    echo "${value%/}"
    return 0
}

resolve_api_base() {
    local candidate="$1"

    if normalize_api_base "$candidate" >/dev/null 2>&1; then
        normalize_api_base "$candidate"
        return 0
    fi

    if normalize_api_base "${SECRETS_MANAGER_API_BASE:-}" >/dev/null 2>&1; then
        normalize_api_base "${SECRETS_MANAGER_API_BASE:-}"
        return 0
    fi

    if normalize_api_base "${API_BASE_URL:-}" >/dev/null 2>&1; then
        normalize_api_base "${API_BASE_URL:-}"
        return 0
    fi

    if [[ -n "${SECRETS_MANAGER_API_PORT:-}" ]]; then
        echo "http://${SECRETS_MANAGER_API_HOST:-localhost}:${SECRETS_MANAGER_API_PORT}/api/v1"
        return 0
    fi

    if [[ -n "${API_PORT:-}" ]]; then
        echo "http://${API_HOST:-localhost}:${API_PORT}/api/v1"
        return 0
    fi

    if command -v vrooli >/dev/null 2>&1; then
        local detected_port
        detected_port=$(vrooli scenario port "$SCENARIO_ID" API_PORT 2>/dev/null || true)
        if [[ -n "$detected_port" ]]; then
            echo "http://localhost:${detected_port}/api/v1"
            return 0
        fi
    fi

    return 1
}

ensure_api_base() {
    if [[ -n "$API_BASE" ]]; then
        return 0
    fi

    if ! API_BASE=$(resolve_api_base "$CONFIG_API_BASE"); then
        error "Unable to determine API base URL. Start the scenario via 'vrooli scenario run $SCENARIO_ID' or run '$CLI_NAME configure api_base <url>'."
        exit 1
    fi
}

encode_uri_component() {
    local value="$1"
    python3 -c 'import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1]))' "$value"
}

api_request() {
    local method="$1"
    local endpoint="$2"
    local query="${3:-}"
    local body="${4:-}"

    ensure_api_base

    local url="${API_BASE}${endpoint}"
    if [[ -n "$query" ]]; then
        if [[ "$query" == \?* ]]; then
            url+="$query"
        else
            url+="?$query"
        fi
    fi

    local args=("-sS" "-X" "$method" "$url" "-H" "Content-Type: application/json")
    if [[ -n "$API_TOKEN" ]]; then
        args+=("-H" "Authorization: Bearer $API_TOKEN")
    fi
    if [[ -n "$body" ]]; then
        args+=("-d" "$body")
    fi

    local response
    local err_file
    err_file=$(mktemp -t secrets-manager-cli.XXXXXX)
    if ! response=$(curl "${args[@]}" 2>"$err_file"); then
        error "API request failed: $(cat "$err_file")"
        rm -f "$err_file"
        exit 1
    fi
    rm -f "$err_file"
    echo "$response"
}

print_json() {
    local payload="$1"
    if [[ -z "$payload" ]]; then
        return 0
    fi

    if [[ "${OUTPUT_FORMAT:-json}" == "json" && command -v jq >/dev/null 2>&1 ]]; then
        echo "$payload" | jq .
    else
        echo "$payload"
    fi
}

cmd_status() {
    info "Checking API health"
    local payload
    payload=$(api_request GET "/health")
    print_json "$payload"
}

cmd_vault() {
    local resource=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --resource)
                resource="${2:-}"
                shift 2
                ;;
            --resource=*)
                resource="${1#*=}"
                shift 1
                ;;
            *)
                error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    local query=""
    if [[ -n "$resource" ]]; then
        query="resource=$(encode_uri_component "$resource")"
    fi

    local payload
    payload=$(api_request GET "/vault/secrets/status" "$query")
    print_json "$payload"
}

cmd_vulnerabilities() {
    local component=""
    local component_type=""
    local severity=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --component)
                component="${2:-}"
                shift 2
                ;;
            --component=*)
                component="${1#*=}"
                shift 1
                ;;
            --component-type)
                component_type="${2:-}"
                shift 2
                ;;
            --component-type=*)
                component_type="${1#*=}"
                shift 1
                ;;
            --severity)
                severity="${2:-}"
                shift 2
                ;;
            --severity=*)
                severity="${1#*=}"
                shift 1
                ;;
            *)
                error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    local params=()
    [[ -n "$component" ]] && params+=("component=$(encode_uri_component "$component")")
    [[ -n "$component_type" ]] && params+=("componentType=$(encode_uri_component "$component_type")")
    [[ -n "$severity" ]] && params+=("severity=$(encode_uri_component "$severity")")
    local query="$(IFS='&'; echo "${params[*]}")"

    local payload
    payload=$(api_request GET "/vulnerabilities" "$query")
    print_json "$payload"
}

cmd_scan() {
    local component=""
    local component_type=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --component)
                component="${2:-}"
                shift 2
                ;;
            --component=*)
                component="${1#*=}"
                shift 1
                ;;
            --component-type)
                component_type="${2:-}"
                shift 2
                ;;
            --component-type=*)
                component_type="${1#*=}"
                shift 1
                ;;
            *)
                error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    local params=()
    [[ -n "$component" ]] && params+=("component=$(encode_uri_component "$component")")
    [[ -n "$component_type" ]] && params+=("componentType=$(encode_uri_component "$component_type")")
    local query="$(IFS='&'; echo "${params[*]}")"

    local payload
    payload=$(api_request GET "/security/scan" "$query")
    print_json "$payload"
}

cmd_compliance() {
    local payload
    payload=$(api_request GET "/security/compliance")
    print_json "$payload"
}

cmd_configure() {
    local key="${1:-}"
    local value="${2:-}"

    if [[ -z "$key" ]]; then
        if command -v jq >/dev/null 2>&1; then
            jq '.' "$CONFIG_FILE"
        else
            cat "$CONFIG_FILE"
        fi
        return 0
    fi

    require_jq

    case "$key" in
        api|api_base)
            jq --arg v "$value" '.api_base = $v' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
            mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            success "API base set to $value"
            CONFIG_API_BASE="$value"
            ;;
        token|api_token)
            jq --arg v "$value" '.api_token = $v' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
            mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            success "API token updated"
            API_TOKEN="$value"
            ;;
        output|output_format)
            jq --arg v "$value" '.output_format = $v' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
            mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            success "Output format set to $value"
            OUTPUT_FORMAT="$value"
            ;;
        *)
            error "Unknown configuration key: $key"
            echo "Valid keys: api_base, api_token, output_format"
            exit 1
            ;;
    esac
}

cmd_version() {
    echo "$CLI_NAME version $CLI_VERSION"
    if [[ -n "$API_BASE" ]]; then
        echo "API endpoint: $API_BASE"
    elif [[ -n "$CONFIG_API_BASE" ]]; then
        echo "API endpoint: ${CONFIG_API_BASE%/}"
    else
        echo "API endpoint: (auto-detect when running)"
    fi
}

cmd_help() {
    cat <<'TEXT'
secrets-manager CLI
Usage: secrets-manager <command> [options]

Commands:
  status                 Check API /health
  vault [--resource R]   Show aggregated vault status (optional single resource)
  vulnerabilities [opts] List vulnerabilities (filters: --severity, --component, --component-type)
  scan [opts]            Trigger/read latest scan summary (filters like vulnerabilities)
  compliance             Fetch combined compliance metrics
  configure              View or update CLI configuration
  version                Show CLI version
  help                   Show this message

Environment overrides:
  SECRETS_MANAGER_API_BASE   Fully qualified API base URL
  SECRETS_MANAGER_API_TOKEN  Bearer token (if auth added later)
  SECRETS_MANAGER_OUTPUT_FORMAT  json|raw (defaults to json)
TEXT
}

main() {
    init_config
    load_config

    if [[ -n "${SECRETS_MANAGER_API_TOKEN:-}" ]]; then
        API_TOKEN="$SECRETS_MANAGER_API_TOKEN"
    fi

    if [[ -n "${SECRETS_MANAGER_OUTPUT_FORMAT:-}" ]]; then
        OUTPUT_FORMAT="$SECRETS_MANAGER_OUTPUT_FORMAT"
    fi

    local command="${1:-help}"
    shift || true

    case "$command" in
        status)
            cmd_status "$@"
            ;;
        vault)
            cmd_vault "$@"
            ;;
        vulnerabilities)
            cmd_vulnerabilities "$@"
            ;;
        scan)
            cmd_scan "$@"
            ;;
        compliance)
            cmd_compliance "$@"
            ;;
        configure|config)
            cmd_configure "$@"
            ;;
        version|-v|--version)
            cmd_version
            ;;
        help|-h|--help)
            cmd_help
            ;;
        *)
            error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
