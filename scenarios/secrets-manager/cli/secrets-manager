#!/usr/bin/env bash
# Secrets Manager CLI
# Dark chrome security interface for discovering, validating, and provisioning secrets

set -euo pipefail

APP_ROOT="${APP_ROOT:-$(builtin cd "${BASH_SOURCE[0]%/*}/../../.." && builtin pwd)}"
SCRIPT_DIR="${APP_ROOT}/scenarios/secrets-manager/cli"
CLI_NAME="secrets-manager"
VERSION="1.0.0"

# Default API URL - can be overridden via environment
API_URL="${SECRETS_API_URL:-http://localhost:28000}"
UI_URL="${SECRETS_UI_URL:-http://localhost:28250}"

# Cyberpunk color codes for dark chrome aesthetic
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
SILVER='\033[0;37m'      # Chrome silver
MATRIX_GREEN='\033[1;92m'  # Bright matrix green
DARK_GRAY='\033[1;30m'   # Dark gray
NC='\033[0m' # No Color

# Cyberpunk/Dark Chrome banner
show_banner() {
    echo -e "${SILVER}"
    cat << 'EOF'
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
    â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•
EOF
    echo -e "${DARK_GRAY}"
    cat << 'EOF'
    â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
    â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•
EOF
    echo -e "${MATRIX_GREEN}       ðŸ” SECURITY VAULT ACCESS TERMINAL v${VERSION} ðŸ”${NC}"
    echo -e "${SILVER}       â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# Enhanced messaging with cyberpunk styling  
error() {
    echo -e "${RED}â”Œâ”€ SECURITY BREACH â”€${NC}" >&2
    echo -e "${RED}â”‚ âŒ $1${NC}" >&2
    echo -e "${RED}â””â”€â”€${NC}" >&2
    exit 1
}

success() {
    echo -e "${MATRIX_GREEN}â”Œâ”€ OPERATION SUCCESS â”€${NC}"
    echo -e "${MATRIX_GREEN}â”‚ âœ… $1${NC}"
    echo -e "${MATRIX_GREEN}â””â”€â”€${NC}"
}

info() {
    echo -e "${CYAN}â”Œâ”€ SYSTEM INFO â”€${NC}"
    echo -e "${CYAN}â”‚ â„¹ï¸  $1${NC}"
    echo -e "${CYAN}â””â”€â”€${NC}"
}

warn() {
    echo -e "${YELLOW}â”Œâ”€ SECURITY WARNING â”€${NC}"
    echo -e "${YELLOW}â”‚ âš ï¸  $1${NC}"
    echo -e "${YELLOW}â””â”€â”€${NC}"
}

scanning() {
    echo -e "${SILVER}â”Œâ”€ SCANNING... â”€${NC}"
    echo -e "${SILVER}â”‚ ðŸ” $1${NC}"
    echo -e "${SILVER}â””â”€â”€${NC}"
}

# API helper functions  
api_get() {
    local endpoint="$1"
    curl -s "${API_URL}${endpoint}" || error "Failed to connect to Secrets Manager API at ${API_URL}"
}

api_post() {
    local endpoint="$1"
    local data="$2"
    curl -s -X POST -H "Content-Type: application/json" -d "$data" "${API_URL}${endpoint}" || error "Failed to post to API"
}

# Check if API is available
check_api() {
    if ! api_get "/health" > /dev/null 2>&1; then
        error "Secrets Manager API is not running at ${API_URL}. Please start it first."
    fi
}

# Display secrets in table format
display_secrets_table() {
    local json_data="$1"
    local show_all="${2:-false}"
    
    if [[ "$show_all" == "true" ]]; then
        echo -e "${WHITE}â”Œâ”€ ALL SECRETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    else
        echo -e "${WHITE}â”Œâ”€ MISSING SECRETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    fi
    
    echo -e "${SILVER}â”‚${NC}"
    printf "${SILVER}â”‚ %-20s %-30s %-12s %-8s${NC}\n" "RESOURCE" "SECRET KEY" "TYPE" "STATUS"
    echo -e "${SILVER}â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    if command -v jq > /dev/null 2>&1; then
        echo "$json_data" | jq -r '.discovered_secrets[]? // .missing_secrets[]? // .[] | 
            "\(.resource_name // "unknown") \(.secret_key // "unknown") \(.secret_type // "unknown") \(.validation_status // "discovered")"' | 
        while read -r resource key type status; do
            local color="${MATRIX_GREEN}"
            local status_icon="âœ…"
            
            case "$status" in
                "missing")
                    color="${RED}"
                    status_icon="âŒ"
                    ;;
                "invalid")
                    color="${YELLOW}" 
                    status_icon="âš ï¸"
                    ;;
                "discovered")
                    color="${CYAN}"
                    status_icon="ðŸ”"
                    ;;
            esac
            
            printf "${SILVER}â”‚${color} %-20s %-30s %-12s %s %-6s${NC}\n" \
                "$resource" "$key" "$type" "$status_icon" "$status"
        done
    else
        echo -e "${SILVER}â”‚ jq not available - displaying raw JSON${NC}"
        echo -e "${SILVER}â”‚${NC} $json_data"
    fi
    
    echo -e "${WHITE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# Command implementations
cmd_status() {
    info "Checking Secrets Manager status..."
    check_api
    
    local health
    health=$(api_get "/health")
    
    if [[ -n "$health" ]]; then
        success "Security vault is operational"
        echo -e "\n${WHITE}â”Œâ”€ SYSTEM STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        if command -v jq > /dev/null 2>&1; then
            echo "$health" | jq -r '"â”‚ Service: " + .service + " v" + .version'
            echo "$health" | jq -r '"â”‚ Status: " + .status'  
            echo "$health" | jq -r '"â”‚ Timestamp: " + .timestamp'
        else
            echo -e "${SILVER}â”‚ $health${NC}"
        fi
        echo -e "${WHITE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        
        echo -e "\n${WHITE}â”Œâ”€ ACCESS TERMINALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        echo -e "${SILVER}â”‚ ðŸ”Œ API Terminal: ${API_URL}${NC}"
        echo -e "${SILVER}â”‚ ðŸŒ Security Dashboard: ${UI_URL}${NC}"
        echo -e "${SILVER}â”‚ ðŸ”§ Command Interface: secrets-manager --help${NC}"
        echo -e "${WHITE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    fi
}

cmd_scan() {
    local resources=()
    local output_format="table"
    local scan_type="full"
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --resource)
                resources+=("$2")
                shift 2
                ;;
            --output)
                output_format="$2"
                shift 2
                ;;
            --type)
                scan_type="$2" 
                shift 2
                ;;
            *)
                break
                ;;
        esac
    done
    
    check_api
    
    scanning "Initiating resource secret discovery scan..."
    
    local request_data
    if [[ ${#resources[@]} -gt 0 ]]; then
        request_data=$(printf '{"resources":[%s],"scan_type":"%s"}' "$(printf '"%s",' "${resources[@]}" | sed 's/,$//')" "$scan_type")
        scanning "Targeting resources: ${resources[*]}"
    else
        request_data='{"scan_type":"'"$scan_type"'"}'
        scanning "Scanning all available resources..."
    fi
    
    local result
    result=$(api_post "/api/v1/secrets/scan" "$request_data")
    
    if [[ "$output_format" == "json" ]]; then
        echo "$result"
    else
        success "Resource scan completed successfully"
        
        if command -v jq > /dev/null 2>&1; then
            local scan_id scan_duration discovered_count
            scan_id=$(echo "$result" | jq -r '.scan_id')
            scan_duration=$(echo "$result" | jq -r '.scan_duration_ms')
            discovered_count=$(echo "$result" | jq -r '.discovered_secrets | length')
            
            echo -e "\n${WHITE}â”Œâ”€ SCAN RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
            echo -e "${SILVER}â”‚ Scan ID: $scan_id${NC}"
            echo -e "${SILVER}â”‚ Duration: ${scan_duration}ms${NC}"
            echo -e "${SILVER}â”‚ Secrets Discovered: $discovered_count${NC}"
            echo -e "${WHITE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
        fi
        
        display_secrets_table "$result" true
    fi
}

cmd_validate() {
    local resource=""
    local output_format="table"
    local missing_only=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --resource)
                resource="$2"
                shift 2
                ;;
            --output)
                output_format="$2"
                shift 2
                ;;
            --missing-only)
                missing_only=true
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    check_api
    
    if [[ -n "$resource" ]]; then
        scanning "Validating secrets for resource: $resource"
        local request_data='{"resource":"'"$resource"'"}'
    else
        scanning "Validating all discovered secrets..."
        local request_data='{}'
    fi
    
    local result
    result=$(api_post "/api/v1/secrets/validate" "$request_data")
    
    if [[ "$output_format" == "json" ]]; then
        echo "$result"
    else
        if command -v jq > /dev/null 2>&1; then
            local total_secrets valid_secrets missing_count invalid_count
            total_secrets=$(echo "$result" | jq -r '.total_secrets')
            valid_secrets=$(echo "$result" | jq -r '.valid_secrets')
            missing_count=$(echo "$result" | jq -r '.missing_secrets | length')
            invalid_count=$(echo "$result" | jq -r '.invalid_secrets | length')
            
            echo -e "\n${WHITE}â”Œâ”€ VALIDATION RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
            echo -e "${SILVER}â”‚ Total Secrets: $total_secrets${NC}"
            echo -e "${MATRIX_GREEN}â”‚ Valid Secrets: $valid_secrets${NC}"
            echo -e "${RED}â”‚ Missing Secrets: $missing_count${NC}"
            echo -e "${YELLOW}â”‚ Invalid Secrets: $invalid_count${NC}"
            echo -e "${WHITE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
            
            if [[ $missing_count -gt 0 ]]; then
                warn "Found $missing_count missing required secrets"
                display_secrets_table "$(echo "$result" | jq '.missing_secrets')"
            fi
            
            if [[ $invalid_count -gt 0 && "$missing_only" == "false" ]]; then
                warn "Found $invalid_count invalid secrets"
                display_secrets_table "$(echo "$result" | jq '.invalid_secrets')"
            fi
            
            if [[ $missing_count -eq 0 && $invalid_count -eq 0 ]]; then
                success "All secrets are properly configured"
            fi
        else
            echo "$result"
        fi
    fi
}

cmd_provision() {
    local secret_key=""
    local storage_method="vault"
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --secret)
                secret_key="$2"
                shift 2
                ;;
            --vault)
                storage_method="vault"
                shift
                ;;
            --env)
                storage_method="env"
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    if [[ -z "$secret_key" ]]; then
        error "Secret key is required. Use --secret <key>"
    fi
    
    check_api
    
    # Interactive secret value input
    echo -e "${SILVER}â”Œâ”€ SECURE PROVISIONING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${SILVER}â”‚ Secret Key: $secret_key${NC}" 
    echo -e "${SILVER}â”‚ Storage Method: $storage_method${NC}"
    echo -e "${SILVER}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    echo -e -n "${YELLOW}Enter secret value (hidden): ${NC}"
    read -s secret_value
    echo
    
    if [[ -z "$secret_value" ]]; then
        error "Secret value cannot be empty"
    fi
    
    local request_data
    request_data=$(printf '{"secret_key":"%s","secret_value":"%s","storage_method":"%s"}' \
        "$secret_key" "$secret_value" "$storage_method")
    
    scanning "Provisioning secret securely..."
    
    local result
    result=$(api_post "/api/v1/secrets/provision" "$request_data")
    
    if command -v jq > /dev/null 2>&1; then
        local success_status storage_location
        success_status=$(echo "$result" | jq -r '.success')
        storage_location=$(echo "$result" | jq -r '.storage_location')
        
        if [[ "$success_status" == "true" ]]; then
            success "Secret provisioned successfully"
            info "Storage location: $storage_location"
        else
            error "Failed to provision secret"
        fi
    else
        echo "$result"
    fi
}

cmd_help() {
    show_banner
    echo
    echo -e "${WHITE}USAGE:${NC}"
    echo -e "  ${SILVER}$CLI_NAME <command> [options]${NC}"
    echo
    echo -e "${WHITE}COMMANDS:${NC}"
    echo -e "  ${MATRIX_GREEN}status${NC}          Show security vault operational status"
    echo -e "  ${MATRIX_GREEN}scan${NC}            Discover secrets required by resources"
    echo -e "  ${MATRIX_GREEN}validate${NC}        Validate current environment secrets" 
    echo -e "  ${MATRIX_GREEN}provision${NC}       Interactive secret provisioning wizard"
    echo -e "  ${MATRIX_GREEN}version${NC}         Show version information"
    echo -e "  ${MATRIX_GREEN}help${NC}            Show this help message"
    echo
    echo -e "${WHITE}SCAN OPTIONS:${NC}"
    echo -e "  ${SILVER}--resource <name>${NC}  Scan specific resource only"
    echo -e "  ${SILVER}--output <format>${NC}  Output format: table, json (default: table)"
    echo -e "  ${SILVER}--type <type>${NC}      Scan type: full, quick (default: full)"
    echo
    echo -e "${WHITE}VALIDATE OPTIONS:${NC}"
    echo -e "  ${SILVER}--resource <name>${NC}  Validate specific resource only"
    echo -e "  ${SILVER}--missing-only${NC}     Show only missing secrets"
    echo -e "  ${SILVER}--output <format>${NC}  Output format: table, json (default: table)"
    echo
    echo -e "${WHITE}PROVISION OPTIONS:${NC}"
    echo -e "  ${SILVER}--secret <key>${NC}     Secret key to provision (required)"
    echo -e "  ${SILVER}--vault${NC}            Store in HashiCorp Vault (default)"
    echo -e "  ${SILVER}--env${NC}              Store as environment variable"
    echo
    echo -e "${WHITE}EXAMPLES:${NC}"
    echo -e "  ${SILVER}$CLI_NAME status${NC}"
    echo -e "  ${SILVER}$CLI_NAME scan --resource postgres${NC}"
    echo -e "  ${SILVER}$CLI_NAME validate --missing-only${NC}"
    echo -e "  ${SILVER}$CLI_NAME provision --secret POSTGRES_PASSWORD${NC}"
    echo -e "  ${SILVER}$CLI_NAME scan --output json${NC}"
    echo
    echo -e "${DARK_GRAY}â”Œâ”€ SECURITY NOTICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${DARK_GRAY}â”‚ This terminal provides secure access to credential management.${NC}"
    echo -e "${DARK_GRAY}â”‚ All secret values are encrypted and handled securely.${NC}"
    echo -e "${DARK_GRAY}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

cmd_version() {
    echo -e "${SILVER}Secrets Manager CLI v${VERSION}${NC}"
    echo -e "${DARK_GRAY}Dark Chrome Security Terminal${NC}"
    echo -e "${SILVER}API Endpoint: ${API_URL}${NC}"
    echo -e "${SILVER}UI Dashboard: ${UI_URL}${NC}"
}

# Main command dispatcher
main() {
    case "${1:-help}" in
        "status")
            shift
            cmd_status "$@"
            ;;
        "scan")
            shift
            cmd_scan "$@"
            ;;
        "validate")
            shift
            cmd_validate "$@"
            ;;
        "provision")
            shift
            cmd_provision "$@"
            ;;
        "version")
            cmd_version
            ;;
        "help"|"--help"|"-h")
            cmd_help
            ;;
        *)
            error "Unknown command: $1. Use 'secrets-manager help' for usage."
            ;;
    esac
}

# Execute main function with all arguments
main "$@"