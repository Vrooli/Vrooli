version: 1.0
scenario: secrets-manager

# Structure validation
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/secrets-manager
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - initialization/storage/postgres/seed.sql
    - initialization/automation/n8n/resource-scanner.json
    - initialization/automation/n8n/secret-validator.json
    - ui/index.html
    - ui/script.js
    - ui/server.js
    - ui/styles.css
    - scenario-test.yaml
    - test.sh
    - custom-tests.sh
  
  required_dirs:
    - .vrooli
    - api
    - cli
    - initialization/storage/postgres
    - initialization/automation/n8n
    - ui

# Resource requirements
resources:
  required: [vault, postgres, n8n]
  optional: [redis]
  health_timeout: 60

# Declarative tests
tests:
  - name: "Vault Secrets Management Ready"
    type: http
    service: vault
    endpoint: /v1/sys/health
    method: GET
    expect:
      status: 200
      body:
        type: json
        
  - name: "PostgreSQL Database Connection"
    type: tcp
    service: postgres
    port: 5432
    timeout: 5000
      
  - name: "n8n Workflow Engine Ready"
    type: http
    service: n8n
    endpoint: /healthz
    method: GET
    expect:
      status: 200
      
  - name: "Secrets Manager API Health"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        type: json
        contains: ["status", "service"]

  - name: "Secrets Scan API Endpoint"
    type: http
    service: api
    endpoint: /api/v1/secrets/scan
    method: GET
    expect:
      status: 200
      body:
        type: json
        contains: ["discovered_secrets"]

  - name: "Secrets Validation API Endpoint" 
    type: http
    service: api
    endpoint: /api/v1/secrets/validate
    method: GET
    expect:
      status: 200
      body:
        type: json
        contains: ["total_secrets", "valid_secrets", "missing_secrets"]
      
  - name: "Dark Chrome Dashboard UI"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body:
        type: html
        contains: ["Secrets Manager", "dark-chrome", "secret-health"]
        
  - name: "Database Schema Validation"
    type: database
    service: postgres
    database: vrooli
    query: "SELECT table_name FROM information_schema.tables WHERE table_name IN ('resource_secrets', 'secret_validations')"
    expect:
      contains: ["resource_secrets", "secret_validations"]
      
  - name: "Resource Scanner Workflow"
    type: n8n
    service: n8n
    workflow: resource-scanner
    expect:
      active: true
      node_count: ">= 3"
      
  - name: "Secret Validator Workflow"
    type: n8n
    service: n8n  
    workflow: secret-validator
    expect:
      active: true
      node_count: ">= 4"
      
  - name: "CLI Status Command"
    type: exec
    command: ./cli/secrets-manager status --json
    expect:
      exit_code: 0
      output_contains: ["secrets", "resources"]
      
  - name: "CLI Scan Command"
    type: exec
    command: ./cli/secrets-manager scan --output json
    expect:
      exit_code: 0
      output_contains: ["discovered_secrets"]
      
  - name: "CLI Validation Command"
    type: exec
    command: ./cli/secrets-manager validate --json
    expect:
      exit_code: 0
      output_contains: ["validation_id", "total_secrets"]

  - name: "Resource Discovery Integration Test"
    type: integration
    description: "Test complete resource secret discovery pipeline"
    workflow:
      - step: "Trigger Resource Scan"
        type: http
        service: api
        endpoint: /api/v1/secrets/scan
        method: POST
        body:
          resources: ["postgres", "vault"]
        expect:
          status: 200
          response_time: 10000
          
      - step: "Verify Discovery Results"
        type: database
        service: postgres
        query: "SELECT COUNT(*) as count FROM resource_secrets WHERE resource_name IN ('postgres', 'vault')"
        expect:
          count: ">= 4"  # Should discover at least some secrets
          
  - name: "Secret Validation Integration Test"
    type: integration
    description: "Test secret validation against live environment"
    workflow:
      - step: "Run Environment Validation"
        type: http
        service: api
        endpoint: /api/v1/secrets/validate
        method: POST
        expect:
          status: 200
          response_time: 8000
          
      - step: "Verify Validation Storage"
        type: database
        service: postgres
        query: "SELECT COUNT(*) as count FROM secret_validations WHERE validation_timestamp > NOW() - INTERVAL '5 minutes'"
        expect:
          count: ">= 1"
          
  - name: "Dark Chrome UI Accessibility Test"
    type: custom
    script: custom-tests.sh
    function: test_dark_chrome_ui_accessibility
    
  - name: "Resource Secret Discovery Test"
    type: custom
    script: custom-tests.sh
    function: test_resource_secret_discovery
    
  - name: "Vault Integration Test"
    type: custom
    script: custom-tests.sh  
    function: test_vault_secret_storage

# Performance benchmarks
performance:
  targets:
    resource_scan_time: 5000      # 5 seconds max for full resource scan
    validation_time: 3000         # 3 seconds max for environment validation
    dashboard_load_time: 2000     # 2 seconds max for dashboard load
    api_response_time: 1000       # 1 second max for basic API calls
    
  load_test:
    concurrent_users: 2
    test_duration: 60   # 1 minute
    ramp_up_time: 10    # 10 seconds

# Validation criteria  
validation:
  success_rate: 95        # Very high success rate for security-focused tool
  response_time: 5000     # 5 seconds max for complex secret operations
  revenue_potential: 0    # Internal development tool - no revenue model
  business_criteria:
    - "Successfully discovers secrets from at least 5 different resource types"
    - "Dark chrome cyberpunk UI loads and displays secret health status"  
    - "Vault integration functional for secure secret storage/retrieval"
    - "CLI provides both human-readable and JSON output formats"
    - "Database schema properly tracks resource secrets and validation history"
    - "n8n workflows active and functional for resource scanning"
    - "API endpoints respond correctly with proper JSON structures"
    - "Interactive provisioning wizard stores secrets securely"