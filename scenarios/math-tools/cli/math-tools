#!/bin/bash
# Math Tools CLI - Command-line interface for mathematical operations

set -euo pipefail

# Configuration
readonly CLI_NAME="math-tools"
readonly CLI_VERSION="1.0.0"
readonly CONFIG_DIR="$HOME/.${CLI_NAME}"
readonly CONFIG_FILE="$CONFIG_DIR/config.json"
# Note: API token should be provided via MATH_TOOLS_API_TOKEN environment variable
# or stored in config file. No default token for security.

# Auto-detect API port from running scenario
detect_api_port() {
    # Try to find the running math-tools-api process and its port
    local pid
    pid=$(pgrep -f 'math-tools-api' 2>/dev/null | head -1 || true)
    if [[ -n "$pid" ]]; then
        # Check the process environment for API_PORT
        local port
        port=$(cat /proc/$pid/environ 2>/dev/null | tr '\0' '\n' | grep '^API_PORT=' | cut -d= -f2 || true)
        if [[ -n "$port" ]]; then
            echo "http://localhost:${port}"
            return 0
        fi

        # Alternative: check what port the process is listening on
        port=$(ss -tlnp 2>/dev/null | grep "$pid" | grep -oP ':\K[0-9]+' | head -1 || true)
        if [[ -n "$port" ]]; then
            echo "http://localhost:${port}"
            return 0
        fi
    fi

    # Fall back to default port
    echo "http://localhost:8095"
}

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Initialize configuration
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi
    
    if [[ ! -f "$CONFIG_FILE" ]]; then
        local detected_api_base=$(detect_api_port)
        cat > "$CONFIG_FILE" <<EOF
{
    "api_base": "$detected_api_base",
    "api_token": "",
    "output_format": "table",
    "precision": 10,
    "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
}
EOF
        echo -e "${GREEN}‚úì${NC} Configuration initialized at $CONFIG_FILE"
        echo -e "${YELLOW}‚ö†${NC}  Set API token via MATH_TOOLS_API_TOKEN environment variable or update config file"
    fi
}

# Load configuration
load_config() {
    # Detect API port dynamically
    local detected_api_base=$(detect_api_port)

    if [[ -f "$CONFIG_FILE" ]]; then
        API_BASE=$(jq -r '.api_base // "'$detected_api_base'"' "$CONFIG_FILE" 2>/dev/null || echo "$detected_api_base")
        API_TOKEN=$(jq -r '.api_token // ""' "$CONFIG_FILE" 2>/dev/null || echo "")
        OUTPUT_FORMAT=$(jq -r '.output_format // "table"' "$CONFIG_FILE" 2>/dev/null || echo "table")
        PRECISION=$(jq -r '.precision // 10' "$CONFIG_FILE" 2>/dev/null || echo "10")
    else
        API_BASE="$detected_api_base"
        API_TOKEN=""
        OUTPUT_FORMAT="table"
        PRECISION="10"
    fi

    # Allow environment variable to override config
    API_TOKEN="${MATH_TOOLS_API_TOKEN:-$API_TOKEN}"
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    
    local url="${API_BASE}${endpoint}"
    local curl_opts=(-s -X "$method" -H "Authorization: Bearer $API_TOKEN")
    
    if [[ -n "$data" ]]; then
        curl_opts+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    response=$(curl "${curl_opts[@]}" "$url" 2>/dev/null)
    exit_code=$?
    
    if [[ $exit_code -ne 0 ]]; then
        echo -e "${RED}‚úó${NC} Failed to connect to API at $url" >&2
        return 1
    fi
    
    echo "$response"
}

# Format output
format_output() {
    local data="$1"
    local format="${2:-$OUTPUT_FORMAT}"
    
    case "$format" in
        json)
            echo "$data" | jq '.' 2>/dev/null || echo "$data"
            ;;
        table)
            echo "$data" | jq -r '.data | if type == "object" then . else . end' 2>/dev/null || echo "$data"
            ;;
        raw)
            echo "$data"
            ;;
        *)
            echo "$data"
            ;;
    esac
}

# Command: status
cmd_status() {
    echo -e "${BLUE}üîç Checking Math Tools status...${NC}"

    response=$(api_request "GET" "/health")
    if [[ $? -eq 0 ]]; then
        # Try new format first (.data.status), then fall back to old format (.status)
        status=$(echo "$response" | jq -r '.data.status // .status // "unknown"')
        if [[ "$status" == "healthy" ]]; then
            echo -e "${GREEN}‚úì${NC} Math Tools API is healthy"
            echo "$response" | jq '.' 2>/dev/null
        else
            echo -e "${YELLOW}‚ö†${NC} Math Tools API status: $status"
            echo "$response" | jq '.' 2>/dev/null
        fi
    else
        echo -e "${RED}‚úó${NC} Math Tools API is not responding"
        exit 1
    fi
}

# Command: calc - Perform calculations
cmd_calc() {
    local operation="$1"
    shift
    local data_array="["
    
    # Build array from arguments
    for num in "$@"; do
        if [[ "$data_array" != "[" ]]; then
            data_array+=","
        fi
        data_array+="$num"
    done
    data_array+="]"
    
    local json_data=$(jq -n \
        --arg op "$operation" \
        --argjson data "$data_array" \
        '{operation: $op, data: $data}')
    
    echo -e "${BLUE}üßÆ Calculating: $operation${NC}"
    response=$(api_request "POST" "/api/v1/math/calculate" "$json_data")
    
    if [[ $? -eq 0 ]]; then
        result=$(echo "$response" | jq -r '.data.result // "error"')
        echo -e "${GREEN}Result:${NC} $result"
        
        if [[ "$OUTPUT_FORMAT" == "json" ]]; then
            echo "$response" | jq '.data'
        fi
    else
        echo -e "${RED}‚úó${NC} Calculation failed"
        exit 1
    fi
}

# Command: stats - Statistical analysis
cmd_stats() {
    local analysis_type="${1:-descriptive}"
    shift
    local data_array="["
    
    # Build array from arguments
    for num in "$@"; do
        if [[ "$data_array" != "[" ]]; then
            data_array+=","
        fi
        data_array+="$num"
    done
    data_array+="]"
    
    local json_data=$(jq -n \
        --argjson data "$data_array" \
        --arg analyses "$analysis_type" \
        '{data: $data, analyses: [$analyses]}')
    
    echo -e "${BLUE}üìä Performing statistical analysis: $analysis_type${NC}"
    response=$(api_request "POST" "/api/v1/math/statistics" "$json_data")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Statistics:${NC}"
        echo "$response" | jq '.data.results.descriptive' 2>/dev/null || echo "$response" | jq '.data'
    else
        echo -e "${RED}‚úó${NC} Statistical analysis failed"
        exit 1
    fi
}

# Command: matrix - Matrix operations
cmd_matrix() {
    local operation="$1"
    local matrix_file="${2:-}"
    
    if [[ ! -f "$matrix_file" ]]; then
        echo -e "${RED}‚úó${NC} Matrix file not found: $matrix_file"
        exit 1
    fi
    
    local matrix_data=$(cat "$matrix_file")
    
    local json_data=$(jq -n \
        --arg op "matrix_$operation" \
        --argjson matrix "$matrix_data" \
        '{operation: $op, matrix: $matrix}')
    
    echo -e "${BLUE}üî¢ Performing matrix operation: $operation${NC}"
    response=$(api_request "POST" "/api/v1/math/calculate" "$json_data")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Result:${NC}"
        echo "$response" | jq '.data.result' 2>/dev/null || echo "$response" | jq '.data'
    else
        echo -e "${RED}‚úó${NC} Matrix operation failed"
        exit 1
    fi
}

# Command: solve - Solve equations
cmd_solve() {
    local equation="$1"
    local variables="${2:-x}"
    
    local json_data=$(jq -n \
        --arg eq "$equation" \
        --arg vars "$variables" \
        '{equations: [$eq], variables: [$vars]}')
    
    echo -e "${BLUE}üîç Solving equation: $equation${NC}"
    response=$(api_request "POST" "/api/v1/math/solve" "$json_data")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Solutions:${NC}"
        echo "$response" | jq '.data' 2>/dev/null
    else
        echo -e "${RED}‚úó${NC} Failed to solve equation"
        exit 1
    fi
}

# Command: model - Model management
cmd_model() {
    local subcommand="${1:-list}"
    shift
    
    case "$subcommand" in
        list)
            echo -e "${BLUE}üìã Listing mathematical models...${NC}"
            response=$(api_request "GET" "/api/v1/models")
            if [[ $? -eq 0 ]]; then
                echo "$response" | jq '.data' 2>/dev/null || echo "$response"
            fi
            ;;
        create)
            local name="$1"
            local model_type="${2:-linear_regression}"
            local formula="${3:-}"
            
            local json_data=$(jq -n \
                --arg n "$name" \
                --arg t "$model_type" \
                --arg f "$formula" \
                '{name: $n, model_type: $t, formula: $f}')
            
            echo -e "${BLUE}‚ú® Creating model: $name${NC}"
            response=$(api_request "POST" "/api/v1/models" "$json_data")
            if [[ $? -eq 0 ]]; then
                echo -e "${GREEN}‚úì${NC} Model created successfully"
                echo "$response" | jq '.data' 2>/dev/null
            fi
            ;;
        get)
            local id="$1"
            echo -e "${BLUE}üîç Getting model: $id${NC}"
            response=$(api_request "GET" "/api/v1/models/$id")
            if [[ $? -eq 0 ]]; then
                echo "$response" | jq '.data' 2>/dev/null || echo "$response"
            fi
            ;;
        delete)
            local id="$1"
            echo -e "${YELLOW}üóëÔ∏è  Deleting model: $id${NC}"
            response=$(api_request "DELETE" "/api/v1/models/$id")
            if [[ $? -eq 0 ]]; then
                echo -e "${GREEN}‚úì${NC} Model deleted successfully"
            fi
            ;;
        *)
            echo "Unknown model subcommand: $subcommand"
            echo "Usage: $CLI_NAME model [list|create|get|delete]"
            exit 1
            ;;
    esac
}

# Command: help
cmd_help() {
    cat <<EOF
${BLUE}Math Tools CLI${NC} v${CLI_VERSION}
Comprehensive mathematical computation and analysis platform

${YELLOW}Usage:${NC}
  $CLI_NAME <command> [arguments]

${YELLOW}Available Commands:${NC}
  status              Check API health status
  help                Show this help message
  version             Show CLI version
  
${YELLOW}Calculation Commands:${NC}
  calc <op> <nums...> Perform basic calculations
    Operations: add, subtract, multiply, divide, power, sqrt, log, exp,
                mean, median, mode, stddev, variance,
                prime_factors, gcd, lcm
    
    Examples:
      $CLI_NAME calc add 1 2 3 4 5
      $CLI_NAME calc mean 10 20 30 40 50
      $CLI_NAME calc power 2 8
      $CLI_NAME calc gcd 48 18
      
  stats [type] <nums...>  Perform statistical analysis
    Types: descriptive, correlation, regression
    
    Example:
      $CLI_NAME stats descriptive 1 2 3 4 5 6 7 8 9 10
      
  matrix <op> <file>  Perform matrix operations
    Operations: transpose, determinant, inverse, multiply
    File should contain JSON array representation of matrix
    
    Example:
      echo '[[1,2],[3,4]]' > matrix.json
      $CLI_NAME matrix transpose matrix.json
      
  solve <equation> [variables]  Solve equations
    
    Example:
      $CLI_NAME solve "x^2 - 4 = 0" x
      
${YELLOW}Model Management:${NC}
  model list                    List all models
  model create <name> <type>    Create new model
  model get <id>                Get model details
  model delete <id>             Delete model
  
${YELLOW}Configuration:${NC}
  configure api_base <url>      Set API base URL
  configure api_token <token>   Set API token
  configure output_format <fmt> Set output format (json|table|raw)
  configure precision <n>       Set calculation precision

${YELLOW}Examples:${NC}
  # Basic arithmetic
  $CLI_NAME calc add 10 20 30
  
  # Statistics
  $CLI_NAME stats descriptive 1 2 3 4 5 6 7 8 9 10
  
  # Matrix operations
  echo '[[1,2,3],[4,5,6],[7,8,9]]' > matrix.json
  $CLI_NAME matrix determinant matrix.json
  
  # Model management
  $CLI_NAME model create "Linear Regression Model" linear_regression
  $CLI_NAME model list

${YELLOW}Environment Variables:${NC}
  MATH_TOOLS_API_BASE    Override API base URL
  MATH_TOOLS_API_TOKEN   Override API token

EOF
}

# Command: version
cmd_version() {
    echo "$CLI_NAME version $CLI_VERSION"
}

# Command: configure
cmd_configure() {
    local key="$1"
    local value="$2"
    
    case "$key" in
        api_base|api_token|output_format|precision)
            jq --arg k "$key" --arg v "$value" '.[$k] = $v' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
            echo -e "${GREEN}‚úì${NC} Configuration updated: $key = $value"
            ;;
        *)
            echo -e "${RED}‚úó${NC} Unknown configuration key: $key"
            echo "Valid keys: api_base, api_token, output_format, precision"
            exit 1
            ;;
    esac
}

# Main entry point
main() {
    # Initialize configuration
    init_config
    load_config

    # Override API base with environment variable if set
    API_BASE="${MATH_TOOLS_API_BASE:-$API_BASE}"

    # Parse command
    local command="${1:-help}"
    shift || true
    
    case "$command" in
        status)
            cmd_status
            ;;
        calc)
            if [[ $# -lt 2 ]]; then
                echo "Usage: $CLI_NAME calc <operation> <numbers...>"
                exit 1
            fi
            cmd_calc "$@"
            ;;
        stats)
            if [[ $# -lt 1 ]]; then
                echo "Usage: $CLI_NAME stats [analysis_type] <numbers...>"
                exit 1
            fi
            cmd_stats "$@"
            ;;
        matrix)
            if [[ $# -lt 2 ]]; then
                echo "Usage: $CLI_NAME matrix <operation> <matrix_file>"
                exit 1
            fi
            cmd_matrix "$@"
            ;;
        solve)
            if [[ $# -lt 1 ]]; then
                echo "Usage: $CLI_NAME solve <equation> [variables]"
                exit 1
            fi
            cmd_solve "$@"
            ;;
        model)
            cmd_model "$@"
            ;;
        configure)
            if [[ $# -lt 2 ]]; then
                echo "Usage: $CLI_NAME configure <key> <value>"
                exit 1
            fi
            cmd_configure "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        version|--version|-v)
            cmd_version
            ;;
        *)
            echo -e "${RED}‚úó${NC} Unknown command: $command"
            echo "Run '$CLI_NAME help' for usage information"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"