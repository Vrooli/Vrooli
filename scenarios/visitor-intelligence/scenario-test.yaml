version: 1.0
scenario: visitor-intelligence

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/visitor-intelligence
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - ui/tracker.js
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/storage
    - initialization/storage/postgres
    - ui
    - test

# Resource validation
resources:
  required: [postgres, redis]
  optional: [ollama]
  health_timeout: 60

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL is accessible"
    type: postgres
    service: postgres
    query: "SELECT 1"
    expect:
      connected: true
      
  - name: "Redis is accessible" 
    type: tcp
    service: redis
    port: "${RESOURCE_PORTS[redis]}"
    expect:
      connected: true
      
  # API endpoint tests
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        
  - name: "Visitor tracking endpoint accepts events"
    type: http
    service: api
    endpoint: /api/v1/visitor/track
    method: POST
    headers:
      Content-Type: "application/json"
    body:
      fingerprint: "test-fingerprint-123"
      event_type: "pageview"
      scenario: "test-scenario"
      page_url: "http://localhost:3000/test"
      properties:
        test: true
    expect:
      status: 201
      body:
        success: true
        
  - name: "Analytics endpoint returns data"
    type: http
    service: api
    endpoint: /api/v1/analytics/scenario/test-scenario
    method: GET
    expect:
      status: 200
      body:
        scenario: "test-scenario"
        
  # CLI command tests
  - name: "CLI status command works"
    type: exec
    command: ./cli/visitor-intelligence status --json
    expect:
      exit_code: 0
      output_contains: ["healthy"]
      
  - name: "CLI help command works"
    type: exec
    command: ./cli/visitor-intelligence help
    expect:
      exit_code: 0
      output_contains: ["visitor-intelligence", "commands"]
      
  # Database schema tests
  - name: "Database schema initialized correctly"
    type: sql
    service: postgres
    query: |
      SELECT COUNT(*) as table_count 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name IN ('visitors', 'visitor_events', 'visitor_sessions')
    expect:
      rows:
        - table_count: 3
        
  - name: "Visitor table has correct structure"
    type: sql
    service: postgres  
    query: |
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'visitors' 
      AND table_schema = 'public'
      ORDER BY column_name
    expect:
      rows_contain:
        - column_name: "id"
        - column_name: "fingerprint"
        - column_name: "first_seen"
        - column_name: "last_seen"
        
  # JavaScript tracking library tests
  - name: "Tracking script is accessible"
    type: http
    service: api
    endpoint: /tracker.js
    method: GET
    expect:
      status: 200
      headers:
        Content-Type: "text/javascript"
        
  # Integration tests
  - name: "End-to-end tracking flow"
    type: exec
    command: ./test/integration-test.sh
    expect:
      exit_code: 0
      output_contains: ["SUCCESS"]
      
  # Performance tests
  - name: "Tracking endpoint performance"
    type: load
    service: api
    endpoint: /api/v1/visitor/track
    method: POST
    body:
      fingerprint: "load-test"
      event_type: "pageview"  
      scenario: "load-test"
    requests: 100
    concurrency: 10
    expect:
      avg_response_time: "< 100ms"
      success_rate: "> 95%"