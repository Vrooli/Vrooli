#!/bin/bash
################################################################################
# Visitor Intelligence CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="visitor-intelligence"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}âŒ Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
usage() {
    echo -e "${CYAN}Visitor Intelligence CLI${NC}"
    echo "Visitor tracking and analytics management"
    echo ""
    echo "Usage: visitor-intelligence [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}track${NC}           Manually track a visitor event"
    echo -e "  ${GREEN}profile${NC}         Retrieve visitor profile and analytics"
    echo -e "  ${GREEN}analytics${NC}       Get analytics for a specific scenario"
    echo -e "  ${GREEN}health${NC}          Check service health"
    echo -e "  ${GREEN}status${NC}          Show operational status and resource health"
    echo ""
    echo "Examples:"
    echo "  visitor-intelligence track pageview my-scenario --page-url /dashboard"
    echo "  visitor-intelligence profile visitor-123 --events"
    echo "  visitor-intelligence analytics my-scenario --timeframe 30d"
    echo "  visitor-intelligence status"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (most commands)"
    echo ""
    echo "For more information: visitor-intelligence <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Track command
cmd_track() {
    local event_type=""
    local scenario=""
    local page_url=""
    local properties="{}"
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --page-url)
                page_url="$2"
                shift 2
                ;;
            --properties)
                properties="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: visitor-intelligence track <event_type> <scenario> [OPTIONS]"
                echo ""
                echo "Manually track a visitor event"
                echo ""
                echo "Arguments:"
                echo "  <event_type>    Type of event (pageview, click, form_focus, etc.)"
                echo "  <scenario>      Scenario name generating the event"
                echo ""
                echo "Options:"
                echo "  --page-url <url>       Page URL for the event"
                echo "  --properties <json>    JSON properties object"
                echo "  --json                 Output response in JSON format"
                echo ""
                echo "Examples:"
                echo "  visitor-intelligence track pageview my-scenario"
                echo "  visitor-intelligence track click my-scenario --page-url /dashboard"
                echo "  visitor-intelligence track form_focus my-scenario --properties '{\"field\":\"email\"}'"
                return 0
                ;;
            -*) 
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
            *)
                if [[ -z "$event_type" ]]; then
                    event_type="$1"
                elif [[ -z "$scenario" ]]; then
                    scenario="$1"
                else
                    echo -e "${RED}âŒ Unknown argument: $1${NC}" >&2
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    if [[ -z "$event_type" || -z "$scenario" ]]; then
        echo -e "${RED}âŒ Error: EVENT_TYPE and SCENARIO are required${NC}" >&2
        echo "Usage: visitor-intelligence track <event_type> <scenario> [OPTIONS]" >&2
        return 1
    fi
    
    # Set default page URL if not provided
    if [[ -z "$page_url" ]]; then
        page_url="http://localhost/cli-tracking"
    fi
    
    # Generate a CLI fingerprint
    local fingerprint="cli-$(date +%s)-$(whoami)"
    
    # Create JSON payload
    local request_body
    request_body=$(jq -n \
        --arg fingerprint "$fingerprint" \
        --arg event_type "$event_type" \
        --arg scenario "$scenario" \
        --arg page_url "$page_url" \
        --argjson properties "$properties" \
        '{
            fingerprint: $fingerprint,
            event_type: $event_type,
            scenario: $scenario,
            page_url: $page_url,
            properties: $properties
        }')
    
    echo -e "${BLUE}ðŸ“Š Tracking event: $event_type for scenario: $scenario${NC}"
    echo ""
    
    local response
    response=$(api_request "POST" "/api/v1/visitor/track" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local success=$(echo "$response" | jq -r '.success // false' 2>/dev/null)
        local visitor_id=$(echo "$response" | jq -r '.visitor_id // ""' 2>/dev/null)
        
        if [[ "$success" == "true" ]]; then
            echo -e "${GREEN}âœ… Event tracked successfully${NC}"
            if [[ -n "$visitor_id" && "$visitor_id" != "null" ]]; then
                echo "   Visitor ID: $visitor_id"
            fi
        else
            echo -e "${RED}âŒ Failed to track event${NC}"
            local message=$(echo "$response" | jq -r '.message // "Unknown error"' 2>/dev/null)
            echo "   Error: $message"
            return 1
        fi
    fi
}

# Profile command
cmd_profile() {
    local visitor_id=""
    local include_events=false
    local include_sessions=false
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --events)
                include_events=true
                shift
                ;;
            --sessions)
                include_sessions=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: visitor-intelligence profile <visitor_id> [OPTIONS]"
                echo ""
                echo "Retrieve visitor profile and analytics"
                echo ""
                echo "Arguments:"
                echo "  <visitor_id>    Visitor ID to retrieve"
                echo ""
                echo "Options:"
                echo "  --events        Include visitor events in output"
                echo "  --sessions      Include session data in output"
                echo "  --json          Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  visitor-intelligence profile visitor-123"
                echo "  visitor-intelligence profile visitor-123 --events --sessions"
                echo "  visitor-intelligence profile visitor-123 --json"
                return 0
                ;;
            -*) 
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
            *)
                if [[ -z "$visitor_id" ]]; then
                    visitor_id="$1"
                else
                    echo -e "${RED}âŒ Unknown argument: $1${NC}" >&2
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    if [[ -z "$visitor_id" ]]; then
        echo -e "${RED}âŒ Error: VISITOR_ID is required${NC}" >&2
        echo "Usage: visitor-intelligence profile <visitor_id> [OPTIONS]" >&2
        return 1
    fi
    
    # Build query parameters
    local endpoint="/api/v1/visitor/${visitor_id}"
    local query_params=""
    
    if [[ "$include_events" == true ]]; then
        query_params+="include_events=true&"
    fi
    if [[ "$include_sessions" == true ]]; then
        query_params+="include_sessions=true&"
    fi
    
    if [[ -n "$query_params" ]]; then
        endpoint+="?${query_params%&}"
    fi
    
    echo -e "${BLUE}ðŸ‘¤ Retrieving profile for visitor: $visitor_id${NC}"
    echo ""
    
    local response
    response=$(api_request "GET" "$endpoint")
    
    # Check if visitor was found (simple check for 404-like response)
    if echo "$response" | grep -q "not found" || [[ -z "$response" ]]; then
        echo -e "${RED}âŒ Visitor not found: $visitor_id${NC}"
        return 1
    fi
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        # Pretty print visitor profile
        echo -e "${GREEN}Visitor Profile:${NC}"
        echo "$response" | jq -r '
            "",
            "ID: \(.id)",
            "Fingerprint: \(.fingerprint)",
            "First Seen: \(.first_seen)",
            "Last Seen: \(.last_seen)",
            "Session Count: \(.session_count)",
            "Identified: \(if .identified then "Yes" else "No" end)",
            "Email: \(.email // "Not provided")",
            "Total Page Views: \(.total_page_views)",
            "Total Session Duration: \(.total_session_duration // 0)s",
            "Device Type: \(.device_type // "Unknown")",
            "User Agent: \(.user_agent // "Not available")"' 2>/dev/null || echo "$response"
    fi
}

# Analytics command
cmd_analytics() {
    local scenario=""
    local timeframe="7d"
    local format="table"
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --timeframe)
                timeframe="$2"
                shift 2
                ;;
            --format)
                format="$2"
                shift 2
                ;;
            --json)
                format="json"
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: visitor-intelligence analytics <scenario> [OPTIONS]"
                echo ""
                echo "Get analytics for a specific scenario"
                echo ""
                echo "Arguments:"
                echo "  <scenario>      Scenario name for analytics"
                echo ""
                echo "Options:"
                echo "  --timeframe <period>   Time period (1d, 7d, 30d, 90d) [default: 7d]"
                echo "  --format <format>      Output format (table, json, csv) [default: table]"
                echo "  --json                 Same as --format json"
                echo ""
                echo "Examples:"
                echo "  visitor-intelligence analytics my-scenario"
                echo "  visitor-intelligence analytics my-scenario --timeframe 30d"
                echo "  visitor-intelligence analytics my-scenario --format csv"
                return 0
                ;;
            -*) 
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
            *)
                if [[ -z "$scenario" ]]; then
                    scenario="$1"
                else
                    echo -e "${RED}âŒ Unknown argument: $1${NC}" >&2
                    return 1
                fi
                shift
                ;;
        esac
    done
    
    if [[ -z "$scenario" ]]; then
        echo -e "${RED}âŒ Error: SCENARIO is required${NC}" >&2
        echo "Usage: visitor-intelligence analytics <scenario> [OPTIONS]" >&2
        return 1
    fi
    
    echo -e "${BLUE}ðŸ“ˆ Retrieving analytics for scenario: $scenario (timeframe: $timeframe)${NC}"
    echo ""
    
    local endpoint="/api/v1/analytics/scenario/${scenario}?timeframe=${timeframe}"
    
    local response
    response=$(api_request "GET" "$endpoint")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        case "$format" in
            json)
                echo "$response" | format_json
                ;;
            csv)
                # Convert JSON to CSV format
                echo "metric,value"
                echo "$response" | jq -r '
                    "unique_visitors,\(.unique_visitors // 0)",
                    "total_sessions,\(.total_sessions // 0)",
                    "avg_session_duration,\(.avg_session_duration // 0)",
                    "total_page_views,\(.total_page_views // 0)",
                    "bounce_rate,\(.bounce_rate // 0)",
                    "identified_visitors,\(.identified_visitors // 0)"' 2>/dev/null || echo "$response"
                ;;
            *)
                # Table format
                echo -e "${GREEN}Analytics Summary:${NC}"
                echo "$response" | jq -r '
                    "",
                    "ðŸ“Š Unique Visitors:      \(.unique_visitors // 0)",
                    "ðŸ”„ Total Sessions:       \(.total_sessions // 0)",
                    "â±ï¸  Avg Session Duration: \(.avg_session_duration // 0)s",
                    "ðŸ“„ Total Page Views:     \(.total_page_views // 0)",
                    "ðŸ“ˆ Bounce Rate:          \((.bounce_rate // 0) * 100 | floor)%",
                    "ðŸ‘¤ Identified Visitors:  \(.identified_visitors // 0)"' 2>/dev/null || echo "$response"
                ;;
        esac
    fi
}

# Health check command
cmd_health() {
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/health")
    
    if echo "$response" | jq -e '.status' >/dev/null 2>&1; then
        local status=$(echo "$response" | jq -r '.status')
        case "$status" in
            "healthy")
                echo -e "${GREEN}âœ… Visitor Intelligence is healthy${NC}"
                ;;
            "degraded")
                echo -e "${YELLOW}âš ï¸ Visitor Intelligence is degraded${NC}"
                ;;
            *)
                echo -e "${RED}âŒ Visitor Intelligence status: $status${NC}"
                ;;
        esac
        
        echo "   API: ${api_url}"
        echo "   Timestamp: $(echo "$response" | jq -r '.timestamp' 2>/dev/null)"
        
        # Show service statuses
        echo ""
        echo -e "${BLUE}Services:${NC}"
        echo "$response" | jq -r '.services | to_entries[] | "   \(.key): \(.value)"' 2>/dev/null
    else
        echo -e "${RED}âŒ Health check failed${NC}"
        echo "   Response: $response"
        return 1
    fi
}

# Status command
cmd_status() {
    local verbose=false
    local json_output=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --verbose)
                verbose=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: visitor-intelligence status [OPTIONS]"
                echo ""
                echo "Show operational status and resource health"
                echo ""
                echo "Options:"
                echo "  --verbose      Show detailed status information"
                echo "  --json         Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  visitor-intelligence status"
                echo "  visitor-intelligence status --verbose"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${CYAN}ðŸ“Š Visitor Intelligence Status${NC}"
    echo ""
    
    # Check API
    if api_url=$(get_api_url 2>/dev/null); then
        echo -e "API Server: ${GREEN}âœ… Running${NC}"
        echo "   URL: $api_url"
        
        # Get health info
        local health_response
        health_response=$(curl -s "${api_url}/health" 2>/dev/null)
        if [[ -n "$health_response" ]]; then
            if [[ $json_output == true ]]; then
                echo "$health_response" | format_json
            else
                local status=$(echo "$health_response" | jq -r '.status // "unknown"' 2>/dev/null)
                echo "   Overall Status: $status"
                
                if [[ $verbose == true ]]; then
                    echo "   Services:"
                    echo "$health_response" | jq -r '.services | to_entries[] | "      \(.key): \(.value)"' 2>/dev/null || echo "      Unable to parse service status"
                fi
            fi
        fi
    else
        echo -e "API Server: ${RED}âŒ Not Running${NC}"
        echo "   Start with: vrooli scenario run visitor-intelligence"
    fi
    
    # Check UI if available
    local ui_port
    ui_port=$(vrooli scenario port "${SCENARIO_NAME}" UI_PORT 2>/dev/null)
    if [[ -n "$ui_port" ]]; then
        if curl -sf "http://localhost:${ui_port}" >/dev/null 2>&1; then
            echo -e "UI Server:  ${GREEN}âœ… Running${NC} (port $ui_port)"
            echo "   Dashboard: http://localhost:${ui_port}"
        else
            echo -e "UI Server:  ${YELLOW}âš ï¸ Check connection${NC}"
        fi
    fi
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        track)
            cmd_track "$@"
            ;;
        profile)
            cmd_profile "$@"
            ;;
        analytics)
            cmd_analytics "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        version|--version|-v)
            echo "Visitor Intelligence CLI v2.0.0 (thin wrapper)"
            local api_url
            if api_url=$(get_api_url 2>/dev/null); then
                echo "API: $api_url"
            fi
            ;;
        *)
            echo -e "${RED}âŒ Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"