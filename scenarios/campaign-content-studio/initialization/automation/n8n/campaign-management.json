{
  "name": "Campaign Content Studio - Campaign Management",
  "nodes": [
    {
      "parameters": {
        "path": "campaign-content-studio/campaigns",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "campaign-webhook",
      "name": "Campaign Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "campaign-management-webhook"
    },
    
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Campaign Management Router\nconst method = $json.method || $node.context.httpMethod;\nconst operation = $json.operation;\nconst campaignData = $json.campaign || {};\n\n// Extract and validate request\nconst request = {\n  operation: operation,\n  method: method,\n  timestamp: new Date().toISOString(),\n  session_id: $json.session_id,\n  user_identifier: $json.user_identifier || 'system',\n  campaign_data: campaignData\n};\n\n// Route based on operation\nswitch(operation) {\n  case 'create':\n    return {\n      ...request,\n      route: 'create_campaign',\n      sql_operation: 'INSERT',\n      campaign_name: campaignData.name,\n      description: campaignData.description,\n      brand_guidelines: campaignData.brand_guidelines || {},\n      content_preferences: campaignData.content_preferences || {},\n      target_audience: campaignData.target_audience || ''\n    };\n    \n  case 'read':\n  case 'list':\n    return {\n      ...request,\n      route: 'list_campaigns',\n      sql_operation: 'SELECT',\n      filters: campaignData.filters || {},\n      include_inactive: campaignData.include_inactive || false\n    };\n    \n  case 'update':\n    return {\n      ...request,\n      route: 'update_campaign',\n      sql_operation: 'UPDATE',\n      campaign_id: campaignData.id,\n      updates: campaignData.updates || {}\n    };\n    \n  case 'delete':\n    return {\n      ...request,\n      route: 'delete_campaign', \n      sql_operation: 'DELETE',\n      campaign_id: campaignData.id,\n      soft_delete: campaignData.soft_delete !== false\n    };\n    \n  case 'switch':\n    return {\n      ...request,\n      route: 'switch_campaign',\n      sql_operation: 'UPDATE',\n      campaign_id: campaignData.id,\n      session_id: $json.session_id\n    };\n    \n  default:\n    throw new Error(`Unknown operation: ${operation}`);\n}"
      },
      "id": "route-operation",
      "name": "Route Operation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "create_campaign"
            }
          ]
        }
      },
      "id": "if-create",
      "name": "If Create Campaign",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 200]
    },
    
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "list_campaigns"
            }
          ]
        }
      },
      "id": "if-list",
      "name": "If List Campaigns",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "update_campaign"
            }
          ]
        }
      },
      "id": "if-update",
      "name": "If Update Campaign",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 400]
    },
    
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.route }}",
              "value2": "switch_campaign"
            }
          ]
        }
      },
      "id": "if-switch",
      "name": "If Switch Campaign",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 500]
    },
    
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO campaign_content_studio.campaigns (name, description, brand_guidelines, content_preferences, target_audience) VALUES ($1, $2, $3::jsonb, $4::jsonb, $5) RETURNING id, name, created_at",
        "additionalFields": {
          "mode": "independently"
        },
        "options": {}
      },
      "id": "create-campaign-db",
      "name": "Create Campaign DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [900, 200],
      "credentials": {
        "postgres": {
          "id": "campaign-content-studio-postgres",
          "name": "Campaign Content Studio PostgreSQL"
        }
      }
    },
    
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT c.id, c.name, c.description, c.brand_guidelines, c.content_preferences, c.target_audience, c.created_at, c.is_active, COUNT(DISTINCT cd.id) as document_count, COUNT(DISTINCT gc.id) as content_count FROM campaign_content_studio.campaigns c LEFT JOIN campaign_content_studio.campaign_documents cd ON c.id = cd.campaign_id LEFT JOIN campaign_content_studio.generated_content gc ON c.id = gc.campaign_id WHERE ($1::boolean = true OR c.is_active = true) GROUP BY c.id, c.name, c.description, c.brand_guidelines, c.content_preferences, c.target_audience, c.created_at, c.is_active ORDER BY c.created_at DESC",
        "additionalFields": {
          "mode": "independently"
        },
        "options": {}
      },
      "id": "list-campaigns-db",
      "name": "List Campaigns DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [900, 300],
      "credentials": {
        "postgres": {
          "id": "campaign-content-studio-postgres",
          "name": "Campaign Content Studio PostgreSQL"
        }
      }
    },
    
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE campaign_content_studio.campaigns SET name = COALESCE($2, name), description = COALESCE($3, description), brand_guidelines = COALESCE($4::jsonb, brand_guidelines), content_preferences = COALESCE($5::jsonb, content_preferences), target_audience = COALESCE($6, target_audience), updated_at = NOW() WHERE id = $1::uuid RETURNING id, name, updated_at",
        "additionalFields": {
          "mode": "independently"
        },
        "options": {}
      },
      "id": "update-campaign-db",
      "name": "Update Campaign DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [900, 400],
      "credentials": {
        "postgres": {
          "id": "campaign-content-studio-postgres",
          "name": "Campaign Content Studio PostgreSQL"
        }
      }
    },
    
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE campaign_content_studio.user_sessions SET current_campaign_id = $1::uuid, last_activity = NOW() WHERE session_id = $2 RETURNING current_campaign_id, session_id",
        "additionalFields": {
          "mode": "independently"
        },
        "options": {}
      },
      "id": "switch-campaign-db",
      "name": "Switch Campaign DB",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [900, 500],
      "credentials": {
        "postgres": {
          "id": "campaign-content-studio-postgres",
          "name": "Campaign Content Studio PostgreSQL"
        }
      }
    },
    
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO campaign_content_studio.activity_log (event_type, event_data, campaign_id, session_id, user_identifier, status) VALUES ($1, $2::jsonb, $3::uuid, (SELECT id FROM campaign_content_studio.user_sessions WHERE session_id = $4), $5, 'completed')",
        "additionalFields": {
          "mode": "independently"
        },
        "options": {}
      },
      "id": "log-activity",
      "name": "Log Activity",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1120, 350],
      "credentials": {
        "postgres": {
          "id": "campaign-content-studio-postgres",
          "name": "Campaign Content Studio PostgreSQL"
        }
      }
    },
    
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Build response based on operation\nconst inputData = $input.item.json;\nconst operation = inputData.route;\nconst dbResult = inputData.id ? inputData : null; // Database result\n\nlet response = {\n  success: true,\n  operation: operation,\n  timestamp: new Date().toISOString(),\n  data: null\n};\n\nswitch(operation) {\n  case 'create_campaign':\n    response.data = {\n      campaign: dbResult,\n      message: `Campaign '${dbResult.name}' created successfully`\n    };\n    break;\n    \n  case 'list_campaigns':\n    response.data = {\n      campaigns: inputData.campaigns || [inputData],\n      total_count: Array.isArray(inputData.campaigns) ? inputData.campaigns.length : 1\n    };\n    break;\n    \n  case 'update_campaign':\n    response.data = {\n      campaign: dbResult,\n      message: `Campaign '${dbResult.name}' updated successfully`\n    };\n    break;\n    \n  case 'switch_campaign':\n    response.data = {\n      current_campaign_id: dbResult.current_campaign_id,\n      session_id: dbResult.session_id,\n      message: 'Campaign switched successfully'\n    };\n    break;\n    \n  default:\n    response.data = {\n      message: 'Operation completed successfully'\n    };\n}\n\nreturn response;"
      },
      "id": "build-response",
      "name": "Build Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 350]
    }
  ],
  
  "connections": {
    "Campaign Webhook": {
      "main": [
        [
          {
            "node": "Route Operation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "Route Operation": {
      "main": [
        [
          {
            "node": "If Create Campaign",
            "type": "main",
            "index": 0
          },
          {
            "node": "If List Campaigns", 
            "type": "main",
            "index": 0
          },
          {
            "node": "If Update Campaign",
            "type": "main",
            "index": 0
          },
          {
            "node": "If Switch Campaign",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "If Create Campaign": {
      "main": [
        [
          {
            "node": "Create Campaign DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "If List Campaigns": {
      "main": [
        [
          {
            "node": "List Campaigns DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "If Update Campaign": {
      "main": [
        [
          {
            "node": "Update Campaign DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "If Switch Campaign": {
      "main": [
        [
          {
            "node": "Switch Campaign DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "Create Campaign DB": {
      "main": [
        [
          {
            "node": "Log Activity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "List Campaigns DB": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "Update Campaign DB": {
      "main": [
        [
          {
            "node": "Log Activity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "Switch Campaign DB": {
      "main": [
        [
          {
            "node": "Log Activity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "Log Activity": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  
  "versionId": "campaign-management-v1",
  "id": "campaign-content-studio-campaign-mgmt",
  
  "meta": {
    "templateCreatedBy": "campaign-content-studio",
    "instanceId": "campaign-management"
  },
  
  "tags": [
    {
      "id": "campaign-content-studio",
      "name": "Campaign Content Studio"
    },
    {
      "id": "campaign-management",
      "name": "Campaign Management"
    }
  ]
}