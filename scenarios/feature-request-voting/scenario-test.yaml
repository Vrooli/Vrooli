version: 1.0
scenario: feature-request-voting

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - README.md
    - api/main.go
    - api/go.mod
    - cli/feature-voting
    - cli/install.sh
    - initialization/postgres/schema.sql
    - initialization/postgres/seed.sql
    - ui/package.json
    - ui/index.html
    - ui/src/App.jsx
    - ui/src/main.jsx
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/postgres
    - ui
    - ui/src
    - ui/src/components
    - ui/src/services

# Resource validation
resources:
  required: 
    - postgres
  optional: 
    - redis
    - scenario-authenticator
  health_timeout: 60

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL is accessible"
    type: exec
    command: resource-postgres status
    expect:
      exit_code: 0
      
  - name: "PostgreSQL schema is initialized"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('scenarios', 'feature_requests', 'votes')"
    expect:
      rows:
        - count: 3
      
  # API build and health tests
  - name: "API builds successfully"
    type: exec
    command: cd api && go build -o test-build . && rm test-build
    expect:
      exit_code: 0
      
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        
  # API functionality tests
  - name: "API lists scenarios"
    type: http
    service: api
    endpoint: /api/v1/scenarios
    method: GET
    expect:
      status: 200
      
  - name: "API creates feature request"
    type: http
    service: api
    endpoint: /api/v1/feature-requests
    method: POST
    body:
      scenario_id: "11111111-1111-1111-1111-111111111111"
      title: "Test Feature Request"
      description: "This is a test feature request"
      priority: "medium"
    expect:
      status: 201
      body:
        success: true
        
  - name: "API lists feature requests"
    type: http
    service: api
    endpoint: /api/v1/scenarios/11111111-1111-1111-1111-111111111111/feature-requests
    method: GET
    expect:
      status: 200
      
  # CLI tests
  - name: "CLI is executable"
    type: exec
    command: test -x cli/feature-voting
    expect:
      exit_code: 0
      
  - name: "CLI shows help"
    type: exec
    command: ./cli/feature-voting --help
    expect:
      exit_code: 0
      output_contains: 
        - "Feature Request Voting CLI"
        - "USAGE:"
        - "COMMANDS:"
        
  - name: "CLI shows version"
    type: exec
    command: ./cli/feature-voting version --json
    expect:
      exit_code: 0
      output_contains:
        - "version"
        - "1.0.0"
        
  - name: "CLI checks API status"
    type: exec
    command: ./cli/feature-voting status
    expect:
      exit_code: 0
      output_contains:
        - "healthy"
        
  # UI build tests
  - name: "UI dependencies install"
    type: exec
    command: cd ui && npm install
    timeout: 300000
    expect:
      exit_code: 0
      
  - name: "UI builds successfully"
    type: exec
    command: cd ui && npm run build
    timeout: 300000
    expect:
      exit_code: 0
      
  - name: "UI build output exists"
    type: exec
    command: test -d ui/dist
    expect:
      exit_code: 0
      
  # Integration tests
  - name: "Create and vote on feature request via CLI"
    type: exec
    command: |
      # Create request
      REQUEST_ID=$(./cli/feature-voting create "Test CLI Feature" "Testing from CLI" --scenario study-buddy --json | jq -r '.id')
      
      # Vote on it
      ./cli/feature-voting vote $REQUEST_ID --up
      
      # Verify vote was recorded
      ./cli/feature-voting list study-buddy --json | jq -e ".requests[] | select(.id == \"$REQUEST_ID\") | .vote_count > 0"
    expect:
      exit_code: 0
      
  # Performance tests
  - name: "API response time is acceptable"
    type: http
    service: api
    endpoint: /api/v1/scenarios
    method: GET
    expect:
      status: 200
      response_time_ms: 500
      
  - name: "Database query performance"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM feature_requests WHERE scenario_id = '11111111-1111-1111-1111-111111111111'"
    expect:
      response_time_ms: 100

# Validation criteria
validation:
  - All required files and directories exist
  - PostgreSQL schema is properly initialized
  - API builds and responds to health checks
  - CLI is functional and can interact with API
  - UI builds without errors
  - Feature requests can be created and voted on
  - Response times meet performance targets