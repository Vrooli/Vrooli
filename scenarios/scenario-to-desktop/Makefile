# Scenario Makefile
#
# This Makefile ensures scenarios are always run through the Vrooli lifecycle system.
# NEVER run scenarios directly (./api/scenario-to-desktop-api). ALWAYS use these commands.
#
# Usage:
#   make       - Show help
#   make start - Start this scenario
#   make stop  - Stop this scenario
#   make test  - Run scenario tests
#   make logs  - Show scenario logs
#   make clean - Clean build artifacts

.PHONY: help start run stop dev test logs logs-follow status clean build build-all build-linux build-macos build-windows deps fmt fmt-go fmt-ui vet lint lint-go lint-ui check docker-build docker-run health docs version validate

# Default target - show help
.DEFAULT_GOAL := help

# Get scenario name from directory
SCENARIO_NAME := $(notdir $(CURDIR))

# Color palette for output (standard set only)
GREEN := \033[1;32m
YELLOW := \033[1;33m
BLUE := \033[1;34m
RED := \033[1;31m
RESET := \033[0m

help: ## Show this help message
	@echo "$(BLUE)Scenario-to-Desktop Scenario Commands$(RESET)"
	@echo ""
	@echo "$(YELLOW)Usage:$(RESET)"
	@echo "  make <command>"
	@echo ""
	@echo "$(YELLOW)Commands:$(RESET)"
	@grep -E '^[a-zA-Z0-9_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-18s$(RESET) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(RED)âš ï¸  Always use 'make start' or 'vrooli scenario start $(SCENARIO_NAME)' to run this scenario.$(RESET)"
	@echo "$(RED)   Never run ./api/scenario-to-desktop-api directly!$(RESET)"

# Build configuration
BINARY_NAME := scenario-to-desktop-api
BUILD_DIR := api/bin
GO_FILES := $(shell find api -type f -name '*.go' -not -path "./vendor/*" 2>/dev/null)
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME := $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")

# ============================================================================
# LIFECYCLE COMMANDS - Use Vrooli lifecycle system
# ============================================================================

start: ## Start scenario-to-desktop (via Vrooli lifecycle)
	@echo "$(BLUE)ðŸš€ Starting Scenario-to-Desktop Converter...$(RESET)"
	@echo "$(BLUE)Converting scenarios to desktop applications$(RESET)"
	@vrooli scenario run $(SCENARIO_NAME)

run: start ## Alias for 'make start'

stop: ## Stop scenario-to-desktop
	@echo "$(YELLOW)â¹ï¸  Stopping Scenario-to-Desktop Converter...$(RESET)"
	@vrooli scenario stop $(SCENARIO_NAME)

dev: ## Start in development mode with hot reload
	@echo "$(BLUE)ðŸ”§ Starting in development mode...$(RESET)"
	@vrooli scenario run $(SCENARIO_NAME) --dev

logs: ## Show recent logs
	@echo "$(BLUE)ðŸ“œ Recent Scenario-to-Desktop logs:$(RESET)"
	@vrooli scenario logs $(SCENARIO_NAME) --tail 50

logs-follow: ## Follow logs in real-time
	@echo "$(BLUE)ðŸ“œ Following Scenario-to-Desktop logs...$(RESET)"
	@vrooli scenario logs $(SCENARIO_NAME) --follow

status: ## Check if scenario is running
	@echo "$(BLUE)ðŸ“Š Scenario-to-Desktop Status:$(RESET)"
	@vrooli scenario status $(SCENARIO_NAME)

# ============================================================================
# BUILD COMMANDS - Cross-platform builds
# ============================================================================

build: deps ## Build for current platform
	@echo "$(BLUE)ðŸ—ï¸  Building $(BINARY_NAME)...$(RESET)"
	@mkdir -p $(BUILD_DIR)
	@cd api && CGO_ENABLED=0 go build \
		-ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)" \
		-o bin/$(BINARY_NAME) \
		main.go
	@echo "$(GREEN)âœ“ Built $(BUILD_DIR)/$(BINARY_NAME)$(RESET)"

build-all: deps ## Build for all platforms (Linux, macOS, Windows)
	@echo "$(BLUE)ðŸ—ï¸  Building for all platforms...$(RESET)"
	@$(MAKE) build-linux
	@$(MAKE) build-macos
	@$(MAKE) build-windows
	@echo "$(GREEN)âœ“ All platforms built$(RESET)"

build-linux: ## Build for Linux (amd64 & arm64)
	@echo "$(BLUE)Building for Linux...$(RESET)"
	@mkdir -p $(BUILD_DIR)
	@cd api && GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build \
		-ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)" \
		-o bin/$(BINARY_NAME)-linux-amd64 \
		main.go
	@cd api && GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
		-ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)" \
		-o bin/$(BINARY_NAME)-linux-arm64 \
		main.go
	@echo "  $(GREEN)âœ“$(RESET) Linux builds complete"

build-macos: ## Build for macOS (Intel & Apple Silicon)
	@echo "$(BLUE)Building for macOS...$(RESET)"
	@mkdir -p $(BUILD_DIR)
	@cd api && GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build \
		-ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)" \
		-o bin/$(BINARY_NAME)-darwin-amd64 \
		main.go
	@cd api && GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build \
		-ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)" \
		-o bin/$(BINARY_NAME)-darwin-arm64 \
		main.go
	@echo "  $(GREEN)âœ“$(RESET) macOS builds complete"

build-windows: ## Build for Windows (amd64)
	@echo "$(BLUE)Building for Windows...$(RESET)"
	@mkdir -p $(BUILD_DIR)
	@cd api && GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build \
		-ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)" \
		-o bin/$(BINARY_NAME)-windows-amd64.exe \
		main.go
	@echo "  $(GREEN)âœ“$(RESET) Windows build complete"

# ============================================================================
# DEVELOPMENT COMMANDS
# ============================================================================

test: ## Run tests for this scenario
	@echo "$(BLUE)ðŸ§ª Testing $(SCENARIO_NAME) scenario...$(RESET)"
	@vrooli scenario test $(SCENARIO_NAME)

deps: ## Install/update dependencies
	@echo "$(BLUE)ðŸ“¦ Installing dependencies...$(RESET)"
	@cd api && go mod download
	@cd api && go mod tidy
	@echo "$(GREEN)âœ“ Dependencies installed$(RESET)"

fmt: fmt-go fmt-ui ## Format all code

fmt-go: ## Format Go code
	@echo "$(BLUE)ðŸŽ¨ Formatting Go code...$(RESET)"
	@cd api && go fmt ./...
	@echo "$(GREEN)âœ“ Go format complete$(RESET)"

fmt-ui: ## Format UI code (no-op if no UI formatting tool)
	@echo "$(BLUE)ðŸŽ¨ Formatting UI code...$(RESET)"
	@echo "$(YELLOW)â„¹ UI formatting not configured$(RESET)"

lint: lint-go lint-ui ## Lint all code

lint-go: ## Lint Go code
	@echo "$(BLUE)ðŸ” Linting Go code...$(RESET)"
	@if command -v golangci-lint >/dev/null 2>&1; then \
		cd api && golangci-lint run ./...; \
	else \
		echo "$(YELLOW)â„¹ golangci-lint not installed, skipping$(RESET)"; \
	fi
	@echo "$(GREEN)âœ“ Go lint complete$(RESET)"

lint-ui: ## Lint UI code (no-op if no UI linter)
	@echo "$(BLUE)ðŸ” Linting UI code...$(RESET)"
	@echo "$(YELLOW)â„¹ UI linting not configured$(RESET)"

vet: ## Vet code
	@echo "$(BLUE)ðŸ” Vetting code...$(RESET)"
	@cd api && go vet ./...
	@echo "$(GREEN)âœ“ Vet complete$(RESET)"

check: fmt vet test ## Run fmt, vet, and test
	@echo "$(GREEN)âœ“ All checks passed!$(RESET)"

clean: ## Clean build artifacts
	@echo "$(YELLOW)ðŸ§¹ Cleaning build artifacts...$(RESET)"
	@rm -rf $(BUILD_DIR)
	@cd api && go clean
	@rm -f api/*.log
	@echo "$(GREEN)âœ“ Cleaned$(RESET)"

# ============================================================================
# DOCKER COMMANDS
# ============================================================================

docker-build: ## Build Docker image
	@echo "$(BLUE)ðŸ³ Building Docker image...$(RESET)"
	@cd api && docker build -t $(SCENARIO_NAME):$(VERSION) .
	@echo "$(GREEN)âœ“ Docker image built: $(SCENARIO_NAME):$(VERSION)$(RESET)"

docker-run: docker-build ## Run in Docker container
	@echo "$(BLUE)ðŸ³ Running Docker container...$(RESET)"
	@docker run --rm -p 3202:3202 $(SCENARIO_NAME):$(VERSION)

# ============================================================================
# UTILITY COMMANDS
# ============================================================================

health: ## Check API health
	@echo "$(BLUE)ðŸ’“ Checking API health...$(RESET)"
	@curl -f http://localhost:3202/api/v1/health 2>/dev/null && echo "$(GREEN)âœ“ API is healthy$(RESET)" || echo "$(RED)âœ— API not responding$(RESET)"

docs: ## Show API documentation
	@echo "$(BLUE)ðŸ“š API Endpoints:$(RESET)"
	@echo ""
	@echo "$(YELLOW)Health & Status:$(RESET)"
	@echo "  GET  /api/v1/health                         - Health check"
	@echo "  GET  /api/v1/status                         - System status"
	@echo ""
	@echo "$(YELLOW)Templates:$(RESET)"
	@echo "  GET  /api/v1/templates                      - List templates"
	@echo "  GET  /api/v1/templates/{type}               - Get template details"
	@echo ""
	@echo "$(YELLOW)Desktop Generation:$(RESET)"
	@echo "  POST /api/v1/desktop/generate               - Generate desktop app"
	@echo "  GET  /api/v1/desktop/status/{build_id}      - Get build status"
	@echo "  POST /api/v1/desktop/build                  - Build desktop app"
	@echo "  POST /api/v1/desktop/test                   - Test desktop app"
	@echo "  POST /api/v1/desktop/package                - Package desktop app"
	@echo ""
	@echo "$(YELLOW)Webhooks:$(RESET)"
	@echo "  POST /api/v1/desktop/webhook/build-complete - Build completion webhook"

version: ## Show version info
	@echo "$(YELLOW)Version Information:$(RESET)"
	@echo "  Version:    $(VERSION)"
	@echo "  Build Time: $(BUILD_TIME)"
	@echo "  Go Version: $$(go version | cut -d' ' -f3)"

validate: ## Validate scenario structure
	@echo "$(BLUE)âœ… Validating $(SCENARIO_NAME) structure...$(RESET)"
	@vrooli scenario validate $(SCENARIO_NAME)

install: build ## Install binary to GOPATH/bin
	@echo "$(BLUE)ðŸ“¦ Installing $(BINARY_NAME) to GOPATH/bin...$(RESET)"
	@cp $(BUILD_DIR)/$(BINARY_NAME) $$(go env GOPATH)/bin/
	@echo "$(GREEN)âœ“ Installed to $$(go env GOPATH)/bin/$(BINARY_NAME)$(RESET)"

dev-deps: ## Install development dependencies
	@echo "$(BLUE)ðŸ“¦ Installing development dependencies...$(RESET)"
	@go install github.com/cosmtrek/air@latest
	@go install github.com/tsenart/vegeta@latest
	@echo "$(GREEN)âœ“ Development dependencies installed$(RESET)"

# ============================================================================
# SHORTCUTS
# ============================================================================

r: run
s: stop
d: dev
t: test
l: logs
c: clean
b: build
ba: build-all