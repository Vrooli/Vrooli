# Logging and Debugging Bundled Desktop Apps (Linux)

Use this when you need to run and inspect a packaged AppImage generated by scenario-to-desktop. It is independent of the Tier 1 `.vrooli/service.json` lifecycle; everything here is for the bundled runtime.

## 1) Rebuild the bundle after changes
1. Make your code changes (UI/API/runtime/template).
2. Restart the packager and orchestrator if needed:
   - `vrooli scenario stop scenario-to-desktop && vrooli scenario start scenario-to-desktop`
   - `vrooli scenario stop deployment-manager && vrooli scenario start deployment-manager`
3. Regenerate the desktop bundle/installers (example for a profile):
   - `GPG_PASSPHRASE="<pass>" deployment-manager deploy-desktop --profile <profile-id> --platforms linux --timeout 20m`
   - Artifacts land in `scenarios/<scenario>/platforms/electron/dist-electron/`.

## 2) Run the AppImage with verbose logging
From the scenario’s electron dist directory:
```bash
cd scenarios/<scenario>/platforms/electron/dist-electron
timeout 60s bash -lc '
  ELECTRON_ENABLE_LOGGING=1 ELECTRON_ENABLE_STACK_DUMPING=1 NODE_OPTIONS="" \
  ./"<AppName>-<version>.AppImage" --enable-logging --verbose --disable-gpu \
  2>&1 | tee ~/bundled-app.log
'
```
Notes:
- `--disable-gpu` avoids GPU crashes in VMs/headless.
- `tee` captures stdout/stderr to `~/bundled-app.log` for review.
- Increase timeout for longer sessions.

## 3) Where to find logs after a run
- **Console capture**: the `~/bundled-app.log` file from the run command.
- **Runtime userData** (per-user): `~/.config/<app-name>/` (Electron stores runtime logs and telemetry here).
- **Bundled runtime logs**: `scenarios/<scenario>/platforms/electron/bundle/logs/` (created/updated when services start under the bundled runtime).
- **Telemetry** (if enabled): `~/.config/<app-name>/deployment-telemetry.jsonl`.

## 4) Inspect runtime state
- The runtime prints its IPC port: `runtime ready — IPC listening on 127.0.0.1:<port>`.
- You can query runtime endpoints (read-only) while it runs, e.g. `curl http://127.0.0.1:<port>/ports` to see allocated service ports, or `/validate` for bundle validation status.

## 5) Common fixes when UI loads but APIs fail
- If UI calls return HTML instead of JSON, the UI may be hitting its own static server instead of the API. Check:
  - API service started: look for API logs under `bundle/logs` or the console output.
  - API base URL: set the UI’s API base to the runtime-exposed API port (or configure a proxy from the UI service to the API service).
  - WebSocket path: ensure WS is pointed at the API port/path (or proxied).

## 6) Rerun cycle after further edits
1. Apply code changes.
2. Restart scenarios if they include rebuilt code (scenario-to-desktop, deployment-manager).
3. Regenerate bundle/installers via `deployment-manager deploy-desktop ...`.
4. Re-run the AppImage with the logging command above.

## Quick checklist
- [ ] Rebuild/regenerate installers after any code change.
- [ ] Run AppImage with verbose logging and capture to file.
- [ ] Check `bundle/logs` and `~/.config/<app-name>/` for service logs.
- [ ] Verify API base/WS paths if UI loads but data calls fail.
