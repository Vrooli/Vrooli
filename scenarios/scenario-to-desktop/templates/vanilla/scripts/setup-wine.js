#!/usr/bin/env node

/**
 * Auto-install Wine AppImage for cross-platform Windows builds
 *
 * Wine is required for building Windows executables on Linux.
 * This script downloads and sets up Wine AppImage if:
 * 1. Running on Linux
 * 2. Wine is not already available
 * 3. User is building for Windows target
 *
 * Wine AppImage requires NO sudo - fully portable installation.
 */

const fs = require('fs');
const path = require('path');
const https = require('https');
const { execSync } = require('child_process');
const os = require('os');

const WINE_DIR = path.join(os.homedir(), '.local', 'share', 'wine-appimage');
const WINE_BIN_DIR = path.join(os.homedir(), '.local', 'bin');
const WINE_APPIMAGE_PATH = path.join(WINE_DIR, 'wine.AppImage');
const WINE_WRAPPER_PATH = path.join(WINE_BIN_DIR, 'wine');

// Latest stable Wine AppImage from mmtrt/WINE_AppImage
const WINE_APPIMAGE_URL = 'https://github.com/mmtrt/WINE_AppImage/releases/download/continuous-stable/wine-stable_10.0-x86_64.AppImage';

async function checkWineInstalled() {
  try {
    execSync('wine --version', { stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

async function downloadFile(url, destPath) {
  return new Promise((resolve, reject) => {
    console.log(`ðŸ“¥ Downloading Wine AppImage...`);
    console.log(`   URL: ${url}`);
    console.log(`   Destination: ${destPath}`);

    const file = fs.createWriteStream(destPath);

    https.get(url, (response) => {
      // Follow redirects
      if (response.statusCode === 301 || response.statusCode === 302) {
        const redirectUrl = response.headers.location;
        console.log(`   Following redirect to: ${redirectUrl}`);
        downloadFile(redirectUrl, destPath).then(resolve).catch(reject);
        return;
      }

      if (response.statusCode !== 200) {
        reject(new Error(`Failed to download: HTTP ${response.statusCode}`));
        return;
      }

      const totalBytes = parseInt(response.headers['content-length'] || '0', 10);
      let downloadedBytes = 0;
      let lastPercent = 0;

      response.on('data', (chunk) => {
        downloadedBytes += chunk.length;
        const percent = Math.floor((downloadedBytes / totalBytes) * 100);

        if (percent >= lastPercent + 10) {
          console.log(`   Progress: ${percent}% (${Math.floor(downloadedBytes / 1024 / 1024)}MB / ${Math.floor(totalBytes / 1024 / 1024)}MB)`);
          lastPercent = percent;
        }
      });

      response.pipe(file);

      file.on('finish', () => {
        file.close();
        console.log(`âœ“ Download complete`);
        resolve();
      });
    }).on('error', (err) => {
      fs.unlink(destPath, () => {});
      reject(err);
    });
  });
}

async function setupWineAppImage() {
  console.log('\nðŸ· Wine Auto-Installer for Windows Builds\n');

  // Only run on Linux
  if (os.platform() !== 'linux') {
    console.log('â„¹ï¸  Not on Linux - Wine not required');
    return;
  }

  // Check if Wine is already available
  if (await checkWineInstalled()) {
    console.log('âœ“ Wine is already installed');
    return;
  }

  console.log('âš ï¸  Wine not found - required for Windows builds');
  console.log('ðŸ“¦ Installing Wine AppImage (no sudo required)...\n');

  try {
    // Create directories
    fs.mkdirSync(WINE_DIR, { recursive: true });
    fs.mkdirSync(WINE_BIN_DIR, { recursive: true });

    // Download Wine AppImage
    await downloadFile(WINE_APPIMAGE_URL, WINE_APPIMAGE_PATH);

    // Make executable
    fs.chmodSync(WINE_APPIMAGE_PATH, 0o755);
    console.log('âœ“ Made Wine AppImage executable');

    // Create wrapper script
    const wrapperScript = `#!/bin/bash
# Wine AppImage wrapper for electron-builder
# Auto-generated by scenario-to-desktop
exec "${WINE_APPIMAGE_PATH}" "$@"
`;

    fs.writeFileSync(WINE_WRAPPER_PATH, wrapperScript);
    fs.chmodSync(WINE_WRAPPER_PATH, 0o755);
    console.log('âœ“ Created Wine wrapper script');

    // Verify installation
    try {
      const version = execSync(`"${WINE_WRAPPER_PATH}" --version`, {
        encoding: 'utf8',
        stdio: 'pipe'
      }).trim();
      console.log(`\nâœ… Wine installed successfully!`);
      console.log(`   Version: ${version}`);
      console.log(`   Location: ${WINE_APPIMAGE_PATH}`);
      console.log(`   Wrapper: ${WINE_WRAPPER_PATH}`);
      console.log(`\nðŸ’¡ Make sure ~/.local/bin is in your PATH:`);
      console.log(`   export PATH="$HOME/.local/bin:$PATH"`);
      console.log(`\nðŸš€ You can now build Windows executables with: npm run dist:win`);
    } catch (err) {
      console.error('âš ï¸  Wine installed but verification failed:', err.message);
      console.log('   Try running manually:', WINE_WRAPPER_PATH, '--version');
    }

  } catch (error) {
    console.error('âŒ Failed to install Wine AppImage:', error.message);
    console.log('\nðŸ“– Manual installation:');
    console.log('   1. Download: https://github.com/mmtrt/WINE_AppImage/releases');
    console.log('   2. chmod +x wine-*.AppImage');
    console.log('   3. mv wine-*.AppImage ~/.local/share/wine-appimage/wine.AppImage');
    console.log('   4. Create wrapper script at ~/.local/bin/wine');
    process.exit(1);
  }
}

// Run if called directly
if (require.main === module) {
  setupWineAppImage().catch(err => {
    console.error('Fatal error:', err);
    process.exit(1);
  });
}

module.exports = { setupWineAppImage };
