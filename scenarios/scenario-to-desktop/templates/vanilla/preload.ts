import { contextBridge, ipcRenderer } from "electron";

// ===== DESKTOP API BRIDGE - GENERATED BY SCENARIO-TO-DESKTOP =====
// This preload script provides secure access to desktop features for the web application

// Define the API interface
interface DesktopAPI {
    // File operations
    file: {
        save: (content: string, defaultPath?: string) => Promise<string | null>;
        open: () => Promise<{ filePath: string; content: string } | null>;
    };
    
    // System information
    system: {
        info: () => Promise<{
            platform: string;
            arch: string;
            version: string;
            appVersion: string;
            isPackaged: boolean;
        }>;
    };
    
    // Application control
    app: {
        minimize: () => Promise<void>;
        maximize: () => Promise<void>;
        close: () => Promise<void>;
    };
    
    // Event listeners
    on: (channel: string, callback: (data: any) => void) => void;
    off: (channel: string, callback: (data: any) => void) => void;
    
    // Send messages to main process
    send: (channel: string, data: any) => void;
    
    // Utility functions
    utils: {
        openExternal: (url: string) => void;
        showNotification: (title: string, body: string) => void;
    };
}

// Validate allowed channels for security
const ALLOWED_CHANNELS = {
    TO_MAIN: [
        "file:save",
        "file:open", 
        "system:info",
        "app:minimize",
        "app:maximize",
        "app:close",
        "menu-action",
        "notification:show"
    ],
    FROM_MAIN: [
        "menu-action",
        "protocol-url",
        "notification:clicked"
    ]
};

function isValidChannel(channel: string, direction: 'TO_MAIN' | 'FROM_MAIN'): boolean {
    return ALLOWED_CHANNELS[direction].includes(channel);
}

// Create the desktop API
const desktopAPI: DesktopAPI = {
    // File operations
    file: {
        save: async (content: string, defaultPath?: string) => {
            return ipcRenderer.invoke("file:save", { content, defaultPath });
        },
        
        open: async () => {
            return ipcRenderer.invoke("file:open");
        }
    },
    
    // System information
    system: {
        info: async () => {
            return ipcRenderer.invoke("system:info");
        }
    },
    
    // Application control
    app: {
        minimize: async () => {
            return ipcRenderer.invoke("app:minimize");
        },
        
        maximize: async () => {
            return ipcRenderer.invoke("app:maximize");
        },
        
        close: async () => {
            return ipcRenderer.invoke("app:close");
        }
    },
    
    // Event listeners
    on: (channel: string, callback: (data: any) => void) => {
        if (isValidChannel(channel, 'FROM_MAIN')) {
            ipcRenderer.on(channel, (_, data) => callback(data));
        } else {
            console.warn(`[Desktop API] Invalid channel for listening: ${channel}`);
        }
    },
    
    off: (channel: string, callback: (data: any) => void) => {
        if (isValidChannel(channel, 'FROM_MAIN')) {
            ipcRenderer.off(channel, callback);
        } else {
            console.warn(`[Desktop API] Invalid channel for removal: ${channel}`);
        }
    },
    
    // Send messages to main process
    send: (channel: string, data: any) => {
        if (isValidChannel(channel, 'TO_MAIN')) {
            ipcRenderer.send(channel, data);
        } else {
            console.warn(`[Desktop API] Invalid channel for sending: ${channel}`);
        }
    },
    
    // Utility functions
    utils: {
        openExternal: (url: string) => {
            // This is handled by the main process through webContents.setWindowOpenHandler
            window.open(url, '_blank');
        },
        
        showNotification: (title: string, body: string) => {
            if ('Notification' in window) {
                // Use web notifications if available
                if (Notification.permission === 'granted') {
                    new Notification(title, { body });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification(title, { body });
                        }
                    });
                }
            } else {
                // Fallback: send to main process for native notification
                ipcRenderer.send("notification:show", { title, body });
            }
        }
    }
};

// Additional utility functions for common desktop app patterns
const desktopUtils = {
    // Check if running in desktop mode
    isDesktop: true,
    
    // Get desktop app information
    getAppInfo: async () => {
        return desktopAPI.system.info();
    },
    
    // Save data to a file with JSON serialization
    saveJSON: async (data: any, defaultFilename?: string) => {
        const json = JSON.stringify(data, null, 2);
        const defaultPath = defaultFilename ? defaultFilename.endsWith('.json') ? defaultFilename : `${defaultFilename}.json` : undefined;
        return desktopAPI.file.save(json, defaultPath);
    },
    
    // Load and parse JSON data from a file
    loadJSON: async () => {
        const result = await desktopAPI.file.open();
        if (!result) return null;
        
        try {
            const data = JSON.parse(result.content);
            return { filePath: result.filePath, data };
        } catch (error) {
            console.error('[Desktop Utils] Failed to parse JSON:', error);
            return null;
        }
    },
    
    // Show a simple notification
    notify: (message: string, title: string = 'Notification') => {
        desktopAPI.utils.showNotification(title, message);
    },
    
    // Handle menu actions (common pattern for desktop apps)
    onMenuAction: (callback: (action: string, data?: any) => void) => {
        desktopAPI.on('menu-action', callback);
    },
    
    // Handle protocol URLs (deep linking)
    onProtocolUrl: (callback: (url: string) => void) => {
        desktopAPI.on('protocol-url', callback);
    }
};

// Expose the API to the renderer process
contextBridge.exposeInMainWorld("desktopAPI", desktopAPI);
contextBridge.exposeInMainWorld("desktopUtils", desktopUtils);

// Also expose some common patterns for easier use
contextBridge.exposeInMainWorld("desktop", {
    // Quick access to common functions
    save: desktopAPI.file.save,
    open: desktopAPI.file.open,
    saveJSON: desktopUtils.saveJSON,
    loadJSON: desktopUtils.loadJSON,
    notify: desktopUtils.notify,
    minimize: desktopAPI.app.minimize,
    maximize: desktopAPI.app.maximize,
    close: desktopAPI.app.close,
    getInfo: desktopAPI.system.info,
    onMenuAction: desktopUtils.onMenuAction,
    onProtocolUrl: desktopUtils.onProtocolUrl,
    
    // Feature flags
    features: {
        fileSystem: true,
        notifications: true,
        systemTray: {{ENABLE_SYSTEM_TRAY}},
        autoUpdater: {{ENABLE_AUTO_UPDATER}},
        multiWindow: false // Can be enabled in advanced templates
    }
});

// Add TypeScript declarations for window object (for development)
declare global {
    interface Window {
        desktopAPI: typeof desktopAPI;
        desktopUtils: typeof desktopUtils;
        desktop: {
            save: typeof desktopAPI.file.save;
            open: typeof desktopAPI.file.open;
            saveJSON: typeof desktopUtils.saveJSON;
            loadJSON: typeof desktopUtils.loadJSON;
            notify: typeof desktopUtils.notify;
            minimize: typeof desktopAPI.app.minimize;
            maximize: typeof desktopAPI.app.maximize;
            close: typeof desktopAPI.app.close;
            getInfo: typeof desktopAPI.system.info;
            onMenuAction: typeof desktopUtils.onMenuAction;
            onProtocolUrl: typeof desktopUtils.onProtocolUrl;
            features: {
                fileSystem: boolean;
                notifications: boolean;
                systemTray: boolean;
                autoUpdater: boolean;
                multiWindow: boolean;
            };
        };
    }
}

// Log successful initialization
console.log('[Desktop API] Preload script initialized successfully');
console.log('[Desktop API] Available features:', {
    fileSystem: true,
    notifications: true,
    systemTray: {{ENABLE_SYSTEM_TRAY}},
    autoUpdater: {{ENABLE_AUTO_UPDATER}},
    multiWindow: false
});