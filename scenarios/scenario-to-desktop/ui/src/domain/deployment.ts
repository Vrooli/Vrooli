export type DeploymentMode = "external-server" | "cloud-api" | "bundled";
export type ServerType = "external" | "static" | "node" | "executable";
export type ConnectionDecisionKind = "bundled-runtime" | "remote-server" | "local-embedded";

export interface DeploymentOption {
  value: DeploymentMode;
  label: string;
  description: string;
  docs?: string;
}

export interface ServerTypeOption {
  value: ServerType;
  label: string;
  description: string;
  docs?: string;
}

export const DEFAULT_DEPLOYMENT_MODE: DeploymentMode = "external-server";
export const DEFAULT_SERVER_TYPE: ServerType = "external";

export const DEPLOYMENT_OPTIONS: DeploymentOption[] = [
  {
    value: "external-server",
    label: "Thin client (connect to your Vrooli server)",
    description:
      "Connects to the scenario you already started via `vrooli scenario start`. APIs/resources stay on that machine; the desktop build just hosts the UI shell.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/tiers/tier-2-desktop.md"
  },
  {
    value: "cloud-api",
    label: "Cloud API bundle (coming soon)",
    description:
      "Planned: package a cloud-friendly API target generated by deployment-manager. Disabled until bundle manifests exist.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/tiers/tier-4-saas.md"
  },
  {
    value: "bundled",
    label: "Fully bundled/offline",
    description:
      "Ships the API/resources inside the desktop installer using a bundle.json manifest exported by deployment-manager.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/tiers/tier-2-desktop.md"
  }
];

export const SERVER_TYPE_OPTIONS: ServerTypeOption[] = [
  {
    value: "external",
    label: "External (connect to your Vrooli server)",
    description:
      "Recommended. Desktop loads UI from the browser URL you already use (LAN or Cloudflare) and calls the remote API.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/tiers/tier-1-local-dev.md"
  },
  {
    value: "static",
    label: "Static files (UI only)",
    description:
      "Ships only the built UI. Use when the scenario has no API or when you plan to wire every API request to a hosted endpoint manually.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/tiers/tier-2-desktop.md"
  },
  {
    value: "node",
    label: "Embedded Node server",
    description:
      "Experimental. Runs a Node script bundled with the app (e.g., lightweight APIs) and proxies requests locally.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/scenarios/scenario-to-desktop.md"
  },
  {
    value: "executable",
    label: "Executable / background binary",
    description:
      "Launches a binary packaged with the desktop app. Useful for custom services but requires careful resource planning.",
    docs: "https://github.com/vrooli/vrooli/blob/main/docs/deployment/scenarios/scenario-to-desktop.md"
  }
];

export function findDeploymentOption(mode?: string): DeploymentOption {
  return DEPLOYMENT_OPTIONS.find((option) => option.value === mode) ?? DEPLOYMENT_OPTIONS[0];
}

export function findServerTypeOption(serverType?: string): ServerTypeOption {
  return SERVER_TYPE_OPTIONS.find((option) => option.value === serverType) ?? SERVER_TYPE_OPTIONS[0];
}

export function isBundledMode(mode?: string): mode is "bundled" {
  return mode === "bundled";
}

export function requiresProxyURL(mode: DeploymentMode, serverType: ServerType): boolean {
  return !isBundledMode(mode) && serverType === "external";
}

export interface ConnectionDecision {
  kind: ConnectionDecisionKind;
  requiresProxyUrl: boolean;
  requiresBundleManifest: boolean;
  effectiveServerType: ServerType;
  allowsAutoManageTier1: boolean;
}

export function decideConnection(deploymentMode: DeploymentMode, serverType: ServerType): ConnectionDecision {
  if (isBundledMode(deploymentMode)) {
    return {
      kind: "bundled-runtime",
      requiresProxyUrl: false,
      requiresBundleManifest: true,
      effectiveServerType: DEFAULT_SERVER_TYPE,
      allowsAutoManageTier1: false
    };
  }

  if (serverType === "external") {
    return {
      kind: "remote-server",
      requiresProxyUrl: true,
      requiresBundleManifest: false,
      effectiveServerType: "external",
      allowsAutoManageTier1: true
    };
  }

  return {
    kind: "local-embedded",
    requiresProxyUrl: false,
    requiresBundleManifest: false,
    effectiveServerType: serverType,
    allowsAutoManageTier1: true
  };
}
