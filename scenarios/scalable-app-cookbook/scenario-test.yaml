version: 1.0
scenario: scalable-app-cookbook

# Structure validation - required files and directories
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/scalable-app-cookbook
    - cli/install.sh
    - initialization/postgres/schema.sql
    - initialization/postgres/seed.sql
    - scenario-test.yaml
    - ui/package.json
    - ui/src/App.jsx
    
  required_dirs:
    - api
    - cli
    - ui
    - ui/src
    - initialization
    - initialization/postgres
    - docs
    - tests

# Resource requirements
resources:
  required: [postgres]
  optional: [ollama]
  health_timeout: 60

# Test suite
tests:
  # Database structure tests
  - name: "PostgreSQL schema initialized"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('patterns', 'recipes', 'implementations', 'ci_gates', 'observability', 'pattern_usage')"
    expect:
      rows:
        - count: 6

  - name: "Patterns table populated with seed data"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM patterns"
    expect:
      rows:
        - count: ">= 8"

  - name: "Recipes table has implementation recipes"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM recipes"
    expect:
      rows:
        - count: ">= 3"

  - name: "Implementations table has code examples"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM implementations"
    expect:
      rows:
        - count: ">= 3"

  # API health and functionality tests
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        database: true

  - name: "Pattern search endpoint works"
    type: http
    service: api
    endpoint: /api/v1/patterns/search?chapter=Part A
    method: GET
    expect:
      status: 200
      body:
        total: ">= 5"

  - name: "Pattern detail retrieval works"
    type: http
    service: api
    endpoint: /api/v1/patterns/search?query=jwt
    method: GET
    expect:
      status: 200

  - name: "Recipe generation endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/recipes/generate
    method: POST
    body:
      recipe_id: "jwt-auth-recipe"
      language: "go"
    expect:
      status: 200

  - name: "Chapters endpoint lists cookbook sections"
    type: http
    service: api
    endpoint: /api/v1/patterns/chapters
    method: GET
    expect:
      status: 200

  - name: "Stats endpoint provides metrics"
    type: http
    service: api
    endpoint: /api/v1/patterns/stats
    method: GET
    expect:
      status: 200
      body:
        statistics:
          total_patterns: ">= 8"

  # CLI functionality tests
  - name: "CLI status command works"
    type: exec
    command: ./cli/scalable-app-cookbook status --json
    expect:
      exit_code: 0
      output_contains: ["healthy"]

  - name: "CLI search command works"
    type: exec
    command: ./cli/scalable-app-cookbook search "jwt" --json
    expect:
      exit_code: 0
      output_contains: ["patterns"]

  - name: "CLI chapters command works"
    type: exec
    command: ./cli/scalable-app-cookbook chapters --json
    expect:
      exit_code: 0
      output_contains: ["Part A"]

  - name: "CLI help command works"
    type: exec
    command: ./cli/scalable-app-cookbook help
    expect:
      exit_code: 0
      output_contains: ["Scalable App Cookbook CLI", "COMMANDS", "search", "generate"]

  - name: "CLI version command works"
    type: exec
    command: ./cli/scalable-app-cookbook version
    expect:
      exit_code: 0
      output_contains: ["v1.0.0"]

  # UI tests (if UI is running)
  - name: "UI serves main page"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body_contains: ["Scalable App Cookbook"]

# Performance requirements
performance:
  api_response_time:
    search: 100ms
    retrieval: 50ms
    generation: 2000ms
  
  resource_usage:
    max_memory: 1GB
    max_cpu: 50%

# Integration requirements
integration:
  discoverable: true
  api_documented: true
  cli_functional: true
  web_ui_accessible: true