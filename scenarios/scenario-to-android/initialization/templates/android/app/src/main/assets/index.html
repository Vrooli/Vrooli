<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#{{THEME_COLOR}}">
    <title>{{APP_NAME}}</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #app {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loading {
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #{{THEME_COLOR}};
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            margin: 20px;
        }
        
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 9999;
            display: none;
        }
        
        .offline .offline-banner {
            display: block;
        }
    </style>
    
    <!-- Scenario-specific styles will be injected here -->
    {{SCENARIO_STYLES}}
</head>
<body>
    <div class="offline-banner">
        You are currently offline. Some features may be limited.
    </div>
    
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading {{APP_NAME}}...</p>
        </div>
    </div>
    
    <script>
        // Native Android interface detection
        window.isAndroidApp = typeof VrooliNative !== 'undefined';
        
        if (window.isAndroidApp) {
            console.log('Running in Vrooli Android app');
            
            // Get device info
            try {
                const deviceInfo = JSON.parse(VrooliNative.getDeviceInfo());
                console.log('Device info:', deviceInfo);
                window.deviceInfo = deviceInfo;
            } catch (e) {
                console.error('Failed to get device info:', e);
            }
            
            // Setup permission handlers
            window.requestPermission = function(permission) {
                if (VrooliNative && VrooliNative.requestPermission) {
                    VrooliNative.requestPermission(permission);
                }
            };
            
            window.hasPermission = function(permission) {
                if (VrooliNative && VrooliNative.hasPermission) {
                    return VrooliNative.hasPermission(permission);
                }
                return false;
            };
            
            // Setup local storage bridge
            window.nativeSaveData = function(key, value) {
                if (VrooliNative && VrooliNative.saveData) {
                    VrooliNative.saveData(key, typeof value === 'object' ? JSON.stringify(value) : value);
                }
            };
            
            window.nativeGetData = function(key) {
                if (VrooliNative && VrooliNative.getData) {
                    const data = VrooliNative.getData(key);
                    try {
                        return JSON.parse(data);
                    } catch {
                        return data;
                    }
                }
                return null;
            };
            
            // Vibration API
            window.vibrate = function(duration) {
                if (VrooliNative && VrooliNative.vibrate) {
                    VrooliNative.vibrate(duration || 100);
                }
            };
        }
        
        // Offline detection
        window.addEventListener('online', function() {
            document.body.classList.remove('offline');
            console.log('Connection restored');
        });
        
        window.addEventListener('offline', function() {
            document.body.classList.add('offline');
            console.log('Connection lost');
        });
        
        // Initial offline check
        if (!navigator.onLine) {
            document.body.classList.add('offline');
        }
        
        // Service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('Service Worker registered:', registration);
                })
                .catch(function(error) {
                    console.error('Service Worker registration failed:', error);
                });
        }
        
        // Error handling
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            const app = document.getElementById('app');
            if (app && !app.querySelector('.error')) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <h3>Oops! Something went wrong</h3>
                    <p>${event.error?.message || 'An unexpected error occurred'}</p>
                    <p style="margin-top: 10px; font-size: 12px;">Please try refreshing the app</p>
                `;
                app.appendChild(errorDiv);
            }
        });
        
        // Load scenario-specific code
        function loadScenario() {
            // This will be replaced with actual scenario loading logic
            {{SCENARIO_LOADER}}
            
            // Fallback loading complete
            setTimeout(function() {
                const app = document.getElementById('app');
                if (app && app.querySelector('.loading')) {
                    app.innerHTML = '<h1>{{APP_NAME}}</h1><p>Scenario content will appear here</p>';
                }
            }, 2000);
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadScenario);
        } else {
            loadScenario();
        }
    </script>
    
    <!-- Scenario-specific scripts will be injected here -->
    {{SCENARIO_SCRIPTS}}
</body>
</html>