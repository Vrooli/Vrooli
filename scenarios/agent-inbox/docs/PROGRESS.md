# Progress Log

Track development progress here. Each agent session should add an entry.

| Date | Author | Status Snapshot | Notes |
|------|--------|-----------------|-------|
| 2025-11-28 | Generator Agent | Initialization complete | Scenario scaffold, PRD, requirements registry seeded. Ready for P0 implementation. |
| 2025-11-28 | Improver Agent | Core P0 progress (33% coverage) | Full Go API with CRUD for chats, messages, labels; PostgreSQL schema; Inbox UI with chat list, messaging, read/unread, archive, star; 14 API tests; Selector registry for BAS workflows. Completeness: 12→12/100. Next: OpenRouter integration, streaming, multi-layer E2E validation. |
| 2025-11-28 | Improver Agent (Phase 1 Iteration 2) | Security & standards fixes | Fixed CORS wildcard vulnerability (HTTP-002); updated Makefile to match standards template; fixed service.json health endpoints; added 4 E2E playbooks for multi-layer validation; updated requirements with integration phase tests. Security: 1→0 vulnerabilities. Standards violations reduced from 75→50. |
| 2025-12-25 | Improver Agent | OpenRouter integration & P0 progress (40% coverage) | Added OpenRouter chat completion with SSE streaming (api/openrouter.go); model selector UI with dropdown; streaming response display; fixed 4 HIGH standards violations (PRD sections, service.json condition structure, pnpm --ignore-workspace); added usage-stats requirements module. Standards violations: 52→2. Completeness: 24→26/100. Requirements coverage: 33%→40%. Next: Add focused API tests, reduce monolithic test files. |
| 2025-12-25 | Improver Agent | Test restructuring & P0 progress | Split monolithic main_test.go into 5 focused test files: inbox_test.go (312 LOC, 8 tests), chat_test.go (264 LOC, 10 tests), persistence_test.go (379 LOC, 14 tests), labels_test.go (457 LOC, 14 tests), openrouter_test.go (237 LOC, 8 tests). Added tests for /api/v1/models and /api/v1/chats/{id}/complete endpoints. Updated requirements to point to focused test files. Marked LABEL-005 and LABEL-006 as complete with API tests. Fixed database schema conflict by adding scenario-specific PostgreSQL schema (agent_inbox). Scenario now starts and API healthy (http://localhost:16661). Security: 0 vulnerabilities. Standards: 1 medium (Go workspace mode). Requirements coverage: 40%→44%. Next: Install openrouter resource, run integration tests, add NAME-* requirement tests. |
| 2025-12-25 | Claude Opus 4.5 | Tool calling & agent-manager integration | Major architectural update to support the "inbox as dispatcher" pattern. Agent-inbox now acts as a conversational hub that dispatches coding tasks to agent-manager via tool calls. Key changes: (1) Extended database schema with tool_calls table and message fields for tool_call_id, tool_calls JSONB, response_id, finish_reason; (2) Added tools.go with 6 agent-manager tools (spawn_coding_agent, check_agent_status, stop_agent, list_active_agents, get_agent_diff, approve_agent_changes); (3) Updated openrouter.go to handle OpenRouter Responses API with streaming tool call events; (4) Added handleListTools and handleListChatToolCalls API endpoints; (5) Updated UI MessageList to display tool calls with running/completed/failed states; (6) Added activeToolCalls state to useChats hook with streaming event handling; (7) Added agent-manager as scenario dependency in service.json. API compiles and TypeScript passes. Next: Add tests for tool call flow, integrate with running agent-manager. |
| 2025-12-25 | Claude Opus 4.5 | P0-005 Auto-naming & Responses API storage | Implemented auto-naming with Ollama (P0-005): (1) Added ollama.go with handleAutoName endpoint that uses local Ollama (llama3.1:8b) to generate concise chat names from conversation content; (2) Added /api/v1/chats/{id}/auto-name POST endpoint; (3) Added autoNameChat API function and useChats mutation; (4) Auto-naming triggers after first AI response when chat has default "New Chat" name. Updated conversation storage for Responses API pattern: (1) handleGetChat now returns all message fields including tool_call_id, tool_calls, response_id, finish_reason; (2) handleAddMessage now accepts tool role with tool_call_id validation. Added naming_test.go with 6 new tests for auto-naming and tool messages. Installed openrouter resource. Security: 0 vulnerabilities. Standards: 1 medium (Go workspace mode). |
| 2025-12-25 | Claude Opus 4.5 | Control Surface & Graceful Degradation | Applied ecosystem-manager design guides (control-surface-tunable-levers-design.md, failure-topography-and-graceful-degradation.md). **Control Surface:** Added `config/config.go` with centralized, validated configuration for all tunable levers - server timeouts, AI defaults, naming parameters, integration timeouts, and resilience settings. All levers have sane defaults, clear documentation of tradeoffs, and bounded validation. **Graceful Degradation:** Added `resilience/` package with (1) retry.go - exponential backoff retry with permanent error support; (2) circuit_breaker.go - full circuit breaker implementation (closed/open/half-open states) with thread-safety and metrics; (3) fallback.go - typed fallback helpers for graceful degradation. Updated integrations to use config: OllamaClient, OpenRouterClient, AgentManagerClient now inject timeouts from config. Health endpoint upgraded to report dependency status (healthy/degraded/unhealthy) and capability availability. Added 24 new tests for config validation and resilience patterns. All tests pass. |
| 2025-12-25 | Claude Opus 4.5 | Temporal Flow Audit & Interruption Resilience | Applied ecosystem-manager temporal-flow-audit.md and progress-continuity-interruption-resilience.md guides. **Critical fixes:** (1) **Race condition in useCompletion** - Added request ID tracking to prevent stale state updates; each completion gets unique ID, state updates guarded by ID match; (2) **AbortController for streaming** - Added cancellation support to `completeChat()` API; abort on unmount or new request; properly releases stream reader; (3) **Error propagation fix** - `ExecuteToolCalls` no longer silently swallows errors; returns aggregated error while still providing partial results; (4) **Cleanup on unmount** - useCompletion now cancels in-flight requests when component unmounts via useEffect cleanup; (5) **Completion tracking** - Added `completion_id` to all SSE events for client-side correlation, preventing stale event handling. **Key temporal flows documented:** SSE streaming, tool execution, auto-naming, retry/circuit breaker flows. **Remaining considerations:** Tool calls not resumable on restart (long-running agents can be orphaned), no server-side streaming checkpoints. All changes compile and pass type checking. |
| 2025-12-25 | Claude Opus 4.5 | Startup Reconciliation for Orphaned Tool Calls | Applied second pass of temporal-flow-audit.md and progress-continuity-interruption-resilience.md. **Implemented:** (1) **Startup reconciliation service** - `services/reconciliation.go` that runs at server startup to find and reconcile orphaned tool calls; (2) **ListOrphanedToolCalls query** - persistence method to find tool calls in 'pending'/'running' status; (3) **UpdateToolCallStatus method** - allows marking tool calls as cancelled/completed/failed with error messages; (4) **Agent-manager integration** - reconciliation checks agent-manager for still-running agents and updates status accordingly; (5) **Main.go integration** - reconciliation runs after schema init, before server starts. **Remaining architectural considerations documented below.** |
| 2025-12-25 | Claude Opus 4.5 | P0 Naming & Labels Complete | **Marked 5 requirements complete with proper validation refs.** Implemented NAME-004 (double-click to rename) with inline editing in ChatList: (1) Double-click on chat name enters edit mode with input field; (2) Enter/blur saves, Escape cancels; (3) Proper focus management and value sync; (4) Added 18 UI tests for ChatList including inline rename functionality. **Fixed test infrastructure:** Added jsdom dependency, passWithNoTests in vitest config, lighthouse.json version field. Completion: 44%→55.6%. Critical gap: 25→20. P0 naming complete (4/4). P0 labels complete (6/6). |
| 2025-12-25 | Claude Opus 4.5 | Removed Terminal View Mode | **Scope reduction per user request.** Terminal view mode (TERM-001 through TERM-006) removed from requirements and codebase. **Changes:** (1) Deleted `requirements/04-terminal/core.json` and updated index; (2) Removed `ViewModeTerminal` constant and validation from `domain/types.go`; (3) Simplified `MessageList.tsx` to only use bubble mode; (4) Removed terminal icon condition from `ChatList.tsx`; (5) Updated PRD to replace terminal references with tool-calling/agent-manager integration; (6) Updated PROBLEMS.md, RESEARCH.md, requirements README.md. **Impact:** Requirements: 45→39 total. Completion: 55.6%→64.1%. Critical gap: 20→14. All tests pass. |
| 2025-12-25 | Claude Opus 4.5 | Full-text Search (SEARCH-001-003) Complete | **Implemented PostgreSQL full-text search across chats and messages.** (1) **API:** Added `messages.search_vector` and `chats.search_vector` tsvector columns with GIN indexes; triggers auto-populate on insert/update; `GET /api/v1/search?q=query&limit=20` endpoint with ranked results and highlighted snippets using `ts_headline`; (2) **UI:** New `useSearch` hook with 300ms debounce and react-query caching; ChatList now shows server-side search results with match type indicator and highlighted snippets; (3) **Navigation:** Clicking search result passes `messageId` to `onSelectChat`; MessageList scrolls to and highlights target message with yellow ring animation that fades after 2 seconds. (4) **Tests:** Updated ChatList tests with QueryClientProvider wrapper and mocked searchChats API. **Impact:** Requirements: 28/39 complete. Completion: 64.1%→71.8%. Critical gap: 14→11. All tests pass. |
| 2025-12-25 | Claude Opus 4.5 | Keyboard Navigation Complete (KEY-001-005) | **Implemented all 5 keyboard shortcuts for power users.** (1) **J/K navigation (KEY-001):** Added focusedIndex state in App.tsx; j moves focus down, k moves up; visual focus ring on ChatList items; scroll-into-view on focus change; (2) **Enter to open (KEY-002):** Opens the currently focused chat; (3) **Escape to close (KEY-003):** Already implemented, closes dialogs or deselects chat; (4) **Ctrl/Cmd+N new chat (KEY-004):** Already implemented; (5) **/ or Ctrl+K for search (KEY-005):** Added "/" as additional shortcut to focus search. **UI updates:** Updated KeyboardShortcuts help dialog with new shortcuts; ChatListItem now supports forwardRef and isFocused prop. **Tests:** Added useKeyboardShortcuts.test.ts with 17 tests covering key matching, modifiers, input exclusion, Escape special case; added 4 focus tests to ChatList.test.tsx. All 40 UI tests pass. **Impact:** Requirements: 30/36 complete. Completion: 71.8%→83.3%. Critical gap: 11→6. |
| 2025-12-25 | Claude Opus 4.5 | Export Chat Complete (PERSIST-005) | **Implemented chat export to markdown, JSON, and plain text.** (1) **API:** Added `GET /api/v1/chats/{id}/export?format=markdown|json|txt` endpoint in handlers/chat.go; formatMarkdown() and formatPlainText() helpers for content formatting; sanitizeFilename() for safe download filenames; proper Content-Type and Content-Disposition headers for file download. (2) **UI:** Added Export option to ChatHeader's "More actions" dropdown; Export dialog with three format buttons (Markdown, JSON, Plain Text) with descriptions; exportChat() API function with browser download trigger. (3) **Tests:** Added 5 API tests in chat_test.go for all formats, invalid format validation, and default format behavior. All 40 UI tests pass. **Impact:** Requirements: 31/36 complete. Completion: 83.3%→86.1%. Critical gap: 6→5. |
| 2025-12-26 | Claude Opus 4.5 | Usage Tracking Complete (USAGE-001-003) | **Implemented full usage tracking with token counts and cost estimation.** (1) **API:** Added `usage_records` table with prompt/completion token counts and costs; `UsageRecord`, `UsageStats`, `ModelUsage`, `DailyUsage` domain types; `GET /api/v1/usage`, `GET /api/v1/usage/records`, `GET /api/v1/chats/{id}/usage` endpoints with date filtering and pagination; `SaveUsageRecord`, `GetUsageStats`, `GetChatUsageStats`, `GetUsageRecords` persistence methods. (2) **Cost Calculation:** Added `integrations/pricing.go` with model pricing data for Claude, GPT-4, Gemini, Llama, Mistral; `CalculateUsageCost` function with per-model pricing (cents per million tokens); costs calculated and stored on each completion. (3) **UI:** Added `UsageStats.tsx` component with summary cards (total tokens, total cost), model breakdown, and recent daily activity; accessible from Settings via "View Usage Statistics" button. (4) **Tests:** Added `pricing_test.go` with tests for pricing lookup, cost calculation accuracy, and usage record creation. **Impact:** Requirements: 34/36 complete. Completion: 86.1%→94.4%. Critical gap: 5→2. |
| 2025-12-26 | Claude Opus 4.5 | Modular Tool Configuration UI (Phase 3) | **Implemented full UI for dynamic tool configuration - both global defaults and per-chat overrides.** Building on the Tool Discovery Protocol (Phase 1) and ToolRegistry service (Phase 2), this completes the modular tool architecture. **(1) API Types:** Added 15 new TypeScript types in `api.ts` for tool discovery protocol (`ScenarioInfo`, `ToolParameters`, `ToolMetadata`, `EffectiveTool`, `ToolSet`, `ScenarioStatus`, etc.); 5 API functions (`fetchToolSet`, `fetchScenarioStatuses`, `setToolEnabled`, `resetToolConfig`, `refreshTools`). **(2) State Management:** Created `useTools` hook with react-query for caching; supports global and chat-specific configurations; optimistic updates; derived data (enabledTools, toolsByScenario, toolsByCategory). **(3) Settings Modal:** Added "AI Tools" section with collapsible `ToolConfiguration` component showing tools grouped by scenario with toggle switches, metadata badges (long-running, cost), enabled counts, and refresh capability. **(4) Per-Chat Tools:** Added `ChatToolsSelector` popover in ChatHeader; shows tool count badge; indicates when chat has overrides (indigo highlight); allows reset to default. **(5) Tests:** Added 46 new tests across 3 files (`useTools.test.ts`, `ToolConfiguration.test.tsx`, `ChatToolsSelector.test.tsx`). All 77 UI tests pass, all Go tests pass. **Architecture follows screaming architecture principles:** clear boundaries between hooks/components/api, testing seams via dependency injection, pure presentational components. |
| 2025-12-26 | Claude Opus 4.5 | Tabbed Settings Redesign | **Redesigned Settings modal with 3-tab logical grouping to reduce clutter.** (1) **New Tabs component:** Created reusable `ui/tabs.tsx` with `Tabs`, `TabsList`, `TabsTrigger`, `TabsContent` components; context-based state sharing; full accessibility (aria-selected, tablist role, tabpanel role); 10 tests. (2) **Tab organization:** **General** (Appearance theme toggle, Keyboard shortcuts), **AI** (Default model selector, AI Tools configuration), **Data** (Usage statistics, Danger zone). (3) **UX improvements:** Delete confirmation resets when switching tabs; tool data only fetched when AI tab active; icons on tab triggers for visual clarity. All 87 UI tests pass. |
| 2025-12-26 | Claude Opus 4.5 | URL-based Chat Routing | **Implemented URL-based routing so chats persist on page refresh.** (1) **useChatRoute hook:** New `hooks/useChatRoute.ts` with `useChatRoute()` for reading/writing chat ID to URL (`/chat/:id` pattern) and `usePopStateListener()` for browser back/forward navigation; uses History API (pushState/replaceState) without adding router dependency. (2) **useChats integration:** Added `initialChatId` and `onChatChange` options to `useChats` hook; all chat selection mutations now trigger URL sync. (3) **App.tsx integration:** Reads initial chat from URL on page load; syncs URL when chat changes; handles browser back/forward via popstate listener. (4) **Tests:** Added `useChatRoute.test.ts` with 16 tests covering URL parsing, pushState, replaceState, and popstate handling. All 103 UI tests pass. |
| 2025-12-27 | Claude Opus 4.5 | Bulk Selection & Conversation Forking (INBOX-LIST-005, BUBBLE-007) | **Completed final 2 requirements to reach 100% coverage.** (1) **Bulk Selection API:** Added `POST /api/v1/chats/bulk` endpoint in `handlers/chat.go:BulkOperation` supporting 7 operations: delete, archive, unarchive, mark_read, mark_unread, add_label, remove_label; validates max 100 chats per request; returns success/fail counts. (2) **Bulk Selection UI:** Added selection mode toggle button in Sidebar header; checkboxes replace chat icons when in selection mode; bulk actions bar appears when items selected with delete, archive, mark read/unread buttons; select all/deselect all controls; visual feedback with loading state. (3) **Conversation Forking API:** Added `POST /api/v1/chats/{id}/fork` endpoint in `handlers/chat.go:ForkChat`; added `ForkChat` repository method in `persistence/chat.go` using recursive CTE to trace message ancestry and copy messages in order; creates new chat with "(fork)" suffix and proper parent linkages. (4) **Conversation Forking UI:** Updated MessageList with `onForkConversation` prop; fork button in message actions now calls actual fork function instead of "coming soon"; loading state during fork operation; auto-navigates to new forked chat on success. (5) **Type exports:** Added `BulkOperation` type and `bulkOperateChats`, `forkChat` API functions. **Impact:** Requirements: 36/36 complete. Completion: 94.4%→100%. Critical gap: 2→0. All Go tests compile. |
| 2025-12-27 | Claude Opus 4.5 | Fixed Fork Database Errors | **Fixed two critical bugs in ForkChat that caused database errors.** (1) **pq: unexpected Parse response 'C'**: Fixed by collecting all messages from the recursive CTE into a slice BEFORE executing any INSERT queries. The pq driver cannot execute another query on the same transaction while a result set is still being iterated. Added `messageForFork` struct to hold message data temporarily. (2) **pq: invalid input syntax for type json**: Fixed by checking if `toolCallsJSON` byte slice is empty and passing `nil` instead of empty bytes, which PostgreSQL rejected as invalid JSON. (3) **Tests:** Added 3 new API tests in `chat_test.go`: `TestForkChat` (verifies fork creates new chat with correct message ancestry), `TestForkChatRequiresMessageID` (validates message_id required), `TestForkNonexistentChat` (returns 404). Fork now works correctly end-to-end. |
| 2026-01-14 | Claude Opus 4.5 | React Stability Hardening | **Focus: Error boundaries and crash resilience.** (1) **Created ErrorBoundary component** (`components/ErrorBoundary.tsx`) with critical (app-level, full-screen recovery UI) and non-critical (section-level, inline retry) variants; dev-mode error display; withErrorBoundary HOC. (2) **Strategic error boundary placement:** Root-level critical boundary in `main.tsx` wrapping QueryClientProvider; Section-level boundaries for Sidebar and ChatContent in `App.tsx`. (3) **Markdown parsing resilience:** Added `MarkdownErrorBoundary` in `MarkdownRenderer.tsx` that gracefully falls back to plain text when markdown parsing fails. (4) **QueryClient hardening:** Configured retry limits (queries: 2, mutations: 1) and disabled refetch-on-focus for errored queries. (5) **Audit findings:** Codebase already had excellent defensive patterns - stable empty array constants (EMPTY_TOOL_CALLS, etc.), proper optional chaining, nullish coalescing, hook cleanup via AbortController and useEffect return. TypeScript strict mode already enabled. No new code defects introduced. UI smoke test passes. |
| 2026-01-14 | Claude Opus 4.5 | React Stability Verification | **Continuation of React Stability focus - comprehensive audit completed.** Verified all stability patterns are already well-implemented: (1) ErrorBoundary with critical/non-critical modes, retry, and go-home recovery options. (2) MarkdownErrorBoundary for parsing failures with plaintext fallback. (3) Stable empty array constants used consistently across 10+ files (EMPTY_TOOL_CALLS, EMPTY_CHATS, EMPTY_MODELS, EMPTY_IMAGES, etc.). (4) Hooks follow strict discipline: useCompletion has request ID tracking + AbortController cleanup; useChats uses stable references; all effects have proper cleanup. (5) TypeScript strict mode already enabled. (6) QueryClient configured with retry limits. **No additional hardening required** - codebase is already mature and crash-resilient. UI smoke passes in 1367ms with 0 JS exceptions. Completeness: 54/100 (unchanged - validation-only pass). |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Full Audit Completed | **Systematic review of 12 core files using visited-tracker.** Confirmed all React stability patterns already properly implemented: (1) ErrorBoundary (critical/non-critical modes), (2) MarkdownErrorBoundary, (3) Stable empty array constants in all hooks (EMPTY_CHATS, EMPTY_MODELS, EMPTY_TOOL_CALLS, EMPTY_IMAGES, EMPTY_LABELS, EMPTY_RESULTS, EMPTY_TOOL_RECORDS, EMPTY_APPROVALS), (4) Request ID tracking + AbortController in useCompletion, (5) QueryClient retry limits (queries:2, mutations:1), (6) TypeScript strict mode enabled, (7) Proper useEffect cleanup, (8) Memoization with useMemo/useCallback, (9) Defensive data access with optional chaining. Files audited: ErrorBoundary.tsx, main.tsx, App.tsx, useChats.ts, useCompletion.ts, useLabels.ts, useSearch.ts, useTools.ts, MarkdownRenderer.tsx, MessageList.tsx, ChatList.tsx, UsageStats.tsx, ToolConfiguration.tsx. **No code changes required** - codebase already mature. UI smoke passes with 0 JS exceptions. Completeness: 54/100 (unchanged - audit-only pass). |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Additional Error Boundaries | **Added 3 strategic error boundaries to App.tsx.** (1) Wrapped `LabelManager` dialog in ErrorBoundary for label-related data handling. (2) Wrapped `Settings` dialog in ErrorBoundary - this dialog has multiple tabs with async data loading (templates, skills, tool configurations). (3) Wrapped `TemplateEditorModal` in ErrorBoundary - handles user-edited template data. Existing boundaries (Sidebar, ChatContent, Root, MarkdownRenderer) were already well-placed. All audited components follow excellent defensive patterns. UI smoke test passes (1384ms, 0 JS exceptions). Scenario rebuilt and restarted successfully. Auditor findings (3 security, 5 standards) are pre-existing issues unrelated to React stability. Completeness: 54/100 (unchanged - stability-only changes). |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Verification Complete | **Final verification of React stability patterns.** Audited 12 additional files via visited-tracker: input.tsx, badge.tsx, dropdown.tsx, LabelManager.tsx, useKeyboardShortcuts.ts, Settings.tsx, MessageList.tsx, ChatView.tsx, MarkdownRenderer.tsx, SchemaForm.tsx, useAsyncStatus.ts, useChatRoute.ts. **Confirmed patterns:** (1) All useEffect hooks have proper cleanup for event listeners (dropdown.tsx, useKeyboardShortcuts.ts) and EventSource (useAsyncStatus.ts), (2) No conditional hook calls or `as any` casts, (3) All data-driven components use optional chaining and nullish coalescing, (4) TypeScript strict:true enabled. **Test results:** 145/145 UI tests pass, UI smoke test passes (1354ms, 0 JS exceptions, no network failures). **Completeness: 54/100** (unchanged - validation-only pass). No code changes required - codebase is already mature and crash-resilient. |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Defensive Fix | **Applied targeted fix to prevent potential crash.** (1) Fixed `TemplateSelector.tsx:255` - added optional chaining `template.variables?.length ?? 0` to prevent crash if template data from API is missing the variables array. This edge case could occur with malformed API responses or template data migration issues. (2) Recorded 7 file audits in visited-tracker (ErrorBoundary.tsx, main.tsx, App.tsx, useChats.ts, MessageList.tsx, MarkdownRenderer.tsx, TemplateSelector.tsx). **Test results:** 145/145 UI tests pass, UI smoke test passes (1368ms, 0 JS exceptions). **Completeness: 54/100** (unchanged). |
| 2026-01-15 | Claude Opus 4.5 | React Stability - TemplateVariableForm Fix | **Continued React stability audit with fix.** (1) Fixed `TemplateVariableForm.tsx` - added defensive `template.variables ?? []` guard before accessing variables array to prevent crash if template data is incomplete. All 3 usages in the component now use the local `variables` variable. (2) Audited 7 additional files via visited-tracker: KeyboardShortcuts.tsx (static data only), VersionPicker.tsx (proper null check), messageTree.ts (pure utility), UsageStats.tsx (loading/error/empty states), ModelSelector.tsx (fallback rendering), ChatList.tsx (defensive patterns). All audited files already follow proper stability patterns. **Test results:** 145/145 UI tests pass, UI smoke test passes (1369ms, 0 JS exceptions). **Completeness: 54/100** (unchanged - targeted stability fix only). |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Error #310 Investigation | **Investigated React Error #310 ("Too many re-renders") mentioned in task notes.** (1) **Root cause analysis:** Error occurs when sending messages, caught by `ChatContent` ErrorBoundary. Deep code review of useMemo, useCallback, and hook patterns across 20+ files. Found existing defenses are excellent - stable empty array constants, proper hook discipline, cleanup functions. (2) **Fix applied:** `TemplateSelector.tsx:255-258` had inconsistent optional chaining - fixed `template.variables.length` to `template.variables?.length ?? 0` inside conditional block. (3) **Assessment:** Error #310 likely caused by intermittent race condition during rapid state updates, not static code issue. ErrorBoundary properly catches and recovers, preventing white-screen crash. (4) **Files audited:** ChatView.tsx, MessageList.tsx, MessageInput.tsx, useTemplatesAndSkills.ts, Suggestions.tsx, ErrorBoundary.tsx, TemplateSelector.tsx. **Test results:** Build passes, structure tests pass. **Completeness: 54/100** (unchanged - targeted fix only). |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Granular Error Boundaries | **Added granular error boundaries to ChatView.tsx for better crash isolation.** (1) **Changes:** Wrapped ChatHeader, AsyncOperationsPanel, MessageList, and MessageInput with individual ErrorBoundary components. This isolates crashes to specific sections rather than having the entire ChatContent area fail. (2) **Root cause investigation:** Comprehensive analysis of React Error #310 ("Cannot update a component while rendering a different component"). The error appears to be an intermittent race condition during complex state updates when sending messages or navigating to empty chats. Existing code already has excellent defensive patterns: stable empty array constants, proper hook discipline, request ID tracking in useCompletion, AbortController cleanup. (3) **Strategy:** Since the race condition is intermittent and likely timing-dependent, granular error boundaries provide the most practical mitigation - allowing partial UI recovery instead of full white-screen crashes. **Test results:** TypeScript check passes, scenario running and healthy. |
| 2026-01-15 | Claude Opus 4.5 | React Stability - Fixed Error #310 Root Cause | **Found and fixed root cause of React Error #310 ("Cannot update a component while rendering a different component").** (1) **Root cause:** In `useCompletion.ts`, the `onTemplateDeactivated()` callback was being called synchronously during streaming event processing (inside `createEventHandler`). This callback triggers `activeTemplate.deactivate()` which calls `queryClient.setQueryData()`, causing a parent component state update while a child component was still rendering. (2) **Fix:** Wrapped the `onTemplateDeactivated()` call in `queueMicrotask()` to defer execution until after the current render cycle completes. This ensures the parent state update happens in a separate microtask, avoiding the React Error #310. (3) **Location:** `ui/src/hooks/useCompletion.ts:154-160`. (4) **Test results:** UI build passes, all TypeScript checks pass. |

---

## Temporal Flow & Interruption Resilience Analysis

### Temporal Flows Identified

1. **SSE Streaming Completion Flow**
   - Client sends POST `/chats/{id}/complete?stream=true`
   - Server streams SSE events (content, tool_call_start, tool_call_result, tool_calls_complete, done)
   - Client accumulates streaming content via `useCompletion` hook
   - Uses `completion_id` for event correlation to prevent stale updates

2. **Tool Execution Flow**
   - When AI returns `finish_reason: tool_calls`, server executes tools sequentially
   - Each tool call persisted to `tool_calls` table with status tracking
   - Tool response messages saved to `messages` table
   - Tool results streamed back to client via SSE events

3. **Agent-Manager Tool Calls**
   - `spawn_coding_agent` spawns long-running agents (up to 30 minutes)
   - Returns immediately with `run_id`, stores in `external_run_id` field
   - User must poll `check_agent_status` to monitor progress
   - Startup reconciliation queries agent-manager to recover state after restart

4. **Auto-naming Flow**
   - Triggers after first AI response when chat has "New Chat" name
   - Calls Ollama asynchronously, falls back to default name on failure

5. **Chat List Polling**
   - Client polls `/chats` every 10 seconds via React Query `refetchInterval`

### Mitigations Implemented

| Issue | Mitigation | Location |
|-------|------------|----------|
| Race conditions in streaming | Request ID tracking + guards | `useCompletion.ts` |
| Stale SSE events | `completion_id` in all events | `handlers/sse.go` |
| Connection drop during streaming | AbortController + cleanup | `lib/api.ts`, `useCompletion.ts` |
| Orphaned tool calls on restart | Startup reconciliation | `services/reconciliation.go` |
| Tool execution errors swallowed | Aggregated error reporting | `services/completion.go` |

### Remaining Architectural Considerations

**1. No Server-Side Streaming Checkpoints**
- If connection drops mid-stream, accumulated content is lost
- Client must retry from beginning
- **Future option**: Store streaming checkpoints in DB, allow client resume with last checkpoint ID
- **Tradeoff**: Adds complexity and DB writes for a relatively rare failure mode

**2. Long-Running Agent Monitoring**
- `spawn_coding_agent` returns immediately; user must manually poll status
- **Future option**: Background poller that monitors active tool calls with `external_run_id`
- **Future option**: WebSocket/SSE subscription for agent status updates
- **Current pattern**: User-driven polling is acceptable for MVP

**3. No Retry for Failed Tool Calls**
- Tool calls that fail are marked failed with error message
- User must create new message to retry
- **Future option**: Add "retry tool call" endpoint
- **Current pattern**: Fail-fast is appropriate for debugging/development

**4. Partial Tool Call Results**
- If server crashes mid-tool-execution, some tools may have succeeded
- Reconciliation marks orphaned as cancelled, but successful intermediate results are preserved
- **Current pattern**: Acceptable - user can see what completed before failure
