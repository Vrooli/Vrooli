# Progress Log

Track development progress here. Each agent session should add an entry.

| Date | Author | Status Snapshot | Notes |
|------|--------|-----------------|-------|
| 2025-11-28 | Generator Agent | Initialization complete | Scenario scaffold, PRD, requirements registry seeded. Ready for P0 implementation. |
| 2025-11-28 | Improver Agent | Core P0 progress (33% coverage) | Full Go API with CRUD for chats, messages, labels; PostgreSQL schema; Inbox UI with chat list, messaging, read/unread, archive, star; 14 API tests; Selector registry for BAS workflows. Completeness: 12→12/100. Next: OpenRouter integration, streaming, multi-layer E2E validation. |
| 2025-11-28 | Improver Agent (Phase 1 Iteration 2) | Security & standards fixes | Fixed CORS wildcard vulnerability (HTTP-002); updated Makefile to match standards template; fixed service.json health endpoints; added 4 E2E playbooks for multi-layer validation; updated requirements with integration phase tests. Security: 1→0 vulnerabilities. Standards violations reduced from 75→50. |
| 2025-12-25 | Improver Agent | OpenRouter integration & P0 progress (40% coverage) | Added OpenRouter chat completion with SSE streaming (api/openrouter.go); model selector UI with dropdown; streaming response display; fixed 4 HIGH standards violations (PRD sections, service.json condition structure, pnpm --ignore-workspace); added usage-stats requirements module. Standards violations: 52→2. Completeness: 24→26/100. Requirements coverage: 33%→40%. Next: Add focused API tests, reduce monolithic test files. |
| 2025-12-25 | Improver Agent | Test restructuring & P0 progress | Split monolithic main_test.go into 5 focused test files: inbox_test.go (312 LOC, 8 tests), chat_test.go (264 LOC, 10 tests), persistence_test.go (379 LOC, 14 tests), labels_test.go (457 LOC, 14 tests), openrouter_test.go (237 LOC, 8 tests). Added tests for /api/v1/models and /api/v1/chats/{id}/complete endpoints. Updated requirements to point to focused test files. Marked LABEL-005 and LABEL-006 as complete with API tests. Fixed database schema conflict by adding scenario-specific PostgreSQL schema (agent_inbox). Scenario now starts and API healthy (http://localhost:16661). Security: 0 vulnerabilities. Standards: 1 medium (Go workspace mode). Requirements coverage: 40%→44%. Next: Install openrouter resource, run integration tests, add NAME-* requirement tests. |
| 2025-12-25 | Claude Opus 4.5 | Tool calling & agent-manager integration | Major architectural update to support the "inbox as dispatcher" pattern. Agent-inbox now acts as a conversational hub that dispatches coding tasks to agent-manager via tool calls. Key changes: (1) Extended database schema with tool_calls table and message fields for tool_call_id, tool_calls JSONB, response_id, finish_reason; (2) Added tools.go with 6 agent-manager tools (spawn_coding_agent, check_agent_status, stop_agent, list_active_agents, get_agent_diff, approve_agent_changes); (3) Updated openrouter.go to handle OpenRouter Responses API with streaming tool call events; (4) Added handleListTools and handleListChatToolCalls API endpoints; (5) Updated UI MessageList to display tool calls with running/completed/failed states; (6) Added activeToolCalls state to useChats hook with streaming event handling; (7) Added agent-manager as scenario dependency in service.json. API compiles and TypeScript passes. Next: Add tests for tool call flow, integrate with running agent-manager. |
| 2025-12-25 | Claude Opus 4.5 | P0-005 Auto-naming & Responses API storage | Implemented auto-naming with Ollama (P0-005): (1) Added ollama.go with handleAutoName endpoint that uses local Ollama (llama3.1:8b) to generate concise chat names from conversation content; (2) Added /api/v1/chats/{id}/auto-name POST endpoint; (3) Added autoNameChat API function and useChats mutation; (4) Auto-naming triggers after first AI response when chat has default "New Chat" name. Updated conversation storage for Responses API pattern: (1) handleGetChat now returns all message fields including tool_call_id, tool_calls, response_id, finish_reason; (2) handleAddMessage now accepts tool role with tool_call_id validation. Added naming_test.go with 6 new tests for auto-naming and tool messages. Installed openrouter resource. Security: 0 vulnerabilities. Standards: 1 medium (Go workspace mode). |
| 2025-12-25 | Claude Opus 4.5 | Control Surface & Graceful Degradation | Applied ecosystem-manager design guides (control-surface-tunable-levers-design.md, failure-topography-and-graceful-degradation.md). **Control Surface:** Added `config/config.go` with centralized, validated configuration for all tunable levers - server timeouts, AI defaults, naming parameters, integration timeouts, and resilience settings. All levers have sane defaults, clear documentation of tradeoffs, and bounded validation. **Graceful Degradation:** Added `resilience/` package with (1) retry.go - exponential backoff retry with permanent error support; (2) circuit_breaker.go - full circuit breaker implementation (closed/open/half-open states) with thread-safety and metrics; (3) fallback.go - typed fallback helpers for graceful degradation. Updated integrations to use config: OllamaClient, OpenRouterClient, AgentManagerClient now inject timeouts from config. Health endpoint upgraded to report dependency status (healthy/degraded/unhealthy) and capability availability. Added 24 new tests for config validation and resilience patterns. All tests pass. |
| 2025-12-25 | Claude Opus 4.5 | Temporal Flow Audit & Interruption Resilience | Applied ecosystem-manager temporal-flow-audit.md and progress-continuity-interruption-resilience.md guides. **Critical fixes:** (1) **Race condition in useCompletion** - Added request ID tracking to prevent stale state updates; each completion gets unique ID, state updates guarded by ID match; (2) **AbortController for streaming** - Added cancellation support to `completeChat()` API; abort on unmount or new request; properly releases stream reader; (3) **Error propagation fix** - `ExecuteToolCalls` no longer silently swallows errors; returns aggregated error while still providing partial results; (4) **Cleanup on unmount** - useCompletion now cancels in-flight requests when component unmounts via useEffect cleanup; (5) **Completion tracking** - Added `completion_id` to all SSE events for client-side correlation, preventing stale event handling. **Key temporal flows documented:** SSE streaming, tool execution, auto-naming, retry/circuit breaker flows. **Remaining considerations:** Tool calls not resumable on restart (long-running agents can be orphaned), no server-side streaming checkpoints. All changes compile and pass type checking. |
| 2025-12-25 | Claude Opus 4.5 | Startup Reconciliation for Orphaned Tool Calls | Applied second pass of temporal-flow-audit.md and progress-continuity-interruption-resilience.md. **Implemented:** (1) **Startup reconciliation service** - `services/reconciliation.go` that runs at server startup to find and reconcile orphaned tool calls; (2) **ListOrphanedToolCalls query** - persistence method to find tool calls in 'pending'/'running' status; (3) **UpdateToolCallStatus method** - allows marking tool calls as cancelled/completed/failed with error messages; (4) **Agent-manager integration** - reconciliation checks agent-manager for still-running agents and updates status accordingly; (5) **Main.go integration** - reconciliation runs after schema init, before server starts. **Remaining architectural considerations documented below.** |
| 2025-12-25 | Claude Opus 4.5 | P0 Naming & Labels Complete | **Marked 5 requirements complete with proper validation refs.** Implemented NAME-004 (double-click to rename) with inline editing in ChatList: (1) Double-click on chat name enters edit mode with input field; (2) Enter/blur saves, Escape cancels; (3) Proper focus management and value sync; (4) Added 18 UI tests for ChatList including inline rename functionality. **Fixed test infrastructure:** Added jsdom dependency, passWithNoTests in vitest config, lighthouse.json version field. Completion: 44%→55.6%. Critical gap: 25→20. P0 naming complete (4/4). P0 labels complete (6/6). |
| 2025-12-25 | Claude Opus 4.5 | Removed Terminal View Mode | **Scope reduction per user request.** Terminal view mode (TERM-001 through TERM-006) removed from requirements and codebase. **Changes:** (1) Deleted `requirements/04-terminal/core.json` and updated index; (2) Removed `ViewModeTerminal` constant and validation from `domain/types.go`; (3) Simplified `MessageList.tsx` to only use bubble mode; (4) Removed terminal icon condition from `ChatList.tsx`; (5) Updated PRD to replace terminal references with tool-calling/agent-manager integration; (6) Updated PROBLEMS.md, RESEARCH.md, requirements README.md. **Impact:** Requirements: 45→39 total. Completion: 55.6%→64.1%. Critical gap: 20→14. All tests pass. |
| 2025-12-25 | Claude Opus 4.5 | Full-text Search (SEARCH-001-003) Complete | **Implemented PostgreSQL full-text search across chats and messages.** (1) **API:** Added `messages.search_vector` and `chats.search_vector` tsvector columns with GIN indexes; triggers auto-populate on insert/update; `GET /api/v1/search?q=query&limit=20` endpoint with ranked results and highlighted snippets using `ts_headline`; (2) **UI:** New `useSearch` hook with 300ms debounce and react-query caching; ChatList now shows server-side search results with match type indicator and highlighted snippets; (3) **Navigation:** Clicking search result passes `messageId` to `onSelectChat`; MessageList scrolls to and highlights target message with yellow ring animation that fades after 2 seconds. (4) **Tests:** Updated ChatList tests with QueryClientProvider wrapper and mocked searchChats API. **Impact:** Requirements: 28/39 complete. Completion: 64.1%→71.8%. Critical gap: 14→11. All tests pass. |
| 2025-12-25 | Claude Opus 4.5 | Keyboard Navigation Complete (KEY-001-005) | **Implemented all 5 keyboard shortcuts for power users.** (1) **J/K navigation (KEY-001):** Added focusedIndex state in App.tsx; j moves focus down, k moves up; visual focus ring on ChatList items; scroll-into-view on focus change; (2) **Enter to open (KEY-002):** Opens the currently focused chat; (3) **Escape to close (KEY-003):** Already implemented, closes dialogs or deselects chat; (4) **Ctrl/Cmd+N new chat (KEY-004):** Already implemented; (5) **/ or Ctrl+K for search (KEY-005):** Added "/" as additional shortcut to focus search. **UI updates:** Updated KeyboardShortcuts help dialog with new shortcuts; ChatListItem now supports forwardRef and isFocused prop. **Tests:** Added useKeyboardShortcuts.test.ts with 17 tests covering key matching, modifiers, input exclusion, Escape special case; added 4 focus tests to ChatList.test.tsx. All 40 UI tests pass. **Impact:** Requirements: 30/36 complete. Completion: 71.8%→83.3%. Critical gap: 11→6. |
| 2025-12-25 | Claude Opus 4.5 | Export Chat Complete (PERSIST-005) | **Implemented chat export to markdown, JSON, and plain text.** (1) **API:** Added `GET /api/v1/chats/{id}/export?format=markdown|json|txt` endpoint in handlers/chat.go; formatMarkdown() and formatPlainText() helpers for content formatting; sanitizeFilename() for safe download filenames; proper Content-Type and Content-Disposition headers for file download. (2) **UI:** Added Export option to ChatHeader's "More actions" dropdown; Export dialog with three format buttons (Markdown, JSON, Plain Text) with descriptions; exportChat() API function with browser download trigger. (3) **Tests:** Added 5 API tests in chat_test.go for all formats, invalid format validation, and default format behavior. All 40 UI tests pass. **Impact:** Requirements: 31/36 complete. Completion: 83.3%→86.1%. Critical gap: 6→5. |
| 2025-12-26 | Claude Opus 4.5 | Usage Tracking Complete (USAGE-001-003) | **Implemented full usage tracking with token counts and cost estimation.** (1) **API:** Added `usage_records` table with prompt/completion token counts and costs; `UsageRecord`, `UsageStats`, `ModelUsage`, `DailyUsage` domain types; `GET /api/v1/usage`, `GET /api/v1/usage/records`, `GET /api/v1/chats/{id}/usage` endpoints with date filtering and pagination; `SaveUsageRecord`, `GetUsageStats`, `GetChatUsageStats`, `GetUsageRecords` persistence methods. (2) **Cost Calculation:** Added `integrations/pricing.go` with model pricing data for Claude, GPT-4, Gemini, Llama, Mistral; `CalculateUsageCost` function with per-model pricing (cents per million tokens); costs calculated and stored on each completion. (3) **UI:** Added `UsageStats.tsx` component with summary cards (total tokens, total cost), model breakdown, and recent daily activity; accessible from Settings via "View Usage Statistics" button. (4) **Tests:** Added `pricing_test.go` with tests for pricing lookup, cost calculation accuracy, and usage record creation. **Impact:** Requirements: 34/36 complete. Completion: 86.1%→94.4%. Critical gap: 5→2. |
| 2025-12-26 | Claude Opus 4.5 | Modular Tool Configuration UI (Phase 3) | **Implemented full UI for dynamic tool configuration - both global defaults and per-chat overrides.** Building on the Tool Discovery Protocol (Phase 1) and ToolRegistry service (Phase 2), this completes the modular tool architecture. **(1) API Types:** Added 15 new TypeScript types in `api.ts` for tool discovery protocol (`ScenarioInfo`, `ToolParameters`, `ToolMetadata`, `EffectiveTool`, `ToolSet`, `ScenarioStatus`, etc.); 5 API functions (`fetchToolSet`, `fetchScenarioStatuses`, `setToolEnabled`, `resetToolConfig`, `refreshTools`). **(2) State Management:** Created `useTools` hook with react-query for caching; supports global and chat-specific configurations; optimistic updates; derived data (enabledTools, toolsByScenario, toolsByCategory). **(3) Settings Modal:** Added "AI Tools" section with collapsible `ToolConfiguration` component showing tools grouped by scenario with toggle switches, metadata badges (long-running, cost), enabled counts, and refresh capability. **(4) Per-Chat Tools:** Added `ChatToolsSelector` popover in ChatHeader; shows tool count badge; indicates when chat has overrides (indigo highlight); allows reset to default. **(5) Tests:** Added 46 new tests across 3 files (`useTools.test.ts`, `ToolConfiguration.test.tsx`, `ChatToolsSelector.test.tsx`). All 77 UI tests pass, all Go tests pass. **Architecture follows screaming architecture principles:** clear boundaries between hooks/components/api, testing seams via dependency injection, pure presentational components. |
| 2025-12-26 | Claude Opus 4.5 | Tabbed Settings Redesign | **Redesigned Settings modal with 3-tab logical grouping to reduce clutter.** (1) **New Tabs component:** Created reusable `ui/tabs.tsx` with `Tabs`, `TabsList`, `TabsTrigger`, `TabsContent` components; context-based state sharing; full accessibility (aria-selected, tablist role, tabpanel role); 10 tests. (2) **Tab organization:** **General** (Appearance theme toggle, Keyboard shortcuts), **AI** (Default model selector, AI Tools configuration), **Data** (Usage statistics, Danger zone). (3) **UX improvements:** Delete confirmation resets when switching tabs; tool data only fetched when AI tab active; icons on tab triggers for visual clarity. All 87 UI tests pass. |
| 2025-12-26 | Claude Opus 4.5 | URL-based Chat Routing | **Implemented URL-based routing so chats persist on page refresh.** (1) **useChatRoute hook:** New `hooks/useChatRoute.ts` with `useChatRoute()` for reading/writing chat ID to URL (`/chat/:id` pattern) and `usePopStateListener()` for browser back/forward navigation; uses History API (pushState/replaceState) without adding router dependency. (2) **useChats integration:** Added `initialChatId` and `onChatChange` options to `useChats` hook; all chat selection mutations now trigger URL sync. (3) **App.tsx integration:** Reads initial chat from URL on page load; syncs URL when chat changes; handles browser back/forward via popstate listener. (4) **Tests:** Added `useChatRoute.test.ts` with 16 tests covering URL parsing, pushState, replaceState, and popstate handling. All 103 UI tests pass. |

---

## Temporal Flow & Interruption Resilience Analysis

### Temporal Flows Identified

1. **SSE Streaming Completion Flow**
   - Client sends POST `/chats/{id}/complete?stream=true`
   - Server streams SSE events (content, tool_call_start, tool_call_result, tool_calls_complete, done)
   - Client accumulates streaming content via `useCompletion` hook
   - Uses `completion_id` for event correlation to prevent stale updates

2. **Tool Execution Flow**
   - When AI returns `finish_reason: tool_calls`, server executes tools sequentially
   - Each tool call persisted to `tool_calls` table with status tracking
   - Tool response messages saved to `messages` table
   - Tool results streamed back to client via SSE events

3. **Agent-Manager Tool Calls**
   - `spawn_coding_agent` spawns long-running agents (up to 30 minutes)
   - Returns immediately with `run_id`, stores in `external_run_id` field
   - User must poll `check_agent_status` to monitor progress
   - Startup reconciliation queries agent-manager to recover state after restart

4. **Auto-naming Flow**
   - Triggers after first AI response when chat has "New Chat" name
   - Calls Ollama asynchronously, falls back to default name on failure

5. **Chat List Polling**
   - Client polls `/chats` every 10 seconds via React Query `refetchInterval`

### Mitigations Implemented

| Issue | Mitigation | Location |
|-------|------------|----------|
| Race conditions in streaming | Request ID tracking + guards | `useCompletion.ts` |
| Stale SSE events | `completion_id` in all events | `handlers/sse.go` |
| Connection drop during streaming | AbortController + cleanup | `lib/api.ts`, `useCompletion.ts` |
| Orphaned tool calls on restart | Startup reconciliation | `services/reconciliation.go` |
| Tool execution errors swallowed | Aggregated error reporting | `services/completion.go` |

### Remaining Architectural Considerations

**1. No Server-Side Streaming Checkpoints**
- If connection drops mid-stream, accumulated content is lost
- Client must retry from beginning
- **Future option**: Store streaming checkpoints in DB, allow client resume with last checkpoint ID
- **Tradeoff**: Adds complexity and DB writes for a relatively rare failure mode

**2. Long-Running Agent Monitoring**
- `spawn_coding_agent` returns immediately; user must manually poll status
- **Future option**: Background poller that monitors active tool calls with `external_run_id`
- **Future option**: WebSocket/SSE subscription for agent status updates
- **Current pattern**: User-driven polling is acceptable for MVP

**3. No Retry for Failed Tool Calls**
- Tool calls that fail are marked failed with error message
- User must create new message to retry
- **Future option**: Add "retry tool call" endpoint
- **Current pattern**: Fail-fast is appropriate for debugging/development

**4. Partial Tool Call Results**
- If server crashes mid-tool-execution, some tools may have succeeded
- Reconciliation marks orphaned as cancelled, but successful intermediate results are preserved
- **Current pattern**: Acceptable - user can see what completed before failure
