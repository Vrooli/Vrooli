{
  "name": "NutriTrack - Meal Suggester",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "nutrition-tracker/meal-suggester",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  user_id: 'test-user',\n  meal_type: 'lunch',\n  dietary_preferences: 'balanced',\n  remaining_calories: 600,\n  remaining_protein: 25,\n  remaining_carbs: 75,\n  remaining_fat: 20\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $('Manual').first() !== undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Merge webhook or default data\nconst isManual = $('Manual').first() !== undefined;\nconst input = isManual ? $json : $('Webhook').first().json;\n\nconst prompt = `You are a nutrition expert creating personalized meal suggestions.\n\nUser needs:\n- Meal type: ${input.meal_type}\n- Remaining calories: ${input.remaining_calories}\n- Remaining protein: ${input.remaining_protein}g\n- Remaining carbs: ${input.remaining_carbs}g\n- Remaining fat: ${input.remaining_fat}g\n- Dietary preferences: ${input.dietary_preferences}\n\nGenerate 3 meal suggestions that:\n1. Fit within the nutritional targets\n2. Are diverse and interesting\n3. Match the meal type (breakfast/lunch/dinner/snack)\n4. Consider dietary preferences\n\nReturn ONLY a JSON array with exactly 3 meals:\n[\n  {\n    \"meal_name\": \"name of meal\",\n    \"description\": \"brief description\",\n    \"ingredients\": [\"ingredient1\", \"ingredient2\"],\n    \"calories\": number,\n    \"protein_g\": number,\n    \"carbs_g\": number,\n    \"fat_g\": number,\n    \"prep_time_min\": number,\n    \"reason\": \"why this meal fits the user's needs\"\n  }\n]`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    model: \"llama3.2\",\n    type: \"generation\",\n    temperature: 0.7,\n    format: \"json\",\n    quiet: true,\n    original_input: input\n  }\n}];"
      },
      "id": "prepare-prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.service.n8n.url }}/webhook/ollama",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  prompt: $json.prompt,\n  model: $json.model,\n  type: $json.type,\n  quiet: $json.quiet,\n  timeout_seconds: $json.timeout_seconds || 120\n}) }}",
        "options": {
          "timeout": 180000
        }
      },
      "id": "generate-suggestions",
      "name": "Call Shared Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse and validate the response from HTTP request\nconst httpResponse = $json;\nconst originalInput = $('Prepare Prompt').first().json.original_input;\n\ntry {\n  // Extract the actual response from the ollama HTTP response\n  let ollamaResponse = httpResponse.response;\n  \n  // Parse the JSON response\n  let suggestions = [];\n  \n  if (typeof ollamaResponse === 'string') {\n    suggestions = JSON.parse(ollamaResponse);\n  } else {\n    suggestions = ollamaResponse;\n  }\n  \n  // Ensure it's an array\n  if (!Array.isArray(suggestions)) {\n    suggestions = [suggestions];\n  }\n  \n  // Take only first 3 and enrich with metadata\n  const enrichedSuggestions = suggestions.slice(0, 3).map((meal, index) => ({\n    id: `meal_${Date.now()}_${index}`,\n    user_id: originalInput.user_id,\n    meal_type: originalInput.meal_type,\n    meal_name: meal.meal_name || `Meal Option ${index + 1}`,\n    description: meal.description || 'Nutritious meal',\n    ingredients: meal.ingredients || [],\n    calories: meal.calories || Math.round(originalInput.remaining_calories * 0.4),\n    protein_g: meal.protein_g || Math.round(originalInput.remaining_protein * 0.4),\n    carbs_g: meal.carbs_g || Math.round(originalInput.remaining_carbs * 0.4),\n    fat_g: meal.fat_g || Math.round(originalInput.remaining_fat * 0.4),\n    prep_time_min: meal.prep_time_min || 30,\n    reason: meal.reason || 'Balanced meal based on your targets',\n    created_at: new Date().toISOString()\n  }));\n  \n  return [{\n    json: {\n      success: true,\n      suggestions: enrichedSuggestions,\n      message: `Generated ${enrichedSuggestions.length} meal suggestions`,\n      user_id: originalInput.user_id,\n      meal_type: originalInput.meal_type\n    }\n  }];\n  \n} catch (error) {\n  // Fallback suggestions if parsing fails\n  return [{\n    json: {\n      success: false,\n      error: error.message,\n      suggestions: [\n        {\n          meal_name: 'Balanced Bowl',\n          description: 'A nutritious balanced meal',\n          ingredients: ['mixed vegetables', 'lean protein', 'whole grains'],\n          calories: Math.round(originalInput.remaining_calories * 0.4),\n          protein_g: Math.round(originalInput.remaining_protein * 0.4),\n          carbs_g: Math.round(originalInput.remaining_carbs * 0.4),\n          fat_g: Math.round(originalInput.remaining_fat * 0.4),\n          prep_time_min: 25,\n          reason: 'Balanced macronutrients'\n        }\n      ],\n      user_id: originalInput.user_id,\n      meal_type: originalInput.meal_type\n    }\n  }];\n}"
      },
      "id": "process-response",
      "name": "Process Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Prepare Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual": {
      "main": [
        [
          {
            "node": "Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Defaults": {
      "main": [
        [
          {
            "node": "Prepare Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Prompt": {
      "main": [
        [
          {
            "node": "Call Shared Ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Shared Ollama": {
      "main": [
        [
          {
            "node": "Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Response": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["nutrition", "meal-planning", "ai"],
  "id": "meal-suggester"
}