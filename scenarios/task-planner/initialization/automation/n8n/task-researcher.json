{
  "name": "Task Planner - Research Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "research-task",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook - Research Task",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT t.*, a.name as app_name, a.display_name as app_display_name FROM tasks t JOIN apps a ON t.app_id = a.id WHERE t.id = '{{ $json.task_id }}' AND t.status = 'backlog'",
        "additionalFields": {}
      },
      "id": "get_task_details",
      "name": "Get Task Details",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check_task_exists",
      "name": "Check Task Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [600, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO agent_runs (task_id, action, agent_name, model_used, prompt_template) VALUES ('{{ $('get_task_details').item.json.id }}', 'research', 'research-coordinator', 'multi-agent', 'task_research_template') RETURNING id",
        "additionalFields": {}
      },
      "id": "create_agent_run",
      "name": "Create Agent Run Record",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [800, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE tasks SET status = 'in_progress' WHERE id = '{{ $('get_task_details').item.json.id }}'",
        "additionalFields": {}
      },
      "id": "mark_in_progress",
      "name": "Mark Task In Progress",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [800, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:9201/search",
        "authentication": "none",
        "requestMethod": "GET",
        "qs": {
          "q": "={{ $('get_task_details').item.json.title }} {{ $('get_task_details').item.json.description }}",
          "categories": "it,stackoverflow,github",
          "engines": "duckduckgo,stackoverflow,github",
          "format": "json",
          "safesearch": "0"
        }
      },
      "id": "searxng_research",
      "name": "SearXNG Research",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1000, 100]
    },
    {
      "parameters": {
        "url": "http://localhost:4113/api/search",
        "authentication": "none",
        "requestMethod": "POST",
        "body": {
          "query": "{{ $('get_task_details').item.json.title }} implementation guide best practices",
          "maxResults": 5,
          "domains": ["github.com", "stackoverflow.com", "docs.*", "*.readthedocs.io"]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "agents2_research",
      "name": "Agent-S2 Research",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT title, description, investigation_report, implementation_plan, technical_requirements FROM tasks WHERE app_id = '{{ $('get_task_details').item.json.app_id }}' AND status IN ('staged', 'completed') AND title_embedding <-> (SELECT title_embedding FROM tasks WHERE id = '{{ $('get_task_details').item.json.id }}') < 0.3 ORDER BY title_embedding <-> (SELECT title_embedding FROM tasks WHERE id = '{{ $('get_task_details').item.json.id }}') LIMIT 3",
        "additionalFields": {}
      },
      "id": "find_similar_tasks",
      "name": "Find Similar Tasks",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "jsCode": "// Combine and structure research data\nconst task = $('get_task_details').item.json;\nconst searxngResults = $('searxng_research').item.json?.results || [];\nconst agentResults = $('agents2_research').item.json?.results || [];\nconst similarTasks = $input.all();\n\n// Extract relevant search results\nconst relevantResults = [\n  ...searxngResults.slice(0, 5).map(r => ({\n    title: r.title,\n    url: r.url,\n    content: r.content,\n    source: 'searxng'\n  })),\n  ...agentResults.slice(0, 3).map(r => ({\n    title: r.title,\n    url: r.url, \n    content: r.summary || r.content,\n    source: 'agent-s2'\n  }))\n];\n\n// Structure research context\nconst researchContext = {\n  task: {\n    title: task.title,\n    description: task.description,\n    priority: task.priority,\n    tags: task.tags,\n    app_name: task.app_name\n  },\n  research_results: relevantResults,\n  similar_tasks: similarTasks.map(st => ({\n    title: st.json.title,\n    description: st.json.description,\n    technical_requirements: st.json.technical_requirements,\n    implementation_plan: st.json.implementation_plan\n  })),\n  research_summary: {\n    total_sources: relevantResults.length,\n    search_terms: `${task.title} ${task.description}`,\n    domains_searched: ['github.com', 'stackoverflow.com', 'documentation sites'],\n    similar_tasks_found: similarTasks.length\n  }\n};\n\nreturn [{ research_context: researchContext, task_id: task.id }];"
      },
      "id": "combine_research",
      "name": "Combine Research Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 200]
    },
    {
      "parameters": {
        "model": "llama3.2",
        "prompt": "You are a technical research analyst. Based on the following research data, create a comprehensive investigation report and implementation plan.\n\nTask Details:\n{{ JSON.stringify($json.research_context.task, null, 2) }}\n\nResearch Results:\n{{ JSON.stringify($json.research_context.research_results, null, 2) }}\n\nSimilar Tasks (for reference):\n{{ JSON.stringify($json.research_context.similar_tasks, null, 2) }}\n\nGenerate a JSON response with exactly this structure:\n{\n  \"investigation_report\": \"Detailed analysis of the task, requirements, and approach based on research findings. Include key insights, potential challenges, and recommended technologies/approaches.\",\n  \"implementation_plan\": \"Step-by-step implementation plan with specific actions, dependencies, and milestones. Be concrete and actionable.\",\n  \"technical_requirements\": \"Specific technical requirements, dependencies, libraries, APIs, or tools needed for implementation.\",\n  \"estimated_hours\": 4.5,\n  \"confidence_score\": 0.85,\n  \"research_artifacts\": [\n    {\n      \"type\": \"documentation\",\n      \"title\": \"Most relevant documentation found\",\n      \"url\": \"https://example.com/docs\",\n      \"relevance_score\": 0.9,\n      \"key_points\": \"Main takeaways from this source\"\n    }\n  ]\n}\n\nEnsure the response is valid JSON only, no other text.",
        "options": {
          "temperature": 0.2,
          "maxTokens": 4096
        }
      },
      "id": "generate_analysis",
      "name": "Generate Analysis with Ollama",
      "type": "n8n-nodes-base.ollama",
      "typeVersion": 1,
      "position": [1400, 200]
    },
    {
      "parameters": {
        "jsCode": "// Parse and validate the Ollama analysis response\ntry {\n  const ollamaResponse = $json.response;\n  const taskId = $('get_task_details').item.json.id;\n  \n  // Clean and parse the JSON response\n  let analysisData;\n  try {\n    const cleanResponse = ollamaResponse.replace(/```json\\n?|```\\n?/g, '').trim();\n    analysisData = JSON.parse(cleanResponse);\n  } catch (parseError) {\n    // Fallback parsing\n    const jsonMatch = ollamaResponse.match(/\\{[\\s\\S]*\\}/s);\n    if (jsonMatch) {\n      analysisData = JSON.parse(jsonMatch[0]);\n    } else {\n      throw new Error('Could not extract valid JSON from analysis response');\n    }\n  }\n  \n  // Validate required fields\n  const requiredFields = ['investigation_report', 'implementation_plan', 'technical_requirements'];\n  for (const field of requiredFields) {\n    if (!analysisData[field]) {\n      throw new Error(`Missing required field: ${field}`);\n    }\n  }\n  \n  // Prepare update data\n  const updateData = {\n    task_id: taskId,\n    investigation_report: analysisData.investigation_report,\n    implementation_plan: analysisData.implementation_plan,\n    technical_requirements: analysisData.technical_requirements,\n    estimated_hours: parseFloat(analysisData.estimated_hours) || null,\n    confidence_score: parseFloat(analysisData.confidence_score) || 0.5,\n    research_artifacts: analysisData.research_artifacts || []\n  };\n  \n  return [{ success: true, ...updateData }];\n  \n} catch (error) {\n  return [{ \n    success: false,\n    error: error.message,\n    task_id: $('get_task_details').item.json.id,\n    raw_response: $json.response\n  }];\n}"
      },
      "id": "process_analysis",
      "name": "Process Analysis Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.success }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check_analysis_success",
      "name": "Check Analysis Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1800, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE tasks SET investigation_report = '{{ $json.investigation_report }}', implementation_plan = '{{ $json.implementation_plan }}', technical_requirements = '{{ $json.technical_requirements }}', estimated_hours = {{ $json.estimated_hours || 'NULL' }}, confidence_score = {{ $json.confidence_score }}, status = 'staged' WHERE id = '{{ $json.task_id }}'",
        "additionalFields": {}
      },
      "id": "update_task_analysis",
      "name": "Update Task with Analysis",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2000, 100]
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "output": "input",
        "rules": {
          "rules": [
            {
              "operation": "containsAny",
              "value": "={{ $json.research_artifacts }}",
              "output": "split"
            }
          ]
        }
      },
      "id": "split_artifacts",
      "name": "Split Research Artifacts",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO research_artifacts (task_id, type, source_url, title, content, relevance_score, metadata) VALUES ('{{ $('process_analysis').item.json.task_id }}', '{{ $json.type }}', '{{ $json.url }}', '{{ $json.title }}', '{{ $json.key_points }}', {{ $json.relevance_score }}, '{{ JSON.stringify({ source: \"research_workflow\", generated_at: new Date().toISOString() }) }}')",
        "additionalFields": {}
      },
      "id": "save_artifact",
      "name": "Save Research Artifact",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2200, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE agent_runs SET successful = true, output_data = '{{ JSON.stringify($('process_analysis').item.json) }}', completed_at = CURRENT_TIMESTAMP WHERE id = '{{ $('create_agent_run').item.json.id }}'",
        "additionalFields": {}
      },
      "id": "complete_agent_run",
      "name": "Complete Agent Run",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO task_transitions (task_id, from_status, to_status, triggered_by, trigger_type, reason) VALUES ('{{ $('process_analysis').item.json.task_id }}', 'backlog', 'staged', 'research-workflow', 'automated', 'Task research and planning completed successfully')",
        "additionalFields": {}
      },
      "id": "record_transition",
      "name": "Record Status Transition",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2200, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT t.*, COUNT(ra.id) as artifact_count FROM tasks t LEFT JOIN research_artifacts ra ON t.id = ra.task_id WHERE t.id = '{{ $('process_analysis').item.json.task_id }}' GROUP BY t.id",
        "additionalFields": {}
      },
      "id": "get_updated_task",
      "name": "Get Updated Task",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2400, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": true,\n  \"task_id\": \"{{ $json.id }}\",\n  \"status\": \"{{ $json.status }}\",\n  \"investigation_report\": \"{{ $json.investigation_report }}\",\n  \"implementation_plan\": \"{{ $json.implementation_plan }}\",\n  \"technical_requirements\": \"{{ $json.technical_requirements }}\",\n  \"estimated_hours\": {{ $json.estimated_hours }},\n  \"confidence_score\": {{ $json.confidence_score }},\n  \"artifacts_collected\": {{ $json.artifact_count }}\n}"
      },
      "id": "success_response",
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2600, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"Task not found or not in backlog status\",\n  \"task_id\": \"{{ $('webhook_trigger').item.json.task_id }}\"\n}",
        "options": {
          "responseCode": 404
        }
      },
      "id": "task_not_found_response",
      "name": "Task Not Found Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [600, 450]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE agent_runs SET successful = false, error_message = '{{ $json.error }}', completed_at = CURRENT_TIMESTAMP WHERE id = '{{ $('create_agent_run').item.json.id }}'",
        "additionalFields": {}
      },
      "id": "mark_agent_run_failed",
      "name": "Mark Agent Run Failed",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1800, 350]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE tasks SET status = 'backlog' WHERE id = '{{ $('get_task_details').item.json.id }}'",
        "additionalFields": {}
      },
      "id": "revert_task_status",
      "name": "Revert Task Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1800, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"Research analysis failed\",\n  \"details\": \"{{ $json.error }}\",\n  \"task_id\": \"{{ $json.task_id }}\"\n}",
        "options": {
          "responseCode": 500
        }
      },
      "id": "analysis_error_response",
      "name": "Analysis Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 450]
    }
  ],
  "pinData": {},
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "get_task_details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_task_details": {
      "main": [
        [
          {
            "node": "check_task_exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_task_exists": {
      "main": [
        [
          {
            "node": "create_agent_run",
            "type": "main",
            "index": 0
          },
          {
            "node": "mark_in_progress",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "task_not_found_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create_agent_run": {
      "main": [
        [
          {
            "node": "searxng_research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mark_in_progress": {
      "main": [
        [
          {
            "node": "agents2_research",
            "type": "main",
            "index": 0
          },
          {
            "node": "find_similar_tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "searxng_research": {
      "main": [
        [
          {
            "node": "combine_research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "agents2_research": {
      "main": [
        [
          {
            "node": "combine_research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "find_similar_tasks": {
      "main": [
        [
          {
            "node": "combine_research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "combine_research": {
      "main": [
        [
          {
            "node": "generate_analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate_analysis": {
      "main": [
        [
          {
            "node": "process_analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process_analysis": {
      "main": [
        [
          {
            "node": "check_analysis_success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_analysis_success": {
      "main": [
        [
          {
            "node": "update_task_analysis",
            "type": "main",
            "index": 0
          },
          {
            "node": "split_artifacts",
            "type": "main",
            "index": 0
          },
          {
            "node": "complete_agent_run",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "mark_agent_run_failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split_artifacts": {
      "main": [
        [
          {
            "node": "save_artifact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update_task_analysis": {
      "main": [
        [
          {
            "node": "record_transition",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "complete_agent_run": {
      "main": [
        [
          {
            "node": "get_updated_task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "record_transition": {
      "main": [
        [
          {
            "node": "get_updated_task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get_updated_task": {
      "main": [
        [
          {
            "node": "success_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mark_agent_run_failed": {
      "main": [
        [
          {
            "node": "revert_task_status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "revert_task_status": {
      "main": [
        [
          {
            "node": "analysis_error_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "task-planner",
      "name": "task-planner"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}