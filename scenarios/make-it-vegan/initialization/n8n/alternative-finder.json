{
  "name": "Make It Vegan - Alternative Finder",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "make-it-vegan/substitute",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Default values for manual testing\nconst defaults = {\n  ingredient: \"cheese\",\n  context: \"pizza topping\",\n  preferences: \"nut-free\"\n};\n\nreturn [{json: defaults}];"
      },
      "id": "default_values",
      "name": "Default Values",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Merge webhook or default data\nconst isManual = $('Manual Trigger').first() !== undefined;\nconst input = isManual ? $json : $('Webhook').first().json;\n\n// Prepare the prompt for Ollama\nconst ingredient = input.ingredient || 'unknown ingredient';\nconst context = input.context || 'general cooking';\nconst preferences = input.preferences || 'no specific preferences';\n\nconst prompt = `You are a vegan cooking expert. Suggest the best vegan alternatives for this non-vegan ingredient.\n\nIngredient to replace: ${ingredient}\nContext/Usage: ${context}\nDietary preferences/restrictions: ${preferences}\n\nProvide 3 alternatives ranked by suitability. For each alternative include:\n1. Name of the substitute\n2. Why it works well in this context\n3. Any adjustments needed when using it\n4. Where to find it (common stores)\n\nFormat as JSON:\n{\n  \"alternatives\": [\n    {\n      \"name\": \"substitute name\",\n      \"reason\": \"why it works\",\n      \"adjustments\": \"preparation tips\",\n      \"availability\": \"where to find\",\n      \"rating\": 1-5\n    }\n  ],\n  \"quickTip\": \"general advice for this substitution\"\n}`;\n\n// Prepare request for Ollama CLI\nreturn [{\n  json: {\n    prompt: prompt,\n    model: 'llama3.2:3b',\n    type: 'reasoning',\n    quiet: true,\n    timeout_seconds: 30,\n    original_request: {\n      ingredient: ingredient,\n      context: context,\n      preferences: preferences\n    }\n  }\n}];"
      },
      "id": "prepare_ollama",
      "name": "Prepare Ollama Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "workflowId": "ollama",
        "mode": "once",
        "source": "db",
        "passThrough": false
      },
      "id": "call_shared_ollama",
      "name": "Call Shared Ollama Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse the response from shared Ollama workflow\nconst response = $json;\nconst originalRequest = $node[\"prepare_ollama\"].json.original_request;\n\n// Get the response text from shared workflow\nconst responseText = response.response || '';\nconst success = response.success === true;\nconst hasError = response.error != null;\n\nlet result;\ntry {\n  // Check if the command was successful\n  if (!success) {\n    throw new Error(hasError ? response.error.message : 'Ollama workflow failed');\n  }\n  \n  // Try to parse as JSON\n  if (responseText && typeof responseText === 'string') {\n    // Clean up the response (remove markdown code blocks if present)\n    const cleanedResponse = responseText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    result = JSON.parse(cleanedResponse);\n  } else {\n    throw new Error('Empty response from Ollama');\n  }\n} catch (e) {\n  // Fallback to provide default alternatives if parsing fails\n  result = {\n    alternatives: [\n      {\n        name: 'Nutritional yeast',\n        reason: 'Provides umami and cheesy flavor',\n        adjustments: 'Use about 1/4 the amount',\n        availability: 'Health food stores, most supermarkets',\n        rating: 4\n      },\n      {\n        name: 'Cashew cream',\n        reason: 'Creamy texture similar to cheese',\n        adjustments: 'Soak cashews first, blend with water',\n        availability: 'Any store with nuts section',\n        rating: 5\n      },\n      {\n        name: 'Store-bought vegan cheese',\n        reason: 'Direct replacement, melts similarly',\n        adjustments: 'Use same amount as regular cheese',\n        availability: 'Health food stores, major supermarkets',\n        rating: 3\n      }\n    ],\n    quickTip: 'For best results, combine multiple alternatives',\n    error: e.message,\n    rawResponse: responseText\n  };\n}\n\n// Format final response\nreturn [{\n  json: {\n    request: originalRequest,\n    alternatives: result.alternatives || [],\n    quickTip: result.quickTip || '',\n    timestamp: new Date().toISOString(),\n    execution_details: {\n      model_used: response.request?.model || 'llama3.2:3b',\n      shared_workflow_used: true,\n      ollama_success: success\n    }\n  }\n}];"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1450, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "prepare_ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "default_values",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "default_values": {
      "main": [
        [
          {
            "node": "prepare_ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_ollama": {
      "main": [
        [
          {
            "node": "call_shared_ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "call_shared_ollama": {
      "main": [
        [
          {
            "node": "format_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format_response": {
      "main": [
        [
          {
            "node": "respond_webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "make-it-vegan-alternatives-v1.3.0",
  "id": "make-it-vegan-alternatives",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": []
}