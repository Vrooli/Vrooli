#!/bin/bash

# Smart Shopping Assistant CLI
# Version: 1.0.0

set -euo pipefail

# Configuration
API_HOST="${SMART_SHOPPING_API_HOST:-localhost}"
# Use dynamic port assignment from lifecycle system
API_PORT="${SMART_SHOPPING_API_PORT:-${API_PORT:-3300}}"
API_BASE_URL="http://${API_HOST}:${API_PORT}/api/v1"
PROFILE_ID="${SMART_SHOPPING_PROFILE:-11111111-1111-1111-1111-111111111111}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat << EOF
Smart Shopping Assistant CLI - Intelligent shopping research and price tracking

USAGE:
    smart-shopping-assistant <COMMAND> [OPTIONS]

COMMANDS:
    research <query>        Search for products with smart recommendations
    track <product-url>     Track product prices and set alerts  
    analyze-patterns        Analyze purchase patterns and predict needs
    status                  Show service status and health
    help                    Show this help message
    version                 Show version information

GLOBAL OPTIONS:
    --profile <id>          Use specific profile ID
    --json                  Output in JSON format
    --verbose               Show detailed output

EXAMPLES:
    smart-shopping-assistant research "laptop under 1000" --alternatives
    smart-shopping-assistant track "https://amazon.com/product" --target-price 50
    smart-shopping-assistant analyze-patterns --timeframe 90d --predict

For more information, visit: https://github.com/vrooli/scenarios/smart-shopping-assistant
EOF
}

# Version function
show_version() {
    echo "Smart Shopping Assistant CLI v1.0.0"
    echo "API: ${API_BASE_URL}"
}

# Status function
check_status() {
    echo -e "${BLUE}Checking Smart Shopping Assistant status...${NC}"
    
    response=$(curl -sf "${API_BASE_URL%/api/v1}/health" 2>/dev/null || echo "error")
    
    if [ "$response" = "error" ]; then
        echo -e "${RED}✗ API is not responding${NC}"
        echo "  Make sure the service is running: vrooli scenario run smart-shopping-assistant"
        exit 1
    else
        echo -e "${GREEN}✓ API is healthy${NC}"
        if [ "${JSON_OUTPUT:-false}" = "true" ]; then
            echo "$response"
        else
            echo "$response" | jq -r '"  Status: \(.status)\n  Service: \(.service)\n  Version: \(.version)"'
        fi
    fi
}

# Research function
do_research() {
    local query="$1"
    shift
    
    local budget=""
    local alternatives="false"
    local gift_for=""
    
    while [ $# -gt 0 ]; do
        case "$1" in
            --budget)
                budget="$2"
                shift 2
                ;;
            --alternatives)
                alternatives="true"
                shift
                ;;
            --gift-for)
                gift_for="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}Researching: ${query}${NC}"
    
    # Build JSON payload
    local payload=$(cat <<EOF
{
    "profile_id": "${PROFILE_ID}",
    "query": "${query}",
    "include_alternatives": ${alternatives}
EOF
)
    
    if [ -n "$budget" ]; then
        payload="${payload%\}}, \"budget_max\": ${budget}"
    fi
    
    if [ -n "$gift_for" ]; then
        payload="${payload%\}}, \"gift_recipient_id\": \"${gift_for}\""
    fi
    
    payload="${payload}}"
    
    response=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "${API_BASE_URL}/shopping/research" 2>/dev/null || echo "error")
    
    if [ "$response" = "error" ]; then
        echo -e "${RED}✗ Failed to perform research${NC}"
        exit 1
    fi
    
    if [ "${JSON_OUTPUT:-false}" = "true" ]; then
        echo "$response"
    else
        echo -e "\n${GREEN}Found Products:${NC}"
        echo "$response" | jq -r '.products[] | "  • \(.name) - $\(.current_price) (\(.category))"'
        
        if [ "$alternatives" = "true" ]; then
            echo -e "\n${YELLOW}Alternative Options:${NC}"
            echo "$response" | jq -r '.alternatives[] | "  • \(.product.name) (\(.alternative_type)) - Save $\(.savings_amount)"'
        fi
        
        echo -e "\n${BLUE}Recommendations:${NC}"
        echo "$response" | jq -r '.recommendations[] | "  • \(.)"'
        
        echo -e "\n${GREEN}Affiliate Links Available:${NC}"
        echo "$response" | jq -r '.affiliate_links[] | "  • \(.retailer): \(.url)"'
    fi
}

# Track function
do_track() {
    local product_url="$1"
    shift
    
    local target_price=""
    
    while [ $# -gt 0 ]; do
        case "$1" in
            --target-price)
                target_price="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}Setting up price tracking for: ${product_url}${NC}"
    
    local payload=$(cat <<EOF
{
    "profile_id": "${PROFILE_ID}",
    "product_url": "${product_url}",
    "target_price": ${target_price:-null}
}
EOF
)
    
    response=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "${API_BASE_URL}/shopping/tracking" 2>/dev/null || echo "error")
    
    if [ "$response" = "error" ]; then
        echo -e "${RED}✗ Failed to set up tracking${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✓ Price tracking activated${NC}"
    
    if [ -n "$target_price" ]; then
        echo "  Alert will trigger when price drops below \$${target_price}"
    fi
}

# Analyze patterns function
analyze_patterns() {
    local timeframe="${1:-30d}"
    local predict="${2:-false}"
    
    echo -e "${BLUE}Analyzing purchase patterns...${NC}"
    
    local payload=$(cat <<EOF
{
    "profile_id": "${PROFILE_ID}",
    "timeframe": "${timeframe}"
}
EOF
)
    
    response=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "${API_BASE_URL}/shopping/pattern-analysis" 2>/dev/null || echo "error")
    
    if [ "$response" = "error" ]; then
        echo -e "${RED}✗ Failed to analyze patterns${NC}"
        exit 1
    fi
    
    if [ "${JSON_OUTPUT:-false}" = "true" ]; then
        echo "$response"
    else
        echo -e "\n${GREEN}Purchase Patterns:${NC}"
        echo "$response" | jq -r '.patterns[] | "  • \(.category): \(.pattern_type) every \(.frequency_days) days (avg $\(.average_spend))"'
        
        echo -e "\n${YELLOW}Restock Predictions:${NC}"
        echo "$response" | jq -r '.predictions[] | "  • \(.product_category) needed by \(.predicted_date | split("T")[0])"'
        
        echo -e "\n${BLUE}Savings Opportunities:${NC}"
        echo "$response" | jq -r '.savings_opportunities[] | "  • \(.description): Save $\(.potential_savings)"'
    fi
}

# Parse global options
while [ $# -gt 0 ]; do
    case "$1" in
        --profile)
            PROFILE_ID="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT="true"
            shift
            ;;
        --verbose)
            set -x
            shift
            ;;
        *)
            break
            ;;
    esac
done

# Main command routing
case "${1:-help}" in
    research)
        shift
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: Query required${NC}"
            echo "Usage: smart-shopping-assistant research <query> [--budget N] [--alternatives] [--gift-for ID]"
            exit 1
        fi
        do_research "$@"
        ;;
    track)
        shift
        if [ $# -eq 0 ]; then
            echo -e "${RED}Error: Product URL required${NC}"
            echo "Usage: smart-shopping-assistant track <product-url> [--target-price N]"
            exit 1
        fi
        do_track "$@"
        ;;
    analyze-patterns)
        shift
        timeframe="${1:-30d}"
        predict="${2:-false}"
        analyze_patterns "$timeframe" "$predict"
        ;;
    status)
        check_status
        ;;
    version)
        show_version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'smart-shopping-assistant help' for usage information"
        exit 1
        ;;
esac