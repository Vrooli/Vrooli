name: test-genie
description: Comprehensive test suite for AI-powered test generation and management platform
version: 1.0.0

metadata:
  category: quality_assurance
  tags: [testing, ai, automation, quality, vault, comprehensive]
  author: Vrooli Core Team
  estimated_runtime: "15-20 minutes"
  complexity: "high"
  lifecycle_version: "1.0.0"

# Test vault configuration
vault:
  enabled: true
  phases:
    - setup
    - develop
    - test
    - deploy
    - monitor
  success_criteria:
    all_phases_completed: true
    no_critical_failures: true
    coverage_threshold: 95
    performance_baseline_met: true

resources:
  required:
    - postgres
    - ollama
  optional:
    - redis
    - n8n
    - qdrant
  health_timeout: 120

# Phase 1: Setup Phase
setup:
  - name: Initialize test genie infrastructure
    type: lifecycle
    action: setup
    description: Setup all required resources and initialize test genie system
    timeout: 300

  - name: Verify resource availability
    description: Ensure all required resources are accessible and healthy
    category: infrastructure
    timeout: 60
    steps:
      - action: check_service
        service: postgres
        port: 5432
        expected: healthy
        
      - action: verify_database_schema
        service: postgres
        database: test_genie
        tables: [test_suites, test_cases, test_executions, test_results]
        expected: all_exist

  - name: Verify Delegated Generation
    description: Ensure App Issue Tracker is reachable for AI-backed test generation
    category: ai_integration
    timeout: 120
    steps:
      - action: http_get
        url: "http://localhost:8090/api/v1/health"
        expected_status: 200
        description: "App Issue Tracker health check"

# Phase 2: Develop Phase
develop:
  - name: API development validation
    description: Validate all API endpoints are properly implemented
    category: api_development
    timeout: 180
    steps:
      - action: exec
        command: "API_PORT=$(lsof -i -P -n 2>/dev/null | grep test-genie-api | grep LISTEN | awk '{print $9}' | cut -d: -f2 | head -1); curl -sf http://localhost:${API_PORT}/health | jq -e '.status == \"healthy\"'"
        expected_exit_code: 0
        description: "API health check with dynamic port discovery"

      - action: exec
        command: "API_PORT=$(vrooli scenario port test-genie API_PORT); curl -sf -X POST http://localhost:${API_PORT}/api/v1/test-suite/generate -H 'Content-Type: application/json' -d '"
{"scenario_name":"test-scenario","test_types":["unit","integration"],"coverage_target":95,"options":{"include_performance_tests":true,"include_security_tests":true,"custom_test_patterns":[],"execution_timeout":300}}' | jq -e '.request_id' > /dev/null"
        expected_exit_code: 0
        store_response_as: test_generation_request
        validate_response:
          has_field: "request_id"
          has_field: "status"
        description: "Test suite generation API"

      - action: http_post
        url: "http://localhost:8200/api/v1/test-analysis/coverage"
        json_data:
          scenario_name: "test-scenario"
          source_code_paths: ["./api", "./cli"]
          existing_test_paths: ["./test"]
          analysis_depth: "comprehensive"
        expected_status: 200
        validate_response:
          has_field: "overall_coverage"
          has_field: "coverage_gaps"
          has_field: "improvement_suggestions"
        description: "Coverage analysis API"

  - name: CLI development validation
    description: Test CLI functionality and integration
    category: cli_development
    timeout: 120
    steps:
      - action: shell_command
        command: "./cli/test-genie version"
        expected_exit_code: 0
        expected_output_contains: ["Test Genie CLI"]
        description: "CLI version check"

      - action: shell_command
        command: "./cli/test-genie status"
        expected_exit_code: 0
        expected_output_contains: ["API is healthy"]
        description: "CLI status check"

      - action: shell_command
        command: "./cli/test-genie generate test-demo --types unit,integration --coverage 90"
        expected_exit_code: 0
        expected_output_contains: ["Test suite generated successfully"]
        description: "CLI test generation"

# Phase 3: Test Phase
test:
  - name: Test generation comprehensive validation
    description: Validate comprehensive test generation capabilities
    category: test_generation
    timeout: 300
    steps:
      - name: "Generate unit tests"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "unit-test-demo"
          test_types: ["unit"]
          coverage_target: 95
        expected_status: 201
        store_response_as: unit_suite

      - name: "Generate integration tests"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "integration-test-demo"
          test_types: ["integration"]
          coverage_target: 90
        expected_status: 201
        store_response_as: integration_suite

      - name: "Generate performance tests"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "performance-test-demo"
          test_types: ["performance"]
          coverage_target: 85
          options:
            include_performance_tests: true
        expected_status: 201
        store_response_as: performance_suite

      - name: "Generate vault tests"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "vault-test-demo"
          test_types: ["vault"]
          coverage_target: 95
        expected_status: 201
        store_response_as: vault_suite

  - name: Test execution workflow validation
    description: Test complete test execution workflow
    category: test_execution
    timeout: 240
    dependencies: [test_generation_comprehensive_validation]
    steps:
      - name: "Execute unit test suite"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/${unit_suite.suite_id}/execute"
        json_data:
          execution_type: "full"
          environment: "local"
          parallel_execution: false
          timeout_seconds: 120
        expected_status: 202
        store_response_as: unit_execution

      - name: "Check execution status"
        action: wait_for_condition
        condition: execution_completed
        execution_id: "${unit_execution.execution_id}"
        timeout: 180
        check_interval: 5

      - name: "Get execution results"
        action: http_get
        url: "http://localhost:8200/api/v1/test-execution/${unit_execution.execution_id}/results"
        expected_status: 200
        validate_response:
          has_field: "summary"
          has_field: "status"
        store_response_as: unit_results

  - name: Coverage analysis validation
    description: Test coverage analysis and reporting
    category: coverage_analysis
    timeout: 180
    steps:
      - name: "Analyze scenario coverage"
        action: http_post
        url: "http://localhost:8200/api/v1/test-analysis/coverage"
        json_data:
          scenario_name: "test-genie"
          source_code_paths: ["./api/main.go", "./cli/test-genie"]
          existing_test_paths: ["./test"]
          analysis_depth: "comprehensive"
        expected_status: 200
        validate_response:
          has_field: "overall_coverage"
          has_field: "coverage_by_file"
          has_field: "coverage_gaps"
          has_field: "improvement_suggestions"
        store_response_as: coverage_analysis

      - name: "Validate coverage metrics"
        action: assert_conditions
        conditions:
          - field: "coverage_analysis.overall_coverage"
            operator: "greater_than"
            value: 70
          - field: "coverage_analysis.improvement_suggestions"
            operator: "is_array"
            min_length: 1

  - name: Vault testing capability validation
    description: Test vault creation and execution capabilities
    category: vault_testing
    timeout: 300
    steps:
      - name: "Create test vault via CLI"
        action: shell_command
        command: "./cli/test-genie vault test-vault-demo --phases setup,develop,test --timeout 120"
        expected_exit_code: 0
        expected_output_contains: ["Test vault created successfully"]

      - name: "Verify vault structure"
        action: verify_file_exists
        files:
          - "test-vault-test-vault-demo/vault.yaml"
          - "test-vault-test-vault-demo/phases/setup.yaml"
          - "test-vault-test-vault-demo/phases/develop.yaml"
          - "test-vault-test-vault-demo/phases/test.yaml"
          - "test-vault-test-vault-demo/run_vault.sh"

      - name: "Execute vault (dry run)"
        action: shell_command
        command: "cd test-vault-test-vault-demo && ./run_vault.sh"
        expected_exit_code: 0
        expected_output_contains: ["Vault Execution Completed"]

# Phase 4: Deploy Phase
deploy:
  - name: System integration validation
    description: Validate full system integration and readiness
    category: system_integration
    timeout: 240
    steps:
      - name: "End-to-end workflow test"
        action: shell_command
        command: |
          # Complete workflow: generate -> execute -> analyze
          SUITE_ID=$(./cli/test-genie generate e2e-test --types unit,integration --json | jq -r '.suite_id')
          ./cli/test-genie execute $SUITE_ID --type full --timeout 120
          ./cli/test-genie coverage e2e-test --depth basic
        expected_exit_code: 0
        description: "Complete end-to-end workflow"

      - name: "Performance baseline validation"
        action: measure_performance
        operations:
          - name: "Test generation speed"
            command: "./cli/test-genie generate perf-test --types unit"
            max_duration: 60
          - name: "Coverage analysis speed"
            command: "./cli/test-genie coverage perf-test --depth basic"
            max_duration: 30

      - name: "Resource utilization check"
        action: check_resource_usage
        thresholds:
          cpu_usage: 80
          memory_usage: 2048
          disk_usage: 1024

  - name: Multi-scenario compatibility
    description: Test compatibility with different scenario types
    category: compatibility
    timeout: 180
    steps:
      - name: "Test with simple scenario"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "simple-test"
          test_types: ["unit"]
          coverage_target: 80
        expected_status: 201

      - name: "Test with complex scenario"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "document-manager"
          test_types: ["unit", "integration", "performance"]
          coverage_target: 95
          options:
            include_performance_tests: true
            include_security_tests: true
        expected_status: 201

      - name: "Test with resource-heavy scenario"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: "personal-digital-twin"
          test_types: ["unit", "integration", "vault"]
          coverage_target: 90
        expected_status: 201

# Phase 5: Monitor Phase
monitor:
  - name: System health monitoring
    description: Validate monitoring and health check capabilities
    category: monitoring
    timeout: 120
    steps:
      - name: "API health monitoring"
        action: repeated_http_check
        url: "http://localhost:8200/health"
        repetitions: 5
        interval: 10
        expected_status: 200
        description: "Continuous health monitoring"

      - name: "Database health monitoring"
        action: check_database_health
        service: postgres
        checks:
          - connection_pool_usage
          - query_performance
          - table_integrity

      - name: "AI service monitoring"
        action: check_ai_service_health
        service: ollama
        checks:
          - model_availability
          - response_times
          - error_rates

  - name: Performance monitoring
    description: Monitor system performance under various loads
    category: performance_monitoring
    timeout: 300
    steps:
      - name: "Concurrent test generation load"
        action: concurrent_requests
        url: "http://localhost:8200/api/v1/test-suite/generate"
        concurrent_users: 5
        requests_per_user: 3
        request_data:
          scenario_name: "load-test-{{USER_ID}}"
          test_types: ["unit"]
          coverage_target: 80
        success_criteria:
          success_rate: 95
          avg_response_time: 30000
          max_response_time: 60000

      - name: "Memory usage monitoring"
        action: monitor_resource_usage
        duration: 120
        metrics: ["memory", "cpu", "disk_io"]
        alerts:
          memory_threshold: 2048
          cpu_threshold: 80

  - name: Error handling validation
    description: Test system behavior under error conditions
    category: error_handling
    timeout: 180
    steps:
      - name: "Invalid input handling"
        action: http_post
        url: "http://localhost:8200/api/v1/test-suite/generate"
        json_data:
          scenario_name: ""
          test_types: []
        expected_status: 400
        description: "Test invalid input handling"

      - name: "Resource unavailability handling"
        action: simulate_resource_failure
        resource: "postgres"
        duration: 30
        expected_behavior: "graceful_degradation"
        recovery_validation: true

      - name: "AI service failure handling"
        action: simulate_service_failure
        service: "ollama"
        duration: 30
        expected_behavior: "fallback_to_rule_based_generation"

# Validation criteria
validation:
  # Resource validation
  resources:
    - name: postgres
      checks: [connection, schema_loaded, performance]
      required: true
      performance_thresholds:
        query_time: 500ms
        connection_time: 1000ms
    
    - name: ollama
      checks: [connection, models_available, response_time]
      required: true
      performance_thresholds:
        response_time: 10000ms
        model_load_time: 30000ms
    
    - name: redis
      checks: [connection]
      required: false
      performance_thresholds:
        response_time: 100ms

  # API endpoint validation
  api_endpoints:
    test_genie_api:
      - endpoint: /health
        method: GET
        expected_status: 200
        max_response_time: 1000ms
      
      - endpoint: /api/v1/test-suite/generate
        method: POST
        expected_status: 201
        max_response_time: 60000ms
      
      - endpoint: /api/v1/test-analysis/coverage
        method: POST
        expected_status: 200
        max_response_time: 30000ms

  # Performance criteria
  performance:
    test_generation_time: "<60s"
    coverage_analysis_time: "<30s"
    test_execution_startup: "<10s"
    api_response_time: "<5s"
    memory_usage: "<2GB"
    cpu_usage: "<80%"

  # Quality gates
  quality_gates:
    - name: "All API endpoints functional"
      criteria: "all_api_endpoints_return_expected_status"
      required: true
    
    - name: "Test generation accuracy"
      criteria: "generated_tests_are_executable_and_valid"
      required: true
    
    - name: "Coverage analysis accuracy"
      criteria: "coverage_metrics_are_realistic_and_actionable"
      required: true
    
    - name: "Vault testing capability"
      criteria: "vault_creation_and_execution_successful"
      required: true
    
    - name: "Performance within limits"
      criteria: "all_performance_thresholds_met"
      required: true

  # Data integrity checks
  data_integrity:
    - all_generated_tests_stored_in_database: true
    - test_execution_results_properly_tracked: true
    - coverage_analysis_data_consistent: true
    - vault_configurations_valid: true

# Cleanup procedures
cleanup:
  - name: Clean test data
    type: database
    action: delete_test_records
    tables: [test_suites, test_cases, test_executions, test_results]
    condition: "scenario_name LIKE '%test%' OR scenario_name LIKE '%demo%'"
    
  - name: Remove vault directories
    type: filesystem
    action: remove_directories
    pattern: "test-vault-*"
    
  - name: Clean temporary files
    type: filesystem
    action: remove_files
    pattern: "*.tmp"
    directories: ["./", "./test", "./api", "./cli"]

  - name: Reset AI model state
    type: service
    service: ollama
    action: reset_model_cache

# Reporting configuration
reporting:
  format: [json, html, junit]
  include_metrics: true
  include_logs: true
  include_artifacts: true
  output_directory: "test-results"
  
  custom_metrics:
    - name: "test_generation_accuracy"
      description: "Percentage of generated tests that are executable"
      
    - name: "coverage_gap_detection_rate"
      description: "Accuracy of coverage gap identification"
      
    - name: "ai_generation_quality_score"
      description: "Quality score of AI-generated test cases"

# Notifications
notifications:
  on_completion:
    webhook_url: "${NOTIFICATION_WEBHOOK_URL}"
    include_summary: true
    include_failures: true
    
  on_failure:
    immediate: true
    include_logs: true
    include_stack_traces: true
