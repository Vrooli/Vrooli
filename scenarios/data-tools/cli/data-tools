#!/bin/bash
################################################################################
# Data Tools CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="data-tools"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the new ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}âŒ Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
usage() {
    echo -e "${CYAN}Data Tools CLI${NC}"
    echo "Comprehensive data processing and analysis toolkit"
    echo ""
    echo "Usage: data-tools [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}health${NC}      Check service health"
    echo -e "  ${GREEN}list${NC}        List resources"
    echo -e "  ${GREEN}get${NC}         Get specific resource"
    echo -e "  ${GREEN}create${NC}      Create new resource"
    echo -e "  ${GREEN}update${NC}      Update resource"
    echo -e "  ${GREEN}delete${NC}      Delete resource"
    echo -e "  ${GREEN}execute${NC}     Execute workflow"
    echo -e "  ${GREEN}executions${NC}  List workflow executions"
    echo -e "  ${GREEN}status${NC}      Show execution status"
    echo -e "  ${GREEN}docs${NC}        Show API documentation"
    echo ""
    echo "Examples:"
    echo "  data-tools health"
    echo "  data-tools list"
    echo "  data-tools create name \"My Dataset\" description \"Test dataset\""
    echo "  data-tools execute workflow_id \"data-process-1\""
    echo "  data-tools executions"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (most commands)"
    echo ""
    echo "For more information: data-tools <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL from orchestrator
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Health check command
cmd_health() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools health [OPTIONS]"
                echo ""
                echo "Check service health and connectivity"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools health"
                echo "  data-tools health --json"
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/health" 2>/dev/null)
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | jq -e '.status' | grep -q "healthy"; then
            echo -e "${GREEN}âœ… Data Tools is healthy${NC}"
            echo "   API: ${api_url}"
        else
            echo -e "${RED}âŒ Data Tools health check failed${NC}"
            echo "   Response: $response"
            return 1
        fi
    fi
}

# List resources command
cmd_list() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools list [OPTIONS]"
                echo ""
                echo "List all resources"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools list"
                echo "  data-tools list --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/api/v1/resources")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        # Pretty print resources
        local count=$(echo "$response" | jq -r '.data | length' 2>/dev/null || echo "0")
        echo -e "${CYAN}ðŸ“‹ Resources: $count${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.data[]? | [.id[0:8], .name, .description] | @tsv' 2>/dev/null | \
            while IFS=$'\t' read -r id name desc; do
                printf "%-10s %-20s %s\n" "$id" "$name" "$desc"
            done
        else
            echo "No resources found."
        fi
    fi
}

# Get resource command
cmd_get() {
    local resource_id="$1"
    local json_output=false
    
    if [[ -z "$resource_id" ]]; then
        echo -e "${RED}âŒ Error: Resource ID required${NC}" >&2
        echo "Usage: data-tools get <resource_id>" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools get <resource_id> [OPTIONS]"
                echo ""
                echo "Get specific resource details"
                echo ""
                echo "Arguments:"
                echo "  resource_id    ID of the resource to retrieve"
                echo ""
                echo "Options:"
                echo "  --json         Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools get abc12345"
                echo "  data-tools get abc12345 --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/api/v1/resources/${resource_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${CYAN}ðŸ“„ Resource Details:${NC}"
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    fi
}

# Create resource command
cmd_create() {
    local name=""
    local description=""
    local config=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --name)
                name="$2"
                shift 2
                ;;
            --description)
                description="$2"
                shift 2
                ;;
            --config)
                config="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools create [OPTIONS]"
                echo ""
                echo "Create a new resource"
                echo ""
                echo "Options:"
                echo "  --name <name>              Resource name (required)"
                echo "  --description <desc>       Resource description"
                echo "  --config <json>            Resource configuration as JSON"
                echo "  --json                     Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools create --name \"My Dataset\" --description \"Test data\""
                echo "  data-tools create --name \"API Config\" --config '{\"type\":\"api\"}'"
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}âŒ Error: Resource name is required${NC}" >&2
        return 1
    fi
    
    local request_body
    if [[ -n "$config" ]]; then
        request_body=$(jq -n \
            --arg name "$name" \
            --arg description "$description" \
            --argjson config "$config" \
            '{name: $name, description: $description, config: $config}')
    else
        request_body=$(jq -n \
            --arg name "$name" \
            --arg description "$description" \
            '{name: $name, description: $description}')
    fi
    
    echo -e "${BLUE}ðŸ“ Creating resource: $name${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/resources" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local resource_id
        resource_id=$(echo "$response" | jq -r '.data.id // "unknown"' 2>/dev/null)
        echo -e "${GREEN}âœ… Resource created: $resource_id${NC}"
    fi
}

# Update resource command
cmd_update() {
    local resource_id="$1"
    local name=""
    local description=""
    local config=""
    local json_output=false
    
    if [[ -z "$resource_id" ]]; then
        echo -e "${RED}âŒ Error: Resource ID required${NC}" >&2
        echo "Usage: data-tools update <resource_id> [OPTIONS]" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --name)
                name="$2"
                shift 2
                ;;
            --description)
                description="$2"
                shift 2
                ;;
            --config)
                config="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools update <resource_id> [OPTIONS]"
                echo ""
                echo "Update an existing resource"
                echo ""
                echo "Arguments:"
                echo "  resource_id    ID of the resource to update"
                echo ""
                echo "Options:"
                echo "  --name <name>              New resource name"
                echo "  --description <desc>       New resource description"
                echo "  --config <json>            New resource configuration as JSON"
                echo "  --json                     Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools update abc123 --name \"Updated Dataset\""
                echo "  data-tools update abc123 --description \"Updated description\""
                return 0
                ;;
            *)
                echo -e "${RED}âŒ Unknown option: $1${NC}" >&2
                return 1
                ;;
        esac
    done
    
    # Build request body with only provided fields
    local request_body="{}"
    [[ -n "$name" ]] && request_body=$(echo "$request_body" | jq --arg name "$name" '. + {name: $name}')
    [[ -n "$description" ]] && request_body=$(echo "$request_body" | jq --arg desc "$description" '. + {description: $desc}')
    [[ -n "$config" ]] && request_body=$(echo "$request_body" | jq --argjson config "$config" '. + {config: $config}')
    
    echo -e "${BLUE}ðŸ“ Updating resource: $resource_id${NC}"
    
    local response
    response=$(api_request "PUT" "/api/v1/resources/${resource_id}" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}âœ… Resource updated: $resource_id${NC}"
    fi
}

# Delete resource command
cmd_delete() {
    local resource_id="$1"
    local json_output=false
    local confirm=false
    
    if [[ -z "$resource_id" ]]; then
        echo -e "${RED}âŒ Error: Resource ID required${NC}" >&2
        echo "Usage: data-tools delete <resource_id> [OPTIONS]" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --confirm)
                confirm=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools delete <resource_id> [OPTIONS]"
                echo ""
                echo "Delete a resource"
                echo ""
                echo "Arguments:"
                echo "  resource_id    ID of the resource to delete"
                echo ""
                echo "Options:"
                echo "  --confirm      Skip confirmation prompt"
                echo "  --json         Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools delete abc123"
                echo "  data-tools delete abc123 --confirm"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    if [[ "$confirm" != true ]]; then
        echo -e "${YELLOW}âš ï¸  Are you sure you want to delete resource $resource_id? (y/N)${NC}"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            echo "Cancelled."
            return 0
        fi
    fi
    
    echo -e "${BLUE}ðŸ—‘ï¸  Deleting resource: $resource_id${NC}"
    
    local response
    response=$(api_request "DELETE" "/api/v1/resources/${resource_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}âœ… Resource deleted: $resource_id${NC}"
    fi
}

# Execute workflow command
cmd_execute() {
    local workflow_id="$1"
    local input=""
    local json_output=false
    
    if [[ -z "$workflow_id" ]]; then
        echo -e "${RED}âŒ Error: Workflow ID required${NC}" >&2
        echo "Usage: data-tools execute <workflow_id> [OPTIONS]" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --input)
                input="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools execute <workflow_id> [OPTIONS]"
                echo ""
                echo "Execute a workflow"
                echo ""
                echo "Arguments:"
                echo "  workflow_id    ID of the workflow to execute"
                echo ""
                echo "Options:"
                echo "  --input <json>     Input data as JSON"
                echo "  --json             Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools execute workflow-123"
                echo "  data-tools execute workflow-123 --input '{\"data\":\"value\"}'"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local request_body
    if [[ -n "$input" ]]; then
        request_body=$(jq -n \
            --arg workflow_id "$workflow_id" \
            --argjson input "$input" \
            '{workflow_id: $workflow_id, input: $input}')
    else
        request_body=$(jq -n \
            --arg workflow_id "$workflow_id" \
            '{workflow_id: $workflow_id}')
    fi
    
    echo -e "${BLUE}ðŸš€ Executing workflow: $workflow_id${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/execute" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local execution_id
        execution_id=$(echo "$response" | jq -r '.data.execution_id // "unknown"' 2>/dev/null)
        echo -e "${GREEN}âœ… Execution started: $execution_id${NC}"
        echo "   Check status with: data-tools status $execution_id"
    fi
}

# List executions command
cmd_executions() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools executions [OPTIONS]"
                echo ""
                echo "List workflow executions"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools executions"
                echo "  data-tools executions --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/api/v1/executions")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq -r '.data | length' 2>/dev/null || echo "0")
        echo -e "${CYAN}ðŸ”„ Executions: $count${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.data[]? | [.id[0:8], .workflow_id, .status, .started_at] | @tsv' 2>/dev/null | \
            while IFS=$'\t' read -r id workflow_id status started_at; do
                printf "%-10s %-15s %-10s %s\n" "$id" "$workflow_id" "$status" "$started_at"
            done
        else
            echo "No executions found."
        fi
    fi
}

# Show execution status command
cmd_status() {
    local execution_id="$1"
    local json_output=false
    
    if [[ -z "$execution_id" ]]; then
        echo -e "${RED}âŒ Error: Execution ID required${NC}" >&2
        echo "Usage: data-tools status <execution_id>" >&2
        return 1
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools status <execution_id> [OPTIONS]"
                echo ""
                echo "Show execution status and details"
                echo ""
                echo "Arguments:"
                echo "  execution_id    ID of the execution to check"
                echo ""
                echo "Options:"
                echo "  --json          Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools status abc12345"
                echo "  data-tools status abc12345 --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local response
    response=$(api_request "GET" "/api/v1/executions/${execution_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${CYAN}ðŸ“Š Execution Status:${NC}"
        echo "$response" | jq '.' 2>/dev/null || echo "$response"
    fi
}

# Show API docs command
cmd_docs() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: data-tools docs [OPTIONS]"
                echo ""
                echo "Show API documentation"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  data-tools docs"
                echo "  data-tools docs --json"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/docs" 2>/dev/null)
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${CYAN}ðŸ“š API Documentation:${NC}"
        echo "   API Endpoint: $api_url"
        echo ""
        echo "$response" | format_json
    fi
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        health)
            cmd_health "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        get|show)
            cmd_get "$@"
            ;;
        create|add)
            cmd_create "$@"
            ;;
        update|edit)
            cmd_update "$@"
            ;;
        delete|remove|rm)
            cmd_delete "$@"
            ;;
        execute|exec|run)
            cmd_execute "$@"
            ;;
        executions)
            cmd_executions "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        docs)
            cmd_docs "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        *)
            echo -e "${RED}âŒ Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"