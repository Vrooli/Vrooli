{
  "$schema": "../../../../.vrooli/schemas/service.schema.json",
  "version": "1.0.0",
  "service": {
    "name": "home-automation",
    "displayName": "Home Automation Intelligence",
    "description": "Self-evolving intelligent home automation system with AI-powered automation generation, multi-user permissions, and calendar-aware scheduling",
    "version": "1.0.0",
    "tags": [
      "home-automation",
      "iot",
      "device-control",
      "ai-generation",
      "multi-user",
      "permissions",
      "scheduling",
      "self-improving",
      "go-api",
      "postgres-storage",
      "redis-cache",
      "home-assistant-integration",
      "scenario-authenticator-integration",
      "calendar-integration",
      "claude-code-integration",
      "ai-powered-validation",
      "business-premium"
    ]
  },
  "ports": {
     "api": {
       "env_var": "API_PORT",
       "description": "Home automation API server port",
       "range": "15000-19999"
     },
    "ui": {
      "env_var": "UI_PORT",
      "description": "Home automation UI server port",
      "range": "35000-39999"
    }
  },
  "resources": {
    "postgres": {
      "type": "postgres",
      "enabled": true,
      "required": true,
      "purpose": "Store user profiles, automation rules, device state cache, and audit logs",
      "initialization": [
        {
          "file": "initialization/postgres/schema.sql",
          "type": "schema"
        },
        {
          "file": "initialization/postgres/seed.sql",
          "type": "seed"
        }
      ]
    },
    "redis": {
      "type": "redis",
      "enabled": true,
      "required": false,
      "purpose": "Real-time device state caching and event pub/sub for live UI updates",
      "fallback": "In-memory caching with periodic database persistence",
      "initialization": []
    },
    "home-assistant": {
      "type": "home-assistant",
      "enabled": true,
      "required": true,
      "purpose": "Physical device control, state monitoring, and IoT ecosystem integration",
      "fallback": "Mock device interface for development and testing",
      "cli_integration": true,
      "health_check": "resource-home-assistant status"
    },
    "scenario-authenticator": {
      "type": "scenario",
      "name": "scenario-authenticator",
      "enabled": true,
      "required": false,
      "purpose": "User authentication, profile management, and permission validation",
      "fallback": "Mock user permissions with default admin access for development",
      "api_endpoint": "/api/v1/auth/validate",
      "required_version": "1.0.0",
      "cli_integration": true
    },
    "calendar": {
      "type": "scenario",
      "name": "calendar",
      "enabled": true,
      "required": false,
      "purpose": "Schedule-aware automation triggers and context switching intelligence",
      "fallback": "Manual scheduling only without intelligent context switching",
      "api_endpoint": "/api/v1/events",
      "required_version": "1.0.0",
      "event_subscription": [
        "calendar.event.starting",
        "calendar.event.ending"
      ]
    },
    "resource-claude-code": {
      "type": "resource",
      "name": "claude-code",
      "enabled": true,
      "required": false,
      "purpose": "AI-powered automation generation from natural language descriptions",
      "fallback": "Template-based automation generation using predefined patterns",
      "cli_integration": true,
      "health_check": "resource-claude-code status"
    },
    "ollama": {
      "type": "ollama",
      "enabled": true,
      "required": false,
      "purpose": "AI-powered automation safety validation and context analysis",
      "fallback": "Rule-based validation without AI insights",
      "models": ["llama3.2"],
      "cli_integration": true
    },
    "notification-hub": {
      "type": "scenario",
      "name": "notification-hub",
      "enabled": false,
      "required": false,
      "purpose": "Multi-channel alerts for device failures, security events, and automation notifications",
      "fallback": "Log-only notifications without user alerts"
    }
  },
  "lifecycle": {
    "version": "2.0.0",
    "health": {
      "description": "Home automation system health check configuration",
      "endpoints": {
        "api": "/health",
        "ui": "/health"
      },
      "checks": [
        {
          "name": "api_endpoint",
          "type": "http",
          "target": "http://localhost:${API_PORT}/health",
          "critical": true,
          "timeout": 5000,
          "interval": 30000
        },
        {
          "name": "ui_endpoint",
          "type": "http",
          "target": "http://localhost:${UI_PORT}/health",
          "critical": true,
          "timeout": 5000,
          "interval": 30000
        },
        {
          "name": "postgres_connection",
          "type": "resource",
          "target": "postgres",
          "critical": true
        },
        {
          "name": "home_assistant_cli",
          "type": "exec",
          "target": "resource-home-assistant status",
          "critical": true,
          "timeout": 10000
        },
        {
          "name": "scenario_authenticator",
          "type": "http",
          "target": "http://localhost:3252/health",
          "critical": false,
          "timeout": 5000
        },
        {
          "name": "calendar_service",
          "type": "http",
          "target": "http://localhost:3300/health",
          "critical": false,
          "timeout": 5000
        },
        {
          "name": "claude_code_cli",
          "type": "exec",
          "target": "resource-claude-code status",
          "critical": false,
          "timeout": 10000
        }
      ],
      "timeout": 10000,
      "interval": 30000,
      "startup_grace_period": 15000
    },
    "setup": {
      "description": "Initialize Home Automation Intelligence System",
      "condition": {
        "checks": [
           {
             "type": "binaries",
             "targets": [
               "api/home-automation-api"
             ]
           },
           {
             "type": "cli",
             "targets": [
               "home-automation"
             ]
           },
          {
            "type": "dependencies",
            "paths": [
              "ui/package.json"
            ]
          },
          {
            "type": "resources",
            "populated": true
          }
        ]
      },
      "steps": [
        {
          "name": "verify-home-assistant",
          "run": "resource-home-assistant status || echo 'WARNING: Home Assistant not available - using mock mode'",
          "description": "Verify Home Assistant resource availability"
        },
        {
          "name": "verify-auth-service",
          "run": "scenario-authenticator status || echo 'WARNING: Scenario Authenticator not available - using mock permissions'",
          "description": "Verify authentication service is available"
        },
        {
          "name": "verify-calendar-service",
          "run": "calendar status || echo 'WARNING: Calendar service not available - using fallback scheduling'",
          "description": "Verify calendar service is available"
        },
        {
          "name": "initialize-database",
          "run": "resource-postgres content create-database home_automation || echo 'Database already exists or creation skipped'",
          "description": "Create home automation database"
        },
        {
          "name": "add-data",
          "run": "../../scripts/resources/populate/populate.sh .",
          "description": "Initialize home automation data in resources"
        },
        {
          "name": "install-cli",
          "run": "chmod +x cli/home-automation && ln -sf $(pwd)/cli/home-automation ~/.local/bin/home-automation 2>/dev/null || true",
          "description": "Install home automation CLI globally"
        },
        {
          "name": "build-api",
          "run": "cd api && go mod download && go build -o home-automation-api .",
          "description": "Build home automation API server"
        },
        {
          "name": "install-ui-deps",
          "run": "cd ui && npm install",
          "description": "Install UI dependencies"
        },
        {
          "name": "create-data-directories",
          "run": "mkdir -p data/{profiles,automations,device-cache,logs}",
          "description": "Create data storage directories"
        },
        {
          "name": "setup-mock-devices",
          "run": "cp test/mock-devices.json data/device-cache/mock-devices.json 2>/dev/null || echo 'Mock devices template not found - will create during runtime'",
          "description": "Setup mock device data for development",
          "condition": {
            "env_var_set": "HOME_ASSISTANT_MOCK"
          }
        },
        {
          "name": "show-urls",
          "run": "echo 'Home Automation initialized - UI: http://localhost:${UI_PORT} - API: http://localhost:${API_PORT} - CLI: home-automation --help'",
          "description": "Display service access URLs"
        }
      ]
    },
    "develop": {
      "description": "Start Home Automation System with API and UI",
      "steps": [
         {
           "name": "start-api",
           "run": "cd api && ./home-automation-api",
           "description": "Start Go API server in background",
           "background": true,
           "condition": {
             "file_exists": "api/home-automation-api"
           }
         },
        {
          "name": "start-ui",
          "run": "cd ui && node server.js",
          "description": "Start home automation UI server",
          "background": true
        },
         {
           "name": "show-urls",
           "run": "echo 'Home Automation running - UI: http://localhost:${UI_PORT} - API: http://localhost:${API_PORT} - CLI: home-automation --help'",
           "description": "Display all running service URLs"
         }
      ]
    },
    "test": {
      "description": "Test home automation system functionality",
      "steps": [
        {
          "name": "test-api-build",
          "run": "cd api && go test ./...",
          "description": "Run API unit tests"
        },
        {
          "name": "test-home-assistant-integration",
          "run": "./test/test-home-assistant-integration.sh",
          "description": "Test Home Assistant CLI integration",
          "condition": {
            "file_exists": "test/test-home-assistant-integration.sh"
          }
        },
        {
          "name": "test-auth-integration",
          "run": "./test/test-auth-integration.sh",
          "description": "Test scenario-authenticator integration",
          "condition": {
            "file_exists": "test/test-auth-integration.sh"
          }
        },
        {
          "name": "test-calendar-integration",
          "run": "./test/test-calendar-integration.sh",
          "description": "Test calendar service integration",
          "condition": {
            "file_exists": "test/test-calendar-integration.sh"
          }
        },
        {
          "name": "test-device-control",
          "run": "./test/test-device-control.sh",
          "description": "Test device control with permission validation",
          "condition": {
            "file_exists": "test/test-device-control.sh"
          }
        },
        {
          "name": "test-automation-generation",
          "run": "./test/test-automation-generation.sh",
          "description": "Test AI automation generation via Claude Code",
          "condition": {
            "file_exists": "test/test-automation-generation.sh"
          }
        },
        {
          "name": "test-cli",
          "run": "./cli/home-automation status --json",
          "description": "Test CLI functionality"
        },
        {
          "name": "test-ui-integration",
          "run": "./test/test-ui-integration.sh",
          "description": "Test UI device control and real-time updates",
          "condition": {
            "file_exists": "test/test-ui-integration.sh"
          }
        }
      ]
    },
    "stop": {
      "description": "Stop services",
      "steps": [
        {
          "name": "stop-api",
          "run": "pkill -f \"home-automation-api\" || true; sleep 1; pkill -9 -f \"home-automation-api\" 2>/dev/null || true",
          "description": "Stop API process"
        },
        {
          "name": "stop-ui",
          "run": "pkill -f \"scenarios/home-automation.*server\\.js\" || true; sleep 1; pkill -9 -f \"scenarios/home-automation.*server\\.js\" 2>/dev/null || true",
          "description": "Stop UI process"
        }
      ]
    }
  },
  "integration": {
    "shared_capabilities": [
      {
        "name": "device_control",
        "description": "Physical device control with permission validation for any scenario",
        "endpoint": "/api/v1/devices/{device_id}/control",
        "cli": "home-automation devices control",
        "workflow": "initialization/n8n/home-assistant-device-control.json"
      },
      {
        "name": "automation_generation",
        "description": "AI-powered automation generation from natural language for any IoT scenario",
        "endpoint": "/api/v1/automations/generate",
        "cli": "home-automation automations create",
        "workflow": "initialization/n8n/automation-safety-validator.json"
      },
      {
        "name": "permission_management",
        "description": "Multi-user device access control template for IoT scenarios",
        "endpoint": "/api/v1/profiles",
        "cli": "home-automation profiles"
      },
      {
        "name": "schedule_awareness",
        "description": "Calendar-integrated context switching for time-aware automations",
        "endpoint": "/api/v1/context",
        "cli": "home-automation context",
        "events": [
          "home.context.changed",
          "home.schedule.updated"
        ]
      }
    ],
    "example_integration": {
      "api": "const response = await fetch(`http://localhost:${process.env.HOME_AUTOMATION_API_PORT}/api/v1/devices`, { headers: { 'Authorization': `Bearer ${jwt_token}` } });",
      "cli": "home-automation devices list --profile $PROFILE_ID --filter lights",
      "workflow": "Use home-assistant-device-control.json workflow with device_id and action parameters",
      "events": "Subscribe to home.device.state_changed for real-time device updates"
    }
  },
  "business": {
    "value_proposition": "Self-improving intelligent home automation with AI-generated rules and enterprise-grade multi-user permissions",
    "revenue_model": {
      "type": "premium_deployment",
      "pricing_tiers": {
        "residential": "$25,000 - $50,000",
        "commercial": "$75,000 - $200,000",
        "enterprise": "$200,000+"
      },
      "recurring": {
        "monitoring": "$200-500/month",
        "automation_updates": "$100-300/month",
        "premium_features": "$500-1000/month"
      }
    },
    "target_markets": [
      "luxury_residential",
      "commercial_buildings",
      "property_management",
      "smart_facilities",
      "elderly_care",
      "energy_management"
    ],
    "competitive_advantages": [
      "Only system that writes its own automations",
      "Enterprise-grade multi-user permissions",
      "Calendar-integrated context awareness",
      "Self-improving through Claude Code generation",
      "Vrooli ecosystem integration"
    ]
  },
  "environment": {
    "api": {
      "HOME_ASSISTANT_URL": "${HOME_ASSISTANT_URL:-http://localhost:8123}",
      "HOME_ASSISTANT_TOKEN": "${HOME_ASSISTANT_TOKEN}",
      "HOME_ASSISTANT_MOCK": "${HOME_ASSISTANT_MOCK:-false}",
      "POSTGRES_URL": "postgres://vrooli:REDACTED@localhost:5433/home_automation?sslmode=disable",
      "POSTGRES_PASSWORD": "${POSTGRES_PASSWORD}",
      "REDIS_URL": "${REDIS_URL:-redis://localhost:6379}",
      "AUTH_SERVICE_URL": "http://localhost:3252",
      "CALENDAR_SERVICE_URL": "http://localhost:3300",
      "NOTIFICATION_SERVICE_URL": "${NOTIFICATION_SERVICE_URL:-http://localhost:28100}",
      "JWT_SECRET": "${JWT_SECRET}",
      "CLAUDE_CODE_CLI": "resource-claude-code",
      "LOG_LEVEL": "${LOG_LEVEL:-info}",
      "AUTOMATION_SANDBOX_ENABLED": "${AUTOMATION_SANDBOX_ENABLED:-true}",
      "DEVICE_COMMAND_TIMEOUT": "${DEVICE_COMMAND_TIMEOUT:-5000}",
      "MAX_CONCURRENT_AUTOMATIONS": "${MAX_CONCURRENT_AUTOMATIONS:-10}"
    },
    "ui": {
      "API_BASE_URL": "http://localhost:${HOME_AUTOMATION_API_PORT}",
      "WS_BASE_URL": "ws://localhost:${HOME_AUTOMATION_API_PORT}",
      "AUTH_REDIRECT_URL": "http://localhost:3252/auth",
      "CALENDAR_URL": "http://localhost:3300",
      "REAL_TIME_UPDATES": "true",
      "THEME": "dark",
      "MOBILE_OPTIMIZED": "true"
    }
  }
}
