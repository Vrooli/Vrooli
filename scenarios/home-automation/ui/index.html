<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Automation Intelligence</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2024%2024%27%20fill%3D%27none%27%20stroke%3D%27%230f172a%27%20stroke-width%3D%271.5%27%20stroke-linecap%3D%27round%27%20stroke-linejoin%3D%27round%27%3E%3Cpath%20d%3D%27m3%209%209-7%209%207v11a2%202%200%200%201-2%202H5a2%202%200%200%201-2-2z%27/%3E%3Cpolyline%20points%3D%279%2022%209%2012%2015%2012%2015%2022%27/%3E%3C/svg%3E">
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script type="module">
        import { initIframeBridgeChild } from '/node_modules/@vrooli/iframe-bridge/dist/iframeBridgeChild.js';

        if (typeof window !== 'undefined' && window.parent !== window && !window.__homeAutomationBridgeInitialized) {
            let parentOrigin;
            try {
                if (document.referrer) {
                    parentOrigin = new URL(document.referrer).origin;
                }
            } catch (error) {
                console.warn('[HomeAutomation] Unable to parse parent origin for iframe bridge', error);
            }

            initIframeBridgeChild({ parentOrigin, appId: 'home-automation' });
            window.__homeAutomationBridgeInitialized = true;
        }
    </script>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <h1>
                        <span class="icon icon-lg" data-lucide="home"></span>
                        <span>Home Intelligence</span>
                    </h1>
                    <span class="tagline">Self-Evolving Automation</span>
                </div>
                
                <div class="header-controls">
                    <div class="connection-status" id="connectionStatus">
                        <div class="status-indicator offline"></div>
                        <span>Connecting...</span>
                    </div>
                    
                    <div class="user-profile" id="userProfile">
                        <div class="profile-avatar">
                            <span class="icon" data-lucide="user"></span>
                        </div>
                        <span class="profile-name">Guest</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="tab-button active" data-tab="devices">
                <span class="icon" data-lucide="plug"></span>
                <span>Devices</span>
            </button>
            <button class="tab-button" data-tab="scenes">
                <span class="icon" data-lucide="clapperboard"></span>
                <span>Scenes</span>
            </button>
            <button class="tab-button" data-tab="automations">
                <span class="icon" data-lucide="bot"></span>
                <span>Automations</span>
            </button>
            <button class="tab-button" data-tab="energy">
                <span class="icon" data-lucide="bolt"></span>
                <span>Energy</span>
            </button>
            <button class="tab-button" data-tab="settings">
                <span class="icon" data-lucide="settings"></span>
                <span>Settings</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Devices Tab -->
            <div class="tab-content active" id="devices-tab">
                <div class="section-header">
                    <h2>
                        <span class="icon" data-lucide="plug"></span>
                        <span>Connected Devices</span>
                    </h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary" id="refreshDevices">
                            <span class="icon" data-lucide="refresh-cw"></span>
                            <span>Refresh</span>
                        </button>
                        <select class="device-filter" id="deviceFilter">
                            <option value="all">All Devices</option>
                            <option value="lights">Lights</option>
                            <option value="sensors">Sensors</option>
                            <option value="switches">Switches</option>
                            <option value="climate">Climate</option>
                        </select>
                    </div>
                </div>
                
                <div class="devices-grid" id="devicesGrid">
                    <!-- Device tiles will be dynamically populated -->
                    <div class="device-placeholder">
                        <div class="placeholder-icon"><span class="icon" data-lucide="search"></span></div>
                        <p>Discovering devices...</p>
                        <small>Make sure Home Assistant is connected</small>
                    </div>
                </div>
            </div>

            <!-- Scenes Tab -->
            <div class="tab-content" id="scenes-tab">
                <div class="section-header">
                    <h2>
                        <span class="icon" data-lucide="clapperboard"></span>
                        <span>Smart Scenes</span>
                    </h2>
                    <button class="btn btn-primary" id="createScene">
                        <span class="icon" data-lucide="plus"></span>
                        <span>Create Scene</span>
                    </button>
                </div>
                
                <div class="scenes-grid" id="scenesGrid">
                    <div class="scene-placeholder">
                        <div class="placeholder-icon"><span class="icon" data-lucide="sparkles"></span></div>
                        <p>No scenes configured</p>
                        <small>Create your first automated scene</small>
                    </div>
                </div>
            </div>

            <!-- Automations Tab -->
            <div class="tab-content" id="automations-tab">
                <div class="section-header">
                    <h2>
                        <span class="icon" data-lucide="bot"></span>
                        <span>AI Automations</span>
                    </h2>
                    <button class="btn btn-primary" id="createAutomation">
                        <span class="icon" data-lucide="sparkles"></span>
                        <span>Create with AI</span>
                    </button>
                </div>
                
                <div class="automation-creator" id="automationCreator" style="display: none;">
                    <div class="creator-header">
                        <h3>Describe Your Automation</h3>
                        <button class="btn-close" id="closeCreator" aria-label="Close">
                            <span class="icon" data-lucide="x"></span>
                        </button>
                    </div>
                    
                    <div class="creator-content">
                        <textarea 
                            id="automationDescription" 
                            placeholder="Example: 'Turn on living room lights when I get home after sunset, but only on weekdays'"
                            rows="4"
                        ></textarea>
                        
                        <div class="creator-actions">
                            <button class="btn btn-secondary" id="cancelCreation">Cancel</button>
                            <button class="btn btn-primary" id="generateAutomation">
                                <span class="icon" data-lucide="cpu"></span>
                                <span>Generate Automation</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="automations-list" id="automationsList">
                    <div class="automation-placeholder">
                        <div class="placeholder-icon"><span class="icon" data-lucide="bot"></span></div>
                        <p>No automations yet</p>
                        <small>Let AI create your first intelligent automation</small>
                    </div>
                </div>
            </div>

            <!-- Energy Tab -->
            <div class="tab-content" id="energy-tab">
                <div class="section-header">
                    <h2>
                        <span class="icon" data-lucide="bolt"></span>
                        <span>Energy Management</span>
                    </h2>
                    <div class="energy-summary">
                        <div class="energy-stat">
                            <span class="stat-value" id="currentUsage">-- kW</span>
                            <span class="stat-label">Current Usage</span>
                        </div>
                        <div class="energy-stat">
                            <span class="stat-value" id="todayUsage">-- kWh</span>
                            <span class="stat-label">Today</span>
                        </div>
                        <div class="energy-stat">
                            <span class="stat-value" id="monthlyUsage">-- kWh</span>
                            <span class="stat-label">This Month</span>
                        </div>
                    </div>
                </div>
                
                <div class="energy-content">
                    <div class="energy-placeholder">
                        <div class="placeholder-icon"><span class="icon" data-lucide="bar-chart-3"></span></div>
                        <p>Energy monitoring coming soon</p>
                        <small>Connect energy meters for detailed analytics</small>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="section-header">
                    <h2>
                        <span class="icon" data-lucide="settings"></span>
                        <span>System Settings</span>
                    </h2>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>
                            <span class="icon" data-lucide="users"></span>
                            <span>User Profiles</span>
                        </h3>
                        <p>Manage user access and permissions</p>
                        <button class="btn btn-secondary" id="manageProfiles">Manage</button>
                    </div>
                    
                    <div class="settings-card">
                        <h3>
                            <span class="icon" data-lucide="shield"></span>
                            <span>Security</span>
                        </h3>
                        <p>Authentication and access control</p>
                        <button class="btn btn-secondary" id="securitySettings">Configure</button>
                    </div>
                    
                    <div class="settings-card">
                        <h3>
                            <span class="icon" data-lucide="calendar"></span>
                            <span>Calendar Integration</span>
                        </h3>
                        <p>Schedule-aware automation</p>
                        <button class="btn btn-secondary" id="calendarSettings">Setup</button>
                    </div>
                    
                    <div class="settings-card">
                        <h3>
                            <span class="icon" data-lucide="house"></span>
                            <span>Home Assistant</span>
                        </h3>
                        <p>Device discovery and control</p>
                        <div class="status-badge" id="haStatus">Unknown</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-content">
                <div class="spinner"></div>
                <p id="loadingMessage">Processing...</p>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script src="app.js"></script>
</body>
</html>
