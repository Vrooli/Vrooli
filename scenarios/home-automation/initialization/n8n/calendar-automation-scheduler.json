{
  "name": "Calendar Automation Scheduler",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "calendar-trigger",
        "options": {}
      },
      "id": "calendar-webhook",
      "name": "Calendar Event Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "calendar-automation-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Process calendar event for home automation context switching\nconst payload = $input.all()[0].json;\n\n// Validate calendar event data\nif (!payload.event_id) {\n  throw new Error('event_id is required');\n}\n\nif (!payload.event_type) {\n  throw new Error('event_type is required (starting, ending, updated)');\n}\n\nif (!payload.event_data) {\n  throw new Error('event_data is required');\n}\n\nconst eventData = payload.event_data;\n\n// Map calendar events to home automation contexts\nconst contextMapping = {\n  // Work contexts\n  'meeting': 'focus_mode',\n  'conference call': 'focus_mode', \n  'work from home': 'work_mode',\n  'home office': 'work_mode',\n  \n  // Entertainment contexts\n  'movie night': 'entertainment_mode',\n  'tv time': 'entertainment_mode',\n  'game night': 'entertainment_mode',\n  'party': 'party_mode',\n  \n  // Sleep contexts\n  'bedtime': 'sleep_mode',\n  'nap': 'quiet_mode',\n  'sleep': 'sleep_mode',\n  \n  // Away contexts\n  'vacation': 'away_mode',\n  'trip': 'away_mode',\n  'out of town': 'away_mode',\n  'travel': 'away_mode',\n  \n  // Activity contexts\n  'cooking': 'kitchen_active_mode',\n  'dinner': 'dinner_mode',\n  'breakfast': 'morning_mode',\n  'workout': 'exercise_mode'\n};\n\n// Determine context from event title and description\nconst eventTitle = (eventData.title || '').toLowerCase();\nconst eventDescription = (eventData.description || '').toLowerCase();\nconst combinedText = `${eventTitle} ${eventDescription}`;\n\nlet detectedContext = 'default_mode';\nfor (const [keyword, context] of Object.entries(contextMapping)) {\n  if (combinedText.includes(keyword)) {\n    detectedContext = context;\n    break;\n  }\n}\n\n// Prepare automation trigger data\nreturn {\n  event_id: payload.event_id,\n  event_type: payload.event_type,\n  calendar_event: eventData,\n  detected_context: detectedContext,\n  start_time: eventData.start_time,\n  end_time: eventData.end_time,\n  all_day: eventData.all_day || false,\n  participants: eventData.participants || [],\n  location: eventData.location || 'home',\n  priority: eventData.priority || 'normal',\n  processing_timestamp: new Date().toISOString()\n};"
      },
      "id": "process-calendar-event",
      "name": "Process Calendar Event",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "functionCode": "// Query database for existing calendar contexts and automation overrides\nconst data = $input.all()[0].json;\n\n// Mock database query - in real implementation, this would:\n// 1. Query calendar_contexts table for matching event\n// 2. Get scene_id and automation_overrides\n// 3. Check for conflicts with other active contexts\n\n// Simulate database lookup\nconst mockContexts = {\n  'focus_mode': {\n    scene_id: null,\n    automation_overrides: {\n      'light.living_room': {'brightness': 90},\n      'climate.thermostat': {'target_temp': 70},\n      'notification_settings': {'do_not_disturb': true}\n    },\n    description: 'Optimized for focused work with bright lighting'\n  },\n  'entertainment_mode': {\n    scene_id: 'scene_movie_night', // References smart_scenes table\n    automation_overrides: {\n      'light.living_room': {'brightness': 10, 'color': 'orange'},\n      'climate.thermostat': {'target_temp': 72}\n    },\n    description: 'Dim lights and comfortable temperature for entertainment'\n  },\n  'sleep_mode': {\n    scene_id: 'scene_bedtime',\n    automation_overrides: {\n      'light.living_room': {'on': false},\n      'light.bedroom': {'brightness': 5, 'color_temp': 450},\n      'lock.front_door': {'locked': true},\n      'automation_pause': ['energy_saver_evening']\n    },\n    description: 'Secure home and gentle lighting for sleep'\n  },\n  'away_mode': {\n    scene_id: 'scene_away_mode',\n    automation_overrides: {\n      'security_mode': true,\n      'energy_saving': 'maximum',\n      'climate.thermostat': {'target_temp': 65},\n      'all_lights': {'on': false}\n    },\n    description: 'Security and energy optimization when away'\n  },\n  'work_mode': {\n    scene_id: null,\n    automation_overrides: {\n      'light.living_room': {'brightness': 85},\n      'climate.thermostat': {'target_temp': 70},\n      'switch.coffee_maker': {'on': true}\n    },\n    description: 'Work from home optimizations'\n  }\n};\n\nconst contextConfig = mockContexts[data.detected_context] || mockContexts['default_mode'] || {\n  scene_id: null,\n  automation_overrides: {},\n  description: 'Default home state'\n};\n\n// Check for context conflicts (multiple events at same time)\nconst hasConflicts = false; // Mock - would check overlapping calendar_contexts\n\nreturn {\n  ...data,\n  context_config: contextConfig,\n  has_conflicts: hasConflicts,\n  should_activate: data.event_type === 'starting' || data.event_type === 'updated',\n  should_deactivate: data.event_type === 'ending'\n};"
      },
      "id": "lookup-context-config",
      "name": "Lookup Context Config",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [600, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.should_activate}}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-activation",
      "name": "Should Activate Context?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [800, 300]
    },
    {
      "parameters": {
        "functionCode": "// Generate device control actions for context activation\nconst data = $input.all()[0].json;\nconst config = data.context_config;\nconst overrides = config.automation_overrides || {};\n\nconst actions = [];\n\n// Process automation overrides into device control actions\nfor (const [deviceId, settings] of Object.entries(overrides)) {\n  if (deviceId.startsWith('light.')) {\n    // Handle lighting controls\n    if (settings.on === false) {\n      actions.push({\n        device_id: deviceId,\n        action: 'turn_off',\n        parameters: {}\n      });\n    } else if (settings.on === true || settings.brightness !== undefined) {\n      actions.push({\n        device_id: deviceId,\n        action: 'turn_on',\n        parameters: {\n          brightness: settings.brightness || 100,\n          color_temp: settings.color_temp,\n          color: settings.color\n        }\n      });\n    }\n  } else if (deviceId.startsWith('climate.')) {\n    // Handle climate controls\n    if (settings.target_temp !== undefined) {\n      actions.push({\n        device_id: deviceId,\n        action: 'set_temperature',\n        parameters: {\n          temperature: settings.target_temp\n        }\n      });\n    }\n  } else if (deviceId.startsWith('switch.')) {\n    // Handle switch controls\n    actions.push({\n      device_id: deviceId,\n      action: settings.on ? 'turn_on' : 'turn_off',\n      parameters: {}\n    });\n  } else if (deviceId.startsWith('lock.')) {\n    // Handle lock controls\n    actions.push({\n      device_id: deviceId,\n      action: settings.locked ? 'lock' : 'unlock',\n      parameters: {}\n    });\n  }\n}\n\n// Handle scene activation\nif (config.scene_id) {\n  actions.push({\n    scene_id: config.scene_id,\n    action: 'activate',\n    parameters: {}\n  });\n}\n\n// Log context activation\nconsole.log(`Activating context ${data.detected_context} for event ${data.event_id}`);\nconsole.log(`Generated ${actions.length} device control actions`);\n\nreturn {\n  ...data,\n  device_actions: actions,\n  activation_timestamp: new Date().toISOString()\n};"
      },
      "id": "generate-actions",
      "name": "Generate Device Actions",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 200]
    },
    {
      "parameters": {
        "functionCode": "// Execute device control actions via Home Assistant\nconst data = $input.all()[0].json;\nconst actions = data.device_actions || [];\n\nconst results = [];\nconst errors = [];\n\n// Process each device action\nfor (const action of actions) {\n  try {\n    if (action.scene_id) {\n      // Handle scene activation\n      console.log(`Activating scene: ${action.scene_id}`);\n      results.push({\n        type: 'scene',\n        id: action.scene_id,\n        status: 'activated',\n        timestamp: new Date().toISOString()\n      });\n    } else if (action.device_id) {\n      // Handle device control\n      console.log(`Controlling device: ${action.device_id} -> ${action.action}`);\n      \n      // In real implementation, this would call the Home Assistant device control workflow\n      // For now, simulate the execution\n      results.push({\n        type: 'device',\n        device_id: action.device_id,\n        action: action.action,\n        parameters: action.parameters,\n        status: 'executed',\n        timestamp: new Date().toISOString()\n      });\n    }\n  } catch (error) {\n    errors.push({\n      action: action,\n      error: error.message,\n      timestamp: new Date().toISOString()\n    });\n  }\n}\n\nconst summary = {\n  context: data.detected_context,\n  event_id: data.event_id,\n  total_actions: actions.length,\n  successful_actions: results.length,\n  failed_actions: errors.length,\n  results: results,\n  errors: errors,\n  execution_timestamp: new Date().toISOString()\n};\n\nconsole.log('Context Activation Summary:', JSON.stringify(summary, null, 2));\n\nreturn summary;"
      },
      "id": "execute-actions",
      "name": "Execute Device Actions",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1200, 200]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.should_deactivate}}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-deactivation",
      "name": "Should Deactivate Context?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [800, 450]
    },
    {
      "parameters": {
        "functionCode": "// Handle context deactivation (event ending)\nconst data = $input.all()[0].json;\n\nconsole.log(`Deactivating context ${data.detected_context} for event ${data.event_id}`);\n\n// In real implementation, this would:\n// 1. Remove context from active calendar_contexts\n// 2. Check for next scheduled context\n// 3. Revert to previous state or default mode\n// 4. Clean up temporary automation overrides\n\n// For now, simulate returning to default state\nconst deactivationActions = [\n  {\n    action_type: 'revert_to_default',\n    description: 'Return devices to default state after context ends'\n  },\n  {\n    action_type: 'cleanup_overrides',\n    description: 'Remove temporary automation pauses and overrides'\n  }\n];\n\nreturn {\n  event_id: data.event_id,\n  deactivated_context: data.detected_context,\n  deactivation_actions: deactivationActions,\n  deactivation_timestamp: new Date().toISOString(),\n  next_context: 'default_mode' // Would be determined by checking calendar\n};"
      },
      "id": "handle-deactivation", 
      "name": "Handle Context Deactivation",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 450]
    },
    {
      "parameters": {
        "functionCode": "// Store calendar context in database and send notifications\nconst activationData = $('execute-actions').all()[0]?.json;\nconst deactivationData = $('handle-deactivation').all()[0]?.json;\nconst originalData = $('process-calendar-event').all()[0].json;\n\nlet response;\n\nif (activationData) {\n  // Context was activated\n  response = {\n    success: true,\n    action: 'context_activated',\n    event_id: originalData.event_id,\n    context: activationData.context,\n    actions_executed: activationData.successful_actions,\n    errors: activationData.errors,\n    message: `Home context switched to ${activationData.context} for calendar event`\n  };\n  \n  // In real implementation: INSERT INTO calendar_contexts\n  console.log(`Database: Store context activation for event ${originalData.event_id}`);\n  \n} else if (deactivationData) {\n  // Context was deactivated\n  response = {\n    success: true,\n    action: 'context_deactivated',\n    event_id: deactivationData.event_id,\n    previous_context: deactivationData.deactivated_context,\n    next_context: deactivationData.next_context,\n    message: `Home context returned to ${deactivationData.next_context} after calendar event ended`\n  };\n  \n  // In real implementation: UPDATE calendar_contexts SET end_time = NOW()\n  console.log(`Database: Store context deactivation for event ${deactivationData.event_id}`);\n  \n} else {\n  // No action taken (event updated but no context change needed)\n  response = {\n    success: true,\n    action: 'no_change',\n    event_id: originalData.event_id,\n    message: 'Calendar event processed but no home automation changes needed'\n  };\n}\n\n// Publish event for other scenarios to consume\nconst eventToPublish = {\n  type: 'home.calendar.context_changed',\n  data: response,\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('Publishing event:', JSON.stringify(eventToPublish, null, 2));\n\nreturn {\n  ...response,\n  published_event: eventToPublish\n};"
      },
      "id": "finalize-context",
      "name": "Finalize and Notify",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "webhook-response",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1600, 300]
    },
    {
      "parameters": {
        "mode": "manual"
      },
      "id": "manual-trigger",
      "name": "Manual Test Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [40, 600]
    },
    {
      "parameters": {
        "functionCode": "// Manual test data for calendar automation\nreturn {\n  event_id: 'test_meeting_001',\n  event_type: 'starting',\n  event_data: {\n    title: 'Important Meeting - Work from Home',\n    description: 'Video conference with the team',\n    start_time: new Date().toISOString(),\n    end_time: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(), // 2 hours\n    all_day: false,\n    location: 'home',\n    participants: ['user1', 'user2'],\n    priority: 'high'\n  },\n  test_mode: true\n};"
      },
      "id": "manual-test-data",
      "name": "Generate Test Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [200, 600]
    }
  ],
  "connections": {
    "Calendar Event Webhook": {
      "main": [
        [
          {
            "node": "Process Calendar Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Calendar Event": {
      "main": [
        [
          {
            "node": "Lookup Context Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup Context Config": {
      "main": [
        [
          {
            "node": "Should Activate Context?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Should Deactivate Context?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Activate Context?": {
      "main": [
        [
          {
            "node": "Generate Device Actions",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Finalize and Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Device Actions": {
      "main": [
        [
          {
            "node": "Execute Device Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Device Actions": {
      "main": [
        [
          {
            "node": "Finalize and Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Deactivate Context?": {
      "main": [
        [
          {
            "node": "Handle Context Deactivation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Finalize and Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Context Deactivation": {
      "main": [
        [
          {
            "node": "Finalize and Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize and Notify": {
      "main": [
        [
          {
            "node": "Send Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Test Trigger": {
      "main": [
        [
          {
            "node": "Generate Test Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Test Data": {
      "main": [
        [
          {
            "node": "Process Calendar Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "America/New_York"
  },
  "staticData": null,
  "tags": ["home-automation", "calendar", "context-switching", "shared-workflow"],
  "meta": {
    "description": "Shared workflow for calendar-driven home automation context switching. Automatically adjusts lighting, climate, and device settings based on calendar events.",
    "usage": "POST to webhook with calendar event data when events start, end, or update",
    "examples": [
      {
        "description": "Meeting starts - activate focus mode",
        "payload": {
          "event_id": "meeting_001",
          "event_type": "starting",
          "event_data": {
            "title": "Team Meeting",
            "start_time": "2024-01-22T14:00:00Z",
            "end_time": "2024-01-22T15:00:00Z"
          }
        }
      },
      {
        "description": "Movie night event - activate entertainment mode",
        "payload": {
          "event_id": "movie_001",
          "event_type": "starting",
          "event_data": {
            "title": "Movie Night",
            "description": "Watch the new Marvel movie"
          }
        }
      }
    ],
    "context_mapping": {
      "meeting": "focus_mode",
      "movie night": "entertainment_mode", 
      "bedtime": "sleep_mode",
      "vacation": "away_mode",
      "work from home": "work_mode"
    },
    "features": [
      "Automatic context detection from event titles",
      "Scene activation based on context",
      "Device control override management",
      "Conflict resolution for overlapping events",
      "Context deactivation when events end",
      "Database logging of all context changes"
    ]
  }
}