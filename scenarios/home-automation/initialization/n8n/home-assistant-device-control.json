{
  "name": "Home Assistant Device Control",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "device-control",
        "options": {
          "authentication": {
            "type": "headerAuth",
            "headerAuth": {
              "name": "Authorization",
              "value": "Bearer {{$env.HOME_AUTOMATION_API_TOKEN}}"
            }
          }
        }
      },
      "id": "webhook-trigger",
      "name": "Device Control Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "device-control-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Validate and sanitize device control request\nconst payload = $input.all()[0].json;\n\n// Required fields validation\nif (!payload.device_id) {\n  throw new Error('device_id is required');\n}\n\nif (!payload.action) {\n  throw new Error('action is required');\n}\n\nif (!payload.user_id && !payload.profile_id) {\n  throw new Error('user_id or profile_id is required');\n}\n\n// Sanitize device_id (prevent injection)\nconst deviceId = payload.device_id.replace(/[^a-zA-Z0-9._]/g, '');\n\n// Validate action against allowed actions\nconst allowedActions = [\n  'turn_on', 'turn_off', 'toggle', 'set_brightness', \n  'set_temperature', 'set_color', 'activate', 'refresh'\n];\n\nif (!allowedActions.includes(payload.action)) {\n  throw new Error(`Invalid action: ${payload.action}`);\n}\n\n// Prepare output\nreturn {\n  device_id: deviceId,\n  action: payload.action,\n  parameters: payload.parameters || {},\n  user_id: payload.user_id,\n  profile_id: payload.profile_id,\n  timestamp: new Date().toISOString(),\n  request_id: `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n};"
      },
      "id": "validate-request",
      "name": "Validate Request",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [400, 300]
    },
    {
      "parameters": {
        "functionCode": "// Check user permissions for device control\nconst data = $input.all()[0].json;\n\n// Mock permission check - in real implementation, this would:\n// 1. Query scenario-authenticator for user details\n// 2. Query home_profiles table for permissions\n// 3. Check if user can control specific device\n\n// For now, simulate permission check\nconst mockPermissions = {\n  'admin-user': ['*'],\n  'family-member': ['light.living_room', 'light.bedroom', 'switch.coffee_maker'],\n  'kid-user': ['light.bedroom_kid']\n};\n\n// Simulate user lookup (would be real API call)\nlet userType = 'admin-user'; // Default for demo\nif (data.user_id === '550e8400-e29b-41d4-a716-446655440002') {\n  userType = 'family-member';\n} else if (data.user_id === '550e8400-e29b-41d4-a716-446655440003') {\n  userType = 'kid-user';\n}\n\nconst allowedDevices = mockPermissions[userType] || [];\n\n// Check permission\nconst hasPermission = allowedDevices.includes('*') || allowedDevices.includes(data.device_id);\n\nif (!hasPermission) {\n  throw new Error(`Permission denied: User cannot control device ${data.device_id}`);\n}\n\n// Log permission check for audit\nconsole.log(`Permission granted: ${userType} -> ${data.device_id} -> ${data.action}`);\n\nreturn {\n  ...data,\n  permission_granted: true,\n  user_type: userType\n};"
      },
      "id": "check-permissions",
      "name": "Check Permissions",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [600, 300]
    },
    {
      "parameters": {
        "command": "resource-home-assistant device control {{$json.device_id}} {{$json.action}}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "execute-command",
      "name": "Execute Home Assistant Command",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [800, 300]
    },
    {
      "parameters": {
        "functionCode": "// Parse and format Home Assistant CLI response\nconst data = $input.all()[0].json;\nconst cliOutput = data.stdout || '';\nconst cliError = data.stderr || '';\nconst exitCode = data.code || 0;\n\nlet response = {\n  success: exitCode === 0,\n  device_id: $node['validate-request'].json.device_id,\n  action: $node['validate-request'].json.action,\n  request_id: $node['validate-request'].json.request_id,\n  timestamp: new Date().toISOString(),\n  execution_time_ms: Date.now() - new Date($node['validate-request'].json.timestamp).getTime()\n};\n\nif (response.success) {\n  // Parse successful response\n  try {\n    const result = JSON.parse(cliOutput);\n    response.device_state = result.state || {};\n    response.message = `Device ${response.device_id} ${response.action} completed successfully`;\n  } catch (e) {\n    // Fallback for non-JSON output\n    response.message = cliOutput.trim() || `Device ${response.action} completed`;\n  }\n} else {\n  // Handle error\n  response.error = cliError.trim() || cliOutput.trim() || 'Command failed';\n  response.message = `Failed to ${response.action} device ${response.device_id}: ${response.error}`;\n}\n\nreturn response;"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "functionCode": "// Log automation execution to database\nconst response = $input.all()[0].json;\nconst request = $node['validate-request'].json;\n\n// In real implementation, this would insert into automation_executions table\n// For now, just log to console\n\nconst logEntry = {\n  type: 'device_control',\n  device_id: response.device_id,\n  action: response.action,\n  user_id: request.user_id,\n  success: response.success,\n  execution_time_ms: response.execution_time_ms,\n  timestamp: response.timestamp,\n  request_id: response.request_id\n};\n\nconsole.log('Device Control Log:', JSON.stringify(logEntry, null, 2));\n\n// Update device state cache if successful\nif (response.success && response.device_state) {\n  console.log(`Updating device state cache for ${response.device_id}:`, response.device_state);\n  // In real implementation: UPDATE device_states table\n}\n\nreturn response;"
      },
      "id": "log-execution",
      "name": "Log Execution",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1200, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "webhook-response",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "functionCode": "// Manual trigger with default test parameters\nreturn {\n  device_id: 'light.living_room',\n  action: 'turn_on',\n  parameters: {\n    brightness: 80\n  },\n  user_id: '550e8400-e29b-41d4-a716-446655440001',\n  test_mode: true\n};"
      },
      "id": "manual-trigger",
      "name": "Manual Test Trigger",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "manual"
      },
      "id": "manual-start",
      "name": "Manual Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [40, 500]
    },
    {
      "parameters": {
        "functionCode": "// Error handler for device control failures\nconst error = $input.all()[0].json;\nconst originalRequest = $node['validate-request'].json;\n\nconst errorResponse = {\n  success: false,\n  device_id: originalRequest?.device_id || 'unknown',\n  action: originalRequest?.action || 'unknown',\n  request_id: originalRequest?.request_id || 'unknown',\n  error: error.message || 'Unknown error occurred',\n  timestamp: new Date().toISOString(),\n  execution_time_ms: originalRequest ? \n    Date.now() - new Date(originalRequest.timestamp).getTime() : 0\n};\n\n// Log error for debugging\nconsole.error('Device Control Error:', errorResponse);\n\n// In real implementation, log to error tracking system\n// and update automation_executions table with failure status\n\nreturn errorResponse;"
      },
      "id": "error-handler",
      "name": "Error Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [800, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}"
      },
      "id": "error-response",
      "name": "Send Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1000, 500]
    }
  ],
  "connections": {
    "Device Control Webhook": {
      "main": [
        [
          {
            "node": "Validate Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Request": {
      "main": [
        [
          {
            "node": "Check Permissions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Permissions": {
      "main": [
        [
          {
            "node": "Execute Home Assistant Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Home Assistant Command": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Log Execution",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Execution": {
      "main": [
        [
          {
            "node": "Send Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Test Trigger": {
      "main": [
        [
          {
            "node": "Validate Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Start": {
      "main": [
        [
          {
            "node": "Manual Test Trigger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "America/New_York"
  },
  "staticData": null,
  "tags": ["home-automation", "device-control", "shared-workflow"],
  "meta": {
    "description": "Shared workflow for reliable Home Assistant device control with permission validation, error handling, and execution logging. Used by home automation scenario and available for other IoT scenarios.",
    "usage": "POST to webhook with: {device_id, action, parameters?, user_id|profile_id}",
    "examples": [
      {
        "description": "Turn on living room lights",
        "payload": {
          "device_id": "light.living_room",
          "action": "turn_on", 
          "parameters": {"brightness": 80},
          "user_id": "user-uuid"
        }
      },
      {
        "description": "Set thermostat temperature",
        "payload": {
          "device_id": "climate.thermostat",
          "action": "set_temperature",
          "parameters": {"temperature": 72},
          "profile_id": "profile-uuid"
        }
      }
    ],
    "error_handling": "Returns structured error responses with permission denial details",
    "security": "Validates user permissions against home_profiles table",
    "logging": "Logs all executions to automation_executions table",
    "timeout": "10 second timeout for Home Assistant CLI commands"
  }
}