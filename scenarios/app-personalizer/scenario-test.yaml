name: app-personalizer
description: Validate app personalization capabilities with digital twins and branding
version: 1.0.0

resources:
  required:
    - claude-code
    - ollama
    - postgres
    - minio
    - n8n
  
dependencies:
  scenarios:
    - personal-digital-twin
    - brand-manager

tests:
  - name: resource_availability
    description: Verify all required resources are accessible
    steps:
      - check_service: localhost:${RESOURCE_PORTS[claude-code]}
      - check_service: localhost:${RESOURCE_PORTS[ollama]}
      - check_service: localhost:${RESOURCE_PORTS[postgres]}
      - check_service: localhost:${RESOURCE_PORTS[minio]}
      - check_service: localhost:${RESOURCE_PORTS[n8n]}

  - name: integration_connectivity
    description: Verify connections to dependent scenarios
    steps:
      - check_service: localhost:${PERSONAL_DIGITAL_TWIN_PORT}  # personal-digital-twin
      - check_service: localhost:${BRAND_MANAGER_PORT}  # brand-manager
      - api_call:
          method: GET
          url: http://localhost:${PERSONAL_DIGITAL_TWIN_PORT}/health
          expected_status: 200
      - api_call:
          method: GET
          url: http://localhost:${BRAND_MANAGER_PORT}/health
          expected_status: 200

  - name: app_registration
    description: Test registering an app for personalization
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/apps/register
          body:
            app_name: "TestApp"
            app_path: "/scenarios/test-app"
            app_type: "generated"
            framework: "react"
          expected_status: 201
      - verify_database:
          table: app_registry
          condition: "app_name = 'TestApp'"

  - name: app_analysis
    description: Test analyzing app for personalization points
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/apps/analyze
          body:
            app_id: "${app_id}"
          expected_status: 200
          validate_response:
            has_field: "personalization_points"
            array_length: ">0"

  - name: simple_personalization
    description: Test basic UI theme personalization
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/personalize
          body:
            app_id: "${app_id}"
            brand_id: "${brand_id}"
            personalization_type: "ui_theme"
            deployment_mode: "copy"
          expected_status: 202
      - wait: 30
      - verify_database:
          table: personalizations
          condition: "app_id = '${app_id}' AND status IN ('completed', 'validated')"

  - name: twin_personalization
    description: Test personalization with digital twin
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/personalize
          body:
            app_id: "${app_id}"
            persona_id: "${persona_id}"
            twin_api_token: "${test_token}"
            personalization_type: "content"
            deployment_mode: "copy"
          expected_status: 202
      - wait: 45
      - verify_files:
          path: "/scenarios/test-app-personalized-${persona_id}"
          exists: true

  - name: full_personalization
    description: Test complete personalization with twin and branding
    steps:
      - webhook_call:
          url: http://localhost:${RESOURCE_PORTS[n8n]}/webhook/personalize
          method: POST
          body:
            app_path: "/scenarios/test-app"
            persona_id: "${persona_id}"
            brand_id: "${brand_id}"
            twin_api_token: "${test_token}"
            brand_api_key: "${test_key}"
            personalization_type: "full"
            deployment_mode: "copy"
          expected_status: 200
      - wait: 60
      - verify_workflow_output:
          expected_keys: ["personalized_app_path", "modifications_applied"]

  - name: backup_creation
    description: Verify backups are created before personalization
    steps:
      - verify_database:
          table: app_backups
          condition: "app_id = '${app_id}'"
      - verify_storage:
          bucket: app-backups
          file_pattern: "${app_id}/*.tar.gz"

  - name: claude_code_modification
    description: Test Claude Code integration for modifications
    steps:
      - api_call:
          method: POST
          url: http://localhost:${RESOURCE_PORTS[claude-code]}/api/modify
          body:
            project_path: "/scenarios/test-app-copy"
            modifications: [
              {
                "type": "ui_theme",
                "files": ["src/styles/theme.js"],
                "changes": {"primary_color": "#FF5733"}
              }
            ]
          expected_status: 200
          timeout: 300000

  - name: multi_tenant_setup
    description: Test multi-tenant configuration
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/multi-tenant/configure
          body:
            app_id: "${app_id}"
            tenant_id: "${persona_id}"
            config_type: "theme"
            configuration:
              colors:
                primary: "#FF5733"
                secondary: "#33FF57"
          expected_status: 201
      - verify_database:
          table: multi_tenant_configs
          condition: "app_id = '${app_id}' AND tenant_id = '${persona_id}'"

  - name: validation_testing
    description: Test personalized app validation
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/validate
          body:
            app_path: "/scenarios/test-app-personalized"
            tests: ["build", "lint"]
          expected_status: 200
          timeout: 180000
          validate_response:
            has_field: "validation_results"
            nested_field: "validation_results.build.success"
            value: true

  - name: rollback_capability
    description: Test rollback of personalization
    steps:
      - api_call:
          method: POST
          url: http://localhost:${API_PORT}/api/rollback
          body:
            personalization_id: "${personalization_id}"
          expected_status: 200
      - verify_database:
          table: personalizations
          condition: "id = '${personalization_id}' AND rollback_at IS NOT NULL"

validation:
  performance:
    simple_personalization_time: "<60s"
    full_personalization_time: "<180s"
    app_analysis_time: "<30s"
    backup_time: "<30s"
  
  data_integrity:
    - all_personalizations_have_backups: true
    - modifications_are_tracked: true
    - integrations_are_verified: true
    - validation_passes_for_personalizations: true