#!/bin/bash
################################################################################
# Bookmark Intelligence Hub CLI - Thin Wrapper Version
# 
# A lightweight CLI that delegates all logic to the scenario's API.
# Port discovery uses ultra-fast file-based lookup.
################################################################################

set -e

# Configuration
SCENARIO_NAME="bookmark-intelligence-hub"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

################################################################################
# Port Discovery - Ultra-fast file-based lookup
################################################################################
get_api_url() {
    # Use the ultra-fast port command
    local api_port
    api_port=$(vrooli scenario port "${SCENARIO_NAME}" API_PORT 2>/dev/null)
    
    if [[ -z "$api_port" ]]; then
        echo -e "${RED}‚ùå Error: ${SCENARIO_NAME} is not running${NC}" >&2
        echo "   Start it with: vrooli scenario run ${SCENARIO_NAME}" >&2
        exit 1
    fi
    
    echo "http://localhost:${api_port}"
}

################################################################################
# Helper Functions
################################################################################
usage() {
    echo -e "${CYAN}Bookmark Intelligence Hub CLI${NC}"
    echo "Intelligent bookmark management with AI categorization and automation"
    echo ""
    echo "Usage: bookmark-intelligence-hub [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}profiles${NC}      Manage user profiles and settings"
    echo -e "  ${GREEN}bookmarks${NC}     Process, query, and sync bookmarks"
    echo -e "  ${GREEN}categories${NC}    Manage bookmark categories"
    echo -e "  ${GREEN}actions${NC}       Manage pending automation actions"
    echo -e "  ${GREEN}platforms${NC}     Manage platform integrations"
    echo -e "  ${GREEN}analytics${NC}     View processing metrics and insights"
    echo -e "  ${GREEN}sync${NC}          Synchronize bookmarks from platforms"
    echo -e "  ${GREEN}health${NC}        Check service health and status"
    echo ""
    echo "Examples:"
    echo "  bookmark-intelligence-hub profiles list"
    echo "  bookmark-intelligence-hub bookmarks query --category Programming"
    echo "  bookmark-intelligence-hub sync reddit"
    echo "  bookmark-intelligence-hub actions approve action-123"
    echo "  bookmark-intelligence-hub analytics metrics"
    echo ""
    echo "Options:"
    echo "  --help, -h       Show help for any command"
    echo "  --json           Output in JSON format (most commands)"
    echo "  --verbose        Show detailed output"
    echo ""
    echo "For more information: bookmark-intelligence-hub <command> --help"
}

# Format JSON output if jq is available
format_json() {
    if command -v jq >/dev/null 2>&1; then
        jq .
    else
        cat
    fi
}

# Make API request
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="${3:-}"
    local api_url
    
    # Get the current API URL
    api_url=$(get_api_url)
    
    local curl_args=(-s)
    
    if [[ "$method" != "GET" ]]; then
        curl_args+=(-X "$method")
    fi
    
    if [[ -n "$data" ]]; then
        curl_args+=(-H "Content-Type: application/json" -d "$data")
    fi
    
    curl "${curl_args[@]}" "${api_url}${endpoint}"
}

################################################################################
# Command Implementations - All delegated to API
################################################################################

# Profiles command
cmd_profiles() {
    local subcommand="${1:-list}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        list)
            cmd_profiles_list "$@"
            ;;
        create)
            cmd_profiles_create "$@"
            ;;
        view)
            cmd_profiles_view "$@"
            ;;
        stats)
            cmd_profiles_stats "$@"
            ;;
        --help|-h)
            echo "Usage: bookmark-intelligence-hub profiles [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  list              List all profiles"
            echo "  create <name>     Create a new profile"
            echo "  view <id>         View specific profile details"
            echo "  stats <id>        View profile statistics"
            echo ""
            echo "For more information: bookmark-intelligence-hub profiles <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown profiles command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_profiles_list() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub profiles list [OPTIONS]"
                echo ""
                echo "List all user profiles"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üë§ Fetching profiles...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/profiles")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Found $count profiles:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "- \(.name) (ID: \(.id))"' 2>/dev/null
        else
            echo -e "${YELLOW}No profiles found${NC}"
        fi
    fi
}

cmd_profiles_create() {
    echo -e "${YELLOW}‚ö†Ô∏è  Profile creation not yet implemented${NC}"
    echo "   This feature will be available in a future update"
}

cmd_profiles_view() {
    local profile_id="$1"
    local json_output=false
    
    if [[ -z "$profile_id" || "$profile_id" == "--help" || "$profile_id" == "-h" ]]; then
        echo "Usage: bookmark-intelligence-hub profiles view <profile-id> [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --json    Output in JSON format"
        return 0
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üë§ Fetching profile details...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/profiles/${profile_id}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}‚úÖ Profile Details:${NC}"
        echo "$response" | format_json
    fi
}

cmd_profiles_stats() {
    local profile_id="$1"
    local json_output=false
    
    if [[ -z "$profile_id" || "$profile_id" == "--help" || "$profile_id" == "-h" ]]; then
        echo "Usage: bookmark-intelligence-hub profiles stats <profile-id> [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --json    Output in JSON format"
        return 0
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üìä Fetching profile statistics...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/profiles/${profile_id}/stats")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}‚úÖ Profile Statistics:${NC}"
        echo ""
        
        if echo "$response" | jq -e . >/dev/null 2>&1; then
            echo "$response" | jq -r '
                "üìö Total Bookmarks: \(.total_bookmarks)",
                "üìÅ Categories: \(.categories_count)",
                "‚ö° Pending Actions: \(.pending_actions)",
                "üéØ Accuracy Rate: \(.accuracy_rate)%"
            ' 2>/dev/null
        else
            echo "$response"
        fi
    fi
}

# Bookmarks command
cmd_bookmarks() {
    local subcommand="${1:-query}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        process)
            cmd_bookmarks_process "$@"
            ;;
        query)
            cmd_bookmarks_query "$@"
            ;;
        sync)
            cmd_bookmarks_sync "$@"
            ;;
        --help|-h)
            echo "Usage: bookmark-intelligence-hub bookmarks [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  process       Process new bookmarks with AI"
            echo "  query         Query existing bookmarks"
            echo "  sync          Synchronize bookmarks from all platforms"
            echo ""
            echo "For more information: bookmark-intelligence-hub bookmarks <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown bookmarks command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_bookmarks_process() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub bookmarks process [OPTIONS]"
                echo ""
                echo "Process new bookmarks with AI categorization and analysis"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}ü§ñ Processing bookmarks with AI...${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/bookmarks/process" "{}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "success"; then
            echo -e "${GREEN}‚úÖ Bookmark processing completed${NC}"
            local processed=$(echo "$response" | jq -r '.processed_count // 0' 2>/dev/null)
            echo "   Processed: $processed bookmarks"
        else
            echo -e "${RED}‚ùå Processing failed${NC}"
            echo "$response"
        fi
    fi
}

cmd_bookmarks_query() {
    local category=""
    local platform=""
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --category)
                category="$2"
                shift 2
                ;;
            --platform)
                platform="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub bookmarks query [OPTIONS]"
                echo ""
                echo "Query and search your bookmarks"
                echo ""
                echo "Options:"
                echo "  --category <cat>    Filter by category"
                echo "  --platform <plat>   Filter by platform"
                echo "  --json              Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  bookmark-intelligence-hub bookmarks query --category Programming"
                echo "  bookmark-intelligence-hub bookmarks query --platform reddit"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local endpoint="/api/v1/bookmarks/query"
    local query_params=""
    
    [[ -n "$category" ]] && query_params="${query_params:+$query_params&}category=$category"
    [[ -n "$platform" ]] && query_params="${query_params:+$query_params&}platform=$platform"
    [[ -n "$query_params" ]] && endpoint="${endpoint}?${query_params}"
    
    echo -e "${BLUE}üîç Querying bookmarks...${NC}"
    
    local response
    response=$(api_request "GET" "$endpoint")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local total=$(echo "$response" | jq -r '.total_count // 0' 2>/dev/null)
        echo -e "${GREEN}‚úÖ Found $total bookmarks:${NC}"
        echo ""
        
        if [[ $total -gt 0 ]]; then
            echo "$response" | jq -r '.bookmarks[]? | "üìö \(.title) (\(.platform)) - \(.category)"' 2>/dev/null
        else
            echo -e "${YELLOW}No bookmarks found matching your criteria${NC}"
        fi
    fi
}

cmd_bookmarks_sync() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub bookmarks sync [OPTIONS]"
                echo ""
                echo "Synchronize bookmarks from all connected platforms"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üîÑ Syncing bookmarks from all platforms...${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/bookmarks/sync" "{}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "success"; then
            echo -e "${GREEN}‚úÖ Sync completed${NC}"
            local processed=$(echo "$response" | jq -r '.processed_count // 0' 2>/dev/null)
            echo "   Processed: $processed bookmarks"
        else
            echo -e "${RED}‚ùå Sync failed${NC}"
            echo "$response"
        fi
    fi
}

# Categories command
cmd_categories() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub categories [OPTIONS]"
                echo ""
                echo "List all bookmark categories with counts"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üìÅ Fetching categories...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/categories")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Found $count categories:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "üìÅ \(.name): \(.count) bookmarks"' 2>/dev/null
        else
            echo -e "${YELLOW}No categories found${NC}"
        fi
    fi
}

# Actions command
cmd_actions() {
    local subcommand="${1:-list}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        list)
            cmd_actions_list "$@"
            ;;
        approve)
            cmd_actions_approve "$@"
            ;;
        reject)
            cmd_actions_reject "$@"
            ;;
        --help|-h)
            echo "Usage: bookmark-intelligence-hub actions [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  list              List pending actions"
            echo "  approve <id>      Approve a specific action"
            echo "  reject <id>       Reject a specific action"
            echo ""
            echo "For more information: bookmark-intelligence-hub actions <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown actions command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_actions_list() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub actions list [OPTIONS]"
                echo ""
                echo "List all pending automation actions"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}‚ö° Fetching pending actions...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/actions")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Found $count pending actions:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "‚ö° \(.title) (ID: \(.id))"' 2>/dev/null
        else
            echo -e "${YELLOW}No pending actions${NC}"
        fi
    fi
}

cmd_actions_approve() {
    local action_id="$1"
    local json_output=false
    
    if [[ -z "$action_id" || "$action_id" == "--help" || "$action_id" == "-h" ]]; then
        echo "Usage: bookmark-intelligence-hub actions approve <action-id> [OPTIONS]"
        echo ""
        echo "Approve a specific automation action"
        echo ""
        echo "Options:"
        echo "  --json    Output in JSON format"
        return 0
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local request_body=$(jq -n \
        --arg action_id "$action_id" \
        '{action_ids: [$action_id]}')
    
    echo -e "${BLUE}‚úÖ Approving action: $action_id${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/actions/approve" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "success"; then
            echo -e "${GREEN}‚úÖ Action approved successfully${NC}"
            local approved=$(echo "$response" | jq -r '.approved_count // 1' 2>/dev/null)
            echo "   Actions approved: $approved"
        else
            echo -e "${RED}‚ùå Failed to approve action${NC}"
            echo "$response"
        fi
    fi
}

cmd_actions_reject() {
    local action_id="$1"
    local json_output=false
    
    if [[ -z "$action_id" || "$action_id" == "--help" || "$action_id" == "-h" ]]; then
        echo "Usage: bookmark-intelligence-hub actions reject <action-id> [OPTIONS]"
        echo ""
        echo "Reject a specific automation action"
        echo ""
        echo "Options:"
        echo "  --json    Output in JSON format"
        return 0
    fi
    
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    local request_body=$(jq -n \
        --arg action_id "$action_id" \
        '{action_ids: [$action_id]}')
    
    echo -e "${BLUE}‚ùå Rejecting action: $action_id${NC}"
    
    local response
    response=$(api_request "POST" "/api/v1/actions/reject" "$request_body")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "success"; then
            echo -e "${GREEN}‚úÖ Action rejected successfully${NC}"
            local rejected=$(echo "$response" | jq -r '.rejected_count // 1' 2>/dev/null)
            echo "   Actions rejected: $rejected"
        else
            echo -e "${RED}‚ùå Failed to reject action${NC}"
            echo "$response"
        fi
    fi
}

# Platforms command
cmd_platforms() {
    local subcommand="${1:-list}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        list)
            cmd_platforms_list "$@"
            ;;
        status)
            cmd_platforms_status "$@"
            ;;
        --help|-h)
            echo "Usage: bookmark-intelligence-hub platforms [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  list      List all supported platforms"
            echo "  status    Show platform connection status"
            echo ""
            echo "For more information: bookmark-intelligence-hub platforms <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown platforms command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_platforms_list() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub platforms list [OPTIONS]"
                echo ""
                echo "List all supported platforms and their capabilities"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üåê Fetching supported platforms...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/platforms")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Found $count supported platforms:${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "üåê \(.display_name) (\(.name)): \(if .supported then "‚úÖ Supported" else "‚ùå Not Available" end)"' 2>/dev/null
        else
            echo -e "${YELLOW}No platforms found${NC}"
        fi
    fi
}

cmd_platforms_status() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub platforms status [OPTIONS]"
                echo ""
                echo "Show connection status for all platforms"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üîå Checking platform connection status...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/platforms/status")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        local count=$(echo "$response" | jq '. | length' 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Platform Status ($count platforms):${NC}"
        echo ""
        
        if [[ $count -gt 0 ]]; then
            echo "$response" | jq -r '.[] | "üîå \(.name): \(if .connected then "‚úÖ Connected" else "‚ùå Disconnected" end)"' 2>/dev/null
        else
            echo -e "${YELLOW}No platform status available${NC}"
        fi
    fi
}

# Analytics command
cmd_analytics() {
    local subcommand="${1:-metrics}"
    shift 2>/dev/null || true
    
    case "$subcommand" in
        metrics)
            cmd_analytics_metrics "$@"
            ;;
        --help|-h)
            echo "Usage: bookmark-intelligence-hub analytics [COMMAND] [OPTIONS]"
            echo ""
            echo "Commands:"
            echo "  metrics    Show processing metrics and insights"
            echo ""
            echo "For more information: bookmark-intelligence-hub analytics <command> --help"
            ;;
        *)
            echo -e "${RED}‚ùå Unknown analytics command: $subcommand${NC}" >&2
            return 1
            ;;
    esac
}

cmd_analytics_metrics() {
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub analytics metrics [OPTIONS]"
                echo ""
                echo "Show comprehensive processing metrics and insights"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üìà Fetching analytics metrics...${NC}"
    
    local response
    response=$(api_request "GET" "/api/v1/analytics/metrics")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        echo -e "${GREEN}‚úÖ Analytics Metrics:${NC}"
        echo ""
        
        if echo "$response" | jq -e . >/dev/null 2>&1; then
            echo "$response" | jq -r '
                "üìö Total Bookmarks: \(.total_bookmarks)",
                "üéØ Processing Accuracy: \(.processing_accuracy)%",
                "‚ö° Actions Executed: \(.actions_executed)",
                "",
                "üìä Platform Breakdown:"
            ' 2>/dev/null
            
            echo "$response" | jq -r '.platform_breakdown | to_entries[] | "   \(.key): \(.value) bookmarks"' 2>/dev/null
        else
            echo "$response"
        fi
    fi
}

# Sync command (standalone for backward compatibility)
cmd_sync() {
    local platform=""
    local json_output=false
    
    # Parse positional argument for platform
    if [[ $# -gt 0 && ! "$1" =~ ^-- ]]; then
        platform="$1"
        shift
    fi
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub sync [platform] [OPTIONS]"
                echo ""
                echo "Synchronize bookmarks from all platforms or a specific one"
                echo ""
                echo "Options:"
                echo "  --json    Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  bookmark-intelligence-hub sync"
                echo "  bookmark-intelligence-hub sync reddit"
                echo "  bookmark-intelligence-hub sync twitter"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    if [[ -n "$platform" ]]; then
        echo -e "${BLUE}üîÑ Syncing bookmarks from $platform...${NC}"
        local endpoint="/api/v1/platforms/${platform}/sync"
    else
        echo -e "${BLUE}üîÑ Syncing bookmarks from all platforms...${NC}"
        local endpoint="/api/v1/bookmarks/sync"
    fi
    
    local response
    response=$(api_request "POST" "$endpoint" "{}")
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "success"; then
            echo -e "${GREEN}‚úÖ Sync completed${NC}"
            local processed=$(echo "$response" | jq -r '.processed_count // 0' 2>/dev/null)
            echo "   Processed: $processed bookmarks"
            [[ -n "$platform" ]] && echo "   Platform: $platform"
        else
            echo -e "${RED}‚ùå Sync failed${NC}"
            echo "$response"
        fi
    fi
}

# Health check command
cmd_health() {
    local json_output=false
    local verbose=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --verbose)
                verbose=true
                shift
                ;;
            --help|-h)
                echo "Usage: bookmark-intelligence-hub health [OPTIONS]"
                echo ""
                echo "Check the health status of all services"
                echo ""
                echo "Options:"
                echo "  --json       Output in JSON format"
                echo "  --verbose    Show detailed health information"
                return 0
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${BLUE}üè• Checking service health...${NC}"
    
    local api_url
    api_url=$(get_api_url)
    
    local response
    response=$(curl -s "${api_url}/health" 2>/dev/null)
    
    if [[ $json_output == true ]]; then
        echo "$response" | format_json
    else
        if echo "$response" | grep -q "healthy"; then
            echo -e "${GREEN}‚úÖ Bookmark Intelligence Hub is healthy${NC}"
            echo "   API: ${api_url}"
            
            if [[ "$verbose" == true ]]; then
                echo "   Version: $(echo "$response" | jq -r '.version' 2>/dev/null)"
                echo "   Database: $(echo "$response" | jq -r '.database' 2>/dev/null)"
                echo "   Huginn: $(echo "$response" | jq -r '.huginn' 2>/dev/null)"
            fi
        else
            echo -e "${RED}‚ùå Health check failed${NC}"
            echo "   Response: $response"
            return 1
        fi
    fi
}

################################################################################
# Main Command Router
################################################################################
main() {
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        usage
        exit 0
    fi
    
    shift
    
    case "$command" in
        profiles)
            cmd_profiles "$@"
            ;;
        bookmarks)
            cmd_bookmarks "$@"
            ;;
        categories)
            cmd_categories "$@"
            ;;
        actions)
            cmd_actions "$@"
            ;;
        platforms)
            cmd_platforms "$@"
            ;;
        analytics)
            cmd_analytics "$@"
            ;;
        sync)
            cmd_sync "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        --version|-v|version)
            echo "Bookmark Intelligence Hub CLI v2.0.0 (thin wrapper)"
            ;;
            
        # Legacy commands for backward compatibility
        profile)
            echo -e "${YELLOW}‚ö†Ô∏è  'profile' is deprecated. Use 'profiles' instead${NC}"
            cmd_profiles "$@"
            ;;
        status)
            echo -e "${YELLOW}‚ö†Ô∏è  'status' is deprecated. Use 'health' instead${NC}"
            cmd_health "$@"
            ;;
            
        *)
            echo -e "${RED}‚ùå Unknown command: $command${NC}" >&2
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"