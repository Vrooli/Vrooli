version: 1.0
scenario: ai-chatbot-manager
description: "AI Chatbot Manager - Build and manage AI-powered chatbots for 24/7 sales and support"

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/ai-chatbot-manager
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - initialization/storage/postgres/seed.sql
    - ui/package.json
    - ui/src/App.js
    - ui/public/widget.js
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - ui
    - ui/src/components
    - initialization
    - initialization/storage
    - initialization/storage/postgres
    - data
    - test

# Resource validation
resources:
  required: 
    - ollama
    - postgres
  optional: []
  health_timeout: 60

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL is accessible"
    type: http
    service: postgres
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "Ollama is accessible"
    type: http  
    service: ollama
    endpoint: /api/tags
    method: GET
    expect:
      status: 200

  # API endpoint tests
  - name: "API health endpoint responds correctly"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        
  - name: "API chatbots endpoint responds correctly"
    type: http
    service: api
    endpoint: /api/v1/chatbots
    method: GET
    expect:
      status: 200

  # CLI command tests
  - name: "CLI status command executes"
    type: exec
    command: ./cli/ai-chatbot-manager status --json
    expect:
      exit_code: 0
      output_contains: ["healthy"]
      
  - name: "CLI help command executes"
    type: exec
    command: ./cli/ai-chatbot-manager help
    expect:
      exit_code: 0
      output_contains: ["AI Chatbot Manager CLI"]

  # Database tests
  - name: "Database schema is initialized"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('chatbots', 'conversations', 'messages', 'daily_analytics')"
    expect:
      rows:
        - count: 4

  - name: "Sample chatbots exist in database"
    type: sql
    service: postgres  
    query: "SELECT COUNT(*) FROM chatbots"
    expect:
      rows:
        - count: 4

  # UI tests
  - name: "React app builds successfully"
    type: exec
    command: cd ui && npm run build
    expect:
      exit_code: 0

  # Widget integration test
  - name: "Widget script is accessible"
    type: http
    service: ui
    endpoint: /widget.js
    method: GET
    expect:
      status: 200
      headers:
        content-type: "application/javascript"

# Performance validation  
performance:
  - name: "API response time under load"
    type: http
    service: api
    endpoint: /health
    concurrent_requests: 10
    expect:
      avg_response_time_ms: 100
      success_rate: 100

# Integration validation
integration:
  - name: "Create chatbot via API"
    type: http
    service: api
    endpoint: /api/v1/chatbots
    method: POST
    body:
      name: "Test Bot"
      personality: "You are a test assistant"
    expect:
      status: 200
      body:
        chatbot:
          name: "Test Bot"

  - name: "Send test message to chatbot"
    type: http
    service: api
    endpoint: /api/v1/chat/${CREATED_CHATBOT_ID}
    method: POST
    body:
      message: "Hello"
      session_id: "test-session"
    expect:
      status: 200
      body:
        response: "*"  # Any non-empty response
        confidence: "*"