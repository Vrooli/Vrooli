version: 1.0
scenario: visited-tracker

structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/visited-tracker
    - cli/install.sh
    - initialization/storage/postgres/schema.sql
    - scenario-test.yaml
    - ui/index.html
    - ui/package.json
    - ui/server.js
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/storage
    - initialization/storage/postgres
    - ui
    - test

resources:
  required: [postgres]
  optional: [redis]
  health_timeout: 60

tests:
  - name: "PostgreSQL is accessible"
    type: resource_health
    service: postgres
    expect:
      status: healthy
      
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: healthy
        service: visited-tracker
        
  - name: "Visit recording endpoint accessible"
    type: http
    service: api
    endpoint: /api/v1/visit
    method: POST
    body:
      files: ["test.js", "main.go"]
      context: "test"
    expect:
      status: 200
      body:
        recorded: 2
      
  - name: "Structure sync works"
    type: http
    service: api
    endpoint: /api/v1/structure/sync
    method: POST
    body:
      patterns: ["*.md"]
      remove_deleted: false
    expect:
      status: 200
      body:
        added: "[number]"
        removed: "[number]"
        moved: "[number]"
        total: "[number]"
        snapshot_id: "[uuid-pattern]"
        
  - name: "Least visited prioritization works"
    type: http
    service: api
    endpoint: /api/v1/prioritize/least-visited
    method: GET
    params:
      limit: 10
      include_unvisited: true
    expect:
      status: 200
      body:
        files: "[array]"
        coverage:
          visited: "[number]"
          unvisited: "[number]"
          percentage: "[number]"
          
  - name: "Most stale prioritization works"
    type: http
    service: api
    endpoint: /api/v1/prioritize/most-stale
    method: GET
    params:
      limit: 5
    expect:
      status: 200
      body:
        files: "[array-with-max-length-5]"
        average_staleness: "[number]"
        critical_count: "[number]"
        
  - name: "Coverage statistics work"
    type: http
    service: api
    endpoint: /api/v1/coverage
    method: GET
    expect:
      status: 200
      body:
        total_files: "[number]"
        visited_files: "[number]"
        unvisited_files: "[number]"
        coverage_percentage: "[number]"
        average_visits: "[number]"
        average_staleness: "[number]"
        
  - name: "CLI visit command executes"
    type: exec
    command: ./cli/visited-tracker visit test.js --context test
    expect:
      exit_code: 0
      output_contains: ["recorded", "test.js"]
      
  - name: "CLI status command works"
    type: exec
    command: ./cli/visited-tracker status --json
    expect:
      exit_code: 0
      output_contains: ["coverage", "total_files"]
      
  - name: "CLI least-visited command works"
    type: exec
    command: ./cli/visited-tracker least-visited --limit 5 --json
    expect:
      exit_code: 0
      output_contains: ["files"]
      
  - name: "CLI most-stale command works"
    type: exec
    command: ./cli/visited-tracker most-stale --limit 5 --json
    expect:
      exit_code: 0
      output_contains: ["files", "staleness"]
      
  - name: "CLI coverage command works"
    type: exec
    command: ./cli/visited-tracker coverage --json
    expect:
      exit_code: 0
      output_contains: ["total_files", "coverage_percentage"]
      
  - name: "CLI help command works"
    type: exec
    command: ./cli/visited-tracker help
    expect:
      exit_code: 0
      output_contains: ["Visited Tracker CLI", "visit", "sync", "least-visited", "most-stale", "coverage"]
      
  - name: "CLI version command works"
    type: exec
    command: ./cli/visited-tracker version
    expect:
      exit_code: 0
      output_contains: ["visited-tracker CLI v1.0.0"]
      
  - name: "Database schema is initialized"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_name IN ('tracked_files', 'visits', 'structure_snapshots')"
    expect:
      rows: 
        - count: 3
        
  - name: "Database indexes exist for performance"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM pg_indexes WHERE tablename IN ('tracked_files', 'visits')"
    expect:
      rows:
        - count: "[number >= 8]"
        
  - name: "UI server responds"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      content_contains: ["Visited Tracker"]
      
  - name: "UI config endpoint works"
    type: http
    service: ui
    endpoint: /config
    method: GET
    expect:
      status: 200
      body:
        service: visited-tracker
        version: "1.0.0"