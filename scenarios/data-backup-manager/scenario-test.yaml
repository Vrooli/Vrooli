version: 1.0
scenario: data-backup-manager

# Structure validation - files and directories that MUST exist:
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/data-backup-manager
    - cli/install.sh
    - initialization/postgres/schema.sql
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/n8n
    - initialization/postgres
    - data/backups

# Resource validation:
resources:
  required: [postgres, minio, n8n]
  optional: [redis]
  health_timeout: 60

# Declarative tests:
tests:
  # Resource health checks:
  - name: "PostgreSQL is accessible"
    type: http
    service: postgres
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "MinIO is accessible"
    type: http
    service: minio
    endpoint: /minio/health/live
    method: GET
    expect:
      status: 200
      
  # API endpoint tests:
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        
  - name: "Backup status endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/backup/status
    method: GET
    expect:
      status: 200
      body:
        system_status: ["healthy", "degraded", "critical"]
        
  # CLI command tests:
  - name: "CLI status command executes"
    type: exec
    command: ./cli/data-backup-manager status --json
    expect:
      exit_code: 0
      output_contains: ["system_status"]
      
  - name: "CLI backup command validation"
    type: exec
    command: ./cli/data-backup-manager backup --help
    expect:
      exit_code: 0
      output_contains: ["targets", "type", "retention"]
      
  # Database tests:
  - name: "Backup metadata schema exists"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) FROM information_schema.tables WHERE table_name IN ('backup_jobs', 'backup_schedules', 'restore_points')"
    expect:
      rows: 
        - count: 3
        
  # Functional tests:
  - name: "Create test backup"
    type: http
    service: api
    endpoint: /api/v1/backup/create
    method: POST
    body:
      type: "full"
      targets: ["test-data"]
      description: "Integration test backup"
    expect:
      status: 201
      body:
        job_id: "not_null"
        status: "pending"
        
  - name: "List available backups"
    type: http
    service: api
    endpoint: /api/v1/backup/list
    method: GET
    expect:
      status: 200
      
  - name: "Verify backup integrity"
    type: exec
    command: ./cli/data-backup-manager verify --target test-data --latest
    expect:
      exit_code: 0
      output_contains: ["verification", "passed"]

# Performance tests:
performance:
  - name: "Backup creation performance"
    type: http
    service: api
    endpoint: /api/v1/backup/create
    method: POST
    body:
      type: "incremental" 
      targets: ["small-test-data"]
    expect:
      response_time_ms: 1000
      
  - name: "Status endpoint performance"
    type: http
    service: api
    endpoint: /api/v1/backup/status
    method: GET
    expect:
      response_time_ms: 200