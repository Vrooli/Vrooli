{
  "name": "Backup Monitor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "cronExpression", "expression": "*/15 * * * *"}]
        }
      },
      "name": "Monitor Trigger",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT bj.*, bs.system_status FROM backup_jobs bj, backup_system_status bs WHERE bj.status IN ('running', 'pending') AND bj.started_at < CURRENT_TIMESTAMP - INTERVAL '2 hours' ORDER BY bj.started_at",
        "additionalFields": {}
      },
      "name": "Check Stuck Jobs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [460, 200],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as failed_count FROM backup_jobs WHERE status = 'failed' AND started_at > CURRENT_TIMESTAMP - INTERVAL '24 hours'",
        "additionalFields": {}
      },
      "name": "Check Failed Jobs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [460, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT SUM(size_bytes) as total_size FROM backup_jobs WHERE status = 'completed' AND retention_until > CURRENT_TIMESTAMP",
        "additionalFields": {}
      },
      "name": "Check Storage Usage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [460, 600],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Process monitoring results\nconst stuckJobs = $input.first().json || [];\nconst failedJobsResult = $input.all().find(item => item.json.failed_count !== undefined);\nconst storageResult = $input.all().find(item => item.json.total_size !== undefined);\n\nconst failedCount = failedJobsResult ? failedJobsResult.json.failed_count : 0;\nconst totalStorageBytes = storageResult ? (storageResult.json.total_size || 0) : 0;\nconst totalStorageGB = Math.round(totalStorageBytes / 1024 / 1024 / 1024 * 100) / 100;\n\nconst alerts = [];\nconst warnings = [];\nconst info = [];\n\n// Check for stuck jobs\nif (Array.isArray(stuckJobs) && stuckJobs.length > 0) {\n  for (const job of stuckJobs) {\n    alerts.push({\n      type: 'stuck_job',\n      severity: 'high',\n      message: `Backup job ${job.id} has been running for over 2 hours`,\n      job_id: job.id,\n      started_at: job.started_at,\n      recommendation: 'Investigate job status and consider manual intervention'\n    });\n  }\n} else if (stuckJobs.length === 0) {\n  info.push({\n    type: 'job_health',\n    message: 'No stuck backup jobs detected'\n  });\n}\n\n// Check failure rate\nif (failedCount > 5) {\n  alerts.push({\n    type: 'high_failure_rate',\n    severity: 'high',\n    message: `${failedCount} backup jobs failed in the last 24 hours`,\n    failed_count: failedCount,\n    recommendation: 'Check system resources and backup configuration'\n  });\n} else if (failedCount > 2) {\n  warnings.push({\n    type: 'moderate_failure_rate',\n    severity: 'medium',\n    message: `${failedCount} backup jobs failed in the last 24 hours`,\n    failed_count: failedCount,\n    recommendation: 'Monitor backup jobs more closely'\n  });\n} else {\n  info.push({\n    type: 'backup_health',\n    message: `Low failure rate: ${failedCount} failures in 24h`\n  });\n}\n\n// Check storage usage\nconst storageWarningGB = 80; // GB\nconst storageAlertGB = 95;   // GB\n\nif (totalStorageGB > storageAlertGB) {\n  alerts.push({\n    type: 'storage_critical',\n    severity: 'high',\n    message: `Backup storage usage is critical: ${totalStorageGB}GB`,\n    storage_gb: totalStorageGB,\n    recommendation: 'Clean up old backups immediately or add storage capacity'\n  });\n} else if (totalStorageGB > storageWarningGB) {\n  warnings.push({\n    type: 'storage_warning',\n    severity: 'medium',\n    message: `Backup storage usage is high: ${totalStorageGB}GB`,\n    storage_gb: totalStorageGB,\n    recommendation: 'Consider cleaning up old backups or adding storage capacity'\n  });\n} else {\n  info.push({\n    type: 'storage_health',\n    message: `Storage usage normal: ${totalStorageGB}GB`\n  });\n}\n\n// Determine overall system status\nlet systemStatus = 'healthy';\nif (alerts.length > 0) {\n  systemStatus = 'critical';\n} else if (warnings.length > 0) {\n  systemStatus = 'degraded';\n}\n\nreturn [{\n  json: {\n    system_status: systemStatus,\n    monitoring_timestamp: new Date().toISOString(),\n    alerts: alerts,\n    warnings: warnings,\n    info: info,\n    metrics: {\n      stuck_jobs: Array.isArray(stuckJobs) ? stuckJobs.length : 0,\n      failed_jobs_24h: failedCount,\n      storage_usage_gb: totalStorageGB\n    }\n  }\n}];"
      },
      "name": "Process Monitoring",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.system_status}}",
              "operation": "notEqual",
              "value2": "healthy"
            }
          ]
        }
      },
      "name": "Check Issues",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "functionCode": "// Handle alerts and warnings\nconst systemStatus = $json.system_status;\nconst alerts = $json.alerts || [];\nconst warnings = $json.warnings || [];\nconst metrics = $json.metrics || {};\n\nconst notifications = [];\n\n// Process high-priority alerts\nfor (const alert of alerts) {\n  notifications.push({\n    type: 'alert',\n    severity: alert.severity,\n    title: `Backup System Alert: ${alert.type.replace('_', ' ').toUpperCase()}`,\n    message: alert.message,\n    recommendation: alert.recommendation,\n    metadata: alert\n  });\n  \n  // Log to console for immediate visibility\n  console.error(`BACKUP ALERT [${alert.severity.toUpperCase()}]: ${alert.message}`);\n  if (alert.recommendation) {\n    console.error(`RECOMMENDATION: ${alert.recommendation}`);\n  }\n}\n\n// Process warnings\nfor (const warning of warnings) {\n  notifications.push({\n    type: 'warning',\n    severity: warning.severity,\n    title: `Backup System Warning: ${warning.type.replace('_', ' ').toUpperCase()}`,\n    message: warning.message,\n    recommendation: warning.recommendation,\n    metadata: warning\n  });\n  \n  console.warn(`BACKUP WARNING [${warning.severity.toUpperCase()}]: ${warning.message}`);\n}\n\n// Auto-remediation for stuck jobs\nconst stuckJobAlerts = alerts.filter(a => a.type === 'stuck_job');\nconst autoRemediationActions = [];\n\nfor (const stuckAlert of stuckJobAlerts) {\n  // Mark stuck jobs as failed after investigation timeout\n  autoRemediationActions.push({\n    action: 'mark_job_failed',\n    job_id: stuckAlert.job_id,\n    reason: 'Job stuck for over 2 hours - marked as failed automatically'\n  });\n}\n\nreturn [{\n  json: {\n    system_status: systemStatus,\n    notifications: notifications,\n    auto_remediation: autoRemediationActions,\n    metrics: metrics,\n    processed_at: new Date().toISOString()\n  }\n}];"
      },
      "name": "Handle Issues",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "functionCode": "// Execute auto-remediation actions\nconst actions = $json.auto_remediation || [];\nconst executedActions = [];\n\nfor (const action of actions) {\n  try {\n    if (action.action === 'mark_job_failed') {\n      // This would be handled by a database update in the next node\n      executedActions.push({\n        ...action,\n        status: 'pending_db_update',\n        executed_at: new Date().toISOString()\n      });\n      \n      console.log(`Auto-remediation: Marking job ${action.job_id} as failed`);\n    }\n  } catch (error) {\n    executedActions.push({\n      ...action,\n      status: 'failed',\n      error: error.message,\n      executed_at: new Date().toISOString()\n    });\n    \n    console.error(`Auto-remediation failed for ${action.action}:`, error);\n  }\n}\n\nreturn executedActions.map(action => ({ json: action }));"
      },
      "name": "Auto Remediation",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "operation": "update",
        "table": "backup_jobs",
        "updateKey": "id",
        "columns": "status,completed_at,error_message",
        "additionalFields": {},
        "options": {}
      },
      "name": "Update Stuck Jobs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1560, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-main",
          "name": "PostgreSQL Main"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/notification/send",
        "sendHeaders": true,\n        "headerParameters": {\n          "parameters": [\n            {\n              "name": "Content-Type",\n              "value": "application/json"\n            }\n          ]\n        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "notifications",
              "value": "={{JSON.stringify($json.notifications)}}"
            },
            {
              "name": "source",
              "value": "backup-monitor"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "name": "Send Notifications",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1120, 500]
    },
    {
      "parameters": {
        "functionCode": "// Log monitoring summary\nconst systemStatus = $json.system_status;\nconst alerts = $json.alerts || [];\nconst warnings = $json.warnings || [];\nconst info = $json.info || [];\nconst metrics = $json.metrics || {};\n\nconsole.log(`=== Backup System Monitor Summary ===`);\nconsole.log(`Status: ${systemStatus.toUpperCase()}`);\nconsole.log(`Timestamp: ${$json.monitoring_timestamp}`);\nconsole.log(`Metrics:`);\nconsole.log(`  - Stuck Jobs: ${metrics.stuck_jobs}`);\nconsole.log(`  - Failed Jobs (24h): ${metrics.failed_jobs_24h}`);\nconsole.log(`  - Storage Usage: ${metrics.storage_usage_gb}GB`);\n\nif (alerts.length > 0) {\n  console.log(`Alerts (${alerts.length}):`);\n  alerts.forEach((alert, i) => {\n    console.log(`  ${i+1}. [${alert.severity.toUpperCase()}] ${alert.message}`);\n  });\n}\n\nif (warnings.length > 0) {\n  console.log(`Warnings (${warnings.length}):`);\n  warnings.forEach((warning, i) => {\n    console.log(`  ${i+1}. [${warning.severity.toUpperCase()}] ${warning.message}`);\n  });\n}\n\nconsole.log(`======================================`);\n\nreturn [{ json: $json }];"
      },
      "name": "Log Summary",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 600]
    }
  ],
  "connections": {
    "Monitor Trigger": {
      "main": [
        [
          {"node": "Check Stuck Jobs", "type": "main", "index": 0},
          {"node": "Check Failed Jobs", "type": "main", "index": 0},
          {"node": "Check Storage Usage", "type": "main", "index": 0}
        ]
      ]
    },
    "Check Stuck Jobs": {
      "main": [[{"node": "Process Monitoring", "type": "main", "index": 0}]]
    },
    "Check Failed Jobs": {
      "main": [[{"node": "Process Monitoring", "type": "main", "index": 0}]]
    },
    "Check Storage Usage": {
      "main": [[{"node": "Process Monitoring", "type": "main", "index": 0}]]
    },
    "Process Monitoring": {
      "main": [
        [{"node": "Check Issues", "type": "main", "index": 0}],
        [{"node": "Log Summary", "type": "main", "index": 0}]
      ]
    },
    "Check Issues": {
      "main": [
        [],
        [
          {"node": "Handle Issues", "type": "main", "index": 0},
          {"node": "Send Notifications", "type": "main", "index": 0}
        ]
      ]
    },
    "Handle Issues": {
      "main": [[{"node": "Auto Remediation", "type": "main", "index": 0}]]
    },
    "Auto Remediation": {
      "main": [[{"node": "Update Stuck Jobs", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "saveManualExecutions": true
  },
  "id": "backup-monitor"
}