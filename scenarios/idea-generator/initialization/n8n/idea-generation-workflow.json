{
  "name": "Enhanced Idea Generation Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-ideas",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 150]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "campaign_id",
              "value": "test-campaign-123"
            },
            {
              "name": "prompt",
              "value": "Generate innovative marketing ideas"
            },
            {
              "name": "count",
              "value": "3"
            }
          ]
        },
        "options": {}
      },
      "id": "manual_defaults",
      "name": "Manual Test Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [450, 150]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT c.*, u.username FROM campaigns c LEFT JOIN users u ON c.owner_id = u.id WHERE c.id = '{{ $json.campaign_id }}'",
        "additionalFields": {}
      },
      "id": "get_campaign",
      "name": "Get Campaign Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery", 
        "query": "SELECT d.original_name, d.extracted_text FROM documents d WHERE d.campaign_id = '{{ $json.campaign_id }}' AND d.processing_status = 'completed' ORDER BY d.created_at DESC LIMIT 5",
        "additionalFields": {}
      },
      "id": "get_documents",
      "name": "Get Campaign Documents",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [650, 450]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT title, content, category FROM ideas WHERE campaign_id = '{{ $json.campaign_id }}' AND status IN ('refined', 'finalized') ORDER BY created_at DESC LIMIT 3",
        "additionalFields": {}
      },
      "id": "get_existing_ideas",
      "name": "Get Recent Ideas",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [650, 600]
    },
    {
      "parameters": {
        "functionCode": "// Build enriched context for idea generation\nconst campaign = $node['Get Campaign Data'].json;\nconst documents = $node['Get Campaign Documents'].json || [];\nconst existingIdeas = $node['Get Recent Ideas'].json || [];\nconst requestData = $input.item.json;\n\n// Extract document context\nconst documentContext = documents.map(doc => \n  `Document: ${doc.original_name}\\nContent Preview: ${doc.extracted_text?.substring(0, 500) || 'No text extracted'}...`\n).join('\\n\\n');\n\n// Extract existing ideas context\nconst existingContext = existingIdeas.map(idea => \n  `Previous Idea: ${idea.title}\\nCategory: ${idea.category}\\nBrief: ${idea.content?.substring(0, 200)}...`\n).join('\\n\\n');\n\n// Build comprehensive prompt\nconst enrichedPrompt = `\nCampaign Context:\nName: ${campaign.name}\nDescription: ${campaign.description}\nObjective: ${JSON.stringify(campaign.context)}\n\n${documentContext ? 'Supporting Documents:\\n' + documentContext + '\\n' : ''}\n\n${existingContext ? 'Recent Ideas for Reference (avoid duplication):\\n' + existingContext + '\\n' : ''}\n\nUser Request: ${requestData.prompt || 'Generate innovative ideas for this campaign'}\n\nGenerate ${requestData.count || 1} innovative, actionable ideas that:\n1. Align with the campaign context and objectives\n2. ${documentContext ? 'Leverage insights from the provided documents' : 'Build on available context'}\n3. Are distinct from existing ideas\n4. Include practical implementation considerations\n\nReturn as JSON array with format: [{\"title\": \"...\", \"description\": \"...\", \"category\": \"...\", \"tags\": [\"...\"], \"implementation_notes\": \"...\"}]\n`;\n\nreturn { \n  enriched_prompt: enrichedPrompt,\n  campaign_id: requestData.campaign_id,\n  user_request: requestData.prompt,\n  count: requestData.count || 1,\n  has_documents: documents.length > 0,\n  has_existing_ideas: existingIdeas.length > 0\n};"
      },
      "id": "build_context",
      "name": "Build Generation Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL }}/webhook/ollama",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "{\n  \"prompt\": \"{{ $json.enriched_prompt }}\",\n  \"model\": \"llama3.2:3b\",\n  \"type\": \"reasoning\",\n  \"quiet\": true,\n  \"timeout_seconds\": 120\n}",
        "options": {}
      },
      "id": "generate_ideas",
      "name": "Generate Ideas via Shared Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "functionCode": "const responseData = $input.item.json;\nconst response = responseData.response || responseData.output || responseData.content;\nconst contextData = $node['Build Generation Context'].json;\n\ntry {\n  const ideas = JSON.parse(response);\n  \n  return ideas.map(idea => ({\n    campaign_id: contextData.campaign_id,\n    title: idea.title,\n    content: idea.description,\n    category: idea.category || 'general',\n    tags: Array.isArray(idea.tags) ? idea.tags : [],\n    metadata: {\n      implementation_notes: idea.implementation_notes,\n      generation_context: {\n        has_documents: contextData.has_documents,\n        has_existing_ideas: contextData.has_existing_ideas,\n        user_request: contextData.user_request\n      }\n    },\n    generation_prompt: contextData.user_request,\n    generation_model: 'llama3.2',\n    status: 'draft',\n    created_by: null\n  }));\n} catch (error) {\n  // Fallback for malformed JSON\n  return [{\n    campaign_id: contextData.campaign_id,\n    title: 'AI Generated Idea',\n    content: response,\n    category: 'general',\n    tags: ['ai-generated'],\n    metadata: { generation_error: 'JSON parse failed' },\n    generation_prompt: contextData.user_request,\n    generation_model: 'llama3.2',\n    status: 'draft',\n    created_by: null\n  }];\n}"
      },
      "id": "process_ideas",
      "name": "Process Generated Ideas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL }}/webhook/embedding-generator",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "{\n  \"text\": \"{{ $json.title }} {{ $json.content }}\",\n  \"model\": \"nomic-embed-text\",\n  \"collection\": \"ideas\"\n}",
        "options": {}
      },
      "id": "generate_embeddings",
      "name": "Generate Embeddings via Shared Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "functionCode": "const ideaData = $node['Process Generated Ideas'].json;\nconst embeddingData = $input.item.json;\nconst embedding = embeddingData.embedding || embeddingData.embeddings || embeddingData.vector;\n\nreturn {\n  ...ideaData,\n  embedding: embedding\n};"
      },
      "id": "merge_embeddings",
      "name": "Merge Embeddings",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "ideas",
        "columns": "campaign_id,title,content,category,tags,metadata,generation_prompt,generation_model,status,embedding,created_by",
        "returnFields": "*"
      },
      "id": "save_ideas",
      "name": "Save Ideas to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:6333/collections/ideas/points",
        "authentication": "none",
        "requestMethod": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "{\n  \"points\": [\n    {\n      \"id\": \"{{ $json.id }}\",\n      \"vector\": {{ JSON.stringify($json.embedding) }},\n      \"payload\": {\n        \"idea_id\": \"{{ $json.id }}\",\n        \"campaign_id\": \"{{ $json.campaign_id }}\",\n        \"title\": \"{{ $json.title }}\",\n        \"content\": \"{{ $json.content }}\",\n        \"category\": \"{{ $json.category }}\",\n        \"tags\": {{ JSON.stringify($json.tags) }},\n        \"status\": \"{{ $json.status }}\",\n        \"created_at\": \"{{ $json.created_at }}\"\n      }\n    }\n  ]\n}"
      },
      "id": "save_to_qdrant",
      "name": "Save to Vector Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "ideas_generated",
              "value": "={{ $node['Save Ideas to Database'].json.length || 1 }}"
            },
            {
              "name": "ideas",
              "value": "={{ JSON.stringify($node['Save Ideas to Database'].json) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "response",
      "name": "Send Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [2250, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {"node": "get_campaign", "type": "main", "index": 0},
          {"node": "get_documents", "type": "main", "index": 0},
          {"node": "get_existing_ideas", "type": "main", "index": 0}
        ]
      ]
    },
    "manual_trigger": {
      "main": [[{"node": "manual_defaults", "type": "main", "index": 0}]]
    },
    "manual_defaults": {
      "main": [
        [
          {"node": "get_campaign", "type": "main", "index": 0},
          {"node": "get_documents", "type": "main", "index": 0},
          {"node": "get_existing_ideas", "type": "main", "index": 0}
        ]
      ]
    },
    "get_campaign": {
      "main": [[{"node": "build_context", "type": "main", "index": 0}]]
    },
    "get_documents": {
      "main": [[{"node": "build_context", "type": "main", "index": 1}]]
    },
    "get_existing_ideas": {
      "main": [[{"node": "build_context", "type": "main", "index": 2}]]
    },
    "build_context": {
      "main": [[{"node": "generate_ideas", "type": "main", "index": 0}]]
    },
    "generate_ideas": {
      "main": [[{"node": "process_ideas", "type": "main", "index": 0}]]
    },
    "process_ideas": {
      "main": [[{"node": "generate_embeddings", "type": "main", "index": 0}]]
    },
    "generate_embeddings": {
      "main": [[{"node": "merge_embeddings", "type": "main", "index": 0}]]
    },
    "merge_embeddings": {
      "main": [[{"node": "save_ideas", "type": "main", "index": 0}]]
    },
    "save_ideas": {
      "main": [[{"node": "save_to_qdrant", "type": "main", "index": 0}]]
    },
    "save_to_qdrant": {
      "main": [[{"node": "response", "type": "main", "index": 0}]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "idea-generation-workflow"
}