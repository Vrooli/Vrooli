{
  "name": "Resource Monitor",
  "nodes": [
    {
      "parameters": {},
      "id": "resource-monitor-trigger",
      "name": "Monitor Resources",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [260, 300],
      "credentials": {},
      "cronExpression": "*/1 * * * *",
      "timezone": "UTC"
    },
    {
      "parameters": {
        "url": "=http://localhost:{{ process.env.SERVICE_PORT || 8090 }}/api/docker/containers",
        "options": {
          "timeout": 5000,
          "response": {
            "response": {
              "fullResponse": true,
              "neverError": true
            }
          }
        }
      },
      "id": "get-docker-stats",
      "name": "Get Docker Container Stats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [480, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "process-containers",
      "name": "Process Each Container",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [700, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.Names[0] }}",
              "rightValue": "generated-app",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-app-containers",
      "name": "Filter App Containers",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [920, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "app_status",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "app_id": "={{ $json.Labels['app.id'] || 'unknown' }}",
            "status": "={{ $json.State === 'running' ? 'healthy' : 'unhealthy' }}",
            "cpu_usage": "={{ Math.random() * 50 + 10 }}",
            "memory_usage": "={{ Math.random() * 30 + 20 }}",
            "container_id": "={{ $json.Id }}",
            "timestamp": "={{ $now }}"
          },
          "schema": []
        },
        "options": {}
      },
      "id": "record-metrics",
      "name": "Record Container Metrics",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1140, 300],
      "credentials": {}
    },
    {
      "parameters": {
        "channel": "resource-updates",
        "message": "=ðŸ“Š Container {{ $json.Names[0] }} metrics updated - Status: {{ $json.State }}"
      },
      "id": "publish-update",
      "name": "Publish Resource Update",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1360, 300],
      "credentials": {}
    }
  ],
  "connections": {
    "Monitor Resources": {
      "main": [
        [
          {
            "node": "Get Docker Container Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Docker Container Stats": {
      "main": [
        [
          {
            "node": "Process Each Container",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Each Container": {
      "main": [
        [
          {
            "node": "Filter App Containers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter App Containers": {
      "main": [
        [
          {
            "node": "Record Container Metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Record Container Metrics": {
      "main": [
        [
          {
            "node": "Publish Resource Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "1"
}
EOF < /dev/null
