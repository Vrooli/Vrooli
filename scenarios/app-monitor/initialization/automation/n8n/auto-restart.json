{
  "name": "App Auto-Restart",
  "nodes": [
    {
      "parameters": {},
      "id": "auto-restart-trigger",
      "name": "Check for Failed Apps",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        260,
        300
      ],
      "credentials": {},
      "cronExpression": "*/5 * * * *",
      "timezone": "UTC"
    },
    {
      "parameters": {
        "operation": "select",
        "table": "apps",
        "where": {
          "conditions": [
            {
              "column": "status",
              "value": "failed"
            }
          ]
        },
        "options": {}
      },
      "id": "get-failed-apps",
      "name": "Get Failed Apps",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        480,
        300
      ],
      "credentials": {}
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "process-failed-apps",
      "name": "Process Each Failed App",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.config.auto_restart }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-auto-restart",
      "name": "Check Auto-Restart Enabled",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        920,
        300
      ]
    },
    {
      "parameters": {
        "url": "=http://localhost:{{ process.env.API_PORT || 8090 }}/api/apps/{{ $json.id }}/start",
        "options": {
          "timeout": 10000,
          "response": {
            "response": {
              "fullResponse": true,
              "neverError": true
            }
          }
        },
        "method": "POST"
      },
      "id": "restart-app",
      "name": "Restart App",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1140,
        300
      ]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "app_logs",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "app_id": "={{ $('Process Each Failed App').item.json.id }}",
            "level": "info",
            "message": "=Auto-restart attempted for app {{ $('Process Each Failed App').item.json.name }}",
            "source": "auto-restart",
            "timestamp": "={{ $now }}"
          },
          "schema": []
        },
        "options": {}
      },
      "id": "log-restart-attempt",
      "name": "Log Restart Attempt",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1360,
        300
      ],
      "credentials": {}
    }
  ],
  "connections": {
    "Check for Failed Apps": {
      "main": [
        [
          {
            "node": "Get Failed Apps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Failed Apps": {
      "main": [
        [
          {
            "node": "Process Each Failed App",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Each Failed App": {
      "main": [
        [
          {
            "node": "Check Auto-Restart Enabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Auto-Restart Enabled": {
      "main": [
        [
          {
            "node": "Restart App",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restart App": {
      "main": [
        [
          {
            "node": "Log Restart Attempt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "1"
}
EOF < /dev/null