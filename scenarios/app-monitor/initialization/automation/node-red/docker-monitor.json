[
  {
    "id": "docker-monitor-flow",
    "type": "tab",
    "label": "Docker App Monitor",
    "disabled": false
  },
  {
    "id": "docker-status-timer",
    "type": "inject",
    "z": "docker-monitor-flow",
    "name": "Poll Every 30s",
    "props": [{"p": "payload"}],
    "repeat": "30",
    "crontab": "",
    "once": true,
    "onceDelay": "1",
    "topic": "",
    "payload": "",
    "payloadType": "date"
  },
  {
    "id": "list-containers",
    "type": "http request",
    "z": "docker-monitor-flow",
    "name": "List Docker Containers",
    "method": "GET",
    "ret": "obj",
    "url": "http://localhost:{{env.get('SERVICE_PORT') || 8090}}/api/docker/containers",
    "tls": "",
    "persist": false,
    "proxy": "",
    "followRedirects": true,
    "headers": {}
  },
  {
    "id": "filter-app-containers",
    "type": "function",
    "z": "docker-monitor-flow",
    "name": "Filter Generated Apps",
    "func": "// Load configuration patterns from context or use defaults\nconst includePatterns = flow.get('discovery.patterns') || [\n    'scenario-',\n    'app-monitor-', \n    'system-monitor-',\n    'prompt-manager-',\n    'vrooli-'\n];\n\nconst excludePatterns = flow.get('discovery.excludePatterns') || [\n    'system-',\n    'temp-',\n    '-backup'\n];\n\n// Filter containers that match patterns\nconst apps = msg.payload.filter(container => {\n    const name = (container.Names[0] || '').replace('/', '');\n    \n    // Check exclude patterns first\n    for (const exclude of excludePatterns) {\n        if (name.includes(exclude)) {\n            return false;\n        }\n    }\n    \n    // Check include patterns\n    for (const include of includePatterns) {\n        if (name.includes(include)) {\n            return true;\n        }\n    }\n    \n    // Check for Vrooli labels\n    const labels = container.Labels || {};\n    if (labels['vrooli.managed'] === 'true' || labels['vrooli.scenario']) {\n        return true;\n    }\n    \n    return false;\n});\n\nmsg.payload = apps.map(container => ({\n    id: container.Id,\n    name: (container.Names[0] || '').replace('/', ''),\n    status: container.State,\n    created: container.Created,\n    ports: container.Ports,\n    image: container.Image,\n    labels: container.Labels\n}));\n\nnode.warn(`Found ${msg.payload.length} managed containers`);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": []
  },
  {
    "id": "store-status",
    "type": "function",
    "z": "docker-monitor-flow",
    "name": "Store in PostgreSQL",
    "func": "// Send status updates to App Monitor API instead of direct DB access\nconst apiBaseUrl = `http://localhost:${env.get('SERVICE_PORT') || 8090}`;\n\nfor (const app of msg.payload) {\n    const statusUpdate = {\n        url: `${apiBaseUrl}/api/apps/${app.name}/status`,\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        payload: {\n            status: app.status,\n            container_id: app.id,\n            timestamp: new Date().toISOString()\n        }\n    };\n    \n    // Send each update (Node-RED will handle async)\n    node.send({ ...statusUpdate, _msgid: msg._msgid + '_' + app.name });\n}\n\nreturn null;",
    "outputs": 1,
    "noerr": 0
  },
  {
    "id": "postgres-insert",
    "type": "postgresql",
    "z": "docker-monitor-flow",
    "name": "PostgreSQL",
    "query": "",
    "postgreSQLConfig": "",
    "split": false,
    "rowsPerMsg": 1
  },
  {
    "id": "health-check",
    "type": "http request",
    "z": "docker-monitor-flow",
    "name": "App Health Check",
    "method": "GET",
    "ret": "obj",
    "payloadType": "str",
    "url": "{{{payload.healthUrl}}}",
    "tls": "",
    "persist": false,
    "proxy": "",
    "followRedirects": true,
    "timeout": "5"
  },
  {
    "id": "restart-unhealthy",
    "type": "http request",
    "z": "docker-monitor-flow",
    "name": "Restart Container",
    "method": "POST",
    "ret": "obj",
    "url": "http://localhost:{{env.get('SERVICE_PORT') || 8090}}/api/apps/{{{payload.appId}}}/start",
    "tls": "",
    "persist": false
  },
  {
    "id": "websocket-broadcast",
    "type": "websocket out",
    "z": "docker-monitor-flow",
    "name": "Broadcast Status",
    "server": "",
    "client": "",
    "x": 800,
    "y": 300
  }
]