{
  "name": "Fact Checker Enhanced",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fact-checker-enhanced",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide default article for testing\nreturn {\n  article_id: 'test_article_' + Date.now(),\n  title: 'US Unemployment Rate Hits Historic Low',\n  summary: 'The US unemployment rate dropped to 3.4%, the lowest since 1969. Job growth exceeded 500,000 in the last month.',\n  claims: [\n    'The US unemployment rate dropped to 3.4%, the lowest since 1969',\n    'Job growth exceeded 500,000 in the last month',\n    'Wages increased by 5% year-over-year'\n  ],\n  source: 'Test News Source',\n  url: 'https://example.com/article',\n  published_date: new Date().toISOString()\n};"
      },
      "id": "set_defaults",
      "name": "Set Default Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract and prepare claims for fact-checking\nconst article = $input.item.json;\n\n// Extract claims from article\nlet claims = article.claims || [];\n\n// If no explicit claims, extract them from title and summary\nif (claims.length === 0) {\n  const text = `${article.title || ''} ${article.summary || ''}`;\n  \n  // Pattern-based claim extraction\n  const patterns = [\n    /\\d+\\.?\\d*%[^,\\.]*[,\\.]?/g,  // Percentages with context\n    /\\$?\\d+\\.?\\d*\\s*(billion|million|thousand)[^,\\.]*[,\\.]?/gi,  // Money amounts\n    /\\d{4}\\s+[^,\\.]+[,\\.]?/g,  // Years with context\n    /\"[^\"]+\"/g,  // Quoted statements\n    /[A-Z][^.!?]*\\s+(increased|decreased|rose|fell|dropped|jumped)\\s+[^.!?]*/g  // Trend statements\n  ];\n  \n  const extractedClaims = new Set();\n  patterns.forEach(pattern => {\n    const matches = text.match(pattern);\n    if (matches) {\n      matches.forEach(match => {\n        const cleaned = match.trim().replace(/[,\\.]$/, '');\n        if (cleaned.length > 10 && cleaned.length < 200) {\n          extractedClaims.add(cleaned);\n        }\n      });\n    }\n  });\n  \n  claims = Array.from(extractedClaims).slice(0, 5);\n  \n  // If still no claims, use the title\n  if (claims.length === 0 && article.title) {\n    claims = [article.title];\n  }\n}\n\n// Prepare structured output for research\nreturn {\n  article_id: article.article_id || article.id,\n  title: article.title,\n  source: article.source,\n  url: article.url,\n  claims: claims,\n  claim_count: claims.length,\n  published_date: article.published_date || new Date().toISOString(),\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "extract_claims",
      "name": "Extract Claims",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process each claim individually for fact-checking\nconst data = $input.item.json;\nconst results = [];\n\n// Process each claim\nfor (const claim of data.claims) {\n  results.push({\n    article_id: data.article_id,\n    title: data.title,\n    source: data.source,\n    claim: claim,\n    claim_index: data.claims.indexOf(claim),\n    total_claims: data.claim_count,\n    published_date: data.published_date\n  });\n}\n\nreturn results;"
      },
      "id": "split_claims",
      "name": "Split Claims",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/web-research-aggregator",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "{\n  \"query\": \"fact check {{ $json.claim }}\",\n  \"config\": {\n    \"search_engines\": [\"google\", \"news\"],\n    \"max_results_per_engine\": 5,\n    \"extraction_mode\": \"smart\",\n    \"synthesis_length\": \"summary\",\n    \"include_academic\": false,\n    \"extract_quotes\": true,\n    \"time_limit\": 120\n  }\n}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "research_claim",
      "name": "Research Claim",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/ollama",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "{\n  \"prompt\": \"You are a professional fact-checker. Analyze this claim and the research findings to determine its accuracy.\\n\\nClaim: {{ $('split_claims').item.json.claim }}\\nSource: {{ $('split_claims').item.json.source }}\\nPublished: {{ $('split_claims').item.json.published_date }}\\n\\nResearch Findings:\\n{{ $json.synthesis }}\\n\\nProvide a fact-check assessment in JSON format:\\n{\\n  \\\"verdict\\\": \\\"true/false/partially_true/unverifiable\\\",\\n  \\\"confidence\\\": 0-100,\\n  \\\"explanation\\\": \\\"brief explanation\\\",\\n  \\\"supporting_sources\\\": [\\\"source1\\\", \\\"source2\\\"],\\n  \\\"contradicting_sources\\\": [\\\"source1\\\", \\\"source2\\\"],\\n  \\\"context\\\": \\\"important context or nuance\\\"\\n}\\n\\nBe objective and base your assessment on the evidence found.\",\n  \"model\": \"llama3.2:3b\",\n  \"type\": \"analysis\",\n  \"quiet\": true,\n  \"timeout_seconds\": 45\n}",
        "options": {
          "timeout": 45000
        }
      },
      "id": "analyze_verification",
      "name": "Analyze Verification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Parse and structure fact-check results\nconst claimData = $('split_claims').item.json;\nconst research = $('research_claim').item.json;\nconst analysis = $json;\n\nlet factCheck;\ntry {\n  // Try to parse the analysis response\n  factCheck = typeof analysis.response === 'string' ? \n    JSON.parse(analysis.response) : analysis.response;\n} catch (e) {\n  // Fallback if parsing fails\n  factCheck = {\n    verdict: 'unverifiable',\n    confidence: 0,\n    explanation: 'Could not parse fact-check results',\n    supporting_sources: [],\n    contradicting_sources: [],\n    context: ''\n  };\n}\n\n// Calculate verification score\nlet verificationScore = 0;\nswitch(factCheck.verdict) {\n  case 'true':\n    verificationScore = 100;\n    break;\n  case 'partially_true':\n    verificationScore = 50;\n    break;\n  case 'false':\n    verificationScore = 0;\n    break;\n  default:\n    verificationScore = -1; // Unverifiable\n}\n\nreturn {\n  article_id: claimData.article_id,\n  claim_index: claimData.claim_index,\n  claim: claimData.claim,\n  verdict: factCheck.verdict,\n  confidence: factCheck.confidence || 0,\n  verification_score: verificationScore,\n  explanation: factCheck.explanation,\n  supporting_sources: factCheck.supporting_sources || [],\n  contradicting_sources: factCheck.contradicting_sources || [],\n  context: factCheck.context || '',\n  research_summary: research.synthesis || '',\n  sources_analyzed: research.sources?.length || 0,\n  fact_checked_at: new Date().toISOString()\n};"
      },
      "id": "structure_results",
      "name": "Structure Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Aggregate all fact-check results for the article\nconst allResults = $input.all();\nconst firstItem = allResults[0].json;\n\n// Group results by article\nconst articleResults = {};\nallResults.forEach(item => {\n  const data = item.json;\n  if (!articleResults[data.article_id]) {\n    articleResults[data.article_id] = {\n      article_id: data.article_id,\n      claims_checked: [],\n      total_claims: 0,\n      verified_claims: 0,\n      false_claims: 0,\n      partially_true_claims: 0,\n      unverifiable_claims: 0,\n      overall_credibility_score: 0,\n      fact_checked_at: data.fact_checked_at\n    };\n  }\n  \n  articleResults[data.article_id].claims_checked.push({\n    claim: data.claim,\n    verdict: data.verdict,\n    confidence: data.confidence,\n    explanation: data.explanation,\n    supporting_sources: data.supporting_sources,\n    contradicting_sources: data.contradicting_sources\n  });\n  \n  articleResults[data.article_id].total_claims++;\n  \n  switch(data.verdict) {\n    case 'true':\n      articleResults[data.article_id].verified_claims++;\n      break;\n    case 'false':\n      articleResults[data.article_id].false_claims++;\n      break;\n    case 'partially_true':\n      articleResults[data.article_id].partially_true_claims++;\n      break;\n    default:\n      articleResults[data.article_id].unverifiable_claims++;\n  }\n});\n\n// Calculate overall credibility score\nconst results = Object.values(articleResults).map(article => {\n  const verifiedWeight = article.verified_claims * 100;\n  const partialWeight = article.partially_true_claims * 50;\n  const falseWeight = article.false_claims * 0;\n  const unverifiableWeight = article.unverifiable_claims * 25;\n  \n  const totalWeight = article.total_claims * 100;\n  article.overall_credibility_score = totalWeight > 0 ? \n    Math.round((verifiedWeight + partialWeight + falseWeight + unverifiableWeight) / article.total_claims) : 0;\n  \n  // Add credibility assessment\n  if (article.overall_credibility_score >= 80) {\n    article.credibility_assessment = 'High Credibility';\n  } else if (article.overall_credibility_score >= 60) {\n    article.credibility_assessment = 'Moderate Credibility';\n  } else if (article.overall_credibility_score >= 40) {\n    article.credibility_assessment = 'Low Credibility';\n  } else {\n    article.credibility_assessment = 'Very Low Credibility';\n  }\n  \n  return article;\n});\n\nreturn results;"
      },
      "id": "aggregate_results",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "respond_to_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1800, 300]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "extract_claims",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "set_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_defaults": {
      "main": [
        [
          {
            "node": "extract_claims",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extract_claims": {
      "main": [
        [
          {
            "node": "split_claims",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split_claims": {
      "main": [
        [
          {
            "node": "research_claim",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "research_claim": {
      "main": [
        [
          {
            "node": "analyze_verification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "analyze_verification": {
      "main": [
        [
          {
            "node": "structure_results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "structure_results": {
      "main": [
        [
          {
            "node": "aggregate_results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aggregate_results": {
      "main": [
        [
          {
            "node": "respond_to_webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "pinData": {},
  "versionId": "1.0.0",
  "triggerCount": 2
}