{
  "name": "Recurring Invoice Handler",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        }
      },
      "name": "Daily Schedule",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [200, 300],
      "id": "schedule_trigger"
    },
    {
      "parameters": {
        "path": "recurring-invoice",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 500],
      "webhookId": "recurring-invoice",
      "id": "webhook_trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM recurring_invoices WHERE \n  is_active = true AND \n  next_invoice_date <= CURRENT_DATE",
        "options": {}
      },
      "name": "Get Due Recurring Invoices",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [400, 400],
      "credentials": {
        "postgres": {
          "id": "postgres_invoice_generator",
          "name": "Invoice Generator DB"
        }
      },
      "id": "get_recurring"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "name": "Process Each Invoice",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [600, 400],
      "id": "split_batches"
    },
    {
      "parameters": {
        "jsCode": "// Generate new invoice from recurring template\nconst recurring = $input.first().json;\nconst today = new Date();\nconst dueDate = new Date(today);\ndueDate.setDate(dueDate.getDate() + (recurring.payment_terms_days || 30));\n\n// Calculate next invoice date based on frequency\nlet nextDate = new Date(recurring.next_invoice_date);\nswitch(recurring.frequency) {\n  case 'monthly':\n    nextDate.setMonth(nextDate.getMonth() + 1);\n    break;\n  case 'quarterly':\n    nextDate.setMonth(nextDate.getMonth() + 3);\n    break;\n  case 'yearly':\n    nextDate.setFullYear(nextDate.getFullYear() + 1);\n    break;\n  case 'weekly':\n    nextDate.setDate(nextDate.getDate() + 7);\n    break;\n  default:\n    nextDate.setMonth(nextDate.getMonth() + 1);\n}\n\n// Generate invoice number\nconst invoiceNumber = `INV-${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${Date.now().toString().slice(-6)}`;\n\nreturn {\n  recurring_id: recurring.id,\n  new_invoice: {\n    invoice_number: invoiceNumber,\n    client_name: recurring.client_name,\n    client_email: recurring.client_email,\n    client_address: recurring.client_address,\n    issue_date: today.toISOString().split('T')[0],\n    due_date: dueDate.toISOString().split('T')[0],\n    items: recurring.items,\n    currency: recurring.currency,\n    payment_terms: recurring.payment_terms,\n    notes: recurring.notes || `Recurring invoice - ${recurring.description}`,\n    recurring_invoice_id: recurring.id\n  },\n  next_invoice_date: nextDate.toISOString().split('T')[0]\n};"
      },
      "name": "Generate Invoice Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 400],
      "id": "generate_invoice"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/invoice-process",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "action",
              "value": "create"
            },
            {
              "name": "invoice",
              "value": "={{ $json.new_invoice }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "name": "Create Invoice",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1000, 400],
      "id": "create_invoice"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE recurring_invoices SET \n  next_invoice_date = '{{ $('Generate Invoice Data').first().json.next_invoice_date }}',\n  last_generated = NOW(),\n  updated_at = NOW()\nWHERE id = {{ $('Generate Invoice Data').first().json.recurring_id }}",
        "options": {}
      },
      "name": "Update Next Date",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1200, 400],
      "credentials": {
        "postgres": {
          "id": "postgres_invoice_generator",
          "name": "Invoice Generator DB"
        }
      },
      "id": "update_next_date"
    },
    {
      "parameters": {
        "jsCode": "// Log success\nconst invoice = $('Create Invoice').first().json;\nconst recurring = $('Generate Invoice Data').first().json;\n\nreturn {\n  success: true,\n  message: `Generated recurring invoice ${invoice.invoice.invoice_number}`,\n  recurring_id: recurring.recurring_id,\n  next_date: recurring.next_invoice_date,\n  invoice_created: invoice.invoice.invoice_number\n};"
      },
      "name": "Log Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 400],
      "id": "log_success"
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Continue Processing",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1600, 400],
      "id": "continue"
    }
  ],
  "connections": {
    "Daily Schedule": {
      "main": [
        [
          {
            "node": "Get Due Recurring Invoices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Get Due Recurring Invoices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Due Recurring Invoices": {
      "main": [
        [
          {
            "node": "Process Each Invoice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Each Invoice": {
      "main": [
        [
          {
            "node": "Generate Invoice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Invoice Data": {
      "main": [
        [
          {
            "node": "Create Invoice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Invoice": {
      "main": [
        [
          {
            "node": "Update Next Date",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Next Date": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        [
          {
            "node": "Process Each Invoice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "recurring-invoice-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "invoice-generator"
  },
  "id": "recurring-invoice-handler",
  "tags": []
}