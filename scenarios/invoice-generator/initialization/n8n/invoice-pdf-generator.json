{
  "name": "Invoice PDF Generator",
  "nodes": [
    {
      "parameters": {
        "path": "generate-invoice-pdf",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "generate-invoice-pdf",
      "id": "webhook_trigger"
    },
    {
      "parameters": {},
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500],
      "id": "manual_trigger"
    },
    {
      "parameters": {
        "jsCode": "// Test defaults for manual trigger\nreturn {\n  invoice: {\n    company_name: 'Your Company LLC',\n    company_address: '456 Main Street, Anytown, USA 12345',\n    company_email: 'info@yourcompany.com',\n    company_phone: '(555) 123-4567',\n    company_logo: '',\n    client_name: 'Sample Client Inc.',\n    client_email: 'client@example.com',\n    client_address: '789 Client Ave, Their City, ST 67890',\n    invoice_number: 'INV-' + Date.now(),\n    issue_date: new Date().toISOString().split('T')[0],\n    due_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],\n    items: [\n      {\n        description: 'Professional Services',\n        quantity: 10,\n        unit_price: 150.00,\n        tax_rate: 0.08\n      },\n      {\n        description: 'Additional Support',\n        quantity: 5,\n        unit_price: 100.00,\n        tax_rate: 0.08\n      }\n    ],\n    currency: 'USD',\n    payment_terms: 'Net 30',\n    notes: 'Thank you for your business!',\n    bank_details: 'Bank: Example Bank\\nAccount: 1234567890\\nRouting: 987654321'\n  },\n  format: 'pdf',\n  template: 'professional'\n};"
      },
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 500],
      "id": "set_defaults"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "trigger_check",
              "leftValue": "={{ $('Webhook Trigger').isExecuted }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "name": "Check Trigger Source",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [600, 400],
      "id": "check_trigger"
    },
    {
      "parameters": {
        "jsCode": "// Validate invoice data\nconst invoice = $input.item.json.invoice;\nconst errors = [];\n\n// Required fields\nif (!invoice?.client_name) errors.push('Client name is required');\nif (!invoice?.invoice_number) errors.push('Invoice number is required');\nif (!invoice?.items || invoice.items.length === 0) errors.push('At least one line item is required');\n\n// Validate items\nif (invoice?.items) {\n  invoice.items.forEach((item, index) => {\n    if (!item.description) errors.push(`Item ${index + 1}: Description is required`);\n    if (!item.quantity || item.quantity <= 0) errors.push(`Item ${index + 1}: Valid quantity is required`);\n    if (!item.unit_price || item.unit_price < 0) errors.push(`Item ${index + 1}: Valid unit price is required`);\n  });\n}\n\nif (errors.length > 0) {\n  throw new Error('Validation failed: ' + errors.join(', '));\n}\n\nreturn $input.item;"
      },
      "name": "Validate Invoice Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 400],
      "id": "validate_data"
    },
    {
      "parameters": {
        "jsCode": "// Calculate invoice totals\nconst invoice = $input.item.json.invoice;\nlet subtotal = 0;\nlet totalTax = 0;\n\n// Calculate line items\nconst calculatedItems = invoice.items.map(item => {\n  const lineTotal = item.quantity * item.unit_price;\n  const taxAmount = lineTotal * (item.tax_rate || 0);\n  subtotal += lineTotal;\n  totalTax += taxAmount;\n  \n  return {\n    ...item,\n    line_total: lineTotal.toFixed(2),\n    tax_amount: taxAmount.toFixed(2)\n  };\n});\n\nconst total = subtotal + totalTax;\n\nreturn {\n  ...invoice,\n  items: calculatedItems,\n  subtotal: subtotal.toFixed(2),\n  tax_total: totalTax.toFixed(2),\n  total: total.toFixed(2),\n  total_formatted: new Intl.NumberFormat('en-US', {\n    style: 'currency',\n    currency: invoice.currency || 'USD'\n  }).format(total)\n};"
      },
      "name": "Calculate Totals",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 400],
      "id": "calculate_totals"
    },
    {
      "parameters": {
        "jsCode": "// Generate HTML invoice template\nconst invoice = $input.item.json;\nconst template = $input.item.json.template || 'professional';\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; line-height: 1.6; }\n    .invoice-container { max-width: 800px; margin: 0 auto; padding: 40px; background: white; }\n    .header { display: flex; justify-content: space-between; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #4a90e2; }\n    .company-info h1 { color: #4a90e2; font-size: 32px; margin-bottom: 10px; }\n    .company-details { font-size: 14px; color: #666; }\n    .invoice-badge { background: #4a90e2; color: white; padding: 10px 20px; border-radius: 5px; text-align: center; }\n    .invoice-number { font-size: 20px; font-weight: bold; }\n    .billing-section { display: flex; justify-content: space-between; margin: 30px 0; }\n    .billing-block { flex: 1; }\n    .billing-block h3 { color: #4a90e2; margin-bottom: 10px; font-size: 16px; text-transform: uppercase; }\n    .billing-details { font-size: 14px; line-height: 1.8; }\n    .items-table { width: 100%; margin: 30px 0; border-collapse: collapse; }\n    .items-table th { background: #f5f5f5; padding: 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 2px solid #ddd; }\n    .items-table td { padding: 12px; border-bottom: 1px solid #eee; }\n    .items-table tr:hover { background: #fafafa; }\n    .totals-section { margin-left: auto; width: 300px; margin-top: 30px; }\n    .total-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }\n    .total-row.grand-total { font-size: 20px; font-weight: bold; color: #4a90e2; border-top: 2px solid #4a90e2; padding-top: 15px; margin-top: 10px; }\n    .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #eee; }\n    .notes { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }\n    .notes h4 { color: #666; margin-bottom: 5px; }\n    .payment-terms { font-size: 12px; color: #888; text-align: center; }\n    @media print { .invoice-container { padding: 20px; } }\n  </style>\n</head>\n<body>\n  <div class=\"invoice-container\">\n    <div class=\"header\">\n      <div class=\"company-info\">\n        <h1>${invoice.company_name || 'Your Company'}</h1>\n        <div class=\"company-details\">\n          ${invoice.company_address || ''}<br>\n          ${invoice.company_email || ''}<br>\n          ${invoice.company_phone || ''}\n        </div>\n      </div>\n      <div class=\"invoice-badge\">\n        <div>INVOICE</div>\n        <div class=\"invoice-number\">${invoice.invoice_number}</div>\n      </div>\n    </div>\n    \n    <div class=\"billing-section\">\n      <div class=\"billing-block\">\n        <h3>Bill To</h3>\n        <div class=\"billing-details\">\n          <strong>${invoice.client_name}</strong><br>\n          ${invoice.client_address || ''}<br>\n          ${invoice.client_email || ''}\n        </div>\n      </div>\n      <div class=\"billing-block\" style=\"text-align: right;\">\n        <h3>Invoice Details</h3>\n        <div class=\"billing-details\">\n          <strong>Issue Date:</strong> ${invoice.issue_date}<br>\n          <strong>Due Date:</strong> ${invoice.due_date}<br>\n          <strong>Terms:</strong> ${invoice.payment_terms || 'Due on receipt'}\n        </div>\n      </div>\n    </div>\n    \n    <table class=\"items-table\">\n      <thead>\n        <tr>\n          <th style=\"width: 50%;\">Description</th>\n          <th style=\"width: 15%; text-align: center;\">Quantity</th>\n          <th style=\"width: 15%; text-align: right;\">Unit Price</th>\n          <th style=\"width: 10%; text-align: right;\">Tax</th>\n          <th style=\"width: 10%; text-align: right;\">Total</th>\n        </tr>\n      </thead>\n      <tbody>\n        ${invoice.items.map(item => `\n          <tr>\n            <td>${item.description}</td>\n            <td style=\"text-align: center;\">${item.quantity}</td>\n            <td style=\"text-align: right;\">$${parseFloat(item.unit_price).toFixed(2)}</td>\n            <td style=\"text-align: right;\">${(item.tax_rate * 100).toFixed(0)}%</td>\n            <td style=\"text-align: right;\">$${item.line_total}</td>\n          </tr>\n        `).join('')}\n      </tbody>\n    </table>\n    \n    <div class=\"totals-section\">\n      <div class=\"total-row\">\n        <span>Subtotal:</span>\n        <span>$${invoice.subtotal}</span>\n      </div>\n      <div class=\"total-row\">\n        <span>Tax:</span>\n        <span>$${invoice.tax_total}</span>\n      </div>\n      <div class=\"total-row grand-total\">\n        <span>Total Due:</span>\n        <span>${invoice.total_formatted}</span>\n      </div>\n    </div>\n    \n    <div class=\"footer\">\n      ${invoice.notes ? `\n        <div class=\"notes\">\n          <h4>Notes</h4>\n          <p>${invoice.notes}</p>\n        </div>\n      ` : ''}\n      ${invoice.bank_details ? `\n        <div class=\"notes\">\n          <h4>Payment Information</h4>\n          <p>${invoice.bank_details.replace(/\\n/g, '<br>')}</p>\n        </div>\n      ` : ''}\n      <div class=\"payment-terms\">\n        <p>Thank you for your business!</p>\n      </div>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  html: html,\n  invoice: invoice,\n  format: $input.item.json.format || 'pdf'\n};"
      },
      "name": "Generate HTML Template",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 400],
      "id": "generate_html"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {
          "waitForSelector": ".invoice-container",
          "format": "A4",
          "margin": {
            "top": "20px",
            "right": "20px",
            "bottom": "20px",
            "left": "20px"
          }
        }
      },
      "name": "Convert to PDF",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [1400, 400],
      "id": "convert_pdf"
    },
    {
      "parameters": {
        "jsCode": "// Return the generated PDF data\nconst pdfData = $input.item.binary?.data;\nconst invoice = $input.item.json.invoice;\n\nif (!pdfData) {\n  throw new Error('PDF generation failed');\n}\n\nreturn {\n  success: true,\n  message: 'Invoice PDF generated successfully',\n  invoice_number: invoice.invoice_number,\n  filename: `invoice_${invoice.invoice_number}.pdf`,\n  pdf_base64: pdfData.data,\n  metadata: {\n    client: invoice.client_name,\n    total: invoice.total_formatted,\n    generated_at: new Date().toISOString()\n  }\n};"
      },
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 400],
      "id": "prepare_response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1800, 400],
      "id": "webhook_response"
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Check Trigger Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Test Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Test Defaults": {
      "main": [
        [
          {
            "node": "Check Trigger Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Trigger Source": {
      "main": [
        [
          {
            "node": "Validate Invoice Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validate Invoice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Invoice Data": {
      "main": [
        [
          {
            "node": "Calculate Totals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Totals": {
      "main": [
        [
          {
            "node": "Generate HTML Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Template": {
      "main": [
        [
          {
            "node": "Convert to PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to PDF": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "invoice-pdf-generator",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": []
}