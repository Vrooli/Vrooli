{
  "name": "Email Sender",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "email-sender"
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger", 
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 450]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "profile_id",
              "value": "00000000-0000-0000-0000-000000000001"
            },
            {
              "name": "contact_id",
              "value": "10000000-0000-0000-0000-000000000001"
            },
            {
              "name": "notification_id",
              "value": "test-notification-123"
            },
            {
              "name": "subject",
              "value": "Test Email"
            },
            {
              "name": "current_channel",
              "value": "email"
            }
          ],
          "object": [
            {
              "name": "channel_content",
              "value": {
                "html": "<h1>Test Email</h1><p>This is a test email from the notification hub.</p>",
                "text": "Test Email\n\nThis is a test email from the notification hub."
              }
            },
            {
              "name": "contact_info",
              "value": {
                "identifier": "demo@example.com",
                "first_name": "Demo", 
                "last_name": "User",
                "full_name": "Demo User"
              }
            }
          ]
        }
      },
      "id": "default-test-data",
      "name": "Default Test Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [400, 450]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "webhook-data-check",
              "leftValue": "={{ $('Webhook Trigger').item }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "data-source-check",
      "name": "Check Data Source",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [600, 375]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  pp.provider,\n  pp.config,\n  pp.priority,\n  pp.enabled,\n  cc.value as recipient_email\nFROM profile_providers pp\nJOIN contacts c ON c.profile_id = pp.profile_id\nJOIN contact_channels cc ON cc.contact_id = c.id\nWHERE pp.profile_id = '{{ $json.profile_id }}'\n  AND pp.channel = 'email'\n  AND pp.enabled = true\n  AND c.id = '{{ $json.contact_id }}'\n  AND cc.type = 'email'\n  AND cc.status = 'active'\nORDER BY pp.priority ASC\nLIMIT 1",
        "options": {}
      },
      "id": "get-email-provider",
      "name": "Get Email Provider",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [800, 375],
      "credentials": {
        "postgres": {
          "id": "postgres-notification-hub",
          "name": "PostgreSQL - Notification Hub"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.all()[0].json;\n\n// Parse provider config\nconst providerConfig = JSON.parse(data.config);\n\n// Prepare email data\nconst emailData = {\n  notification_id: data.notification_id,\n  provider: data.provider,\n  provider_config: providerConfig,\n  recipient_email: data.recipient_email,\n  subject: data.subject,\n  html_content: data.channel_content?.html || '',\n  text_content: data.channel_content?.text || '',\n  contact_info: data.contact_info,\n  profile_id: data.profile_id,\n  priority: data.priority || 'normal'\n};\n\n// Set from email and name from provider config or defaults\nemailData.from_email = providerConfig.from_email || 'noreply@vrooli.local';\nemailData.from_name = providerConfig.from_name || 'Vrooli Notifications';\n\n// Add delivery tracking\nemailData.delivery_id = `email-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\nreturn [{ json: emailData }];"
      },
      "id": "prepare-email-data",
      "name": "Prepare Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 375]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "sendgrid-check",
              "leftValue": "={{ $json.provider }}",
              "rightValue": "sendgrid",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "sendgrid-provider-check",
      "name": "SendGrid Provider",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1200, 275]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "smtp-check",
              "leftValue": "={{ $json.provider }}",
              "rightValue": "smtp",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "smtp-provider-check",
      "name": "SMTP Provider",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1200, 375]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "mock-check",
              "leftValue": "={{ $json.provider }}",
              "rightValue": "mock",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "mock-provider-check",
      "name": "Mock Provider",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1200, 475]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.sendgrid.com/v3/mail/send",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.provider_config.api_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"personalizations\": [{\n    \"to\": [{\n      \"email\": \"{{ $json.recipient_email }}\",\n      \"name\": \"{{ $json.contact_info.full_name }}\"\n    }],\n    \"subject\": \"{{ $json.subject }}\"\n  }],\n  \"from\": {\n    \"email\": \"{{ $json.from_email }}\",\n    \"name\": \"{{ $json.from_name }}\"\n  },\n  \"content\": [{\n    \"type\": \"text/plain\",\n    \"value\": \"{{ $json.text_content }}\"\n  }, {\n    \"type\": \"text/html\", \n    \"value\": \"{{ $json.html_content }}\"\n  }],\n  \"tracking_settings\": {\n    \"click_tracking\": { \"enable\": true },\n    \"open_tracking\": { \"enable\": true }\n  },\n  \"custom_args\": {\n    \"notification_id\": \"{{ $json.notification_id }}\",\n    \"delivery_id\": \"{{ $json.delivery_id }}\"\n  }\n}",
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxRetries": 3,
            "retryInterval": 5000
          }
        }
      },
      "id": "send-via-sendgrid",
      "name": "Send via SendGrid",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1400, 200]
    },
    {
      "parameters": {
        "host": "={{ $json.provider_config.host }}",
        "port": "={{ $json.provider_config.port }}",
        "secure": "={{ $json.provider_config.secure || false }}",
        "fromEmail": "={{ $json.from_email }}",
        "fromName": "={{ $json.from_name }}",
        "toEmail": "={{ $json.recipient_email }}",
        "subject": "={{ $json.subject }}",
        "text": "={{ $json.text_content }}",
        "html": "={{ $json.html_content }}",
        "options": {
          "auth": {
            "user": "={{ $json.provider_config.username }}",
            "pass": "={{ $json.provider_config.password }}"
          }
        }
      },
      "id": "send-via-smtp",
      "name": "Send via SMTP",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1400, 350]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.all()[0].json;\n\n// Mock email sending - just log the attempt\nconsole.log('MOCK EMAIL SEND:', {\n  to: data.recipient_email,\n  subject: data.subject,\n  from: `${data.from_name} <${data.from_email}>`,\n  content_length: {\n    html: data.html_content?.length || 0,\n    text: data.text_content?.length || 0\n  },\n  notification_id: data.notification_id,\n  delivery_id: data.delivery_id\n});\n\n// Return successful mock response\nreturn [{\n  json: {\n    status: 'sent',\n    provider_message_id: `mock_${data.delivery_id}`,\n    provider_response: {\n      mock: true,\n      status: 'accepted',\n      timestamp: new Date().toISOString()\n    },\n    delivery_id: data.delivery_id,\n    notification_id: data.notification_id,\n    recipient_email: data.recipient_email,\n    cost_cents: 1 // Mock cost of 1 cent\n  }\n}];"
      },
      "id": "mock-email-send",
      "name": "Mock Email Send",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 500]
    },
    {
      "parameters": {
        "jsCode": "// Process different provider responses into standard format\nconst input = $input.all()[0];\nlet response;\n\n// Handle different response formats based on provider\nif (input.json.provider === 'sendgrid') {\n  // SendGrid response processing\n  response = {\n    status: input.json.status >= 200 && input.json.status < 300 ? 'sent' : 'failed',\n    provider_message_id: input.json.headers?.['x-message-id'] || `sg_${Date.now()}`,\n    provider_response: {\n      status_code: input.json.status,\n      headers: input.json.headers,\n      response: input.json\n    },\n    cost_cents: 3 // SendGrid typical cost\n  };\n} else if (input.json.provider === 'smtp') {\n  // SMTP response processing\n  response = {\n    status: input.json.response?.accepted?.length > 0 ? 'sent' : 'failed',\n    provider_message_id: input.json.response?.messageId || `smtp_${Date.now()}`,\n    provider_response: {\n      message_id: input.json.response?.messageId,\n      accepted: input.json.response?.accepted,\n      rejected: input.json.response?.rejected,\n      response: input.json.response\n    },\n    cost_cents: 1 // SMTP typically free/low cost\n  };\n} else {\n  // Use input as-is for mock or other providers\n  response = input.json;\n}\n\n// Add standard fields\nresponse.channel = 'email';\nresponse.sent_at = new Date().toISOString();\n\nif (response.status === 'sent') {\n  response.delivered_at = new Date().toISOString();\n}\n\nreturn [{ json: response }];"
      },
      "id": "process-provider-response",
      "name": "Process Provider Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 375]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO notification_deliveries (\n  notification_id,\n  channel,\n  provider,\n  status,\n  provider_message_id,\n  provider_response,\n  sent_at,\n  delivered_at,\n  cost_cents\n) VALUES (\n  '{{ $json.notification_id }}',\n  '{{ $json.channel }}',\n  '{{ $json.provider }}',\n  '{{ $json.status }}',\n  '{{ $json.provider_message_id }}',\n  '{{ JSON.stringify($json.provider_response) }}',\n  '{{ $json.sent_at }}',\n  {{ $json.delivered_at ? \"'\" + $json.delivered_at + \"'\" : \"NULL\" }},\n  {{ $json.cost_cents || \"NULL\" }}\n)",
        "options": {}
      },
      "id": "record-delivery-attempt",
      "name": "Record Delivery Attempt",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1800, 375],
      "credentials": {
        "postgres": {
          "id": "postgres-notification-hub",
          "name": "PostgreSQL - Notification Hub"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "delivery-success-check",
              "leftValue": "={{ $json.status }}",
              "rightValue": "sent",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-delivery-success",
      "name": "Check Delivery Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2000, 375]
    },
    {
      "parameters": {
        "operation": "executeQuery", 
        "query": "UPDATE notifications \nSET status = 'sent', sent_at = NOW(), updated_at = NOW()\nWHERE id = '{{ $json.notification_id }}'",
        "options": {}
      },
      "id": "update-notification-success",
      "name": "Update Notification Success",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2200, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-notification-hub",
          "name": "PostgreSQL - Notification Hub"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE notifications \nSET status = 'failed', updated_at = NOW()\nWHERE id = '{{ $json.notification_id }}'",
        "options": {}
      },
      "id": "update-notification-failed",
      "name": "Update Notification Failed",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2200, 450],
      "credentials": {
        "postgres": {
          "id": "postgres-notification-hub", 
          "name": "PostgreSQL - Notification Hub"
        }
      }
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Check Data Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Default Test Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Test Data": {
      "main": [
        [
          {
            "node": "Check Data Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Data Source": {
      "main": [
        [
          {
            "node": "Get Email Provider",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Email Provider",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Email Provider": {
      "main": [
        [
          {
            "node": "Prepare Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Email Data": {
      "main": [
        [
          {
            "node": "SendGrid Provider",
            "type": "main",
            "index": 0
          },
          {
            "node": "SMTP Provider",
            "type": "main",
            "index": 0
          },
          {
            "node": "Mock Provider",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SendGrid Provider": {
      "main": [
        [
          {
            "node": "Send via SendGrid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SMTP Provider": {
      "main": [
        [
          {
            "node": "Send via SMTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mock Provider": {
      "main": [
        [
          {
            "node": "Mock Email Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send via SendGrid": {
      "main": [
        [
          {
            "node": "Process Provider Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send via SMTP": {
      "main": [
        [
          {
            "node": "Process Provider Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mock Email Send": {
      "main": [
        [
          {
            "node": "Process Provider Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Provider Response": {
      "main": [
        [
          {
            "node": "Record Delivery Attempt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Record Delivery Attempt": {
      "main": [
        [
          {
            "node": "Check Delivery Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Delivery Success": {
      "main": [
        [
          {
            "node": "Update Notification Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Notification Failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "email-delivery",
      "name": "email-delivery"
    }
  ],
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "email-sender",
  "versionId": "1"
}