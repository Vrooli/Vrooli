#!/bin/bash

# Symbol Search CLI
# Provides command-line access to the Symbol Search API

set -e

# Configuration
SYMBOL_SEARCH_API_URL="${SYMBOL_SEARCH_API_URL:-http://localhost:${API_PORT:-15000}}"
VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
log_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

log_success() {
    echo -e "${GREEN}$1${NC}"
}

log_info() {
    echo -e "${BLUE}$1${NC}"
}

log_warning() {
    echo -e "${YELLOW}$1${NC}"
}

# API request helper
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    
    if [ "$method" = "POST" ] && [ -n "$data" ]; then
        curl -s -X "$method" "$SYMBOL_SEARCH_API_URL$endpoint" \
            -H "Content-Type: application/json" \
            -d "$data"
    else
        curl -s -X "$method" "$SYMBOL_SEARCH_API_URL$endpoint"
    fi
}

# Format table output
format_table() {
    local json_output="$1"
    local format="$2"
    
    if [ "$format" = "json" ]; then
        echo "$json_output" | jq .
    else
        # Default table formatting - customize based on command
        echo "$json_output" | jq -r '.'
    fi
}

# Commands

cmd_help() {
    local command="$1"
    
    if [ -n "$command" ]; then
        case "$command" in
            search)
                echo "Usage: symbol-search search <query> [options]"
                echo ""
                echo "Search for symbols by name or properties"
                echo ""
                echo "Options:"
                echo "  --category <code>     Filter by Unicode category (e.g., 'So', 'Sm')"
                echo "  --block <name>        Filter by Unicode block (e.g., 'Emoticons')"
                echo "  --unicode-version <v> Filter by Unicode version"
                echo "  --limit <number>      Maximum results (default: 50, max: 1000)"
                echo "  --offset <number>     Pagination offset (default: 0)"
                echo "  --json               Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  symbol-search search heart"
                echo "  symbol-search search arrow --category Sm"
                echo "  symbol-search search love --block Emoticons --json"
                ;;
            character)
                echo "Usage: symbol-search character <codepoint>"
                echo ""
                echo "Get detailed information about a specific character"
                echo ""
                echo "Arguments:"
                echo "  codepoint            Unicode codepoint (U+1F600) or decimal (128512)"
                echo ""
                echo "Options:"
                echo "  --json               Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  symbol-search character U+1F600"
                echo "  symbol-search character 128512"
                echo "  symbol-search character U+2764 --json"
                ;;
            categories)
                echo "Usage: symbol-search categories [options]"
                echo ""
                echo "List all Unicode categories with character counts"
                echo ""
                echo "Options:"
                echo "  --json               Output in JSON format"
                ;;
            blocks)
                echo "Usage: symbol-search blocks [options]"
                echo ""
                echo "List all Unicode blocks with character ranges and counts"
                echo ""
                echo "Options:"
                echo "  --json               Output in JSON format"
                ;;
            range)
                echo "Usage: symbol-search range <start> <end> [options]"
                echo ""
                echo "Get all characters in specified Unicode range"
                echo ""
                echo "Arguments:"
                echo "  start                Starting codepoint (U+0000 or decimal)"
                echo "  end                  Ending codepoint (U+007F or decimal)"
                echo ""
                echo "Options:"
                echo "  --format <type>      Output format (unicode|decimal|html)"
                echo "  --json               Output in JSON format"
                echo ""
                echo "Examples:"
                echo "  symbol-search range U+2600 U+26FF"
                echo "  symbol-search range 9728 9983 --format html"
                ;;
            *)
                log_error "Unknown command: $command"
                cmd_help
                exit 1
                ;;
        esac
        return
    fi
    
    cat << EOF
Symbol Search CLI v${VERSION}
Unicode and ASCII symbol search with advanced filtering

USAGE:
    symbol-search <command> [arguments] [options]

COMMANDS:
    search <query>           Search for symbols by name or properties
    character <codepoint>    Get detailed information about a character
    categories              List all Unicode categories
    blocks                  List all Unicode blocks  
    range <start> <end>     Get characters in Unicode range
    
    status                  Show service status and health
    version                 Show version information
    help [command]          Show help for specific command

GLOBAL OPTIONS:
    --json                  Output in JSON format (where applicable)
    
EXAMPLES:
    symbol-search search heart --category So
    symbol-search character U+1F600
    symbol-search blocks --json
    symbol-search range U+2600 U+26FF

For detailed help on a command, use: symbol-search help <command>

Environment Variables:
    SYMBOL_SEARCH_API_URL   API server URL (default: http://localhost:15000)
EOF
}

cmd_version() {
    local json_format="$1"
    
    if [ "$json_format" = "--json" ]; then
        cat << EOF
{
  "cli_version": "${VERSION}",
  "api_url": "${SYMBOL_SEARCH_API_URL}",
  "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF
    else
        echo "Symbol Search CLI v${VERSION}"
        echo "API URL: ${SYMBOL_SEARCH_API_URL}"
    fi
}

cmd_status() {
    local json_format="$1"
    local verbose="$2"
    
    log_info "Checking Symbol Search service status..."
    
    # Check API health
    response=$(api_request "GET" "/health" 2>/dev/null || echo '{"error": "connection_failed"}')
    
    if echo "$response" | jq -e '.status == "healthy"' >/dev/null 2>&1; then
        if [ "$json_format" = "--json" ]; then
            echo "$response" | jq .
        else
            log_success "✓ Service is healthy"
            if [ "$verbose" = "--verbose" ]; then
                echo "$response" | jq -r '"Database: " + (if .database then .database else "unknown" end)'
                echo "$response" | jq -r '"Characters loaded: " + (if .characters_loaded then "yes" else "no" end)'
                echo "$response" | jq -r '"Timestamp: " + .timestamp'
            fi
        fi
    else
        if [ "$json_format" = "--json" ]; then
            echo '{"status": "unhealthy", "error": "API not responding"}'
        else
            log_error "✗ Service is not responding"
            log_info "Check that the API server is running on $SYMBOL_SEARCH_API_URL"
        fi
        exit 1
    fi
}

cmd_search() {
    local query=""
    local category=""
    local block=""
    local unicode_version=""
    local limit="50"
    local offset="0"
    local json_format=""
    
    # Parse arguments
    query="$1"
    shift
    
    if [ -z "$query" ]; then
        log_error "Search query is required"
        cmd_help search
        exit 1
    fi
    
    # Parse options
    while [ $# -gt 0 ]; do
        case "$1" in
            --category)
                category="$2"
                shift 2
                ;;
            --block)
                block="$2"
                shift 2
                ;;
            --unicode-version)
                unicode_version="$2"
                shift 2
                ;;
            --limit)
                limit="$2"
                shift 2
                ;;
            --offset)
                offset="$2"
                shift 2
                ;;
            --json)
                json_format="--json"
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    # Build query parameters
    params="q=$(printf %s "$query" | sed 's/ /%20/g')"
    [ -n "$category" ] && params="${params}&category=$category"
    [ -n "$block" ] && params="${params}&block=$(printf %s "$block" | sed 's/ /%20/g')"
    [ -n "$unicode_version" ] && params="${params}&unicode_version=$unicode_version"
    params="${params}&limit=$limit&offset=$offset"
    
    # Make API request
    response=$(api_request "GET" "/api/search?$params")
    
    if [ "$json_format" = "--json" ]; then
        echo "$response" | jq .
    else
        # Format as table
        total=$(echo "$response" | jq -r '.total // 0')
        query_time=$(echo "$response" | jq -r '.query_time_ms // 0')
        
        echo "Found $total characters (${query_time}ms)"
        echo ""
        
        echo "$response" | jq -r '.characters[] | [.codepoint, .decimal, .name, .category, .block] | @tsv' | \
        awk 'BEGIN {
            printf "%-10s %-8s %-40s %-4s %s\n", "CODEPOINT", "DECIMAL", "NAME", "CAT", "BLOCK"
            printf "%-10s %-8s %-40s %-4s %s\n", "----------", "--------", "----------------------------------------", "----", "-----"
        } {
            printf "%-10s %-8s %-40s %-4s %s\n", $1, $2, substr($3,1,40), $4, $5
        }'
    fi
}

cmd_character() {
    local codepoint="$1"
    local json_format="$2"
    
    if [ -z "$codepoint" ]; then
        log_error "Codepoint is required"
        cmd_help character
        exit 1
    fi
    
    # URL encode the codepoint
    encoded_codepoint=$(printf %s "$codepoint" | sed 's/+/%2B/g')
    
    response=$(api_request "GET" "/api/character/$encoded_codepoint")
    
    if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
        error_msg=$(echo "$response" | jq -r '.error')
        log_error "$error_msg"
        exit 1
    fi
    
    if [ "$json_format" = "--json" ]; then
        echo "$response" | jq .
    else
        # Format character details
        echo "$response" | jq -r '.character | 
            "Codepoint: " + .codepoint + 
            "\nDecimal: " + (.decimal | tostring) +
            "\nName: " + .name +
            "\nCategory: " + .category + 
            "\nBlock: " + .block +
            "\nUnicode Version: " + .unicode_version +
            (if .description then "\nDescription: " + .description else "" end)'
        
        echo ""
        echo "Usage Examples:"
        echo "$response" | jq -r '.usage_examples[]? | "  " + .'
        
        # Show related characters if present
        related_count=$(echo "$response" | jq -r '.related_characters | length')
        if [ "$related_count" -gt 0 ]; then
            echo ""
            echo "Related Characters:"
            echo "$response" | jq -r '.related_characters[] | "  " + .codepoint + " " + .name'
        fi
    fi
}

cmd_categories() {
    local json_format="$1"
    
    response=$(api_request "GET" "/api/categories")
    
    if [ "$json_format" = "--json" ]; then
        echo "$response" | jq .
    else
        echo "Unicode Categories:"
        echo ""
        echo "$response" | jq -r '.categories[] | [.code, .name, (.character_count | tostring)] | @tsv' | \
        awk 'BEGIN {
            printf "%-4s %-30s %s\n", "CODE", "NAME", "COUNT"
            printf "%-4s %-30s %s\n", "----", "------------------------------", "-----"
        } {
            printf "%-4s %-30s %s\n", $1, $2, $3
        }'
    fi
}

cmd_blocks() {
    local json_format="$1"
    
    response=$(api_request "GET" "/api/blocks")
    
    if [ "$json_format" = "--json" ]; then
        echo "$response" | jq .
    else
        echo "Unicode Blocks:"
        echo ""
        echo "$response" | jq -r '.blocks[] | [.name, (.start_codepoint | tostring), (.end_codepoint | tostring), (.character_count | tostring)] | @tsv' | \
        awk 'BEGIN {
            printf "%-30s %-8s %-8s %s\n", "BLOCK", "START", "END", "COUNT"
            printf "%-30s %-8s %-8s %s\n", "------------------------------", "--------", "--------", "-----"
        } {
            printf "%-30s %-8s %-8s %s\n", $1, $2, $3, $4
        }'
    fi
}

cmd_range() {
    local start="$1"
    local end="$2"
    shift 2
    
    local format_type=""
    local json_format=""
    
    if [ -z "$start" ] || [ -z "$end" ]; then
        log_error "Start and end codepoints are required"
        cmd_help range
        exit 1
    fi
    
    # Parse options
    while [ $# -gt 0 ]; do
        case "$1" in
            --format)
                format_type="$2"
                shift 2
                ;;
            --json)
                json_format="--json"
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    # Build request data
    request_data=$(cat << EOF
{
  "ranges": [
    {
      "start": "$start",
      "end": "$end"
      $([ -n "$format_type" ] && echo ', "format": "'"$format_type"'"')
    }
  ]
}
EOF
    )
    
    response=$(api_request "POST" "/api/bulk/range" "$request_data")
    
    if [ "$json_format" = "--json" ]; then
        echo "$response" | jq .
    else
        total=$(echo "$response" | jq -r '.total_characters // 0')
        echo "Found $total characters in range $start to $end"
        echo ""
        
        echo "$response" | jq -r '.characters[] | [.codepoint, .decimal, .name] | @tsv' | \
        awk 'BEGIN {
            printf "%-10s %-8s %s\n", "CODEPOINT", "DECIMAL", "NAME"
            printf "%-10s %-8s %s\n", "----------", "--------", "----"
        } {
            printf "%-10s %-8s %s\n", $1, $2, $3
        }'
    fi
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        cmd_help
        exit 1
    fi
    
    local command="$1"
    shift
    
    case "$command" in
        search)
            cmd_search "$@"
            ;;
        character)
            cmd_character "$@"
            ;;
        categories)
            cmd_categories "$@"
            ;;
        blocks)
            cmd_blocks "$@"
            ;;
        range)
            cmd_range "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        version)
            cmd_version "$@"
            ;;
        help|--help|-h)
            cmd_help "$@"
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            cmd_help
            exit 1
            ;;
    esac
}

# Check dependencies
if ! command -v curl >/dev/null 2>&1; then
    log_error "curl is required but not installed"
    exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
    log_error "jq is required but not installed"
    exit 1
fi

# Run main function
main "$@"