#!/usr/bin/env bash
# Git Control Tower CLI
# Wrapper for Git Control Tower API operations

set -euo pipefail

API_PORT="${API_PORT:-18700}"
API_BASE="http://localhost:${API_PORT}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    cat <<EOF
Git Control Tower CLI

USAGE:
    git-control-tower <command> [options]

COMMANDS:
    status              Show repository status (branch, changes, tracking)
    diff <path>         Show diff for a specific file
    stage <files...>    Stage files for commit
    unstage <files...>  Unstage files
    commit <message>    Create a commit with the given message
    preview             Preview changes and impact analysis before commit
    suggest             Generate AI-assisted commit message suggestions
    conflicts           Detect and analyze merge conflicts
    branches            List all branches
    branch <name>       Create a new branch
    checkout <branch>   Switch to a different branch
    health              Check API health status
    help                Show this help message

OPTIONS:
    --json              Output in JSON format
    --api-port PORT     Override API port (default: ${API_PORT})
    --scope SCOPE       Stage/unstage by scope (e.g., scenario:git-control-tower)
    --files FILES       Comma-separated files for commit (default: all staged)

EXAMPLES:
    git-control-tower status
    git-control-tower status --json
    git-control-tower diff scenarios/git-control-tower/api/main.go
    git-control-tower stage file1.txt file2.txt
    git-control-tower stage --scope scenario:git-control-tower
    git-control-tower unstage file1.txt
    git-control-tower commit "feat(api): add new endpoint"
    git-control-tower commit "fix: resolve bug" --files file1.txt,file2.txt
    git-control-tower health

EOF
}

check_api() {
    if ! curl -sf "${API_BASE}/health" > /dev/null 2>&1; then
        echo -e "${RED}Error: Git Control Tower API is not running${NC}" >&2
        echo "Start it with: vrooli scenario start git-control-tower" >&2
        exit 1
    fi
}

cmd_status() {
    check_api

    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    response=$(curl -sf "${API_BASE}/api/v1/status")

    if [[ "$json_output" == "true" ]]; then
        echo "$response"
    else
        echo -e "${BLUE}Git Control Tower - Repository Status${NC}"
        echo ""

        branch=$(echo "$response" | jq -r '.branch')
        echo -e "Branch: ${GREEN}${branch}${NC}"

        ahead=$(echo "$response" | jq -r '.tracking.ahead // 0')
        behind=$(echo "$response" | jq -r '.tracking.behind // 0')

        if [[ "$ahead" -gt 0 ]] || [[ "$behind" -gt 0 ]]; then
            echo -e "Tracking: ahead ${ahead}, behind ${behind}"
        fi

        staged_count=$(echo "$response" | jq -r '.staged | length')
        unstaged_count=$(echo "$response" | jq -r '.unstaged | length')
        untracked_count=$(echo "$response" | jq -r '.untracked | length')
        conflicts_count=$(echo "$response" | jq -r '.conflicts | length')

        echo ""
        echo -e "${YELLOW}Changes:${NC}"
        echo "  Staged: ${staged_count}"
        echo "  Unstaged: ${unstaged_count}"
        echo "  Untracked: ${untracked_count}"

        if [[ "$conflicts_count" -gt 0 ]]; then
            echo -e "  ${RED}Conflicts: ${conflicts_count}${NC}"
        fi

        if [[ "$staged_count" -gt 0 ]]; then
            echo ""
            echo -e "${GREEN}Staged files:${NC}"
            echo "$response" | jq -r '.staged[] | "  \(.status): \(.path)"'
        fi

        if [[ "$unstaged_count" -gt 0 ]]; then
            echo ""
            echo -e "${YELLOW}Unstaged files:${NC}"
            echo "$response" | jq -r '.unstaged[] | "  \(.status): \(.path)"'
        fi
    fi
}

cmd_diff() {
    check_api

    if [[ -z "${1:-}" ]]; then
        echo -e "${RED}Error: File path required${NC}" >&2
        echo "Usage: git-control-tower diff <path>" >&2
        exit 1
    fi

    local file_path="$1"

    curl -sf "${API_BASE}/api/v1/diff/${file_path}"
}

cmd_stage() {
    check_api

    local scope=""
    local files=()

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --scope)
                scope="$2"
                shift 2
                ;;
            *)
                files+=("$1")
                shift
                ;;
        esac
    done

    # Build JSON payload
    local payload
    if [[ -n "$scope" ]]; then
        payload=$(jq -n --arg scope "$scope" '{scope: $scope}')
    elif [[ ${#files[@]} -gt 0 ]]; then
        payload=$(jq -n --argjson files "$(printf '%s\n' "${files[@]}" | jq -R . | jq -s .)" '{files: $files}')
    else
        echo -e "${RED}Error: No files or scope specified${NC}" >&2
        echo "Usage: git-control-tower stage <files...> OR git-control-tower stage --scope <scope>" >&2
        exit 1
    fi

    response=$(curl -sf -X POST "${API_BASE}/api/v1/stage" \
        -H "Content-Type: application/json" \
        -d "$payload")

    success=$(echo "$response" | jq -r '.success')
    message=$(echo "$response" | jq -r '.message')

    if [[ "$success" == "true" ]]; then
        echo -e "${GREEN}✓ ${message}${NC}"
    else
        echo -e "${RED}✗ ${message}${NC}"
        exit 1
    fi
}

cmd_unstage() {
    check_api

    local scope=""
    local files=()

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --scope)
                scope="$2"
                shift 2
                ;;
            *)
                files+=("$1")
                shift
                ;;
        esac
    done

    # Build JSON payload
    local payload
    if [[ -n "$scope" ]]; then
        payload=$(jq -n --arg scope "$scope" '{scope: $scope}')
    elif [[ ${#files[@]} -gt 0 ]]; then
        payload=$(jq -n --argjson files "$(printf '%s\n' "${files[@]}" | jq -R . | jq -s .)" '{files: $files}')
    else
        echo -e "${RED}Error: No files or scope specified${NC}" >&2
        echo "Usage: git-control-tower unstage <files...> OR git-control-tower unstage --scope <scope>" >&2
        exit 1
    fi

    response=$(curl -sf -X POST "${API_BASE}/api/v1/unstage" \
        -H "Content-Type: application/json" \
        -d "$payload")

    success=$(echo "$response" | jq -r '.success')
    message=$(echo "$response" | jq -r '.message')

    if [[ "$success" == "true" ]]; then
        echo -e "${GREEN}✓ ${message}${NC}"
    else
        echo -e "${RED}✗ ${message}${NC}"
        exit 1
    fi
}

cmd_commit() {
    check_api

    if [[ -z "${1:-}" ]]; then
        echo -e "${RED}Error: Commit message required${NC}" >&2
        echo "Usage: git-control-tower commit <message> [--files file1,file2,...]" >&2
        exit 1
    fi

    local message="$1"
    shift

    local files=""

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --files)
                files="$2"
                shift 2
                ;;
            *)
                echo -e "${YELLOW}Warning: Unknown option '$1'${NC}" >&2
                shift
                ;;
        esac
    done

    # Build JSON payload
    local payload
    if [[ -n "$files" ]]; then
        # Convert comma-separated files to JSON array
        IFS=',' read -ra file_array <<< "$files"
        payload=$(jq -n --arg message "$message" --argjson files "$(printf '%s\n' "${file_array[@]}" | jq -R . | jq -s .)" '{message: $message, files: $files}')
    else
        payload=$(jq -n --arg message "$message" '{message: $message}')
    fi

    response=$(curl -sf -X POST "${API_BASE}/api/v1/commit" \
        -H "Content-Type: application/json" \
        -d "$payload")

    success=$(echo "$response" | jq -r '.success')
    message=$(echo "$response" | jq -r '.message')
    commit_hash=$(echo "$response" | jq -r '.commit_hash // ""')

    if [[ "$success" == "true" ]]; then
        echo -e "${GREEN}✓ ${message}${NC}"
        if [[ -n "$commit_hash" ]]; then
            echo "Commit: ${commit_hash:0:8}"
        fi
    else
        echo -e "${RED}✗ ${message}${NC}"
        exit 1
    fi
}

cmd_health() {
    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    if response=$(curl -sf "${API_BASE}/health" 2>&1); then
        if [[ "$json_output" == "true" ]]; then
            echo "$response"
        else
            status=$(echo "$response" | jq -r '.status')
            readiness=$(echo "$response" | jq -r '.readiness')

            if [[ "$status" == "healthy" ]] && [[ "$readiness" == "true" ]]; then
                echo -e "${GREEN}✓ Git Control Tower is healthy${NC}"
            else
                echo -e "${YELLOW}⚠ Git Control Tower is degraded${NC}"
            fi

            echo ""
            echo "Dependencies:"
            db_status=$(echo "$response" | jq -r '.dependencies.database.status // "unknown"')
            git_available=$(echo "$response" | jq -r '.dependencies.git_binary.available // false')
            repo_accessible=$(echo "$response" | jq -r '.dependencies.repository_access.accessible // false')
            echo "  database: $db_status"
            echo "  git_binary: $git_available"
            echo "  repository_access: $repo_accessible"
        fi
        exit 0
    else
        echo -e "${RED}✗ Git Control Tower is not running${NC}"
        exit 1
    fi
}

cmd_branches() {
    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    if response=$(curl -sf "${API_BASE}/api/v1/branches" 2>&1); then
        if [[ "$json_output" == "true" ]]; then
            echo "$response"
        else
            echo -e "${BLUE}Branches:${NC}"
            echo "$response" | jq -r '.branches[] | "\(if .current then "* " else "  " end)\(.name) (\(.commit_hash))"'
        fi
        exit 0
    else
        echo -e "${RED}✗ Failed to list branches${NC}"
        echo "$response"
        exit 1
    fi
}

cmd_branch() {
    local branch_name="${1:-}"
    local start_point="${2:-}"

    if [[ -z "$branch_name" ]]; then
        echo -e "${RED}Error: Branch name is required${NC}" >&2
        echo "Usage: git-control-tower branch <name> [start-point]"
        exit 1
    fi

    local payload="{\"name\":\"$branch_name\""
    if [[ -n "$start_point" ]]; then
        payload="$payload,\"start_point\":\"$start_point\""
    fi
    payload="$payload}"

    if response=$(curl -sf -X POST "${API_BASE}/api/v1/branches" \
        -H "Content-Type: application/json" \
        -d "$payload" 2>&1); then

        message=$(echo "$response" | jq -r '.message')
        echo -e "${GREEN}✓ $message${NC}"
        exit 0
    else
        echo -e "${RED}✗ Failed to create branch${NC}"
        echo "$response"
        exit 1
    fi
}

cmd_checkout() {
    local branch_name="${1:-}"

    if [[ -z "$branch_name" ]]; then
        echo -e "${RED}Error: Branch name is required${NC}" >&2
        echo "Usage: git-control-tower checkout <branch>"
        exit 1
    fi

    local payload="{\"branch\":\"$branch_name\"}"

    if response=$(curl -sf -X POST "${API_BASE}/api/v1/checkout" \
        -H "Content-Type: application/json" \
        -d "$payload" 2>&1); then

        message=$(echo "$response" | jq -r '.message')
        echo -e "${GREEN}✓ $message${NC}"
        exit 0
    else
        echo -e "${RED}✗ Failed to checkout branch${NC}"
        echo "$response"
        exit 1
    fi
}

cmd_suggest() {
    check_api

    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    response=$(curl -sf -X POST "${API_BASE}/api/v1/commit/suggest" \
        -H "Content-Type: application/json" \
        -d '{}' 2>&1)

    if [[ "$json_output" == "true" ]]; then
        echo "$response"
    else
        echo -e "${BLUE}AI-Assisted Commit Message Suggestions${NC}"
        echo ""

        model=$(echo "$response" | jq -r '.model // "unknown"')
        echo -e "Model: ${YELLOW}$model${NC}"
        echo ""

        echo -e "${GREEN}Suggestions:${NC}"
        echo "$response" | jq -r '.suggestions[]' | nl -w2 -s'. '
        echo ""
        echo "Use: git-control-tower commit \"<message>\" to create a commit"
    fi
}

cmd_conflicts() {
    check_api

    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    response=$(curl -sf "${API_BASE}/api/v1/conflicts" 2>&1)

    if [[ "$json_output" == "true" ]]; then
        echo "$response"
    else
        echo -e "${BLUE}Conflict Detection Report${NC}"
        echo ""

        has_conflicts=$(echo "$response" | jq -r '.has_conflicts')
        potential=$(echo "$response" | jq -r '.potential_conflict')
        message=$(echo "$response" | jq -r '.message')

        if [[ "$has_conflicts" == "true" ]]; then
            echo -e "${RED}⚠ $message${NC}"
            echo ""
            echo -e "${YELLOW}Conflicted Files:${NC}"
            echo "$response" | jq -r '.conflicts[] | "  - \(.file) (type: \(.conflict_type), markers: \(.conflict_lines))"'
        elif [[ "$potential" == "true" ]]; then
            echo -e "${YELLOW}⚠ $message${NC}"
        else
            echo -e "${GREEN}✓ $message${NC}"
        fi
    fi
}

cmd_preview() {
    check_api

    local json_output=false
    if [[ "${1:-}" == "--json" ]]; then
        json_output=true
    fi

    response=$(curl -sf "${API_BASE}/api/v1/preview" 2>&1)

    if [[ "$json_output" == "true" ]]; then
        echo "$response"
    else
        echo -e "${BLUE}Change Preview & Impact Analysis${NC}"
        echo ""

        # Summary
        total=$(echo "$response" | jq -r '.summary.total_files')
        added=$(echo "$response" | jq -r '.summary.files_added')
        modified=$(echo "$response" | jq -r '.summary.files_modified')
        deleted=$(echo "$response" | jq -r '.summary.files_deleted')
        additions=$(echo "$response" | jq -r '.summary.total_additions')
        deletions=$(echo "$response" | jq -r '.summary.total_deletions')
        commit_size=$(echo "$response" | jq -r '.estimated_commit_size')

        echo -e "${YELLOW}Changes Summary:${NC}"
        echo "  Total Files: ${total}"
        echo "  Added: ${added}, Modified: ${modified}, Deleted: ${deleted}"
        echo "  Lines: +${additions} -${deletions}"
        echo "  Estimated Commit Size: ${commit_size}"
        echo ""

        # Impact
        severity=$(echo "$response" | jq -r '.impact_analysis.severity')
        risk=$(echo "$response" | jq -r '.impact_analysis.deployment_risk')
        restart=$(echo "$response" | jq -r '.impact_analysis.requires_restart')
        breaking=$(echo "$response" | jq -r '.impact_analysis.breaking_change')
        downtime=$(echo "$response" | jq -r '.impact_analysis.estimated_downtime')

        echo -e "${YELLOW}Impact Analysis:${NC}"
        echo "  Severity: ${severity}"
        echo "  Deployment Risk: ${risk}"
        echo "  Requires Restart: ${restart}"
        echo "  Breaking Change: ${breaking}"
        echo "  Estimated Downtime: ${downtime}"
        echo ""

        # Affected scenarios/resources
        scenarios=$(echo "$response" | jq -r '.impact_analysis.affected_scenarios | length')
        resources=$(echo "$response" | jq -r '.impact_analysis.affected_resources | length')
        if [[ "$scenarios" -gt 0 ]]; then
            echo -e "${YELLOW}Affected Scenarios (${scenarios}):${NC}"
            echo "$response" | jq -r '.impact_analysis.affected_scenarios[] | "  - \(.)"'
            echo ""
        fi
        if [[ "$resources" -gt 0 ]]; then
            echo -e "${YELLOW}Affected Resources (${resources}):${NC}"
            echo "$response" | jq -r '.impact_analysis.affected_resources[] | "  - \(.)"'
            echo ""
        fi

        # Recommendations
        rec_count=$(echo "$response" | jq -r '.recommendations | length')
        if [[ "$rec_count" -gt 0 ]]; then
            echo -e "${YELLOW}Recommendations:${NC}"
            echo "$response" | jq -r '.recommendations[] | "  • \(.)"'
        fi
    fi
}

# Main command dispatcher
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    # Parse global options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --api-port)
                API_PORT="$2"
                API_BASE="http://localhost:${API_PORT}"
                shift 2
                ;;
            *)
                break
                ;;
        esac
    done

    local command="${1:-help}"
    shift || true

    case "$command" in
        status)
            cmd_status "$@"
            ;;
        diff)
            cmd_diff "$@"
            ;;
        stage)
            cmd_stage "$@"
            ;;
        unstage)
            cmd_unstage "$@"
            ;;
        commit)
            cmd_commit "$@"
            ;;
        suggest)
            cmd_suggest "$@"
            ;;
        preview)
            cmd_preview "$@"
            ;;
        conflicts)
            cmd_conflicts "$@"
            ;;
        branches)
            cmd_branches "$@"
            ;;
        branch)
            cmd_branch "$@"
            ;;
        checkout)
            cmd_checkout "$@"
            ;;
        health)
            cmd_health "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Error: Unknown command '${command}'${NC}" >&2
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
