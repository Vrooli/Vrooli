{
  "_metadata": {
    "prd_section": "P0 - Smart Scanning / AI Engine",
    "description": "AI-powered deep analysis using resource-claude-code and resource-codes"
  },
  "requirements": [
    {
      "id": "TM-SS-001",
      "title": "AI batch configuration",
      "prd_ref": "OT-P0-004",
      "description": "Support configurable max files per batch, max tokens per request, max concurrent requests",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/smart_scanner_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/ai-batch-config.json"
        }
      ],
      "notes": "Defaults: 10 files/batch, 5 concurrent batches. Tests passing: TestSmartScannerBatchConfiguration, TestSmartScannerDefaults, TestSmartScannerBatchSizeLimits. Implementation in smart_scanner.go:SmartScanConfig with validation, configurable batch processing with semaphore-based concurrency limit.",
      "status": "complete"
    },
    {
      "id": "TM-SS-002",
      "title": "AI issue recording",
      "prd_ref": "OT-P0-004",
      "description": "Record AI issues with scenario, file paths, category, severity, explanation, and remediation steps",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/smart_scanner_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/ai-issue-recording.json"
        }
      ],
      "notes": "Categories: dead_code, duplication, length, complexity, style. Implementation complete: storeAIIssue() handler in handlers.go stores issues to postgres with all required fields (scenario, file_path, category, severity, title, description, line_number, column_number, agent_notes, remediation_steps, session_id, campaign_id, resource_used). HTTP endpoint POST /api/v1/scan/smart accepts batch scan requests and stores results via handleSmartScan().",
      "status": "complete"
    },
    {
      "id": "TM-SS-003",
      "title": "visited-tracker campaign creation",
      "prd_ref": "OT-P0-005",
      "description": "Create new visited-tracker campaign if none exists for a scenario",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/campaign_manager_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/campaign-creation.json"
        }
      ],
      "notes": "Implementation complete: CampaignManager.CreateCampaign() creates campaigns via visited-tracker API with proper metadata (scenario name, campaign type, from_agent). Tests: TestCampaignManager_CreateCampaign validates campaign creation request/response. Graceful degradation implemented: IsVisitedTrackerAvailable() checks health, TestCampaignManager_GracefulDegradation validates error handling when unavailable.",
      "status": "complete"
    },
    {
      "id": "TM-SS-004",
      "title": "visited-tracker campaign attachment",
      "prd_ref": "OT-P0-005",
      "description": "Attach to existing visited-tracker campaign when available",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/campaign_manager_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/campaign-attachment.json"
        }
      ],
      "notes": "Implementation complete: CampaignManager.FindCampaignByScenario() queries visited-tracker /api/v1/campaigns endpoint, filters by scenario name prefix 'tidiness-{scenario}', returns existing campaign if found. GetOrCreateCampaign() implements full workflow (find existing â†’ create if not found). Tests: TestCampaignManager_FindCampaignByScenario validates search logic, TestCampaignManager_GetOrCreateCampaign validates complete flow.",
      "status": "complete"
    },
    {
      "id": "TM-SS-005",
      "title": "File prioritization - unvisited first",
      "prd_ref": "OT-P0-005",
      "description": "Prioritize unvisited files over visited files in smart scans",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/file_prioritizer_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/file-prioritization-unvisited.json"
        }
      ],
      "notes": "Implementation complete: FilePrioritizer.PrioritizeFiles() implements staleness scoring with +1000 bonus for unvisited files (visit_count=0), ensuring they always appear first regardless of other factors. Staleness algorithm per PRD: score = (days_since_last_visit * 2) + days_since_last_modification - (total_visit_count * 0.5). Tests: TestFilePrioritizer_UnvisitedFirst validates unvisited files rank highest, TestFilePrioritizer_StalenessAlgorithm validates scoring formula.",
      "status": "complete"
    },
    {
      "id": "TM-SS-006",
      "title": "File prioritization - least visited",
      "prd_ref": "OT-P0-005",
      "description": "Among visited files, prioritize least-visited files",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/file_prioritizer_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/file-prioritization-least-visited.json"
        }
      ],
      "notes": "Implementation complete: FilePrioritizer.PrioritizeFiles() scoring algorithm naturally prioritizes least-visited files (lower visit_count = higher score due to negative weighting -0.5 * visit_count). Sorting by score descending ensures least-visited files appear before heavily-visited files with same staleness. Tests: TestFilePrioritizer_LeastVisited validates visit-once files rank above visit-twice files with identical time factors.",
      "status": "complete"
    },
    {
      "id": "TM-SS-007",
      "title": "No duplicate analysis per session",
      "prd_ref": "OT-P0-006",
      "description": "Prevent analyzing the same file twice within a single smart scan session",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/smart_scanner_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/no-duplicate-analysis.json"
        }
      ],
      "notes": "Track analyzed files in session state. Implementation complete: SmartScanner maintains analyzedFiles map (thread-safe with RWMutex), filters files before batch creation via isFileAnalyzed(), marks files after successful analysis via markFileAnalyzed(). Session ID generated per scanner instance ensures session isolation.",
      "status": "complete"
    },
    {
      "id": "TM-SS-008",
      "title": "Configurable max visits per file",
      "prd_ref": "OT-P0-006",
      "description": "Prevent analyzing files beyond configurable max visit count unless explicitly requested",
      "validation": [
        {
          "type": "test",
          "phase": "unit",
          "status": "implemented",
          "ref": "api/file_prioritizer_test.go"
        },
        {
          "type": "test",
          "phase": "e2e",
          "status": "implemented",
          "ref": "bas/cases/02-smart-scanning/api/max-visits-config.json"
        }
      ],
      "notes": "Implementation complete: FilePrioritizer initialized with maxVisitsPerFile (default 3 from PRD). PrioritizeFiles(respectMaxVisits=true) filters files with visit_count >= max. FilterByMaxVisits() provides explicit filtering. Tests: TestFilePrioritizer_MaxVisitsFilter validates filtering with/without force rescan, TestFilePrioritizer_FilterByMaxVisits validates explicit filter method.",
      "status": "complete"
    }
  ]
}
