{
  "name": "Mind Maps - Intelligent Builder",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mind-maps/intelligent-build",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  topic: 'Quantum Computing Fundamentals',\n  depth: 3,\n  style: 'technical',\n  max_nodes: 25,\n  include_examples: true,\n  include_relationships: true,\n  user_id: 'test-user',\n  context: 'Building a comprehensive mind map for learning'\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $execution.resumeUrl === undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Prepare prompt for intelligent mind map building using shared Ollama workflow\nconst input = items[0].json;\n\n// Create a structured prompt for mind map generation\nconst prompt = `You are an expert at creating comprehensive mind maps. Build a detailed mind map for the topic: \"${input.topic}\"\n\nRequirements:\n- Create up to ${input.max_nodes || 20} meaningful nodes\n- Organize nodes hierarchically with depth of ${input.depth || 3} levels\n- Style: ${input.style || 'balanced'}\n- Include examples: ${input.include_examples || false}\n- Include cross-relationships: ${input.include_relationships || false}\n- Context: ${input.context || 'General learning'}\n\nProvide your response as a JSON object with this exact structure:\n{\n  \"nodes\": [\n    {\n      \"id\": \"node_1\",\n      \"title\": \"Main Topic\",\n      \"description\": \"Description of the main topic\",\n      \"parent_id\": null,\n      \"type\": \"root\",\n      \"metadata\": {}\n    },\n    {\n      \"id\": \"node_2\",\n      \"title\": \"Subtopic 1\",\n      \"description\": \"Description of subtopic\",\n      \"parent_id\": \"node_1\",\n      \"type\": \"concept\",\n      \"metadata\": {}\n    }\n  ],\n  \"relationships\": [\n    {\n      \"source_id\": \"node_1\",\n      \"target_id\": \"node_2\",\n      \"type\": \"related\",\n      \"label\": \"is related to\"\n    }\n  ]\n}\n\nImportant: Return ONLY valid JSON with no additional text or explanations.`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    model: input.model || 'llama3.2',\n    type: 'reasoning',\n    quiet: true,\n    timeout_seconds: 180,\n    original_input: input\n  }\n}];"
      },
      "id": "prepare-ollama-prompt",
      "name": "Prepare Ollama Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "source": "workflowByName",
        "workflowName": "Ollama Universal Executor",
        "workflowValues": "={{ JSON.stringify($json) }}"
      },
      "id": "execute-ollama",
      "name": "Execute Ollama via Shared Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "// Process Ollama results and build final mind map structure\nconst ollamaResult = items[0].json;\nconst originalInput = $('prepare-ollama-prompt').item.json.original_input;\n\n// Initialize mind map structure\nlet mindMap = {\n  id: `mindmap_${Date.now()}`,\n  title: originalInput.topic,\n  user_id: originalInput.user_id,\n  nodes: [],\n  relationships: [],\n  metadata: {\n    created_at: new Date().toISOString(),\n    style: originalInput.style,\n    depth: originalInput.depth,\n    ai_generated: true,\n    ollama_success: ollamaResult.success !== false,\n    model_used: originalInput.model || 'llama3.2'\n  }\n};\n\n// Parse the Ollama response from the shared workflow\ntry {\n  // The shared workflow returns the response in the result field\n  const ollamaOutput = ollamaResult.response || ollamaResult.output || '';\n  let generatedData = {};\n  \n  // Try to parse JSON from the Ollama response\n  try {\n    generatedData = JSON.parse(ollamaOutput);\n  } catch (e) {\n    // If direct parsing fails, try to extract JSON from the output\n    const jsonMatch = ollamaOutput.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      try {\n        generatedData = JSON.parse(jsonMatch[0]);\n      } catch (e2) {\n        console.error('Failed to parse JSON from Ollama response');\n      }\n    }\n  }\n  \n  // Use generated nodes if available\n  if (generatedData.nodes && Array.isArray(generatedData.nodes)) {\n    generatedData.nodes.forEach((node, index) => {\n      const processedNode = {\n        id: node.id || `node_${index + 1}`,\n        title: node.title || `Node ${index + 1}`,\n        description: node.description || '',\n        parent_id: node.parent_id || null,\n        type: node.type || 'concept',\n        metadata: node.metadata || {},\n        position: calculateNodePosition(index)\n      };\n      mindMap.nodes.push(processedNode);\n    });\n  }\n  \n  // Use generated relationships if available\n  if (generatedData.relationships && Array.isArray(generatedData.relationships)) {\n    generatedData.relationships.forEach((rel, index) => {\n      const relationship = {\n        id: `rel_${index + 1}`,\n        source: rel.source_id || rel.source,\n        target: rel.target_id || rel.target,\n        type: rel.type || 'related',\n        label: rel.label || ''\n      };\n      mindMap.relationships.push(relationship);\n    });\n  }\n  \n  // If no nodes were created, create a basic structure\n  if (mindMap.nodes.length === 0) {\n    mindMap.nodes = [\n      {\n        id: 'node_1',\n        title: originalInput.topic,\n        description: `Central concept for ${originalInput.topic}`,\n        parent_id: null,\n        type: 'root',\n        position: { x: 0, y: 0 }\n      },\n      {\n        id: 'node_2',\n        title: 'Key Concepts',\n        description: 'Important concepts to understand',\n        parent_id: 'node_1',\n        type: 'category',\n        position: { x: -200, y: 100 }\n      },\n      {\n        id: 'node_3',\n        title: 'Applications',\n        description: 'Practical applications and use cases',\n        parent_id: 'node_1',\n        type: 'category',\n        position: { x: 200, y: 100 }\n      }\n    ];\n  }\n  \n} catch (e) {\n  console.error('Error processing Ollama results:', e);\n}\n\n// Helper function to calculate node positions\nfunction calculateNodePosition(index) {\n  const angle = (index * 2 * Math.PI) / 8;\n  const radius = 150 + (Math.floor(index / 8) * 100);\n  return {\n    x: Math.cos(angle) * radius,\n    y: Math.sin(angle) * radius\n  };\n}\n\n// Add summary statistics\nmindMap.statistics = {\n  total_nodes: mindMap.nodes.length,\n  total_relationships: mindMap.relationships.length,\n  max_depth: calculateMaxDepth(mindMap.nodes),\n  node_types: countNodeTypes(mindMap.nodes)\n};\n\nfunction calculateMaxDepth(nodes) {\n  let maxDepth = 0;\n  nodes.forEach(node => {\n    let depth = 0;\n    let current = node;\n    while (current.parent_id) {\n      depth++;\n      current = nodes.find(n => n.id === current.parent_id);\n      if (!current) break;\n    }\n    maxDepth = Math.max(maxDepth, depth);\n  });\n  return maxDepth;\n}\n\nfunction countNodeTypes(nodes) {\n  const types = {};\n  nodes.forEach(node => {\n    types[node.type] = (types[node.type] || 0) + 1;\n  });\n  return types;\n}\n\nreturn [{ json: mindMap }];"
      },
      "id": "process-results",
      "name": "Process Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mindmaps (id, user_id, title, data, created_at, updated_at) VALUES ($1, $2, $3, $4, NOW(), NOW()) RETURNING *",
        "additionalFields": {
          "queryParams": "={{ [$json.id, $json.user_id, $json.title, JSON.stringify($json)] }}"
        }
      },
      "id": "save-mindmap",
      "name": "Save Mind Map",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1250, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-mind-maps",
          "name": "Mind Maps DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare text for embedding generation using shared workflow\nconst mindMap = items[0].json;\nconst textToEmbed = mindMap.nodes.map(n => n.title + ' ' + n.description).join(' ');\n\nreturn [{\n  json: {\n    text: textToEmbed,\n    model: 'nomic-embed-text',\n    store_in_qdrant: true,\n    collection: 'mind_maps',\n    metadata: {\n      mindmap_id: mindMap.id,\n      user_id: mindMap.user_id,\n      topic: mindMap.title\n    },\n    return_embedding: true\n  }\n}];"
      },
      "id": "prepare-embedding",
      "name": "Prepare Embedding",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "source": "workflowByName",
        "workflowName": "Shared Text Embedding Generator"
      },
      "id": "generate-embeddings",
      "name": "Generate Embeddings",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for Qdrant CLI command\nconst mindMapData = $('process-results').item.json;\nconst embedding = $json.embedding || $json.vector || [];\n\n// Build the point data for Qdrant\nconst point = {\n  id: mindMapData.id,\n  payload: {\n    mindmap_id: mindMapData.id,\n    user_id: mindMapData.user_id,\n    title: mindMapData.title,\n    node_count: mindMapData.statistics.total_nodes,\n    created_at: new Date().toISOString()\n  },\n  vector: embedding\n};\n\n// Create temp file for the point data\nconst timestamp = Date.now();\nconst randomId = Math.random().toString(36).substring(2, 8);\nconst tempFile = `/tmp/qdrant_mindmap_${timestamp}_${randomId}.json`;\n\nreturn [{\n  json: {\n    point: point,\n    tempFile: tempFile,\n    collection: 'mind_maps'\n  }\n}];"
      },
      "id": "prepare-qdrant-data",
      "name": "Prepare Qdrant Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "command": "bash -c \"point_file='{{ $json.tempFile }}'; echo '{{ JSON.stringify($json.point) }}' > \\\"$point_file\\\"; vrooli resource qdrant upsert {{ $json.collection }} \\\"$(cat \\\"$point_file\\\")\\\"; rm -f \\\"$point_file\\\"\"",
        "options": {}
      },
      "id": "store-in-qdrant",
      "name": "Store in Qdrant via CLI",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "content": "={{ JSON.stringify($('process-results').item.json, null, 2) }}",
        "key": "={{ `mind-maps:cache:${$('process-results').item.json.id}` }}",
        "ttl": 3600,
        "options": {}
      },
      "id": "cache-mindmap",
      "name": "Cache Mind Map",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1450, 500],
      "credentials": {
        "redis": {
          "id": "redis-mind-maps",
          "name": "Mind Maps Redis"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare final response\nconst mindMap = $('process-results').item.json;\nconst embedding = $('generate-embeddings').item.json;\n\nreturn [{\n  json: {\n    success: true,\n    mindmap: {\n      id: mindMap.id,\n      title: mindMap.title,\n      url: `${service.ui.url}/mindmap/${mindMap.id}`,\n      statistics: mindMap.statistics,\n      nodes_preview: mindMap.nodes.slice(0, 5).map(n => ({\n        title: n.title,\n        type: n.type\n      }))\n    },\n    message: `Successfully created mind map with ${mindMap.statistics.total_nodes} nodes and ${mindMap.statistics.total_relationships} relationships`,\n    ai_insights: {\n      complexity: mindMap.statistics.max_depth > 3 ? 'high' : mindMap.statistics.max_depth > 1 ? 'medium' : 'low',\n      coverage: mindMap.statistics.total_nodes > 20 ? 'comprehensive' : mindMap.statistics.total_nodes > 10 ? 'good' : 'basic',\n      searchable: true\n    }\n  }\n}];"
      },
      "id": "prepare-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2050, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [[{"node": "prepare-ollama-prompt", "type": "main", "index": 0}]]
    },
    "manual-trigger": {
      "main": [[{"node": "defaults", "type": "main", "index": 0}]]
    },
    "defaults": {
      "main": [[{"node": "prepare-ollama-prompt", "type": "main", "index": 0}]]
    },
    "prepare-ollama-prompt": {
      "main": [[{"node": "execute-ollama", "type": "main", "index": 0}]]
    },
    "execute-ollama": {
      "main": [[{"node": "process-results", "type": "main", "index": 0}]]
    },
    "process-results": {
      "main": [[
        {"node": "save-mindmap", "type": "main", "index": 0},
        {"node": "prepare-embedding", "type": "main", "index": 0},
        {"node": "cache-mindmap", "type": "main", "index": 0}
      ]]
    },
    "prepare-embedding": {
      "main": [[{"node": "generate-embeddings", "type": "main", "index": 0}]]
    },
    "save-mindmap": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "generate-embeddings": {
      "main": [[{"node": "prepare-qdrant-data", "type": "main", "index": 0}]]
    },
    "prepare-qdrant-data": {
      "main": [[{"node": "store-in-qdrant", "type": "main", "index": 0}]]
    },
    "store-in-qdrant": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "cache-mindmap": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "prepare-response": {
      "main": [[{"node": "respond", "type": "main", "index": 0}]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["mind-maps", "ai-generation", "react-loop", "intelligent"],
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "mind-maps-intelligent-builder"
  }
}