{
  "name": "mind-maps-document-to-mindmap",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mind-maps/document-to-map",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={\n  \"document\": \"Machine learning is a subset of artificial intelligence that enables systems to learn from data. Deep learning uses neural networks with multiple layers. Transformers have revolutionized natural language processing by using self-attention mechanisms. Computer vision applications include image classification, object detection, and segmentation.\",\n  \"mapId\": \"test-map-doc\",\n  \"userId\": \"test-user\",\n  \"extractionMode\": \"entities_and_relationships\"\n}",
        "options": {}
      },
      "id": "provide-defaults",
      "name": "Provide Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.all()[0].json;\n\nif (!input.document) {\n  throw new Error('Document content is required');\n}\n\nreturn {\n  document: input.document,\n  mapId: input.mapId || `map_doc_${Date.now()}`,\n  userId: input.userId || 'anonymous',\n  extractionMode: input.extractionMode || 'entities_and_relationships',\n  maxNodes: input.maxNodes || 30,\n  // Data for structured data extractor workflow\n  extractorInput: {\n    text: input.document,\n    extraction_type: input.extractionMode || 'entities_and_relationships',\n    model: 'llama3.2',\n    output_format: 'json'\n  }\n};"
      },
      "id": "merge-inputs",
      "name": "Merge Inputs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "source": "workflowByName",
        "workflowName": "Structured Data Extractor",
        "workflowValues": "={{ JSON.stringify($json.extractorInput) }}"
      },
      "id": "extract-structure",
      "name": "Extract Structured Data",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "const extractedData = $json;\nconst input = $('merge-inputs').item.json;\n\n// Process extracted entities into mind map nodes\nlet nodes = [];\nlet relationships = [];\nlet nodeIdMap = {};\n\n// Parse extraction results\nlet entities = [];\nlet relations = [];\n\ntry {\n  if (extractedData.extracted_data) {\n    const data = typeof extractedData.extracted_data === 'string' \n      ? JSON.parse(extractedData.extracted_data) \n      : extractedData.extracted_data;\n    entities = data.entities || [];\n    relations = data.relationships || [];\n  } else if (extractedData.entities) {\n    entities = extractedData.entities;\n    relations = extractedData.relationships || [];\n  }\n} catch (e) {\n  console.error('Failed to parse extracted data:', e);\n}\n\n// Create root node\nconst rootId = 'root_' + Date.now();\nnodes.push({\n  id: rootId,\n  title: 'Document Structure',\n  description: 'Extracted knowledge from document',\n  parent_id: null,\n  type: 'root',\n  metadata: { source: 'document_extraction' }\n});\n\n// Create nodes from entities\nentities.forEach((entity, index) => {\n  const nodeId = `node_${index + 1}`;\n  nodeIdMap[entity.name || entity.text || entity.label] = nodeId;\n  \n  nodes.push({\n    id: nodeId,\n    title: entity.name || entity.text || entity.label || `Entity ${index + 1}`,\n    description: entity.description || entity.context || '',\n    parent_id: rootId,\n    type: entity.type || 'concept',\n    metadata: {\n      confidence: entity.confidence || 0.8,\n      source: 'extracted'\n    }\n  });\n});\n\n// Create relationships\nrelations.forEach((rel, index) => {\n  const sourceId = nodeIdMap[rel.source] || nodeIdMap[rel.from];\n  const targetId = nodeIdMap[rel.target] || nodeIdMap[rel.to];\n  \n  if (sourceId && targetId) {\n    relationships.push({\n      id: `rel_${index + 1}`,\n      source_id: sourceId,\n      target_id: targetId,\n      type: rel.type || rel.relationship || 'related',\n      label: rel.label || ''\n    });\n  }\n});\n\n// Limit nodes if necessary\nif (nodes.length > input.maxNodes) {\n  nodes = nodes.slice(0, input.maxNodes);\n}\n\nreturn {\n  mapId: input.mapId,\n  userId: input.userId,\n  nodes: nodes,\n  relationships: relationships,\n  metadata: {\n    extraction_mode: input.extractionMode,\n    total_entities: entities.length,\n    total_relationships: relations.length,\n    created_at: new Date().toISOString()\n  }\n};"
      },
      "id": "build-mindmap",
      "name": "Build Mind Map Structure",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for RAG pipeline\nconst mindMapData = $json;\nconst originalInput = $('merge-inputs').item.json;\n\nreturn {\n  mindMapData: mindMapData,\n  ragInput: {\n    query: \"Find additional context and relationships for: \" + mindMapData.nodes.map(n => n.title).slice(0, 5).join(', '),\n    documents: [originalInput.document],\n    model: 'llama3.2',\n    use_embeddings: true\n  }\n};"
      },
      "id": "prepare-rag-input",
      "name": "Prepare RAG Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "source": "workflowByName",
        "workflowName": "Universal RAG Pipeline",
        "workflowValues": "={{ JSON.stringify($json.ragInput) }}"
      },
      "id": "enrich-with-rag",
      "name": "Enrich with RAG Pipeline",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "jsCode": "const mindMap = $('prepare-rag-input').item.json.mindMapData;\nconst ragResults = $json;\n\n// Enrich mind map with RAG insights\nif (ragResults.answer || ragResults.context) {\n  const insights = ragResults.answer || ragResults.context || '';\n  \n  // Add an insights node if we have valuable context\n  if (insights.length > 50) {\n    mindMap.nodes.push({\n      id: 'insights_node',\n      title: 'Additional Insights',\n      description: insights.substring(0, 500),\n      parent_id: mindMap.nodes[0].id,\n      type: 'insight',\n      metadata: {\n        source: 'rag_pipeline',\n        confidence: ragResults.confidence || 0.7\n      }\n    });\n  }\n}\n\n// Add metadata about RAG enrichment\nmindMap.metadata.rag_enriched = true;\nmindMap.metadata.rag_success = ragResults.success || false;\n\nreturn mindMap;"
      },
      "id": "merge-enrichment",
      "name": "Merge Enrichment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mind_maps (id, user_id, title, data, created_at, updated_at)\nVALUES ($1, $2, $3, $4, NOW(), NOW())\nON CONFLICT (id) DO UPDATE\nSET data = $4, updated_at = NOW()\nRETURNING *;",
        "options": {
          "queryParams": "={{ $json.mapId }}, {{ $json.userId }}, Document Mind Map, {{ JSON.stringify({ nodes: $json.nodes, relationships: $json.relationships }) }}"
        }
      },
      "id": "save-to-db",
      "name": "Save to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1850, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-default",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare data for embedding generation using shared workflow\nconst mindMapData = $('merge-enrichment').item.json;\nconst textToEmbed = mindMapData.nodes.map(n => n.title + ' ' + n.description).join(' ');\n\nreturn {\n  text: textToEmbed,\n  model: 'nomic-embed-text',\n  store_in_qdrant: true,\n  collection: 'mind_maps',\n  point_id: mindMapData.mapId,\n  payload: { map_id: mindMapData.mapId }\n};"
      },
      "id": "prepare-embeddings",
      "name": "Prepare Embedding Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 250]
    },
    {
      "parameters": {
        "source": "workflowByName",
        "workflowName": "Shared Text Embedding Generator",
        "workflowValues": "={{ JSON.stringify($json) }}"
      },
      "id": "generate-embeddings",
      "name": "Generate Embeddings",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [2050, 250]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"mapId\": $('merge-enrichment').item.json.mapId, \"statistics\": { \"nodes\": $('merge-enrichment').item.json.nodes.length, \"relationships\": $('merge-enrichment').item.json.relationships.length }, \"message\": \"Successfully converted document to mind map\", \"metadata\": $('merge-enrichment').item.json.metadata } }}",
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2050, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "merge-inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual-trigger": {
      "main": [
        [
          {
            "node": "provide-defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "provide-defaults": {
      "main": [
        [
          {
            "node": "merge-inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "merge-inputs": {
      "main": [
        [
          {
            "node": "extract-structure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extract-structure": {
      "main": [
        [
          {
            "node": "build-mindmap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build-mindmap": {
      "main": [
        [
          {
            "node": "prepare-rag-input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-rag-input": {
      "main": [
        [
          {
            "node": "enrich-with-rag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enrich-with-rag": {
      "main": [
        [
          {
            "node": "merge-enrichment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "merge-enrichment": {
      "main": [
        [
          {
            "node": "save-to-db",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save-to-db": {
      "main": [
        [
          {
            "node": "generate-embeddings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate-embeddings": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "pinData": {},
  "active": true
}