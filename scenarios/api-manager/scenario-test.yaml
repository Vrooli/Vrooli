name: api-manager
description: API Manager scenario validation tests

setup:
  - name: Check database connection
    type: api
    endpoint: http://localhost:8421/api/v1/health
    method: GET
    expect:
      status: 200
      json:
        status: "ok"
        service: "api-manager"

  - name: Check UI accessibility
    type: http
    url: http://localhost:8420/health
    method: GET
    expect:
      status: 200
      json:
        status: "ok"
        service: "api-manager-ui"

tests:
  - name: List scenarios endpoint
    type: api
    endpoint: http://localhost:8421/api/v1/scenarios
    method: GET
    expect:
      status: 200
      json:
        scenarios: []
        count: 0

  - name: System status endpoint
    type: api
    endpoint: http://localhost:8421/api/v1/system/status
    method: GET
    expect:
      status: 200
      json:
        service: "api-manager"
        status: "operational"

  - name: Vulnerabilities endpoint
    type: api
    endpoint: http://localhost:8421/api/v1/vulnerabilities
    method: GET
    expect:
      status: 200
      json:
        vulnerabilities: []
        count: 0

  - name: Discovery trigger
    type: api
    endpoint: http://localhost:8421/api/v1/system/discover
    method: POST
    expect:
      status: 200
      json:
        status: "discovery_initiated"

  - name: CLI health check
    type: command
    command: api-manager health
    expect:
      exit_code: 0
      stdout_contains: "API Manager is healthy"

  - name: CLI scenarios list
    type: command
    command: api-manager list scenarios
    expect:
      exit_code: 0
      stdout_contains: "Scenarios"

  - name: Web dashboard accessibility
    type: http
    url: http://localhost:8420
    method: GET
    expect:
      status: 200
      content_type: "text/html"
      body_contains: "Vrooli API Manager"

validation:
  - name: Database schema exists
    type: sql
    query: "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('scenarios', 'api_endpoints', 'vulnerability_scans')"
    expect:
      row_count: 3

  - name: API server responds to all endpoints
    type: multi_api
    endpoints:
      - /api/v1/health
      - /api/v1/scenarios
      - /api/v1/vulnerabilities
      - /api/v1/system/status
    base_url: http://localhost:8421
    expect_all:
      status: 200

integration:
  - name: N8n workflow deployment
    type: command
    command: resource-n8n list-workflows | grep -E "(API Scanner|Security Audit)"
    expect:
      exit_code: 0

  - name: Resource connectivity
    type: multi_command
    commands:
      - resource-postgres status
      - resource-ollama status  
      - resource-n8n status
    expect_all:
      exit_code: 0

performance:
  - name: API response time
    type: api
    endpoint: http://localhost:8421/api/v1/health
    method: GET
    expect:
      response_time_ms: < 500

  - name: UI load time
    type: http
    url: http://localhost:8420
    method: GET
    expect:
      response_time_ms: < 1000