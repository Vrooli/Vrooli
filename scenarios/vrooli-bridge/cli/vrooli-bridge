#!/bin/bash

# Vrooli Bridge CLI
# Manages Vrooli integrations for external projects

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
API_BASE="http://localhost:${API_PORT:-8080}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if API is running
check_api() {
    if ! curl -sf "${API_BASE}/health" >/dev/null 2>&1; then
        log_error "Vrooli Bridge API is not running or not accessible at ${API_BASE}"
        log_info "Try running: vrooli scenario run vrooli-bridge"
        exit 1
    fi
}

# Show help
show_help() {
    cat << 'EOF'
Vrooli Bridge CLI - Manage Vrooli integrations for external projects

USAGE:
    vrooli-bridge [COMMAND] [OPTIONS]

COMMANDS:
    scan [PATH]              Scan directory for projects (default: ~)
        --depth N            Maximum scan depth (default: 3)
        --type TYPE          Filter by project type
    
    list                     List all discovered projects
        --status STATUS      Filter by status (active|outdated|missing|error)
        --type TYPE          Filter by project type
        --json               Output in JSON format
    
    integrate PROJECT_PATH   Add Vrooli integration to a project
        --force              Overwrite existing integration
    
    update [PROJECT_PATH]    Update Vrooli docs (all projects if no path)
    
    remove PROJECT_PATH      Remove Vrooli integration from project
    
    status                   Show integration statistics
        --json               Output in JSON format
        --verbose            Show detailed information
    
    version                  Show version information
    
    help                     Show this help message

EXAMPLES:
    # Scan home directory for projects
    vrooli-bridge scan
    
    # Scan specific directory with custom depth
    vrooli-bridge scan /workspace --depth 2
    
    # List all projects
    vrooli-bridge list
    
    # List only NPM projects that are integrated
    vrooli-bridge list --type npm --status active
    
    # Integrate a specific project
    vrooli-bridge integrate /path/to/project
    
    # Update all project integrations
    vrooli-bridge update
    
    # Show detailed status
    vrooli-bridge status --verbose

EOF
}

# API call helper
api_call() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    
    if [ "$method" = "GET" ]; then
        curl -sf "${API_BASE}${endpoint}"
    else
        curl -sf -X "$method" -H "Content-Type: application/json" \
             -d "$data" "${API_BASE}${endpoint}"
    fi
}

# Scan for projects
cmd_scan() {
    local path="$1"
    local depth="3"
    local type=""
    
    # Parse options
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --depth)
                depth="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    if [ -z "$path" ]; then
        path="$HOME"
    fi
    
    log_info "Scanning $path (depth: $depth)..."
    
    local json="{\"directories\":[\"$path\"],\"depth\":$depth}"
    local result
    
    if result=$(api_call "POST" "/api/v1/projects/scan" "$json"); then
        local found=$(echo "$result" | jq -r '.found // 0')
        local new=$(echo "$result" | jq -r '.new // 0')
        
        log_success "Found $found projects ($new new)"
        
        if [ "$new" -gt 0 ]; then
            log_info "Run 'vrooli-bridge list' to see all projects"
        fi
    else
        log_error "Scan failed"
        exit 1
    fi
}

# List projects
cmd_list() {
    local status=""
    local type=""
    local json_output=false
    
    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --status)
                status="$2"
                shift 2
                ;;
            --type)
                type="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    local result
    if result=$(api_call "GET" "/api/v1/projects"); then
        if [ "$json_output" = true ]; then
            echo "$result"
        else
            # Format for human reading
            echo "$result" | jq -r '
                .projects[] | 
                select(
                    (if $status then .integration_status == $status else true end) and
                    (if $type then .type == $type else true end)
                ) |
                "\(.name)\t\(.type)\t\(.integration_status)\t\(.path)"
            ' --arg status "$status" --arg type "$type" | \
            column -t -s $'\t' -N "NAME,TYPE,STATUS,PATH"
        fi
    else
        log_error "Failed to list projects"
        exit 1
    fi
}

# Integrate a project
cmd_integrate() {
    local project_path="$1"
    local force=false
    
    if [ -z "$project_path" ]; then
        log_error "Project path is required"
        exit 1
    fi
    
    # Parse options
    shift
    while [[ $# -gt 0 ]]; do
        case $1 in
            --force)
                force=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    # Find project by path
    local project_id
    if ! project_id=$(api_call "GET" "/api/v1/projects" | jq -r ".projects[] | select(.path == \"$project_path\") | .id"); then
        log_error "Failed to find project"
        exit 1
    fi
    
    if [ -z "$project_id" ] || [ "$project_id" = "null" ]; then
        log_error "Project not found: $project_path"
        log_info "Run 'vrooli-bridge scan' to discover projects first"
        exit 1
    fi
    
    log_info "Integrating project at $project_path..."
    
    local json="{\"force\":$force}"
    local result
    
    if result=$(api_call "POST" "/api/v1/projects/$project_id/integrate" "$json"); then
        local files_created=$(echo "$result" | jq -r '.files_created[]?' 2>/dev/null || echo "")
        local files_updated=$(echo "$result" | jq -r '.files_updated[]?' 2>/dev/null || echo "")
        
        log_success "Integration completed"
        
        if [ -n "$files_created" ]; then
            log_info "Files created:"
            echo "$files_created" | while read -r file; do
                echo "  + $file"
            done
        fi
        
        if [ -n "$files_updated" ]; then
            log_info "Files updated:"
            echo "$files_updated" | while read -r file; do
                echo "  ~ $file"
            done
        fi
    else
        log_error "Integration failed"
        exit 1
    fi
}

# Show status
cmd_status() {
    local json_output=false
    local verbose=false
    
    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --json)
                json_output=true
                shift
                ;;
            --verbose)
                verbose=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    local result
    if result=$(api_call "GET" "/api/v1/projects"); then
        if [ "$json_output" = true ]; then
            echo "$result" | jq '{
                total: (.projects | length),
                active: (.projects | map(select(.integration_status == "active")) | length),
                outdated: (.projects | map(select(.integration_status == "outdated")) | length),
                missing: (.projects | map(select(.integration_status == "missing")) | length),
                error: (.projects | map(select(.integration_status == "error")) | length)
            }'
        else
            local total=$(echo "$result" | jq '.projects | length')
            local active=$(echo "$result" | jq '.projects | map(select(.integration_status == "active")) | length')
            local outdated=$(echo "$result" | jq '.projects | map(select(.integration_status == "outdated")) | length')
            local missing=$(echo "$result" | jq '.projects | map(select(.integration_status == "missing")) | length')
            local errors=$(echo "$result" | jq '.projects | map(select(.integration_status == "error")) | length')
            
            echo "Vrooli Bridge Status"
            echo "===================="
            echo "Total Projects:    $total"
            echo "Active:           $active"
            echo "Outdated:         $outdated"
            echo "Not Integrated:   $missing"
            echo "Errors:           $errors"
            
            if [ "$verbose" = true ]; then
                echo ""
                echo "Project Breakdown by Type:"
                echo "$result" | jq -r '
                    .projects | group_by(.type) | 
                    .[] | "\(.[0].type): \(length) projects"
                '
            fi
        fi
    else
        log_error "Failed to get status"
        exit 1
    fi
}

# Show version
cmd_version() {
    echo "Vrooli Bridge CLI v1.0.0"
    
    # Try to get API version too
    if curl -sf "${API_BASE}/health" >/dev/null 2>&1; then
        local api_version
        api_version=$(curl -sf "${API_BASE}/health" | jq -r '.version // "unknown"')
        echo "API Version: $api_version"
    else
        echo "API: Not running"
    fi
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    local command="$1"
    shift
    
    # Commands that don't need API
    case "$command" in
        help|--help|-h)
            show_help
            exit 0
            ;;
        version|--version|-v)
            cmd_version
            exit 0
            ;;
    esac
    
    # Check API availability for other commands
    check_api
    
    case "$command" in
        scan)
            cmd_scan "$@"
            ;;
        list)
            cmd_list "$@"
            ;;
        integrate)
            cmd_integrate "$@"
            ;;
        update)
            log_warning "Update command not yet implemented"
            exit 1
            ;;
        remove)
            log_warning "Remove command not yet implemented"
            exit 1
            ;;
        status)
            cmd_status "$@"
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"