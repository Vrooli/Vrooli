# Prompt Manager Makefile
# Comprehensive management interface for the prompt-manager scenario

SCENARIO_NAME := prompt-manager
VROOLI_CMD := vrooli scenario

# Color codes for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

.PHONY: help
help: ## Show this help message
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘           ğŸ“ Prompt Manager - Make Commands ğŸ“              â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Available commands:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)Examples:$(NC)"
	@echo "  make setup      # Initial setup of the scenario"
	@echo "  make run        # Start the scenario"
	@echo "  make test       # Run tests"
	@echo "  make logs       # View logs"
	@echo "  make stop       # Stop the scenario"

.PHONY: setup
setup: ## Initial setup and build
	@echo "$(GREEN)ğŸ”§ Setting up Prompt Manager...$(NC)"
	@$(VROOLI_CMD) setup $(SCENARIO_NAME)
	@echo "$(GREEN)âœ… Setup complete!$(NC)"

.PHONY: run
run: ## Start the scenario
	@echo "$(GREEN)ğŸš€ Starting Prompt Manager...$(NC)"
	@$(VROOLI_CMD) start $(SCENARIO_NAME)
	@echo ""
	@echo "$(GREEN)âœ… Prompt Manager is running!$(NC)"
	@echo "$(BLUE)ğŸ“ Dashboard: http://localhost:$${UI_PORT:-35000}$(NC)"
	@echo "$(BLUE)ğŸ“ API: http://localhost:$${API_PORT:-15000}$(NC)"
	@echo "$(BLUE)ğŸ“ CLI: prompt-manager --help$(NC)"

.PHONY: start
start: run ## Alias for 'run'

.PHONY: stop
stop: ## Stop the scenario
	@echo "$(YELLOW)â¹ï¸  Stopping Prompt Manager...$(NC)"
	@$(VROOLI_CMD) stop $(SCENARIO_NAME)
	@echo "$(GREEN)âœ… Stopped$(NC)"

.PHONY: restart
restart: stop run ## Restart the scenario

.PHONY: status
status: ## Check scenario status
	@echo "$(BLUE)ğŸ“Š Checking Prompt Manager status...$(NC)"
	@$(VROOLI_CMD) status $(SCENARIO_NAME) || true
	@echo ""
	@echo "$(BLUE)ğŸ” Process status:$(NC)"
	@ps aux | grep -E "prompt-manager-api|scenarios/prompt-manager.*server\.js" | grep -v grep || echo "  No processes running"

.PHONY: logs
logs: ## View scenario logs
	@echo "$(BLUE)ğŸ“‹ Prompt Manager logs:$(NC)"
	@$(VROOLI_CMD) logs $(SCENARIO_NAME)

.PHONY: test
test: ## Run tests for this scenario
	@echo "$(BLUE)ğŸ§ª Testing $(SCENARIO_NAME) scenario...$(RESET)"
	@vrooli scenario test $(SCENARIO_NAME)

.PHONY: clean
clean: ## Clean build artifacts and data
	@echo "$(YELLOW)ğŸ§¹ Cleaning Prompt Manager...$(NC)"
	@rm -rf api/prompt-manager-api
	@rm -rf ui/node_modules
	@rm -rf data/campaigns/*
	@echo "$(GREEN)âœ… Cleaned$(NC)"

.PHONY: reset
reset: stop clean setup ## Full reset (stop, clean, setup)
	@echo "$(GREEN)âœ… Prompt Manager has been reset$(NC)"

.PHONY: build-api
build-api: ## Build API binary
	@echo "$(BLUE)ğŸ”¨ Building API...$(NC)"
	@cd api && go mod download && go build -o prompt-manager-api .
	@echo "$(GREEN)âœ… API built$(NC)"

.PHONY: build-ui
build-ui: ## Build UI
	@echo "$(BLUE)ğŸ”¨ Building UI...$(NC)"
	@cd ui && npm install
	@echo "$(GREEN)âœ… UI dependencies installed$(NC)"

.PHONY: dev
dev: ## Start in development mode with live logs
	@echo "$(GREEN)ğŸ”§ Starting Prompt Manager in development mode...$(NC)"
	@$(VROOLI_CMD) develop $(SCENARIO_NAME)

.PHONY: cli-test
cli-test: ## Test CLI commands
	@echo "$(BLUE)ğŸ§ª Testing CLI...$(NC)"
	@prompt-manager status || echo "$(YELLOW)âš ï¸  CLI not installed or service not running$(NC)"
	@prompt-manager list-campaigns || true
	@echo "$(GREEN)âœ… CLI test complete$(NC)"

.PHONY: health
health: ## Check health endpoints
	@echo "$(BLUE)ğŸ¥ Checking health...$(NC)"
	@curl -sf http://localhost:$${API_PORT:-15000}/health | jq '.' || echo "$(RED)âŒ API not responding$(NC)"
	@curl -sf http://localhost:$${UI_PORT:-35000}/health | jq '.' || echo "$(RED)âŒ UI not responding$(NC)"

.PHONY: db-status
db-status: ## Check database connection
	@echo "$(BLUE)ğŸ—„ï¸  Checking database status...$(NC)"
	@curl -sf http://localhost:$${API_PORT:-15000}/health | jq '.services.database' || echo "$(RED)âŒ Cannot check database status$(NC)"

.PHONY: quick-test
quick-test: ## Quick API test
	@echo "$(BLUE)âš¡ Quick API test...$(NC)"
	@curl -sf http://localhost:$${API_PORT:-15000}/api/v1/campaigns | jq '.' || echo "$(RED)âŒ API test failed$(NC)"
	@echo "$(GREEN)âœ… Quick test complete$(NC)"

# Default target
.DEFAULT_GOAL := help