version: 1.0
scenario: scenario-to-extension

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - README.md
    - api/main.go
    - api/go.mod
    - cli/scenario-to-extension
    - cli/install.sh
    - templates/vanilla/manifest.json
    - templates/vanilla/background.js
    - templates/vanilla/content.js
    - templates/vanilla/popup.html
    - templates/vanilla/popup.js
    - templates/vanilla/build.js
    - templates/vanilla/package.json
    - templates/vanilla/README.md
    - templates/advanced/content-script-only.json
    - templates/advanced/background-only.json
    - templates/advanced/popup-only.json
    - prompts/extension-creation-prompt.md
    - prompts/extension-debugging-prompt.md
    - initialization/n8n/extension-testing.json
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - templates
    - templates/vanilla
    - templates/advanced
    - prompts
    - initialization
    - initialization/n8n
    - ui
    - test
    - data

# Resource validation
resources:
  required: 
    - browserless
  optional: 
    - postgres
    - redis
  health_timeout: 90

# Declarative tests
tests:
  # Resource health checks
  - name: "Browserless is accessible and responsive"
    type: http
    service: browserless
    endpoint: /health
    method: GET
    expect:
      status: 200
      timeout: 10

  # API endpoint tests  
  - name: "Extension generation API endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/extension/generate
    method: POST
    headers:
      Content-Type: application/json
    body:
      scenario_name: "test-scenario"
      template_type: "popup-only"
      config:
        app_name: "Test Extension"
        description: "Test extension for validation"
        api_endpoint: "http://localhost:3000"
        permissions: ["storage", "activeTab"]
        host_permissions: ["https://example.com/*"]
    expect:
      status: 201
      body_contains: ["build_id", "extension_path"]
      timeout: 30

  - name: "Extension status API endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/extension/status/test-build-123
    method: GET
    expect:
      status: [200, 404]  # 404 is acceptable if build doesn't exist
      timeout: 5

  - name: "Extension testing API endpoint exists"
    type: http
    service: api
    endpoint: /api/v1/extension/test
    method: POST
    headers:
      Content-Type: application/json
    body:
      extension_path: "/tmp/test-extension"
      test_sites: ["https://example.com"]
      screenshot: true
    expect:
      status: [200, 400]  # 400 is acceptable if path doesn't exist
      timeout: 15

  # CLI command tests
  - name: "CLI binary exists and is executable"
    type: exec
    command: ls -la ./cli/scenario-to-extension
    expect:
      exit_code: 0
      output_contains: ["-rwxr-xr-x", "scenario-to-extension"]

  - name: "CLI help command works"
    type: exec
    command: ./cli/scenario-to-extension help
    expect:
      exit_code: 0
      output_contains: ["generate", "build", "test", "status"]

  - name: "CLI status command executes"
    type: exec
    command: ./cli/scenario-to-extension status --json
    expect:
      exit_code: 0
      output_contains: ["status", "version"]
      timeout: 10

  - name: "CLI generate command validates input"
    type: exec
    command: ./cli/scenario-to-extension generate --help
    expect:
      exit_code: 0
      output_contains: ["--template", "--permissions", "--output"]

  # Template validation tests
  - name: "Vanilla template manifest validates"
    type: exec
    command: node -e "JSON.parse(require('fs').readFileSync('./templates/vanilla/manifest.json', 'utf8')); console.log('Valid JSON')"
    expect:
      exit_code: 0
      output_contains: ["Valid JSON"]

  - name: "Vanilla template background.js has no syntax errors"
    type: exec
    command: node -c ./templates/vanilla/background.js
    expect:
      exit_code: 0

  - name: "Vanilla template content.js has no syntax errors"  
    type: exec
    command: node -c ./templates/vanilla/content.js
    expect:
      exit_code: 0

  - name: "Vanilla template popup.js has no syntax errors"
    type: exec
    command: node -c ./templates/vanilla/popup.js
    expect:
      exit_code: 0

  - name: "Advanced template configs are valid JSON"
    type: exec
    command: |
      for template in ./templates/advanced/*.json; do
        node -e "JSON.parse(require('fs').readFileSync('$template', 'utf8')); console.log('$template: Valid')"
      done
    expect:
      exit_code: 0
      output_contains: ["Valid"]

  # N8n workflow validation
  - name: "Extension testing workflow is valid JSON"
    type: exec  
    command: node -e "JSON.parse(require('fs').readFileSync('./initialization/n8n/extension-testing.json', 'utf8')); console.log('Workflow valid')"
    expect:
      exit_code: 0
      output_contains: ["Workflow valid"]

  - name: "Extension testing workflow has required nodes"
    type: exec
    command: node -e "const wf = JSON.parse(require('fs').readFileSync('./initialization/n8n/extension-testing.json', 'utf8')); const nodes = wf.nodes.map(n => n.type); console.log('Nodes:', nodes.join(','))"
    expect:
      exit_code: 0
      output_contains: ["webhook", "function", "httpRequest"]

  # Integration tests with browserless
  - name: "Browserless can load a test page"
    type: http
    service: browserless
    endpoint: /content
    method: POST
    headers:
      Content-Type: application/json
    body:
      url: "https://example.com"
      options:
        screenshot:
          type: "png"
    expect:
      status: 200
      timeout: 15

  - name: "N8n extension testing workflow is accessible"
    type: http
    service: n8n
    endpoint: /webhook/extension-testing
    method: POST
    headers:
      Content-Type: application/json
    body:
      extension_path: "/tmp/test-extension"
      test_sites: ["https://example.com"]
      screenshot: true
    expect:
      status: [200, 404]  # 404 if workflow not deployed yet
      timeout: 20

  # File structure integrity tests
  - name: "All template variables are documented"
    type: exec
    command: |
      # Check that template variables in files have corresponding documentation
      grep -r "{{[A-Z_]*}}" templates/ | wc -l
    expect:
      exit_code: 0

  - name: "No hardcoded secrets in templates"
    type: exec  
    command: |
      # Ensure no actual API keys or secrets are hardcoded
      if grep -r -E "(api[_-]?key|secret|password|token).*['\"]?[a-zA-Z0-9]{20}" templates/; then
        echo "Potential hardcoded secret found"
        exit 1
      else
        echo "No hardcoded secrets detected"
      fi
    expect:
      exit_code: 0
      output_contains: ["No hardcoded secrets detected"]

  # Performance and quality tests
  - name: "Template files are reasonable size"
    type: exec
    command: |
      # Check that template files aren't unexpectedly large
      for file in templates/vanilla/*; do
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 1048576 ]; then  # 1MB limit
          echo "File $file is too large: ${size} bytes"
          exit 1
        fi
      done
      echo "All template files are reasonable size"
    expect:
      exit_code: 0
      output_contains: ["reasonable size"]

  - name: "PRD has all required sections"
    type: exec
    command: |
      required_sections="Capability Definition|Success Metrics|Technical Architecture|CLI Interface Contract"
      if grep -E "$required_sections" PRD.md > /dev/null; then
        echo "All required PRD sections present"
      else
        echo "Missing required PRD sections"
        exit 1
      fi
    expect:
      exit_code: 0
      output_contains: ["All required PRD sections present"]

# Performance validation
performance:
  extension_generation_time: 
    max_duration: "30s"
    test_command: "./cli/scenario-to-extension generate test-scenario --template popup-only"
  
  template_processing_time:
    max_duration: "5s"
    test_command: "node ./templates/vanilla/build.js"
    
  api_response_time:
    max_duration: "2s"
    endpoint: "/api/v1/extension/status/test"

# Security validation
security:
  permission_validation:
    description: "Ensure templates request minimal required permissions"
    test_command: |
      # Check that default templates don't request overly broad permissions
      if grep -r "<all_urls>" templates/vanilla/; then
        echo "WARNING: Template requests broad host permissions"
      fi
      echo "Permission check completed"
    
  csp_validation:
    description: "Ensure Content Security Policy is properly configured"
    test_command: |
      if grep -r "content_security_policy" templates/vanilla/manifest.json; then
        echo "CSP configured in manifest"
      else
        echo "WARNING: No CSP found in manifest template"
      fi

# Quality gates that must pass for scenario validation
quality_gates:
  manifest_validation: true
  template_syntax_check: true 
  api_integration_test: true
  cli_functionality_test: true
  browserless_integration_test: true
  n8n_workflow_validation: true
  security_audit: true
  performance_benchmark: true