#!/bin/bash

# Job-to-Scenario Pipeline CLI
# Manages job import, research, and proposal generation

set -euo pipefail

# Configuration
API_PORT="${API_PORT:-15500}"
API_BASE="http://localhost:${API_PORT}/api/v1"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Help function
show_help() {
    cat << EOF
Job-to-Scenario Pipeline CLI

Usage: $(basename "$0") <command> [options]

Commands:
    status              Show pipeline status and job counts
    import <source>     Import job from source (manual|screenshot|url)
    research            Run research on pending jobs
    approve <job-id>    Approve job for scenario generation
    list                List jobs by state
    view <job-id>       View job details
    proposal <job-id>   Generate proposal for job
    help                Show this help message

Import Options:
    --file <path>       Path to screenshot or text file
    --text <text>       Job description text
    --url <url>         URL to scrape (requires Huginn)

Research Options:
    --job-id <id>       Research specific job
    --batch-size <n>    Number of jobs to process (default: 5)

List Options:
    --state <state>     Filter by state (pending|researching|evaluated|approved|building|completed)
    --limit <n>         Number of results (default: 10)
    --json              Output as JSON

Examples:
    $(basename "$0") import manual --text "Build a React dashboard for analytics"
    $(basename "$0") import screenshot --file job-screenshot.png
    $(basename "$0") research --batch-size 10
    $(basename "$0") approve JOB-20250106-123456-001
    $(basename "$0") list --state evaluated
    $(basename "$0") proposal JOB-20250106-123456-001

EOF
}

# Check API health
check_api() {
    if ! curl -s "${API_BASE%/api/v1}/health" > /dev/null 2>&1; then
        echo -e "${RED}Error: API is not running on port ${API_PORT}${NC}"
        echo "Start it with: cd api && go run main.go"
        exit 1
    fi
}

# Status command
cmd_status() {
    check_api
    
    echo -e "${CYAN}Job Pipeline Status${NC}"
    echo
    
    # Get counts for each state
    for state in pending researching evaluated approved building completed; do
        response=$(curl -s "${API_BASE}/jobs?state=${state}")
        count=$(echo "$response" | jq -r '.total // 0')
        
        case "$state" in
            pending) color=$YELLOW ;;
            researching) color=$BLUE ;;
            evaluated) color=$PURPLE ;;
            approved) color=$CYAN ;;
            building) color=$YELLOW ;;
            completed) color=$GREEN ;;
            *) color=$NC ;;
        esac
        
        printf "${color}%-15s${NC}: %3d jobs\n" "$state" "$count"
    done
}

# Import command
cmd_import() {
    local source="${1:-}"
    shift || true
    
    if [ -z "$source" ]; then
        echo -e "${RED}Error: Source required${NC}"
        echo "Usage: $(basename "$0") import <source> [options]"
        echo "Sources: manual, screenshot, url"
        exit 1
    fi
    
    local data=""
    
    case "$source" in
        manual)
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --text)
                        data="$2"
                        shift 2
                        ;;
                    --file)
                        data=$(cat "$2")
                        shift 2
                        ;;
                    *)
                        echo -e "${RED}Unknown option: $1${NC}"
                        exit 1
                        ;;
                esac
            done
            
            if [ -z "$data" ]; then
                echo "Enter job description (Ctrl+D when done):"
                data=$(cat)
            fi
            ;;
            
        screenshot)
            local file=""
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --file)
                        file="$2"
                        shift 2
                        ;;
                    *)
                        echo -e "${RED}Unknown option: $1${NC}"
                        exit 1
                        ;;
                esac
            done
            
            if [ -z "$file" ] || [ ! -f "$file" ]; then
                echo -e "${RED}Error: Screenshot file required${NC}"
                echo "Usage: $(basename "$0") import screenshot --file <path>"
                exit 1
            fi
            
            # Convert to base64
            data=$(base64 -w 0 "$file")
            ;;
            
        url)
            echo -e "${YELLOW}URL import requires Huginn agent setup${NC}"
            echo "Huginn will automatically import jobs from configured RSS feeds"
            exit 0
            ;;
            
        *)
            echo -e "${RED}Error: Invalid source '$source'${NC}"
            echo "Valid sources: manual, screenshot, url"
            exit 1
            ;;
    esac
    
    check_api
    
    # Send to API
    response=$(curl -s -X POST "${API_BASE}/jobs/import" \
        -H "Content-Type: application/json" \
        -d "{\"source\": \"$source\", \"data\": \"$data\"}")
    
    job_id=$(echo "$response" | jq -r '.job_id')
    
    if [ -n "$job_id" ] && [ "$job_id" != "null" ]; then
        echo -e "${GREEN}✓ Job imported: $job_id${NC}"
    else
        echo -e "${RED}Error importing job${NC}"
        echo "$response"
        exit 1
    fi
}

# Research command
cmd_research() {
    local job_id=""
    local batch_size=5
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --job-id)
                job_id="$2"
                shift 2
                ;;
            --batch-size)
                batch_size="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
        esac
    done
    
    check_api
    
    if [ -n "$job_id" ]; then
        # Research specific job
        response=$(curl -s -X POST "${API_BASE}/jobs/${job_id}/research")
        status=$(echo "$response" | jq -r '.status')
        
        if [ "$status" = "researching" ]; then
            echo -e "${GREEN}✓ Started research for job $job_id${NC}"
        else
            echo -e "${RED}Error starting research${NC}"
            echo "$response"
            exit 1
        fi
    else
        # Research batch of pending jobs
        response=$(curl -s "${API_BASE}/jobs?state=pending")
        jobs=$(echo "$response" | jq -r '.jobs[:'"$batch_size"'] | .[].id')
        
        if [ -z "$jobs" ]; then
            echo "No pending jobs to research"
            exit 0
        fi
        
        count=0
        for job in $jobs; do
            response=$(curl -s -X POST "${API_BASE}/jobs/${job}/research")
            status=$(echo "$response" | jq -r '.status')
            
            if [ "$status" = "researching" ]; then
                echo -e "${GREEN}✓ Started research for $job${NC}"
                count=$((count + 1))
            else
                echo -e "${YELLOW}⚠ Failed to start research for $job${NC}"
            fi
        done
        
        echo -e "${GREEN}Started research for $count job(s)${NC}"
    fi
}

# Approve command
cmd_approve() {
    local job_id="${1:-}"
    
    if [ -z "$job_id" ]; then
        echo -e "${RED}Error: Job ID required${NC}"
        echo "Usage: $(basename "$0") approve <job-id>"
        exit 1
    fi
    
    check_api
    
    response=$(curl -s -X POST "${API_BASE}/jobs/${job_id}/approve")
    state=$(echo "$response" | jq -r '.state')
    
    if [ "$state" = "building" ]; then
        echo -e "${GREEN}✓ Job approved and building: $job_id${NC}"
        echo "Estimated completion: $(echo "$response" | jq -r '.estimated_completion')"
    else
        echo -e "${RED}Error approving job${NC}"
        echo "$response"
        exit 1
    fi
}

# List command
cmd_list() {
    local state=""
    local limit=10
    local json_output=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --state)
                state="$2"
                shift 2
                ;;
            --limit)
                limit="$2"
                shift 2
                ;;
            --json)
                json_output=true
                shift
                ;;
            *)
                echo -e "${RED}Unknown option: $1${NC}"
                exit 1
                ;;
        esac
    done
    
    check_api
    
    local url="${API_BASE}/jobs"
    if [ -n "$state" ]; then
        url="${url}?state=${state}"
    fi
    
    response=$(curl -s "$url")
    
    if $json_output; then
        echo "$response" | jq ".jobs[:$limit]"
    else
        echo -e "${CYAN}Jobs${NC}"
        echo
        
        echo "$response" | jq -r ".jobs[:$limit] | .[] | 
            \"\\(.id) | \\(.state) | \\(.title[:50]) | $\\(.budget.max)\"" |
        while IFS='|' read -r id state title budget; do
            printf "%-30s | %-12s | %-50s | %s\n" \
                "$(echo "$id" | xargs)" \
                "$(echo "$state" | xargs)" \
                "$(echo "$title" | xargs)" \
                "$(echo "$budget" | xargs)"
        done
    fi
}

# View command
cmd_view() {
    local job_id="${1:-}"
    
    if [ -z "$job_id" ]; then
        echo -e "${RED}Error: Job ID required${NC}"
        echo "Usage: $(basename "$0") view <job-id>"
        exit 1
    fi
    
    check_api
    
    response=$(curl -s "${API_BASE}/jobs/${job_id}")
    
    if echo "$response" | jq -e . > /dev/null 2>&1; then
        echo "$response" | jq .
    else
        echo -e "${RED}Job not found: $job_id${NC}"
        exit 1
    fi
}

# Proposal command
cmd_proposal() {
    local job_id="${1:-}"
    
    if [ -z "$job_id" ]; then
        echo -e "${RED}Error: Job ID required${NC}"
        echo "Usage: $(basename "$0") proposal <job-id>"
        exit 1
    fi
    
    check_api
    
    echo -e "${YELLOW}Generating proposal for $job_id...${NC}"
    
    response=$(curl -s -X POST "${API_BASE}/jobs/${job_id}/proposal")
    
    if echo "$response" | jq -e . > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Proposal generated${NC}"
        echo
        echo "$response" | jq .
    else
        echo -e "${RED}Error generating proposal${NC}"
        echo "$response"
        exit 1
    fi
}

# Version command
cmd_version() {
    echo "Job-to-Scenario Pipeline CLI v1.0.0"
}

# Main command dispatcher
case "${1:-help}" in
    status) cmd_status ;;
    import) shift; cmd_import "$@" ;;
    research) shift; cmd_research "$@" ;;
    approve) shift; cmd_approve "$@" ;;
    list) shift; cmd_list "$@" ;;
    view) shift; cmd_view "$@" ;;
    proposal) shift; cmd_proposal "$@" ;;
    version|--version) cmd_version ;;
    help|--help|-h) show_help ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo
        show_help
        exit 1
        ;;
esac