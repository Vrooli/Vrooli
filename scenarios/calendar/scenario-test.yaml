# Calendar Scenario Test Specification
# Validates the universal scheduling intelligence system

version: 1.0
scenario: calendar

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - README.md
    - api/main.go
    - api/go.mod
    - cli/calendar
    - cli/install.sh
    - initialization/postgres/schema.sql
    - ui/index.html
    - ui/styles.css
    - ui/calendar.js
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/postgres
    - ui

# Resource validation
resources:
  required: [postgres, qdrant, scenario-authenticator, notification-hub]
  optional: [ollama]
  health_timeout: 90

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL calendar database is accessible"
    type: http
    service: postgres
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "Qdrant vector database is accessible"
    type: http
    url: "${QDRANT_URL}/collections/calendar_events"
    method: GET
    expect:
      status: 200
      
  - name: "scenario-authenticator service is running"
    type: http
    url: "${AUTH_SERVICE_URL}/health"
    method: GET
    expect:
      status: 200
      
  - name: "notification-hub service is running"
    type: http
    url: "${NOTIFICATION_SERVICE_URL}/health"
    method: GET
    expect:
      status: 200

  # API endpoint tests
  - name: "Calendar API health check responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        
  - name: "Event creation works with mock authentication"
    type: http
    service: api
    endpoint: /api/v1/events
    method: POST
    headers:
      Authorization: "Bearer mock-token-for-testing"
    body:
      title: "Test Meeting"
      start_time: "2024-01-15T10:00:00Z"
      end_time: "2024-01-15T11:00:00Z"
      event_type: "meeting"
    expect:
      status: 201
      body:
        success: true
        
  - name: "Event listing works with authentication"
    type: http
    service: api
    endpoint: /api/v1/events
    method: GET
    headers:
      Authorization: "Bearer mock-token-for-testing"
    expect:
      status: 200
      body_contains: ["events", "total_count"]
      
  - name: "Schedule chat interface responds"
    type: http
    service: api
    endpoint: /api/v1/schedule/chat
    method: POST
    headers:
      Authorization: "Bearer mock-token-for-testing"
    body:
      message: "Schedule a meeting tomorrow at 2pm"
    expect:
      status: 200
      body_contains: ["response", "suggested_actions"]
      
  - name: "Schedule optimization endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/schedule/optimize
    method: POST
    headers:
      Authorization: "Bearer mock-token-for-testing"
    body:
      request: "free up my schedule tonight"
    expect:
      status: 200
      body_contains: ["suggestions"]

  # CLI command tests
  - name: "CLI shows help information"
    type: exec
    command: ./cli/calendar help
    expect:
      exit_code: 0
      output_contains: ["Universal Scheduling Intelligence", "COMMANDS", "EXAMPLES"]
      
  - name: "CLI shows version information"
    type: exec
    command: ./cli/calendar version
    expect:
      exit_code: 0
      output_contains: ["Calendar CLI", "API Version"]
      
  - name: "CLI install script is executable"
    type: exec
    command: bash ./cli/install.sh
    expect:
      exit_code: 0
      output_contains: ["Installing Calendar CLI", "Installation complete"]
      
  # Database schema tests
  - name: "Database schema is properly initialized"
    type: sql
    service: postgres
    database: calendar_system
    query: "SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = 'public' AND table_type = 'BASE TABLE'"
    expect:
      rows:
        - table_count: 8  # events, recurring_patterns, event_reminders, event_attendees, calendar_permissions, calendar_audit_log, users
        
  - name: "Events table has proper structure"
    type: sql
    service: postgres
    database: calendar_system
    query: "SELECT column_name FROM information_schema.columns WHERE table_name = 'events' ORDER BY ordinal_position"
    expect:
      row_count: 15  # All event table columns
      
  - name: "Required indexes exist for performance"
    type: sql
    service: postgres
    database: calendar_system
    query: "SELECT indexname FROM pg_indexes WHERE tablename = 'events' AND indexname LIKE 'idx_%'"
    expect:
      min_rows: 5  # At least 5 performance indexes

  # UI tests
  - name: "Calendar UI loads successfully"
    type: http
    service: ui
    endpoint: /
    method: GET
    expect:
      status: 200
      body_contains: ["Universal Scheduling Intelligence", "calendar-container"]
      
  - name: "Calendar CSS file is accessible"
    type: http
    service: ui
    endpoint: /styles.css
    method: GET
    expect:
      status: 200
      body_contains: [":root", "--primary", "calendar-view"]
      
  - name: "Calendar JavaScript file is accessible"
    type: http
    service: ui
    endpoint: /calendar.js
    method: GET
    expect:
      status: 200
      body_contains: ["CalendarApp", "renderCurrentView", "apiCall"]
      
  # Integration tests
  - name: "Full event lifecycle works"
    type: integration
    description: "Create event, retrieve it, verify in database"
    steps:
      - name: "Create event via API"
        type: http
        service: api
        endpoint: /api/v1/events
        method: POST
        headers:
          Authorization: "Bearer mock-token-for-testing"
        body:
          title: "Integration Test Event"
          start_time: "2024-02-01T14:00:00Z"
          end_time: "2024-02-01T15:00:00Z"
        expect:
          status: 201
          store_response_field: event_id
          
      - name: "Verify event in database"
        type: sql
        service: postgres
        database: calendar_system
        query: "SELECT title FROM events WHERE title = 'Integration Test Event'"
        expect:
          rows:
            - title: "Integration Test Event"
            
      - name: "Retrieve event via API"
        type: http
        service: api
        endpoint: "/api/v1/events?search=Integration Test Event"
        method: GET
        headers:
          Authorization: "Bearer mock-token-for-testing"
        expect:
          status: 200
          body_contains: ["Integration Test Event"]

# Performance validation
performance:
  - name: "API response time is under 200ms"
    endpoint: "/api/v1/events"
    max_response_time: 200
    
  - name: "Event search is under 500ms"
    endpoint: "/api/v1/events?search=meeting"
    max_response_time: 500
    
  - name: "Database can handle 100 concurrent event creations"
    type: load_test
    concurrent_requests: 100
    endpoint: "/api/v1/events"
    success_rate: 95

# Security validation
security:
  - name: "Unauthenticated requests are rejected"
    type: http
    service: api
    endpoint: /api/v1/events
    method: GET
    expect:
      status: 401
      
  - name: "Invalid tokens are rejected"
    type: http
    service: api
    endpoint: /api/v1/events
    method: GET
    headers:
      Authorization: "Bearer invalid-token"
    expect:
      status: 401
      
  - name: "SQL injection is prevented"
    type: http
    service: api
    endpoint: "/api/v1/events?search='; DROP TABLE events; --"
    method: GET
    headers:
      Authorization: "Bearer mock-token-for-testing"
    expect:
      status: 200  # Should not crash

# Capability verification
capabilities:
  - name: "Natural language scheduling works"
    description: "AI can interpret and suggest scheduling actions"
    validation: "Chat endpoint returns structured suggestions"
    
  - name: "Multi-user isolation works"
    description: "Users can only see their own events"
    validation: "Different auth tokens return different event sets"
    
  - name: "Event automation triggers work"
    description: "Events can trigger other scenario actions"
    validation: "Automation config is stored and retrievable"
    
  - name: "Semantic search works"
    description: "AI-powered event search using embeddings"
    validation: "Search returns relevant results even with partial matches"

# Success criteria
success_criteria:
  - all_tests_pass: true
  - api_availability: 99.9
  - average_response_time_ms: 200
  - database_connection: true
  - ui_loads: true
  - cli_functional: true
  
# Documentation validation
documentation:
  - pr–¥_complete: true
  - readme_comprehensive: true  
  - api_endpoints_documented: true
  - cli_help_available: true
  - integration_examples_provided: true