#!/bin/bash

# QR Code Generator CLI
set -e

APP_ROOT="${APP_ROOT:-$(builtin cd "${BASH_SOURCE[0]%/*}/../../.." && builtin pwd)}"
SCRIPT_DIR="${APP_ROOT}/scenarios/qr-code-generator/cli"
# Find API port from running process or use default
API_PORT=$(lsof -i -P 2>/dev/null | grep "qr-code.*LISTEN" | awk '{print $9}' | cut -d: -f2 | head -1)
API_URL="${API_URL:-http://localhost:${API_PORT:-17320}}"

show_help() {
    cat << EOF
QR Code Generator CLI

Usage: qr-generator [command] [options]

Commands:
    generate <text>     Generate a QR code from text
    batch <file>        Process batch from file
    help               Show this help message

Options:
    --size <pixels>    QR code size (default: 256)
    --color <hex>      Foreground color (default: #000000)
    --bg <hex>         Background color (default: #FFFFFF)
    --output <file>    Save to file
    
Examples:
    qr-generator generate "https://vrooli.com"
    qr-generator generate "Hello World" --size 512 --output hello.png
    qr-generator batch urls.txt --size 256

EOF
}

generate_qr() {
    local text="$1"
    shift
    
    local size="256"
    local color="#000000"
    local bg="#FFFFFF"
    local output=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --size) size="$2"; shift 2 ;;
            --color) color="$2"; shift 2 ;;
            --bg) bg="$2"; shift 2 ;;
            --output) output="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    echo "Generating QR code..."
    
    response=$(curl -s -X POST "$API_URL/generate" \
        -H "Content-Type: application/json" \
        -d "{\"text\":\"$text\",\"size\":$size,\"color\":\"$color\",\"background\":\"$bg\"}")
    
    if [[ -n "$output" ]]; then
        echo "$response" | jq -r '.data' | base64 -d > "$output"
        echo "QR code saved to: $output"
    else
        echo "$response" | jq .
    fi
}

process_batch() {
    local file="$1"
    shift
    
    if [[ ! -f "$file" ]]; then
        echo "Error: File not found: $file"
        exit 1
    fi
    
    local size="256"
    local color="#000000"
    local bg="#FFFFFF"
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --size) size="$2"; shift 2 ;;
            --color) color="$2"; shift 2 ;;
            --bg) bg="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    # Build items array from file
    items="["
    first=true
    while IFS= read -r line; do
        if [[ -n "$line" ]]; then
            if [[ "$first" == false ]]; then
                items+=","
            fi
            items+="{\"text\":\"$line\",\"label\":\"$(basename "$line")\"}"
            first=false
        fi
    done < "$file"
    items+="]"
    
    echo "Processing batch of $(wc -l < "$file") items..."
    
    response=$(curl -s -X POST "$API_URL/batch" \
        -H "Content-Type: application/json" \
        -d "{\"items\":$items,\"options\":{\"size\":$size,\"color\":\"$color\",\"background\":\"$bg\"}}")
    
    echo "$response" | jq .
}

# Main command handling
case "${1:-}" in
    generate)
        if [[ -z "$2" ]]; then
            echo "Error: Text required"
            show_help
            exit 1
        fi
        generate_qr "$2" "${@:3}"
        ;;
    batch)
        if [[ -z "$2" ]]; then
            echo "Error: File required"
            show_help
            exit 1
        fi
        process_batch "$2" "${@:3}"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Error: Unknown command: $1"
        show_help
        exit 1
        ;;
esac