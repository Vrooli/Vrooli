version: 1.0
scenario: no-spoilers-book-talk

# Structure validation - files and directories that MUST exist
structure:
  required_files:
    - .vrooli/service.json
    - PRD.md
    - api/main.go
    - api/go.mod
    - cli/no-spoilers-book-talk
    - cli/install.sh
    - initialization/postgres/schema.sql
    - initialization/postgres/seed.sql
    - scenario-test.yaml
    
  required_dirs:
    - api
    - cli
    - initialization
    - initialization/postgres
    - test
    - data

# Resource validation
resources:
  required: [postgres, qdrant, ollama, n8n]
  optional: [minio]
  health_timeout: 90  # Allow extra time for embedding generation

# Declarative tests
tests:
  # Resource health checks
  - name: "PostgreSQL is accessible"
    type: http
    service: postgres
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "Qdrant is accessible" 
    type: http
    service: qdrant
    endpoint: /health
    method: GET
    expect:
      status: 200
      
  - name: "Ollama is accessible"
    type: http
    service: ollama
    endpoint: /api/tags
    method: GET
    expect:
      status: 200

  # API endpoint tests
  - name: "API health endpoint responds"
    type: http
    service: api
    endpoint: /health
    method: GET
    expect:
      status: 200
      body:
        status: "healthy"
        service: "no-spoilers-book-talk-api"

  - name: "Books list endpoint responds"
    type: http
    service: api
    endpoint: /api/v1/books
    method: GET
    expect:
      status: 200

  - name: "Books endpoint accepts user filter"
    type: http
    service: api
    endpoint: /api/v1/books?user_id=test-user
    method: GET
    expect:
      status: 200

  # Database schema tests
  - name: "Database schema is initialized"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('books', 'user_progress', 'conversations', 'book_chunks')"
    expect:
      rows: 
        - count: 4

  - name: "Sample books are seeded"
    type: sql
    service: postgres  
    query: "SELECT COUNT(*) as count FROM books WHERE processing_status = 'completed'"
    expect:
      rows_min: 1

  - name: "Database indexes exist"
    type: sql
    service: postgres
    query: "SELECT COUNT(*) as count FROM pg_indexes WHERE schemaname = 'public' AND indexname LIKE 'idx_%'"
    expect:
      rows_min: 5

  # CLI command tests
  - name: "CLI help command works"
    type: exec
    command: ./cli/no-spoilers-book-talk help
    expect:
      exit_code: 0
      output_contains: ["No Spoilers Book Talk", "USAGE", "COMMANDS"]

  - name: "CLI version command works"
    type: exec
    command: ./cli/no-spoilers-book-talk version
    expect:
      exit_code: 0
      output_contains: ["1.0.0"]

  - name: "CLI status command works (with API running)"
    type: exec
    command: ./cli/no-spoilers-book-talk status
    expect:
      exit_code: 0
      output_contains: ["Status:", "healthy"]

  - name: "CLI can list books"
    type: exec
    command: ./cli/no-spoilers-book-talk list --user-id demo-user-1
    expect:
      exit_code: 0
      output_contains: ["Books for user"]

  # Go build tests
  - name: "Go API builds successfully"
    type: exec
    command: cd api && go build -o test-build . && rm -f test-build
    expect:
      exit_code: 0

  - name: "Go mod is valid"
    type: exec
    command: cd api && go mod verify
    expect:
      exit_code: 0

  # Data directory tests  
  - name: "Data directories can be created"
    type: exec
    command: mkdir -p data/books data/uploads data/temp && ls -la data/
    expect:
      exit_code: 0
      output_contains: ["books", "uploads", "temp"]

# Performance requirements
performance:
  startup_time_max: 30000  # 30 seconds max startup
  api_response_time_max: 2000  # 2 seconds max for API responses
  memory_limit_mb: 2048  # 2GB memory limit
  
# Security requirements  
security:
  no_hardcoded_secrets: true
  file_permissions_strict: true
  sql_injection_safe: true

# Integration requirements
integration:
  qdrant_collections: 
    - name: "book-content"
      vector_size: 1024
      distance: "cosine"
  postgres_tables:
    - books
    - user_progress  
    - conversations
    - book_chunks
    - reading_analytics
  n8n_workflows:
    - book-processor
    - safe-chat-orchestrator