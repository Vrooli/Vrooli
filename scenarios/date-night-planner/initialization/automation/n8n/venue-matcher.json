{
  "name": "venue-matcher",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "date-night-planner/match-venues",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "preferences",
              "value": "={{JSON.stringify($json[\"preferences\"])}}"
            },
            {
              "name": "location",
              "value": "={{$json[\"location\"] || \"current\"}}"
            },
            {
              "name": "radius",
              "value": "={{$json[\"radius\"] || 10}}"
            }
          ]
        }
      },
      "id": "set-search-params",
      "name": "Set Search Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:{{$env.QDRANT_PORT}}/collections/venues/points/search",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "vector",
              "value": "={{$json[\"embedding\"]}}"
            },
            {
              "name": "limit",
              "value": 10
            },
            {
              "name": "with_payload",
              "value": true
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "search-vectors",
      "name": "Search Vector DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [850, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "http://localhost:{{$env.OLLAMA_PORT}}/api/embeddings",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "nomic-embed-text"
            },
            {
              "name": "prompt",
              "value": "={{$json[\"preferences\"]}}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "generate-embedding",
      "name": "Generate Embedding",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [650, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "http://localhost:{{$env.LOCAL_INFO_SCOUT_PORT}}/api/search",
        "method": "GET",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "{{$json[\"preferences\"]}}"
            },
            {
              "name": "location",
              "value": "{{$json[\"location\"]}}"
            },
            {
              "name": "radius",
              "value": "{{$json[\"radius\"]}}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "search-local-info",
      "name": "Search Local Info",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [650, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "const vectorResults = $node[\"Search Vector DB\"].json?.result || [];\nconst localResults = $node[\"Search Local Info\"].json?.venues || [];\nconst preferences = JSON.parse(items[0].json.preferences || '[]');\n\n// Combine and rank venues\nconst allVenues = [];\n\n// Add vector search results\nvectorResults.forEach(result => {\n  if (result.payload) {\n    allVenues.push({\n      ...result.payload,\n      score: result.score || 0.5,\n      source: 'semantic_search'\n    });\n  }\n});\n\n// Add local search results\nlocalResults.forEach(venue => {\n  // Check if already in results\n  if (!allVenues.find(v => v.name === venue.name)) {\n    allVenues.push({\n      ...venue,\n      score: 0.7, // Default score for local results\n      source: 'local_search'\n    });\n  }\n});\n\n// Sort by score\nallVenues.sort((a, b) => (b.score || 0) - (a.score || 0));\n\n// Add fallback venues if no results\nif (allVenues.length === 0) {\n  allVenues.push(\n    {\n      name: \"Local Restaurant\",\n      type: \"dining\",\n      description: \"A popular local dining spot\",\n      score: 0.5,\n      source: 'fallback'\n    },\n    {\n      name: \"City Park\",\n      type: \"outdoor\",\n      description: \"Beautiful park for a romantic walk\",\n      score: 0.4,\n      source: 'fallback'\n    }\n  );\n}\n\nreturn [{\n  json: {\n    matched_venues: allVenues.slice(0, 5),\n    total_found: allVenues.length,\n    search_preferences: preferences,\n    sources_used: [...new Set(allVenues.map(v => v.source))]\n  }\n}];"
      },
      "id": "combine-results",
      "name": "Combine Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Set Search Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Search Params": {
      "main": [
        [
          {
            "node": "Generate Embedding",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search Local Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Embedding": {
      "main": [
        [
          {
            "node": "Search Vector DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Vector DB": {
      "main": [
        [
          {
            "node": "Combine Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Local Info": {
      "main": [
        [
          {
            "node": "Combine Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Results": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "date-night-planner"
  },
  "id": "venue-matcher",
  "tags": []
}