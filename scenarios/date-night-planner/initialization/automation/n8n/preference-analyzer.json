{
  "name": "preference-analyzer",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "date-night-planner/analyze-preferences",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "couple_id",
              "value": "={{$json[\"couple_id\"]}}"
            },
            {
              "name": "date_feedback",
              "value": "={{$json[\"feedback\"]}}"
            },
            {
              "name": "rating",
              "value": "={{$json[\"rating\"]}}"
            }
          ]
        }
      },
      "id": "extract-data",
      "name": "Extract Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:{{$env.OLLAMA_PORT}}/api/generate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "llama3.2"
            },
            {
              "name": "prompt",
              "value": "Analyze this date feedback and extract preferences:\n\nRating: {{$json[\"rating\"]}}/5\nFeedback: {{$json[\"date_feedback\"]}}\n\nExtract key preferences in JSON format with categories: cuisine, activity_type, ambiance, timing, budget.\nRespond only with valid JSON."
            },
            {
              "name": "stream",
              "value": false
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "analyze-with-ai",
      "name": "Analyze with AI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [650, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "functionCode": "const coupleId = items[0].json.couple_id;\nconst rating = parseInt(items[0].json.rating) || 3;\nconst aiResponse = $node[\"Analyze with AI\"].json?.response || '{}';\n\nlet preferences = [];\n\ntry {\n  // Parse AI response\n  const aiPrefs = JSON.parse(aiResponse);\n  \n  // Convert to preference records\n  for (const [category, value] of Object.entries(aiPrefs)) {\n    if (value) {\n      preferences.push({\n        couple_id: coupleId,\n        category: category,\n        preference_value: value.toString(),\n        confidence_score: rating > 3 ? 0.7 : 0.3,\n        learned_from: 'feedback'\n      });\n    }\n  }\n} catch (e) {\n  // Fallback if AI parsing fails\n  preferences.push({\n    couple_id: coupleId,\n    category: 'general',\n    preference_value: rating > 3 ? 'positive' : 'needs_improvement',\n    confidence_score: 0.5,\n    learned_from: 'feedback'\n  });\n}\n\nreturn [{\n  json: {\n    couple_id: coupleId,\n    preferences_extracted: preferences,\n    original_rating: rating,\n    analysis_status: preferences.length > 0 ? 'success' : 'partial'\n  }\n}];"
      },
      "id": "process-preferences",
      "name": "Process Preferences",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:{{$env.POSTGRES_PORT}}/execute",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "queries",
              "value": "={{$json[\"preferences_extracted\"].map(p => `INSERT INTO date_night_planner.preferences (couple_id, category, preference_key, preference_value, confidence_score, learned_from) VALUES ('${p.couple_id}', '${p.category}', '${p.category}_learned', '${p.preference_value}', ${p.confidence_score}, '${p.learned_from}') ON CONFLICT DO NOTHING`).join(';')}}"
            }
          ]
        }
      },
      "id": "save-preferences",
      "name": "Save Preferences",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1050, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Extract Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Data": {
      "main": [
        [
          {
            "node": "Analyze with AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze with AI": {
      "main": [
        [
          {
            "node": "Process Preferences",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Preferences": {
      "main": [
        [
          {
            "node": "Save Preferences",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Preferences": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "date-night-planner"
  },
  "id": "preference-analyzer",
  "tags": []
}