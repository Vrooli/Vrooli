# syntax=docker/dockerfile:1.4

ARG PROJECT_DIR=/srv/app

### Base stage for production: install only production dependencies and build workspace
FROM node:18-slim AS base
ARG PROJECT_DIR
ENV PROJECT_DIR=${PROJECT_DIR}
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
WORKDIR ${PROJECT_DIR}
ENV NODE_ENV=production

# Install pnpm and build dependencies
RUN apt-get update && apt-get install -y dnsutils curl python3 python3-dev build-essential && \
    npm install -g pnpm@9.15.2

# Copy manifest files and configuration
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY packages/server/package.json packages/server/package.json
COPY packages/jobs/package.json packages/jobs/package.json
COPY packages/ui/package.json packages/ui/package.json
COPY packages/shared/package.json packages/shared/package.json

# Install dependencies (including devDependencies for build)
ENV NODE_ENV=development
RUN --mount=type=cache,id=pnpm-store,target=/usr/local/share/pnpm-store pnpm fetch
RUN --mount=type=cache,id=pnpm-store,target=/usr/local/share/pnpm-store \
    pnpm install --frozen-lockfile && \
    pnpm install --frozen-lockfile

# Add node_modules/.bin to PATH for binary access
ENV PATH="/srv/app/node_modules/.bin:$PATH"

# Copy full source and build all packages
COPY . .

# Build shared utilities
RUN pnpm --filter @vrooli/shared run build

# Build UI package
RUN pnpm --filter @vrooli/ui run build

# Build jobs package  
RUN pnpm --filter @vrooli/jobs run build

# Build server package
RUN pnpm --filter @vrooli/server run build

# Reset NODE_ENV to production after all builds are complete
ENV NODE_ENV=production

### Production UI image using nginx
FROM nginx:alpine AS ui
COPY --from=base /srv/app/packages/ui/dist /usr/share/nginx/html
COPY --from=base /srv/app/packages/ui/nginx.conf /etc/nginx/conf.d/default.conf 2>/dev/null || true
# Add a simple nginx config if one doesn't exist
RUN if [ ! -f /etc/nginx/conf.d/default.conf ]; then \
    echo 'server { \
        listen 3000; \
        server_name localhost; \
        root /usr/share/nginx/html; \
        index index.html; \
        location / { \
            try_files $uri $uri/ /index.html; \
        } \
        location /healthcheck { \
            access_log off; \
            return 200 "ok"; \
            add_header Content-Type text/plain; \
        } \
    }' > /etc/nginx/conf.d/default.conf; \
    fi
EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]

### Production server image
FROM node:18-slim AS server
ARG PROJECT_DIR=/srv/app
WORKDIR ${PROJECT_DIR}

# Install production dependencies only
RUN apt-get update && apt-get install -y dnsutils && \
    rm -rf /var/lib/apt/lists/*

# Copy built application
COPY --from=base ${PROJECT_DIR}/node_modules ./node_modules
COPY --from=base ${PROJECT_DIR}/packages ./packages
COPY --from=base ${PROJECT_DIR}/package.json ./package.json

# Generate Prisma client at runtime
RUN cd packages/server && npx prisma generate

EXPOSE 5329
CMD ["node", "packages/server/dist/index.js"]

### Production jobs image
FROM node:18-slim AS jobs
ARG PROJECT_DIR=/srv/app
WORKDIR ${PROJECT_DIR}

# Install production dependencies only
RUN apt-get update && apt-get install -y dnsutils && \
    rm -rf /var/lib/apt/lists/*

# Copy built application
COPY --from=base ${PROJECT_DIR}/node_modules ./node_modules
COPY --from=base ${PROJECT_DIR}/packages ./packages
COPY --from=base ${PROJECT_DIR}/package.json ./package.json

# Generate Prisma client at runtime
RUN cd packages/server && npx prisma generate

EXPOSE 4001
CMD ["node", "packages/jobs/dist/index.js"]