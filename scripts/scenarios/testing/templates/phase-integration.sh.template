#!/bin/bash
# Integration tests phase - tests component interactions and external integrations
# TEMPLATE: Copy this to your scenario's test/phases/test-integration.sh and customize
source "$(dirname "${BASH_SOURCE[0]}")/../../../../scripts/scenarios/testing/shell/phase-helpers.sh"

# Initialize phase with runtime requirement and 120-second target
testing::phase::init --require-runtime --target-time "120s"

echo "Running integration tests for $TESTING_PHASE_SCENARIO_NAME..."

# TODO: Add any test data variables here
TEST_DATA_ID=""

# TODO: Define cleanup functions for test data
cleanup_test_data() {
    if [ -n "$TEST_DATA_ID" ]; then
        # TODO: Add cleanup logic here
        echo "Cleaning up test data: $TEST_DATA_ID"
    fi
}

# Register cleanup function
testing::phase::register_cleanup cleanup_test_data

# Wait for scenario to be ready
if ! testing::core::wait_for_scenario "$TESTING_PHASE_SCENARIO_NAME" 30; then
    testing::phase::add_error "âŒ Scenario '$TESTING_PHASE_SCENARIO_NAME' did not become ready in time"
    testing::phase::end_with_summary
fi

# Get API and UI URLs
if ! API_URL=$(testing::connectivity::get_api_url "$TESTING_PHASE_SCENARIO_NAME"); then
    testing::phase::add_error "âŒ Could not resolve API URL for $TESTING_PHASE_SCENARIO_NAME"
    testing::phase::end_with_summary
fi

if UI_URL=$(testing::connectivity::get_ui_url "$TESTING_PHASE_SCENARIO_NAME" 2>/dev/null); then
    UI_PORT="${UI_URL##*:}"
fi
API_PORT="${API_URL##*:}"

# Test API connectivity
echo "ğŸŒ Testing API Integration..."
testing::phase::check "API health endpoint" curl -sf --max-time 10 "$API_URL/health"

# TODO: Test your API endpoints here
# Example:
# testing::phase::check "Users endpoint" curl -sf --max-time 10 "$API_URL/api/v1/users"
# testing::phase::check "Auth endpoint" curl -sf --max-time 10 "$API_URL/api/v1/auth/login"

# Test UI connectivity (if applicable)
if [ -n "${UI_URL:-}" ]; then
    echo "ğŸ–¥ï¸  Testing UI Integration..."
    testing::phase::check "UI homepage" curl -sf --max-time 10 "$UI_URL"
fi

# TODO: Test CLI integration if you have a CLI
# Example:
# if [ -x "$TESTING_PHASE_SCENARIO_DIR/cli/my-cli" ]; then
#     echo "ğŸ–¥ï¸  Testing CLI Integration..."
#     testing::phase::check "CLI version command" "$TESTING_PHASE_SCENARIO_DIR/cli/my-cli" version
#     testing::phase::check "CLI help command" "$TESTING_PHASE_SCENARIO_DIR/cli/my-cli" help
# fi

# TODO: Test resource connectivity if you use resources
# Example for PostgreSQL:
# if command -v resource-postgres >/dev/null 2>&1; then
#     echo "ğŸ—„ï¸  Testing database connectivity..."
#     testing::phase::check "PostgreSQL connectivity" resource-postgres test smoke
# fi

# TODO: Test any workflow or end-to-end scenarios
# Example:
# echo "ğŸ”„ Testing end-to-end workflow..."
# test_payload='{"name":"test-item"}'
# response=$(curl -sf --max-time 15 -X POST \
#     -H "Content-Type: application/json" \
#     -d "$test_payload" \
#     "$API_URL/api/v1/items" 2>/dev/null || echo "")
# if echo "$response" | jq -e '.id' >/dev/null 2>&1; then
#     TEST_DATA_ID=$(echo "$response" | jq -r '.id')
#     echo "âœ… End-to-end workflow test passed - created item: $TEST_DATA_ID"
#     testing::phase::add_test passed
# else
#     echo "âŒ End-to-end workflow test failed"
#     testing::phase::add_test failed
# fi

# End with summary
testing::phase::end_with_summary "Integration tests completed"