{
  "name": "Stream of Consciousness - Process Stream",
  "nodes": [
    {
      "parameters": {
        "path": "process-stream",
        "responseMode": "responseNode",
        "options": {
          "responseCode": 200
        }
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nreturn [{\n  json: {\n    text: \"Had a great idea about improving the user onboarding flow. We could add interactive tutorials and gamification elements. Also need to review the API documentation before the meeting tomorrow. The current flow is confusing for new users based on support tickets. I should also look into that bug report from yesterday.\",\n    campaign: \"work\",\n    user_id: \"test-user\",\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "provide-defaults",
      "name": "Provide Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'http://localhost:5678' }}/webhook/chain-of-thought-orchestrator",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "problem",
              "value": "={{ 'Analyze and organize this stream of consciousness text into structured knowledge' }}"
            },
            {
              "name": "context",
              "value": "={{ { text: $json.text, campaign: $json.campaign, user_id: $json.user_id } }}"
            },
            {
              "name": "steps",
              "value": "={{ [\n  'Extract main topics and themes from the text',\n  'Identify actionable items and tasks',\n  'Discover key insights and patterns',\n  'Generate relevant tags and categories',\n  'Determine priority levels for each item',\n  'Identify relationships between different thoughts'\n] }}"
            },
            {
              "name": "expected_output",
              "value": "Structured JSON with topics, action_items, insights, tags, priorities, and relationships"
            },
            {
              "name": "model",
              "value": "llama3.2"
            }
          ]
        },
        "options": {}
      },
      "id": "chain-of-thought-analysis",
      "name": "Chain of Thought Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse and enhance the chain-of-thought results\nconst cotResult = $json.result;\nconst originalData = $input.first().json;\n\n// Extract structured data from chain-of-thought analysis\nlet processed = {\n  topics: [],\n  action_items: [],\n  insights: [],\n  tags: [],\n  priorities: {},\n  relationships: []\n};\n\ntry {\n  // Parse the result if it's a string\n  const parsed = typeof cotResult === 'string' ? JSON.parse(cotResult) : cotResult;\n  \n  processed = {\n    topics: parsed.topics || [],\n    action_items: parsed.action_items || [],\n    insights: parsed.insights || [], \n    tags: parsed.tags || [],\n    priorities: parsed.priorities || {},\n    relationships: parsed.relationships || []\n  };\n} catch (e) {\n  // Fallback to basic extraction if parsing fails\n  processed.topics = ['Unprocessed thought'];\n  processed.tags = [originalData.campaign || 'general'];\n}\n\n// Add metadata\nprocessed.metadata = {\n  campaign: originalData.campaign,\n  user_id: originalData.user_id,\n  timestamp: originalData.timestamp || new Date().toISOString(),\n  word_count: originalData.text.split(' ').length,\n  processing_method: 'chain-of-thought'\n};\n\nreturn [{\n  json: {\n    ...originalData,\n    processed: processed,\n    analysis_timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "enhance-results",
      "name": "Enhance Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'http://localhost:5678' }}/webhook/embedding-generator",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "texts",
              "value": "={{ [$json.text] }}"
            },
            {
              "name": "model",
              "value": "nomic-embed-text"
            }
          ]
        },
        "options": {}
      },
      "id": "generate-embedding",
      "name": "Generate Embedding",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO stream_entries (user_id, campaign, raw_text, processed_data, embedding_vector, created_at) VALUES ($1, $2, $3, $4, $5, $6) RETURNING id, created_at",
        "additionalFields": {
          "queryParams": "={{ [\n  $json.user_id || 'default',\n  $json.campaign || 'general',\n  $json.text,\n  JSON.stringify($json.processed),\n  JSON.stringify($json.embeddings[0]),\n  $json.analysis_timestamp\n] }}"
        }
      },
      "id": "save-to-postgres",
      "name": "Save to PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.3,
      "position": [1250, 400],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.QDRANT_URL || 'http://localhost:6333' }}/collections/stream_thoughts/points",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "points",
              "value": "={{ [{\n  id: String($json.id),\n  vector: $json.embeddings[0],\n  payload: {\n    text: $input.first().json.text,\n    campaign: $input.first().json.campaign,\n    user_id: $input.first().json.user_id,\n    topics: $input.first().json.processed.topics,\n    tags: $input.first().json.processed.tags,\n    insights: $input.first().json.processed.insights,\n    action_items: $input.first().json.processed.action_items,\n    priorities: $input.first().json.processed.priorities,\n    created_at: $json.created_at\n  }\n}] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "store-in-qdrant",
      "name": "Store in Qdrant",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.processed.action_items.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "id": "has-action-items",
      "name": "Has Action Items?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.N8N_URL || 'http://localhost:5678' }}/webhook/smart-notification-router",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.user_id }}"
            },
            {
              "name": "title",
              "value": "New Action Items from Stream"
            },
            {
              "name": "message",
              "value": "={{ 'You have ' + $json.processed.action_items.length + ' new action items from your ' + $json.campaign + ' stream' }}"
            },
            {
              "name": "data",
              "value": "={{ { action_items: $json.processed.action_items, entry_id: $json.id } }}"
            },
            {
              "name": "priority",
              "value": "medium"
            }
          ]
        },
        "options": {}
      },
      "id": "notify-action-items",
      "name": "Notify Action Items",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "Stream processed successfully"
            }
          ],
          "number": [
            {
              "name": "entry_id",
              "value": "={{ $json.id }}"
            },
            {
              "name": "topics_count",
              "value": "={{ $json.processed.topics.length }}"
            },
            {
              "name": "action_items_count",
              "value": "={{ $json.processed.action_items.length }}"
            }
          ]
        }
      },
      "id": "prepare-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [1850, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-to-webhook",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2050, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "chain-of-thought-analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual-trigger": {
      "main": [
        [
          {
            "node": "provide-defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "provide-defaults": {
      "main": [
        [
          {
            "node": "chain-of-thought-analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "chain-of-thought-analysis": {
      "main": [
        [
          {
            "node": "enhance-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enhance-results": {
      "main": [
        [
          {
            "node": "generate-embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate-embedding": {
      "main": [
        [
          {
            "node": "save-to-postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save-to-postgres": {
      "main": [
        [
          {
            "node": "store-in-qdrant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "store-in-qdrant": {
      "main": [
        [
          {
            "node": "has-action-items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "has-action-items": {
      "main": [
        [
          {
            "node": "notify-action-items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "notify-action-items": {
      "main": [
        [
          {
            "node": "prepare-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-response": {
      "main": [
        [
          {
            "node": "respond-to-webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}