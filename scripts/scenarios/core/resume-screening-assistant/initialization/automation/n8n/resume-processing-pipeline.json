{
  "name": "Resume Processing Pipeline",
  "nodes": [
    {
      "parameters": {
        "path": "resume-upload",
        "responseMode": "responseNode",
        "options": {
          "binaryData": true
        }
      },
      "name": "Resume Upload Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "resume-upload",
      "id": "webhook_1"
    },
    {
      "parameters": {
        "jsCode": "// Enhanced security validation for file uploads\nconst input = $input.first();\nconst jobId = input.json.job_id;\nconst binaryData = input.binary.data;\nconst fileName = binaryData?.fileName || '';\n\n// Validation results\nconst errors = [];\nconst warnings = [];\n\n// 1. Basic input validation\nif (!jobId || typeof jobId !== 'string' || jobId.trim().length === 0) {\n  errors.push('Missing or invalid job_id');\n}\n\nif (!binaryData) {\n  errors.push('No file data provided');\n  return { valid: false, errors, warnings };\n}\n\n// 2. File name validation\nif (!fileName || fileName.length === 0) {\n  errors.push('Missing filename');\n} else if (fileName.length > 255) {\n  errors.push('Filename too long (max 255 characters)');\n}\n\n// Check for suspicious characters in filename\nif (/[<>:\"|?*\\\\]/.test(fileName)) {\n  errors.push('Filename contains invalid characters');\n}\n\n// 3. File extension validation\nconst allowedExtensions = ['.pdf', '.docx', '.doc', '.txt', '.rtf'];\nconst fileExtension = fileName.toLowerCase().match(/\\.[^.]+$/);\nif (!fileExtension || !allowedExtensions.includes(fileExtension[0])) {\n  errors.push(`Invalid file type. Allowed: ${allowedExtensions.join(', ')}`);\n}\n\n// 4. File size validation (10MB limit)\nconst maxSizeBytes = 10 * 1024 * 1024; // 10MB\nif (binaryData.data && Buffer.byteLength(binaryData.data, 'base64') > maxSizeBytes) {\n  errors.push('File size exceeds 10MB limit');\n}\n\n// 5. MIME type validation (if available)\nif (binaryData.mimeType) {\n  const allowedMimeTypes = [\n    'application/pdf',\n    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    'application/msword',\n    'text/plain',\n    'application/rtf'\n  ];\n  \n  if (!allowedMimeTypes.includes(binaryData.mimeType)) {\n    errors.push(`Invalid MIME type: ${binaryData.mimeType}`);\n  }\n}\n\n// 6. Content validation checks\nif (binaryData.data) {\n  const dataStr = Buffer.from(binaryData.data, 'base64').toString('utf8', 0, 1000);\n  \n  // Check for suspicious content patterns\n  const suspiciousPatterns = [\n    /<script[^>]*>/i,\n    /javascript:/i,\n    /on[a-z]+\\s*=/i,\n    /%3C%73%63%72%69%70%74/i  // encoded <script\n  ];\n  \n  for (const pattern of suspiciousPatterns) {\n    if (pattern.test(dataStr)) {\n      warnings.push('File contains potentially suspicious content');\n      break;\n    }\n  }\n}\n\n// 7. Rate limiting info (for monitoring)\nconst now = new Date().toISOString();\nconst clientInfo = {\n  timestamp: now,\n  filename: fileName,\n  size: binaryData.data ? Buffer.byteLength(binaryData.data, 'base64') : 0,\n  ip: $json.headers?.['x-forwarded-for'] || $json.headers?.['x-real-ip'] || 'unknown'\n};\n\nif (errors.length > 0) {\n  return {\n    valid: false,\n    errors,\n    warnings,\n    clientInfo,\n    message: `Validation failed: ${errors.join(', ')}`\n  };\n}\n\nreturn {\n  valid: true,\n  errors: [],\n  warnings,\n  clientInfo,\n  sanitizedData: {\n    job_id: jobId.trim(),\n    original_filename: fileName,\n    file_size: clientInfo.size,\n    mime_type: binaryData.mimeType,\n    file_extension: fileExtension ? fileExtension[0] : ''\n  },\n  message: warnings.length > 0 ? `Validation passed with warnings: ${warnings.join(', ')}` : 'Validation passed'\n};"
      },
      "name": "Enhanced Security Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300],
      "id": "validate_input"
    },
    {
      "parameters": {
        "url": "http://localhost:11450/general/v0/general",
        "requestMethod": "POST",
        "sendBody": true,
        "sendBinaryData": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "strategy",
              "value": "fast"
            },
            {
              "name": "output_format",
              "value": "application/json"
            },
            {
              "name": "coordinates",
              "value": "false"
            }
          ]
        }
      },
      "name": "Parse Resume with Unstructured-IO",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [640, 200],
      "id": "unstructured_parser"
    },
    {
      "parameters": {
        "jsCode": "// Extract and clean resume text from Unstructured-IO response\nconst elements = $input.first().json;\nlet resumeText = '';\nlet extractedInfo = {\n  name: '',\n  email: '',\n  phone: '',\n  skills: [],\n  experience: '',\n  education: ''\n};\n\n// Combine all text elements\nif (Array.isArray(elements)) {\n  resumeText = elements\n    .filter(el => el.type === 'NarrativeText' || el.type === 'Title' || el.type === 'ListItem')\n    .map(el => el.text)\n    .join('\\n');\n\n  // Basic extraction patterns\n  const emailMatch = resumeText.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g);\n  const phoneMatch = resumeText.match(/[\\+]?[0-9\\s\\-\\(\\)]{10,}/g);\n  \n  if (emailMatch) extractedInfo.email = emailMatch[0];\n  if (phoneMatch) extractedInfo.phone = phoneMatch[0];\n  \n  // Extract potential name (first line or title)\n  const lines = resumeText.split('\\n').filter(line => line.trim());\n  if (lines.length > 0) {\n    extractedInfo.name = lines[0].replace(/[^a-zA-Z\\s]/g, '').trim();\n  }\n}\n\nreturn {\n  job_id: $('Resume Upload Webhook').first().json.job_id,\n  resume_text: resumeText,\n  extracted_info: extractedInfo,\n  original_filename: $('Resume Upload Webhook').first().json.filename || 'unknown.pdf'\n};"
      },
      "name": "Process Resume Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [840, 200],
      "id": "process_text"
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "requestMethod": "POST",
        "sendBody": true,
        "bodyContent": "{\n  \"model\": \"llama3.1:8b\",\n  \"prompt\": \"Extract structured information from this resume and provide a comprehensive assessment. Resume text:\\n\\n{{ $json.resume_text }}\\n\\nProvide a JSON response with:\\n1. candidate_name (full name)\\n2. email\\n3. phone\\n4. skills (array of technical and soft skills)\\n5. experience_years (numeric estimate)\\n6. education_level (highest degree)\\n7. experience_summary (brief summary)\\n8. key_achievements (array of notable accomplishments)\\n9. overall_score (0-100 based on resume quality and completeness)\\n\\nFormat as valid JSON only.\",\n  \"stream\": false,\n  \"format\": \"json\"\n}",
        "options": {
          "timeout": 120000,
          "retry": {
            "maxAttempts": 3,
            "waitBetween": 2000
          }
        }
      },
      "name": "AI Assessment with Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1040, 200],
      "id": "ai_assessment"
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/embeddings",
        "requestMethod": "POST",
        "sendBody": true,
        "bodyContent": "{\n  \"model\": \"nomic-embed-text\",\n  \"prompt\": \"{{ $json.resume_text }}\"\n}",
        "options": {
          "timeout": 120000,
          "retry": {
            "maxAttempts": 3,
            "waitBetween": 2000
          }
        }
      },
      "name": "Generate Resume Embedding",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1040, 400],
      "id": "generate_embedding"
    },
    {
      "parameters": {
        "jsCode": "// Parse AI assessment and prepare database record\nconst assessment = JSON.parse($('AI Assessment with Ollama').first().json.response);\nconst embedding = $('Generate Resume Embedding').first().json.embedding;\nconst jobId = $('Process Resume Text').first().json.job_id;\nconst resumeText = $('Process Resume Text').first().json.resume_text;\nconst originalFilename = $('Process Resume Text').first().json.original_filename;\n\n// Prepare resume record\nconst resumeData = {\n  candidate_name: assessment.candidate_name || 'Unknown',\n  email: assessment.email || null,\n  resume_text: resumeText,\n  parsed_skills: JSON.stringify(assessment.skills || []),\n  experience_years: assessment.experience_years || 0,\n  education_level: assessment.education_level || 'Not specified',\n  score: assessment.overall_score || 0,\n  status: 'processed'\n};\n\n// Prepare file upload record\nconst fileData = {\n  original_filename: originalFilename,\n  file_path: `/uploads/${Date.now()}_${originalFilename}`,\n  file_type: originalFilename.split('.').pop().toLowerCase(),\n  processing_status: 'completed',\n  job_id: jobId\n};\n\nreturn {\n  resume_data: resumeData,\n  file_data: fileData,\n  embedding: embedding,\n  assessment: assessment,\n  job_id: jobId\n};"
      },
      "name": "Prepare Database Records",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 300],
      "id": "prepare_records"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO resumes (candidate_name, email, resume_text, parsed_skills, experience_years, education_level, score, status) VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING id",
        "additionalFields": {
          "mode": "independently"
        }
      },
      "name": "Save Resume to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1440, 200],
      "credentials": {
        "postgres": {
          "id": "postgres_default",
          "name": "PostgreSQL account"
        }
      },
      "id": "save_resume"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO resume_embeddings (resume_id, embedding_vector) VALUES ($1, $2)",
        "additionalFields": {
          "mode": "independently"
        }
      },
      "name": "Save Resume Embedding",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1640, 200],
      "credentials": {
        "postgres": {
          "id": "postgres_default",
          "name": "PostgreSQL account"
        }
      },
      "id": "save_embedding"
    },
    {
      "parameters": {
        "url": "http://localhost:6333/collections/resumes/points",
        "requestMethod": "PUT",
        "sendBody": true,
        "bodyContent": "{\n  \"points\": [\n    {\n      \"id\": {{ $('Save Resume to Database').first().json.id }},\n      \"vector\": {{ JSON.stringify($('Prepare Database Records').first().json.embedding) }},\n      \"payload\": {\n        \"candidate_id\": {{ $('Save Resume to Database').first().json.id }},\n        \"candidate_name\": \"{{ $('Prepare Database Records').first().json.assessment.candidate_name }}\",\n        \"skills\": {{ JSON.stringify($('Prepare Database Records').first().json.assessment.skills) }},\n        \"experience_years\": {{ $('Prepare Database Records').first().json.assessment.experience_years }},\n        \"education_level\": \"{{ $('Prepare Database Records').first().json.assessment.education_level }}\",\n        \"overall_score\": {{ $('Prepare Database Records').first().json.assessment.overall_score }}\n      }\n    }\n  ]\n}"
      },
      "name": "Store in Qdrant Vector DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1640, 400],
      "id": "store_vector"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE file_uploads SET resume_id = $1, processing_status = 'completed', processed_at = NOW() WHERE job_id = $2 AND original_filename = $3",
        "additionalFields": {
          "mode": "independently"
        }
      },
      "name": "Update File Upload Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1840, 300],
      "credentials": {
        "postgres": {
          "id": "postgres_default",
          "name": "PostgreSQL account"
        }
      },
      "id": "update_file_status"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": true,\n  \"resume_id\": {{ $('Save Resume to Database').first().json.id }},\n  \"candidate_name\": \"{{ $('Prepare Database Records').first().json.assessment.candidate_name }}\",\n  \"score\": {{ $('Prepare Database Records').first().json.assessment.overall_score }},\n  \"skills\": {{ JSON.stringify($('Prepare Database Records').first().json.assessment.skills) }},\n  \"processing_time\": \"{{ new Date().toISOString() }}\",\n  \"job_id\": {{ $('Prepare Database Records').first().json.job_id }}\n}"
      },
      "name": "Return Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2040, 300],
      "id": "success_response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"Invalid input: missing job_id or file data\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {
          "responseCode": 400
        }
      },
      "name": "Return Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [640, 500],
      "id": "error_response"
    }
  ],
  "connections": {
    "Resume Upload Webhook": {
      "main": [
        [
          {
            "node": "Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Input": {
      "main": [
        [
          {
            "node": "Parse Resume with Unstructured-IO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Resume with Unstructured-IO": {
      "main": [
        [
          {
            "node": "Process Resume Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Resume Text": {
      "main": [
        [
          {
            "node": "AI Assessment with Ollama",
            "type": "main",
            "index": 0
          },
          {
            "node": "Generate Resume Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Assessment with Ollama": {
      "main": [
        [
          {
            "node": "Prepare Database Records",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Resume Embedding": {
      "main": [
        [
          {
            "node": "Prepare Database Records",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Database Records": {
      "main": [
        [
          {
            "node": "Save Resume to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Resume to Database": {
      "main": [
        [
          {
            "node": "Save Resume Embedding",
            "type": "main",
            "index": 0
          },
          {
            "node": "Store in Qdrant Vector DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Resume Embedding": {
      "main": [
        [
          {
            "node": "Update File Upload Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store in Qdrant Vector DB": {
      "main": [
        [
          {
            "node": "Update File Upload Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update File Upload Status": {
      "main": [
        [
          {
            "node": "Return Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "resume_processing_pipeline",
  "tags": []
}