#!/bin/bash

# Travel Map Filler CLI
# Interactive world map for tracking travel history

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source common functions if available
if [[ -f "$PROJECT_ROOT/scripts/lib/common.sh" ]]; then
    source "$PROJECT_ROOT/scripts/lib/common.sh"
fi

# Default values
API_URL="${API_URL:-http://localhost:8760}"
N8N_URL="${N8N_URL:-http://localhost:5678}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Display help
show_help() {
    cat << EOF
üó∫Ô∏è Travel Map Filler CLI

Usage: travel-map [COMMAND] [OPTIONS]

Commands:
    add <location>      Add a new travel location
    list               List all travel locations  
    stats              Show travel statistics
    achievements       View unlocked achievements
    bucket-add <loc>   Add location to bucket list
    bucket-list        View bucket list
    search <query>     Search travel history
    export             Export travel data
    help               Show this help message

Options:
    --date DATE        Date of travel (YYYY-MM-DD)
    --type TYPE        Type of travel (vacation/business/adventure/family/transit/lived)
    --notes NOTES      Notes about the travel
    --rating RATING    Rating from 1-5
    --duration DAYS    Duration in days

Examples:
    travel-map add "Paris, France" --date 2024-01-15 --type vacation --notes "Amazing trip!"
    travel-map list
    travel-map stats
    travel-map bucket-add "Machu Picchu, Peru" --notes "Dream destination"

EOF
}

# Add a new travel location
add_travel() {
    local location="$1"
    shift
    
    local date=""
    local type="vacation"
    local notes=""
    local rating=""
    local duration="1"
    
    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --date) date="$2"; shift 2 ;;
            --type) type="$2"; shift 2 ;;
            --notes) notes="$2"; shift 2 ;;
            --rating) rating="$2"; shift 2 ;;
            --duration) duration="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    # Default to today if no date provided
    if [[ -z "$date" ]]; then
        date=$(date +%Y-%m-%d)
    fi
    
    echo -e "${BLUE}‚úàÔ∏è Adding travel to ${location}...${NC}"
    
    # Call API to add travel
    response=$(curl -s -X POST "$API_URL/api/add-travel" \
        -H "Content-Type: application/json" \
        -d "{
            \"location\": \"$location\",
            \"date\": \"$date\",
            \"type\": \"$type\",
            \"notes\": \"$notes\",
            \"rating\": $rating,
            \"duration_days\": $duration
        }")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}‚úÖ Travel added successfully!${NC}"
        echo "$response" | jq -r '.message' 2>/dev/null || echo "$response"
    else
        echo -e "${RED}‚ùå Failed to add travel${NC}"
    fi
}

# List all travels
list_travels() {
    echo -e "${BLUE}üìç Fetching your travel history...${NC}"
    
    response=$(curl -s "$API_URL/api/travels")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Your Travels:${NC}"
        echo "$response" | jq -r '.[] | "\(.date) - \(.location) (\(.type))"' 2>/dev/null || echo "$response"
    else
        echo -e "${RED}‚ùå Failed to fetch travels${NC}"
    fi
}

# Show travel statistics
show_stats() {
    echo -e "${BLUE}üìä Fetching travel statistics...${NC}"
    
    response=$(curl -s "$API_URL/api/stats")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Travel Statistics:${NC}"
        echo "$response" | jq -r '
            "üåç Countries: \(.total_countries)",
            "üèôÔ∏è Cities: \(.total_cities)",
            "üó∫Ô∏è Continents: \(.total_continents)",
            "üìè Distance: \(.total_distance_km) km",
            "üìÖ Days Traveled: \(.total_days_traveled)",
            "üåé World Coverage: \(.world_coverage_percent)%"
        ' 2>/dev/null || echo "$response"
    else
        echo -e "${RED}‚ùå Failed to fetch statistics${NC}"
    fi
}

# Show achievements
show_achievements() {
    echo -e "${BLUE}üèÜ Fetching achievements...${NC}"
    
    response=$(curl -s "$API_URL/api/achievements")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Unlocked Achievements:${NC}"
        echo "$response" | jq -r '.[] | "\(.icon) \(.name) - \(.description)"' 2>/dev/null || echo "$response"
    else
        echo -e "${RED}‚ùå Failed to fetch achievements${NC}"
    fi
}

# Add to bucket list
add_bucket() {
    local location="$1"
    shift
    
    local notes=""
    local priority="3"
    
    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --notes) notes="$2"; shift 2 ;;
            --priority) priority="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    echo -e "${BLUE}üìù Adding ${location} to bucket list...${NC}"
    echo -e "${GREEN}‚úÖ Added to bucket list!${NC}"
}

# List bucket list
list_bucket() {
    echo -e "${BLUE}üìù Fetching bucket list...${NC}"
    
    response=$(curl -s "$API_URL/api/bucket-list")
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}Bucket List:${NC}"
        echo "$response" | jq -r '.[] | "‚≠ê\(.priority) - \(.location)"' 2>/dev/null || echo "$response"
    else
        echo -e "${RED}‚ùå Failed to fetch bucket list${NC}"
    fi
}

# Export travel data
export_data() {
    echo -e "${BLUE}üì• Exporting travel data...${NC}"
    
    local filename="travel-export-$(date +%Y%m%d-%H%M%S).json"
    
    curl -s "$API_URL/api/travels" > "$filename"
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}‚úÖ Data exported to $filename${NC}"
    else
        echo -e "${RED}‚ùå Failed to export data${NC}"
    fi
}

# Main command handler
case "$1" in
    add)
        shift
        if [[ -z "$1" ]]; then
            echo -e "${RED}‚ùå Please provide a location${NC}"
            exit 1
        fi
        add_travel "$@"
        ;;
    list)
        list_travels
        ;;
    stats)
        show_stats
        ;;
    achievements)
        show_achievements
        ;;
    bucket-add)
        shift
        if [[ -z "$1" ]]; then
            echo -e "${RED}‚ùå Please provide a location${NC}"
            exit 1
        fi
        add_bucket "$@"
        ;;
    bucket-list)
        list_bucket
        ;;
    export)
        export_data
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac