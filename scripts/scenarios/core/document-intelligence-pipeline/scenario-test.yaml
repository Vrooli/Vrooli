version: 1.0
scenario: document-intelligence-pipeline

# Structure validation
structure:
  required_files:
    - .vrooli/service.json
    - initialization/storage/schema.sql
    - initialization/storage/seed.sql
    - initialization/automation/n8n/main-workflow.json
    - initialization/automation/windmill/windmill-app.json
    - initialization/automation/triggers.yaml
    - initialization/configuration/app-config.json
    - initialization/configuration/feature-flags.json
    - initialization/configuration/resource-urls.json
    - deployment/startup.sh
    - test.sh
    - custom-tests.sh
  
  required_dirs:
    - initialization/storage
    - initialization/automation
    - initialization/configuration
    - deployment

# Resource requirements
resources:
  required: [postgres, qdrant, unstructured-io, ollama]
  optional: [browserless]
  health_timeout: 60

# Declarative tests
tests:
  - name: "PostgreSQL Database Ready"
    type: database
    service: postgres
    database: document_intelligence_pipeline
    query: "SELECT table_name FROM information_schema.tables WHERE table_schema = 'document_intelligence_pipeline'"
    expect:
      contains: ["documents", "document_chunks", "processing_jobs", "extracted_entities"]
      
  - name: "Qdrant Vector Database Ready"
    type: http
    service: qdrant
    endpoint: /collections
    method: GET
    expect:
      status: 200
      body:
        type: json
        
  - name: "Unstructured-IO Document Processing Ready"
    type: http
    service: unstructured-io
    endpoint: /healthcheck
    method: GET
    expect:
      status: 200
      
  - name: "Ollama AI Models Ready"
    type: http
    service: ollama
    endpoint: /api/tags
    method: GET
    expect:
      status: 200
      body:
        type: json
        contains: ["llama3.1:8b", "nomic-embed-text"]
        
  - name: "Browserless Web Automation Ready (Optional)"
    type: http
    service: browserless
    endpoint: /
    method: GET
    expect:
      status: 200
    required: false

  - name: "Document Processing Pipeline Test"
    type: integration
    description: "Test document upload, processing, and search pipeline"
    workflow:
      - step: "Process Sample Document"
        type: http
        service: unstructured-io
        endpoint: /general/v0/general
        method: POST
        body:
          text: "This is a sample document for processing and analysis. It contains important business information."
        expect:
          status: 200
          response_time: 30000
          
      - step: "Generate Document Embeddings"
        type: http
        service: ollama
        endpoint: /api/embeddings
        method: POST
        body:
          model: "nomic-embed-text"
          prompt: "This is a sample document for processing and analysis."
        expect:
          status: 200
          response_time: 15000
          
      - step: "Store Vector Embeddings"
        type: http
        service: qdrant
        endpoint: /collections/documents/points
        method: PUT
        body:
          points:
            - id: "test-doc-1"
              vector: [0.1, 0.2, 0.3]  # Mock vector
              payload:
                title: "Test Document"
                content: "Sample content"
        expect:
          status: 200
          response_time: 5000
          
      - step: "Search Similar Documents"
        type: http
        service: qdrant
        endpoint: /collections/documents/points/search
        method: POST
        body:
          vector: [0.1, 0.2, 0.3]  # Mock query vector
          limit: 5
          score_threshold: 0.5
        expect:
          status: 200
          response_time: 5000

  - name: "AI Analysis and Classification Test"
    type: integration
    description: "Test AI-powered document analysis and entity extraction"
    workflow:
      - step: "Analyze Document Content"
        type: http
        service: ollama
        endpoint: /api/generate
        method: POST
        body:
          model: "llama3.1:8b"
          prompt: "Extract key entities and classify this document: This is a business contract between Company A and Company B."
          stream: false
        expect:
          status: 200
          response_time: 30000

  - name: "Document Intelligence Business Logic"
    type: custom
    script: custom-tests.sh
    function: test_document_intelligence_workflow

# Validation criteria
validation:
  success_rate: 85        # High success rate for enterprise document processing
  response_time: 30000    # 30 seconds max for complex document processing
  revenue_potential: 41000  # Based on service.json business model
  business_criteria:
    - "All core document processing services operational"
    - "Document parsing and text extraction working end-to-end"
    - "Vector database storing and searching document embeddings"
    - "AI analysis engine performing entity extraction and classification"
    - "Semantic search capabilities enabling intelligent document discovery"
    - "Database properly storing document metadata and processing results"
    - "Integration pipeline handles document-to-insight workflows"
    - "Enterprise-grade document intelligence capabilities functional"