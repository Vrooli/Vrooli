{
  "name": "macro-tracker",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "macro-tracker",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 100]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "user_id",
              "value": "demo-user-123"
            },
            {
              "name": "date",
              "value": "={{ new Date().toISOString().split('T')[0] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "default-values",
      "name": "Default Values",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [450, 100]
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": [
            {
              "field1": "user_id",
              "field2": "user_id"
            }
          ]
        },
        "joinMode": "keepEverything",
        "options": {}
      },
      "id": "merge-inputs",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  COALESCE(SUM(mi.calories), 0) as total_calories,\n  COALESCE(SUM(mi.protein), 0) as total_protein,\n  COALESCE(SUM(mi.carbs), 0) as total_carbs,\n  COALESCE(SUM(mi.fat), 0) as total_fat,\n  COALESCE(SUM(mi.fiber), 0) as total_fiber,\n  COALESCE(SUM(mi.sugar), 0) as total_sugar,\n  COALESCE(SUM(mi.sodium), 0) as total_sodium,\n  COUNT(DISTINCT m.id) as meal_count,\n  COUNT(mi.id) as food_items_count\nFROM meals m\nLEFT JOIN meal_items mi ON m.id = mi.meal_id\nWHERE m.user_id = '{{ $json.user_id }}'\n  AND m.meal_date = '{{ $json.date }}';",
        "options": {}
      },
      "id": "get-daily-totals",
      "name": "Get Daily Totals",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [850, 200],
      "credentials": {
        "postgres": {
          "id": "nutrition-tracker-postgres",
          "name": "Nutrition Tracker DB"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  ug.daily_calories as target_calories,\n  ug.protein_grams as target_protein,\n  ug.carbs_grams as target_carbs,\n  ug.fat_grams as target_fat,\n  ug.fiber_grams as target_fiber,\n  ug.sugar_limit as target_sugar,\n  ug.sodium_limit as target_sodium,\n  ug.weight_goal,\n  ug.activity_level\nFROM user_goals ug\nWHERE ug.user_id = '{{ $json.user_id }}'\nORDER BY ug.created_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-user-goals",
      "name": "Get User Goals",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "nutrition-tracker-postgres",
          "name": "Nutrition Tracker DB"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "mergeByFields": {
          "values": []
        },
        "joinMode": "keepEverything",
        "options": {}
      },
      "id": "combine-data",
      "name": "Combine Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "const totals = $input.all()[0].json;\nconst goals = $input.all()[1].json;\n\n// Calculate percentages and remaining amounts\nconst calculate = (current, target) => {\n  const percentage = target > 0 ? Math.round((current / target) * 100) : 0;\n  const remaining = Math.max(0, target - current);\n  const status = percentage < 80 ? 'low' : percentage > 120 ? 'high' : 'good';\n  return { current, target, percentage, remaining, status };\n};\n\nconst result = {\n  date: $node[\"merge-inputs\"].json.date,\n  user_id: $node[\"merge-inputs\"].json.user_id,\n  summary: {\n    meal_count: totals.meal_count || 0,\n    food_items_count: totals.food_items_count || 0\n  },\n  calories: calculate(totals.total_calories || 0, goals.target_calories || 2000),\n  macros: {\n    protein: calculate(totals.total_protein || 0, goals.target_protein || 50),\n    carbs: calculate(totals.total_carbs || 0, goals.target_carbs || 250),\n    fat: calculate(totals.total_fat || 0, goals.target_fat || 65)\n  },\n  micronutrients: {\n    fiber: calculate(totals.total_fiber || 0, goals.target_fiber || 25),\n    sugar: {\n      current: totals.total_sugar || 0,\n      limit: goals.target_sugar || 50,\n      percentage: Math.round(((totals.total_sugar || 0) / (goals.target_sugar || 50)) * 100),\n      status: (totals.total_sugar || 0) > (goals.target_sugar || 50) ? 'over_limit' : 'within_limit'\n    },\n    sodium: {\n      current: totals.total_sodium || 0,\n      limit: goals.target_sodium || 2300,\n      percentage: Math.round(((totals.total_sodium || 0) / (goals.target_sodium || 2300)) * 100),\n      status: (totals.total_sodium || 0) > (goals.target_sodium || 2300) ? 'over_limit' : 'within_limit'\n    }\n  },\n  recommendations: []\n};\n\n// Generate recommendations\nif (result.calories.percentage < 50 && new Date().getHours() > 18) {\n  result.recommendations.push(\"You're significantly under your calorie goal. Consider adding a healthy evening snack.\");\n}\n\nif (result.macros.protein.percentage < 70) {\n  result.recommendations.push(\"Your protein intake is low. Try adding lean meats, eggs, or legumes to your meals.\");\n}\n\nif (result.micronutrients.fiber.percentage < 60) {\n  result.recommendations.push(\"Increase fiber intake with whole grains, fruits, and vegetables.\");\n}\n\nif (result.micronutrients.sugar.status === 'over_limit') {\n  result.recommendations.push(\"You've exceeded your sugar limit. Consider reducing sugary drinks and snacks.\");\n}\n\nif (result.micronutrients.sodium.status === 'over_limit') {\n  result.recommendations.push(\"Sodium intake is high. Reduce processed foods and restaurant meals.\");\n}\n\nreturn result;"
      },
      "id": "calculate-progress",
      "name": "Calculate Progress",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO daily_summaries (\n  user_id,\n  summary_date,\n  total_calories,\n  total_protein,\n  total_carbs,\n  total_fat,\n  total_fiber,\n  total_sugar,\n  total_sodium\n) VALUES (\n  '{{ $json.user_id }}',\n  '{{ $json.date }}',\n  {{ $json.calories.current }},\n  {{ $json.macros.protein.current }},\n  {{ $json.macros.carbs.current }},\n  {{ $json.macros.fat.current }},\n  {{ $json.micronutrients.fiber.current }},\n  {{ $json.micronutrients.sugar.current }},\n  {{ $json.micronutrients.sodium.current }}\n)\nON CONFLICT (user_id, summary_date) \nDO UPDATE SET\n  total_calories = EXCLUDED.total_calories,\n  total_protein = EXCLUDED.total_protein,\n  total_carbs = EXCLUDED.total_carbs,\n  total_fat = EXCLUDED.total_fat,\n  total_fiber = EXCLUDED.total_fiber,\n  total_sugar = EXCLUDED.total_sugar,\n  total_sodium = EXCLUDED.total_sodium,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "id": "save-summary",
      "name": "Save Daily Summary",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1450, 300],
      "credentials": {
        "postgres": {
          "id": "nutrition-tracker-postgres",
          "name": "Nutrition Tracker DB"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $node[\"calculate-progress\"].json }}",
        "options": {}
      },
      "id": "respond-to-webhook",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1650, 300]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "merge-inputs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "manual-trigger": {
      "main": [
        [
          {
            "node": "default-values",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "default-values": {
      "main": [
        [
          {
            "node": "merge-inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "merge-inputs": {
      "main": [
        [
          {
            "node": "get-daily-totals",
            "type": "main",
            "index": 0
          },
          {
            "node": "get-user-goals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-daily-totals": {
      "main": [
        [
          {
            "node": "combine-data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-user-goals": {
      "main": [
        [
          {
            "node": "combine-data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "combine-data": {
      "main": [
        [
          {
            "node": "calculate-progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calculate-progress": {
      "main": [
        [
          {
            "node": "save-summary",
            "type": "main",
            "index": 0
          },
          {
            "node": "respond-to-webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [],
  "id": "macro-tracker"
}