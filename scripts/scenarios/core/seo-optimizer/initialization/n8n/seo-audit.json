{
  "name": "seo-audit",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [260, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "seo-audit",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [260, 500]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "url",
              "value": "https://example.com"
            },
            {
              "name": "depth",
              "value": "3"
            }
          ]
        },
        "options": {}
      },
      "id": "default-values",
      "name": "Default Values",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [460, 300]
    },
    {
      "parameters": {
        "command": "bash /vrooli/cli/vrooli resource browserless screenshot '{{ $json.url }}' '/tmp/seo-screenshot-{{ $now.toMillis() }}.png' 10000"
      },
      "id": "capture-screenshot",
      "name": "Capture Screenshot",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [660, 400]
    },
    {
      "parameters": {
        "command": "bash /vrooli/cli/vrooli resource browserless scrape '{{ $json.url }}' 'body' 30000"
      },
      "id": "scrape-content",
      "name": "Scrape Page Content",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [860, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract important SEO elements from scraped content\nconst content = $json.stdout || '';\nconst url = $('default-values').item.json.url || $('webhook-trigger').item.json.url;\n\n// Extract title\nconst titleMatch = content.match(/<title[^>]*>([^<]*)<\\/title>/i);\nconst title = titleMatch ? titleMatch[1].trim() : '';\n\n// Extract meta description\nconst metaDescMatch = content.match(/<meta[^>]*name=[\"']description[\"'][^>]*content=[\"']([^\"']*)[\"']/i);\nconst metaDescription = metaDescMatch ? metaDescMatch[1].trim() : '';\n\n// Count headers\nconst h1Count = (content.match(/<h1[^>]*>/gi) || []).length;\nconst h2Count = (content.match(/<h2[^>]*>/gi) || []).length;\nconst h3Count = (content.match(/<h3[^>]*>/gi) || []).length;\n\n// Count images and check for alt tags\nconst imgMatches = content.match(/<img[^>]*>/gi) || [];\nconst totalImages = imgMatches.length;\nconst imagesWithAlt = imgMatches.filter(img => /alt=[\"'][^\"']+[\"']/i.test(img)).length;\n\n// Count links\nconst linkMatches = content.match(/<a[^>]*href=[\"'][^\"']*[\"'][^>]*>/gi) || [];\nconst totalLinks = linkMatches.length;\nconst internalLinks = linkMatches.filter(link => !/https?:\\/\\//i.test(link) || link.includes(url)).length;\nconst externalLinks = totalLinks - internalLinks;\n\n// Clean content for analysis (remove HTML tags)\nconst textContent = content.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').trim();\nconst wordCount = textContent.split(' ').filter(word => word.length > 0).length;\n\nreturn {\n  url: url,\n  extracted_data: {\n    title: title,\n    title_length: title.length,\n    meta_description: metaDescription,\n    meta_description_length: metaDescription.length,\n    h1_count: h1Count,\n    h2_count: h2Count,\n    h3_count: h3Count,\n    total_images: totalImages,\n    images_with_alt: imagesWithAlt,\n    total_links: totalLinks,\n    internal_links: internalLinks,\n    external_links: externalLinks,\n    word_count: wordCount,\n    content_sample: textContent.substring(0, 500)\n  }\n};"
      },
      "id": "extract-seo-elements",
      "name": "Extract SEO Elements",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1060, 400]
    },
    {
      "parameters": {
        "jsCode": "// Build the SEO analysis prompt\nconst data = $json.extracted_data;\nconst url = $json.url;\n\nconst prompt = `Analyze this webpage SEO data and provide a comprehensive audit:\n\nURL: ${url}\n\nExtracted Data:\n- Title: ${data.title} (${data.title_length} characters)\n- Meta Description: ${data.meta_description} (${data.meta_description_length} characters)\n- H1 Tags: ${data.h1_count}\n- H2 Tags: ${data.h2_count}\n- H3 Tags: ${data.h3_count}\n- Total Images: ${data.total_images}\n- Images with Alt Text: ${data.images_with_alt}\n- Total Links: ${data.total_links}\n- Internal Links: ${data.internal_links}\n- External Links: ${data.external_links}\n- Word Count: ${data.word_count}\n\nContent Sample:\n${data.content_sample}\n\nProvide SEO analysis as a JSON object with:\n{\n  \"overall_score\": number (0-100),\n  \"title_analysis\": {\n    \"score\": number (0-100),\n    \"issues\": [strings],\n    \"recommendations\": [strings]\n  },\n  \"meta_description_analysis\": {\n    \"score\": number (0-100),\n    \"issues\": [strings],\n    \"recommendations\": [strings]\n  },\n  \"header_structure\": {\n    \"score\": number (0-100),\n    \"issues\": [strings],\n    \"recommendations\": [strings]\n  },\n  \"content_quality\": {\n    \"score\": number (0-100),\n    \"word_count_assessment\": string,\n    \"recommendations\": [strings]\n  },\n  \"image_optimization\": {\n    \"score\": number (0-100),\n    \"alt_text_coverage\": string,\n    \"recommendations\": [strings]\n  },\n  \"link_analysis\": {\n    \"score\": number (0-100),\n    \"internal_external_ratio\": string,\n    \"recommendations\": [strings]\n  },\n  \"top_priorities\": [strings (top 3-5 most important fixes)]\n}`;\n\n// Prepare data for Ollama workflow\nreturn {\n  ...($json || {}),\n  prompt: prompt,\n  model: 'llama3.2:3b',\n  type: 'reasoning',\n  quiet: true,\n  timeout_seconds: 120\n};"
      },
      "id": "prepare-ollama-request",
      "name": "Prepare Ollama Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1260, 400]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "url": "={{ $env.SERVICE_N8N_URL }}/webhook/ollama",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "model",
              "value": "={{ $json.model }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "quiet",
              "value": "={{ $json.quiet }}"
            },
            {
              "name": "timeout_seconds",
              "value": "={{ $json.timeout_seconds }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "call-ollama-workflow",
      "name": "Call Ollama Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1460, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Parse the AI response from Ollama workflow and format final results\nconst ollamaResult = $input.item.json;\nconst aiResponse = ollamaResult.response || ollamaResult.data?.response || '{}';\nlet seoAudit;\n\ntry {\n  // The Ollama workflow returns the response as a string\n  seoAudit = typeof aiResponse === 'string' ? JSON.parse(aiResponse.trim()) : aiResponse;\n} catch (e) {\n  // If parsing fails, create a basic structure\n  seoAudit = {\n    overall_score: 50,\n    error: 'Failed to parse AI response',\n    raw_response: aiResponse\n  };\n}\n\nconst extractedData = $('extract-seo-elements').item.json.extracted_data;\nconst url = $('extract-seo-elements').item.json.url;\n\nreturn {\n  audit_id: Date.now().toString(),\n  url: url,\n  timestamp: new Date().toISOString(),\n  seo_audit: seoAudit,\n  raw_data: extractedData,\n  success: ollamaResult.success === true || ollamaResult.success === undefined\n};"
      },
      "id": "format-results",
      "name": "Format Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1660, 400]
    }
  ],
  "connections": {
    "manual-trigger": {
      "main": [[{"node": "default-values", "type": "main", "index": 0}]]
    },
    "webhook-trigger": {
      "main": [[{"node": "capture-screenshot", "type": "main", "index": 0}]]
    },
    "default-values": {
      "main": [[{"node": "capture-screenshot", "type": "main", "index": 0}]]
    },
    "capture-screenshot": {
      "main": [[{"node": "scrape-content", "type": "main", "index": 0}]]
    },
    "scrape-content": {
      "main": [[{"node": "extract-seo-elements", "type": "main", "index": 0}]]
    },
    "extract-seo-elements": {
      "main": [[{"node": "prepare-ollama-request", "type": "main", "index": 0}]]
    },
    "prepare-ollama-request": {
      "main": [[{"node": "call-ollama-workflow", "type": "main", "index": 0}]]
    },
    "call-ollama-workflow": {
      "main": [[{"node": "format-results", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "seo-audit"
  },
  "pinData": {},
  "versionId": "1.0.0",
  "triggerCount": 2,
  "tags": []
}