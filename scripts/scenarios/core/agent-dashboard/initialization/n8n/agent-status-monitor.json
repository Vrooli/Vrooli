{
  "name": "Agent Status Monitor",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "agent-dashboard/status",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide defaults for manual testing\nreturn {\n  agent_name: $json.agent_name || 'all',\n  include_metrics: $json.include_metrics !== false,\n  include_logs: $json.include_logs || false,\n  time_range: $json.time_range || '1h'\n};"
      },
      "id": "set_defaults",
      "name": "Set Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge_triggers",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [650, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM agent_dashboard.agents WHERE ($1 = 'all' OR name = $1) ORDER BY name",
        "options": {
          "queryParams": "={{ [$json.agent_name] }}"
        }
      },
      "id": "fetch_agents",
      "name": "Fetch Agents",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const agent = $json;\nconst input = $('merge_triggers').item.json;\n\n// Check agent heartbeat\nconst lastHeartbeat = agent.last_heartbeat ? new Date(agent.last_heartbeat) : null;\nconst now = new Date();\nconst heartbeatThreshold = 5 * 60 * 1000; // 5 minutes\n\nlet actualStatus = agent.status;\nif (lastHeartbeat) {\n  const timeSinceHeartbeat = now - lastHeartbeat;\n  if (timeSinceHeartbeat > heartbeatThreshold && agent.status === 'active') {\n    actualStatus = 'unresponsive';\n  }\n}\n\n// Format the agent data\nconst result = {\n  id: agent.id,\n  name: agent.name,\n  type: agent.type,\n  description: agent.description,\n  status: actualStatus,\n  last_heartbeat: agent.last_heartbeat,\n  heartbeat_age_seconds: lastHeartbeat ? Math.floor((now - lastHeartbeat) / 1000) : null,\n  configuration: agent.configuration,\n  capabilities: agent.capabilities,\n  created_at: agent.created_at,\n  updated_at: agent.updated_at\n};\n\n// Add request flags for additional data\nresult.fetch_metrics = input.include_metrics;\nresult.fetch_logs = input.include_logs;\nresult.time_range = input.time_range;\n\nreturn result;"
      },
      "id": "process_agent_status",
      "name": "Process Status",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.fetch_metrics }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check_metrics",
      "name": "Check Metrics",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT metric_type, AVG(value) as avg_value, MAX(value) as max_value, MIN(value) as min_value, unit FROM agent_dashboard.agent_metrics WHERE agent_id = $1 AND recorded_at > NOW() - INTERVAL '1 hour' * $2::int GROUP BY metric_type, unit",
        "options": {
          "queryParams": "={{ [$json.id, parseInt($json.time_range) || 1] }}"
        }
      },
      "id": "fetch_metrics",
      "name": "Fetch Metrics",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1450, 350],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Pass through agent data without metrics\nreturn {\n  ...$json,\n  metrics: null\n};"
      },
      "id": "no_metrics",
      "name": "No Metrics",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 450]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "id": "merge_metrics",
      "name": "Merge Metrics",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.fetch_logs }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check_logs",
      "name": "Check Logs",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT level, message, context, timestamp FROM agent_dashboard.agent_logs WHERE agent_id = $1 AND timestamp > NOW() - INTERVAL '1 hour' * $2::int ORDER BY timestamp DESC LIMIT 20",
        "options": {
          "queryParams": "={{ [$json.id, parseInt($json.time_range) || 1] }}"
        }
      },
      "id": "fetch_logs",
      "name": "Fetch Logs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2050, 350],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Pass through without logs\nreturn {\n  ...$json,\n  recent_logs: null\n};"
      },
      "id": "no_logs",
      "name": "No Logs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 450]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "id": "merge_logs",
      "name": "Merge Logs",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2250, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Clean up and format final response\nconst agent = $json;\nconst metricsData = $('fetch_metrics').all();\nconst logsData = $('fetch_logs').all();\n\nconst response = {\n  id: agent.id,\n  name: agent.name,\n  type: agent.type,\n  description: agent.description,\n  status: agent.status,\n  last_heartbeat: agent.last_heartbeat,\n  heartbeat_age_seconds: agent.heartbeat_age_seconds,\n  capabilities: agent.capabilities,\n  created_at: agent.created_at,\n  updated_at: agent.updated_at\n};\n\nif (agent.fetch_metrics && metricsData.length > 0) {\n  response.metrics = metricsData[0].json;\n}\n\nif (agent.fetch_logs && logsData.length > 0) {\n  response.recent_logs = logsData[0].json;\n}\n\nreturn response;"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2650, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "set_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "fetch_agents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_agents": {
      "main": [
        [
          {
            "node": "process_agent_status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process_agent_status": {
      "main": [
        [
          {
            "node": "check_metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_metrics": {
      "main": [
        [
          {
            "node": "fetch_metrics",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "no_metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_metrics": {
      "main": [
        [
          {
            "node": "merge_metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "no_metrics": {
      "main": [
        [
          {
            "node": "merge_metrics",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_metrics": {
      "main": [
        [
          {
            "node": "check_logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_logs": {
      "main": [
        [
          {
            "node": "fetch_logs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "no_logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_logs": {
      "main": [
        [
          {
            "node": "merge_logs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "no_logs": {
      "main": [
        [
          {
            "node": "merge_logs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_logs": {
      "main": [
        [
          {
            "node": "format_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format_response": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "agent-dashboard"
  },
  "id": "agent-status-monitor",
  "tags": []
}