{
  "name": "Resource Monitor - Main Workflow",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 30
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 30 Seconds",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT r.id, r.resource_name, r.resource_type, r.host, r.port, r.base_url, r.health_check_endpoint, r.is_critical, r.config FROM resource_monitoring.resources r WHERE r.is_enabled = true ORDER BY r.is_critical DESC, r.resource_name",
        "options": {}
      },
      "id": "get-resources",
      "name": "Get Active Resources",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "split-batches",
      "name": "Process in Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.base_url || ('http://' + $json.host + ':' + $json.port) }}{{ $json.health_check_endpoint || '/health' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "timeout": 5000,
          "response": {
            "response": {
              "fullResponse": true
            }
          },
          "redirect": {
            "redirect": {
              "followRedirects": true
            }
          }
        }
      },
      "id": "health-check",
      "name": "Health Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 240],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process health check results\nconst resource = $input.item.json;\nconst timestamp = new Date().toISOString();\n\n// Determine status based on HTTP response\nlet status = 'unknown';\nlet responseTime = 0;\nlet errorMessage = null;\n\nif (resource.statusCode) {\n  // Successful HTTP request\n  responseTime = resource.responseTime || 0;\n  \n  if (resource.statusCode >= 200 && resource.statusCode < 300) {\n    status = 'healthy';\n  } else if (resource.statusCode >= 500) {\n    status = 'down';\n    errorMessage = `HTTP ${resource.statusCode}`;\n  } else {\n    status = 'degraded';\n    errorMessage = `HTTP ${resource.statusCode}`;\n  }\n} else if (resource.error) {\n  // Failed HTTP request\n  status = 'down';\n  errorMessage = resource.error.message || 'Connection failed';\n}\n\n// Prepare metric data\nconst metric = {\n  timestamp,\n  resource_id: resource.id,\n  resource_name: resource.resource_name,\n  resource_type: resource.resource_type,\n  status,\n  response_time_ms: Math.round(responseTime),\n  error_message: errorMessage,\n  is_critical: resource.is_critical\n};\n\n// Check if status changed\nconst previousStatus = resource.current_status || 'unknown';\nmetric.status_changed = previousStatus !== status;\n\n// Determine if alert needed\nmetric.needs_alert = false;\nif (status === 'down' && resource.is_critical) {\n  metric.needs_alert = true;\n  metric.alert_severity = 'critical';\n  metric.alert_message = `Critical resource ${resource.resource_name} is DOWN`;\n} else if (status === 'down' && !resource.is_critical) {\n  metric.needs_alert = true;\n  metric.alert_severity = 'warning';\n  metric.alert_message = `Resource ${resource.resource_name} is down`;\n} else if (status === 'degraded') {\n  metric.needs_alert = true;\n  metric.alert_severity = 'warning';\n  metric.alert_message = `Resource ${resource.resource_name} is degraded (${errorMessage})`;\n}\n\nreturn metric;"
      },
      "id": "process-results",
      "name": "Process Health Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 240]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE resource_monitoring.resources SET current_status = $1, last_seen = NOW(), last_status_change = CASE WHEN current_status != $1 THEN NOW() ELSE last_status_change END WHERE id = $2 RETURNING id, resource_name, current_status",
        "options": {
          "queryReplacement": "={{ $json.status }}, ={{ $json.resource_id }}"
        }
      },
      "id": "update-status",
      "name": "Update Resource Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1340, 180],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "url": "http://localhost:9009/exec",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=INSERT INTO resource_metrics(timestamp, resource_name, resource_type, metric_type, value, status, response_time_ms, error_count, tags) VALUES('{{ $json.timestamp }}', '{{ $json.resource_name }}', '{{ $json.resource_type }}', 'availability', {{ $json.status === 'healthy' ? 1 : 0 }}, '{{ $json.status }}', {{ $json.response_time_ms }}, {{ $json.status === 'down' ? 1 : 0 }}, 'monitored=true')"
            }
          ]
        },
        "options": {
          "timeout": 3000
        }
      },
      "id": "write-questdb",
      "name": "Write to QuestDB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1340, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_alert }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-alert",
      "name": "Needs Alert?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 420]
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "get",
        "key": "=alert_throttle_{{ $json.resource_name }}_{{ $json.alert_severity }}"
      },
      "id": "check-throttle",
      "name": "Check Alert Throttle",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1560, 480],
      "credentials": {
        "redis": {
          "id": "redis-monitoring",
          "name": "Redis Monitoring"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ !$json.value || $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "id": "throttle-check",
      "name": "Not Throttled?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1780, 480]
    },
    {
      "parameters": {
        "path": "secret/data/monitoring/twilio",
        "method": "GET"
      },
      "id": "get-twilio-creds",
      "name": "Get Twilio Credentials",
      "type": "n8n-nodes-base.vault",
      "typeVersion": 1,
      "position": [2000, 540],
      "credentials": {
        "vault": {
          "id": "vault-monitoring",
          "name": "Vault Monitoring"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "from": "={{ $('get-twilio-creds').item.json.data.from_number }}",
        "to": "={{ $('get-twilio-creds').item.json.data.to_number }}",
        "message": "=ðŸš¨ {{ $json.alert_severity === 'critical' ? 'CRITICAL' : 'WARNING' }}: {{ $json.alert_message }}\\n\\nResource: {{ $json.resource_name }}\\nStatus: {{ $json.status }}\\nTime: {{ $now.format('HH:mm:ss') }}"
      },
      "id": "send-sms",
      "name": "Send SMS Alert",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [2220, 540],
      "credentials": {
        "twilioApi": {
          "id": "twilio-api",
          "name": "Twilio API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "set",
        "key": "=alert_throttle_{{ $json.resource_name }}_{{ $json.alert_severity }}",
        "value": "={{ $now }}",
        "expire": true,
        "ttl": 900
      },
      "id": "set-throttle",
      "name": "Set Alert Throttle (15min)",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [2440, 540],
      "credentials": {
        "redis": {
          "id": "redis-monitoring",
          "name": "Redis Monitoring"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO resource_monitoring.alert_history (alert_rule_id, resource_id, alert_time, severity, metric_type, metric_value, threshold_value, notification_sent, notification_channels, message) VALUES (NULL, $1, NOW(), $2, 'availability', $3, 0, $4, $5, $6)",
        "options": {
          "queryReplacement": "={{ $json.resource_id }}, ={{ $json.alert_severity }}, ={{ $json.status === 'healthy' ? 1 : 0 }}, ={{ $json.notification_sent || false }}, ={{ JSON.stringify($json.notification_channels || ['sms']) }}, ={{ $json.alert_message }}"
        }
      },
      "id": "log-alert",
      "name": "Log Alert to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2660, 540],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('split-batches').context.noItemsLeft }}",
              "value2": true
            }
          ]
        }
      },
      "id": "all-done",
      "name": "All Batches Done?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2880, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM resource_monitoring.get_resource_health_summary()",
        "options": {}
      },
      "id": "get-summary",
      "name": "Get Health Summary",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [3100, 360],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "set",
        "key": "monitoring_summary",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": 60
      },
      "id": "cache-summary",
      "name": "Cache Summary in Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [3320, 360],
      "credentials": {
        "redis": {
          "id": "redis-monitoring",
          "name": "Redis Monitoring"
        }
      }
    }
  ],
  "connections": {
    "Every 30 Seconds": {
      "main": [
        [
          {
            "node": "Get Active Resources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Active Resources": {
      "main": [
        [
          {
            "node": "Process in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process in Batches": {
      "main": [
        [
          {
            "node": "Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Health Check": {
      "main": [
        [
          {
            "node": "Process Health Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Health Results": {
      "main": [
        [
          {
            "node": "Update Resource Status",
            "type": "main",
            "index": 0
          },
          {
            "node": "Write to QuestDB",
            "type": "main",
            "index": 0
          },
          {
            "node": "Needs Alert?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Alert?": {
      "main": [
        [
          {
            "node": "Check Alert Throttle",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Check Alert Throttle": {
      "main": [
        [
          {
            "node": "Not Throttled?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Not Throttled?": {
      "main": [
        [
          {
            "node": "Get Twilio Credentials",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Get Twilio Credentials": {
      "main": [
        [
          {
            "node": "Send SMS Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send SMS Alert": {
      "main": [
        [
          {
            "node": "Set Alert Throttle (15min)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Alert Throttle (15min)": {
      "main": [
        [
          {
            "node": "Log Alert to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Resource Status": {
      "main": [
        [
          {
            "node": "All Batches Done?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write to QuestDB": {
      "main": [
        [
          {
            "node": "All Batches Done?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Alert to Database": {
      "main": [
        [
          {
            "node": "All Batches Done?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "All Batches Done?": {
      "main": [
        [
          {
            "node": "Get Health Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process in Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Health Summary": {
      "main": [
        [
          {
            "node": "Cache Summary in Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "error-handler"
  },
  "versionId": "resource-monitor-v1",
  "id": "resource-monitor-main",
  "meta": {
    "templateCreatedBy": "vrooli-monitoring",
    "instanceId": "monitoring-instance"
  },
  "tags": [
    {
      "id": "monitoring",
      "name": "Monitoring"
    },
    {
      "id": "core",
      "name": "Core Workflow"
    }
  ]
}