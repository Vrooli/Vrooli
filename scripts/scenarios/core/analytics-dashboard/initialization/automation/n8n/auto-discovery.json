{
  "name": "Resource Auto-Discovery",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "schedule-discovery",
      "name": "Hourly Discovery",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "path": "discover-resources",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "manual-trigger",
      "name": "Manual Discovery Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 500],
      "webhookId": "discover-resources"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT value FROM resource_monitoring.system_config WHERE key = 'known_services'",
        "options": {}
      },
      "id": "get-known-ports",
      "name": "Get Known Service Ports",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Parse known services configuration\nconst config = $input.item.json.value;\nconst knownServices = [];\n\n// Define resource type mapping\nconst typeMapping = {\n  'ollama': 'ai',\n  'whisper': 'ai',\n  'comfyui': 'ai',\n  'unstructured-io': 'ai',\n  'postgres': 'storage',\n  'redis': 'storage',\n  'questdb': 'storage',\n  'minio': 'storage',\n  'qdrant': 'storage',\n  'vault': 'storage',\n  'n8n': 'automation',\n  'node-red': 'automation',\n  'windmill': 'automation',\n  'huginn': 'automation',\n  'browserless': 'agent',\n  'agent-s2': 'agent',\n  'claude-code': 'agent',\n  'judge0': 'execution',\n  'searxng': 'search'\n};\n\n// Define health check endpoints\nconst healthEndpoints = {\n  'ollama': '/api/tags',\n  'postgres': null, // TCP check only\n  'redis': '/ping',\n  'questdb': '/status',\n  'minio': '/minio/health/live',\n  'qdrant': '/health',\n  'vault': '/v1/sys/health',\n  'n8n': '/healthz',\n  'node-red': '/settings',\n  'windmill': '/api/version',\n  'huginn': '/users/sign_in', // Check login page\n  'browserless': '/health',\n  'agent-s2': '/health',\n  'claude-code': '/health',\n  'judge0': '/system_info',\n  'searxng': '/healthz',\n  'whisper': '/health',\n  'comfyui': '/system_stats',\n  'unstructured-io': '/health'\n};\n\n// Define display names\nconst displayNames = {\n  'ollama': 'Ollama LLM Service',\n  'postgres': 'PostgreSQL Database',\n  'redis': 'Redis Cache',\n  'questdb': 'QuestDB Time-Series',\n  'minio': 'MinIO Object Storage',\n  'qdrant': 'Qdrant Vector Database',\n  'vault': 'HashiCorp Vault',\n  'n8n': 'n8n Workflow Automation',\n  'node-red': 'Node-RED Flow Engine',\n  'windmill': 'Windmill Platform',\n  'huginn': 'Huginn Event Processor',\n  'browserless': 'Browserless Chrome',\n  'agent-s2': 'Agent-S2 Desktop Automation',\n  'claude-code': 'Claude Code Assistant',\n  'judge0': 'Judge0 Code Executor',\n  'searxng': 'SearXNG Search Engine',\n  'whisper': 'Whisper Speech-to-Text',\n  'comfyui': 'ComfyUI Image Generation',\n  'unstructured-io': 'Unstructured.io Document Processing'\n};\n\n// Parse the known services\nfor (const [service, port] of Object.entries(config)) {\n  knownServices.push({\n    service_name: service,\n    resource_type: typeMapping[service] || 'unknown',\n    display_name: displayNames[service] || service,\n    port: port,\n    health_endpoint: healthEndpoints[service] || '/health',\n    base_url: `http://localhost:${port}`\n  });\n}\n\nreturn knownServices;"
      },
      "id": "parse-services",
      "name": "Parse Known Services",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "id": "batch-checks",
      "name": "Batch Port Checks",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [900, 400]
    },
    {
      "parameters": {
        "command": "=nc -zv localhost {{ $json.port }} -w 1 2>&1 | grep -q 'succeeded' && echo 'open' || echo 'closed'"
      },
      "id": "check-port",
      "name": "Check Port Open",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1120, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.stdout }}",
              "operation": "contains",
              "value2": "open"
            }
          ]
        }
      },
      "id": "port-open",
      "name": "Port Open?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "url": "={{ $json.base_url }}{{ $json.health_endpoint }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "timeout": 3000,
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "health-probe",
      "name": "Health Endpoint Probe",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1560, 340],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process discovery result\nconst service = $input.item.json;\nconst timestamp = new Date().toISOString();\n\n// Determine if service is healthy\nlet isHealthy = false;\nlet healthDetails = {};\n\nif (service.statusCode && service.statusCode >= 200 && service.statusCode < 300) {\n  isHealthy = true;\n  healthDetails = {\n    statusCode: service.statusCode,\n    responseTime: service.responseTime || 0\n  };\n} else if (service.health_endpoint === null) {\n  // For services without HTTP health check (like PostgreSQL), port open = healthy\n  isHealthy = true;\n  healthDetails = {\n    note: 'TCP port check only'\n  };\n}\n\n// Prepare resource data\nconst resource = {\n  resource_name: service.service_name,\n  resource_type: service.resource_type,\n  display_name: service.display_name,\n  description: `Auto-discovered ${service.display_name} on port ${service.port}`,\n  host: 'localhost',\n  port: service.port,\n  base_url: service.base_url,\n  health_check_endpoint: service.health_endpoint,\n  is_enabled: isHealthy,\n  is_critical: ['postgres', 'redis', 'vault', 'n8n', 'questdb'].includes(service.service_name),\n  current_status: isHealthy ? 'healthy' : 'down',\n  auto_discovered: true,\n  config: healthDetails,\n  discovered_at: timestamp\n};\n\nreturn resource;"
      },
      "id": "prepare-resource",
      "name": "Prepare Resource Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 340]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO resource_monitoring.resources (resource_name, resource_type, display_name, description, host, port, base_url, health_check_endpoint, is_enabled, is_critical, current_status, auto_discovered, config, discovered_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14) ON CONFLICT (resource_name) DO UPDATE SET port = $6, base_url = $7, health_check_endpoint = $8, current_status = $11, last_seen = NOW(), config = $13 RETURNING id, resource_name, resource_type",
        "options": {
          "queryReplacement": "={{ $json.resource_name }}, ={{ $json.resource_type }}, ={{ $json.display_name }}, ={{ $json.description }}, ={{ $json.host }}, ={{ $json.port }}, ={{ $json.base_url }}, ={{ $json.health_check_endpoint }}, ={{ $json.is_enabled }}, ={{ $json.is_critical }}, ={{ $json.current_status }}, ={{ $json.auto_discovered }}, ={{ JSON.stringify($json.config) }}, ={{ $json.discovered_at }}"
        }
      },
      "id": "upsert-resource",
      "name": "Upsert Resource",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2000, 340],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "url": "http://localhost:9009/exec",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "=INSERT INTO system_events(timestamp, event_type, event_source, event_action, resource_name, user_id, success, duration_ms, details) VALUES(now(), 'discovery', 'auto_discovery', 'resource_found', '{{ $json.resource_name }}', 'system', true, 0, 'Auto-discovered resource on port {{ $json.port }}')"
            }
          ]
        },
        "options": {
          "timeout": 3000
        }
      },
      "id": "log-discovery",
      "name": "Log Discovery Event",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 340],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $('batch-checks').context.noItemsLeft }}",
              "value2": true
            }
          ]
        }
      },
      "id": "batch-complete",
      "name": "Batch Complete?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2440, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as total_resources, COUNT(*) FILTER (WHERE current_status = 'healthy') as healthy_count, COUNT(*) FILTER (WHERE discovered_at > NOW() - INTERVAL '5 minutes') as newly_discovered FROM resource_monitoring.resources WHERE is_enabled = true",
        "options": {}
      },
      "id": "discovery-summary",
      "name": "Get Discovery Summary",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2660, 460],
      "credentials": {
        "postgres": {
          "id": "postgres-monitoring",
          "name": "PostgreSQL Monitoring"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Prepare discovery summary\nconst summary = $input.item.json;\nconst timestamp = new Date().toISOString();\n\nreturn {\n  discovery_complete: true,\n  timestamp,\n  total_resources: parseInt(summary.total_resources),\n  healthy_resources: parseInt(summary.healthy_count),\n  newly_discovered: parseInt(summary.newly_discovered),\n  message: `Discovery complete: ${summary.healthy_count}/${summary.total_resources} resources healthy, ${summary.newly_discovered} newly discovered`\n};"
      },
      "id": "format-summary",
      "name": "Format Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2880, 460]
    },
    {
      "parameters": {
        "resource": "database",
        "operation": "set",
        "key": "discovery_summary",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": 3600
      },
      "id": "cache-discovery",
      "name": "Cache Discovery Results",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [3100, 460],
      "credentials": {
        "redis": {
          "id": "redis-monitoring",
          "name": "Redis Monitoring"
        }
      }
    },
    {
      "parameters": {
        "command": "=/scripts/resources/port-registry.sh --action scan --range {{ $json.range }} --timeout 100"
      },
      "id": "port-scan",
      "name": "Extended Port Scan",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1120, 600],
      "continueOnFail": true
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "range",
              "value": "8000-9000"
            }
          ]
        },
        "options": {}
      },
      "id": "scan-params",
      "name": "Set Scan Parameters",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [900, 600]
    }
  ],
  "connections": {
    "Hourly Discovery": {
      "main": [
        [
          {
            "node": "Get Known Service Ports",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Discovery Trigger": {
      "main": [
        [
          {
            "node": "Get Known Service Ports",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Known Service Ports": {
      "main": [
        [
          {
            "node": "Parse Known Services",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Known Services": {
      "main": [
        [
          {
            "node": "Batch Port Checks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch Port Checks": {
      "main": [
        [
          {
            "node": "Check Port Open",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Port Open": {
      "main": [
        [
          {
            "node": "Port Open?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Port Open?": {
      "main": [
        [
          {
            "node": "Health Endpoint Probe",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Batch Complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Health Endpoint Probe": {
      "main": [
        [
          {
            "node": "Prepare Resource Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Resource Data": {
      "main": [
        [
          {
            "node": "Upsert Resource",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Resource": {
      "main": [
        [
          {
            "node": "Log Discovery Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Discovery Event": {
      "main": [
        [
          {
            "node": "Batch Complete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch Complete?": {
      "main": [
        [
          {
            "node": "Get Discovery Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Batch Port Checks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Discovery Summary": {
      "main": [
        [
          {
            "node": "Format Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Summary": {
      "main": [
        [
          {
            "node": "Cache Discovery Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Scan Parameters": {
      "main": [
        [
          {
            "node": "Extended Port Scan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "auto-discovery-v1",
  "id": "resource-auto-discovery",
  "meta": {
    "templateCreatedBy": "vrooli-monitoring",
    "instanceId": "monitoring-instance"
  },
  "tags": [
    {
      "id": "discovery",
      "name": "Discovery"
    },
    {
      "id": "setup",
      "name": "Setup"
    }
  ]
}