#!/bin/bash

# Picker Wheel CLI
# Fun random selection tool

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
API_PORT="${API_PORT:-8200}"
API_URL="${API_URL:-http://localhost:${API_PORT}}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}ðŸŽ¯ Picker Wheel CLI${NC}"
    echo
    echo "Usage: picker-wheel [command] [options]"
    echo
    echo "Commands:"
    echo "  spin [wheel-name] [--options 'opt1,opt2,opt3'] [--dry-run]"
    echo "                        Spin a wheel with custom options"
    echo "  list                  List available wheels"
    echo "  create                Create a new wheel"
    echo "  history               Show spin history"
    echo "  help                  Show this help message"
    echo
    echo "Options:"
    echo "  --options             Comma-separated list of options"
    echo "  --dry-run            Run without saving to API"
    echo
    echo "Examples:"
    echo "  picker-wheel spin dinner"
    echo "  picker-wheel spin --options 'Yes,No,Maybe'"
    echo "  picker-wheel spin --options 'Pizza,Tacos,Sushi' --dry-run"
    echo "  picker-wheel list"
    echo "  picker-wheel create"
}

spin_wheel() {
    local wheel_name=""
    local custom_options=""
    local dry_run=false
    local options=()
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --options)
                custom_options="$2"
                shift 2
                ;;
            --dry-run)
                dry_run=true
                shift
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}"
                show_help
                exit 1
                ;;
            *)
                if [ -z "$wheel_name" ]; then
                    wheel_name="$1"
                fi
                shift
                ;;
        esac
    done
    
    # Use custom options if provided
    if [ ! -z "$custom_options" ]; then
        IFS=',' read -ra options <<< "$custom_options"
        wheel_name="${wheel_name:-custom}"
    else
        # Default to yes-no if no wheel specified
        wheel_name="${wheel_name:-yes-no}"
        
        # Try to fetch wheel from API first
        if command -v curl &> /dev/null && [ "$dry_run" != "true" ]; then
            wheel_data=$(curl -s "$API_URL/api/wheels/$wheel_name" 2>/dev/null)
            if [ ! -z "$wheel_data" ] && [ "$wheel_data" != "null" ]; then
                # Extract options from API response
                mapfile -t options < <(echo "$wheel_data" | grep -o '"label":"[^"]*"' | cut -d'"' -f4)
            fi
        fi
        
        # Fall back to built-in options if API didn't work
        if [ ${#options[@]} -eq 0 ]; then
            case "$wheel_name" in
                "yes-no")
                    options=("YES! âœ…" "NO âŒ" "Maybe? ðŸ¤”")
                    ;;
                "dinner")
                    options=("Pizza ðŸ•" "Sushi ðŸ±" "Tacos ðŸŒ®" "Burger ðŸ”" "Pasta ðŸ")
                    ;;
                "d20")
                    options=($(seq 1 20))
                    ;;
                *)
                    options=("Option 1" "Option 2" "Option 3")
                    ;;
            esac
        fi
    fi
    
    echo -e "${YELLOW}ðŸŽ° Spinning the $wheel_name wheel...${NC}"
    
    # Only show animation if not in dry-run mode
    if [ "$dry_run" != "true" ]; then
        sleep 1
        # Animated spinning effect
        for i in {1..20}; do
            random_index=$((RANDOM % ${#options[@]}))
            echo -ne "\r${CYAN}    ${options[$random_index]}${NC}    "
            sleep 0.1
        done
    fi
    
    # Final result
    final_index=$((RANDOM % ${#options[@]}))
    result="${options[$final_index]}"
    
    echo -e "\r${GREEN}ðŸŽ‰ Result: $result${NC}        "
    echo
    
    # Save to API unless dry-run
    if [ "$dry_run" != "true" ] && command -v curl &> /dev/null; then
        # Build options JSON array
        options_json="["
        for i in "${!options[@]}"; do
            [ $i -gt 0 ] && options_json+=","
            # Escape quotes in option text
            escaped_opt=$(echo "${options[$i]}" | sed 's/"/\\"/g')
            options_json+="{\"label\":\"$escaped_opt\",\"weight\":1}"
        done
        options_json+="]"
        
        # Send spin request with full data
        curl -s -X POST "$API_URL/api/spin" \
            -H "Content-Type: application/json" \
            -d "{\"wheel_id\":\"$wheel_name\",\"result\":\"$result\",\"options\":$options_json}" \
            > /dev/null 2>&1 || true
    fi
}

list_wheels() {
    echo -e "${CYAN}ðŸ“‹ Available Wheels:${NC}"
    echo
    echo -e "${MAGENTA}Preset Wheels:${NC}"
    echo "  â€¢ dinner    - Dinner Decider ðŸ•"
    echo "  â€¢ yes-no    - Yes or No âœ…âŒ"
    echo "  â€¢ teams     - Team Picker ðŸ‘¥"
    echo "  â€¢ d20       - D20 Roll ðŸŽ²"
    echo "  â€¢ workout   - Workout Chooser ðŸ’ª"
    echo "  â€¢ movie     - Movie Genre ðŸŽ¬"
    echo
    
    # Try to fetch custom wheels from API
    if command -v curl &> /dev/null; then
        custom_wheels=$(curl -s "$API_URL/api/wheels" 2>/dev/null | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
        if [ ! -z "$custom_wheels" ]; then
            echo -e "${MAGENTA}Custom Wheels:${NC}"
            echo "$custom_wheels" | while read wheel; do
                echo "  â€¢ $wheel"
            done
            echo
        fi
    fi
}

create_wheel() {
    echo -e "${CYAN}ðŸŽ¨ Create Custom Wheel${NC}"
    echo
    
    read -p "Wheel name: " name
    read -p "Number of options (2-20): " num_options
    
    if [[ ! "$num_options" =~ ^[0-9]+$ ]] || [ "$num_options" -lt 2 ] || [ "$num_options" -gt 20 ]; then
        echo -e "${RED}Invalid number of options${NC}"
        exit 1
    fi
    
    options="["
    for ((i=1; i<=num_options; i++)); do
        read -p "Option $i: " option
        if [ $i -gt 1 ]; then
            options+=","
        fi
        options+="{\"label\":\"$option\",\"weight\":1}"
    done
    options+="]"
    
    echo
    echo -e "${GREEN}âœ… Wheel '$name' created with $num_options options${NC}"
    echo
    
    # Try to save to API
    if command -v curl &> /dev/null; then
        curl -s -X POST "$API_URL/api/wheels" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"$name\",\"options\":$options}" \
            > /dev/null 2>&1 || true
    fi
}

show_history() {
    echo -e "${CYAN}ðŸ“œ Recent Spin History:${NC}"
    echo
    
    # Try to fetch from API
    if command -v curl &> /dev/null; then
        history=$(curl -s "$API_URL/api/history" 2>/dev/null)
        if [ ! -z "$history" ] && [ "$history" != "[]" ]; then
            echo "$history" | grep -o '"result":"[^"]*"' | head -10 | while read line; do
                result=$(echo "$line" | cut -d'"' -f4)
                echo "  â€¢ $result"
            done
        else
            echo "  No history available"
        fi
    else
        echo "  No history available (API not reachable)"
    fi
    echo
}

# Main command handling
case "${1:-help}" in
    spin)
        shift  # Remove 'spin' from arguments
        spin_wheel "$@"  # Pass all remaining arguments
        ;;
    list)
        list_wheels
        ;;
    create)
        create_wheel
        ;;
    history)
        show_history
        ;;
    help|--help|-h)
        show_help
        ;;
    --version|-v|version)
        echo "picker-wheel version 1.0.0"
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo
        show_help
        exit 1
        ;;
esac