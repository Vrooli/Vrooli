#!/bin/bash

# Personal Relationship Manager CLI
# Manages contacts, reminders, and gift suggestions

set -e

API_URL="${API_URL:-http://localhost:39001}"
SCRIPT_NAME="relationship-manager"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    cat << EOF
Personal Relationship Manager CLI

Usage: $SCRIPT_NAME <command> [options]

Commands:
    list                    List all contacts
    add <name>             Add a new contact
    view <id>              View contact details
    update <id>            Update contact information
    delete <id>            Delete a contact
    
    interactions <id>      View interaction history
    add-interaction <id>   Log a new interaction
    
    gifts <id>             View gift ideas and history
    suggest-gift <id>      Get AI gift suggestions
    
    reminders              View upcoming reminders
    birthdays              Check upcoming birthdays
    insights <id>          Get relationship insights
    
    help                   Show this help message

Examples:
    $SCRIPT_NAME list
    $SCRIPT_NAME add "John Doe"
    $SCRIPT_NAME view 1
    $SCRIPT_NAME birthdays
    $SCRIPT_NAME suggest-gift 1

EOF
}

list_contacts() {
    echo -e "${BLUE}Fetching contacts...${NC}"
    response=$(curl -s "${API_URL}/api/contacts")
    
    if [ -z "$response" ] || [ "$response" = "[]" ]; then
        echo -e "${YELLOW}No contacts found${NC}"
        return
    fi
    
    echo -e "${GREEN}Your Contacts:${NC}"
    echo "$response" | jq -r '.[] | "\(.id). \(.name) (\(.relationship_type // "friend")) - \(.email // "no email")"'
}

add_contact() {
    local name="$1"
    if [ -z "$name" ]; then
        echo -e "${RED}Error: Contact name required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Adding contact: $name${NC}"
    
    # Prompt for additional details
    read -p "Nickname (optional): " nickname
    read -p "Relationship type (friend/family/colleague): " rel_type
    read -p "Birthday (YYYY-MM-DD, optional): " birthday
    read -p "Email (optional): " email
    read -p "Phone (optional): " phone
    read -p "Notes (optional): " notes
    read -p "Interests (comma-separated, optional): " interests
    
    # Convert interests to JSON array
    if [ -n "$interests" ]; then
        interests_json=$(echo "$interests" | jq -R 'split(",")')
    else
        interests_json="[]"
    fi
    
    # Create JSON payload
    json_data=$(jq -n \
        --arg name "$name" \
        --arg nickname "$nickname" \
        --arg rel_type "$rel_type" \
        --arg birthday "$birthday" \
        --arg email "$email" \
        --arg phone "$phone" \
        --arg notes "$notes" \
        --argjson interests "$interests_json" \
        '{
            name: $name,
            nickname: $nickname,
            relationship_type: $rel_type,
            birthday: $birthday,
            email: $email,
            phone: $phone,
            notes: $notes,
            interests: $interests
        }')
    
    response=$(curl -s -X POST "${API_URL}/api/contacts" \
        -H "Content-Type: application/json" \
        -d "$json_data")
    
    if [ -n "$response" ]; then
        echo -e "${GREEN}Contact added successfully!${NC}"
        echo "$response" | jq '.'
    else
        echo -e "${RED}Failed to add contact${NC}"
    fi
}

view_contact() {
    local id="$1"
    if [ -z "$id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Fetching contact details...${NC}"
    response=$(curl -s "${API_URL}/api/contacts/${id}")
    
    if [ -z "$response" ]; then
        echo -e "${RED}Contact not found${NC}"
        return
    fi
    
    echo -e "${GREEN}Contact Details:${NC}"
    echo "$response" | jq '.'
}

delete_contact() {
    local id="$1"
    if [ -z "$id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    read -p "Are you sure you want to delete contact $id? (y/n): " confirm
    if [ "$confirm" != "y" ]; then
        echo "Cancelled"
        return
    fi
    
    curl -s -X DELETE "${API_URL}/api/contacts/${id}"
    echo -e "${GREEN}Contact deleted${NC}"
}

view_interactions() {
    local id="$1"
    if [ -z "$id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Fetching interaction history...${NC}"
    response=$(curl -s "${API_URL}/api/contacts/${id}/interactions")
    
    if [ -z "$response" ] || [ "$response" = "[]" ]; then
        echo -e "${YELLOW}No interactions found${NC}"
        return
    fi
    
    echo -e "${GREEN}Interaction History:${NC}"
    echo "$response" | jq -r '.[] | "\(.interaction_date): \(.interaction_type) - \(.description)"'
}

add_interaction() {
    local contact_id="$1"
    if [ -z "$contact_id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Adding interaction for contact $contact_id${NC}"
    
    read -p "Type (call/text/email/in-person/gift): " type
    read -p "Date (YYYY-MM-DD): " date
    read -p "Description: " description
    read -p "Sentiment (positive/neutral/negative): " sentiment
    
    json_data=$(jq -n \
        --arg contact_id "$contact_id" \
        --arg type "$type" \
        --arg date "$date" \
        --arg description "$description" \
        --arg sentiment "$sentiment" \
        '{
            contact_id: ($contact_id | tonumber),
            interaction_type: $type,
            interaction_date: $date,
            description: $description,
            sentiment: $sentiment
        }')
    
    response=$(curl -s -X POST "${API_URL}/api/interactions" \
        -H "Content-Type: application/json" \
        -d "$json_data")
    
    echo -e "${GREEN}Interaction logged!${NC}"
}

view_gifts() {
    local id="$1"
    if [ -z "$id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Fetching gift ideas and history...${NC}"
    response=$(curl -s "${API_URL}/api/contacts/${id}/gifts")
    
    if [ -z "$response" ] || [ "$response" = "[]" ]; then
        echo -e "${YELLOW}No gifts found${NC}"
        return
    fi
    
    echo -e "${GREEN}Gift Ideas & History:${NC}"
    echo "$response" | jq -r '.[] | "\(.status): \(.gift_name) - $\(.price) (\(.occasion))"'
}

suggest_gift() {
    local id="$1"
    if [ -z "$id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Getting gift suggestions for contact $id...${NC}"
    
    # Get contact details first
    contact=$(curl -s "${API_URL}/api/contacts/${id}")
    name=$(echo "$contact" | jq -r '.name')
    interests=$(echo "$contact" | jq -r '.interests | join(", ")')
    
    # Trigger gift suggestion workflow
    response=$(curl -s -X POST "http://localhost:5678/webhook/gift-suggester" \
        -H "Content-Type: application/json" \
        -d "{
            \"contact_id\": $id,
            \"name\": \"$name\",
            \"interests\": \"$interests\",
            \"occasion\": \"birthday\",
            \"budget\": \"50-100\"
        }")
    
    echo -e "${GREEN}Gift suggestions generated!${NC}"
    echo "Check the gifts list to see new ideas"
}

view_reminders() {
    echo -e "${BLUE}Fetching upcoming reminders...${NC}"
    response=$(curl -s "${API_URL}/api/reminders")
    
    if [ -z "$response" ] || [ "$response" = "[]" ]; then
        echo -e "${YELLOW}No upcoming reminders${NC}"
        return
    fi
    
    echo -e "${GREEN}Upcoming Reminders:${NC}"
    echo "$response" | jq -r '.[] | "\(.reminder_date): \(.contact_name) - \(.message)"'
}

check_birthdays() {
    echo -e "${BLUE}Checking upcoming birthdays...${NC}"
    
    # Trigger birthday reminder workflow
    response=$(curl -s -X POST "http://localhost:5678/webhook/birthday-reminder" \
        -H "Content-Type: application/json" \
        -d '{"days_ahead": 30}')
    
    echo -e "${GREEN}Birthday check complete!${NC}"
    echo "View reminders to see upcoming birthdays"
}

get_insights() {
    local id="$1"
    if [ -z "$id" ]; then
        echo -e "${RED}Error: Contact ID required${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Analyzing relationship with contact $id...${NC}"
    
    # Trigger insights workflow
    response=$(curl -s -X POST "http://localhost:5678/webhook/relationship-insights" \
        -H "Content-Type: application/json" \
        -d "{\"contact_id\": $id}")
    
    echo -e "${GREEN}Relationship Insights:${NC}"
    echo "$response" | jq '.'
}

# Main command handling
case "$1" in
    list)
        list_contacts
        ;;
    add)
        add_contact "$2"
        ;;
    view)
        view_contact "$2"
        ;;
    update)
        echo "Update functionality coming soon"
        ;;
    delete)
        delete_contact "$2"
        ;;
    interactions)
        view_interactions "$2"
        ;;
    add-interaction)
        add_interaction "$2"
        ;;
    gifts)
        view_gifts "$2"
        ;;
    suggest-gift)
        suggest_gift "$2"
        ;;
    reminders)
        view_reminders
        ;;
    birthdays)
        check_birthdays
        ;;
    insights)
        get_insights "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac