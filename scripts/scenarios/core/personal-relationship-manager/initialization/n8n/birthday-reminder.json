{
  "name": "Birthday Reminder",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "birthday-reminder"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily Check",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "days_ahead",
              "value": "7"
            }
          ]
        }
      },
      "id": "defaults",
      "name": "Set Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [450, 500]
    },
    {
      "parameters": {
        "command": "vrooli resource postgres query \"SELECT c.*, e.event_date, e.reminder_days_before FROM contacts c JOIN events e ON c.id = e.contact_id WHERE e.event_type = 'birthday' AND e.recurring = true AND EXTRACT(DOY FROM e.event_date) BETWEEN EXTRACT(DOY FROM CURRENT_DATE) AND EXTRACT(DOY FROM CURRENT_DATE + INTERVAL '{{$json.days_ahead}} days') ORDER BY e.event_date\""
      },
      "id": "query-birthdays",
      "name": "Query Upcoming Birthdays",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const contact = $input.item.json;\nconst today = new Date();\nconst birthday = new Date(contact.event_date);\nbirthday.setFullYear(today.getFullYear());\n\nif (birthday < today) {\n  birthday.setFullYear(today.getFullYear() + 1);\n}\n\nconst daysUntil = Math.ceil((birthday - today) / (1000 * 60 * 60 * 24));\n\nlet message = '';\nlet urgency = 'normal';\n\nif (daysUntil === 0) {\n  message = `ðŸŽ‰ Today is ${contact.name}'s birthday!`;\n  urgency = 'high';\n} else if (daysUntil === 1) {\n  message = `ðŸŽ‚ Tomorrow is ${contact.name}'s birthday!`;\n  urgency = 'high';\n} else if (daysUntil <= 3) {\n  message = `ðŸ“… ${contact.name}'s birthday is in ${daysUntil} days`;\n  urgency = 'medium';\n} else {\n  message = `ðŸ“† ${contact.name}'s birthday is coming up in ${daysUntil} days`;\n  urgency = 'low';\n}\n\nconst interests = contact.interests || [];\nconst notes = contact.notes || '';\n\nreturn {\n  contact_id: contact.id,\n  name: contact.name,\n  nickname: contact.nickname,\n  birthday: birthday.toISOString().split('T')[0],\n  days_until: daysUntil,\n  message: message,\n  urgency: urgency,\n  interests: interests,\n  notes: notes,\n  email: contact.email\n};"
      },
      "id": "process-birthdays",
      "name": "Process Birthday Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.days_until}}",
              "operation": "smaller",
              "value2": 8
            }
          ]
        }
      },
      "id": "filter-upcoming",
      "name": "Filter Upcoming",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.service.n8n.url}}/webhook/gift-suggester",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "contact_id",
              "value": "={{$json.contact_id}}"
            },
            {
              "name": "name",
              "value": "={{$json.name}}"
            },
            {
              "name": "interests",
              "value": "={{$json.interests}}"
            },
            {
              "name": "occasion",
              "value": "birthday"
            }
          ]
        }
      },
      "id": "trigger-gift-suggestions",
      "name": "Get Gift Suggestions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1250, 350]
    },
    {
      "parameters": {
        "command": "vrooli resource postgres query \"INSERT INTO reminders (contact_id, reminder_type, reminder_date, message) VALUES ({{$json.contact_id}}, 'birthday', CURRENT_DATE, '{{$json.message}}') ON CONFLICT DO NOTHING\""
      },
      "id": "create-reminder",
      "name": "Create Reminder",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1250, 450]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "Birthday reminders processed"
            }
          ],
          "number": [
            {
              "name": "reminders_created",
              "value": "={{$items().length}}"
            }
          ]
        }
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1450, 400]
    },
    {
      "parameters": {},
      "id": "no-op",
      "name": "No Upcoming Birthdays",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1250, 550]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Query Upcoming Birthdays",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily Check": {
      "main": [
        [
          {
            "node": "Set Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Defaults": {
      "main": [
        [
          {
            "node": "Query Upcoming Birthdays",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Upcoming Birthdays": {
      "main": [
        [
          {
            "node": "Process Birthday Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Birthday Data": {
      "main": [
        [
          {
            "node": "Filter Upcoming",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Upcoming": {
      "main": [
        [
          {
            "node": "Get Gift Suggestions",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Reminder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Upcoming Birthdays",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Gift Suggestions": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Reminder": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "birthday-reminder"
}