{
  "name": "Mind Maps - Intelligent Builder",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mind-maps/intelligent-build",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  topic: 'Quantum Computing Fundamentals',\n  depth: 3,\n  style: 'technical',\n  max_nodes: 25,\n  include_examples: true,\n  include_relationships: true,\n  user_id: 'test-user',\n  context: 'Building a comprehensive mind map for learning'\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $execution.resumeUrl === undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Prepare the ReAct Loop context for intelligent mind map building\nconst input = items[0].json;\n\n// Define available tools for the ReAct agent\nconst tools = [\n  {\n    name: 'research_topic',\n    description: 'Research a topic to gather information for mind map nodes',\n    parameters: {\n      query: 'string',\n      depth: 'number'\n    }\n  },\n  {\n    name: 'create_node',\n    description: 'Create a new node in the mind map',\n    parameters: {\n      title: 'string',\n      description: 'string',\n      parent_id: 'string',\n      type: 'string',\n      metadata: 'object'\n    }\n  },\n  {\n    name: 'create_relationship',\n    description: 'Create a relationship between two nodes',\n    parameters: {\n      source_id: 'string',\n      target_id: 'string',\n      relationship_type: 'string',\n      label: 'string'\n    }\n  },\n  {\n    name: 'analyze_structure',\n    description: 'Analyze current mind map structure and suggest improvements',\n    parameters: {\n      nodes: 'array',\n      relationships: 'array'\n    }\n  },\n  {\n    name: 'generate_examples',\n    description: 'Generate relevant examples for a concept',\n    parameters: {\n      concept: 'string',\n      count: 'number'\n    }\n  }\n];\n\n// Create the task for the ReAct agent\nconst task = `Build a comprehensive mind map for the topic: \"${input.topic}\"\n\nRequirements:\n- Create up to ${input.max_nodes || 20} meaningful nodes\n- Organize nodes hierarchically with depth of ${input.depth || 3} levels\n- Style: ${input.style || 'balanced'}\n- Include examples: ${input.include_examples || false}\n- Include cross-relationships: ${input.include_relationships || false}\n- Context: ${input.context || 'General learning'}\n\nApproach:\n1. Research the main topic to understand key concepts\n2. Create the root node for the main topic\n3. Identify and create major subtopics as child nodes\n4. For each subtopic, add detailed concept nodes\n5. If examples are requested, add example nodes\n6. If relationships are requested, identify and create cross-connections\n7. Analyze the structure and make improvements\n8. Return the complete mind map structure`;\n\nreturn [{\n  json: {\n    task: task,\n    tools: tools,\n    context: {\n      user_id: input.user_id,\n      topic: input.topic,\n      requirements: input\n    },\n    max_iterations: 15,\n    model: 'llama3.2',\n    temperature: 0.7,\n    validation_rules: [\n      'Must create hierarchical structure',\n      'Node descriptions must be informative',\n      'Relationships must be meaningful'\n    ]\n  }\n}];"
      },
      "id": "prepare-react-context",
      "name": "Prepare ReAct Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_react-loop-engine', 'string') }}",
        "workflowData": "={{ JSON.stringify($json) }}",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "react-loop-execution",
      "name": "ReAct Loop Execution",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "// Process ReAct results and build final mind map structure\nconst reactResult = items[0].json;\nconst input = $input.all()[0].json;\n\n// Initialize mind map structure\nlet mindMap = {\n  id: `mindmap_${Date.now()}`,\n  title: input.topic,\n  user_id: input.user_id,\n  nodes: [],\n  relationships: [],\n  metadata: {\n    created_at: new Date().toISOString(),\n    style: input.style,\n    depth: input.depth,\n    ai_generated: true\n  }\n};\n\n// Parse the ReAct execution results\ntry {\n  const actions = reactResult.actions || [];\n  const nodeMap = new Map();\n  \n  // Process all create_node actions\n  actions.forEach(action => {\n    if (action.tool === 'create_node' && action.result) {\n      const node = {\n        id: `node_${mindMap.nodes.length + 1}`,\n        title: action.parameters.title,\n        description: action.parameters.description,\n        parent_id: action.parameters.parent_id || null,\n        type: action.parameters.type || 'concept',\n        metadata: action.parameters.metadata || {},\n        position: calculateNodePosition(mindMap.nodes.length)\n      };\n      mindMap.nodes.push(node);\n      nodeMap.set(node.title, node.id);\n    }\n  });\n  \n  // Process all create_relationship actions\n  actions.forEach(action => {\n    if (action.tool === 'create_relationship' && action.result) {\n      const relationship = {\n        id: `rel_${mindMap.relationships.length + 1}`,\n        source: action.parameters.source_id,\n        target: action.parameters.target_id,\n        type: action.parameters.relationship_type || 'related',\n        label: action.parameters.label || ''\n      };\n      mindMap.relationships.push(relationship);\n    }\n  });\n  \n  // If no nodes were created, create a basic structure\n  if (mindMap.nodes.length === 0) {\n    mindMap.nodes = [\n      {\n        id: 'node_1',\n        title: input.topic,\n        description: `Central concept for ${input.topic}`,\n        parent_id: null,\n        type: 'root',\n        position: { x: 0, y: 0 }\n      },\n      {\n        id: 'node_2',\n        title: 'Key Concepts',\n        description: 'Important concepts to understand',\n        parent_id: 'node_1',\n        type: 'category',\n        position: { x: -200, y: 100 }\n      },\n      {\n        id: 'node_3',\n        title: 'Applications',\n        description: 'Practical applications and use cases',\n        parent_id: 'node_1',\n        type: 'category',\n        position: { x: 200, y: 100 }\n      }\n    ];\n  }\n  \n} catch (e) {\n  console.error('Error processing ReAct results:', e);\n}\n\n// Helper function to calculate node positions\nfunction calculateNodePosition(index) {\n  const angle = (index * 2 * Math.PI) / 8;\n  const radius = 150 + (Math.floor(index / 8) * 100);\n  return {\n    x: Math.cos(angle) * radius,\n    y: Math.sin(angle) * radius\n  };\n}\n\n// Add summary statistics\nmindMap.statistics = {\n  total_nodes: mindMap.nodes.length,\n  total_relationships: mindMap.relationships.length,\n  max_depth: calculateMaxDepth(mindMap.nodes),\n  node_types: countNodeTypes(mindMap.nodes)\n};\n\nfunction calculateMaxDepth(nodes) {\n  let maxDepth = 0;\n  nodes.forEach(node => {\n    let depth = 0;\n    let current = node;\n    while (current.parent_id) {\n      depth++;\n      current = nodes.find(n => n.id === current.parent_id);\n      if (!current) break;\n    }\n    maxDepth = Math.max(maxDepth, depth);\n  });\n  return maxDepth;\n}\n\nfunction countNodeTypes(nodes) {\n  const types = {};\n  nodes.forEach(node => {\n    types[node.type] = (types[node.type] || 0) + 1;\n  });\n  return types;\n}\n\nreturn [{ json: mindMap }];"
      },
      "id": "process-results",
      "name": "Process Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mindmaps (id, user_id, title, data, created_at, updated_at) VALUES ($1, $2, $3, $4, NOW(), NOW()) RETURNING *",
        "additionalFields": {
          "queryParams": "={{ [$json.id, $json.user_id, $json.title, JSON.stringify($json)] }}"
        }
      },
      "id": "save-mindmap",
      "name": "Save Mind Map",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1250, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-mind-maps",
          "name": "Mind Maps DB"
        }
      }
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_embedding-generator', 'string') }}",
        "workflowData": "={{ JSON.stringify({\n  text: $json.nodes.map(n => n.title + ' ' + n.description).join(' '),\n  model: 'nomic-embed-text',\n  metadata: {\n    mindmap_id: $json.id,\n    user_id: $json.user_id,\n    topic: $json.title\n  }\n}) }}",
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "id": "generate-embeddings",
      "name": "Generate Embeddings",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.QDRANT_URL }}/collections/mindmaps/points",
        "method": "PUT",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "points",
              "value": "={{ [{\n  id: $('process-results').item.json.id,\n  vector: $json.embedding,\n  payload: {\n    mindmap_id: $('process-results').item.json.id,\n    user_id: $('process-results').item.json.user_id,\n    title: $('process-results').item.json.title,\n    node_count: $('process-results').item.json.statistics.total_nodes,\n    created_at: new Date().toISOString()\n  }\n}] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "store-in-qdrant",
      "name": "Store in Qdrant",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "content": "={{ JSON.stringify($('process-results').item.json, null, 2) }}",
        "key": "={{ `mind-maps:cache:${$('process-results').item.json.id}` }}",
        "ttl": 3600,
        "options": {}
      },
      "id": "cache-mindmap",
      "name": "Cache Mind Map",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1450, 500],
      "credentials": {
        "redis": {
          "id": "redis-mind-maps",
          "name": "Mind Maps Redis"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare final response\nconst mindMap = $('process-results').item.json;\nconst embedding = $('generate-embeddings').item.json;\n\nreturn [{\n  json: {\n    success: true,\n    mindmap: {\n      id: mindMap.id,\n      title: mindMap.title,\n      url: `http://localhost:${process.env.UI_PORT}/mindmap/${mindMap.id}`,\n      statistics: mindMap.statistics,\n      nodes_preview: mindMap.nodes.slice(0, 5).map(n => ({\n        title: n.title,\n        type: n.type\n      }))\n    },\n    message: `Successfully created mind map with ${mindMap.statistics.total_nodes} nodes and ${mindMap.statistics.total_relationships} relationships`,\n    ai_insights: {\n      complexity: mindMap.statistics.max_depth > 3 ? 'high' : mindMap.statistics.max_depth > 1 ? 'medium' : 'low',\n      coverage: mindMap.statistics.total_nodes > 20 ? 'comprehensive' : mindMap.statistics.total_nodes > 10 ? 'good' : 'basic',\n      searchable: true\n    }\n  }\n}];"
      },
      "id": "prepare-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2050, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [[{"node": "prepare-react-context", "type": "main", "index": 0}]]
    },
    "manual-trigger": {
      "main": [[{"node": "defaults", "type": "main", "index": 0}]]
    },
    "defaults": {
      "main": [[{"node": "prepare-react-context", "type": "main", "index": 0}]]
    },
    "prepare-react-context": {
      "main": [[{"node": "react-loop-execution", "type": "main", "index": 0}]]
    },
    "react-loop-execution": {
      "main": [[{"node": "process-results", "type": "main", "index": 0}]]
    },
    "process-results": {
      "main": [[
        {"node": "save-mindmap", "type": "main", "index": 0},
        {"node": "generate-embeddings", "type": "main", "index": 0},
        {"node": "cache-mindmap", "type": "main", "index": 0}
      ]]
    },
    "save-mindmap": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "generate-embeddings": {
      "main": [[{"node": "store-in-qdrant", "type": "main", "index": 0}]]
    },
    "store-in-qdrant": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "cache-mindmap": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "prepare-response": {
      "main": [[{"node": "respond", "type": "main", "index": 0}]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["mind-maps", "ai-generation", "react-loop", "intelligent"],
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "mind-maps-intelligent-builder"
  }
}