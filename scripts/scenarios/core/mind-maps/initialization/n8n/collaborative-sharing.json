{
  "name": "Mind Maps - Collaborative Sharing",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mind-maps/share",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "jsCode": "// Provide defaults for manual testing\nconst defaults = {\n  mindmap_id: 'mindmap_123456',\n  action: 'share', // share, unshare, invite, fork, merge\n  user_id: 'test-user',\n  target_users: ['user2@example.com', 'user3@example.com'],\n  permissions: {\n    view: true,\n    edit: false,\n    comment: true,\n    fork: true\n  },\n  message: 'Check out this mind map on quantum computing!',\n  expiry_days: 30\n};\n\n// Only use defaults if coming from manual trigger\nconst isManual = $execution.resumeUrl === undefined;\nif (isManual) {\n  return [{json: defaults}];\n}\n\n// Otherwise pass through webhook data\nreturn items;"
      },
      "id": "defaults",
      "name": "Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 500]
    },
    {
      "parameters": {
        "jsCode": "// Validate input and determine action type\nconst input = items[0].json;\n\n// Validate required fields\nif (!input.mindmap_id || !input.action || !input.user_id) {\n  throw new Error('Missing required fields: mindmap_id, action, or user_id');\n}\n\n// Route based on action type\nconst validActions = ['share', 'unshare', 'invite', 'fork', 'merge', 'collaborate'];\nif (!validActions.includes(input.action)) {\n  throw new Error(`Invalid action: ${input.action}. Must be one of: ${validActions.join(', ')}`);\n}\n\n// Prepare context based on action\nlet context = {\n  action: input.action,\n  mindmap_id: input.mindmap_id,\n  user_id: input.user_id,\n  timestamp: new Date().toISOString()\n};\n\nswitch(input.action) {\n  case 'share':\n  case 'invite':\n    context.target_users = input.target_users || [];\n    context.permissions = input.permissions || { view: true, edit: false, comment: false, fork: false };\n    context.message = input.message || '';\n    context.expiry_date = input.expiry_days ? \n      new Date(Date.now() + input.expiry_days * 24 * 60 * 60 * 1000).toISOString() : \n      null;\n    break;\n    \n  case 'unshare':\n    context.target_users = input.target_users || [];\n    break;\n    \n  case 'fork':\n    context.new_title = input.new_title || null;\n    context.keep_relationships = input.keep_relationships !== false;\n    break;\n    \n  case 'merge':\n    context.source_mindmap_id = input.source_mindmap_id;\n    context.merge_strategy = input.merge_strategy || 'append'; // append, replace, smart\n    break;\n    \n  case 'collaborate':\n    context.session_id = `collab_${Date.now()}`;\n    context.collaborators = input.target_users || [];\n    context.mode = input.mode || 'real-time'; // real-time, async\n    break;\n}\n\nreturn [{ json: context }];"
      },
      "id": "validate-and-route",
      "name": "Validate & Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ `SELECT m.*, u.email as owner_email, u.name as owner_name \n         FROM mindmaps m \n         JOIN users u ON m.user_id = u.id \n         WHERE m.id = '${$json.mindmap_id}'` }}",
        "options": {}
      },
      "id": "fetch-mindmap",
      "name": "Fetch Mind Map",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-mind-maps",
          "name": "Mind Maps DB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "share-condition",
              "leftValue": "={{ $json.action }}",
              "rightValue": "share",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "fork-condition",
              "leftValue": "={{ $json.action }}",
              "rightValue": "fork",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "collaborate-condition",
              "leftValue": "={{ $json.action }}",
              "rightValue": "collaborate",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "action-switch",
      "name": "Action Switch",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "// Handle sharing action\nconst context = $('validate-and-route').item.json;\nconst mindmap = items[0].json;\n\nif (!mindmap || !mindmap.id) {\n  throw new Error('Mind map not found');\n}\n\n// Check ownership\nif (mindmap.user_id !== context.user_id) {\n  throw new Error('You do not have permission to share this mind map');\n}\n\n// Generate share links for each target user\nconst shareLinks = [];\nconst shareRecords = [];\n\nfor (const targetUser of context.target_users) {\n  const shareToken = generateShareToken();\n  const shareLink = `${service.ui.url}/shared/${shareToken}`;\n  \n  shareLinks.push({\n    user: targetUser,\n    link: shareLink,\n    token: shareToken\n  });\n  \n  shareRecords.push({\n    mindmap_id: context.mindmap_id,\n    shared_with: targetUser,\n    shared_by: context.user_id,\n    permissions: JSON.stringify(context.permissions),\n    share_token: shareToken,\n    expiry_date: context.expiry_date,\n    message: context.message\n  });\n}\n\nfunction generateShareToken() {\n  return 'share_' + Math.random().toString(36).substring(2, 15) + \n         Math.random().toString(36).substring(2, 15);\n}\n\nreturn [{\n  json: {\n    action: 'share',\n    mindmap: {\n      id: mindmap.id,\n      title: mindmap.title,\n      owner: mindmap.owner_name || mindmap.owner_email\n    },\n    shares: shareLinks,\n    records: shareRecords,\n    permissions: context.permissions,\n    message: context.message,\n    expiry_date: context.expiry_date\n  }\n}];"
      },
      "id": "handle-share",
      "name": "Handle Share",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "jsCode": "// Handle fork action\nconst context = $('validate-and-route').item.json;\nconst mindmap = $('fetch-mindmap').item.json;\n\nif (!mindmap || !mindmap.id) {\n  throw new Error('Mind map not found');\n}\n\n// Create a forked copy\nconst forkedMindmap = {\n  id: `mindmap_fork_${Date.now()}`,\n  user_id: context.user_id,\n  title: context.new_title || `${mindmap.title} (Fork)`,\n  data: mindmap.data,\n  parent_mindmap_id: mindmap.id,\n  created_at: new Date().toISOString(),\n  metadata: {\n    forked_from: mindmap.id,\n    forked_by: context.user_id,\n    forked_at: new Date().toISOString(),\n    original_owner: mindmap.owner_name || mindmap.owner_email,\n    keep_relationships: context.keep_relationships\n  }\n};\n\n// Modify the data if needed\nif (typeof forkedMindmap.data === 'string') {\n  try {\n    const data = JSON.parse(forkedMindmap.data);\n    data.metadata = { ...data.metadata, ...forkedMindmap.metadata };\n    \n    // Remove relationships if requested\n    if (!context.keep_relationships) {\n      data.relationships = [];\n    }\n    \n    forkedMindmap.data = JSON.stringify(data);\n  } catch (e) {\n    console.error('Error parsing mindmap data:', e);\n  }\n}\n\nreturn [{\n  json: {\n    action: 'fork',\n    original: {\n      id: mindmap.id,\n      title: mindmap.title,\n      owner: mindmap.owner_name || mindmap.owner_email\n    },\n    forked: forkedMindmap,\n    message: `Successfully forked mind map: ${forkedMindmap.title}`\n  }\n}];"
      },
      "id": "handle-fork",
      "name": "Handle Fork",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "jsCode": "// Handle real-time collaboration setup\nconst context = $('validate-and-route').item.json;\nconst mindmap = $('fetch-mindmap').item.json;\n\nif (!mindmap || !mindmap.id) {\n  throw new Error('Mind map not found');\n}\n\n// Check permissions\nconst hasEditPermission = mindmap.user_id === context.user_id || \n  checkUserPermission(context.user_id, mindmap.id, 'edit');\n\nif (!hasEditPermission) {\n  throw new Error('You do not have permission to start a collaboration session');\n}\n\n// Create collaboration session\nconst session = {\n  id: context.session_id,\n  mindmap_id: context.mindmap_id,\n  host_user_id: context.user_id,\n  collaborators: context.collaborators,\n  mode: context.mode,\n  started_at: new Date().toISOString(),\n  status: 'active',\n  websocket_url: `${service.ws.url}/collaborate/${context.session_id}`,\n  features: {\n    real_time_sync: context.mode === 'real-time',\n    cursor_tracking: true,\n    voice_chat: false,\n    change_tracking: true,\n    auto_save: true\n  }\n};\n\n// Prepare collaboration links\nconst collaborationLinks = context.collaborators.map(user => ({\n  user: user,\n  link: `${service.ui.url}/collaborate/${context.session_id}`,\n  role: user === context.user_id ? 'host' : 'collaborator'\n}));\n\nfunction checkUserPermission(userId, mindmapId, permission) {\n  // This would normally check the database\n  // For now, return false\n  return false;\n}\n\nreturn [{\n  json: {\n    action: 'collaborate',\n    session: session,\n    mindmap: {\n      id: mindmap.id,\n      title: mindmap.title\n    },\n    collaboration_links: collaborationLinks,\n    message: `Collaboration session started. Share the links with your collaborators.`\n  }\n}];"
      },
      "id": "handle-collaborate",
      "name": "Handle Collaborate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 500]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.action === 'share' ? \n  `INSERT INTO mindmap_shares (mindmap_id, shared_with, shared_by, permissions, share_token, expiry_date, message, created_at) \n   VALUES ${$json.records.map(r => `('${r.mindmap_id}', '${r.shared_with}', '${r.shared_by}', '${r.permissions}', '${r.share_token}', ${r.expiry_date ? `'${r.expiry_date}'` : 'NULL'}, '${r.message}', NOW())`).join(', ')} \n   RETURNING *` : \n  $json.action === 'fork' ? \n  `INSERT INTO mindmaps (id, user_id, title, data, parent_mindmap_id, created_at, updated_at) \n   VALUES ('${$json.forked.id}', '${$json.forked.user_id}', '${$json.forked.title}', '${$json.forked.data}', '${$json.forked.parent_mindmap_id}', NOW(), NOW()) \n   RETURNING *` : \n  `INSERT INTO collaboration_sessions (id, mindmap_id, host_user_id, collaborators, mode, status, started_at) \n   VALUES ('${$json.session.id}', '${$json.session.mindmap_id}', '${$json.session.host_user_id}', '${JSON.stringify($json.session.collaborators)}', '${$json.session.mode}', '${$json.session.status}', NOW()) \n   RETURNING *` }}",
        "options": {}
      },
      "id": "save-to-database",
      "name": "Save to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1450, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-mind-maps",
          "name": "Mind Maps DB"
        }
      }
    },
    {
      "parameters": {
        "content": "={{ JSON.stringify($json, null, 2) }}",
        "key": "={{ $json.action === 'collaborate' ? \n  `mind-maps:collab:${$json.session.id}` : \n  $json.action === 'share' ? \n  `mind-maps:shares:${$json.mindmap.id}` : \n  `mind-maps:fork:${$json.forked.id}` }}",
        "ttl": 7200,
        "options": {}
      },
      "id": "cache-result",
      "name": "Cache Result",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1650, 400],
      "credentials": {
        "redis": {
          "id": "redis-mind-maps",
          "name": "Mind Maps Redis"
        }
      }
    },
    {
      "parameters": {
        "workflow": "={{ $fromAI('WORKFLOW_ID_smart-notification-router', 'string') }}",
        "workflowData": "={{ JSON.stringify({\n  type: $json.action === 'share' ? 'share_notification' : \n        $json.action === 'fork' ? 'fork_notification' : \n        'collaboration_invitation',\n  recipients: $json.action === 'share' ? $json.shares.map(s => s.user) : \n              $json.action === 'collaborate' ? $json.collaboration_links.map(c => c.user) : \n              [$json.original.owner],\n  data: {\n    mindmap_title: $json.mindmap?.title || $json.original?.title,\n    action: $json.action,\n    message: $json.message,\n    links: $json.shares || $json.collaboration_links || [],\n    sender: $('validate-and-route').item.json.user_id\n  },\n  channels: ['email', 'in-app'],\n  priority: 'normal'\n}) }}",
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "send-notifications",
      "name": "Send Notifications",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1850, 400],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Prepare final response\nconst action = $('validate-and-route').item.json.action;\nconst result = $('save-to-database').item.json;\n\nlet response = {\n  success: true,\n  action: action,\n  timestamp: new Date().toISOString()\n};\n\nswitch(action) {\n  case 'share':\n    const shareData = $('handle-share').item.json;\n    response.data = {\n      mindmap_id: shareData.mindmap.id,\n      shared_with: shareData.shares.length,\n      share_links: shareData.shares,\n      permissions: shareData.permissions,\n      expiry: shareData.expiry_date,\n      message: 'Mind map shared successfully'\n    };\n    break;\n    \n  case 'fork':\n    const forkData = $('handle-fork').item.json;\n    response.data = {\n      original_id: forkData.original.id,\n      forked_id: forkData.forked.id,\n      forked_title: forkData.forked.title,\n      url: `${service.ui.url}/mindmap/${forkData.forked.id}`,\n      message: forkData.message\n    };\n    break;\n    \n  case 'collaborate':\n    const collabData = $('handle-collaborate').item.json;\n    response.data = {\n      session_id: collabData.session.id,\n      mindmap_id: collabData.mindmap.id,\n      websocket_url: collabData.session.websocket_url,\n      collaboration_links: collabData.collaboration_links,\n      features: collabData.session.features,\n      message: collabData.message\n    };\n    break;\n    \n  default:\n    response.data = result;\n}\n\nreturn [{ json: response }];"
      },
      "id": "prepare-response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2250, 400]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [[{"node": "validate-and-route", "type": "main", "index": 0}]]
    },
    "manual-trigger": {
      "main": [[{"node": "defaults", "type": "main", "index": 0}]]
    },
    "defaults": {
      "main": [[{"node": "validate-and-route", "type": "main", "index": 0}]]
    },
    "validate-and-route": {
      "main": [[{"node": "fetch-mindmap", "type": "main", "index": 0}]]
    },
    "fetch-mindmap": {
      "main": [[{"node": "action-switch", "type": "main", "index": 0}]]
    },
    "action-switch": {
      "main": [
        [
          {"node": "handle-share", "type": "main", "index": 0},
          {"node": "handle-fork", "type": "main", "index": 0},
          {"node": "handle-collaborate", "type": "main", "index": 0}
        ],
        []
      ]
    },
    "handle-share": {
      "main": [[{"node": "save-to-database", "type": "main", "index": 0}]]
    },
    "handle-fork": {
      "main": [[{"node": "save-to-database", "type": "main", "index": 0}]]
    },
    "handle-collaborate": {
      "main": [[{"node": "save-to-database", "type": "main", "index": 0}]]
    },
    "save-to-database": {
      "main": [[
        {"node": "cache-result", "type": "main", "index": 0},
        {"node": "send-notifications", "type": "main", "index": 0}
      ]]
    },
    "cache-result": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "send-notifications": {
      "main": [[{"node": "prepare-response", "type": "main", "index": 0}]]
    },
    "prepare-response": {
      "main": [[{"node": "respond", "type": "main", "index": 0}]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": ["mind-maps", "collaboration", "sharing", "fork"],
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "mind-maps-collaborative-sharing"
  }
}