{
  "name": "mind-maps-export-mindmap",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "mind-maps/export/:id",
        "responseMode": "onReceived",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "id": "webhook_1"
    },
    {
      "parameters": {
        "operation": "execute",
        "query": "SELECT m.*, array_agg(json_build_object('id', n.id, 'content', n.content, 'type', n.type, 'position_x', n.position_x, 'position_y', n.position_y, 'parent_id', n.parent_id, 'metadata', n.metadata) ORDER BY n.created_at) as nodes FROM mind_maps m LEFT JOIN mind_map_nodes n ON m.id = n.mind_map_id WHERE m.id = $1 GROUP BY m.id",
        "additionalFields": {
          "queryParams": "={{ [$json.params.id] }}"
        }
      },
      "name": "Get Full Mind Map",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300],
      "id": "get_full_map",
      "credentials": {
        "postgres": {
          "id": "vrooli-postgres",
          "name": "Vrooli PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.query.format }}",
              "operation": "equals",
              "value2": "markdown"
            }
          ]
        }
      },
      "name": "Format Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [650, 300],
      "id": "format_switch",
      "outputs": 4
    },
    {
      "parameters": {
        "functionCode": "const mindMap = $json;\nconst nodes = mindMap.nodes || [];\n\n// Build tree structure\nconst nodeMap = {};\nconst rootNodes = [];\n\nnodes.forEach(node => {\n  nodeMap[node.id] = { ...node, children: [] };\n});\n\nnodes.forEach(node => {\n  if (node.parent_id && nodeMap[node.parent_id]) {\n    nodeMap[node.parent_id].children.push(nodeMap[node.id]);\n  } else if (!node.parent_id || node.type === 'root') {\n    rootNodes.push(nodeMap[node.id]);\n  }\n});\n\n// Generate markdown\nfunction nodeToMarkdown(node, level = 0) {\n  const indent = '  '.repeat(level);\n  const bullet = level === 0 ? '#' : '-';\n  let md = `${indent}${bullet} ${node.content}\\n`;\n  \n  if (node.children && node.children.length > 0) {\n    node.children.forEach(child => {\n      md += nodeToMarkdown(child, level + 1);\n    });\n  }\n  \n  return md;\n}\n\nlet markdown = `# ${mindMap.title}\\n\\n`;\nif (mindMap.description) {\n  markdown += `${mindMap.description}\\n\\n`;\n}\n\nrootNodes.forEach(root => {\n  markdown += nodeToMarkdown(root);\n});\n\nreturn { \n  format: 'markdown',\n  content: markdown,\n  filename: `${mindMap.title.replace(/[^a-z0-9]/gi, '_')}.md`\n};"
      },
      "name": "Export as Markdown",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 200],
      "id": "export_markdown"
    },
    {
      "parameters": {
        "functionCode": "const mindMap = $json;\nconst nodes = mindMap.nodes || [];\n\n// Create Graphviz DOT format\nlet dot = 'digraph MindMap {\\n';\ndot += '  rankdir=LR;\\n';\ndot += '  node [shape=box, style=rounded];\\n\\n';\n\n// Add nodes\nnodes.forEach(node => {\n  const label = node.content.replace(/\"/g, '\\\\\"');\n  const color = node.metadata?.color || '#667eea';\n  dot += `  \"${node.id}\" [label=\"${label}\", fillcolor=\"${color}\", style=\"rounded,filled\"];\\n`;\n});\n\ndot += '\\n';\n\n// Add edges\nnodes.forEach(node => {\n  if (node.parent_id) {\n    dot += `  \"${node.parent_id}\" -> \"${node.id}\";\\n`;\n  }\n});\n\ndot += '}\\n';\n\nreturn {\n  format: 'dot',\n  content: dot,\n  filename: `${mindMap.title.replace(/[^a-z0-9]/gi, '_')}.dot`\n};"
      },
      "name": "Export as DOT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 300],
      "id": "export_dot"
    },
    {
      "parameters": {
        "functionCode": "const mindMap = $json;\nconst nodes = mindMap.nodes || [];\n\n// Build OPML structure\nlet opml = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n';\nopml += '<opml version=\"2.0\">\\n';\nopml += '  <head>\\n';\nopml += `    <title>${mindMap.title}</title>\\n`;\nopml += '  </head>\\n';\nopml += '  <body>\\n';\n\n// Build tree structure\nconst nodeMap = {};\nconst rootNodes = [];\n\nnodes.forEach(node => {\n  nodeMap[node.id] = { ...node, children: [] };\n});\n\nnodes.forEach(node => {\n  if (node.parent_id && nodeMap[node.parent_id]) {\n    nodeMap[node.parent_id].children.push(nodeMap[node.id]);\n  } else if (!node.parent_id || node.type === 'root') {\n    rootNodes.push(nodeMap[node.id]);\n  }\n});\n\n// Generate OPML outline\nfunction nodeToOPML(node, indent = '    ') {\n  let opml = `${indent}<outline text=\"${node.content.replace(/\"/g, '&quot;')}\"`;  \n  if (node.children && node.children.length > 0) {\n    opml += '>\\n';\n    node.children.forEach(child => {\n      opml += nodeToOPML(child, indent + '  ');\n    });\n    opml += `${indent}</outline>\\n`;\n  } else {\n    opml += ' />\\n';\n  }\n  return opml;\n}\n\nrootNodes.forEach(root => {\n  opml += nodeToOPML(root);\n});\n\nopml += '  </body>\\n';\nopml += '</opml>';\n\nreturn {\n  format: 'opml',\n  content: opml,\n  filename: `${mindMap.title.replace(/[^a-z0-9]/gi, '_')}.opml`\n};"
      },
      "name": "Export as OPML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 400],
      "id": "export_opml"
    },
    {
      "parameters": {
        "functionCode": "const mindMap = $json;\n\n// Return raw JSON structure\nreturn {\n  format: 'json',\n  content: JSON.stringify(mindMap, null, 2),\n  filename: `${mindMap.title.replace(/[^a-z0-9]/gi, '_')}.json`,\n  data: mindMap\n};"
      },
      "name": "Export as JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 500],
      "id": "export_json"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            }
          ]
        }
      },
      "name": "Format Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1050, 350],
      "id": "format_response"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Get Full Mind Map",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Full Mind Map": {
      "main": [
        [
          {
            "node": "Format Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Switch": {
      "main": [
        [
          {
            "node": "Export as Markdown",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Export as DOT",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Export as OPML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Export as JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Export as Markdown": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Export as DOT": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Export as OPML": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Export as JSON": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "1.0.0",
  "triggerCount": 1,
  "tags": []
}