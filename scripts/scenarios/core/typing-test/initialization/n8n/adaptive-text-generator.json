{
  "name": "Adaptive Text Generator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "typing-test/generate-text",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_generate",
      "name": "Webhook - Generate Text",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Default test data for manual trigger\nreturn {\n  userId: 'test_user_' + Date.now(),\n  difficulty: 'medium',\n  targetWords: ['necessary', 'receive', 'separate', 'definitely', 'whether'],\n  problemChars: ['e', 'r', 't', 'i'],\n  userLevel: 'intermediate',\n  textLength: 'medium',\n  previousMistakes: [\n    { word: 'receive', errorCount: 5 },\n    { word: 'necessary', errorCount: 3 },\n    { char: 'e', position: 'middle', errorCount: 8 }\n  ]\n};"
      },
      "id": "test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const data = $input.item.json;\n\n// Extract user performance data\nconst difficulty = data.difficulty || 'medium';\nconst targetWords = data.targetWords || [];\nconst problemChars = data.problemChars || [];\nconst userLevel = data.userLevel || 'beginner';\nconst textLength = data.textLength || 'medium';\nconst previousMistakes = data.previousMistakes || [];\n\n// Determine text parameters\nlet wordCount, complexity;\nswitch(textLength) {\n  case 'short': wordCount = '20-30'; complexity = 'simple'; break;\n  case 'long': wordCount = '80-100'; complexity = 'complex'; break;\n  default: wordCount = '40-60'; complexity = 'moderate';\n}\n\n// Build focused word list\nconst focusWords = targetWords.slice(0, 8).join(', ');\nconst problemCharList = problemChars.slice(0, 5).join(', ');\nconst mistakeWords = previousMistakes.map(m => m.word).filter(w => w).slice(0, 5).join(', ');\n\n// Create adaptive prompt\nconst prompt = `Generate a ${wordCount}-word typing practice text that specifically targets improvement areas for a ${userLevel} typist.\n\nCustomization Requirements:\n- Difficulty: ${difficulty}\n- Must include these challenging words: ${focusWords}\n- Extra focus on characters: ${problemCharList}\n- Revisit problematic words: ${mistakeWords}\n- Text complexity: ${complexity}\n- Make it coherent and natural-sounding\n\nContent Guidelines:\n- Create a meaningful, flowing text (not random sentences)\n- Naturally incorporate the target words without forcing them\n- Use varied sentence structures to practice different typing patterns\n- Include common punctuation and capitalization\n- Make the content engaging and relevant to modern topics\n\nText Topic Suggestions: technology, productivity, learning, travel, science, or creative writing.\n\nReturn ONLY the practice text, no explanations or formatting.`;\n\nreturn {\n  prompt,\n  model: 'llama3.2:3b',\n  type: 'general',\n  quiet: true,\n  timeout_seconds: 45,\n  originalData: data\n};"
      },
      "id": "prepare_text_prompt",
      "name": "Prepare Text Generation Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:{{ $env.RESOURCE_PORTS['n8n'] }}/webhook/ollama",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "model",
              "value": "={{ $json.model }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "quiet",
              "value": "={{ $json.quiet }}"
            },
            {
              "name": "timeout_seconds",
              "value": "={{ $json.timeout_seconds }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "ollama_generate",
      "name": "Call Shared Ollama Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const ollamaResponse = $input.item.json;\nconst originalData = $input.all()[0].json.originalData;\n\n// Clean the generated text\nlet generatedText = ollamaResponse?.response || ollamaResponse?.output || '';\n\n// Basic cleaning\ngeneratedText = generatedText\n  .replace(/\\n+/g, ' ')\n  .replace(/\\s+/g, ' ')\n  .trim();\n\n// Remove any meta-commentary or instructions that might have been included\ngeneratedText = generatedText\n  .replace(/^(Here's|Here is|This is).*/i, '')\n  .replace(/^Practice text:?\\s*/i, '')\n  .trim();\n\n// Ensure proper sentence structure\nif (generatedText && !generatedText.endsWith('.') && !generatedText.endsWith('!') && !generatedText.endsWith('?')) {\n  generatedText += '.';\n}\n\n// Validate text quality\nconst wordCount = generatedText.split(/\\s+/).length;\nconst isValid = wordCount >= 15 && wordCount <= 120 && generatedText.length > 50;\n\nif (!isValid) {\n  // Fallback to a default challenging text\n  generatedText = \"Technology continues to reshape how we communicate and collaborate in our increasingly digital world. Whether we're receiving important messages or processing necessary information, typing skills remain definitely crucial for productivity. The ability to separate efficient workflows from time-consuming tasks often depends on our technological proficiency and attention to detail.\";\n}\n\nreturn {\n  text: generatedText,\n  wordCount: generatedText.split(/\\s+/).length,\n  difficulty: originalData.difficulty || 'medium',\n  isAdaptive: true,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "process_response",
      "name": "Process Generated Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "respond_with_text",
      "name": "Respond with Generated Text",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1400, 400]
    }
  ],
  "connections": {
    "webhook_generate": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "test_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "test_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "prepare_text_prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_text_prompt": {
      "main": [
        [
          {
            "node": "ollama_generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ollama_generate": {
      "main": [
        [
          {
            "node": "process_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process_response": {
      "main": [
        [
          {
            "node": "respond_with_text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "tags": []
}