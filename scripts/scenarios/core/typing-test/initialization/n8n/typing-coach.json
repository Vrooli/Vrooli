{
  "name": "Typing Coach",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "typing-test/coach",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_coach",
      "name": "Webhook - Get Coaching",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Default test data for manual trigger\nreturn {\n  userId: 'test_user_' + Date.now(),\n  sessionStats: {\n    wpm: 45,\n    accuracy: 85,\n    commonMistakes: [\n      { char: 'e', errorRate: 12 },\n      { char: 'r', errorRate: 10 },\n      { char: 't', errorRate: 8 }\n    ],\n    weakWords: ['receive', 'necessary', 'separate'],\n    strongWords: ['the', 'and', 'for'],\n    timeSpent: 120,\n    improvement: 5\n  },\n  historicalData: {\n    avgWpm: 42,\n    avgAccuracy: 83,\n    totalSessions: 15,\n    bestWpm: 52,\n    trend: 'improving'\n  }\n};"
      },
      "id": "test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const data = $input.item.json;\n\n// Extract stats\nconst { sessionStats, historicalData } = data;\nconst wpm = sessionStats?.wpm || 0;\nconst accuracy = sessionStats?.accuracy || 0;\nconst mistakes = sessionStats?.commonMistakes || [];\nconst weakWords = sessionStats?.weakWords || [];\nconst trend = historicalData?.trend || 'stable';\nconst improvement = sessionStats?.improvement || 0;\n\n// Categorize skill level\nlet skillLevel = 'beginner';\nif (wpm >= 60 && accuracy >= 95) skillLevel = 'advanced';\nelse if (wpm >= 40 && accuracy >= 90) skillLevel = 'intermediate';\n\n// Build personalized prompt\nconst mistakeList = mistakes.map(m => `${m.char} (${m.errorRate}% errors)`).join(', ');\nconst weakWordList = weakWords.slice(0, 5).join(', ');\n\nconst prompt = `You are an expert typing coach providing personalized advice. Analyze this typing session:\n\nCurrent Performance:\n- Words Per Minute: ${wpm}\n- Accuracy: ${accuracy}%\n- Skill Level: ${skillLevel}\n- Trend: ${trend}\n- Recent Improvement: ${improvement > 0 ? '+' : ''}${improvement} WPM\n\nProblem Areas:\n- Most missed characters: ${mistakeList || 'none'}\n- Challenging words: ${weakWordList || 'none'}\n\nHistorical Context:\n- Average WPM: ${historicalData?.avgWpm || wpm}\n- Best WPM: ${historicalData?.bestWpm || wpm}\n- Total Practice Sessions: ${historicalData?.totalSessions || 1}\n\nProvide:\n1. One specific technique to fix the most common mistake\n2. A focused 5-minute practice exercise\n3. An encouraging observation about their progress\n4. One advanced tip for breaking through their current plateau\n\nKeep the response concise, actionable, and motivating. Format as JSON with keys: technique, exercise, encouragement, advanced_tip.`;\n\nreturn {\n  prompt,\n  model: 'phi3.5:3.8b',\n  type: 'reasoning',\n  quiet: true,\n  timeout_seconds: 60,\n  originalData: data\n};"
      },
      "id": "prepare_coach_prompt",
      "name": "Prepare Coach Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:{{ $env.RESOURCE_PORTS['n8n'] }}/webhook/ollama",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "model",
              "value": "={{ $json.model }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "quiet",
              "value": "={{ $json.quiet }}"
            },
            {
              "name": "timeout_seconds",
              "value": "={{ $json.timeout_seconds }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "call_ollama",
      "name": "Call Shared Ollama Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const ollamaResponse = $input.item.json;\nconst originalData = $input.all()[0].json.originalData;\n\n// Parse the AI response\nlet coachingAdvice;\ntry {\n  // Try to extract JSON from the response\n  const responseText = ollamaResponse?.response || ollamaResponse?.output || '';\n  \n  // Look for JSON in the response\n  const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    coachingAdvice = JSON.parse(jsonMatch[0]);\n  } else {\n    // Fallback: parse as structured text\n    coachingAdvice = {\n      technique: 'Focus on accuracy before speed. Slow down and ensure each keystroke is deliberate.',\n      exercise: 'Type the alphabet slowly and accurately 5 times, focusing on problem letters.',\n      encouragement: 'Your consistency is improving! Keep practicing daily.',\n      advanced_tip: 'Try touch typing with your monitor turned off for 30 seconds at a time.'\n    };\n  }\n} catch (error) {\n  console.error('Failed to parse AI response:', error);\n  // Provide generic but helpful advice\n  coachingAdvice = {\n    technique: 'Focus on home row positioning. Keep your fingers on ASDF and JKL;',\n    exercise: 'Practice typing \"the quick brown fox\" 10 times, focusing on accuracy.',\n    encouragement: `Great job maintaining ${originalData.sessionStats?.wpm || 40} WPM!`,\n    advanced_tip: 'Challenge yourself with code snippets or technical documentation.'\n  };\n}\n\n// Build response with personalized elements\nconst response = {\n  success: true,\n  coaching: {\n    ...coachingAdvice,\n    personalizedMetrics: {\n      currentWpm: originalData.sessionStats?.wpm || 0,\n      targetWpm: Math.min((originalData.sessionStats?.wpm || 40) + 10, 100),\n      accuracyGoal: Math.min((originalData.sessionStats?.accuracy || 85) + 5, 100),\n      focusCharacters: (originalData.sessionStats?.commonMistakes || []).map(m => m.char).slice(0, 3)\n    },\n    practiceTexts: generatePracticeTexts(originalData.sessionStats),\n    achievementUnlocked: checkAchievements(originalData)\n  },\n  timestamp: new Date().toISOString()\n};\n\n// Helper function to generate practice texts\nfunction generatePracticeTexts(stats) {\n  const texts = [];\n  \n  // Add texts based on weak areas\n  if (stats?.weakWords?.length > 0) {\n    texts.push({\n      difficulty: 'targeted',\n      text: `Practice these words: ${stats.weakWords.join(' ')} ${stats.weakWords.join(' ')}`,\n      focus: 'weak words'\n    });\n  }\n  \n  // Add texts for common mistakes\n  if (stats?.commonMistakes?.length > 0) {\n    const problemChars = stats.commonMistakes.map(m => m.char).join('');\n    texts.push({\n      difficulty: 'targeted',\n      text: `The ${problemChars} letters need practice. Type: better letter getter setter wetter.`,\n      focus: 'problem characters'\n    });\n  }\n  \n  // Add progressive difficulty texts\n  texts.push(\n    {\n      difficulty: 'easy',\n      text: 'The quick brown fox jumps over the lazy dog.',\n      focus: 'all letters'\n    },\n    {\n      difficulty: 'medium',\n      text: 'Pack my box with five dozen liquor jugs.',\n      focus: 'varied patterns'\n    },\n    {\n      difficulty: 'hard',\n      text: 'Sphinx of black quartz, judge my vow! Waltz, nymph, for quick jigs vex Bud.',\n      focus: 'complex patterns'\n    }\n  );\n  \n  return texts;\n}\n\n// Helper function to check achievements\nfunction checkAchievements(data) {\n  const achievements = [];\n  const wpm = data.sessionStats?.wpm || 0;\n  const accuracy = data.sessionStats?.accuracy || 0;\n  const sessions = data.historicalData?.totalSessions || 0;\n  \n  if (wpm >= 30 && achievements.length === 0) achievements.push({ name: 'Speed Demon Jr.', icon: 'üèÉ' });\n  if (wpm >= 50) achievements.push({ name: 'Keyboard Warrior', icon: '‚öîÔ∏è' });\n  if (wpm >= 70) achievements.push({ name: 'Lightning Fingers', icon: '‚ö°' });\n  if (accuracy >= 95) achievements.push({ name: 'Precision Master', icon: 'üéØ' });\n  if (accuracy === 100) achievements.push({ name: 'Perfect Score', icon: 'üíØ' });\n  if (sessions >= 10) achievements.push({ name: 'Dedicated Typist', icon: 'üèÜ' });\n  if (sessions >= 50) achievements.push({ name: 'Keyboard Veteran', icon: 'üéñÔ∏è' });\n  \n  return achievements;\n}\n\nreturn response;"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1400, 300]
    }
  ],
  "connections": {
    "webhook_coach": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "test_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "test_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "prepare_coach_prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_coach_prompt": {
      "main": [
        [
          {
            "node": "call_ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "call_ollama": {
      "main": [
        [
          {
            "node": "format_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "format_response": {
      "main": [
        [
          {
            "node": "respond_webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "typing_coach_001",
  "tags": []
}