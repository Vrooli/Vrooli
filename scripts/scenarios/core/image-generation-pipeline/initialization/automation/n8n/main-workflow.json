{
  "name": "Enterprise Image Generation Pipeline - Main Workflow",
  "nodes": [
    {
      "parameters": {
        "path": "image-generation-pipeline-webhook",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "image-generation-pipeline-webhook"
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 500]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "prompt",
              "value": "Generate a professional product photo with modern aesthetic"
            },
            {
              "name": "campaign_id",
              "value": "test-campaign"
            },
            {
              "name": "brand",
              "value": "default"
            },
            {
              "name": "style",
              "value": "photorealistic"
            }
          ],
          "number": [
            {
              "name": "num_variations",
              "value": 1
            }
          ]
        },
        "options": {}
      },
      "id": "default-values",
      "name": "Default Values",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [460, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process input and prepare for image generation\nconst inputData = $input.item.json;\nconst timestamp = new Date().toISOString();\n\n// Extract generation parameters\nconst processedData = {\n  scenario_id: 'image-generation-pipeline',\n  timestamp: timestamp,\n  request_id: `img-gen-${Date.now()}`,\n  \n  // Generation parameters\n  prompt: inputData.prompt || inputData.text || inputData.description || '',\n  campaign_id: inputData.campaign_id || 'default',\n  brand: inputData.brand || 'default',\n  style: inputData.style || 'photorealistic',\n  num_variations: inputData.num_variations || 1,\n  \n  // Processing flags\n  needs_voice_processing: !!(inputData.audio_file || inputData.voice_brief),\n  needs_text_enhancement: !!(inputData.enhance_prompt || inputData.auto_enhance),\n  needs_brand_compliance: inputData.brand !== 'default',\n  \n  // Original input for reference\n  original_input: inputData,\n  processing_start: Date.now()\n};\n\n// Validate required fields\nif (!processedData.prompt && !processedData.needs_voice_processing) {\n  throw new Error('Either prompt or voice input is required');\n}\n\nreturn processedData;"
      },
      "id": "process-input",
      "name": "Process Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_text_enhancement }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-enhancement",
      "name": "Check Enhancement Needed",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.SHARED_WORKFLOW_OLLAMA_ID || 'ollama' }}",
        "workflowParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "=Enhance this image generation prompt for better quality and detail. Original prompt: {{ $json.prompt }}\n\nProvide an enhanced version that includes:\n- More specific visual details\n- Lighting and atmosphere\n- Composition suggestions\n- Technical quality markers\n\nEnhanced prompt:"
            },
            {
              "name": "model",
              "value": "llama3.1:8b"
            },
            {
              "name": "temperature",
              "value": "0.7"
            }
          ]
        }
      },
      "id": "enhance-prompt",
      "name": "Enhance Prompt (Shared Ollama)",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Prepare ComfyUI workflow for image generation\nconst inputData = $input.item.json;\n\n// Use enhanced prompt if available, otherwise original\nconst finalPrompt = inputData.enhanced_prompt || inputData.prompt;\n\n// Build ComfyUI workflow configuration\nconst comfyWorkflow = {\n  workflow_type: inputData.brand === 'default' ? 'brand-workflow' : 'qc-workflow',\n  parameters: {\n    positive_prompt: finalPrompt,\n    negative_prompt: 'blurry, low quality, distorted, watermark, text',\n    style: inputData.style,\n    steps: 30,\n    cfg: 7.5,\n    width: 1024,\n    height: 1024,\n    batch_size: inputData.num_variations || 1,\n    seed: inputData.seed || Math.floor(Math.random() * 1000000)\n  },\n  metadata: {\n    campaign_id: inputData.campaign_id,\n    brand: inputData.brand,\n    request_id: inputData.request_id,\n    timestamp: inputData.timestamp\n  }\n};\n\nreturn {\n  ...inputData,\n  comfy_workflow: comfyWorkflow,\n  final_prompt: finalPrompt\n};"
      },
      "id": "prepare-comfyui",
      "name": "Prepare ComfyUI Workflow",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "command": "# Execute ComfyUI workflow using CLI\n# This approach is more reliable than direct API calls\n\nWORKFLOW_TYPE=\"{{ $json.comfy_workflow.workflow_type }}\"\nPROMPT=\"{{ $json.comfy_workflow.parameters.positive_prompt }}\"\nSTYLE=\"{{ $json.comfy_workflow.parameters.style }}\"\nCAMPAIGN=\"{{ $json.campaign_id }}\"\n\n# Check if ComfyUI resource is available\nif command -v resource-comfyui &> /dev/null; then\n    # Use the ComfyUI CLI to generate image\n    resource-comfyui generate \\\n        --prompt \"$PROMPT\" \\\n        --style \"$STYLE\" \\\n        --workflow \"$WORKFLOW_TYPE\" \\\n        --output-format json\nelse\n    # Fallback to checking service availability\n    echo '{\"status\": \"comfyui_not_available\", \"message\": \"ComfyUI resource not found\"}'\nfi"
      },
      "id": "generate-image",
      "name": "Generate Image (ComfyUI CLI)",
      "type": "n8n-nodes-base.executeBash",
      "typeVersion": 1,
      "position": [1560, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO activity_log (event_type, event_data, campaign_id, brand, processing_time_ms, status) VALUES ($1, $2, $3, $4, $5, $6) ON CONFLICT DO NOTHING RETURNING id",
        "queryParameters": "=event_type:image_generation\nevent_data:{{ JSON.stringify($json) }}\ncampaign_id:{{ $json.campaign_id }}\nbrand:{{ $json.brand }}\nprocessing_time_ms:{{ Date.now() - $json.processing_start }}\nstatus:success",
        "options": {}
      },
      "id": "log-activity",
      "name": "Log Activity",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1780, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-image-generation",
          "name": "PostgreSQL - Image Generation"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Build final response\nconst inputData = $input.item.json;\nconst processingEndTime = Date.now();\nconst processingStartTime = inputData.processing_start || processingEndTime;\n\n// Parse generation result\nlet generationResult = {};\ntry {\n  if (typeof inputData.generation_result === 'string') {\n    generationResult = JSON.parse(inputData.generation_result);\n  } else {\n    generationResult = inputData.generation_result || {};\n  }\n} catch (e) {\n  generationResult = { status: 'parse_error', message: e.message };\n}\n\nconst response = {\n  success: generationResult.status !== 'error',\n  scenario: 'Enterprise Image Generation Pipeline',\n  scenario_id: 'image-generation-pipeline',\n  version: '1.0.0',\n  timestamp: new Date().toISOString(),\n  request_id: inputData.request_id,\n  \n  // Generation results\n  results: {\n    prompt_used: inputData.final_prompt,\n    prompt_enhanced: !!inputData.enhanced_prompt,\n    images_generated: generationResult.images || [],\n    workflow_used: inputData.comfy_workflow?.workflow_type,\n    generation_status: generationResult.status || 'unknown'\n  },\n  \n  // Metadata\n  metadata: {\n    campaign_id: inputData.campaign_id,\n    brand: inputData.brand,\n    style: inputData.style,\n    num_variations: inputData.num_variations,\n    processing_time_ms: processingEndTime - processingStartTime\n  },\n  \n  // Performance metrics\n  performance: {\n    processing_time_ms: processingEndTime - processingStartTime,\n    status: (processingEndTime - processingStartTime) < 30000 ? 'fast' : 'normal',\n    efficiency_score: Math.max(0, 100 - ((processingEndTime - processingStartTime) / 300))\n  }\n};\n\n// Add error details if generation failed\nif (!response.success) {\n  response.error = {\n    message: generationResult.message || 'Generation failed',\n    details: generationResult.error || null\n  };\n}\n\nreturn response;"
      },
      "id": "build-response",
      "name": "Build Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "={{ $json.success ? 'success' : 'error' }}"
            },
            {
              "name": "message",
              "value": "={{ $json.success ? 'Image generation completed successfully' : $json.error.message }}"
            }
          ],
          "number": [
            {
              "name": "http_code",
              "value": "={{ $json.success ? 200 : 500 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "final-response",
      "name": "Final Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [2220, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "enhanced_prompt",
              "value": "={{ $json.prompt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "pass-through",
      "name": "Pass Through Original",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1120, 500]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Default Values",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Values": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Input": {
      "main": [
        [
          {
            "node": "Check Enhancement Needed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Enhancement Needed": {
      "main": [
        [
          {
            "node": "Enhance Prompt (Shared Ollama)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pass Through Original",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enhance Prompt (Shared Ollama)": {
      "main": [
        [
          {
            "node": "Prepare ComfyUI Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Through Original": {
      "main": [
        [
          {
            "node": "Prepare ComfyUI Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare ComfyUI Workflow": {
      "main": [
        [
          {
            "node": "Generate Image (ComfyUI CLI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Image (ComfyUI CLI)": {
      "main": [
        [
          {
            "node": "Log Activity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Activity": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Response": {
      "main": [
        [
          {
            "node": "Final Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "image-generation-pipeline-main-v2",
  "id": "image-generation-pipeline-main",
  "meta": {
    "templateCreatedBy": "vrooli-scenario-generator",
    "instanceId": "image-generation-pipeline-instance"
  },
  "tags": [
    {
      "id": "image-generation-pipeline",
      "name": "Enterprise Image Generation Pipeline"
    },
    {
      "id": "vrooli-scenario",
      "name": "Vrooli Scenario"
    }
  ]
}