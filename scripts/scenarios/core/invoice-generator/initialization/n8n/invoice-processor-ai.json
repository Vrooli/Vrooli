{
  "name": "Invoice Processor AI",
  "nodes": [
    {
      "parameters": {
        "path": "invoice-process-ai",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300],
      "webhookId": "invoice-process-ai",
      "id": "webhook_trigger"
    },
    {
      "parameters": {},
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500],
      "id": "manual_trigger"
    },
    {
      "parameters": {
        "jsCode": "// Test defaults for manual trigger\nreturn {\n  mode: 'extract',\n  text: `Invoice #2025-001\n  \n  Bill To:\n  Acme Corporation\n  123 Business St, Suite 100\n  New York, NY 10001\n  \n  Date: January 17, 2025\n  Due Date: February 16, 2025\n  \n  Services:\n  - Web Development (40 hours @ $150/hr): $6,000\n  - Design Consultation (10 hours @ $200/hr): $2,000\n  \n  Subtotal: $8,000\n  Tax (8%): $640\n  Total: $8,640\n  \n  Payment Terms: Net 30\n  Please remit payment to account ending in 1234`\n};"
      },
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 500],
      "id": "set_defaults"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [600, 400],
      "id": "merge_triggers"
    },
    {
      "parameters": {
        "jsCode": "// Determine processing mode\nconst input = $input.first().json;\n\nif (input.mode === 'extract' && input.text) {\n  // Extract invoice data from text using AI\n  return {\n    use_ai: true,\n    prompt: `Extract invoice data from the following text and return as JSON with these fields:\n- invoice_number\n- client_name\n- client_address\n- issue_date (YYYY-MM-DD format)\n- due_date (YYYY-MM-DD format)\n- items (array with description, quantity, unit_price, tax_rate)\n- currency\n- payment_terms\n- notes\n\nText:\\n${input.text}\\n\\nReturn ONLY valid JSON, no additional text.`,\n    original_input: input\n  };\n} else if (input.invoice) {\n  // Process structured invoice data\n  return {\n    use_ai: false,\n    invoice: input.invoice,\n    action: input.action || 'create'\n  };\n} else {\n  throw new Error('Invalid input: provide either text for extraction or invoice object');\n}"
      },
      "name": "Determine Processing Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 400],
      "id": "determine_mode"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "ai_check",
              "leftValue": "={{ $json.use_ai }}",
              "rightValue": "={{ true }}",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Check AI Mode",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1000, 400],
      "id": "check_ai_mode"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/structured-data-extractor",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.original_input.text }}"
            },
            {
              "name": "extraction_prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "model",
              "value": "phi3.5:3.8b"
            },
            {
              "name": "output_format",
              "value": "json"
            }
          ]
        },
        "options": {}
      },
      "name": "Extract Invoice Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1200, 300],
      "id": "extract_data"
    },
    {
      "parameters": {
        "jsCode": "// Parse extracted invoice data\nconst extracted = $input.first().json;\nlet invoice = {};\n\ntry {\n  if (extracted.extracted_data) {\n    invoice = typeof extracted.extracted_data === 'string' \n      ? JSON.parse(extracted.extracted_data)\n      : extracted.extracted_data;\n  } else if (extracted.response) {\n    // Fallback to direct response parsing\n    const jsonMatch = extracted.response.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      invoice = JSON.parse(jsonMatch[0]);\n    }\n  }\n} catch (e) {\n  throw new Error('Failed to parse extracted invoice data: ' + e.message);\n}\n\n// Ensure items is an array\nif (!Array.isArray(invoice.items)) {\n  invoice.items = [];\n}\n\n// Add defaults and validate\ninvoice.invoice_number = invoice.invoice_number || `INV-${Date.now()}`;\ninvoice.issue_date = invoice.issue_date || new Date().toISOString().split('T')[0];\ninvoice.due_date = invoice.due_date || new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];\ninvoice.currency = invoice.currency || 'USD';\ninvoice.status = 'draft';\n\nreturn {\n  invoice: invoice,\n  action: 'create',\n  source: 'ai_extraction'\n};"
      },
      "name": "Parse Extracted Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 300],
      "id": "parse_extracted"
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "name": "Merge Processing Paths",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1600, 400],
      "id": "merge_paths"
    },
    {
      "parameters": {
        "jsCode": "// Calculate invoice totals and validate\nconst input = $input.first().json;\nconst invoice = input.invoice;\n\nif (!invoice) {\n  throw new Error('Invoice data is required');\n}\n\n// Validate required fields\nconst required = ['client_name', 'items'];\nfor (const field of required) {\n  if (!invoice[field]) {\n    throw new Error(`Missing required field: ${field}`);\n  }\n}\n\n// Calculate totals\nlet subtotal = 0;\nlet totalTax = 0;\nconst processedItems = [];\n\nfor (const item of invoice.items) {\n  const quantity = item.quantity || 1;\n  const unitPrice = item.unit_price || 0;\n  const taxRate = item.tax_rate || 0.08; // Default 8% tax\n  \n  const itemTotal = quantity * unitPrice;\n  const taxAmount = itemTotal * taxRate;\n  \n  processedItems.push({\n    ...item,\n    quantity: quantity,\n    unit_price: unitPrice,\n    tax_rate: taxRate,\n    item_total: itemTotal,\n    tax_amount: taxAmount,\n    total_with_tax: itemTotal + taxAmount\n  });\n  \n  subtotal += itemTotal;\n  totalTax += taxAmount;\n}\n\nconst total = subtotal + totalTax;\n\nreturn {\n  action: input.action || 'create',\n  source: input.source || 'manual',\n  invoice: {\n    ...invoice,\n    items: processedItems,\n    subtotal: subtotal,\n    total_tax: totalTax,\n    total: total,\n    created_at: new Date().toISOString()\n  }\n};"
      },
      "name": "Calculate Invoice Totals",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 400],
      "id": "calculate_totals"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/ollama",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "=Based on this invoice data, generate a professional thank you note and payment reminder (max 2 sentences):\\n\\nClient: {{ $json.invoice.client_name }}\\nTotal: {{ $json.invoice.currency }} {{ $json.invoice.total }}\\nDue Date: {{ $json.invoice.due_date }}\\nPayment Terms: {{ $json.invoice.payment_terms || 'Net 30' }}\\n\\nBe professional but friendly."
            },
            {
              "name": "model",
              "value": "phi3.5:3.8b"
            },
            {
              "name": "type",
              "value": "creative"
            },
            {
              "name": "quiet",
              "value": "={{ true }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Generate Thank You Note",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2000, 400],
      "id": "generate_note"
    },
    {
      "parameters": {
        "jsCode": "// Add AI-generated note to invoice\nconst invoice = $('Calculate Invoice Totals').first().json;\nconst aiNote = $input.first().json;\n\nif (aiNote.response && !invoice.invoice.notes) {\n  invoice.invoice.notes = aiNote.response.trim();\n}\n\nreturn invoice;"
      },
      "name": "Add AI Note",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 400],
      "id": "add_note"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.action === 'create' ? \n  `INSERT INTO invoices (\n    invoice_number, client_name, client_email, client_address,\n    issue_date, due_date, subtotal, total_tax, total,\n    currency, status, payment_terms, notes, items, created_at\n  ) VALUES (\n    '${$json.invoice.invoice_number}',\n    '${$json.invoice.client_name.replace(/'/g, \"''\")}',\n    '${($json.invoice.client_email || '').replace(/'/g, \"''\")}',\n    '${($json.invoice.client_address || '').replace(/'/g, \"''\")}',\n    '${$json.invoice.issue_date}',\n    '${$json.invoice.due_date}',\n    ${$json.invoice.subtotal},\n    ${$json.invoice.total_tax},\n    ${$json.invoice.total},\n    '${$json.invoice.currency}',\n    '${$json.invoice.status}',\n    '${($json.invoice.payment_terms || '').replace(/'/g, \"''\")}',\n    '${($json.invoice.notes || '').replace(/'/g, \"''\")}',\n    '${JSON.stringify($json.invoice.items).replace(/'/g, \"''\")}',\n    '${$json.invoice.created_at}'\n  ) RETURNING *`\n  : `SELECT * FROM invoices WHERE invoice_number = '${$json.invoice.invoice_number}'`\n}}",
        "options": {}
      },
      "name": "Save to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2400, 400],
      "credentials": {
        "postgres": {
          "id": "postgres_invoice_generator",
          "name": "Invoice Generator DB"
        }
      },
      "id": "save_to_db"
    },
    {
      "parameters": {
        "jsCode": "// Format response\nconst result = $input.first().json;\nconst processInfo = $('Add AI Note').first().json;\n\nreturn {\n  success: true,\n  message: `Invoice ${result.invoice_number} ${processInfo.action === 'create' ? 'created' : 'updated'} successfully`,\n  source: processInfo.source,\n  invoice: {\n    id: result.id,\n    invoice_number: result.invoice_number,\n    client_name: result.client_name,\n    client_email: result.client_email,\n    total: result.total,\n    currency: result.currency,\n    status: result.status,\n    issue_date: result.issue_date,\n    due_date: result.due_date,\n    notes: result.notes,\n    pdf_url: `/api/invoices/${result.invoice_number}/pdf`\n  }\n};"
      },
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2600, 400],
      "id": "format_response"
    },
    {
      "parameters": {
        "options": {}
      },
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2800, 400],
      "id": "respond"
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Test Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Test Defaults": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Determine Processing Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Processing Mode": {
      "main": [
        [
          {
            "node": "Check AI Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check AI Mode": {
      "main": [
        [
          {
            "node": "Extract Invoice Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Processing Paths",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Extract Invoice Data": {
      "main": [
        [
          {
            "node": "Parse Extracted Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Extracted Data": {
      "main": [
        [
          {
            "node": "Merge Processing Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Processing Paths": {
      "main": [
        [
          {
            "node": "Calculate Invoice Totals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Invoice Totals": {
      "main": [
        [
          {
            "node": "Generate Thank You Note",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Thank You Note": {
      "main": [
        [
          {
            "node": "Add AI Note",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add AI Note": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Database": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ai-enhanced-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "invoice-processor-ai"
  },
  "id": "invoice-processor-ai",
  "tags": []
}