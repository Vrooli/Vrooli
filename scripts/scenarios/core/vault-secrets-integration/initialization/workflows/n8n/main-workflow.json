{
  "name": "Vault Secrets Integration - Main Workflow",
  "nodes": [
    {
      "parameters": {
        "path": "vault-secrets-integration-webhook",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "vault-secrets-integration-webhook"
    },
    
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Main processing logic for Vault Secrets Integration\nconst inputData = $input.item.json;\n\n// Validate input\nif (!inputData || typeof inputData !== 'object') {\n  throw new Error('Invalid input data received');\n}\n\n// Extract and process data\nconst processedData = {\n  scenario_id: 'vault-secrets-integration',\n  timestamp: new Date().toISOString(),\n  input: inputData,\n  processing_start: Date.now()\n};\n\n// Add scenario-specific processing based on category\n{% if 'ai-assistance' in categories %}\nprocessedData.ai_processing_required = true;\nprocessedData.text_content = inputData.text || inputData.content || '';\n{% endif %}\n\n{% if 'content-creation' in categories %}\nprocessedData.content_generation_required = true;\nprocessedData.content_type = inputData.type || 'text';\n{% endif %}\n\n{% if 'business-automation' in categories %}\nprocessedData.automation_workflow = inputData.workflow || 'default';\nprocessedData.automation_steps = inputData.steps || [];\n{% endif %}\n\nreturn processedData;"
      },
      "id": "process-input",
      "name": "Process Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    
    {% if "ollama" in resources.required %}
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "llama3.1:8b"
            },
            {
              "name": "prompt", 
              "value": "={{ $json.text_content || 'Process this request for Vault Secrets Integration' }}"
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-processing",
      "name": "AI Processing (Ollama)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [680, 240],
      "executeOnce": false
    },
    {% endif %}
    
    {% if "whisper" in resources.required %}
    {
      "parameters": {
        "url": "http://localhost:8090/transcribe",
        "sendBody": true,
        "bodyContentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "audio",
              "value": "={{ $json.audio_file }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "speech-to-text",
      "name": "Speech to Text (Whisper)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [680, 360],
      "executeOnce": false
    },
    {% endif %}
    
    {% if "postgres" in resources.required %}
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO {{ scenario.id | replace('-', '_') }}.activity_log (event_type, event_data, user_identifier, processing_time_ms, status) VALUES ($1, $2, $3, $4, $5) RETURNING id",
        "additionalFields": {
          "mode": "independently"
        },
        "options": {}
      },
      "id": "log-activity",
      "name": "Log Activity",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [900, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-vault-secrets-integration",
          "name": "PostgreSQL - Vault Secrets Integration"
        }
      }
    },
    {% endif %}
    
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Finalize processing and prepare response\nconst inputData = $input.item.json;\nconst processingEndTime = Date.now();\nconst processingStartTime = inputData.processing_start || processingEndTime;\n\n// Build comprehensive response\nconst response = {\n  success: true,\n  scenario: 'Vault Secrets Integration',\n  scenario_id: 'vault-secrets-integration',\n  version: '1.0.0',\n  timestamp: new Date().toISOString(),\n  processing_time_ms: processingEndTime - processingStartTime,\n  \n  // Include original input for reference\n  request: inputData.input || {},\n  \n  // Processing results\n  results: {},\n  \n  // Metadata\n  metadata: {\n    categories: {{ categories | tojson }},\n    complexity: '{{ complexity }}',\n    resources_used: {{ resources.required | tojson }}\n  }\n};\n\n// Add scenario-specific results\n{% if 'ai-assistance' in categories %}\nif (inputData.ai_processing_required) {\n  response.results.ai_response = inputData.ai_result || 'AI processing completed';\n  response.results.ai_model = 'llama3.1:8b';\n}\n{% endif %}\n\n{% if 'content-creation' in categories %}\nif (inputData.content_generation_required) {\n  response.results.content_generated = true;\n  response.results.content_type = inputData.content_type || 'text';\n  response.results.content_url = '/api/vault-secrets-integration/content/' + Date.now();\n}\n{% endif %}\n\n{% if 'business-automation' in categories %}\nif (inputData.automation_workflow) {\n  response.results.workflow_executed = inputData.automation_workflow;\n  response.results.steps_completed = (inputData.automation_steps || []).length;\n  response.results.automation_status = 'completed';\n}\n{% endif %}\n\n// Add performance metrics\nresponse.performance = {\n  processing_time_ms: response.processing_time_ms,\n  status: response.processing_time_ms < 5000 ? 'fast' : 'normal',\n  efficiency_score: Math.max(0, 100 - (response.processing_time_ms / 100))\n};\n\n// Add business value metrics\nresponse.business_impact = {\n  category: '{{ categories[0] if categories else \"general\" }}',\n  value_delivered: true,\n  estimated_time_saved_minutes: Math.round(response.processing_time_ms / 1000 / 6), // Assume 10x efficiency\n  target_market: '{{ business.target_markets[0] if business.target_markets else \"general\" }}'\n};\n\nreturn response;"
      },
      "id": "build-response",
      "name": "Build Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message", 
              "value": "Vault Secrets Integration workflow completed successfully"
            }
          ],
          "number": [
            {
              "name": "http_code",
              "value": 200
            }
          ]
        },
        "options": {}
      },
      "id": "success-response",
      "name": "Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1340, 300]
    }
  ],
  
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    "Process Input": {
      "main": [
        [
          {% if "ollama" in resources.required %}
          {
            "node": "AI Processing (Ollama)",
            "type": "main",
            "index": 0
          },
          {% endif %}
          
          {% if "whisper" in resources.required %}
          {
            "node": "Speech to Text (Whisper)",
            "type": "main", 
            "index": 0
          },
          {% endif %}
          
          {% if "postgres" in resources.required %}
          {
            "node": "Log Activity",
            "type": "main",
            "index": 0
          },
          {% endif %}
          
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    
    {% if "ollama" in resources.required %}
    "AI Processing (Ollama)": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    {% endif %}
    
    {% if "whisper" in resources.required %}
    "Speech to Text (Whisper)": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    {% endif %}
    
    {% if "postgres" in resources.required %}
    "Log Activity": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    {% endif %}
    
    "Build Response": {
      "main": [
        [
          {
            "node": "Success Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  
  "versionId": "vault-secrets-integration-main-workflow",
  "id": "vault-secrets-integration-main",
  
  "meta": {
    "templateCreatedBy": "vrooli-scenario-generator",
    "instanceId": "vault-secrets-integration-instance"
  },
  
  "tags": [
    {
      "id": "vault-secrets-integration",
      "name": "Vault Secrets Integration"
    },
    {
      "id": "vrooli-scenario",
      "name": "Vrooli Scenario"
    }
  ]
}