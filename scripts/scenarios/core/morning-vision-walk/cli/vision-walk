#!/bin/bash

# Morning Vision Walk CLI
# AI companion for morning walks - brainstorm, plan, and understand Vrooli's state

set -euo pipefail

SCRIPT_NAME="vision-walk"
VERSION="1.0.0"
API_URL="${VISION_WALK_API_URL:-http://localhost:8900}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${MAGENTA}ðŸŒ… Morning Vision Walk - Vrooli Recursive Improvement${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1" >&2
}

print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

show_help() {
    print_header
    echo ""
    echo "Usage: $SCRIPT_NAME <command> [options]"
    echo ""
    echo "Commands:"
    echo "  start               Start a new morning vision walk session"
    echo "  message <text>      Send a message in current session"
    echo "  end                 End current session and get summary"
    echo "  context             Gather current Vrooli context"
    echo "  insights            Generate insights from conversation"
    echo "  prioritize          Prioritize tasks for the day"
    echo "  export              Export session data to file"
    echo "  export-tasks        Export tasks to task-planner scenario"
    echo "  export-to-soc       Export to stream-of-consciousness-analyzer"
    echo "  status              Check service status"
    echo "  help                Show this help message"
    echo ""
    echo "Options:"
    echo "  --session-id <id>   Specify session ID"
    echo "  --user-id <id>      Specify user ID (default: $USER)"
    echo "  --json              Output in JSON format"
    echo ""
    echo "Examples:"
    echo "  $SCRIPT_NAME start"
    echo "  $SCRIPT_NAME message \"Let's discuss scenario improvements\""
    echo "  $SCRIPT_NAME prioritize --session-id session-123"
    echo ""
    echo "Environment Variables:"
    echo "  VISION_WALK_API_URL   API endpoint (default: http://localhost:8900)"
    echo "  VISION_WALK_SESSION   Current session ID"
    echo ""
}

# API interaction functions
api_call() {
    local method=$1
    local endpoint=$2
    local data=${3:-}
    
    local url="${API_URL}${endpoint}"
    local response
    
    if [ -z "$data" ]; then
        response=$(curl -s -X "$method" "$url" -H "Content-Type: application/json" 2>/dev/null) || {
            print_error "Failed to connect to API at $url"
            return 1
        }
    else
        response=$(curl -s -X "$method" "$url" -H "Content-Type: application/json" -d "$data" 2>/dev/null) || {
            print_error "Failed to connect to API at $url"
            return 1
        }
    fi
    
    echo "$response"
}

start_session() {
    local user_id="${USER_ID:-$USER}"
    
    print_header
    print_info "Starting new morning vision walk session..."
    echo ""
    
    local response=$(api_call POST "/api/conversation/start" "{\"user_id\":\"$user_id\"}")
    
    if [ -z "$response" ]; then
        print_error "Failed to start session"
        return 1
    fi
    
    local session_id=$(echo "$response" | grep -o '"session_id":"[^"]*' | cut -d'"' -f4)
    local welcome=$(echo "$response" | grep -o '"welcome_message":"[^"]*' | cut -d'"' -f4)
    
    if [ -n "$session_id" ]; then
        # Save session ID for subsequent commands
        echo "$session_id" > /tmp/vision-walk-session
        export VISION_WALK_SESSION="$session_id"
        
        print_success "Session started: $session_id"
        echo ""
        echo -e "${CYAN}$welcome${NC}"
        echo ""
        print_info "Session ID saved. You can now send messages with:"
        echo "  $SCRIPT_NAME message \"your message here\""
        echo ""
        
        # Show initial context
        show_context
    else
        print_error "Failed to extract session ID"
        return 1
    fi
}

send_message() {
    local message="$1"
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    local user_id="${USER_ID:-$USER}"
    
    if [ -z "$session_id" ]; then
        print_error "No active session. Start one with: $SCRIPT_NAME start"
        return 1
    fi
    
    print_info "Sending message..."
    
    local data="{\"session_id\":\"$session_id\",\"user_id\":\"$user_id\",\"message\":\"$message\"}"
    local response=$(api_call POST "/api/conversation/message" "$data")
    
    if [ -z "$response" ]; then
        print_error "Failed to send message"
        return 1
    fi
    
    # Extract and display assistant response
    local assistant_msg=$(echo "$response" | grep -o '"content":"[^"]*' | head -1 | cut -d'"' -f4)
    
    if [ -n "$assistant_msg" ]; then
        echo ""
        echo -e "${GREEN}Assistant:${NC} $assistant_msg"
        echo ""
        
        # Show session stats
        local msg_count=$(echo "$response" | grep -o '"message_count":[0-9]*' | cut -d':' -f2)
        local duration=$(echo "$response" | grep -o '"duration_minutes":[0-9.]*' | cut -d':' -f2)
        local insights=$(echo "$response" | grep -o '"insights_generated":[0-9]*' | cut -d':' -f2)
        
        if [ -n "$msg_count" ]; then
            print_info "Messages: $msg_count | Duration: ${duration}min | Insights: $insights"
        fi
    fi
}

end_session() {
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    
    if [ -z "$session_id" ]; then
        print_error "No active session to end"
        return 1
    fi
    
    print_info "Ending session and generating summary..."
    
    local response=$(api_call POST "/api/conversation/end" "{\"session_id\":\"$session_id\"}")
    
    if [ -z "$response" ]; then
        print_error "Failed to end session"
        return 1
    fi
    
    # Clean up session file
    rm -f /tmp/vision-walk-session
    unset VISION_WALK_SESSION
    
    print_success "Session ended successfully"
    echo ""
    
    # Display summary
    local duration=$(echo "$response" | grep -o '"duration_minutes":[0-9.]*' | cut -d':' -f2)
    local total_msgs=$(echo "$response" | grep -o '"total_messages":[0-9]*' | cut -d':' -f2)
    local insights_count=$(echo "$response" | grep -o '"insights_generated":[0-9]*' | cut -d':' -f2)
    
    echo -e "${CYAN}Session Summary:${NC}"
    echo "  Duration: ${duration} minutes"
    echo "  Messages: ${total_msgs}"
    echo "  Insights: ${insights_count}"
    echo ""
    
    print_info "Session data has been saved. Export with:"
    echo "  $SCRIPT_NAME export --session-id $session_id"
}

show_context() {
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    local user_id="${USER_ID:-$USER}"
    
    print_info "Gathering Vrooli context..."
    
    local response=$(api_call GET "/api/context/gather?session_id=${session_id}&user_id=${user_id}")
    
    if [ -z "$response" ]; then
        print_error "Failed to gather context"
        return 1
    fi
    
    echo ""
    echo -e "${CYAN}Current Vrooli State:${NC}"
    echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
}

generate_insights() {
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    local user_id="${USER_ID:-$USER}"
    
    if [ -z "$session_id" ]; then
        print_error "No active session. Start one with: $SCRIPT_NAME start"
        return 1
    fi
    
    print_info "Generating insights from conversation..."
    
    # Get current session data first
    local session_data=$(api_call GET "/api/session/$session_id")
    
    if [ -z "$session_data" ]; then
        print_error "Failed to get session data"
        return 1
    fi
    
    local response=$(api_call POST "/api/insights/generate" "{\"session_id\":\"$session_id\",\"user_id\":\"$user_id\",\"conversation_history\":[]}")
    
    if [ -n "$response" ]; then
        print_success "Insights generated"
        echo ""
        echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
    fi
}

prioritize_tasks() {
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    local user_id="${USER_ID:-$USER}"
    
    print_info "Prioritizing tasks for optimal productivity..."
    
    local response=$(api_call POST "/api/tasks/prioritize" "{\"session_id\":\"$session_id\",\"user_id\":\"$user_id\",\"tasks\":[],\"context\":{}}")
    
    if [ -n "$response" ]; then
        print_success "Tasks prioritized"
        echo ""
        echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
    fi
}

export_session() {
    local session_id="${SESSION_ID:-$1}"
    
    if [ -z "$session_id" ]; then
        print_error "Session ID required. Use: $SCRIPT_NAME export --session-id <id>"
        return 1
    fi
    
    print_info "Exporting session data..."
    
    local response=$(api_call GET "/api/session/$session_id/export")
    local filename="vision-walk-${session_id}-$(date +%Y%m%d-%H%M%S).json"
    
    echo "$response" > "$filename"
    
    if [ -f "$filename" ]; then
        print_success "Session exported to: $filename"
    else
        print_error "Failed to export session"
        return 1
    fi
}

# Integration with stream-of-consciousness-analyzer
export_to_soc() {
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    
    if [ -z "$session_id" ]; then
        print_error "No active session to export"
        return 1
    fi
    
    print_info "Exporting conversation to Stream-of-Consciousness Analyzer..."
    
    # Get session data
    local session_data=$(api_call GET "/api/session/$session_id")
    
    if [ -z "$session_data" ]; then
        print_error "Failed to get session data"
        return 1
    fi
    
    # Extract messages and format for SoC analyzer
    local messages=$(echo "$session_data" | python3 -c "
import json
import sys
data = json.load(sys.stdin)
messages = data.get('messages', [])
text = ' '.join([msg.get('content', '') for msg in messages])
print(text)
" 2>/dev/null)
    
    if [ -z "$messages" ]; then
        print_warning "No messages found in session"
        return 1
    fi
    
    # Call stream-of-consciousness-analyzer CLI if available
    if command -v soc-analyzer &> /dev/null; then
        print_info "Sending to Stream-of-Consciousness Analyzer..."
        
        # Create a campaign for morning vision walks if needed
        soc-analyzer create-campaign "Morning Vision Walks" --description "Thoughts and plans from morning vision walks" 2>/dev/null || true
        
        # Add the conversation
        local result=$(echo "$messages" | soc-analyzer analyze --campaign "Morning Vision Walks" --source "vision-walk-$session_id" 2>/dev/null)
        
        if [ $? -eq 0 ]; then
            print_success "Successfully exported to Stream-of-Consciousness Analyzer"
            echo "$result"
        else
            print_warning "Failed to analyze with SoC analyzer"
        fi
    else
        print_warning "Stream-of-Consciousness Analyzer CLI not found"
        print_info "Install with: cd ../stream-of-consciousness-analyzer/cli && ./install-cli.sh"
    fi
}

# Integration with task-planner
export_tasks() {
    local session_id="${SESSION_ID:-${VISION_WALK_SESSION:-$(cat /tmp/vision-walk-session 2>/dev/null)}}"
    
    if [ -z "$session_id" ]; then
        print_error "No active session"
        return 1
    fi
    
    print_info "Exporting tasks to Task Planner..."
    
    # Get insights which contain extracted tasks
    local response=$(api_call POST "/api/insights/generate" "{\"session_id\":\"$session_id\",\"user_id\":\"${USER_ID:-$USER}\",\"conversation_history\":[]}")
    
    if [ -z "$response" ]; then
        print_error "Failed to generate insights"
        return 1
    fi
    
    # Extract tasks from insights
    local tasks=$(echo "$response" | python3 -c "
import json
import sys
data = json.load(sys.stdin)
tasks = data.get('tasks', [])
for task in tasks:
    print(task if isinstance(task, str) else task.get('title', ''))
" 2>/dev/null)
    
    if [ -z "$tasks" ]; then
        print_warning "No tasks found in conversation"
        return 0
    fi
    
    # Call task-planner CLI if available
    if command -v task-planner &> /dev/null; then
        while IFS= read -r task; do
            if [ -n "$task" ]; then
                print_info "Adding task: $task"
                task-planner add-task "$task" --source "vision-walk" --priority medium 2>/dev/null || true
            fi
        done <<< "$tasks"
        
        print_success "Tasks exported to Task Planner"
    else
        print_warning "Task Planner CLI not found"
        print_info "Install with: cd ../task-planner/cli && ./install-cli.sh"
        echo ""
        echo "Tasks extracted:"
        echo "$tasks"
    fi
}

check_status() {
    print_info "Checking Morning Vision Walk service status..."
    
    local response=$(api_call GET "/health")
    
    if [ -n "$response" ]; then
        local status=$(echo "$response" | grep -o '"status":"[^"]*' | cut -d'"' -f4)
        
        if [ "$status" = "healthy" ]; then
            print_success "Service is healthy"
            echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
        else
            print_warning "Service status: $status"
        fi
    else
        print_error "Service is not responding"
        return 1
    fi
}

# Main command router
main() {
    local command="${1:-help}"
    shift || true
    
    # Parse options
    while [[ $# -gt 0 ]]; do
        case $1 in
            --session-id)
                SESSION_ID="$2"
                shift 2
                ;;
            --user-id)
                USER_ID="$2"
                shift 2
                ;;
            --json)
                JSON_OUTPUT=true
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    case "$command" in
        start)
            start_session
            ;;
        message|msg)
            send_message "$*"
            ;;
        end|stop)
            end_session
            ;;
        context|ctx)
            show_context
            ;;
        insights)
            generate_insights
            ;;
        prioritize|tasks)
            prioritize_tasks
            ;;
        export)
            export_session "$SESSION_ID"
            ;;
        export-tasks)
            export_tasks
            ;;
        export-to-soc|soc)
            export_to_soc
            ;;
        status|health)
            check_status
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"