{
  "name": "Retro Game Generator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-game",
        "responseMode": "onReceived"
      },
      "name": "Game Generation Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.SHARED_WORKFLOW_OLLAMA_ID }}",
        "source": "parameter",
        "parameters": {
          "prompt": "Create a retro JavaScript game based on this prompt: {{$json.prompt}}\n\nGenerate complete, playable game code using HTML5 Canvas. Include:\n1. Game loop\n2. Player controls\n3. Score system\n4. Game over condition\n5. Retro pixel art style\n\nReturn only valid JavaScript code.",
          "model": "codellama",
          "type": "code",
          "quiet": true,
          "timeout_seconds": 180
        }
      },
      "name": "Generate Game Code",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://judge0:2358/submissions",
        "method": "POST",
        "body": {
          "source_code": "{{$json.generated_code}}",
          "language_id": 63,
          "stdin": "",
          "expected_output": ""
        }
      },
      "name": "Validate Code",
      "type": "n8n-nodes-base.httpRequest",
      "position": [650, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract response from shared Ollama workflow\nconst ollamaResult = $json;\nconst generatedCode = ollamaResult.response || ollamaResult.output || '';\n\n// Pass the generated code to the next node for validation\nreturn {\n  generated_code: generatedCode,\n  model_used: ollamaResult.request?.model || 'codellama',\n  execution_time_ms: ollamaResult.execution?.execution_time_ms || 0\n};"
      },
      "name": "Extract Generated Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [550, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "{{$json.status.id}}",
              "value2": 3
            }
          ]
        }
      },
      "name": "Check Validation",
      "type": "n8n-nodes-base.if",
      "position": [850, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "games",
        "columns": "title,prompt,code,author_id,engine",
        "returnFields": "id,title"
      },
      "name": "Save Game",
      "type": "n8n-nodes-base.postgres",
      "position": [1050, 250]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.SHARED_WORKFLOW_OLLAMA_ID }}",
        "source": "parameter",
        "parameters": {
          "prompt": "Generate retro pixel art assets for game: {{$json.title}}\nReturn as base64 encoded 32x32 sprite data.",
          "model": "llama3.2",
          "type": "general",
          "quiet": true,
          "timeout_seconds": 120
        }
      },
      "name": "Generate Assets",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1250, 250]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "error",
              "value": "Code validation failed"
            }
          ]
        }
      },
      "name": "Error Response",
      "type": "n8n-nodes-base.set",
      "position": [1050, 350]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract asset data from shared Ollama workflow\nconst ollamaResult = $json;\nconst assetData = ollamaResult.response || ollamaResult.output || '';\n\n// Return the complete game data with assets\nconst gameData = $('Save Game').item.json;\nreturn {\n  ...gameData,\n  assets: assetData,\n  asset_generation_time_ms: ollamaResult.execution?.execution_time_ms || 0\n};"
      },
      "name": "Process Assets",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1450, 250]
    }
  ],
  "connections": {
    "Game Generation Webhook": {"main": [[{"node": "Generate Game Code"}]]},
    "Generate Game Code": {"main": [[{"node": "Extract Generated Code"}]]},
    "Extract Generated Code": {"main": [[{"node": "Validate Code"}]]},
    "Validate Code": {"main": [[{"node": "Check Validation"}]]},
    "Check Validation": {
      "main": [
        [{"node": "Save Game"}],
        [{"node": "Error Response"}]
      ]
    },
    "Save Game": {"main": [[{"node": "Generate Assets"}]]},
    "Generate Assets": {"main": [[{"node": "Process Assets"}]]}
  }
}