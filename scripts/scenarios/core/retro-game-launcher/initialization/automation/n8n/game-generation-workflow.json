{
  "name": "Retro Game Generator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-game",
        "responseMode": "onReceived"
      },
      "name": "Game Generation Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:{{ $env.RESOURCE_PORTS.n8n }}/webhook/ollama",
        "method": "POST",
        "sendBody": true,
        "bodyContentType": "json",
        "specifyBody": "json",
        "jsonBody": "{\n  \"prompt\": \"Create a retro JavaScript game based on this prompt: {{$json.prompt}}\\n\\nGenerate complete, playable game code using HTML5 Canvas. Include:\\n1. Game loop\\n2. Player controls\\n3. Score system\\n4. Game over condition\\n5. Retro pixel art style\\n\\nReturn only valid JavaScript code wrapped in ```javascript``` tags.\",\n  \"model\": \"codellama\",\n  \"type\": \"code\",\n  \"quiet\": true,\n  \"timeout_seconds\": 180\n}",
        "options": {}
      },
      "name": "Generate Game Code via Shared Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://judge0:2358/submissions",
        "method": "POST",
        "body": {
          "source_code": "{{$json.generated_code}}",
          "language_id": 63,
          "stdin": "",
          "expected_output": ""
        }
      },
      "name": "Validate Code",
      "type": "n8n-nodes-base.httpRequest",
      "position": [650, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract response from shared Ollama workflow\nconst ollamaResult = $json;\n\n// The shared workflow returns a comprehensive response object\nlet generatedCode = '';\nif (ollamaResult.response) {\n  generatedCode = ollamaResult.response;\n  // Extract code from markdown code blocks if present\n  const codeMatch = generatedCode.match(/```javascript\\s*([\\s\\S]*?)```/);\n  if (codeMatch) {\n    generatedCode = codeMatch[1].trim();\n  }\n}\n\n// Pass the generated code to the next node for validation\nreturn {\n  generated_code: generatedCode,\n  model_used: ollamaResult.request?.model || 'codellama',\n  execution_time_ms: ollamaResult.execution?.execution_time_ms || 0,\n  success: ollamaResult.success || false\n};"
      },
      "name": "Extract Generated Code",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [550, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "{{$json.status.id}}",
              "value2": 3
            }
          ]
        }
      },
      "name": "Check Validation",
      "type": "n8n-nodes-base.if",
      "position": [850, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "games",
        "columns": "title,prompt,code,author_id,engine",
        "returnFields": "id,title"
      },
      "name": "Save Game",
      "type": "n8n-nodes-base.postgres",
      "position": [1050, 250]
    },
    {
      "parameters": {
        "url": "http://localhost:{{ $env.RESOURCE_PORTS.n8n }}/webhook/ollama",
        "method": "POST",
        "sendBody": true,
        "bodyContentType": "json",
        "specifyBody": "json",
        "jsonBody": "{\n  \"prompt\": \"Generate retro pixel art assets for game: {{$json.title}}\\nReturn as base64 encoded 32x32 sprite data.\",\n  \"model\": \"llama3.2\",\n  \"type\": \"general\",\n  \"quiet\": true,\n  \"timeout_seconds\": 120\n}",
        "options": {}
      },
      "name": "Generate Assets via Shared Ollama",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1250, 250]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "error",
              "value": "Code validation failed"
            }
          ]
        }
      },
      "name": "Error Response",
      "type": "n8n-nodes-base.set",
      "position": [1050, 350]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract asset data from shared Ollama workflow\nconst ollamaResult = $json;\nconst assetData = ollamaResult.response || ollamaResult.output || '';\n\n// Return the complete game data with assets\nconst gameData = $('Save Game').item.json;\nreturn {\n  ...gameData,\n  assets: assetData,\n  asset_generation_time_ms: ollamaResult.execution?.execution_time_ms || 0\n};"
      },
      "name": "Process Assets",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1450, 250]
    }
  ],
  "connections": {
    "Game Generation Webhook": {"main": [[{"node": "Generate Game Code via Shared Ollama"}]]},
    "Generate Game Code via Shared Ollama": {"main": [[{"node": "Extract Generated Code"}]]},
    "Extract Generated Code": {"main": [[{"node": "Validate Code"}]]},
    "Validate Code": {"main": [[{"node": "Check Validation"}]]},
    "Check Validation": {
      "main": [
        [{"node": "Save Game"}],
        [{"node": "Error Response"}]
      ]
    },
    "Save Game": {"main": [[{"node": "Generate Assets via Shared Ollama"}]]},
    "Generate Assets via Shared Ollama": {"main": [[{"node": "Process Assets"}]]}
  }
}