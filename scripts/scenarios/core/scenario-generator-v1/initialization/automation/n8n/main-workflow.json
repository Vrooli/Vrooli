{
  "name": "Scenario Generator V1 - Main Pipeline",
  "nodes": [
    {
      "parameters": {
        "path": "scenario-generator-v1/new-scenario",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "new-scenario-webhook",
      "name": "New Scenario Request",
      "type": "n8n-nodes-base.webhook", 
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "new-scenario-webhook"
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Validate and prepare scenario request\nconst request = $input.item.json;\n\n// Input validation\nif (!request.userRequest || typeof request.userRequest !== 'string') {\n  throw new Error('Missing or invalid userRequest field');\n}\n\nif (!request.campaignId) {\n  throw new Error('Missing campaignId field');\n}\n\n// Generate scenario ID\nconst scenarioId = `scn-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n// Prepare scenario data\nconst scenarioData = {\n  scenarioId,\n  campaignId: request.campaignId,\n  userRequest: request.userRequest.trim(),\n  complexity: request.complexity || 'intermediate',\n  category: request.category || 'general',\n  planningIterations: parseInt(request.planningIterations) || 3,\n  implementationIterations: parseInt(request.implementationIterations) || 2,\n  validationIterations: parseInt(request.validationIterations) || 5,\n  requestedAt: new Date().toISOString(),\n  status: 'requested'\n};\n\nconsole.log('Prepared scenario request:', scenarioData);\nreturn scenarioData;"
      },
      "id": "validate-request",
      "name": "Validate Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300]
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO scenarios (scenario_id, campaign_id, scenario_name, description, user_request, complexity, category, planning_iterations, implementation_iterations, validation_iterations, status, current_phase, progress_percent) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13) RETURNING id",
        "additionalFields": {
          "mode": "independently",
          "valuesUi": {
            "values": [
              {
                "column": "$1",
                "value": "={{ $json.scenarioId }}"
              },
              {
                "column": "$2", 
                "value": "={{ $json.campaignId }}"
              },
              {
                "column": "$3",
                "value": "={{ $json.userRequest.slice(0, 100) }}..."
              },
              {
                "column": "$4",
                "value": "Scenario generated from: {{ $json.userRequest.slice(0, 200) }}..."
              },
              {
                "column": "$5",
                "value": "={{ $json.userRequest }}"
              },
              {
                "column": "$6",
                "value": "={{ $json.complexity }}"
              },
              {
                "column": "$7",
                "value": "={{ $json.category }}"
              },
              {
                "column": "$8",
                "value": "={{ $json.planningIterations }}"
              },
              {
                "column": "$9",
                "value": "={{ $json.implementationIterations }}"
              },
              {
                "column": "$10",
                "value": "={{ $json.validationIterations }}"
              },
              {
                "column": "$11",
                "value": "requested"
              },
              {
                "column": "$12", 
                "value": "planning"
              },
              {
                "column": "$13",
                "value": "0"
              }
            ]
          }
        }
      },
      "id": "create-scenario-record",
      "name": "Create Scenario Record",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [600, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-scenario-generator",
          "name": "PostgreSQL - Scenario Generator"
        }
      }
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem", 
        "jsCode": "// Update status to planning and publish to Redis queue\nconst scenarioData = $('validate-request').item.json;\nconst dbResult = $input.item.json;\n\n// Add database ID to scenario data\nconst enrichedData = {\n  ...scenarioData,\n  databaseId: dbResult.id,\n  status: 'planning',\n  startedAt: new Date().toISOString()\n};\n\nconsole.log('Publishing scenario to planning queue:', enrichedData.scenarioId);\nreturn enrichedData;"
      },
      "id": "prepare-planning-queue",
      "name": "Prepare Planning Queue",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 300]
    },

    {
      "parameters": {
        "command": "LPUSH",
        "key": "scenario-planning-queue",
        "value": "={{ JSON.stringify($json) }}"
      },
      "id": "queue-for-planning",
      "name": "Queue for Planning",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1000, 300],
      "credentials": {
        "redis": {
          "id": "redis-scenario-generator", 
          "name": "Redis - Scenario Generator"
        }
      }
    },

    {
      "parameters": {
        "url": "http://localhost:5678/webhook/scenario-generator-v1/planning",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "scenarioData",
              "value": "={{ JSON.stringify($('prepare-planning-queue').item.json) }}"
            }
          ]
        },
        "options": {
          "timeout": 5000
        }
      },
      "id": "trigger-planning-workflow",
      "name": "Trigger Planning Workflow",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1200, 300]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Build response for UI\nconst scenarioData = $('prepare-planning-queue').item.json;\n\nconst response = {\n  success: true,\n  message: 'Scenario generation pipeline started',\n  scenario: {\n    id: scenarioData.scenarioId,\n    campaignId: scenarioData.campaignId,\n    status: 'planning',\n    phase: 'planning',\n    progressPercent: 5,\n    estimatedCompletionTime: '15-30 minutes',\n    createdAt: scenarioData.requestedAt\n  },\n  pipeline: {\n    planningIterations: scenarioData.planningIterations,\n    implementationIterations: scenarioData.implementationIterations,\n    validationIterations: scenarioData.validationIterations\n  },\n  monitoring: {\n    statusUrl: `/api/scenario-generator-v1/status/${scenarioData.scenarioId}`,\n    progressUrl: `/api/scenario-generator-v1/progress/${scenarioData.scenarioId}`,\n    logsUrl: `/api/scenario-generator-v1/logs/${scenarioData.scenarioId}`\n  }\n};\n\nconsole.log('Scenario generation initiated:', scenarioData.scenarioId);\nreturn response;"
      },
      "id": "build-response",
      "name": "Build Response", 
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 300]
    },

    {
      "parameters": {
        "path": "scenario-generator-v1/status/:scenarioId",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "status-webhook",
      "name": "Status Check",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 500],
      "webhookId": "status-webhook"
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT s.*, c.name as campaign_name, c.color_theme FROM scenarios s LEFT JOIN campaigns c ON s.campaign_id = c.id WHERE s.scenario_id = $1",
        "additionalFields": {
          "mode": "independently",
          "valuesUi": {
            "values": [
              {
                "column": "$1",
                "value": "={{ $node.parameter.scenarioId }}"
              }
            ]
          }
        }
      },
      "id": "get-scenario-status",
      "name": "Get Scenario Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [400, 500],
      "credentials": {
        "postgres": {
          "id": "postgres-scenario-generator",
          "name": "PostgreSQL - Scenario Generator"
        }
      }
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Build status response\nconst scenario = $input.item.json;\n\nif (!scenario || !scenario.id) {\n  return {\n    success: false,\n    error: 'Scenario not found',\n    status: 'not_found'\n  };\n}\n\nconst response = {\n  success: true,\n  scenario: {\n    id: scenario.scenario_id,\n    name: scenario.scenario_name,\n    description: scenario.description,\n    status: scenario.status,\n    currentPhase: scenario.current_phase,\n    progressPercent: scenario.progress_percent,\n    campaign: {\n      id: scenario.campaign_id,\n      name: scenario.campaign_name,\n      colorTheme: scenario.color_theme\n    },\n    configuration: {\n      complexity: scenario.complexity,\n      category: scenario.category,\n      planningIterations: scenario.planning_iterations,\n      implementationIterations: scenario.implementation_iterations,\n      validationIterations: scenario.validation_iterations\n    },\n    timing: {\n      requestedAt: scenario.requested_at,\n      startedAt: scenario.started_at,\n      completedAt: scenario.completed_at,\n      totalDurationMinutes: scenario.total_duration_minutes\n    },\n    storage: {\n      planPath: scenario.plan_path,\n      implementationPath: scenario.implementation_path,\n      finalScenarioPath: scenario.final_scenario_path\n    },\n    business: {\n      estimatedRevenue: scenario.estimated_revenue\n    },\n    error: scenario.error_message\n  }\n};\n\nreturn response;"
      },
      "id": "format-status-response",
      "name": "Format Status Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 500]
    }
  ],

  "connections": {
    "New Scenario Request": {
      "main": [
        [
          {
            "node": "Validate Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Request": {
      "main": [
        [
          {
            "node": "Create Scenario Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Scenario Record": {
      "main": [
        [
          {
            "node": "Prepare Planning Queue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Planning Queue": {
      "main": [
        [
          {
            "node": "Queue for Planning",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Queue for Planning": {
      "main": [
        [
          {
            "node": "Trigger Planning Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Planning Workflow": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Status Check": {
      "main": [
        [
          {
            "node": "Get Scenario Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Scenario Status": {
      "main": [
        [
          {
            "node": "Format Status Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },

  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },

  "versionId": "scenario-generator-v1-main-pipeline",
  "id": "scenario-generator-v1-main-pipeline",

  "meta": {
    "templateCreatedBy": "vrooli-scenario-generator-v1",
    "instanceId": "scenario-generator-v1-pipeline"
  },

  "tags": [
    {
      "id": "scenario-generator-v1",
      "name": "Scenario Generator V1"
    },
    {
      "id": "scenario-pipeline",
      "name": "Scenario Pipeline"
    }
  ]
}