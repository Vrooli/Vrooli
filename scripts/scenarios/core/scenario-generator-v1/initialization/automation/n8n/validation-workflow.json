{
  "name": "Scenario Generator V1 - Validation Workflow",
  "nodes": [
    {
      "parameters": {
        "path": "scenario-generator-v1/validation",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "validation-webhook",
      "name": "Validation Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "validation-webhook"
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Initialize validation phase\nconst scenarioData = JSON.parse($input.item.json.scenarioData);\n\n// Validate scenario data\nif (!scenarioData.scenarioId) {\n  throw new Error('Missing scenarioId in validation data');\n}\n\nif (!scenarioData.finalImplementation) {\n  throw new Error('Missing final implementation for validation');\n}\n\nconst validationState = {\n  ...scenarioData,\n  validationPhase: 'testing',\n  currentAttempt: 1,\n  maxAttempts: scenarioData.validationIterations || 5,\n  validationResults: [],\n  validationIssues: [],\n  startTime: Date.now(),\n  implementationFiles: scenarioData.finalImplementation.finalFiles\n};\n\nconsole.log(`Starting validation for scenario ${scenarioData.scenarioId}`);\nconsole.log(`Validation attempts configured: ${validationState.maxAttempts}`);\n\nreturn validationState;"
      },
      "id": "initialize-validation",
      "name": "Initialize Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300]
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE scenarios SET status = 'validating', current_phase = 'validation', progress_percent = 75 WHERE scenario_id = $1",
        "additionalFields": {
          "mode": "independently",
          "valuesUi": {
            "values": [
              {
                "column": "$1",
                "value": "={{ $json.scenarioId }}"
              }
            ]
          }
        }
      },
      "id": "update-validation-status",
      "name": "Update Validation Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [600, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-scenario-generator",
          "name": "PostgreSQL - Scenario Generator"
        }
      }
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Prepare scenario files for validation\nconst state = $input.item.json;\nconst files = state.implementationFiles;\n\n// Create temporary directory for scenario files\nconst tempScenarioDir = `/tmp/scenario-validation-${state.scenarioId}-${Date.now()}`;\nconst validationState = {\n  ...state,\n  tempScenarioDir: tempScenarioDir,\n  validationType: 'dry_run' // Start with dry run\n};\n\nconsole.log(`Prepared validation directory: ${tempScenarioDir}`);\nconsole.log(`Files to validate: ${Object.keys(files).length}`);\n\nreturn validationState;"
      },
      "id": "prepare-scenario-files",
      "name": "Prepare Scenario Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 300]
    },

    {
      "parameters": {
        "command": "/bin/bash",
        "parameters": "-c \"mkdir -p {{ $json.tempScenarioDir }} && cd {{ $json.tempScenarioDir }} && echo 'Created validation directory for scenario {{ $json.scenarioId }}'\"",
        "options": {
          "timeout": 30000
        }
      },
      "id": "create-temp-directory",
      "name": "Create Temp Directory",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1000, 300]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Write scenario files to temp directory\nconst state = $('prepare-scenario-files').item.json;\nconst files = state.implementationFiles;\n\n// Create file write commands\nconst writeCommands = [];\nfor (const [filePath, content] of Object.entries(files)) {\n  const fullPath = `${state.tempScenarioDir}/${filePath}`;\n  const dirPath = fullPath.split('/').slice(0, -1).join('/');\n  \n  // Escape content for shell\n  const escapedContent = content.replace(/'/g, \"'\\\\''\");\n  \n  writeCommands.push(`mkdir -p \"${dirPath}\"`);\n  writeCommands.push(`cat > \"${fullPath}\" << 'SCENARIO_FILE_EOF'\\n${content}\\nSCENARIO_FILE_EOF`);\n}\n\nconst writeState = {\n  ...state,\n  writeCommands: writeCommands,\n  totalFiles: Object.keys(files).length\n};\n\nconsole.log(`Prepared ${writeCommands.length / 2} file write commands`);\nreturn writeState;"
      },
      "id": "prepare-file-writes",
      "name": "Prepare File Writes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 300]
    },

    {
      "parameters": {
        "command": "/bin/bash",
        "parameters": "-c \"{{ $json.writeCommands.join(' && ') }}\"",
        "options": {
          "timeout": 120000
        }
      },
      "id": "write-scenario-files",
      "name": "Write Scenario Files",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1400, 300]
    },

    {
      "parameters": {
        "command": "/bin/bash",
        "parameters": "-c \"cd ${VROOLI_ROOT:-/home/matthalloran8/Vrooli} && ./scripts/scenarios/tools/scenario-to-app.sh --scenario-path {{ $json.tempScenarioDir }} --dry-run --verbose 2>&1\"",
        "options": {
          "timeout": 300000
        }
      },
      "id": "run-scenario-validation",
      "name": "Run Scenario Validation",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1600, 300]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process validation results\nconst state = $('prepare-file-writes').item.json;\nconst validationOutput = $input.item.json;\n\nconst validationResult = {\n  attempt: state.currentAttempt,\n  validationType: state.validationType,\n  exitCode: validationOutput.exitCode,\n  stdout: validationOutput.stdout || '',\n  stderr: validationOutput.stderr || '',\n  success: validationOutput.exitCode === 0,\n  executedAt: new Date().toISOString(),\n  duration: Date.now() - state.startTime\n};\n\n// Parse validation errors if failed\nlet parsedIssues = [];\nif (!validationResult.success) {\n  const errorText = validationResult.stderr + '\\n' + validationResult.stdout;\n  \n  // Extract common error patterns\n  const syntaxErrors = (errorText.match(/syntax error|parse error|invalid json|malformed/gi) || []).length;\n  const configErrors = (errorText.match(/configuration|endpoint|connection|resource/gi) || []).length;\n  const databaseErrors = (errorText.match(/database|sql|postgres|constraint/gi) || []).length;\n  const permissionErrors = (errorText.match(/permission|access denied|forbidden/gi) || []).length;\n  \n  parsedIssues = [\n    { type: 'syntax', count: syntaxErrors },\n    { type: 'configuration', count: configErrors },\n    { type: 'database', count: databaseErrors },\n    { type: 'permission', count: permissionErrors }\n  ].filter(issue => issue.count > 0);\n}\n\nconst updatedState = {\n  ...state,\n  validationResults: [...state.validationResults, validationResult],\n  currentValidationResult: validationResult,\n  parsedIssues: parsedIssues,\n  validationSuccessful: validationResult.success\n};\n\nconsole.log(`Validation attempt ${state.currentAttempt} for ${state.scenarioId}: ${validationResult.success ? 'SUCCESS' : 'FAILED'}`);\nif (!validationResult.success) {\n  console.log(`Issues found: ${parsedIssues.map(i => `${i.count} ${i.type}`).join(', ')}`);\n}\n\nreturn updatedState;"
      },
      "id": "process-validation-results",
      "name": "Process Validation Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 300]
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO validation_results (scenario_id, attempt_number, validation_type, exit_code, stdout_content, stderr_content, success, executed_at, duration_ms, issues_found) VALUES ((SELECT id FROM scenarios WHERE scenario_id = $1), $2, $3, $4, $5, $6, $7, $8, $9, $10)",
        "additionalFields": {
          "mode": "independently",
          "valuesUi": {
            "values": [
              {
                "column": "$1",
                "value": "={{ $json.scenarioId }}"
              },
              {
                "column": "$2",
                "value": "={{ $json.currentAttempt }}"
              },
              {
                "column": "$3",
                "value": "={{ $json.validationType }}"
              },
              {
                "column": "$4",
                "value": "={{ $json.currentValidationResult.exitCode }}"
              },
              {
                "column": "$5",
                "value": "={{ $json.currentValidationResult.stdout.substring(0, 5000) }}"
              },
              {
                "column": "$6",
                "value": "={{ $json.currentValidationResult.stderr.substring(0, 5000) }}"
              },
              {
                "column": "$7",
                "value": "={{ $json.currentValidationResult.success }}"
              },
              {
                "column": "$8",
                "value": "={{ $json.currentValidationResult.executedAt }}"
              },
              {
                "column": "$9",
                "value": "={{ $json.currentValidationResult.duration }}"
              },
              {
                "column": "$10",
                "value": "={{ JSON.stringify($json.parsedIssues) }}"
              }
            ]
          }
        }
      },
      "id": "log-validation-result",
      "name": "Log Validation Result",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2000, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-scenario-generator",
          "name": "PostgreSQL - Scenario Generator"
        }
      }
    },

    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.validationSuccessful }}",
              "operation": "equal",
              "value2": true
            }
          ]
        }
      },
      "id": "check-validation-success",
      "name": "Validation Successful?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2200, 300]
    },

    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.currentAttempt }}",
              "value2": "={{ $json.maxAttempts }}",
              "operation": "smaller"
            }
          ]
        }
      },
      "id": "check-more-validation-attempts",
      "name": "More Validation Attempts?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2000, 500]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Prepare Claude prompt for validation fixing\nconst state = $input.item.json;\nconst validationResult = state.currentValidationResult;\nconst currentFiles = JSON.stringify(state.implementationFiles, null, 2);\n\nconst validationFixingPrompt = `# Vrooli Scenario Validation & Debugging Prompt\n\n## System Context\nYou are Claude Code, an expert Vrooli scenario debugger in the VALIDATION phase. Your task is to analyze scenario validation results, identify issues, and provide fixes to ensure the scenario deploys and functions correctly.\n\n## Validation Context\n- **Scenario ID**: ${state.scenarioId}\n- **Validation Attempt**: ${state.currentAttempt} of ${state.maxAttempts}\n- **Validation Type**: ${state.validationType}\n\n## Validation Results\nExit Code: ${validationResult.exitCode}\n\nSTDOUT:\n${validationResult.stdout}\n\nSTDERR:\n${validationResult.stderr}\n\n## Scenario Files Being Validated\n${currentFiles.substring(0, 6000)}\n\n## Parsed Issues\n${state.parsedIssues.map(i => `- ${i.type}: ${i.count} instances`).join('\\n')}\n\n## Your Task\nAnalyze validation output, identify root causes of any failures, and provide complete fixes that resolve all issues. Your fixes must be precise, targeted, and ensure successful deployment.\n\n## Required Output Format\nProvide a complete analysis and fix package in JSON format with:\n- validationAnalysis: Overall assessment\n- issueAnalysis: Detailed breakdown of each issue\n- fixedFiles: Complete corrected file content for any files that need changes\n- fixExplanations: Explanation of what was fixed\n- validationStrategy: How to re-run validation\n\nFocus on providing complete, working fixes that resolve all validation issues.`;\n\nconst claudeRequest = {\n  scenarioId: state.scenarioId,\n  attempt: state.currentAttempt,\n  phase: 'validation-fixing',\n  prompt: validationFixingPrompt,\n  maxTokens: 10000,\n  temperature: 0.2\n};\n\nconst fixingState = {\n  ...state,\n  currentAttempt: state.currentAttempt + 1,\n  claudeRequest: claudeRequest\n};\n\nconsole.log(`Prepared Claude validation fixing request for scenario ${state.scenarioId}, attempt ${state.currentAttempt + 1}`);\nreturn fixingState;"
      },
      "id": "prepare-validation-fixing",
      "name": "Prepare Validation Fixing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 500]
    },

    {
      "parameters": {
        "command": "/bin/bash",
        "parameters": "-c \"cd ${VROOLI_ROOT:-/home/matthalloran8/Vrooli} && echo '{{ $json.claudeRequest.prompt }}' | claude --model claude-3-sonnet-20241022 --max-tokens {{ $json.claudeRequest.maxTokens }} --temperature {{ $json.claudeRequest.temperature }}\"",
        "options": {
          "timeout": 600000
        }
      },
      "id": "call-claude-validation-fixing",
      "name": "Call Claude for Validation Fixing",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1600, 500]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Process Claude validation fixing response\nconst state = $('prepare-validation-fixing').item.json;\nconst claudeOutput = $input.item.json;\n\nif (claudeOutput.exitCode !== 0) {\n  console.error('Claude validation fixing failed:', claudeOutput.stderr);\n  throw new Error(`Claude validation fixing failed: ${claudeOutput.stderr}`);\n}\n\nlet fixingData;\ntry {\n  const responseText = claudeOutput.stdout.trim();\n  const jsonMatch = responseText.match(/```json\\s*([\\s\\S]*?)\\s*```/) || [null, responseText];\n  fixingData = JSON.parse(jsonMatch[1]);\n} catch (error) {\n  console.error('Failed to parse Claude validation fixing response:', error);\n  throw new Error(`Invalid JSON response from Claude validation fixing: ${error.message}`);\n}\n\n// Apply fixes to implementation files\nlet updatedFiles = { ...state.implementationFiles };\nif (fixingData.fixedFiles) {\n  for (const [filePath, content] of Object.entries(fixingData.fixedFiles)) {\n    updatedFiles[filePath] = content;\n  }\n}\n\nconst updatedState = {\n  ...state,\n  implementationFiles: updatedFiles,\n  lastFixingData: fixingData,\n  fixesApplied: Object.keys(fixingData.fixedFiles || {}).length\n};\n\nconsole.log(`Validation fixes applied for ${state.scenarioId}`);\nconsole.log(`Files fixed: ${updatedState.fixesApplied}`);\nreturn updatedState;"
      },
      "id": "process-validation-fixing",
      "name": "Process Validation Fixing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 500]
    },

    {
      "parameters": {
        "command": "/bin/bash",
        "parameters": "-c \"rm -rf {{ $json.tempScenarioDir }} && echo 'Cleaned up temp directory'\"",
        "options": {
          "timeout": 30000
        }
      },
      "id": "cleanup-temp-directory",
      "name": "Cleanup Temp Directory",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1200, 500]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Handle validation failure - max attempts reached\nconst state = $input.item.json;\n\nconst failureState = {\n  ...state,\n  status: 'validation_failed',\n  finalResult: 'failed',\n  failureReason: 'Maximum validation attempts exceeded',\n  completedAt: new Date().toISOString(),\n  totalDuration: Date.now() - state.startTime\n};\n\nconsole.log(`Validation failed for scenario ${state.scenarioId} after ${state.currentAttempt} attempts`);\nreturn failureState;"
      },
      "id": "handle-validation-failure",
      "name": "Handle Validation Failure",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 500]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Handle validation success - deploy scenario\nconst state = $input.item.json;\n\nconst successState = {\n  ...state,\n  status: 'deploying',\n  validationCompletedAt: new Date().toISOString(),\n  validationDuration: Date.now() - state.startTime,\n  readyForDeployment: true\n};\n\nconsole.log(`Validation successful for scenario ${state.scenarioId} on attempt ${state.currentAttempt}`);\nreturn successState;"
      },
      "id": "handle-validation-success",
      "name": "Handle Validation Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2400, 300]
    },

    {
      "parameters": {
        "command": "/bin/bash",
        "parameters": "-c \"cd ${VROOLI_ROOT:-/home/matthalloran8/Vrooli} && ./scripts/scenarios/tools/scenario-to-app.sh --scenario-path {{ $json.tempScenarioDir }} --deploy --verbose 2>&1\"",
        "options": {
          "timeout": 600000
        }
      },
      "id": "deploy-scenario",
      "name": "Deploy Scenario",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [2600, 300]
    },

    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Finalize scenario deployment\nconst state = $('handle-validation-success').item.json;\nconst deploymentResult = $input.item.json;\n\nconst finalState = {\n  ...state,\n  deploymentResult: {\n    exitCode: deploymentResult.exitCode,\n    success: deploymentResult.exitCode === 0,\n    stdout: deploymentResult.stdout,\n    stderr: deploymentResult.stderr,\n    deployedAt: new Date().toISOString()\n  },\n  status: deploymentResult.exitCode === 0 ? 'completed' : 'deployment_failed',\n  finalResult: deploymentResult.exitCode === 0 ? 'success' : 'deployment_failed',\n  completedAt: new Date().toISOString(),\n  totalDuration: Date.now() - state.startTime\n};\n\nconsole.log(`Scenario ${state.scenarioId} deployment: ${finalState.finalResult}`);\nreturn finalState;"
      },
      "id": "finalize-deployment",
      "name": "Finalize Deployment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2800, 300]
    },

    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE scenarios SET status = $2, current_phase = 'completed', progress_percent = 100, completed_at = NOW(), total_duration_minutes = EXTRACT(EPOCH FROM (NOW() - requested_at))/60, final_scenario_path = $3, success = $4, error_message = $5 WHERE scenario_id = $1",
        "additionalFields": {
          "mode": "independently",
          "valuesUi": {
            "values": [
              {
                "column": "$1",
                "value": "={{ $json.scenarioId }}"
              },
              {
                "column": "$2",
                "value": "={{ $json.status }}"
              },
              {
                "column": "$3",
                "value": "={{ $json.tempScenarioDir || '' }}"
              },
              {
                "column": "$4",
                "value": "={{ $json.finalResult === 'success' }}"
              },
              {
                "column": "$5",
                "value": "={{ $json.deploymentResult ? $json.deploymentResult.stderr : $json.failureReason || '' }}"
              }
            ]
          }
        }
      },
      "id": "update-final-status",
      "name": "Update Final Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [3000, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-scenario-generator",
          "name": "PostgreSQL - Scenario Generator"
        }
      }
    }
  ],

  "connections": {
    "Validation Trigger": {
      "main": [
        [
          {
            "node": "Initialize Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Validation": {
      "main": [
        [
          {
            "node": "Update Validation Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Validation Status": {
      "main": [
        [
          {
            "node": "Prepare Scenario Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Scenario Files": {
      "main": [
        [
          {
            "node": "Create Temp Directory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Temp Directory": {
      "main": [
        [
          {
            "node": "Prepare File Writes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare File Writes": {
      "main": [
        [
          {
            "node": "Write Scenario Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write Scenario Files": {
      "main": [
        [
          {
            "node": "Run Scenario Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Scenario Validation": {
      "main": [
        [
          {
            "node": "Process Validation Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Validation Results": {
      "main": [
        [
          {
            "node": "Log Validation Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Validation Result": {
      "main": [
        [
          {
            "node": "Validation Successful?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validation Successful?": {
      "main": [
        [
          {
            "node": "Handle Validation Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "More Validation Attempts?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "More Validation Attempts?": {
      "main": [
        [
          {
            "node": "Prepare Validation Fixing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Handle Validation Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Validation Fixing": {
      "main": [
        [
          {
            "node": "Call Claude for Validation Fixing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Claude for Validation Fixing": {
      "main": [
        [
          {
            "node": "Process Validation Fixing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Validation Fixing": {
      "main": [
        [
          {
            "node": "Cleanup Temp Directory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cleanup Temp Directory": {
      "main": [
        [
          {
            "node": "Prepare Scenario Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Validation Success": {
      "main": [
        [
          {
            "node": "Deploy Scenario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deploy Scenario": {
      "main": [
        [
          {
            "node": "Finalize Deployment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Deployment": {
      "main": [
        [
          {
            "node": "Update Final Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Validation Failure": {
      "main": [
        [
          {
            "node": "Update Final Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },

  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },

  "versionId": "scenario-generator-v1-validation",
  "id": "scenario-generator-v1-validation",

  "meta": {
    "templateCreatedBy": "vrooli-scenario-generator-v1",
    "instanceId": "scenario-generator-v1-validation"
  },

  "tags": [
    {
      "id": "scenario-generator-v1",
      "name": "Scenario Generator V1"
    },
    {
      "id": "validation-workflow",
      "name": "Validation Workflow"
    }
  ]
}