name: brand-manager
description: Comprehensive validation of AI-powered brand generation and automated app integration
version: 2.0.0

resources:
  required:
    - ollama
    - comfyui
    - postgres
    - minio
    - n8n
    - windmill
    - vault
    - claude-code

tests:
  - name: resource_availability
    description: Verify all required resources are accessible
    timeout: 120s
    steps:
      - check_service: 
          name: "Ollama AI"
          endpoint: "http://ollama:11434/api/tags"
          timeout: 30s
      - check_service:
          name: "ComfyUI"
          endpoint: "http://comfyui:8188/system_stats"
          timeout: 30s
      - check_tcp:
          name: "PostgreSQL"
          host: postgres
          port: 5432
          timeout: 10s
      - check_service:
          name: "MinIO"
          endpoint: "http://minio:9000/minio/health/ready"
          timeout: 15s
      - check_service:
          name: "n8n"
          endpoint: "http://n8n:5678/healthz"
          timeout: 20s
      - check_service:
          name: "Windmill"
          endpoint: "http://windmill:8000/api/version"
          timeout: 15s
      - check_service:
          name: "Vault"
          endpoint: "http://vault:8200/v1/sys/health"
          timeout: 10s
          optional: true

  - name: database_initialization
    description: Verify database schema and seed data
    timeout: 60s
    steps:
      - verify_database:
          description: "Check brands table exists with data"
          query: "SELECT COUNT(*) as count FROM brands"
          expected_min: 1
      - verify_database:
          description: "Check templates table exists with data"
          query: "SELECT COUNT(*) as count FROM templates WHERE is_active = true"
          expected_min: 3
      - verify_database:
          description: "Check integration_requests table exists"
          query: "SELECT 1 FROM integration_requests LIMIT 1"
          allow_empty: true

  - name: storage_initialization
    description: Verify MinIO buckets and Vault secrets
    timeout: 90s
    steps:
      - verify_storage:
          description: "Check brand-logos bucket exists"
          bucket: brand-logos
          action: list
      - verify_storage:
          description: "Check brand-icons bucket exists"
          bucket: brand-icons
          action: list
      - verify_storage:
          description: "Check brand-exports bucket exists"
          bucket: brand-exports
          action: list
      - verify_storage:
          description: "Check app-backups bucket exists"
          bucket: app-backups
          action: list
      - verify_vault_secrets:
          description: "Check API keys are configured"
          path: "brand-manager/api-keys"
          required_keys: ["claude_code_api_key", "n8n_webhook_secret"]
          optional: true

  - name: windmill_applications
    description: Verify Windmill UI applications are deployed
    timeout: 120s
    steps:
      - verify_windmill_app:
          description: "Check brand manager dashboard exists"
          path: "f/brand-manager/dashboard"
          expected_status: 200
      - verify_windmill_app:
          description: "Check integration monitoring dashboard exists"
          path: "f/brand-manager/integration-dashboard"
          expected_status: 200

  - name: n8n_workflow_deployment
    description: Verify n8n workflows are imported and active
    timeout: 90s
    steps:
      - verify_n8n_workflow:
          description: "Check brand pipeline workflow exists"
          name: "Brand Generation Pipeline"
          expected_active: true
      - verify_n8n_workflow:
          description: "Check claude spawner workflow exists"
          name: "Claude Code Agent Spawner"
          expected_active: true
      - verify_n8n_workflow:
          description: "Check integration monitor workflow exists"
          name: "Integration Monitor"
          expected_active: true

  - name: brand_generation_complete_flow
    description: Test end-to-end brand generation with AI services
    timeout: 180s
    steps:
      - webhook_call:
          description: "Trigger brand generation via n8n webhook"
          url: "http://n8n:5678/webhook/generate-brand"
          method: POST
          body:
            brandName: "TestTech Solutions"
            shortName: "TestTech"
            industry: "Technology"
            template: "modern-tech"
            logoStyle: "minimalist"
            colorScheme: "primary"
          expected_status: 200
      - wait: 
          description: "Wait for AI generation to complete"
          duration: 45s
      - verify_database:
          description: "Verify brand was created in database"
          query: "SELECT id, name, slogan, logo_url FROM brands WHERE name = 'TestTech Solutions'"
          expected_count: 1
          store_result: brand_data
      - verify_storage:
          description: "Verify logo assets were generated"
          bucket: brand-logos
          file_pattern: "*TestTech*.svg"
          expected_min: 1
      - verify_ollama_generation:
          description: "Verify Ollama generated text content"
          brand_id: "${brand_data.id}"
          expected_fields: ["slogan", "description"]

  - name: claude_code_integration_flow
    description: Test complete Claude Code agent integration workflow
    timeout: 400s
    setup:
      - create_test_app:
          description: "Create a test React app for integration"
          path: "/tmp/test-react-app"
          type: "react"
          files:
            - "package.json"
            - "public/index.html"
            - "public/manifest.json"
            - "src/App.js"
    steps:
      - webhook_call:
          description: "Trigger Claude Code agent spawning"
          url: "http://n8n:5678/webhook/spawn-claude-integration"
          method: POST
          body:
            brandId: "${brand_data.id}"
            targetAppPath: "/tmp/test-react-app"
            integrationType: "full"
            createBackup: true
          expected_status: 200
          store_result: integration_request
      - verify_database:
          description: "Verify integration request was created"
          query: "SELECT id, status, claude_session_id FROM integration_requests WHERE brand_id = '${brand_data.id}' AND target_app_path = '/tmp/test-react-app'"
          expected_count: 1
          store_result: integration_data
      - wait:
          description: "Wait for Claude Code agent to process"
          duration: 180s
          condition:
            query: "SELECT status FROM integration_requests WHERE id = '${integration_data.id}'"
            expected_values: ["completed", "failed"]
            check_interval: 15s
      - verify_integration_completion:
          description: "Verify integration completed successfully"
          integration_id: "${integration_data.id}"
          expected_status: "completed"
      - verify_app_integration:
          description: "Verify brand was integrated into test app"
          app_path: "/tmp/test-react-app"
          expected_changes:
            - "public/favicon.ico"
            - "public/manifest.json"
            - "src/brand.css"
      - verify_backup_created:
          description: "Verify backup was created before integration"
          bucket: app-backups
          pattern: "integration_${integration_data.id}/*"

  - name: integration_monitoring
    description: Test integration monitoring and error handling
    timeout: 120s
    steps:
      - verify_integration_metrics:
          description: "Check integration metrics are being collected"
          query: "SELECT COUNT(*) as count FROM integration_metrics"
          expected_min: 1
      - verify_activity_logging:
          description: "Check activity logging is working"
          query: "SELECT COUNT(*) as count FROM activity_log WHERE action IN ('brand_created', 'integration_started')"
          expected_min: 1
      - test_webhook_callbacks:
          description: "Test Claude Code webhook callbacks"
          endpoints:
            - "http://n8n:5678/webhook/claude-progress"
            - "http://n8n:5678/webhook/claude-completion"
            - "http://n8n:5678/webhook/claude-error"
          method: POST
          test_payload:
            sessionId: "test-session-123"
            status: "test"

  - name: windmill_ui_functionality
    description: Test Windmill UI components and interactions
    timeout: 90s
    steps:
      - test_windmill_api:
          description: "Test brand creation via Windmill form"
          app_path: "f/brand-manager/dashboard"
          action: "submit_form"
          form_data:
            brandName: "UI Test Brand"
            industry: "Creative"
            template: "creative-agency"
          expected_response: success
      - verify_ui_data_display:
          description: "Verify data displays correctly in dashboard"
          app_path: "f/brand-manager/dashboard"
          component: "brand-list"
          expected_brands_min: 2
      - test_integration_dashboard:
          description: "Test integration monitoring dashboard"
          app_path: "f/brand-manager/integration-dashboard"
          component: "active-integrations"
          verify_realtime_updates: true

  - name: error_handling_and_recovery
    description: Test error scenarios and recovery mechanisms
    timeout: 180s
    steps:
      - test_invalid_brand_request:
          description: "Test handling of invalid brand generation request"
          webhook_url: "http://n8n:5678/webhook/generate-brand"
          invalid_payload:
            brandName: ""
            template: "invalid-template"
          expected_error: validation_error
      - test_integration_failure:
          description: "Test handling of integration failure"
          webhook_url: "http://n8n:5678/webhook/spawn-claude-integration"
          invalid_payload:
            brandId: "non-existent-brand"
            targetAppPath: "/invalid/path"
          expected_error: integration_error
      - verify_error_logging:
          description: "Verify errors are properly logged"
          query: "SELECT COUNT(*) FROM activity_log WHERE action LIKE '%error%' OR action LIKE '%failed%'"
          expected_min: 0
          allow_zero: true

  - name: performance_benchmarks
    description: Validate performance targets are met
    timeout: 300s
    steps:
      - benchmark_brand_generation:
          description: "Measure brand generation performance"
          iterations: 3
          max_time: 45s
          parallel: false
      - benchmark_asset_generation:
          description: "Measure ComfyUI asset generation time"
          iterations: 2
          max_time: 90s
          asset_types: ["logo", "favicon"]
      - benchmark_integration_speed:
          description: "Measure Claude Code integration speed"
          iterations: 1
          max_time: 240s
          app_size: "small"

validation:
  performance:
    brand_generation_time: "<45s"
    asset_generation_time: "<90s"
    integration_time: "<240s"
    windmill_response_time: "<3s"
    database_query_time: "<500ms"
  
  data_integrity:
    - all_brands_have_required_fields: true
    - all_assets_accessible: true
    - all_integrations_tracked: true
    - backup_files_created: true
    - no_orphaned_records: true
  
  security:
    - vault_secrets_encrypted: true
    - api_endpoints_authenticated: true
    - file_permissions_secure: true
  
  reliability:
    - service_health_checks_pass: true
    - error_recovery_functional: true
    - monitoring_alerts_working: true

cleanup:
  - remove_test_brands:
      query: "DELETE FROM brands WHERE name LIKE '%Test%' OR name LIKE '%UI Test%'"
  - remove_test_integrations:
      query: "DELETE FROM integration_requests WHERE target_app_path LIKE '/tmp/%'"
  - cleanup_test_files:
      path: "/tmp/test-react-app"
      recursive: true
  - cleanup_test_assets:
      bucket: brand-logos
      pattern: "*Test*"