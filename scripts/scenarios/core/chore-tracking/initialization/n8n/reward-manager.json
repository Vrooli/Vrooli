{
  "name": "Reward Manager",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chore-tracker/rewards",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide defaults for manual testing\nreturn {\n  action: 'redeem',\n  user_id: 'test-user-001',\n  reward_id: 'reward-001'\n};"
      },
      "id": "set_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "value2": "redeem"
            }
          ]
        }
      },
      "id": "check_action",
      "name": "Check Action",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM users WHERE id = $1",
        "additionalFields": {
          "queryParams": "={{ $json.user_id }}"
        }
      },
      "id": "fetch_user",
      "name": "Fetch User",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1000, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM rewards WHERE id = $1 AND is_active = true",
        "additionalFields": {
          "queryParams": "={{ $('merge_triggers').item.json.reward_id }}"
        }
      },
      "id": "fetch_reward",
      "name": "Fetch Reward",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1200, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const user = $json;\nconst reward = $('fetch_reward').item.json;\n\n// Check if user has enough points\nif (user.total_points < reward.points_cost) {\n  return {\n    success: false,\n    error: 'Insufficient points',\n    points_needed: reward.points_cost - user.total_points,\n    user_points: user.total_points,\n    reward_cost: reward.points_cost\n  };\n}\n\n// Check daily/weekly limits if applicable\nif (reward.daily_limit || reward.weekly_limit) {\n  // Would need additional query to check redemption history\n  // For now, assume no limits reached\n}\n\nreturn {\n  success: true,\n  user_id: user.id,\n  reward_id: reward.id,\n  reward_name: reward.name,\n  points_cost: reward.points_cost,\n  new_balance: user.total_points - reward.points_cost,\n  reward_category: reward.category\n};"
      },
      "id": "validate_redemption",
      "name": "Validate Redemption",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1400, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.success }}",
              "value2": true
            }
          ]
        }
      },
      "id": "can_redeem",
      "name": "Can Redeem?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO reward_redemptions (user_id, reward_id, points_spent, redeemed_at)\nVALUES ($1, $2, $3, CURRENT_TIMESTAMP)\nRETURNING *",
        "additionalFields": {
          "queryParams": "={{ $json.user_id }},{{ $json.reward_id }},{{ $json.points_cost }}"
        }
      },
      "id": "save_redemption",
      "name": "Save Redemption",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1800, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users \nSET total_points = total_points - $1,\n    rewards_redeemed = rewards_redeemed + 1,\n    updated_at = CURRENT_TIMESTAMP\nWHERE id = $2\nRETURNING *",
        "additionalFields": {
          "queryParams": "={{ $json.points_cost }},{{ $json.user_id }}"
        }
      },
      "id": "update_user_points",
      "name": "Update User Points",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2000, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  r.*,\n  CASE \n    WHEN $1 >= r.points_cost THEN true\n    ELSE false\n  END as can_afford,\n  COALESCE(rr.redemption_count, 0) as times_redeemed\nFROM rewards r\nLEFT JOIN (\n  SELECT reward_id, COUNT(*) as redemption_count\n  FROM reward_redemptions\n  WHERE user_id = $2\n  GROUP BY reward_id\n) rr ON r.id = rr.reward_id\nWHERE r.is_active = true\nORDER BY r.points_cost ASC",
        "additionalFields": {
          "queryParams": "={{ $('fetch_user').item.json.total_points }},{{ $json.user_id }}"
        }
      },
      "id": "fetch_available_rewards",
      "name": "Fetch Available Rewards",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1000, 500],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "={{ $json.success ? 'success' : 'error' }}"
            },
            {
              "name": "message",
              "value": "={{ $json.success ? `Successfully redeemed ${$json.reward_name}!` : $json.error }}"
            }
          ],
          "number": [
            {
              "name": "new_balance",
              "value": "={{ $json.new_balance || $json.user_points }}"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare_response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [2200, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2400, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "set_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "check_action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_action": {
      "main": [
        [
          {
            "node": "fetch_user",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "fetch_available_rewards",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_user": {
      "main": [
        [
          {
            "node": "fetch_reward",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_reward": {
      "main": [
        [
          {
            "node": "validate_redemption",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validate_redemption": {
      "main": [
        [
          {
            "node": "can_redeem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "can_redeem": {
      "main": [
        [
          {
            "node": "save_redemption",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save_redemption": {
      "main": [
        [
          {
            "node": "update_user_points",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update_user_points": {
      "main": [
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "fetch_available_rewards": {
      "main": [
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_response": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "reward-manager",
  "tags": []
}