{
  "name": "Points Calculator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chore-tracker/calculate-points",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide defaults for manual testing\nreturn {\n  chore_id: 'test-chore-001',\n  user_id: 'test-user-001',\n  completion_time: 30,\n  quality_rating: 4,\n  difficulty: 'medium',\n  base_points: 10\n};"
      },
      "id": "set_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const choreData = $json;\n\n// Base points calculation\nlet points = choreData.base_points || 10;\n\n// Difficulty multiplier\nconst difficultyMultipliers = {\n  'easy': 0.8,\n  'medium': 1.0,\n  'hard': 1.5,\n  'extreme': 2.0\n};\npoints *= difficultyMultipliers[choreData.difficulty] || 1.0;\n\n// Speed bonus (complete faster than estimated)\nif (choreData.completion_time && choreData.estimated_time) {\n  const speedRatio = choreData.estimated_time / choreData.completion_time;\n  if (speedRatio > 1.2) {\n    points *= 1.2; // 20% bonus for being fast\n  } else if (speedRatio > 1.0) {\n    points *= 1.1; // 10% bonus\n  }\n}\n\n// Quality bonus\nif (choreData.quality_rating) {\n  const qualityBonus = choreData.quality_rating / 5;\n  points *= (0.8 + qualityBonus * 0.4); // 80% to 120% based on quality\n}\n\n// Streak bonus\nif (choreData.current_streak > 0) {\n  const streakBonus = Math.min(choreData.current_streak * 0.05, 0.5); // Max 50% bonus\n  points *= (1 + streakBonus);\n}\n\n// Weekend bonus\nconst completionDate = new Date(choreData.completed_at || new Date());\nconst dayOfWeek = completionDate.getDay();\nif (dayOfWeek === 0 || dayOfWeek === 6) {\n  points *= 1.15; // 15% weekend bonus\n}\n\n// Special achievements check\nconst achievements = [];\nif (choreData.current_streak === 7) {\n  achievements.push({\n    type: 'week_warrior',\n    name: 'Week Warrior',\n    description: '7 day streak!',\n    bonus_points: 50\n  });\n}\nif (choreData.current_streak === 30) {\n  achievements.push({\n    type: 'monthly_master',\n    name: 'Monthly Master',\n    description: '30 day streak!',\n    bonus_points: 200\n  });\n}\nif (choreData.total_chores_completed % 100 === 0) {\n  achievements.push({\n    type: 'century_cleaner',\n    name: 'Century Cleaner',\n    description: `${choreData.total_chores_completed} chores completed!`,\n    bonus_points: 100\n  });\n}\n\n// Add achievement points\nconst achievementPoints = achievements.reduce((sum, a) => sum + a.bonus_points, 0);\nconst finalPoints = Math.round(points + achievementPoints);\n\nreturn {\n  user_id: choreData.user_id,\n  chore_id: choreData.chore_id,\n  base_points: choreData.base_points,\n  calculated_points: Math.round(points),\n  achievement_points: achievementPoints,\n  total_points: finalPoints,\n  achievements: achievements,\n  multipliers_applied: {\n    difficulty: difficultyMultipliers[choreData.difficulty] || 1.0,\n    speed: choreData.completion_time ? (choreData.estimated_time / choreData.completion_time) : 1.0,\n    quality: choreData.quality_rating ? (0.8 + choreData.quality_rating / 5 * 0.4) : 1.0,\n    streak: choreData.current_streak ? (1 + Math.min(choreData.current_streak * 0.05, 0.5)) : 1.0,\n    weekend: (dayOfWeek === 0 || dayOfWeek === 6) ? 1.15 : 1.0\n  }\n};"
      },
      "id": "calculate_points",
      "name": "Calculate Points",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [800, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE users \nSET total_points = total_points + $1,\n    current_streak = CASE \n      WHEN last_chore_date = CURRENT_DATE - INTERVAL '1 day' THEN current_streak + 1\n      WHEN last_chore_date = CURRENT_DATE THEN current_streak\n      ELSE 1\n    END,\n    last_chore_date = CURRENT_DATE,\n    level = CASE\n      WHEN total_points + $1 >= 1000 THEN LEAST(level + 1, 100)\n      ELSE level\n    END,\n    updated_at = CURRENT_TIMESTAMP\nWHERE id = $2\nRETURNING *",
        "additionalFields": {
          "queryParams": "={{ $json.total_points }},{{ $json.user_id }}"
        }
      },
      "id": "update_user_points",
      "name": "Update User Points",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1000, 400],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.achievements.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "check_achievements",
      "name": "Check Achievements",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO user_achievements (user_id, achievement_type, achievement_name, description, points_awarded, awarded_at)\nVALUES ($1, $2, $3, $4, $5, CURRENT_TIMESTAMP)\nON CONFLICT (user_id, achievement_type) DO NOTHING\nRETURNING *",
        "additionalFields": {
          "mode": "independently",
          "queryParams": "={{ $json.achievements.map(a => `${$json.user_id},${a.type},${a.name},${a.description},${a.bonus_points}`).join(',') }}"
        }
      },
      "id": "save_achievements",
      "name": "Save Achievements",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1400, 300],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "={{ `Points calculated: ${$json.total_points} total (${$json.calculated_points} base + ${$json.achievement_points} achievements)` }}"
            }
          ],
          "number": [
            {
              "name": "points_awarded",
              "value": "={{ $json.total_points }}"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare_response",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1800, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "manual_trigger": {
      "main": [
        [
          {
            "node": "set_defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set_defaults": {
      "main": [
        [
          {
            "node": "merge_triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge_triggers": {
      "main": [
        [
          {
            "node": "calculate_points",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "calculate_points": {
      "main": [
        [
          {
            "node": "update_user_points",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update_user_points": {
      "main": [
        [
          {
            "node": "check_achievements",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_achievements": {
      "main": [
        [
          {
            "node": "save_achievements",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save_achievements": {
      "main": [
        [
          {
            "node": "prepare_response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare_response": {
      "main": [
        [
          {
            "node": "respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "points-calculator",
  "tags": []
}