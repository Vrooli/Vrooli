name: news-aggregator-bias-analysis
description: News aggregator that analyzes media bias across multiple sources
version: 1.0.0

tests:
  # Infrastructure tests
  - name: PostgreSQL Database Schema
    type: database
    service: postgres
    database: news_aggregator
    query: "SELECT COUNT(*) FROM feeds; SELECT COUNT(*) FROM articles;"
    expected: 
      min_feeds: 0
      min_articles: 0

  - name: N8N Workflow Service
    type: connectivity
    service: n8n
    endpoint: http://localhost:5678/api/v1/workflows
    expected: 200
    auth:
      type: bearer
      env: N8N_API_KEY

  # API Tests
  - name: API Health Check
    type: http
    endpoint: http://localhost:9300/health
    expected:
      status: 200
      body:
        status: healthy
        service: news-aggregator-bias-analysis

  - name: Feeds API Endpoints
    type: functional
    description: Test feed management via API
    steps:
      - action: list_feeds
        endpoint: /feeds
        method: GET
        expected: 
          status: 200
          min_items: 0
      
      - action: add_feed
        endpoint: /feeds
        method: POST
        body:
          name: "Test News Source"
          url: "https://example.com/rss"
          category: "general"
          bias_rating: "center"
        expected:
          status: 200
          contains:
            name: "Test News Source"

  - name: Articles API Endpoints
    type: functional
    description: Test article retrieval via API
    steps:
      - action: list_articles
        endpoint: /articles
        method: GET
        expected:
          status: 200
          min_items: 0
      
      - action: filter_by_category
        endpoint: /articles?category=general
        method: GET
        expected:
          status: 200

  # UI Tests
  - name: UI Health Check
    type: http
    endpoint: http://localhost:3300
    expected:
      status: 200
      contains: "The Perspective Press"

  - name: UI Static Assets
    type: functional
    description: Verify UI assets load correctly
    steps:
      - action: check_css
        endpoint: /styles.css
        method: GET
        expected:
          status: 200
          content_type: text/css
      
      - action: check_js
        endpoint: /script.js
        method: GET
        expected:
          status: 200
          content_type: application/javascript

  # N8N Workflow Tests
  - name: RSS Feed Fetcher Workflow
    type: n8n_workflow
    workflow: rss-feed-fetcher
    description: Test RSS feed fetching workflow
    trigger:
      type: webhook
      path: /webhook/rss-feed-fetcher
    expected:
      executions: success
      min_outputs: 1

  - name: Bias Analyzer Workflow
    type: n8n_workflow
    workflow: bias-analyzer
    description: Test bias analysis workflow
    trigger:
      type: webhook
      path: /webhook/bias-analyzer
      body:
        article_id: "test_article_001"
    expected:
      executions: success

  # CLI Tests
  - name: CLI Installation
    type: file_exists
    path: /usr/local/bin/news-bias
    expected: true
    permissions: executable

  - name: CLI Health Command
    type: command
    command: news-bias health
    expected:
      exit_code: 0
      output_contains: "Service is healthy"

validation:
  startup_timeout: 60
  health_check_interval: 5
  max_retries: 3
  required_services:
    - postgres
    - n8n
  optional_services:
    - ollama