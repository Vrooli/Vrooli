{
  "name": "Personal Digital Twin - Persona Chat",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "personal-digital-twin/chat",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide test defaults for manual testing\nreturn {\n  persona_id: 'test-persona-001',\n  message: 'Tell me about your interests in technology and innovation.',\n  conversation_id: 'conv-' + Date.now(),\n  user_id: 'user-001',\n  context: {\n    previous_messages: [],\n    session_start: new Date().toISOString()\n  }\n};"
      },
      "id": "set_test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT p.*, pt.traits, pt.knowledge_base FROM personas p LEFT JOIN persona_traits pt ON p.id = pt.persona_id WHERE p.id = $1",
        "additionalFields": {
          "queryParams": "={{ $json.persona_id }}"
        }
      },
      "id": "fetch_persona",
      "name": "Fetch Persona",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [800, 400],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/smart-semantic-search",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query",
              "value": "={{ $json.message }}"
            },
            {
              "name": "collection",
              "value": "persona_{{ $json.persona_id }}"
            },
            {
              "name": "limit",
              "value": "5"
            },
            {
              "name": "threshold",
              "value": "0.7"
            }
          ]
        },
        "options": {}
      },
      "id": "search_knowledge",
      "name": "Search Knowledge Base",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const input = $('merge_triggers').item.json;\nconst persona = $('fetch_persona').item.json[0] || {};\nconst knowledge = $('search_knowledge').item.json.results || [];\n\n// Build system prompt with persona traits\nconst traits = persona.traits || {};\nconst personalityStr = Object.entries(traits)\n  .map(([key, value]) => `${key}: ${value}`)\n  .join(', ');\n\n// Build context from knowledge base\nconst contextStr = knowledge\n  .map(k => k.content)\n  .join('\\n\\n');\n\n// Construct the prompt for the digital twin\nconst systemPrompt = `You are a digital twin with the following persona:\nName: ${persona.name || 'Digital Twin'}\nDescription: ${persona.description || 'A personalized AI assistant'}\nPersonality Traits: ${personalityStr || 'balanced and helpful'}\n\nRelevant Knowledge:\n${contextStr || 'No specific knowledge retrieved.'}\n\nConversation History:\n${input.context?.previous_messages?.map(m => `${m.role}: ${m.content}`).join('\\n') || 'New conversation'}\n\nRespond as this digital twin would, incorporating the personality traits and knowledge. Be authentic to the persona while being helpful.`;\n\nconst userMessage = input.message;\n\nconst fullPrompt = `${systemPrompt}\n\nUser: ${userMessage}\n\nDigital Twin:`;\n\nreturn {\n  prompt: fullPrompt,\n  model: 'llama3.2',\n  type: 'reasoning',\n  quiet: true,\n  timeout_seconds: 120,\n  persona_id: input.persona_id,\n  conversation_id: input.conversation_id,\n  user_message: userMessage,\n  knowledge_used: knowledge.map(k => k.id)\n};"
      },
      "id": "prepare_prompt",
      "name": "Prepare Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:5678/webhook/ollama",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "prompt",
              "value": "={{ $json.prompt }}"
            },
            {
              "name": "model",
              "value": "={{ $json.model }}"
            },
            {
              "name": "type",
              "value": "={{ $json.type }}"
            },
            {
              "name": "quiet",
              "value": "={{ $json.quiet }}"
            },
            {
              "name": "timeout_seconds",
              "value": "={{ $json.timeout_seconds }}"
            }
          ]
        },
        "options": {}
      },
      "id": "generate_response",
      "name": "Generate Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const prompt_data = $('prepare_prompt').item.json;\nconst ai_response = $input.item.json;\n\n// Extract the actual response\nlet response_text = '';\nif (ai_response.success && ai_response.response) {\n  response_text = ai_response.response.trim();\n} else {\n  response_text = 'I apologize, but I had trouble generating a response. Please try again.';\n}\n\n// Save to conversation history\nconst timestamp = new Date().toISOString();\n\nconst result = {\n  success: true,\n  conversation_id: prompt_data.conversation_id,\n  persona_id: prompt_data.persona_id,\n  message: {\n    role: 'assistant',\n    content: response_text,\n    timestamp: timestamp,\n    knowledge_used: prompt_data.knowledge_used\n  },\n  user_message: {\n    role: 'user',\n    content: prompt_data.user_message,\n    timestamp: timestamp\n  },\n  metadata: {\n    model_used: prompt_data.model,\n    execution_time_ms: ai_response.execution?.execution_time_ms || 0,\n    knowledge_items_retrieved: prompt_data.knowledge_used.length\n  }\n};\n\nreturn result;"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1600, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO conversations (id, persona_id, user_message, assistant_response, knowledge_used, timestamp) VALUES ($1, $2, $3, $4, $5, $6) ON CONFLICT (id) DO UPDATE SET assistant_response = $4, knowledge_used = $5, timestamp = $6",
        "additionalFields": {
          "queryParams": "={{ $json.conversation_id }},{{ $json.persona_id }},{{ JSON.stringify($json.user_message) }},{{ JSON.stringify($json.message) }},{{ JSON.stringify($json.metadata.knowledge_items_retrieved) }},{{ $json.message.timestamp }}"
        }
      },
      "id": "save_conversation",
      "name": "Save Conversation",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1800, 400],
      "credentials": {
        "postgres": {
          "id": "shared",
          "name": "Shared PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json, null, 2) }}",
        "options": {}
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 300]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{"node": "merge_triggers", "type": "main", "index": 0}]]
    },
    "manual_trigger": {
      "main": [[{"node": "set_test_defaults", "type": "main", "index": 0}]]
    },
    "set_test_defaults": {
      "main": [[{"node": "merge_triggers", "type": "main", "index": 1}]]
    },
    "merge_triggers": {
      "main": [[{"node": "fetch_persona", "type": "main", "index": 0}]]
    },
    "fetch_persona": {
      "main": [[
        {"node": "search_knowledge", "type": "main", "index": 0},
        {"node": "prepare_prompt", "type": "main", "index": 0}
      ]]
    },
    "search_knowledge": {
      "main": [[{"node": "prepare_prompt", "type": "main", "index": 0}]]
    },
    "prepare_prompt": {
      "main": [[{"node": "generate_response", "type": "main", "index": 0}]]
    },
    "generate_response": {
      "main": [[{"node": "format_response", "type": "main", "index": 0}]]
    },
    "format_response": {
      "main": [[{"node": "save_conversation", "type": "main", "index": 0}]]
    },
    "save_conversation": {
      "main": [[{"node": "respond", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {},
  "id": "personal-digital-twin-persona-chat"
}