{
  "name": "Personal Digital Twin - Model Training",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "personal-digital-twin/train",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 300]
    },
    {
      "parameters": {},
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [200, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Provide test defaults for manual testing\nreturn {\n  persona_id: $input.item.json.persona_id || 'test-persona-001',\n  training_type: $input.item.json.training_type || 'full',\n  model_params: $input.item.json.model_params || {\n    learning_rate: 0.001,\n    epochs: 10,\n    batch_size: 32,\n    model_size: 'small'\n  },\n  include_sources: $input.item.json.include_sources || ['text', 'email', 'documents'],\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "set_test_defaults",
      "name": "Set Test Defaults",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [400, 500]
    },
    {
      "parameters": {},
      "id": "merge_triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [600, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT doc_id, content, metadata FROM persona_documents WHERE persona_id = '{{ $json.persona_id }}' AND source_type = ANY(ARRAY{{ $json.include_sources }}) ORDER BY created_at DESC LIMIT 1000",
        "options": {}
      },
      "id": "fetch_training_data",
      "name": "Fetch Training Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [800, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-personal-digital-twin",
          "name": "PostgreSQL - Personal Digital Twin"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const trainingData = $('Fetch Training Data').all();\nconst params = $('Merge Triggers').item.json;\n\n// Prepare training corpus\nconst corpus = trainingData.map(item => {\n  const doc = item.json;\n  return {\n    text: doc.content,\n    metadata: doc.metadata\n  };\n});\n\n// Create training prompt for fine-tuning\nconst trainingPrompt = `Analyze this persona's communication patterns and preferences based on the following corpus of ${corpus.length} documents. Create a personality profile that includes:\n\n1. Communication style (formal/informal, verbose/concise)\n2. Key interests and topics\n3. Common phrases and vocabulary\n4. Emotional patterns\n5. Decision-making style\n\nCorpus sample (first 3 documents):\n${corpus.slice(0, 3).map(d => d.text).join('\\n\\n---\\n\\n')}\n\nGenerate a comprehensive JSON profile.`;\n\nreturn {\n  prompt: trainingPrompt,\n  model: 'llama3.2',\n  type: 'reasoning',\n  quiet: true,\n  persona_id: params.persona_id,\n  training_params: params.model_params,\n  document_count: corpus.length,\n  training_id: `training_${params.persona_id}_${Date.now()}`\n};"
      },
      "id": "prepare_training",
      "name": "Prepare Training",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1000, 400]
    },
    {
      "parameters": {
        "workflowId": "={{ $env.SHARED_WORKFLOW_OLLAMA }}",
        "source": "parameter",
        "workflowParameters": {
          "prompt": "={{ $json.prompt }}",
          "model": "={{ $json.model }}",
          "type": "={{ $json.type }}",
          "quiet": "={{ $json.quiet }}"
        }
      },
      "id": "generate_profile",
      "name": "Generate Profile",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [1200, 400]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const profileResult = $('Generate Profile').item.json;\nconst trainingMeta = $('Prepare Training').item.json;\n\n// Parse AI-generated profile\nlet profile = {};\ntry {\n  if (profileResult.response) {\n    const jsonMatch = profileResult.response.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      profile = JSON.parse(jsonMatch[0]);\n    }\n  }\n} catch (e) {\n  profile = {\n    communication_style: 'balanced',\n    interests: ['technology', 'innovation'],\n    vocabulary: [],\n    emotional_patterns: 'neutral',\n    decision_style: 'analytical'\n  };\n}\n\n// Create fine-tuning configuration\nconst finetuneConfig = {\n  base_model: 'llama3.2',\n  persona_id: trainingMeta.persona_id,\n  profile: profile,\n  training_params: trainingMeta.training_params,\n  training_id: trainingMeta.training_id,\n  document_count: trainingMeta.document_count,\n  status: 'ready_for_training'\n};\n\nreturn finetuneConfig;"
      },
      "id": "create_finetune_config",
      "name": "Create Finetune Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1400, 400]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "persona_models",
        "columns": "persona_id,training_id,model_config,profile,status,created_at",
        "values": "={{ $json.persona_id }},={{ $json.training_id }},={{ JSON.stringify($json.training_params) }},={{ JSON.stringify($json.profile) }},={{ $json.status }},={{ new Date().toISOString() }}",
        "options": {}
      },
      "id": "store_model_config",
      "name": "Store Model Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1600, 300],
      "credentials": {
        "postgres": {
          "id": "postgres-personal-digital-twin",
          "name": "PostgreSQL - Personal Digital Twin"
        }
      }
    },
    {
      "parameters": {
        "key": "persona_model_{{ $json.persona_id }}",
        "value": "={{ JSON.stringify($json) }}",
        "expire": true,
        "ttl": 86400,
        "options": {}
      },
      "id": "cache_in_redis",
      "name": "Cache in Redis",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1600, 500],
      "credentials": {
        "redis": {
          "id": "redis-personal-digital-twin",
          "name": "Redis - Personal Digital Twin"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const config = $('Create Finetune Config').item.json;\n\nreturn {\n  success: true,\n  message: `Model training initiated for persona ${config.persona_id}`,\n  training_id: config.training_id,\n  profile_summary: {\n    communication_style: config.profile.communication_style || 'analyzing',\n    main_interests: (config.profile.interests || []).slice(0, 3),\n    document_count: config.document_count\n  },\n  next_steps: [\n    'Profile generated and stored',\n    'Ready for fine-tuning when supported',\n    'Persona can now be queried using the profile'\n  ],\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "format_response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1800, 400]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond_to_webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 400]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Test Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Test Defaults": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Fetch Training Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Training Data": {
      "main": [
        [
          {
            "node": "Prepare Training",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Training": {
      "main": [
        [
          {
            "node": "Generate Profile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Profile": {
      "main": [
        [
          {
            "node": "Create Finetune Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Finetune Config": {
      "main": [
        [
          {
            "node": "Store Model Config",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cache in Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Model Config": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache in Redis": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "personal-digital-twin-model-training"
}