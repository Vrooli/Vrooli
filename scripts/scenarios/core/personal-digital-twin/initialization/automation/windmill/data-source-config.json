{
  "summary": "Personal Digital Twin - Data Source Configuration",
  "description": "Configure and manage data sources for personas",
  "policy": {
    "on_behalf_of": "u/admin",
    "on_behalf_of_email": "admin@windmill.dev"
  },
  "grid": [
    {
      "id": "a",
      "data": {
        "type": "displaycomponent",
        "componentInput": {
          "type": "static",
          "value": {
            "title": "Data Source Configuration", 
            "description": "Connect and manage data sources for your personas"
          }
        },
        "configuration": {
          "style": {
            "backgroundColor": "#f8fafc",
            "padding": "1rem",
            "borderRadius": "0.5rem"
          }
        }
      },
      "3": { "x": 0, "y": 0, "w": 12, "h": 2 }
    },
    {
      "id": "b",
      "data": {
        "type": "selectcomponent",
        "componentInput": {
          "type": "runnable",
          "runnable": {
            "type": "runnableByName",
            "name": "f/datasources/list_personas"
          }
        },
        "configuration": {
          "placeholder": "Select a persona...",
          "itemKey": "id",
          "itemValue": "name"
        }
      },
      "3": { "x": 0, "y": 2, "w": 4, "h": 1 }
    },
    {
      "id": "c",
      "data": {
        "type": "buttoncomponent",
        "componentInput": {
          "type": "static", 
          "value": {
            "label": "Add Data Source",
            "color": "green",
            "size": "md"
          }
        },
        "runnable": {
          "type": "runnableByName",
          "name": "f/datasources/create_source"
        }
      },
      "3": { "x": 4, "y": 2, "w": 3, "h": 1 }
    },
    {
      "id": "d",
      "data": {
        "type": "tablecomponent",
        "componentInput": {
          "type": "runnable",
          "runnable": {
            "type": "runnableByName", 
            "name": "f/datasources/list_sources"
          }
        },
        "configuration": {
          "columns": {
            "persona_name": {
              "displayName": "Persona"
            },
            "source_type": {
              "displayName": "Type"
            },
            "total_documents": {
              "displayName": "Documents"
            },
            "total_size_bytes": {
              "displayName": "Size (MB)"
            },
            "last_sync": {
              "displayName": "Last Sync",
              "type": "datetime"
            },
            "status": {
              "displayName": "Status"
            }
          },
          "actions": [
            {
              "id": "sync",
              "displayName": "Sync Now",
              "runnable": {
                "type": "runnableByName",
                "name": "f/datasources/sync_source"
              }
            },
            {
              "id": "configure",
              "displayName": "Configure",
              "runnable": {
                "type": "runnableByName",
                "name": "f/datasources/configure_source"
              }
            },
            {
              "id": "delete",
              "displayName": "Delete",
              "runnable": {
                "type": "runnableByName",
                "name": "f/datasources/delete_source"
              },
              "confirmationModal": {
                "title": "Delete Data Source?",
                "description": "This will remove the data source configuration."
              }
            }
          ]
        }
      },
      "3": { "x": 0, "y": 3, "w": 12, "h": 8 }
    },
    {
      "id": "e",
      "data": {
        "type": "formcomponent",
        "componentInput": {
          "type": "static",
          "value": {
            "schema": {
              "properties": {
                "persona_id": {
                  "type": "string",
                  "title": "Persona",
                  "description": "Select the persona to add data source to"
                },
                "source_type": {
                  "type": "string", 
                  "title": "Data Source Type",
                  "enum": ["local_files", "google_drive", "github", "email"],
                  "enumLabels": ["Local Files", "Google Drive", "GitHub", "Email"]
                },
                "source_config": {
                  "type": "object",
                  "title": "Configuration",
                  "properties": {
                    "path": {
                      "type": "string",
                      "title": "Path/URL"
                    },
                    "include_patterns": {
                      "type": "array",
                      "title": "Include Patterns",
                      "items": {"type": "string"},
                      "default": ["*.pdf", "*.txt", "*.md", "*.docx"]
                    },
                    "exclude_patterns": {
                      "type": "array",
                      "title": "Exclude Patterns", 
                      "items": {"type": "string"},
                      "default": ["*.tmp", "node_modules"]
                    }
                  }
                },
                "sync_frequency": {
                  "type": "string",
                  "title": "Sync Frequency",
                  "enum": ["manual", "hourly", "daily", "weekly"],
                  "default": "daily"
                }
              },
              "required": ["persona_id", "source_type", "source_config"]
            }
          }
        },
        "runnable": {
          "type": "runnableByName",
          "name": "f/datasources/create_source"
        },
        "configuration": {
          "displayType": "modal",
          "modalTitle": "Add Data Source"
        }
      },
      "3": { "x": 7, "y": 2, "w": 5, "h": 1 }
    }
  ],
  "unusedInlineScripts": [
    {
      "name": "f/datasources/list_personas",
      "language": "postgresql",
      "content": "SELECT id, name FROM personas ORDER BY name;",
      "schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "type": "object",
        "properties": {}
      }
    },
    {
      "name": "f/datasources/list_sources",
      "language": "postgresql", 
      "content": "SELECT ds.id, p.name as persona_name, ds.source_type, ds.total_documents, ROUND(ds.total_size_bytes/1024/1024, 2) as total_size_mb, ds.last_sync, ds.status FROM data_sources ds JOIN personas p ON ds.persona_id = p.id ORDER BY ds.created_at DESC;",
      "schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "type": "object",
        "properties": {}
      }
    },
    {
      "name": "f/datasources/create_source",
      "language": "postgresql",
      "content": "INSERT INTO data_sources (persona_id, source_type, source_config, sync_frequency) VALUES ($1, $2, $3::jsonb, $4) RETURNING id;",
      "schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "type": "object",
        "properties": {
          "persona_id": {"type": "string"},
          "source_type": {"type": "string"},
          "source_config": {"type": "object"},
          "sync_frequency": {"type": "string"}
        },
        "required": ["persona_id", "source_type", "source_config"]
      }
    },
    {
      "name": "f/datasources/sync_source",
      "language": "bash",
      "content": "#!/bin/bash\n# Trigger data source sync via n8n webhook\ncurl -X POST http://n8n:5678/webhook/ingest \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"source_id\\\": \\\"$1\\\"}\"",
      "schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "type": "object",
        "properties": {
          "source_id": {"type": "string"}
        },
        "required": ["source_id"]
      }
    },
    {
      "name": "f/datasources/delete_source",
      "language": "postgresql",
      "content": "DELETE FROM data_sources WHERE id = $1;",
      "schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "type": "object",
        "properties": {
          "source_id": {"type": "string"}
        },
        "required": ["source_id"]
      }
    },
    {
      "name": "f/datasources/configure_source",
      "language": "bash",
      "content": "#!/bin/bash\n# Open configuration modal for data source\necho \"Configuration for source $1\"",
      "schema": {
        "$schema": "https://json-schema.org/draft/2020-12/schema", 
        "type": "object",
        "properties": {
          "source_id": {"type": "string"}
        },
        "required": ["source_id"]
      }
    }
  ]
}