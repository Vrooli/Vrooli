{
  "name": "Model Training Pipeline",
  "active": true,
  "nodes": [
    {
      "name": "Training Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "webhookId": "train-model",
      "parameters": {
        "path": "train",
        "method": "POST",
        "options": {}
      }
    },
    {
      "name": "Validate Training Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [350, 300],
      "parameters": {
        "language": "javascript",
        "jsCode": "// Validate training request\nconst { persona_id, model, technique, job_id } = $input.first().json;\n\nif (!persona_id) {\n  throw new Error('persona_id is required');\n}\nif (!model) {\n  throw new Error('model is required');\n}\nif (!technique) {\n  throw new Error('training technique is required');\n}\n\nreturn {\n  persona_id,\n  model: model || 'llama3.2',\n  technique: technique || 'lora',\n  job_id: job_id || `job_${Date.now()}`,\n  started_at: new Date().toISOString()\n};"
      }
    },
    {
      "name": "Check Persona Exists",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [500, 300],
      "parameters": {
        "url": "http://localhost:8200/api/persona/={{$json.persona_id}}",
        "method": "GET",
        "options": {
          "timeout": 10000
        }
      }
    },
    {
      "name": "Update Training Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [650, 300],
      "parameters": {
        "url": "=http://postgres:5433",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/sql"
            }
          ]
        },
        "sendBody": true,
        "body": "=UPDATE training_jobs SET status = 'running', started_at = NOW() WHERE id = '{{$json.job_id}}';"
      }
    },
    {
      "name": "Gather Training Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [800, 300],
      "parameters": {
        "url": "http://qdrant:6333/collections/documents/points/search",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"vector\": [],\n  \"filter\": {\n    \"must\": [\n      {\n        \"key\": \"persona_id\",\n        \"match\": {\"value\": \"{{$json.persona_id}}\"}\n      }\n    ]\n  },\n  \"limit\": 1000,\n  \"with_payload\": true\n}"
      }
    },
    {
      "name": "Prepare Training Dataset",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [950, 300],
      "parameters": {
        "language": "javascript",
        "jsCode": "// Prepare training dataset from gathered documents\nconst input = $input.first().json;\nconst documents = input.result || [];\n\n// Convert documents to training format\nconst trainingData = documents.map(doc => {\n  const payload = doc.payload;\n  return {\n    instruction: \"You are a personal AI assistant. Respond based on the following context:\",\n    input: payload.content,\n    output: `Based on the provided information: ${payload.content.substring(0, 200)}...`,\n    source: payload.source_type\n  };\n});\n\n// Create dataset metadata\nconst dataset = {\n  persona_id: input.persona_id,\n  total_samples: trainingData.length,\n  created_at: new Date().toISOString(),\n  training_data: trainingData.slice(0, 500) // Limit to 500 samples\n};\n\nreturn {\n  ...input,\n  dataset,\n  dataset_path: `/tmp/training_data_${input.persona_id}.json`\n};"
      }
    },
    {
      "name": "Store Training Dataset",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1100, 300],
      "parameters": {
        "url": "=http://minio:9000/model-checkpoints/{{$json.persona_id}}/training_data.json",
        "method": "PUT",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "body": "={{JSON.stringify($json.dataset)}}"
      }
    },
    {
      "name": "Start Fine-Tuning",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300],
      "parameters": {
        "language": "javascript",
        "jsCode": "// Mock fine-tuning process\n// In real implementation, this would call Ollama's fine-tuning API\nconst input = $input.first().json;\n\n// Simulate training process\nconst trainingConfig = {\n  base_model: input.model,\n  technique: input.technique,\n  learning_rate: 0.0001,\n  epochs: 3,\n  batch_size: 4,\n  dataset_path: input.dataset_path\n};\n\n// Mock training results\nconst results = {\n  ...input,\n  training_config: trainingConfig,\n  model_path: `/models/${input.persona_id}_${input.model}_${input.technique}`,\n  training_loss: 0.85,\n  validation_loss: 0.92,\n  training_time_seconds: 3600,\n  status: 'completed'\n};\n\nreturn results;"
      }
    },
    {
      "name": "Update Training Job",
      "type": "n8n-nodes-base.httpRequest", 
      "typeVersion": 4,
      "position": [1400, 300],
      "parameters": {
        "url": "=http://postgres:5433",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/sql"
            }
          ]
        },
        "sendBody": true,
        "body": "=UPDATE training_jobs SET status = '{{$json.status}}', completed_at = NOW(), checkpoint_path = '{{$json.model_path}}', metrics = '{{JSON.stringify({training_loss: $json.training_loss, validation_loss: $json.validation_loss, training_time: $json.training_time_seconds})}}' WHERE id = '{{$json.job_id}}';"
      }
    },
    {
      "name": "Update Persona Model",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1550, 300],
      "parameters": {
        "url": "=http://postgres:5433",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/sql"
            }
          ]
        },
        "sendBody": true,
        "body": "=UPDATE personas SET fine_tuned_model_path = '{{$json.model_path}}', training_status = 'completed', last_trained = NOW() WHERE id = '{{$json.persona_id}}';"
      }
    },
    {
      "name": "Training Failed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1100, 500],
      "parameters": {
        "url": "=http://postgres:5433",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/sql"
            }
          ]
        },
        "sendBody": true,
        "body": "=UPDATE training_jobs SET status = 'failed', completed_at = NOW(), error_message = 'Training process failed' WHERE id = '{{$json.job_id}}';"
      }
    }
  ],
  "connections": {
    "Training Trigger": {
      "main": [[ {"node": "Validate Training Request", "type": "main", "index": 0} ]]
    },
    "Validate Training Request": {
      "main": [[ {"node": "Check Persona Exists", "type": "main", "index": 0} ]]
    },
    "Check Persona Exists": {
      "main": [[ {"node": "Update Training Status", "type": "main", "index": 0} ]]
    },
    "Update Training Status": {
      "main": [[ {"node": "Gather Training Data", "type": "main", "index": 0} ]]
    },
    "Gather Training Data": {
      "main": [[ {"node": "Prepare Training Dataset", "type": "main", "index": 0} ]]
    },
    "Prepare Training Dataset": {
      "main": [[ {"node": "Store Training Dataset", "type": "main", "index": 0} ]]
    },
    "Store Training Dataset": {
      "main": [[ {"node": "Start Fine-Tuning", "type": "main", "index": 0} ]]
    },
    "Start Fine-Tuning": {
      "main": [[ {"node": "Update Training Job", "type": "main", "index": 0} ]]
    },
    "Update Training Job": {
      "main": [[ {"node": "Update Persona Model", "type": "main", "index": 0} ]]
    }
  },
  "pinData": {},
  "settings": {
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}