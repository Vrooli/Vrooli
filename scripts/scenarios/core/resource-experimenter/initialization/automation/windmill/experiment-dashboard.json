{
  "summary": "Resource Experiment Dashboard",
  "description": "Monitor and manage resource discovery experiments",
  "value": {
    "grid": [
      {
        "id": "header",
        "data": {
          "type": "containercomponent",
          "configuration": {
            "style": {
              "backgroundColor": "#f8f9fa",
              "border": "1px solid #e9ecef",
              "borderRadius": "8px",
              "padding": "20px",
              "marginBottom": "20px"
            }
          },
          "components": [
            {
              "id": "title",
              "data": {
                "type": "textcomponent",
                "configuration": {
                  "text": "Resource Experiment Dashboard",
                  "style": {
                    "fontSize": "24px",
                    "fontWeight": "bold",
                    "color": "#333",
                    "marginBottom": "10px"
                  }
                }
              }
            },
            {
              "id": "subtitle",
              "data": {
                "type": "textcomponent", 
                "configuration": {
                  "text": "Automated discovery and testing of new resources for Vrooli integration",
                  "style": {
                    "fontSize": "14px",
                    "color": "#666"
                  }
                }
              }
            }
          ]
        }
      },
      {
        "id": "stats_row",
        "data": {
          "type": "containercomponent",
          "configuration": {
            "style": {
              "display": "flex",
              "gap": "20px",
              "marginBottom": "30px"
            }
          },
          "components": [
            {
              "id": "stats_discovered",
              "data": {
                "type": "statscomponent",
                "configuration": {
                  "title": "Resources Discovered",
                  "value": {
                    "type": "evalv2",
                    "expr": "window.pg_query('SELECT COUNT(*) as count FROM discovery_queue')",
                    "connections": ["postgresql"]
                  },
                  "progress": false,
                  "style": {
                    "backgroundColor": "#e3f2fd",
                    "color": "#1565c0"
                  }
                }
              }
            },
            {
              "id": "stats_experiments",
              "data": {
                "type": "statscomponent",
                "configuration": {
                  "title": "Experiments Running",
                  "value": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"SELECT COUNT(*) as count FROM experiments WHERE status = 'running'\")",
                    "connections": ["postgresql"]
                  },
                  "progress": false,
                  "style": {
                    "backgroundColor": "#fff3e0",
                    "color": "#ef6c00"
                  }
                }
              }
            },
            {
              "id": "stats_successful",
              "data": {
                "type": "statscomponent",
                "configuration": {
                  "title": "Successful Tests",
                  "value": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"SELECT COUNT(*) as count FROM experiments WHERE success = true\")",
                    "connections": ["postgresql"]
                  },
                  "progress": false,
                  "style": {
                    "backgroundColor": "#e8f5e8",
                    "color": "#2e7d32"
                  }
                }
              }
            },
            {
              "id": "stats_apps",
              "data": {
                "type": "statscomponent",
                "configuration": {
                  "title": "Apps Generated",
                  "value": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"SELECT COUNT(*) as count FROM integration_attempts WHERE status = 'successful'\")",
                    "connections": ["postgresql"]
                  },
                  "progress": false,
                  "style": {
                    "backgroundColor": "#f3e5f5",
                    "color": "#7b1fa2"
                  }
                }
              }
            }
          ]
        }
      },
      {
        "id": "discovery_queue_section",
        "data": {
          "type": "containercomponent",
          "configuration": {
            "style": {
              "marginBottom": "30px"
            }
          },
          "components": [
            {
              "id": "queue_title",
              "data": {
                "type": "textcomponent",
                "configuration": {
                  "text": "Discovery Queue",
                  "style": {
                    "fontSize": "18px",
                    "fontWeight": "bold",
                    "marginBottom": "15px"
                  }
                }
              }
            },
            {
              "id": "discovery_table",
              "data": {
                "type": "aggridcomponent",
                "configuration": {
                  "columnDefs": [
                    {"headerName": "Resource", "field": "name", "flex": 2},
                    {"headerName": "Type", "field": "type", "flex": 1},
                    {"headerName": "Priority", "field": "priority", "flex": 1, "sort": "desc"},
                    {"headerName": "Discovered", "field": "discovered_at", "flex": 2},
                    {"headerName": "Status", "field": "processed", "flex": 1, "cellRenderer": "statusRenderer"}
                  ],
                  "rowData": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"SELECT name, type, priority, discovered_at, processed, discovered_by FROM discovery_queue ORDER BY priority DESC, discovered_at ASC LIMIT 20\")",
                    "connections": ["postgresql"]
                  },
                  "pagination": true,
                  "paginationPageSize": 10,
                  "defaultColDef": {
                    "resizable": true,
                    "sortable": true,
                    "filter": true
                  },
                  "cellRenderers": {
                    "statusRenderer": "params.value ? 'Processed' : 'Pending'"
                  }
                }
              }
            }
          ]
        }
      },
      {
        "id": "active_experiments_section",
        "data": {
          "type": "containercomponent",
          "configuration": {
            "style": {
              "marginBottom": "30px"
            }
          },
          "components": [
            {
              "id": "experiments_title",
              "data": {
                "type": "textcomponent",
                "configuration": {
                  "text": "Active Experiments",
                  "style": {
                    "fontSize": "18px",
                    "fontWeight": "bold",
                    "marginBottom": "15px"
                  }
                }
              }
            },
            {
              "id": "experiments_table",
              "data": {
                "type": "aggridcomponent",
                "configuration": {
                  "columnDefs": [
                    {"headerName": "Name", "field": "name", "flex": 2},
                    {"headerName": "Resource Type", "field": "resource_type", "flex": 1},
                    {"headerName": "Status", "field": "status", "flex": 1, "cellRenderer": "statusBadgeRenderer"},
                    {"headerName": "Port", "field": "allocated_port", "flex": 1},
                    {"headerName": "Started", "field": "started_at", "flex": 2},
                    {"headerName": "Duration", "field": "duration_minutes", "flex": 1},
                    {"headerName": "Success", "field": "success", "flex": 1, "cellRenderer": "successRenderer"},
                    {"headerName": "Actions", "field": "actions", "flex": 1, "cellRenderer": "actionRenderer"}
                  ],
                  "rowData": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"SELECT e.*, EXTRACT(EPOCH FROM (COALESCE(e.completed_at, NOW()) - e.started_at))/60 as duration_minutes FROM experiments e WHERE e.status IN ('running', 'completed', 'failed') ORDER BY e.started_at DESC LIMIT 20\")",
                    "connections": ["postgresql"]
                  },
                  "pagination": true,
                  "paginationPageSize": 10,
                  "defaultColDef": {
                    "resizable": true,
                    "sortable": true,
                    "filter": true
                  },
                  "cellRenderers": {
                    "statusBadgeRenderer": "getStatusBadge(params.value)",
                    "successRenderer": "params.value ? '✅' : params.value === false ? '❌' : '⏳'",
                    "actionRenderer": "getActionButtons(params.data)"
                  }
                }
              }
            }
          ]
        }
      },
      {
        "id": "controls_section",
        "data": {
          "type": "containercomponent",
          "configuration": {
            "style": {
              "display": "flex",
              "gap": "20px",
              "marginBottom": "30px"
            }
          },
          "components": [
            {
              "id": "manual_discovery_btn",
              "data": {
                "type": "buttoncomponent",
                "configuration": {
                  "label": "Trigger Discovery",
                  "color": "blue",
                  "size": "default",
                  "onClick": {
                    "type": "evalv2",
                    "expr": "window.http_request('POST', 'http://localhost:5679/webhook/resource-discovery', {})"
                  },
                  "style": {
                    "minWidth": "150px"
                  }
                }
              }
            },
            {
              "id": "run_experiment_btn",
              "data": {
                "type": "buttoncomponent",
                "configuration": {
                  "label": "Run Next Experiment",
                  "color": "green",
                  "size": "default",
                  "onClick": {
                    "type": "evalv2",
                    "expr": "window.http_request('POST', 'http://localhost:5679/webhook/experiment-orchestrator', {})"
                  },
                  "style": {
                    "minWidth": "150px"
                  }
                }
              }
            },
            {
              "id": "cleanup_btn",
              "data": {
                "type": "buttoncomponent",
                "configuration": {
                  "label": "Cleanup Failed",
                  "color": "red",
                  "size": "default",
                  "onClick": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"UPDATE experiments SET status = 'abandoned' WHERE status = 'failed' AND completed_at < NOW() - INTERVAL '24 hours'\")"
                  },
                  "style": {
                    "minWidth": "150px"
                  }
                }
              }
            },
            {
              "id": "refresh_btn",
              "data": {
                "type": "buttoncomponent",
                "configuration": {
                  "label": "Refresh Data",
                  "color": "gray",
                  "size": "default",
                  "onClick": {
                    "type": "evalv2",
                    "expr": "window.location.reload()"
                  },
                  "style": {
                    "minWidth": "150px"
                  }
                }
              }
            }
          ]
        }
      },
      {
        "id": "recent_results_section",
        "data": {
          "type": "containercomponent",
          "configuration": {
            "style": {
              "marginBottom": "30px"
            }
          },
          "components": [
            {
              "id": "results_title",
              "data": {
                "type": "textcomponent",
                "configuration": {
                  "text": "Recent Test Results",
                  "style": {
                    "fontSize": "18px",
                    "fontWeight": "bold",
                    "marginBottom": "15px"
                  }
                }
              }
            },
            {
              "id": "test_results_table",
              "data": {
                "type": "aggridcomponent",
                "configuration": {
                  "columnDefs": [
                    {"headerName": "Test Name", "field": "test_name", "flex": 2},
                    {"headerName": "Type", "field": "test_type", "flex": 1},
                    {"headerName": "Result", "field": "result", "flex": 1, "cellRenderer": "resultRenderer"},
                    {"headerName": "Execution Time", "field": "execution_time_ms", "flex": 1, "valueFormatter": "formatExecutionTime"},
                    {"headerName": "Executed", "field": "executed_at", "flex": 2}
                  ],
                  "rowData": {
                    "type": "evalv2",
                    "expr": "window.pg_query(\"SELECT test_name, test_type, result, execution_time_ms, executed_at FROM experiment_tests ORDER BY executed_at DESC LIMIT 15\")",
                    "connections": ["postgresql"]
                  },
                  "pagination": true,
                  "paginationPageSize": 10,
                  "defaultColDef": {
                    "resizable": true,
                    "sortable": true,
                    "filter": true
                  },
                  "cellRenderers": {
                    "resultRenderer": "getResultBadge(params.value)"
                  },
                  "valueFormatters": {
                    "formatExecutionTime": "params.value ? (params.value + ' ms') : 'N/A'"
                  }
                }
              }
            }
          ]
        }
      }
    ],
    "css": `
      .status-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status-running { background-color: #fff3cd; color: #856404; }
      .status-completed { background-color: #d4edda; color: #155724; }
      .status-failed { background-color: #f8d7da; color: #721c24; }
      .status-planned { background-color: #d1ecf1; color: #0c5460; }
      
      .result-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .result-pass { background-color: #d4edda; color: #155724; }
      .result-fail { background-color: #f8d7da; color: #721c24; }
      .result-skip { background-color: #e2e3e5; color: #383d41; }
      .result-error { background-color: #f8d7da; color: #721c24; }
      
      .action-buttons {
        display: flex;
        gap: 5px;
      }
      .action-btn {
        padding: 2px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .action-btn:hover {
        opacity: 0.8;
      }
    `,
    "scripts": [
      {
        "type": "frontend",
        "content": `
          function getStatusBadge(status) {
            const badgeClass = 'status-badge status-' + (status || 'unknown').toLowerCase();
            return '<span class="' + badgeClass + '">' + (status || 'Unknown') + '</span>';
          }
          
          function getResultBadge(result) {
            const badgeClass = 'result-badge result-' + (result || 'unknown').toLowerCase();
            return '<span class="' + badgeClass + '">' + (result || 'Unknown') + '</span>';
          }
          
          function getActionButtons(data) {
            let buttons = '<div class="action-buttons">';
            
            if (data.status === 'running') {
              buttons += '<button class="action-btn" style="background-color: #dc3545; color: white;" onclick="stopExperiment(\'' + data.id + '\')">Stop</button>';
            } else if (data.status === 'failed') {
              buttons += '<button class="action-btn" style="background-color: #28a745; color: white;" onclick="retryExperiment(\'' + data.id + '\')">Retry</button>';
            }
            
            buttons += '<button class="action-btn" style="background-color: #17a2b8; color: white;" onclick="viewExperiment(\'' + data.id + '\')">View</button>';
            buttons += '</div>';
            
            return buttons;
          }
          
          function stopExperiment(experimentId) {
            if (confirm('Stop experiment ' + experimentId + '?')) {
              window.pg_query("UPDATE experiments SET status = 'abandoned' WHERE id = '" + experimentId + "'")
                .then(() => {
                  alert('Experiment stopped');
                  window.location.reload();
                });
            }
          }
          
          function retryExperiment(experimentId) {
            if (confirm('Retry failed experiment ' + experimentId + '?')) {
              window.pg_query("UPDATE experiments SET status = 'planned', started_at = NULL, completed_at = NULL WHERE id = '" + experimentId + "'")
                .then(() => {
                  alert('Experiment queued for retry');
                  window.location.reload();
                });
            }
          }
          
          function viewExperiment(experimentId) {
            window.open('/experiment-details?id=' + experimentId, '_blank');
          }
        `
      }
    ]
  },
  "schema": {
    "connections": [
      {
        "name": "postgresql", 
        "type": "postgresql",
        "host": "localhost",
        "port": 5432,
        "database": "resource_experiments",
        "username": "postgres"
      }
    ]
  }
}