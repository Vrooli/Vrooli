#!/usr/bin/env bash
# Resource Experimenter CLI
# Command-line interface for managing AI-powered resource experimentation

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLI_NAME="resource-experimenter"
VERSION="1.0.0"

# Default API URL - can be overridden via environment
API_URL="${RESOURCE_EXPERIMENTER_API_URL:-http://localhost:8092}"

# Color codes for styling
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Banner
show_banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                                                                       
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù   ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù
                                                                                                       
                üß™ AI-Powered Resource Experimentation Platform v${VERSION} üß™
EOF
    echo -e "${NC}"
}

# Error handling
error() {
    echo -e "${RED}‚ùå Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

info() {
    echo -e "${CYAN}‚ÑπÔ∏è  $1${NC}"
}

warn() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# API helper functions
api_get() {
    local endpoint="$1"
    curl -s "${API_URL}${endpoint}" || error "Failed to connect to API at ${API_URL}"
}

api_post() {
    local endpoint="$1"
    local data="$2"
    curl -s -X POST -H "Content-Type: application/json" -d "$data" "${API_URL}${endpoint}" || error "Failed to post to API"
}

api_delete() {
    local endpoint="$1"
    curl -s -X DELETE "${API_URL}${endpoint}" || error "Failed to delete via API"
}

# Check if API is available
check_api() {
    if ! api_get "/health" > /dev/null 2>&1; then
        error "Resource Experimenter API is not running at ${API_URL}. Please start it first."
    fi
}

# Command implementations
cmd_status() {
    info "Checking Resource Experimenter status..."
    check_api
    
    local health_response
    health_response=$(api_get "/health")
    
    if echo "$health_response" | jq -r '.status' | grep -q "healthy"; then
        success "Resource Experimenter API is healthy"
        info "API URL: ${API_URL}"
        
        # Show quick stats
        local experiment_count
        experiment_count=$(api_get "/api/experiments" | jq '. | length')
        info "Total experiments: ${experiment_count}"
        
        local running_count
        running_count=$(api_get "/api/experiments?status=running" | jq '. | length')
        if [[ $running_count -gt 0 ]]; then
            info "Running experiments: ${running_count}"
        fi
    else
        error "API is not healthy"
    fi
}

cmd_start() {
    local prompt="$1"
    
    if [[ -z "$prompt" ]]; then
        error "Please provide an experiment description. Example: 'Add Redis to analytics-dashboard'"
    fi
    
    check_api
    
    # Parse prompt to extract target scenario and new resource
    # Simple pattern: "Add [RESOURCE] to [SCENARIO]"
    if [[ $prompt =~ [Aa]dd[[:space:]]+([a-zA-Z0-9-]+)[[:space:]]+to[[:space:]]+([a-zA-Z0-9-]+) ]]; then
        local new_resource="${BASH_REMATCH[1]}"
        local target_scenario="${BASH_REMATCH[2]}"
        local experiment_name="Add ${new_resource} to ${target_scenario}"
        
        info "Creating experiment: ${experiment_name}"
        info "Target scenario: ${target_scenario}"
        info "New resource: ${new_resource}"
        
        local request_data
        request_data=$(jq -n \
            --arg name "$experiment_name" \
            --arg description "$prompt" \
            --arg prompt "$prompt" \
            --arg target_scenario "$target_scenario" \
            --arg new_resource "$new_resource" \
            '{
                name: $name,
                description: $description,
                prompt: $prompt,
                target_scenario: $target_scenario,
                new_resource: $new_resource
            }')
        
        local response
        response=$(api_post "/api/experiments" "$request_data")
        
        local experiment_id
        experiment_id=$(echo "$response" | jq -r '.id')
        
        if [[ "$experiment_id" != "null" && -n "$experiment_id" ]]; then
            success "Experiment created: ${experiment_id}"
            info "Status: requested (processing will begin shortly)"
            info "Use 'resource-experimenter view ${experiment_id}' to check progress"
        else
            error "Failed to create experiment"
        fi
    else
        error "Invalid prompt format. Use: 'Add [resource] to [scenario]' (e.g., 'Add redis to analytics-dashboard')"
    fi
}

cmd_list() {
    local status="$1"
    
    check_api
    
    local endpoint="/api/experiments"
    if [[ -n "$status" ]]; then
        endpoint="${endpoint}?status=${status}"
    fi
    
    local experiments
    experiments=$(api_get "$endpoint")
    
    local count
    count=$(echo "$experiments" | jq '. | length')
    
    if [[ $count -eq 0 ]]; then
        info "No experiments found"
        return
    fi
    
    info "Found ${count} experiments:"
    echo
    
    # Table header
    printf "%-36s %-30s %-20s %-15s %-20s\n" "ID" "NAME" "SCENARIO" "RESOURCE" "STATUS"
    printf "%s\n" "$(printf '‚îÄ%.0s' {1..125})"
    
    # Table rows
    echo "$experiments" | jq -r '.[] | [.id, .name, .target_scenario, .new_resource, .status] | @tsv' | \
    while IFS=$'\t' read -r id name scenario resource status; do
        # Truncate long fields
        name=$(echo "$name" | cut -c1-29)
        scenario=$(echo "$scenario" | cut -c1-19)
        resource=$(echo "$resource" | cut -c1-14)
        
        # Color code status
        case "$status" in
            "completed") status_colored="${GREEN}${status}${NC}" ;;
            "running") status_colored="${YELLOW}${status}${NC}" ;;
            "failed") status_colored="${RED}${status}${NC}" ;;
            *) status_colored="$status" ;;
        esac
        
        printf "%-36s %-30s %-20s %-15s %-20s\n" "$id" "$name" "$scenario" "$resource" "$status_colored"
    done
}

cmd_view() {
    local experiment_id="$1"
    
    if [[ -z "$experiment_id" ]]; then
        error "Please provide an experiment ID"
    fi
    
    check_api
    
    local experiment
    experiment=$(api_get "/api/experiments/${experiment_id}")
    
    if [[ $(echo "$experiment" | jq -r '.id') == "null" ]]; then
        error "Experiment not found: ${experiment_id}"
    fi
    
    # Display experiment details
    echo -e "${BLUE}‚ïê‚ïê‚ïê EXPERIMENT DETAILS ‚ïê‚ïê‚ïê${NC}"
    echo
    echo -e "${WHITE}ID:${NC} $(echo "$experiment" | jq -r '.id')"
    echo -e "${WHITE}Name:${NC} $(echo "$experiment" | jq -r '.name')"
    echo -e "${WHITE}Description:${NC} $(echo "$experiment" | jq -r '.description')"
    echo -e "${WHITE}Target Scenario:${NC} $(echo "$experiment" | jq -r '.target_scenario')"
    echo -e "${WHITE}New Resource:${NC} $(echo "$experiment" | jq -r '.new_resource')"
    echo -e "${WHITE}Status:${NC} $(echo "$experiment" | jq -r '.status')"
    echo -e "${WHITE}Created:${NC} $(echo "$experiment" | jq -r '.created_at' | cut -c1-19)"
    
    local completed_at
    completed_at=$(echo "$experiment" | jq -r '.completed_at')
    if [[ "$completed_at" != "null" ]]; then
        echo -e "${WHITE}Completed:${NC} $(echo "$completed_at" | cut -c1-19)"
    fi
    
    # Show Claude prompt if available
    local claude_prompt
    claude_prompt=$(echo "$experiment" | jq -r '.claude_prompt')
    if [[ "$claude_prompt" != "null" && -n "$claude_prompt" ]]; then
        echo
        echo -e "${BLUE}‚ïê‚ïê‚ïê CLAUDE PROMPT ‚ïê‚ïê‚ïê${NC}"
        echo "$claude_prompt" | head -10
        if [[ $(echo "$claude_prompt" | wc -l) -gt 10 ]]; then
            echo "... (truncated, full prompt available via API)"
        fi
    fi
    
    # Show Claude response if available
    local claude_response
    claude_response=$(echo "$experiment" | jq -r '.claude_response')
    if [[ "$claude_response" != "null" && -n "$claude_response" ]]; then
        echo
        echo -e "${BLUE}‚ïê‚ïê‚ïê CLAUDE RESPONSE ‚ïê‚ïê‚ïê${NC}"
        echo "$claude_response" | head -15
        if [[ $(echo "$claude_response" | wc -l) -gt 15 ]]; then
            echo "... (truncated, full response available via API)"
        fi
    fi
    
    # Show error if failed
    local error_msg
    error_msg=$(echo "$experiment" | jq -r '.generation_error')
    if [[ "$error_msg" != "null" && -n "$error_msg" ]]; then
        echo
        echo -e "${RED}‚ïê‚ïê‚ïê ERROR ‚ïê‚ïê‚ïê${NC}"
        echo "$error_msg"
    fi
}

cmd_delete() {
    local experiment_id="$1"
    
    if [[ -z "$experiment_id" ]]; then
        error "Please provide an experiment ID"
    fi
    
    check_api
    
    # Confirm deletion
    echo -e "${YELLOW}Are you sure you want to delete experiment ${experiment_id}? [y/N]${NC}"
    read -r confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        info "Deletion cancelled"
        return
    fi
    
    api_delete "/api/experiments/${experiment_id}"
    success "Experiment deleted: ${experiment_id}"
}

cmd_scenarios() {
    check_api
    
    local scenarios
    scenarios=$(api_get "/api/scenarios")
    
    local count
    count=$(echo "$scenarios" | jq '. | length')
    
    if [[ $count -eq 0 ]]; then
        info "No scenarios available for experimentation"
        return
    fi
    
    info "Available scenarios for experimentation:"
    echo
    
    # Table header
    printf "%-25s %-40s %-15s %-20s\n" "NAME" "DESCRIPTION" "COMPLEXITY" "RESOURCES"
    printf "%s\n" "$(printf '‚îÄ%.0s' {1..102})"
    
    # Table rows
    echo "$scenarios" | jq -r '.[] | [.name, .description // "", .complexity_level, (.current_resources | join(","))] | @tsv' | \
    while IFS=$'\t' read -r name description complexity resources; do
        # Truncate long fields
        description=$(echo "$description" | cut -c1-39)
        resources=$(echo "$resources" | cut -c1-19)
        
        printf "%-25s %-40s %-15s %-20s\n" "$name" "$description" "$complexity" "$resources"
    done
}

cmd_templates() {
    check_api
    
    local templates
    templates=$(api_get "/api/templates")
    
    local count
    count=$(echo "$templates" | jq '. | length')
    
    if [[ $count -eq 0 ]]; then
        info "No experiment templates found"
        return
    fi
    
    info "Available experiment templates:"
    echo
    
    # Table header  
    printf "%-25s %-50s %-15s %-10s\n" "NAME" "DESCRIPTION" "CATEGORY" "USAGE"
    printf "%s\n" "$(printf '‚îÄ%.0s' {1..102})"
    
    # Table rows
    echo "$templates" | jq -r '.[] | [.name, .description, .resource_category // "", .usage_count] | @tsv' | \
    while IFS=$'\t' read -r name description category usage; do
        # Truncate long fields
        description=$(echo "$description" | cut -c1-49)
        
        printf "%-25s %-50s %-15s %-10s\n" "$name" "$description" "$category" "$usage"
    done
}

# Help text
show_help() {
    cat << EOF
${CYAN}Resource Experimenter CLI v${VERSION}${NC}

Ultra-simple resource experimentation using Claude Code to copy and modify scenarios.

${WHITE}USAGE:${NC}
    ${CLI_NAME} <command> [options]

${WHITE}COMMANDS:${NC}
    ${YELLOW}status${NC}                     Check API status and experiment counts
    ${YELLOW}start <description>${NC}        Start new experiment (e.g., 'Add redis to analytics-dashboard')
    ${YELLOW}list [status]${NC}              List experiments (optionally filter by status)
    ${YELLOW}view <id>${NC}                  Show detailed experiment information
    ${YELLOW}delete <id>${NC}                Delete an experiment
    ${YELLOW}scenarios${NC}                  List available scenarios for experimentation
    ${YELLOW}templates${NC}                  List available experiment templates
    ${YELLOW}help${NC}                       Show this help message

${WHITE}EXAMPLES:${NC}
    ${CLI_NAME} start "Add redis to analytics-dashboard"
    ${CLI_NAME} start "Add qdrant to document-manager" 
    ${CLI_NAME} list running
    ${CLI_NAME} view 550e8400-e29b-41d4-a716-446655440000
    ${CLI_NAME} scenarios

${WHITE}ENVIRONMENT:${NC}
    RESOURCE_EXPERIMENTER_API_URL    API base URL (default: http://localhost:8092)

${WHITE}STATUS VALUES:${NC}
    requested, running, completed, failed

EOF
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    
    case "$command" in
        "status")
            show_banner
            cmd_status
            ;;
        "start")
            check_api
            cmd_start "${2:-}"
            ;;
        "list")
            cmd_list "${2:-}"
            ;;
        "view")
            cmd_view "${2:-}"
            ;;
        "delete")
            cmd_delete "${2:-}"
            ;;
        "scenarios")
            cmd_scenarios
            ;;
        "templates")
            cmd_templates
            ;;
        "help"|"-h"|"--help")
            show_banner
            show_help
            ;;
        *)
            show_banner
            error "Unknown command: $command. Use 'help' for usage information."
            ;;
    esac
}

# Check dependencies
if ! command -v curl >/dev/null 2>&1; then
    error "curl is required but not installed"
fi

if ! command -v jq >/dev/null 2>&1; then
    error "jq is required but not installed"
fi

# Run main function
main "$@"