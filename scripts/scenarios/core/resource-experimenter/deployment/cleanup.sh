#!/usr/bin/env bash
# Resource Experimenter - Cleanup Script
# Auto-generated by Resource Experimenter

set -euo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCENARIO_DIR="$(dirname "${SCRIPT_DIR}")"

# Source required utilities
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/../../../lib/utils/var.sh"
# shellcheck disable=SC1091
source "${var_LIB_SYSTEM_DIR}/trash.sh"

# Logging functions
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $*"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" >&2
}

log_warn() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARN: $*"
}

# Cleanup failed experiments
cleanup_failed_experiments() {
    log_info "Cleaning up failed experiments..."
    
    # Remove containers from failed experiments (older than 24 hours)
    local failed_containers
    failed_containers=$(docker ps -a --filter "label=experiment=true" --filter "status=exited" --format "{{.Names}}" | head -20)
    
    if [[ -n "${failed_containers}" ]]; then
        log_info "Removing failed experiment containers:"
        echo "${failed_containers}" | while read -r container; do
            log_info "  - Removing: ${container}"
            docker rm "${container}" 2>/dev/null || log_warn "Failed to remove ${container}"
        done
    else
        log_info "No failed experiment containers found"
    fi
    
    # Clean up experiment sandbox directories
    local sandbox_base="${HOME}/.vrooli/sandbox"
    if [[ -d "${sandbox_base}" ]]; then
        log_info "Cleaning up old sandbox directories..."
        find "${sandbox_base}" -name "experiment-*" -type d -mtime +1 -print0 | while IFS= read -r -d '' experiment_dir; do
            trash::safe_remove "$experiment_dir" --no-confirm 2>/dev/null || true
        done
    fi
    
    log_info "âœ… Failed experiments cleanup completed"
}

# Cleanup old test results
cleanup_test_results() {
    log_info "Cleaning up old test results..."
    
    # Clean up test files older than 7 days
    local test_dirs=(
        "${HOME}/.vrooli/data/test-results"
        "${HOME}/.vrooli/logs/tests"
        "/tmp/test-${USER:-user}-*"
    )
    
    for pattern in "${test_dirs[@]}"; do
        if compgen -G "${pattern}" >/dev/null 2>&1; then
            find ${pattern} -mtime +7 -delete 2>/dev/null || true
        fi
    done
    
    log_info "âœ… Test results cleanup completed"
}

# Cleanup Docker resources
cleanup_docker_resources() {
    log_info "Cleaning up Docker resources..."
    
    # Remove unused images from experiments
    docker image prune -f --filter "label=experiment=true" 2>/dev/null || log_warn "Failed to prune experiment images"
    
    # Remove unused volumes
    docker volume prune -f 2>/dev/null || log_warn "Failed to prune volumes"
    
    # Remove unused networks (but preserve vrooli-network)
    docker network prune -f --filter "name!=vrooli-network" 2>/dev/null || log_warn "Failed to prune networks"
    
    log_info "âœ… Docker cleanup completed"
}

# Cleanup logs
cleanup_logs() {
    log_info "Cleaning up old logs..."
    
    local log_dirs=(
        "${HOME}/.vrooli/logs"
        "${SCENARIO_DIR}/logs"
    )
    
    for log_dir in "${log_dirs[@]}"; do
        if [[ -d "${log_dir}" ]]; then
            # Keep logs for 30 days
            find "${log_dir}" -name "*.log" -mtime +30 -delete 2>/dev/null || true
            find "${log_dir}" -name "*.log.*" -mtime +7 -delete 2>/dev/null || true
        fi
    done
    
    # Clean up journal logs if they exist
    if command -v journalctl >/dev/null 2>&1; then
        journalctl --vacuum-time=7d 2>/dev/null || true
    fi
    
    log_info "âœ… Log cleanup completed"
}

# Cleanup database old records
cleanup_database() {
    log_info "Cleaning up database old records..."
    
    # Check if PostgreSQL is running
    if ! docker ps --format "{{.Names}}" | grep -q "vrooli-postgres"; then
        log_warn "PostgreSQL is not running, skipping database cleanup"
        return 0
    fi
    
    # Clean up old experiment records (older than 90 days)
    local cleanup_sql="
    -- Delete old failed experiments
    DELETE FROM experiments 
    WHERE status = 'failed' AND completed_at < NOW() - INTERVAL '90 days';
    
    -- Delete old abandoned experiments
    DELETE FROM experiments 
    WHERE status = 'abandoned' AND updated_at < NOW() - INTERVAL '30 days';
    
    -- Delete orphaned test results
    DELETE FROM experiment_tests 
    WHERE executed_at < NOW() - INTERVAL '30 days' 
    AND experiment_id NOT IN (SELECT id FROM experiments);
    
    -- Delete old discovery queue processed items
    DELETE FROM discovery_queue 
    WHERE processed = true AND processed_at < NOW() - INTERVAL '30 days';
    
    -- Delete old sandbox records
    DELETE FROM sandboxes 
    WHERE active = false AND destroyed_at < NOW() - INTERVAL '7 days';
    
    -- Update statistics
    VACUUM ANALYZE experiments, experiment_tests, discovery_queue, sandboxes;
    "
    
    if docker exec vrooli-postgres psql -U postgres -d resource_experiments -c "${cleanup_sql}" >/dev/null 2>&1; then
        log_info "âœ… Database cleanup completed"
    else
        log_warn "Database cleanup failed or skipped"
    fi
}

# Cleanup temp files
cleanup_temp_files() {
    log_info "Cleaning up temporary files..."
    
    # Clean up system temp files related to experiments
    find /tmp -name "*experiment*" -user "${USER}" -mtime +1 -delete 2>/dev/null || true
    find /tmp -name "*resource-test*" -user "${USER}" -mtime +1 -delete 2>/dev/null || true
    find /tmp -name "*bats-*" -user "${USER}" -mtime +1 -delete 2>/dev/null || true
    
    # Clean up our own temp directories
    local temp_dirs=(
        "${HOME}/.vrooli/temp"
        "${SCENARIO_DIR}/temp"
        "${SCENARIO_DIR}/generated-apps/temp"
    )
    
    for temp_dir in "${temp_dirs[@]}"; do
        if [[ -d "${temp_dir}" ]]; then
            find "${temp_dir}" -mtime +1 -delete 2>/dev/null || true
        fi
    done
    
    log_info "âœ… Temporary files cleanup completed"
}

# Optimize storage
optimize_storage() {
    log_info "Optimizing storage..."
    
    # Optimize MinIO (if running)
    if docker ps --format "{{.Names}}" | grep -q "vrooli-minio"; then
        # Clean up incomplete uploads
        docker exec vrooli-minio sh -c "find /data -name '.minio.sys/multipart' -type d -print0 | while IFS= read -r -d '' dir; do rm -rf \"\$dir\"; done 2>/dev/null || true" || true
    fi
    
    # Optimize Qdrant (if running)
    if docker ps --format "{{.Names}}" | grep -q "vrooli-qdrant"; then
        # Trigger optimization via API
        curl -s -X POST "http://localhost:6333/collections/resources/index" >/dev/null 2>&1 || true
        curl -s -X POST "http://localhost:6333/collections/test-results/index" >/dev/null 2>&1 || true
    fi
    
    log_info "âœ… Storage optimization completed"
}

# Generate cleanup report
generate_report() {
    local report_file="${SCENARIO_DIR}/cleanup-report-$(date +%Y%m%d-%H%M%S).txt"
    
    cat > "${report_file}" << EOF
Resource Experimenter Cleanup Report
=====================================
Generated: $(date)
Hostname: $(hostname)
User: $(whoami)

Docker Resources:
- Containers: $(docker ps -a | wc -l) total
- Images: $(docker images | wc -l) total
- Volumes: $(docker volume ls | wc -l) total
- Networks: $(docker network ls | wc -l) total

Disk Usage:
- Home directory: $(du -sh "${HOME}" 2>/dev/null | cut -f1)
- Vrooli data: $(du -sh "${HOME}/.vrooli" 2>/dev/null | cut -f1 || echo "N/A")
- Docker space: $(docker system df --format "table {{.Type}}\t{{.Size}}" 2>/dev/null || echo "N/A")

Database Statistics:
$(docker exec vrooli-postgres psql -U postgres -d resource_experiments -c "
SELECT 'Experiments' as table_name, COUNT(*) as count FROM experiments
UNION ALL
SELECT 'Test Results', COUNT(*) FROM experiment_tests
UNION ALL
SELECT 'Discovery Queue', COUNT(*) FROM discovery_queue
UNION ALL
SELECT 'Sandboxes', COUNT(*) FROM sandboxes;
" 2>/dev/null || echo "Database not available")

Cleanup Actions Performed:
- Failed experiments cleanup
- Old test results removal
- Docker resource pruning
- Log file rotation
- Database record cleanup
- Temporary file cleanup
- Storage optimization

EOF
    
    log_info "âœ… Cleanup report generated: ${report_file}"
}

# Show cleanup statistics
show_statistics() {
    log_info "Cleanup Statistics:"
    log_info "==================="
    
    # Docker statistics
    log_info "Docker Resources:"
    docker system df 2>/dev/null | tail -n +2 | while IFS= read -r line; do
        log_info "  ${line}"
    done || log_warn "Could not get Docker statistics"
    
    # Disk usage
    log_info ""
    log_info "Disk Usage:"
    log_info "  Vrooli data: $(du -sh "${HOME}/.vrooli" 2>/dev/null | cut -f1 || echo "N/A")"
    log_info "  Scenario data: $(du -sh "${SCENARIO_DIR}" 2>/dev/null | cut -f1 || echo "N/A")"
    
    # Database records (if available)
    if docker ps --format "{{.Names}}" | grep -q "vrooli-postgres"; then
        log_info ""
        log_info "Database Records:"
        docker exec vrooli-postgres psql -U postgres -d resource_experiments -t -c "
        SELECT '  Experiments: ' || COUNT(*) FROM experiments
        UNION ALL
        SELECT '  Test Results: ' || COUNT(*) FROM experiment_tests
        UNION ALL
        SELECT '  Discovery Queue: ' || COUNT(*) FROM discovery_queue;
        " 2>/dev/null | grep -v "^$" || log_warn "Could not get database statistics"
    fi
}

# Main cleanup function
main() {
    local cleanup_type="${1:-all}"
    
    log_info "ðŸ§¹ Resource Experimenter Cleanup"
    log_info "=================================="
    
    case "${cleanup_type}" in
        "all")
            cleanup_failed_experiments
            cleanup_test_results
            cleanup_docker_resources
            cleanup_logs
            cleanup_database
            cleanup_temp_files
            optimize_storage
            ;;
        "experiments")
            cleanup_failed_experiments
            ;;
        "docker")
            cleanup_docker_resources
            ;;
        "logs")
            cleanup_logs
            ;;
        "database")
            cleanup_database
            ;;
        "temp")
            cleanup_temp_files
            ;;
        "report")
            generate_report
            show_statistics
            return 0
            ;;
        "stats")
            show_statistics
            return 0
            ;;
        *)
            echo "Usage: $0 {all|experiments|docker|logs|database|temp|report|stats}"
            echo ""
            echo "  all         - Run all cleanup operations (default)"
            echo "  experiments - Clean up failed experiments only"
            echo "  docker      - Clean up Docker resources only"
            echo "  logs        - Clean up log files only"
            echo "  database    - Clean up database records only"
            echo "  temp        - Clean up temporary files only"
            echo "  report      - Generate cleanup report"
            echo "  stats       - Show current statistics"
            exit 1
            ;;
    esac
    
    generate_report
    show_statistics
    
    log_info ""
    log_info "âœ… Cleanup completed successfully!"
}

# Run main function
main "$@"