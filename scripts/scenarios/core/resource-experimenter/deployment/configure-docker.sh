#!/usr/bin/env bash
# Resource Experimenter - Docker Configuration
# Auto-generated by Resource Experimenter

set -euo pipefail

# Logging functions
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $*"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" >&2
}

log_warn() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] WARN: $*"
}

# Check if user needs to be added to docker group
check_docker_permissions() {
    log_info "Checking Docker permissions..."
    
    if [[ $EUID -eq 0 ]]; then
        log_info "Running as root - Docker permissions OK"
        return 0
    fi
    
    if groups "${USER}" | grep -q docker; then
        log_info "User is in docker group - Docker permissions OK"
        return 0
    fi
    
    if docker ps >/dev/null 2>&1; then
        log_info "Docker access works without docker group membership"
        return 0
    fi
    
    log_warn "User ${USER} is not in the docker group and cannot access Docker"
    return 1
}

# Add user to docker group
add_user_to_docker_group() {
    log_info "Adding user ${USER} to docker group..."
    
    if [[ $EUID -ne 0 ]]; then
        log_error "Need root privileges to add user to docker group"
        log_info "Please run: sudo usermod -aG docker ${USER}"
        log_info "Then log out and log back in, or run: newgrp docker"
        return 1
    fi
    
    if usermod -aG docker "${USER}"; then
        log_info "‚úÖ User ${USER} added to docker group"
        log_info "Please log out and log back in, or run: newgrp docker"
        return 0
    else
        log_error "‚ùå Failed to add user to docker group"
        return 1
    fi
}

# Configure Docker daemon settings
configure_docker_daemon() {
    log_info "Configuring Docker daemon settings..."
    
    local docker_config="/etc/docker/daemon.json"
    local backup_config="${docker_config}.backup.$(date +%Y%m%d-%H%M%S)"
    
    # Check if we need root privileges
    if [[ ! -w "/etc/docker" ]] && [[ $EUID -ne 0 ]]; then
        log_warn "Need root privileges to configure Docker daemon"
        return 0
    fi
    
    # Create Docker config directory if it doesn't exist
    mkdir -p /etc/docker
    
    # Backup existing config
    if [[ -f "${docker_config}" ]]; then
        cp "${docker_config}" "${backup_config}"
        log_info "Backed up existing config to: ${backup_config}"
    fi
    
    # Create optimized Docker daemon configuration
    cat > "${docker_config}" << EOF
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "experimental": false,
  "live-restore": true,
  "userland-proxy": false,
  "no-new-privileges": true,
  "seccomp-profile": "/etc/docker/seccomp.json",
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 64000,
      "Soft": 64000
    }
  },
  "max-concurrent-downloads": 3,
  "max-concurrent-uploads": 5,
  "default-address-pools": [
    {
      "base": "172.17.0.0/12",
      "size": 20
    },
    {
      "base": "192.168.0.0/16", 
      "size": 24
    }
  ]
}
EOF
    
    log_info "‚úÖ Docker daemon configuration updated"
    return 0
}

# Set up Docker resource limits
setup_resource_limits() {
    log_info "Setting up Docker resource limits..."
    
    # Create systemd drop-in directory
    local systemd_dir="/etc/systemd/system/docker.service.d"
    if [[ $EUID -eq 0 ]]; then
        mkdir -p "${systemd_dir}"
        
        # Create resource limits override
        cat > "${systemd_dir}/override.conf" << EOF
[Service]
# Resource limits for Docker daemon
LimitNOFILE=1048576
LimitNPROC=1048576
LimitCORE=infinity
TasksMax=infinity

# Security settings
NoNewPrivileges=false
ProtectSystem=false
ProtectHome=false

# Memory accounting
MemoryAccounting=yes
TasksAccounting=yes
EOF
        
        log_info "‚úÖ Docker service resource limits configured"
    else
        log_warn "Skipping systemd configuration (need root privileges)"
    fi
    
    return 0
}

# Configure Docker network settings
configure_docker_networks() {
    log_info "Configuring Docker networks..."
    
    # Remove default bridge network restrictions that might interfere
    # This helps with container-to-container communication
    if command -v iptables >/dev/null 2>&1; then
        # Allow Docker containers to communicate
        iptables -I FORWARD -i docker0 -o docker0 -j ACCEPT 2>/dev/null || true
    fi
    
    # Ensure Docker can create custom networks
    if sysctl net.ipv4.ip_forward 2>/dev/null | grep -q "= 0"; then
        if [[ $EUID -eq 0 ]]; then
            sysctl -w net.ipv4.ip_forward=1
            echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
            log_info "‚úÖ IP forwarding enabled"
        else
            log_warn "IP forwarding is disabled - may need: sudo sysctl -w net.ipv4.ip_forward=1"
        fi
    fi
    
    return 0
}

# Optimize Docker for experiments
optimize_docker_for_experiments() {
    log_info "Optimizing Docker for resource experiments..."
    
    # Set up Docker BuildKit for better image building
    export DOCKER_BUILDKIT=1
    export COMPOSE_DOCKER_CLI_BUILD=1
    
    # Configure Docker CLI to use BuildKit by default
    local docker_cli_config="${HOME}/.docker/config.json"
    mkdir -p "${HOME}/.docker"
    
    if [[ ! -f "${docker_cli_config}" ]]; then
        cat > "${docker_cli_config}" << EOF
{
  "experimental": "enabled",
  "features": {
    "buildkit": true
  }
}
EOF
    else
        # Update existing config to enable BuildKit
        jq '.features.buildkit = true' "${docker_cli_config}" > "${docker_cli_config}.tmp" && mv "${docker_cli_config}.tmp" "${docker_cli_config}" 2>/dev/null || true
    fi
    
    log_info "‚úÖ Docker optimized for experiments"
    return 0
}

# Clean up Docker before configuration
cleanup_docker() {
    log_info "Cleaning up Docker before configuration..."
    
    # Stop existing Resource Experimenter containers
    local containers=(
        "vrooli-postgres"
        "vrooli-redis"
        "vrooli-minio"
        "vrooli-qdrant"
        "vrooli-ollama"
        "vrooli-n8n"
        "vrooli-windmill"
    )
    
    for container in "${containers[@]}"; do
        if docker ps -a --format "{{.Names}}" | grep -q "^${container}$"; then
            log_info "Stopping and removing existing container: ${container}"
            docker stop "${container}" 2>/dev/null || true
            docker rm "${container}" 2>/dev/null || true
        fi
    done
    
    # Clean up unused resources
    docker system prune -f --volumes 2>/dev/null || true
    
    log_info "‚úÖ Docker cleanup completed"
    return 0
}

# Restart Docker daemon
restart_docker_daemon() {
    log_info "Restarting Docker daemon..."
    
    if [[ $EUID -ne 0 ]]; then
        log_warn "Need root privileges to restart Docker daemon"
        log_info "Please run: sudo systemctl restart docker"
        return 0
    fi
    
    if systemctl is-active --quiet docker; then
        systemctl restart docker
        
        # Wait for Docker to be ready
        local count=0
        while [[ ${count} -lt 30 ]]; do
            if docker info >/dev/null 2>&1; then
                log_info "‚úÖ Docker daemon restarted successfully"
                return 0
            fi
            sleep 2
            count=$((count + 1))
        done
        
        log_error "‚ùå Docker daemon failed to restart properly"
        return 1
    else
        log_warn "Docker is not running - cannot restart"
        return 1
    fi
}

# Verify Docker configuration
verify_docker_configuration() {
    log_info "Verifying Docker configuration..."
    
    # Check Docker version
    local docker_version
    docker_version=$(docker --version | cut -d' ' -f3 | cut -d',' -f1)
    log_info "Docker version: ${docker_version}"
    
    # Check if Docker daemon is running
    if ! docker info >/dev/null 2>&1; then
        log_error "‚ùå Docker daemon is not running"
        return 1
    fi
    
    # Check Docker system info
    local total_memory
    total_memory=$(docker system info --format "{{.MemTotal}}" 2>/dev/null || echo "unknown")
    log_info "Available memory: ${total_memory}"
    
    # Test basic Docker operations
    if docker run --rm hello-world >/dev/null 2>&1; then
        log_info "‚úÖ Docker basic operations working"
    else
        log_error "‚ùå Docker basic operations failed"
        return 1
    fi
    
    # Check if we can create networks
    local test_network="test-network-$$"
    if docker network create "${test_network}" >/dev/null 2>&1; then
        docker network rm "${test_network}" >/dev/null 2>&1
        log_info "‚úÖ Docker network creation working"
    else
        log_error "‚ùå Cannot create Docker networks"
        return 1
    fi
    
    log_info "‚úÖ Docker configuration verification completed"
    return 0
}

# Show configuration summary
show_configuration_summary() {
    log_info "Docker Configuration Summary:"
    log_info "=============================="
    
    # Docker daemon info
    if docker info >/dev/null 2>&1; then
        log_info "Docker Status: Running"
        log_info "Docker Version: $(docker --version | cut -d' ' -f3 | cut -d',' -f1)"
        
        local storage_driver
        storage_driver=$(docker info --format "{{.Driver}}" 2>/dev/null || echo "unknown")
        log_info "Storage Driver: ${storage_driver}"
        
        local containers_running
        containers_running=$(docker ps --format "{{.Names}}" | wc -l)
        log_info "Running Containers: ${containers_running}"
        
        local images_count
        images_count=$(docker images --format "{{.Repository}}" | wc -l)
        log_info "Images Available: ${images_count}"
    else
        log_info "Docker Status: Not running"
    fi
    
    # User permissions
    if groups "${USER}" | grep -q docker; then
        log_info "Docker Group: ‚úÖ User is in docker group"
    else
        log_info "Docker Group: ‚ö†Ô∏è  User not in docker group"
    fi
    
    # Network forwarding
    if sysctl net.ipv4.ip_forward 2>/dev/null | grep -q "= 1"; then
        log_info "IP Forwarding: ‚úÖ Enabled"
    else
        log_info "IP Forwarding: ‚ö†Ô∏è  Disabled"
    fi
}

# Main configuration function
main() {
    local action="${1:-configure}"
    
    log_info "üê≥ Resource Experimenter - Docker Configuration"
    log_info "==============================================="
    
    case "${action}" in
        "configure")
            check_docker_permissions || add_user_to_docker_group
            configure_docker_daemon
            setup_resource_limits
            configure_docker_networks
            optimize_docker_for_experiments
            verify_docker_configuration
            show_configuration_summary
            ;;
        "cleanup")
            cleanup_docker
            ;;
        "restart")
            restart_docker_daemon
            ;;
        "verify")
            verify_docker_configuration
            ;;
        "summary")
            show_configuration_summary
            ;;
        *)
            echo "Usage: $0 {configure|cleanup|restart|verify|summary}"
            echo ""
            echo "  configure - Full Docker configuration (default)"
            echo "  cleanup   - Clean up existing containers"
            echo "  restart   - Restart Docker daemon"
            echo "  verify    - Verify Docker configuration"
            echo "  summary   - Show configuration summary"
            exit 1
            ;;
    esac
    
    log_info ""
    log_info "‚úÖ Docker configuration completed!"
}

# Run main function
main "$@"