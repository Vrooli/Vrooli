#!/usr/bin/env bash
# Resource Experimenter - Environment Validation
# Auto-generated by Resource Experimenter

set -euo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCENARIO_DIR="$(dirname "${SCRIPT_DIR}")"

# Validation functions
validate_docker() {
    echo "Validating Docker..."
    
    if ! command -v docker >/dev/null 2>&1; then
        echo "‚ùå Docker is not installed"
        return 1
    fi
    
    if ! docker info >/dev/null 2>&1; then
        echo "‚ùå Docker daemon is not running"
        return 1
    fi
    
    echo "‚úÖ Docker is available and running"
    return 0
}

validate_ports() {
    echo "Validating required ports..."
    local required_ports=(5679 8001 8091 9000 6333 5432 6379)
    local errors=0
    
    for port in "${required_ports[@]}"; do
        if netstat -ln 2>/dev/null | grep -q ":${port} " || ss -ln 2>/dev/null | grep -q ":${port} "; then
            echo "‚ö†Ô∏è  Port ${port} is already in use"
            errors=$((errors + 1))
        else
            echo "‚úÖ Port ${port} is available"
        fi
    done
    
    return ${errors}
}

validate_storage() {
    echo "Validating storage requirements..."
    
    # Check available disk space (require at least 10GB)
    local available_gb
    available_gb=$(df -BG "${HOME}" 2>/dev/null | awk 'NR==2 {print $4}' | sed 's/G//' || echo "0")
    
    if [[ ${available_gb} -lt 10 ]]; then
        echo "‚ùå Insufficient disk space. Need at least 10GB, have ${available_gb}GB"
        return 1
    fi
    
    echo "‚úÖ Sufficient disk space available (${available_gb}GB)"
    return 0
}

validate_memory() {
    echo "Validating memory requirements..."
    
    if ! command -v free >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Cannot check memory, assuming sufficient"
        return 0
    fi
    
    local available_mb
    available_mb=$(free -m | awk '/^Mem:/ {print $7}' || echo "0")
    
    # Require at least 4GB available memory
    if [[ ${available_mb} -lt 4096 ]]; then
        echo "‚ùå Insufficient memory. Need at least 4GB available, have ${available_mb}MB"
        return 1
    fi
    
    echo "‚úÖ Sufficient memory available (${available_mb}MB)"
    return 0
}

validate_network() {
    echo "Validating network connectivity..."
    
    # Test internet connectivity
    if ! curl -s --max-time 10 https://google.com >/dev/null 2>&1; then
        echo "‚ùå No internet connectivity"
        return 1
    fi
    
    # Test Docker Hub connectivity
    if ! curl -s --max-time 10 https://hub.docker.com >/dev/null 2>&1; then
        echo "‚ùå Cannot reach Docker Hub"
        return 1
    fi
    
    echo "‚úÖ Network connectivity is working"
    return 0
}

validate_permissions() {
    echo "Validating file permissions..."
    
    # Check if we can create directories in HOME
    local test_dir="${HOME}/.vrooli/test-$$"
    if ! mkdir -p "${test_dir}" 2>/dev/null; then
        echo "‚ùå Cannot create directories in HOME"
        return 1
    fi
    rm -rf "${test_dir}"
    
    # Check Docker socket access
    if [[ -S "/var/run/docker.sock" ]] && [[ ! -w "/var/run/docker.sock" ]]; then
        echo "‚ö†Ô∏è  No write access to Docker socket - may need to add user to docker group"
    fi
    
    echo "‚úÖ File permissions are adequate"
    return 0
}

validate_dependencies() {
    echo "Validating required dependencies..."
    local required_commands=(curl jq bash)
    local missing_commands=()
    
    for cmd in "${required_commands[@]}"; do
        if ! command -v "${cmd}" >/dev/null 2>&1; then
            missing_commands+=("${cmd}")
        fi
    done
    
    if [[ ${#missing_commands[@]} -gt 0 ]]; then
        echo "‚ùå Missing required commands: ${missing_commands[*]}"
        return 1
    fi
    
    echo "‚úÖ All required dependencies are available"
    return 0
}

validate_configuration() {
    echo "Validating scenario configuration..."
    
    # Check service.json exists and is valid
    local service_json="${SCENARIO_DIR}/.vrooli/service.json"
    if [[ ! -f "${service_json}" ]]; then
        echo "‚ùå Missing service.json configuration"
        return 1
    fi
    
    if ! jq empty "${service_json}" 2>/dev/null; then
        echo "‚ùå Invalid JSON in service.json"
        return 1
    fi
    
    # Check required directories exist
    local required_dirs=(
        "${SCENARIO_DIR}/initialization/automation/n8n"
        "${SCENARIO_DIR}/initialization/automation/windmill"
        "${SCENARIO_DIR}/initialization/configuration"
        "${SCENARIO_DIR}/initialization/storage/postgres"
        "${SCENARIO_DIR}/initialization/templates"
    )
    
    for dir in "${required_dirs[@]}"; do
        if [[ ! -d "${dir}" ]]; then
            echo "‚ùå Missing required directory: ${dir}"
            return 1
        fi
    done
    
    echo "‚úÖ Scenario configuration is valid"
    return 0
}

# Main validation function
main() {
    echo "üîç Resource Experimenter - Environment Validation"
    echo "=============================================="
    echo ""
    
    local errors=0
    local warnings=0
    
    # Run all validations
    validate_docker || errors=$((errors + 1))
    echo ""
    
    validate_dependencies || errors=$((errors + 1))
    echo ""
    
    validate_configuration || errors=$((errors + 1))
    echo ""
    
    validate_storage || errors=$((errors + 1))
    echo ""
    
    validate_memory || errors=$((errors + 1))
    echo ""
    
    validate_network || errors=$((errors + 1))
    echo ""
    
    validate_permissions || warnings=$((warnings + 1))
    echo ""
    
    # Port validation is warning-only since services may not be running yet
    if ! validate_ports; then
        warnings=$((warnings + 1))
    fi
    echo ""
    
    # Summary
    echo "=============================================="
    echo "Validation Summary:"
    
    if [[ ${errors} -eq 0 ]]; then
        echo "‚úÖ All critical validations passed"
        if [[ ${warnings} -gt 0 ]]; then
            echo "‚ö†Ô∏è  ${warnings} warning(s) found"
        fi
        echo ""
        echo "Environment is ready for Resource Experimenter deployment!"
        exit 0
    else
        echo "‚ùå ${errors} critical issue(s) found"
        if [[ ${warnings} -gt 0 ]]; then
            echo "‚ö†Ô∏è  ${warnings} warning(s) found"
        fi
        echo ""
        echo "Please resolve the issues above before proceeding."
        exit 1
    fi
}

# Show help information
show_help() {
    cat << EOF
Resource Experimenter - Environment Validation

This script validates that your environment meets the requirements for
running the Resource Experimenter scenario.

USAGE:
    $(basename "$0") [options]

OPTIONS:
    --help, -h          Show this help message
    --verbose, -v       Enable verbose output
    --quick             Skip network connectivity tests

CHECKS PERFORMED:
    - Docker installation and daemon status
    - Required command availability
    - Scenario configuration validity
    - Storage space requirements
    - Memory requirements
    - Network connectivity
    - File system permissions
    - Port availability

EXIT CODES:
    0    All validations passed
    1    Critical issues found
EOF
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --verbose|-v)
            set -x
            shift
            ;;
        --quick)
            QUICK_MODE=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Run main function
main