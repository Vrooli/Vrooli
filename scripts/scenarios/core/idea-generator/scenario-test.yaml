name: idea-generator
description: Test suite for AI-powered idea generation application
version: 1.0.0

prerequisites:
  resources:
    - postgres
    - redis
    - ollama
    - n8n
    - qdrant
    - minio
    - windmill
    - unstructured-io
  environment:
    POSTGRES_PASSWORD: postgres
    POSTGRES_DB: idea_generator
    POSTGRES_USER: postgres

tests:
  - name: resource_availability
    description: Verify all required resources are running
    steps:
      - check: postgres_connection
        command: pg_isready -h localhost -p ${RESOURCE_PORTS[postgres]:-5432}
        expected: accepting connections
      - check: redis_connection
        command: redis-cli -p ${RESOURCE_PORTS[redis]:-6379} ping
        expected: PONG
      - check: ollama_api
        command: curl -f http://localhost:${RESOURCE_PORTS[ollama]:-11434}/api/version
        expected_status: 200
      - check: n8n_health
        command: curl -f http://localhost:${RESOURCE_PORTS[n8n]:-5678}/healthz
        expected_status: 200
      - check: qdrant_health
        command: curl -f http://localhost:${RESOURCE_PORTS[qdrant]:-6333}/health
        expected_status: 200
      - check: minio_health
        command: curl -f http://localhost:${RESOURCE_PORTS[minio]:-9000}/minio/health/live
        expected_status: 200
      - check: windmill_health
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]:-5681}/api/version
        expected_status: 200
      - check: unstructured_health
        command: curl -f http://localhost:${RESOURCE_PORTS[unstructured-io]:-11450}/healthcheck
        expected_status: 200

  - name: database_initialization
    description: Verify database schema is properly initialized
    steps:
      - check: tables_exist
        query: |
          SELECT COUNT(*) FROM information_schema.tables 
          WHERE table_schema = 'public' 
          AND table_name IN ('campaigns', 'ideas', 'agent_interactions', 'data_connections')
        expected: 4
      - check: indexes_created
        query: |
          SELECT COUNT(*) FROM pg_indexes 
          WHERE schemaname = 'public' 
          AND tablename IN ('campaigns', 'ideas')
        min_expected: 4

  - name: workflow_deployment
    description: Verify n8n workflows are deployed and active
    steps:
      - check: idea_generation_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]:-5678}/rest/workflows
        contains: idea-generation-workflow
      - check: refinement_workflow
        command: curl -X GET http://localhost:${RESOURCE_PORTS[n8n]:-5678}/rest/workflows
        contains: agent-refinement-workflow

  - name: api_endpoints
    description: Test core API endpoints
    steps:
      - check: api_health
        method: GET
        url: http://localhost:${SERVICE_PORT:-8500}/health
        expected_status: 200
      - check: api_status
        method: GET
        url: http://localhost:${SERVICE_PORT:-8500}/status
        expected_status: 200
      - check: get_campaigns
        method: GET
        url: http://localhost:${SERVICE_PORT:-8500}/campaigns
        expected_status: 200
      - check: get_ideas
        method: GET
        url: http://localhost:${SERVICE_PORT:-8500}/ideas
        expected_status: 200
      - check: get_workflows
        method: GET
        url: http://localhost:${SERVICE_PORT:-8500}/workflows
        expected_status: 200
      - check: create_campaign
        method: POST
        url: http://localhost:${SERVICE_PORT:-8500}/campaigns
        body:
          name: Test Campaign
          description: Test campaign for validation
          color: "#3B82F6"
        expected_status: 201

  - name: ui_availability
    description: Verify Windmill UI is accessible
    steps:
      - check: windmill_ui
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]:-5681}
        expected_status: 200
      - check: windmill_api
        command: curl -f http://localhost:${RESOURCE_PORTS[windmill]:-5681}/api/version
        expected_status: 200

  - name: vector_search
    description: Test vector search functionality
    steps:
      - check: qdrant_collections
        command: curl -f http://localhost:${RESOURCE_PORTS[qdrant]:-6333}/collections
        expected_status: 200
      - check: create_collection
        method: PUT
        url: http://localhost:${RESOURCE_PORTS[qdrant]:-6333}/collections/test_ideas
        body:
          vectors:
            size: 1536
            distance: Cosine
        expected_status: 200

validation:
  timeout: 300
  retry_count: 3
  success_threshold: 0.90