{
  "name": "Chat Refinement Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-message",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook_trigger",
      "name": "Chat Message Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 400]
    },
    {
      "parameters": {
        "functionCode": "// Validate chat message request\nconst data = $json;\n\n// Check required fields\nif (!data.session_id && !data.idea_id) {\n  throw new Error('Either session_id or idea_id is required');\n}\n\nif (!data.message || typeof data.message !== 'string' || data.message.trim().length === 0) {\n  throw new Error('Message text is required');\n}\n\nif (!data.user_id) {\n  throw new Error('User ID is required');\n}\n\n// Set defaults and process request\nconst processedRequest = {\n  session_id: data.session_id || null,\n  idea_id: data.idea_id,\n  user_id: data.user_id,\n  message: data.message.trim(),\n  agent_type: data.agent_type || 'auto', // auto, revise, investigate, critique, expand, synthesize, validate\n  include_context: data.include_context !== false,\n  include_documents: data.include_documents !== false,\n  streaming: data.streaming || false,\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: processedRequest }];"
      },
      "id": "validate_request",
      "name": "Validate Chat Request",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT cs.*, i.title, i.content, i.category, i.campaign_id FROM chat_sessions cs LEFT JOIN ideas i ON cs.idea_id = i.id WHERE {{ $json.session_id ? \"cs.id = '\" + $json.session_id + \"'\" : \"cs.idea_id = '\" + $json.idea_id + \"' AND cs.status = 'active'\" }} ORDER BY cs.created_at DESC LIMIT 1",
        "additionalFields": {}
      },
      "id": "get_session",
      "name": "Get or Create Session",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Create new session if needed\nconst request = $node['Validate Chat Request'].json;\nconst existingSession = $node['Get or Create Session'].json;\n\nif (existingSession && existingSession.id) {\n  return [{ json: existingSession }];\n}\n\n// Need to create new session\nreturn [{\n  json: {\n    create_new: true,\n    idea_id: request.idea_id,\n    user_id: request.user_id,\n    session_type: 'refinement',\n    status: 'active'\n  }\n}];"
      },
      "id": "check_session",
      "name": "Check Session Exists",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "chat_sessions",
        "columns": "idea_id,user_id,session_type,status",
        "returnFields": "*",
        "continueOnFail": true
      },
      "id": "create_session",
      "name": "Create New Session",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT sender_type, sender_name, message_text, created_at FROM chat_messages WHERE session_id = '{{ $json.id || $json.session_id }}' ORDER BY created_at DESC LIMIT 10",
        "additionalFields": {}
      },
      "id": "get_chat_history",
      "name": "Get Chat History",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT c.name as campaign_name, c.context, c.settings FROM campaigns c WHERE c.id = '{{ $json.campaign_id }}'",
        "additionalFields": {}
      },
      "id": "get_campaign_context",
      "name": "Get Campaign Context",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1250, 450]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT d.original_name, d.extracted_text FROM documents d WHERE d.campaign_id = '{{ $json.campaign_id }}' AND d.processing_status = 'completed' ORDER BY d.created_at DESC LIMIT 3",
        "additionalFields": {}
      },
      "id": "get_documents",
      "name": "Get Related Documents",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1250, 600]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "chat_messages",
        "columns": "session_id,sender_type,sender_name,message_text,message_type",
        "additionalFields": {
          "values": {
            "session_id": "{{ $node['Check Session Exists'].json.id || $node['Create New Session'].json.id }}",
            "sender_type": "user",
            "sender_name": "{{ $node['Validate Chat Request'].json.user_id }}",
            "message_text": "{{ $node['Validate Chat Request'].json.message }}",
            "message_type": "text"
          }
        },
        "returnFields": "*"
      },
      "id": "save_user_message",
      "name": "Save User Message",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "functionCode": "// Build comprehensive context for AI agent\nconst request = $node['Validate Chat Request'].json;\nconst session = $node['Check Session Exists'].json;\nconst chatHistory = $node['Get Chat History'].json || [];\nconst campaign = $node['Get Campaign Context'].json || {};\nconst documents = $node['Get Related Documents'].json || [];\nconst idea = session;\n\n// Determine agent type\nlet agentType = request.agent_type;\nif (agentType === 'auto') {\n  // Auto-select based on message content\n  const message = request.message.toLowerCase();\n  if (message.includes('improve') || message.includes('better') || message.includes('refine')) {\n    agentType = 'revise';\n  } else if (message.includes('research') || message.includes('feasibility') || message.includes('market')) {\n    agentType = 'investigate';\n  } else if (message.includes('problem') || message.includes('issue') || message.includes('concern')) {\n    agentType = 'critique';\n  } else if (message.includes('more') || message.includes('expand') || message.includes('additional')) {\n    agentType = 'expand';\n  } else if (message.includes('combine') || message.includes('merge') || message.includes('together')) {\n    agentType = 'synthesize';\n  } else if (message.includes('check') || message.includes('validate') || message.includes('compliance')) {\n    agentType = 'validate';\n  } else {\n    agentType = 'revise'; // Default\n  }\n}\n\n// Build chat history context\nconst historyContext = chatHistory.slice(0, 5).reverse().map(msg => \n  `${msg.sender_type === 'user' ? 'User' : 'Agent'}: ${msg.message_text}`\n).join('\\n');\n\n// Build document context\nconst documentContext = documents.map(doc => \n  `Document: ${doc.original_name}\\nRelevant content: ${doc.extracted_text?.substring(0, 500)}...`\n).join('\\n\\n');\n\n// Build comprehensive prompt\nconst agentPrompts = {\n  revise: \"Improve and refine this idea, making it more specific, actionable, and innovative.\",\n  investigate: \"Research the feasibility, market potential, and implementation requirements.\",\n  critique: \"Provide constructive criticism, identify weaknesses and areas for improvement.\",\n  expand: \"Expand with additional features, use cases, and natural extensions.\",\n  synthesize: \"Synthesize and combine the discussed elements into a unified concept.\",\n  validate: \"Validate against best practices, regulations, and technical feasibility.\"\n};\n\nconst prompt = `\nYou are a ${agentType} agent helping to refine an idea.\n\nIdea Context:\nTitle: ${idea.title || 'Untitled Idea'}\nContent: ${idea.content || 'No content yet'}\nCategory: ${idea.category || 'general'}\n\nCampaign Context:\n${campaign.campaign_name ? `Campaign: ${campaign.campaign_name}\\nContext: ${JSON.stringify(campaign.context)}` : 'No campaign context'}\n\n${documentContext ? `Related Documents:\\n${documentContext}\\n` : ''}\n\n${historyContext ? `Recent Conversation:\\n${historyContext}\\n` : ''}\n\nUser's Current Message: ${request.message}\n\nYour Role: ${agentPrompts[agentType]}\n\nProvide a helpful, specific response that directly addresses the user's message while fulfilling your role as a ${agentType} agent. Be conversational but professional.\n`;\n\nreturn [{\n  json: {\n    prompt: prompt,\n    agent_type: agentType,\n    session_id: session.id || $node['Create New Session'].json.id,\n    idea_id: idea.id || request.idea_id,\n    has_context: !!campaign.campaign_name,\n    has_documents: documents.length > 0,\n    has_history: chatHistory.length > 0\n  }\n}];"
      },
      "id": "build_agent_context",
      "name": "Build Agent Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1650, 400]
    },
    {
      "parameters": {
        "resource": "completion",
        "model": "{{ $json.agent_type === 'investigate' || $json.agent_type === 'validate' ? 'mistral' : 'llama3.2' }}",
        "prompt": "{{ $json.prompt }}",
        "temperature": "{{ $json.agent_type === 'expand' ? 0.8 : $json.agent_type === 'critique' ? 0.5 : 0.7 }}",
        "maxTokens": 1500
      },
      "id": "generate_response",
      "name": "Generate Agent Response",
      "type": "n8n-nodes-base.ollama",
      "typeVersion": 1,
      "position": [1850, 400]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "chat_messages",
        "columns": "session_id,sender_type,sender_name,message_text,message_type,metadata",
        "additionalFields": {
          "values": {
            "session_id": "{{ $node['Build Agent Context'].json.session_id }}",
            "sender_type": "agent",
            "sender_name": "{{ $node['Build Agent Context'].json.agent_type }}",
            "message_text": "{{ $node['Generate Agent Response'].json.response }}",
            "message_type": "text",
            "metadata": "{{ JSON.stringify({agent_type: $node['Build Agent Context'].json.agent_type, model: $node['Generate Agent Response'].json.model, has_context: $node['Build Agent Context'].json.has_context, has_documents: $node['Build Agent Context'].json.has_documents}) }}"
          }
        },
        "returnFields": "*"
      },
      "id": "save_agent_message",
      "name": "Save Agent Message",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2050, 400]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "agent_interactions",
        "columns": "idea_id,session_id,interaction_type,agent_prompt,agent_response,model_used,metadata",
        "additionalFields": {
          "values": {
            "idea_id": "{{ $node['Build Agent Context'].json.idea_id }}",
            "session_id": "{{ $node['Build Agent Context'].json.session_id }}",
            "interaction_type": "{{ $node['Build Agent Context'].json.agent_type }}",
            "agent_prompt": "{{ $node['Validate Chat Request'].json.message }}",
            "agent_response": "{{ $node['Generate Agent Response'].json.response }}",
            "model_used": "{{ $node['Generate Agent Response'].json.model }}",
            "metadata": "{{ JSON.stringify({has_context: $node['Build Agent Context'].json.has_context, has_documents: $node['Build Agent Context'].json.has_documents, has_history: $node['Build Agent Context'].json.has_history}) }}"
          }
        }
      },
      "id": "log_interaction",
      "name": "Log Agent Interaction",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [2250, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "session_id",
              "value": "{{ $node['Build Agent Context'].json.session_id }}"
            },
            {
              "name": "message_id",
              "value": "{{ $node['Save Agent Message'].json.id }}"
            },
            {
              "name": "agent_type",
              "value": "{{ $node['Build Agent Context'].json.agent_type }}"
            },
            {
              "name": "response",
              "value": "{{ $node['Generate Agent Response'].json.response }}"
            },
            {
              "name": "timestamp",
              "value": "{{ new Date().toISOString() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "success_response",
      "name": "Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [2450, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [[{"node": "validate_request", "type": "main", "index": 0}]]
    },
    "validate_request": {
      "main": [[{"node": "get_session", "type": "main", "index": 0}]]
    },
    "get_session": {
      "main": [[{"node": "check_session", "type": "main", "index": 0}]]
    },
    "check_session": {
      "main": [
        [{"node": "create_session", "type": "main", "index": 0}],
        [{"node": "get_chat_history", "type": "main", "index": 0}]
      ]
    },
    "create_session": {
      "main": [[{"node": "get_chat_history", "type": "main", "index": 0}]]
    },
    "get_chat_history": {
      "main": [
        [
          {"node": "get_campaign_context", "type": "main", "index": 0},
          {"node": "get_documents", "type": "main", "index": 0},
          {"node": "save_user_message", "type": "main", "index": 0}
        ]
      ]
    },
    "get_campaign_context": {
      "main": [[{"node": "build_agent_context", "type": "main", "index": 0}]]
    },
    "get_documents": {
      "main": [[{"node": "build_agent_context", "type": "main", "index": 1}]]
    },
    "save_user_message": {
      "main": [[{"node": "build_agent_context", "type": "main", "index": 2}]]
    },
    "build_agent_context": {
      "main": [[{"node": "generate_response", "type": "main", "index": 0}]]
    },
    "generate_response": {
      "main": [[{"node": "save_agent_message", "type": "main", "index": 0}]]
    },
    "save_agent_message": {
      "main": [[{"node": "log_interaction", "type": "main", "index": 0}]]
    },
    "log_interaction": {
      "main": [[{"node": "success_response", "type": "main", "index": 0}]]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "chat-refinement-workflow"
}