{
  "name": "System Monitor - Anomaly Investigator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "anomaly-investigate",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $json }}",
        "options": {}
      },
      "id": "set-defaults",
      "name": "Set Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [450, 400]
    },
    {
      "parameters": {
        "jsCode": "// Extract and process anomaly data\nconst input = $input.all()[0].json;\n\n// Default values for testing\nconst anomalies = input.anomalies || [{\n  type: 'high_cpu',\n  severity: 'warning',\n  description: 'CPU usage exceeded threshold',\n  current_value: 85.2,\n  threshold_value: 80.0,\n  timestamp: new Date().toISOString()\n}];\n\nconst severity = input.severity || 'warning';\nconst context = input.context || 'system_monitoring';\nconst timestamp = input.timestamp || new Date().toISOString();\n\n// Generate investigation ID\nconst investigationId = `inv_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;\n\n// Create summary for AI analysis\nconst anomalySummary = anomalies.map(a => \n  `${a.type}: ${a.description} (current: ${a.current_value}, threshold: ${a.threshold_value})`\n).join('; ');\n\nreturn {\n  investigationId,\n  anomalies,\n  severity,\n  context,\n  timestamp,\n  anomalySummary\n};"
      },
      "id": "process-input",
      "name": "Process Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400]
    },
    {
      "parameters": {
        "command": "psql -h ${service.postgres.host} -p ${service.postgres.port} -U ${service.postgres.user} -d ${service.postgres.database} -t -A -c \"SELECT json_build_object('recent_metrics', (SELECT json_agg(json_build_object('timestamp', timestamp, 'cpu_usage', cpu_usage, 'memory_usage', memory_usage, 'tcp_connections', tcp_connections)) FROM system_health WHERE timestamp >= NOW() - INTERVAL '30 minutes' ORDER BY timestamp DESC LIMIT 20), 'recent_anomalies', (SELECT json_agg(json_build_object('type', type, 'severity', severity, 'description', description, 'created_at', created_at)) FROM anomalies WHERE created_at >= NOW() - INTERVAL '2 hours' ORDER BY created_at DESC LIMIT 10), 'current_thresholds', (SELECT json_agg(json_build_object('metric_name', metric_name, 'warning_threshold', warning_threshold, 'critical_threshold', critical_threshold)) FROM thresholds WHERE enabled = true));\""
      },
      "id": "gather-context",
      "name": "Gather System Context",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "url": "http://localhost:5678/webhook/ollama",
        "method": "POST",
        "sendBody": true,
        "bodyParametersJson": "={{ JSON.stringify({ prompt: `You are an expert system administrator analyzing anomalies. Based on the following data, provide a detailed investigation report:\n\nCurrent Anomalies: ${$json.anomalySummary}\nSeverity: ${$json.severity}\nContext: ${$json.context}\nTimestamp: ${$json.timestamp}\n\nSystem Context: ${JSON.stringify($node['Gather System Context'].json)}\n\nProvide analysis in JSON format:\n{\n  \"root_cause_analysis\": \"detailed analysis of what caused the anomaly\",\n  \"impact_assessment\": \"assessment of current and potential impact\",\n  \"recommended_actions\": [\"list of specific actions to take\"],\n  \"prevention_measures\": [\"list of measures to prevent recurrence\"],\n  \"urgency_level\": \"low|medium|high|critical\",\n  \"investigation_summary\": \"concise summary of findings\"\n}`, model: 'llama3.2:3b', type: 'reasoning', quiet: true }) }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "ai-investigation",
      "name": "AI Investigation Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response and create investigation record\nconst aiResponse = $input.first().json;\nconst processedInput = $node['Process Input'].json;\n\nlet investigation = {};\n\ntry {\n  // Parse the AI response (it might be nested in stdout)\n  let aiAnalysis;\n  if (typeof aiResponse === 'string') {\n    // If it's a string, try to parse JSON\n    aiAnalysis = JSON.parse(aiResponse);\n  } else if (aiResponse.stdout) {\n    // If it's command output, parse the stdout\n    aiAnalysis = JSON.parse(aiResponse.stdout);\n  } else {\n    // If it's already an object, use it directly\n    aiAnalysis = aiResponse;\n  }\n  \n  investigation = {\n    id: processedInput.investigationId,\n    anomalies: processedInput.anomalies,\n    severity: processedInput.severity,\n    context: processedInput.context,\n    timestamp: processedInput.timestamp,\n    ai_analysis: aiAnalysis,\n    status: 'completed',\n    completed_at: new Date().toISOString(),\n    findings: aiAnalysis.investigation_summary || 'Investigation completed with AI analysis',\n    recommended_actions: aiAnalysis.recommended_actions || [],\n    urgency_level: aiAnalysis.urgency_level || processedInput.severity\n  };\n  \n} catch (error) {\n  // Fallback if AI response parsing fails\n  investigation = {\n    id: processedInput.investigationId,\n    anomalies: processedInput.anomalies,\n    severity: processedInput.severity,\n    context: processedInput.context,\n    timestamp: processedInput.timestamp,\n    status: 'completed',\n    completed_at: new Date().toISOString(),\n    findings: `Analysis of ${processedInput.anomalySummary}. AI processing error: ${error.message}`,\n    recommended_actions: ['Review system metrics', 'Check threshold configurations'],\n    urgency_level: processedInput.severity,\n    error: error.message\n  };\n}\n\nreturn investigation;"
      },
      "id": "parse-investigation",
      "name": "Parse Investigation Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    },
    {
      "parameters": {
        "command": "psql -h ${service.postgres.host} -p ${service.postgres.port} -U ${service.postgres.user} -d ${service.postgres.database} -c \"INSERT INTO investigations (id, anomaly_data, severity, status, findings, recommended_actions, ai_analysis, created_at, completed_at) VALUES ('{{ $json.id }}', '{{ JSON.stringify($json.anomalies) }}', '{{ $json.severity }}', '{{ $json.status }}', '{{ $json.findings }}', '{{ JSON.stringify($json.recommended_actions) }}', '{{ JSON.stringify($json.ai_analysis) }}', '{{ $json.timestamp }}', '{{ $json.completed_at }}');\""
      },
      "id": "save-investigation",
      "name": "Save Investigation",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.urgency_level }}",
              "operation": "equal",
              "value2": "critical"
            }
          ]
        }
      },
      "id": "is-critical-urgency",
      "name": "Is Critical Urgency?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "command": "redis-cli -h ${service.redis.host} -p ${service.redis.port} LPUSH critical_investigations '{{ JSON.stringify($json) }}'",
        "options": {}
      },
      "id": "alert-critical",
      "name": "Alert Critical Issue",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1650, 100]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            }
          ],
          "object": [
            {
              "name": "investigation",
              "value": "={{ $json }}"
            }
          ]
        }
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Defaults": {
      "main": [
        [
          {
            "node": "Process Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Input": {
      "main": [
        [
          {
            "node": "Gather System Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gather System Context": {
      "main": [
        [
          {
            "node": "AI Investigation Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Investigation Analysis": {
      "main": [
        [
          {
            "node": "Parse Investigation Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Investigation Results": {
      "main": [
        [
          {
            "node": "Save Investigation",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Critical Urgency?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Critical Urgency?": {
      "main": [
        [
          {
            "node": "Alert Critical Issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "id": "anomaly-investigator"
}