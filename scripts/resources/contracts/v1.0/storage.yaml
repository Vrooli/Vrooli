# Vrooli Resource Interface Contract - Storage Resources v1.0
# This contract extends core.yaml with storage-specific requirements
# Applies to: postgres, redis, minio, qdrant, questdb, vault

version: "1.0"
contract_type: "category"
extends: "core.yaml"
category: "storage"
description: "Interface requirements for data storage and persistence resources"

# Additional actions specific to storage resources
additional_actions:
  backup:
    description: "Create backup of stored data"
    parameters:
      - name: destination
        type: string
        required: true
        description: "Backup destination path"
      - name: compress
        type: flag
        required: false
        description: "Compress backup data"
      - name: incremental
        type: flag
        required: false
        description: "Create incremental backup"
    exit_codes:
      0: "Backup successful"
      1: "Backup failed"
      2: "Destination not accessible"
    timeout_seconds: 600
    
  restore:
    description: "Restore data from backup"
    parameters:
      - name: source
        type: string
        required: true
        description: "Backup source file or directory"
      - name: overwrite
        type: flag
        required: false
        description: "Overwrite existing data"
      - name: verify
        type: flag
        required: false
        description: "Verify data integrity after restore"
    exit_codes:
      0: "Restore successful"
      1: "Restore failed"
      2: "Source backup not found or corrupted"
    timeout_seconds: 600
    
  migrate:
    description: "Migrate data between versions or formats"
    parameters:
      - name: from
        type: string
        required: true
        description: "Source version or format"
      - name: to
        type: string
        required: true
        description: "Target version or format"
      - name: dry-run
        type: flag
        required: false
        description: "Show migration plan without executing"
    exit_codes:
      0: "Migration successful"
      1: "Migration failed"
      2: "Migration not needed or not supported"
    timeout_seconds: 1800
    
  connect:
    description: "Test database/storage connection"
    parameters:
      - name: database
        type: string
        required: false
        description: "Specific database to test"
      - name: timeout
        type: integer
        required: false
        default: 10
        description: "Connection timeout in seconds"
    exit_codes:
      0: "Connection successful"
      1: "Connection failed"
      2: "Database not found"
    timeout_seconds: 30
    
  cleanup:
    description: "Clean up old or unnecessary data"
    parameters:
      - name: age
        type: string
        required: false
        default: "30d"
        description: "Age threshold (e.g., 30d, 7d, 1h)"
      - name: dry-run
        type: flag
        required: false
        description: "Show what would be cleaned without executing"
      - name: force
        type: flag
        required: false
        description: "Force cleanup without confirmation"
    exit_codes:
      0: "Cleanup successful"
      1: "Cleanup failed"
      2: "Nothing to cleanup"
    timeout_seconds: 300

# Storage-specific configuration requirements
storage_configuration:
  data_directory:
    description: "Primary data storage location"
    required: true
    environment_variable: "VROOLI_STORAGE_DATA_PATH"
  
  persistence_settings:
    description: "Data persistence configuration"
    parameters:
      - "durability_mode"
      - "sync_frequency"
      - "checkpoint_interval"
      - "wal_mode"
  
  connection_settings:
    description: "Connection and networking configuration"
    parameters:
      - "max_connections"
      - "connection_timeout"
      - "idle_timeout"
      - "keepalive_interval"
  
  security_settings:
    description: "Storage security configuration"
    required: true
    parameters:
      - "authentication_required"
      - "encryption_at_rest"
      - "ssl_mode"
      - "access_control"

# Storage-specific file structure
storage_file_structure:
  required_files:
    - "lib/backup.sh"           # Backup utilities
    - "lib/restore.sh"          # Restore utilities
  
  optional_files:
    - "data/"                   # Data storage directory
    - "lib/migration.sh"        # Migration utilities
    - "lib/cleanup.sh"          # Cleanup utilities
    - "config/storage.yaml"     # Storage configuration
    - "schemas/"                # Database schemas
    - "migrations/"             # Migration scripts
  
  optional_directories:
    - "data/"                   # Primary data storage
    - "backups/"                # Backup storage
    - "logs/"                   # Storage-specific logs
    - "temp/"                   # Temporary storage
    - "archive/"                # Archived data

# Storage-specific environment variables
storage_environment:
  required_variables:
    - "VROOLI_STORAGE_SERVICE_PORT"
    - "VROOLI_STORAGE_BASE_URL"
    - "VROOLI_STORAGE_DATA_PATH"
  
  optional_variables:
    - "VROOLI_STORAGE_BACKUP_PATH"
    - "VROOLI_STORAGE_MAX_SIZE"
    - "VROOLI_STORAGE_CACHE_SIZE"
    - "VROOLI_STORAGE_SSL_ENABLED"
    - "VROOLI_STORAGE_AUTH_REQUIRED"

# Performance requirements for storage resources
storage_performance:
  startup_time_max_seconds: 60
  connection_time_max_seconds: 5
  backup_speed_min_mbps: 10
  query_response_max_seconds: 1
  concurrent_connection_support: true

# Storage-specific security requirements
storage_security:
  encryption_at_rest: "recommended"
  encryption_in_transit: "required"
  authentication: "required"
  authorization: "required"
  audit_logging: "recommended"
  backup_encryption: "recommended"

# Storage service health indicators
storage_health_checks:
  api_endpoint:
    description: "API endpoint responds"
    method: "GET"
    path: "/health"
    expected_status: 200
    timeout_seconds: 10
  
  connection_test:
    description: "Can establish database connection"
    check_type: "connection"
    timeout_seconds: 10
  
  read_write_test:
    description: "Can read and write data"
    test_operations: ["create", "read", "update", "delete"]
    timeout_seconds: 30
  
  storage_space:
    description: "Adequate storage space available"
    minimum_free_space: "1GB"
    check_type: "disk_space"

# Common storage resource patterns
storage_patterns:
  connection_string:
    description: "Standard connection string format"
    format: "protocol://user:password@host:port/database"
    examples:
      - "postgresql://user:pass@localhost:5432/db"
      - "redis://localhost:6379/0"
      - "http://localhost:9000"  # MinIO/S3
  
  api_endpoints:
    description: "Standard API endpoint patterns"
    required_endpoints:
      - "/health"
      - "/stats"
    optional_endpoints:
      - "/backup"
      - "/restore"
      - "/metrics"
  
  data_formats:
    description: "Supported data formats"
    required_formats: ["json"]
    optional_formats: ["xml", "csv", "binary", "text"]

# Integration requirements
storage_integration:
  backup_systems:
    description: "Integration with backup systems"
    required: true
    supported_destinations: ["local", "s3", "ftp", "ssh"]
  
  monitoring_systems:
    description: "Integration with monitoring"
    required: true
    metrics_export: ["prometheus", "json", "csv"]
  
  replication:
    description: "Data replication capabilities"
    optional: true
    supported_modes: ["master-slave", "master-master", "cluster"]
  
  monitoring:
    description: "Storage-specific monitoring metrics"
    required_metrics:
      - "storage_used"
      - "storage_available"
      - "connection_count"
      - "query_count"
      - "response_time"
      - "error_rate"

# Data lifecycle management
data_lifecycle:
  retention_policies:
    description: "Data retention configuration"
    optional: true
    policies:
      - "time_based"
      - "size_based"
      - "event_based"
  
  archival_rules:
    description: "Data archival configuration"
    optional: true
    triggers:
      - "age_threshold"
      - "access_frequency"
      - "storage_pressure"
  
  cleanup_procedures:
    description: "Automated cleanup procedures"
    required_operations:
      - "temporary_data_cleanup"
      - "log_rotation"
      - "cache_eviction"

# Backup and recovery
backup_recovery:
  backup_types:
    - "full"
    - "incremental"
    - "differential"
  
  recovery_options:
    - "point_in_time"
    - "full_restore"
    - "partial_restore"
  
  verification:
    - "backup_integrity_check"
    - "restore_test"
    - "data_consistency_check"

# Validation rules specific to storage resources
storage_validation:
  syntax_checks:
    - "storage_actions_present"
    - "backup_restore_implemented"
    - "connection_management_available"
  
  behavioral_checks:
    - "connection_establishment_works"
    - "backup_creation_functional"
    - "data_persistence_verified"
  
  integration_checks:
    - "api_endpoints_accessible"
    - "data_integrity_maintained"
    - "backup_recovery_tested"
    - "performance_requirements_met"