
services:
  # PostgreSQL Database
  windmill-db:
    image: postgres:16
    container_name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}-db"
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${WINDMILL_DB_PASSWORD}
      POSTGRES_DB: ${WINDMILL_DB_NAME:-windmill}
      POSTGRES_USER: ${WINDMILL_DB_USER:-postgres}
    volumes:
      - windmill_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${WINDMILL_DB_USER:-postgres} -d ${WINDMILL_DB_NAME:-windmill}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - windmill-network
    profiles:
      - internal-db

  # Windmill Server (Frontend + API)
  windmill-server:
    image: ${WINDMILL_IMAGE:-ghcr.io/windmill-labs/windmill:main}
    container_name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}-app"
    restart: unless-stopped
    ports:
      - "${WINDMILL_SERVER_PORT:-5681}:8000"
    environment:
      - DATABASE_URL=${WINDMILL_DATABASE_URL:-postgresql://${WINDMILL_DB_USER:-postgres}:${WINDMILL_DB_PASSWORD}@windmill-db:5432/${WINDMILL_DB_NAME:-windmill}}
      - MODE=server
      - RUST_LOG=${WINDMILL_LOG_LEVEL:-info}
      - JWT_SECRET=${WINDMILL_JWT_SECRET}
      - COOKIE_DOMAIN=localhost
      - WM_BASE_URL=http://localhost:${WINDMILL_SERVER_PORT:-5681}
    depends_on:
      windmill-db:
        condition: service_healthy
        required: false
    volumes:
      - windmill_server_data:/tmp/windmill
      - windmill_logs:/var/log/windmill
    networks:
      - windmill-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Windmill Workers (Default Group)
  windmill-worker:
    image: ${WINDMILL_IMAGE:-ghcr.io/windmill-labs/windmill:main}
    restart: unless-stopped
    deploy:
      replicas: ${WINDMILL_WORKER_REPLICAS:-3}
      resources:
        limits:
          memory: ${WINDMILL_WORKER_MEMORY_LIMIT:-2048M}
        reservations:
          memory: 512M
    environment:
      - DATABASE_URL=${WINDMILL_DATABASE_URL:-postgresql://${WINDMILL_DB_USER:-postgres}:${WINDMILL_DB_PASSWORD}@windmill-db:5432/${WINDMILL_DB_NAME:-windmill}}
      - MODE=worker
      - WORKER_GROUP=${WINDMILL_WORKER_GROUP:-default}
      - RUST_LOG=${WINDMILL_LOG_LEVEL:-info}
      - DISABLE_NUSER=${WINDMILL_DISABLE_NUSER:-false}
      - KEEP_JOB_DIR=${WINDMILL_KEEP_JOB_DIR:-false}
      - WORKER_TAGS=deno,python3,go,bash,powershell,dependency
    depends_on:
      windmill-server:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - windmill_worker_data:/tmp/windmill
      - windmill_logs:/var/log/windmill
    networks:
      - windmill-network
    profiles:
      - workers

  # Windmill Native Worker (for system commands)
  windmill-worker-native:
    image: ${WINDMILL_IMAGE:-ghcr.io/windmill-labs/windmill:main}
    container_name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}-worker-native"
    restart: unless-stopped
    environment:
      - DATABASE_URL=${WINDMILL_DATABASE_URL:-postgresql://${WINDMILL_DB_USER:-postgres}:${WINDMILL_DB_PASSWORD}@windmill-db:5432/${WINDMILL_DB_NAME:-windmill}}
      - MODE=worker
      - WORKER_GROUP=native
      - RUST_LOG=${WINDMILL_LOG_LEVEL:-info}
      - DISABLE_NUSER=true
      - KEEP_JOB_DIR=${WINDMILL_KEEP_JOB_DIR:-false}
      - WORKER_TAGS=bash,powershell,dependency,native
    depends_on:
      windmill-server:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - windmill_worker_data:/tmp/windmill
      - windmill_logs:/var/log/windmill
      # Mount host directories for native worker access
      - /usr/bin:/usr/bin:ro
      - /bin:/bin:ro
      - /usr/local/bin:/usr/local/bin:ro
    networks:
      - windmill-network
    deploy:
      resources:
        limits:
          memory: ${WINDMILL_WORKER_MEMORY_LIMIT:-2048M}
        reservations:
          memory: 256M
    profiles:
      - native-worker

  # Language Server Protocol (for IDE features)
  windmill-lsp:
    image: ${WINDMILL_IMAGE:-ghcr.io/windmill-labs/windmill:main}
    container_name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}-lsp"
    restart: unless-stopped
    environment:
      - DATABASE_URL=${WINDMILL_DATABASE_URL:-postgresql://${WINDMILL_DB_USER:-postgres}:${WINDMILL_DB_PASSWORD}@windmill-db:5432/${WINDMILL_DB_NAME:-windmill}}
      - MODE=indexer
      - RUST_LOG=${WINDMILL_LOG_LEVEL:-info}
    depends_on:
      windmill-server:
        condition: service_healthy
    volumes:
      - windmill_lsp_data:/tmp/windmill
    networks:
      - windmill-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    profiles:
      - lsp

  # Multiplayer Service (Enterprise Edition)
  windmill-multiplayer:
    image: ${WINDMILL_IMAGE:-ghcr.io/windmill-labs/windmill:main}
    container_name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}-multiplayer"
    restart: unless-stopped
    environment:
      - DATABASE_URL=${WINDMILL_DATABASE_URL:-postgresql://${WINDMILL_DB_USER:-postgres}:${WINDMILL_DB_PASSWORD}@windmill-db:5432/${WINDMILL_DB_NAME:-windmill}}
      - MODE=multiplayer
      - RUST_LOG=${WINDMILL_LOG_LEVEL:-info}
    depends_on:
      windmill-server:
        condition: service_healthy
    volumes:
      - windmill_multiplayer_data:/tmp/windmill
    networks:
      - windmill-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    profiles:
      - multiplayer

volumes:
  windmill_db_data:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_db_data"
  windmill_server_data:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_server_data"
  windmill_worker_data:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_worker_data"
  windmill_lsp_data:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_lsp_data"
  windmill_multiplayer_data:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_multiplayer_data"
  windmill_logs:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_logs"

networks:
  windmill-network:
    name: "${WINDMILL_PROJECT_NAME:-windmill-vrooli}_network"
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/16