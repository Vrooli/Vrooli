workflow:
  name: "demo-flow-control"
  description: "Demonstration of flow control features - branching, loops, and error handling"
  version: "2.0.0"
  debug_level: "steps"
  
  # Enable flow control for state machine execution
  flow_control:
    enabled: true
    max_iterations: 10
    
  parameters:
    search_term:
      type: string
      required: true
      description: "Term to search for"
      default: "browserless automation"
    max_results:
      type: number
      required: false
      description: "Maximum results to collect"
      default: 3

  steps:
    # ENTRY POINT - Start navigation
    - name: "start-search"
      label: "entry"
      action: "navigate"
      url: "https://duckduckgo.com"
      wait_for: "networkidle2"
      debug:
        screenshot: true
        
    # Type search query
    - name: "enter-search"
      action: "type"
      selector: "#searchbox_input"
      text: "${params.search_term}"
      debug:
        screenshot: true
        
    # Submit search
    - name: "submit-search"
      action: "click"
      selector: "button[type='submit']"
      wait_for_navigation: true
      
    # Check if we have results
    - name: "check-results"
      action: "evaluate"
      script: |
        const results = document.querySelectorAll('[data-testid="result"]');
        return {
          hasResults: results.length > 0,
          resultCount: results.length
        };
      
    # BRANCHING - Jump based on results
    - name: "branch-on-results"
      action: "jump_if"
      condition: "window.__lastEvalResult && window.__lastEvalResult.hasResults"
      success_target: "process_results"
      failure_target: "no_results_found"
      
    # SUCCESS PATH - Process search results
    - name: "extract-results"
      label: "process_results"
      action: "extract_data"
      selectors:
        titles: "[data-testid='result'] h2"
        links: "[data-testid='result'] a[href]"
        snippets: "[data-testid='result'] span"
      output: "${context.outputDir}/search-results.json"
      
    - name: "log-success"
      action: "log"
      message: "Successfully extracted ${window.__lastExtractCount || 0} results"
      level: "info"
      jump_to: "take_screenshot"
      
    # FAILURE PATH - No results
    - name: "handle-no-results"
      label: "no_results_found"
      action: "log"
      message: "No search results found for: ${params.search_term}"
      level: "warn"
      
    - name: "try-alternative"
      action: "type"
      selector: "#searchbox_input"
      text: " alternative"
      clear_first: false
      
    - name: "retry-search"
      action: "click"
      selector: "button[type='submit']"
      wait_for_navigation: true
      jump_to: "check_results"  # Loop back to check results
      
    # FINAL STEP - Capture screenshot
    - name: "capture-final-state"
      label: "take_screenshot"
      action: "screenshot"
      output: "${context.outputDir}/final-search.png"
      full_page: true
      
# Sub-workflow for handling cookies/popups
sub_workflows:
  handle_popups:
    description: "Handle cookie banners and popups"
    steps:
      - name: "check-cookie-banner"
        action: "wait_for_element"
        selector: "[id*='cookie'], [class*='consent'], .modal"
        timeout: 3000
        optional: true
        
      - name: "dismiss-popup"
        action: "click"
        selector: "button:has-text('Accept'), button:has-text('OK'), .close"
        optional: true
        wait: 500