workflow:
  name: "monitoring-health-check"
  description: "Monitor website availability, performance, and functionality"
  version: "1.0.0"
  debug_level: "verbose"
  
  parameters:
    sites:
      type: array
      required: true
      description: "Array of sites to monitor"
      items:
        type: object
        properties:
          name:
            type: string
            description: "Site identifier"
          url:
            type: string
            description: "URL to check"
          expected_elements:
            type: array
            description: "CSS selectors that should exist"
          expected_text:
            type: string
            description: "Text that should be present"
          max_load_time:
            type: number
            description: "Maximum acceptable load time in ms"
            default: 5000
    alert_threshold:
      type: number
      required: false
      description: "Number of failures before alerting"
      default: 1
    check_interval:
      type: number
      required: false
      description: "Time between checks in milliseconds"
      default: 300000
  
  steps:
    - name: "initialize-monitoring"
      action: "log"
      message: "Starting health check for ${params.sites.length} sites"
      level: "info"
      debug:
        screenshot: false
    
    # Site 1 Check
    - name: "check-site-1"
      action: "navigate"
      url: "${params.sites[0].url}"
      wait_for: "domcontentloaded"
      timeout: "${params.sites[0].max_load_time}"
      on_error: "continue"
      debug:
        screenshot: true
        network: true
        timing: true
    
    - name: "measure-site-1-performance"
      action: "evaluate"
      script: |
        const perf = performance.timing;
        return {
          dns: perf.domainLookupEnd - perf.domainLookupStart,
          tcp: perf.connectEnd - perf.connectStart,
          request: perf.responseStart - perf.requestStart,
          response: perf.responseEnd - perf.responseStart,
          dom: perf.domContentLoadedEventEnd - perf.domContentLoadedEventStart,
          load: perf.loadEventEnd - perf.loadEventStart,
          total: perf.loadEventEnd - perf.navigationStart
        };
      output: "${context.outputDir}/site-1-performance.json"
      on_error: "continue"
      debug:
        screenshot: false
    
    - name: "verify-site-1-elements"
      action: "assert_element"
      selector: "${params.sites[0].expected_elements[0]}"
      timeout: 5000
      on_error: "continue"
      debug:
        screenshot: true
    
    - name: "verify-site-1-text"
      action: "assert_text"
      selector: "body"
      expected_text: "${params.sites[0].expected_text}"
      on_error: "continue"
      debug:
        screenshot: false
    
    - name: "check-site-1-console-errors"
      action: "evaluate"
      script: |
        return window.__consoleErrors || [];
      output: "${context.outputDir}/site-1-console-errors.json"
      on_error: "continue"
      debug:
        console: true
    
    - name: "capture-site-1-state"
      action: "screenshot"
      output: "${context.outputDir}/site-1-${context.timestamp}.png"
      full_page: false
      debug:
        screenshot: true
    
    # Site 2 Check (if exists)
    - name: "check-site-2"
      action: "navigate"
      url: "${params.sites[1].url}"
      wait_for: "domcontentloaded"
      timeout: "${params.sites[1].max_load_time}"
      condition: "${params.sites.length > 1}"
      on_error: "continue"
      debug:
        screenshot: true
        network: true
        timing: true
    
    - name: "verify-site-2-elements"
      action: "assert_element"
      selector: "${params.sites[1].expected_elements[0]}"
      timeout: 5000
      condition: "${params.sites.length > 1}"
      on_error: "continue"
      debug:
        screenshot: true
    
    - name: "capture-site-2-state"
      action: "screenshot"
      output: "${context.outputDir}/site-2-${context.timestamp}.png"
      full_page: false
      condition: "${params.sites.length > 1}"
      debug:
        screenshot: true
    
    # API Health Check
    - name: "check-api-endpoints"
      action: "evaluate"
      script: |
        const endpoints = [
          '/api/health',
          '/api/status',
          '/api/v1/ping'
        ];
        const results = [];
        for (const endpoint of endpoints) {
          try {
            const response = await fetch('${params.sites[0].url}' + endpoint);
            results.push({
              endpoint: endpoint,
              status: response.status,
              ok: response.ok,
              timestamp: new Date().toISOString()
            });
          } catch (error) {
            results.push({
              endpoint: endpoint,
              error: error.message,
              timestamp: new Date().toISOString()
            });
          }
        }
        return results;
      output: "${context.outputDir}/api-health.json"
      on_error: "continue"
      debug:
        network: true
    
    # Check SSL Certificate
    - name: "check-ssl-certificate"
      action: "evaluate"  
      script: |
        const url = new URL('${params.sites[0].url}');
        return {
          protocol: url.protocol,
          isSecure: url.protocol === 'https:',
          host: url.hostname,
          timestamp: new Date().toISOString()
        };
      output: "${context.outputDir}/ssl-check.json"
      on_error: "continue"
      debug:
        screenshot: false
    
    # Generate Summary Report
    - name: "generate-summary"
      action: "evaluate"
      script: |
        const results = {
          timestamp: new Date().toISOString(),
          sites_checked: ${params.sites.length},
          status: 'completed',
          alerts: []
        };
        
        // Check if any critical elements are missing
        const criticalElements = document.querySelectorAll('.error, .alert-danger, .offline');
        if (criticalElements.length > 0) {
          results.alerts.push({
            type: 'critical',
            message: 'Critical error elements detected',
            count: criticalElements.length
          });
        }
        
        return results;
      output: "${context.outputDir}/monitoring-summary.json"
      debug:
        screenshot: false
    
    - name: "final-report-screenshot"
      action: "screenshot"
      output: "${context.outputDir}/final-monitoring-state.png"
      full_page: true
      debug:
        screenshot: true