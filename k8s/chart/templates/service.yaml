{{- /*
This template generates Services for each service defined in .Values.services
*/ -}}

{{- range $name, $svc := .Values.services }}
{{- $serviceEnabled := true -}}
{{- if hasKey $svc "enabled" -}}
  {{- $serviceEnabled = $svc.enabled -}}
{{- end -}}

{{- if $serviceEnabled -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vrooli.fullname" $ }}-{{ include "vrooli.componentName" $name }}
  labels:
    {{- include "vrooli.labels" $ | nindent 4 }}
    {{- include "vrooli.componentLabels" (dict "componentName" (include "vrooli.componentName" $name) "root" $) | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: {{ $svc.port }}
      targetPort: {{ $svc.port }}
      protocol: TCP
      name: http {{- if eq $name "nsfwDetector" }}-tcp{{- end }} # Ensure port name is valid if it's just numbers
  selector:
    {{- include "vrooli.selectorLabels" $ | nindent 4 }}
    {{- include "vrooli.componentLabels" (dict "componentName" (include "vrooli.componentName" $name) "root" $) | nindent 4 }}
{{- end }}{{/* if $serviceEnabled */}}
{{- end }}

{{- if .Values.adminer.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "vrooli.fullname" . }}-adminer
  labels:
    {{- include "vrooli.labels" . | nindent 4 }}
    app.kubernetes.io/component: adminer
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.adminer.port | default 8080 }}
      targetPort: {{ .Values.adminer.port | default 8080 }}
      protocol: TCP
      name: http
  selector:
    {{- include "vrooli.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: adminer
{{- end }} 