# OpenCode (Twinny) Resource Secrets Declaration
# Follows Vrooli Secrets Standard v1.0

version: "1.0"
resource: "opencode"
description: "API credentials and gateway configuration for the OpenCode (Twinny) VS Code extension"

secrets:
  providers:
    - name: "openrouter_api_key"
      path: "secret/resources/opencode/providers/openrouter/api_key"
      description: "OpenRouter API key used when the Twinny provider is set to openrouter"
      required: false
      format: "string"
      validation:
        pattern: "^sk-or-v1-[a-f0-9]{10,}$"
      default_env: "OPENROUTER_API_KEY"
      fallback: "env:OPENROUTER_API_KEY"
      example: "sk-or-v1-0123456789abcdef..."
      links:
        - label: "Create OpenRouter API key"
          url: "https://openrouter.ai/keys"
    - name: "cloudflare_api_token"
      path: "secret/resources/opencode/providers/cloudflare/api_token"
      description: "Cloudflare AI Gateway token for routing Twinny requests through Cloudflare"
      required: false
      format: "string"
      default_env: "CLOUDFLARE_API_TOKEN"
      fallback: "env:CLOUDFLARE_API_TOKEN"
      example: "cf_token_xxxxxxxxxxxxxxxxx"
      links:
        - label: "Cloudflare AI Gateway tokens"
          url: "https://dash.cloudflare.com/?to=/:account/workers/ai/gateway"
  gateway:
    - name: "cloudflare_account_id"
      path: "secret/resources/opencode/providers/cloudflare/account_id"
      description: "Cloudflare account identifier for AI Gateway integrations"
      required: false
      format: "string"
      default_env: "CLOUDFLARE_ACCOUNT_ID"
      fallback: "env:CLOUDFLARE_ACCOUNT_ID"
      example: "abcd1234ef5678901234567890abcdef"
    - name: "cloudflare_gateway_slug"
      path: "secret/resources/opencode/providers/cloudflare/gateway_slug"
      description: "AI Gateway slug (used to build https://gateway.ai.cloudflare.com/v1/<account>/<slug>)"
      required: false
      format: "string"
      default_env: "CLOUDFLARE_AI_GATEWAY_SLUG"
      example: "vrooli"

initialization:
  prompt_user:
    - name: "openrouter_api_key"
      prompt: |
        (Optional) Enter the OpenRouter API key if you plan to use Twinny with the openrouter provider.
        You can reuse the same key stored for the OpenRouter resource.
      validation: "Test with resource-opencode content add config myconfig openrouter"
      optional: true
    - name: "cloudflare_api_token"
      prompt: |
        (Optional) Enter the Cloudflare AI Gateway API token if you want Twinny to call models through the gateway.
        Reuse the token you registered with the cloudflare-ai-gateway resource.
      validation: "Verify with resource-cloudflare-ai-gateway status"
      optional: true

dependencies:
  - resource: "openrouter"
    secrets: ["openrouter_api_key"]
    purpose: "Reuse the same OpenRouter API key for OpenCode remote completions"
    required: false
  - resource: "cloudflare-ai-gateway"
    secrets: ["cloudflare_api_token", "cloudflare_account_id"]
    purpose: "Route Twinny traffic through Cloudflare AI Gateway"
    required: false

health_check:
  required_secrets: []
  optional_secrets: ["openrouter_api_key", "cloudflare_api_token"]
  note: "OpenCode works with local Ollama models without any secrets; remote providers require the matching API key."

security:
  recommendations:
    - "Scope Cloudflare tokens to AI Gateway only and rotate them regularly."
    - "Store OpenRouter keys in Vault and avoid committing them to settings.json."
    - "Limit VS Code settings sync to exclude API credentials."
  sensitive_paths:
    - "${HOME}/.config/Code/User/settings.json"
    - "${HOME}/Library/Application Support/Code/User/settings.json"
    - "${OPENCODE_DATA_DIR}/config*.json"
