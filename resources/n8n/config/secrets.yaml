# n8n Secrets Declaration v1.0
version: "1.0"
resource: "n8n"
description: "Secrets configuration for n8n workflow automation platform"

secrets:
  # Database credentials
  database:
    - name: "postgres_password"
      path: "secret/resources/n8n/db/postgres"
      description: "PostgreSQL database password for n8n"
      required: true
      format: "string"
      default_env: "DB_POSTGRESDB_PASSWORD"
      fallback: "env:DB_POSTGRESDB_PASSWORD"
      
  # Redis credentials (if authentication is enabled)
  cache:
    - name: "redis_password"
      path: "secret/resources/n8n/cache/redis"
      description: "Redis password for queue management"
      required: false
      format: "string"
      default_env: "QUEUE_BULL_REDIS_PASSWORD"
      fallback: "env:QUEUE_BULL_REDIS_PASSWORD"
      
  # n8n encryption key for credentials
  encryption:
    - name: "encryption_key"
      path: "secret/resources/n8n/encryption/key"
      description: "Encryption key for n8n credential storage"
      required: true
      format: "string"
      validation:
        min_length: 32
      default_env: "N8N_ENCRYPTION_KEY"
      auto_generate: true  # Can be auto-generated if not provided
      
  # Basic auth credentials (optional)
  auth:
    - name: "basic_auth_user"
      path: "secret/resources/n8n/auth/basic"
      description: "Basic authentication username"
      required: false
      format: "string"
      default_env: "N8N_BASIC_AUTH_USER"
      fields:
        - username: "user"
        - password: "pass"
        
  # Webhook authentication token (optional)
  tokens:
    - name: "webhook_token"
      path: "secret/resources/n8n/tokens/webhook"
      description: "Global webhook authentication token"
      required: false
      format: "string"
      default_env: "N8N_WEBHOOK_TOKEN"
      
  # External API credentials that n8n might commonly use
  integrations:
    - name: "openai_api_key"
      path: "secret/resources/n8n/integrations/openai"
      description: "OpenAI API key for AI nodes"
      required: false
      format: "string"
      default_env: "OPENAI_API_KEY"
      fallback: "resource:ollama:api_key"  # Use Ollama if available
      
    - name: "smtp_credentials"
      path: "secret/resources/n8n/integrations/smtp"
      description: "SMTP credentials for email nodes"
      required: false
      format: "object"
      fields:
        - host: "smtp_host"
        - port: "smtp_port"
        - user: "smtp_user"
        - pass: "smtp_pass"
      default_env: "N8N_SMTP_"  # Prefix for multiple env vars

# Dependencies on other resource secrets
dependencies:
  - resource: "postgres"
    secrets: ["connection_string"]
    purpose: "Database storage for workflows and credentials"
    
  - resource: "redis"
    secrets: ["connection_url"]
    purpose: "Queue management and caching"
    required: false
    
  - resource: "ollama"
    secrets: ["api_endpoint"]
    purpose: "Local AI model integration"
    required: false
    
  - resource: "openrouter"
    secrets: ["api_key"]
    purpose: "External AI model routing"
    required: false

# Initialization configuration
initialization:
  auto_generate:
    - name: "encryption_key"
      type: "random_string"
      length: 64
      path: "secret/resources/n8n/encryption/key"
      
  prompt_user:
    - name: "basic_auth_user"
      prompt: "Do you want to enable basic authentication for n8n? (y/n)"
      conditional: true
      sub_prompts:
        - field: "username"
          prompt: "Enter username for n8n basic auth:"
        - field: "password"
          prompt: "Enter password for n8n basic auth:"
          secure: true
          
  copy_from_resource:
    - name: "postgres_password"
      source: "postgres"
      source_field: "password"
      
    - name: "redis_password"
      source: "redis"
      source_field: "password"
      conditional: "if_exists"

# Health check configuration
health_check:
  required_secrets: ["encryption_key", "postgres_password"]
  validation_command: "n8n::validate_secrets"
  failure_mode: "warn"  # warn|fail|skip