# Codex Resource Secrets Configuration
# Based on Vrooli Resource Secrets Standard v1.0

version: "1.0"
resource: "codex"
description: "OpenAI API credentials for AI-powered code generation using GPT models"

secrets:
  # API credentials
  api_keys:
    - name: "openai_api_key"
      path: "secret/resources/codex/api/openai"
      description: "OpenAI API key for GPT-3.5-turbo/GPT-4 code generation"
      required: true
      format: "string"
      validation:
        pattern: "^sk-[A-Za-z0-9_-]{20,}$"
      default_env: "OPENAI_API_KEY"
      fallback: "env:OPENAI_API_KEY"
      example: "sk-proj-abc123..."
      
    - name: "openai_organization"
      path: "secret/resources/codex/api/organization"
      description: "OpenAI organization ID (optional)"
      required: false
      format: "string"
      default_env: "OPENAI_ORG_ID"
      fallback: "env:OPENAI_ORG_ID"
      example: "org-abc123..."

  # Model configuration
  model_config:
    - name: "default_model"
      path: "secret/resources/codex/config/model"
      description: "Default GPT model to use for code generation"
      required: false
      format: "string"
      default_env: "CODEX_DEFAULT_MODEL"
      fallback: "env:CODEX_DEFAULT_MODEL"
      default_value: "gpt-3.5-turbo"
      allowed_values:
        - "gpt-3.5-turbo"
        - "gpt-3.5-turbo-16k"
        - "gpt-4"
        - "gpt-4-turbo"
        - "gpt-4-32k"

# No dependencies on other resources for secrets
dependencies: []

# Initialization hints for vault
initialization:
  prompt_user:
    - name: "openai_api_key"
      prompt: "Enter your OpenAI API key from https://platform.openai.com/api-keys"
      validation: "Test connection to OpenAI API endpoint"
      test_command: |
        curl -s -H "Authorization: Bearer $OPENAI_API_KEY" \
          https://api.openai.com/v1/models | grep -q "gpt-3.5-turbo"
      
# Health check that validates secrets are properly configured
health_check:
  endpoint: "/health/secrets"
  required_secrets: ["openai_api_key"]
  test_script: |
    # Test that API key works with OpenAI
    if [ -n "$OPENAI_API_KEY" ]; then
      response=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        https://api.openai.com/v1/models)
      [ "$response" = "200" ] && echo "API key valid" || echo "API key invalid"
    else
      echo "No API key configured"
      exit 1
    fi