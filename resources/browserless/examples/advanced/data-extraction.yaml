workflow:
  name: "data-extraction"
  description: "Extract various types of data from web pages"
  version: "1.0.0"
  
  parameters:
    target_url:
      type: string
      required: true
      description: "URL to extract data from"
    output_dir:
      type: string
      required: false
      description: "Directory for extracted data"
      default: "./extracted-data"
  
  steps:
    # Navigate to target page
    - name: navigate
      action: navigate
      url: "${params.target_url}"
      wait_for: networkidle2
    
    # Extract page metadata
    - name: extract-metadata
      action: evaluate
      script: |
        const metas = {};
        document.querySelectorAll('meta').forEach(meta => {
          const name = meta.getAttribute('name') || meta.getAttribute('property');
          const content = meta.getAttribute('content');
          if (name && content) {
            metas[name] = content;
          }
        });
        return {
          title: document.title,
          description: metas.description || '',
          keywords: metas.keywords || '',
          author: metas.author || '',
          ogTitle: metas['og:title'] || '',
          ogDescription: metas['og:description'] || '',
          ogImage: metas['og:image'] || ''
        };
      output: "${params.output_dir}/metadata.json"
    
    # Extract all text content
    - name: extract-body-text
      action: extract_text
      selector: "body"
      output: "${params.output_dir}/body-text.txt"
    
    # Extract main content (article, main, or content div)
    - name: extract-main-content
      action: evaluate
      script: |
        const selectors = ['main', 'article', '[role="main"]', '#content', '.content', '#main', '.main'];
        for (const selector of selectors) {
          const element = document.querySelector(selector);
          if (element) {
            return {
              found: true,
              selector: selector,
              text: element.textContent.trim(),
              html: element.innerHTML
            };
          }
        }
        return { found: false, message: 'No main content container found' };
      output: "${params.output_dir}/main-content.json"
    
    # Extract all headings
    - name: extract-headings
      action: evaluate
      script: |
        const headings = [];
        document.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(h => {
          headings.push({
            level: h.tagName.toLowerCase(),
            text: h.textContent.trim(),
            id: h.id || null,
            class: h.className || null
          });
        });
        return headings;
      output: "${params.output_dir}/headings.json"
    
    # Extract all images
    - name: extract-images
      action: evaluate
      script: |
        const images = [];
        document.querySelectorAll('img').forEach(img => {
          images.push({
            src: img.src,
            alt: img.alt,
            title: img.title,
            width: img.naturalWidth,
            height: img.naturalHeight,
            loading: img.loading
          });
        });
        return images;
      output: "${params.output_dir}/images.json"
    
    # Extract all form data
    - name: extract-forms
      action: evaluate
      script: |
        const forms = [];
        document.querySelectorAll('form').forEach(form => {
          const inputs = [];
          form.querySelectorAll('input, select, textarea').forEach(input => {
            inputs.push({
              name: input.name,
              type: input.type || input.tagName.toLowerCase(),
              id: input.id,
              value: input.value,
              required: input.required,
              placeholder: input.placeholder
            });
          });
          forms.push({
            id: form.id,
            action: form.action,
            method: form.method,
            inputs: inputs
          });
        });
        return forms;
      output: "${params.output_dir}/forms.json"
    
    # Extract tables
    - name: extract-tables
      action: evaluate
      script: |
        const tables = [];
        document.querySelectorAll('table').forEach((table, index) => {
          const data = [];
          const headers = [];
          
          // Extract headers
          table.querySelectorAll('thead th, thead td').forEach(th => {
            headers.push(th.textContent.trim());
          });
          
          // If no thead, try first row
          if (headers.length === 0) {
            const firstRow = table.querySelector('tr');
            if (firstRow) {
              firstRow.querySelectorAll('th, td').forEach(cell => {
                headers.push(cell.textContent.trim());
              });
            }
          }
          
          // Extract data rows
          table.querySelectorAll('tbody tr, tr:not(:first-child)').forEach(tr => {
            const row = [];
            tr.querySelectorAll('td').forEach(td => {
              row.push(td.textContent.trim());
            });
            if (row.length > 0) {
              data.push(row);
            }
          });
          
          tables.push({
            index: index,
            id: table.id || `table-${index}`,
            headers: headers,
            rows: data,
            summary: table.getAttribute('summary')
          });
        });
        return tables;
      output: "${params.output_dir}/tables.json"
    
    # Extract specific data attributes
    - name: extract-data-attributes
      action: evaluate
      script: |
        const elements = [];
        document.querySelectorAll('[data-testid], [data-id], [data-value]').forEach(el => {
          const dataAttrs = {};
          for (const attr of el.attributes) {
            if (attr.name.startsWith('data-')) {
              dataAttrs[attr.name] = attr.value;
            }
          }
          elements.push({
            tag: el.tagName.toLowerCase(),
            id: el.id,
            class: el.className,
            text: el.textContent.trim().substring(0, 100),
            dataAttributes: dataAttrs
          });
        });
        return elements;
      output: "${params.output_dir}/data-attributes.json"
    
    # Extract structured data (JSON-LD)
    - name: extract-structured-data
      action: evaluate
      script: |
        const structuredData = [];
        document.querySelectorAll('script[type="application/ld+json"]').forEach(script => {
          try {
            const data = JSON.parse(script.textContent);
            structuredData.push(data);
          } catch (e) {
            structuredData.push({ error: 'Failed to parse JSON-LD', content: script.textContent });
          }
        });
        return structuredData;
      output: "${params.output_dir}/structured-data.json"
    
    # Extract social media links
    - name: extract-social-links
      action: evaluate
      script: |
        const socialPatterns = [
          'facebook.com', 'twitter.com', 'x.com', 'linkedin.com', 
          'instagram.com', 'youtube.com', 'github.com', 'tiktok.com'
        ];
        const socialLinks = [];
        document.querySelectorAll('a[href]').forEach(link => {
          const href = link.href.toLowerCase();
          for (const pattern of socialPatterns) {
            if (href.includes(pattern)) {
              socialLinks.push({
                platform: pattern.replace('.com', ''),
                url: link.href,
                text: link.textContent.trim(),
                icon: link.querySelector('img, svg') ? true : false
              });
              break;
            }
          }
        });
        return socialLinks;
      output: "${params.output_dir}/social-links.json"
    
    # Take screenshots of key elements
    - name: screenshot-header
      action: evaluate
      script: |
        const header = document.querySelector('header, [role="banner"], .header, #header');
        return header ? true : false;
      variable: has_header
    
    - name: capture-header
      action: if
      condition: "${has_header}"
      then:
        - action: screenshot_element
          selector: "header, [role='banner'], .header, #header"
          path: "${params.output_dir}/header.png"
    
    # Generate extraction summary
    - name: generate-summary
      action: evaluate
      script: |
        return {
          url: window.location.href,
          timestamp: new Date().toISOString(),
          documentStats: {
            characterCount: document.body.textContent.length,
            wordCount: document.body.textContent.split(/\s+/).length,
            linkCount: document.querySelectorAll('a').length,
            imageCount: document.querySelectorAll('img').length,
            formCount: document.querySelectorAll('form').length,
            tableCount: document.querySelectorAll('table').length
          }
        };
      output: "${params.output_dir}/extraction-summary.json"
    
    - name: log-completion
      action: log
      message: "Data extraction completed. Results saved to ${params.output_dir}"