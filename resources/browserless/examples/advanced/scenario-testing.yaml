workflow:
  name: "scenario-testing"
  description: "Test scenarios and applications with comprehensive browser automation"
  version: "1.0.0"
  
  parameters:
    scenario_name:
      type: string
      required: false
      description: "Name of scenario to test"
      default: ""
    base_url:
      type: string
      required: false  
      description: "Base URL if testing external site"
      default: ""
    output_dir:
      type: string
      required: false
      description: "Directory for test outputs"
      default: "./test-results"
  
  steps:
    # Navigate to scenario or URL
    - name: navigate-to-target
      action: if
      condition: "${params.scenario_name} !== ''"
      then:
        - name: navigate-to-scenario
          action: navigate_to_scenario
          scenario: "${params.scenario_name}"
          port_type: UI_PORT
      else:
        - name: navigate-to-url
          action: navigate
          url: "${params.base_url}"
    
    # Wait for page to load
    - name: wait-for-page
      action: wait_for_element
      selector: "body"
      timeout: 10
    
    # Take initial screenshot
    - name: capture-initial-state
      action: screenshot_full_page
      path: "${params.output_dir}/initial-full-page.png"
    
    # Extract page information
    - name: extract-title
      action: extract_text
      selector: "title, h1"
      variable: page_title
      output: "${params.output_dir}/page-title.txt"
    
    # Check for common UI elements
    - name: check-navigation
      action: element_exists
      selector: "nav, [role='navigation'], .navigation, #navigation"
      variable: has_navigation
    
    - name: check-forms
      action: evaluate
      script: |
        const forms = document.querySelectorAll('form');
        return {
          count: forms.length,
          ids: Array.from(forms).map(f => f.id || 'unnamed')
        };
      variable: form_info
      output: "${params.output_dir}/forms.json"
    
    # Test form interaction if forms exist
    - name: test-first-form
      action: if
      condition: "${form_info.count} > 0"
      then:
        - name: find-inputs
          action: evaluate
          script: |
            const inputs = document.querySelectorAll('form:first-of-type input:not([type="hidden"])');
            return Array.from(inputs).map(i => ({
              name: i.name,
              type: i.type,
              id: i.id,
              required: i.required
            }));
          output: "${params.output_dir}/form-inputs.json"
    
    # Extract all links
    - name: extract-links
      action: evaluate
      script: |
        const links = document.querySelectorAll('a[href]');
        return Array.from(links).map(a => ({
          text: a.textContent.trim(),
          href: a.href,
          target: a.target
        }));
      output: "${params.output_dir}/links.json"
    
    # Check for interactive elements
    - name: find-buttons
      action: evaluate  
      script: |
        const buttons = document.querySelectorAll('button, input[type="submit"], input[type="button"]');
        return {
          count: buttons.length,
          buttons: Array.from(buttons).slice(0, 10).map(b => ({
            text: b.textContent || b.value,
            id: b.id,
            type: b.type,
            disabled: b.disabled
          }))
        };
      output: "${params.output_dir}/buttons.json"
    
    # Test first button if exists
    - name: test-button-interaction
      action: if
      condition: "${buttons.count} > 0 && !${buttons.buttons[0].disabled}"
      then:
        - name: click-first-button
          action: click
          selector: "button:first-of-type, input[type='submit']:first-of-type"
          on_error: continue
        
        - name: wait-for-response
          action: wait
          duration: 2000
        
        - name: capture-after-click
          action: screenshot_full_page
          path: "${params.output_dir}/after-button-click.png"
    
    # Generate test report
    - name: generate-report
      action: evaluate
      script: |
        return {
          timestamp: new Date().toISOString(),
          url: window.location.href,
          title: document.title,
          viewport: {
            width: window.innerWidth,
            height: window.innerHeight
          },
          performance: {
            loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart,
            domReady: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart
          },
          elements: {
            images: document.querySelectorAll('img').length,
            scripts: document.querySelectorAll('script').length,
            styles: document.querySelectorAll('link[rel="stylesheet"], style').length
          },
          accessibility: {
            hasLangAttribute: document.documentElement.hasAttribute('lang'),
            headingsCount: document.querySelectorAll('h1, h2, h3, h4, h5, h6').length,
            altTextImages: document.querySelectorAll('img[alt]').length
          }
        };
      output: "${params.output_dir}/test-report.json"
    
    # Log completion
    - name: log-completion
      action: log
      message: "Scenario testing completed. Results saved to ${params.output_dir}"