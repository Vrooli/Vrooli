workflow:
  name: "n8n-list-workflows-working"
  description: "List N8n workflows with working screenshots"
  version: "5.0.0"
  debug_level: "steps"
  enabled: true
    
  parameters:
    n8n_url:
      type: string
      default: "http://localhost:5678"
    include_inactive:
      type: boolean
      default: true

  steps:
    - name: "extract-workflows"
      action: "browser_script"
      script: |
        console.log('=== N8N WORKFLOWS EXTRACTION ===');
        
        // Navigate to workflows page
        const targetUrl = '${params.n8n_url}/workflows';
        console.log('Navigating to:', targetUrl);
        
        await page.goto(targetUrl, { 
          waitUntil: 'networkidle2',
          timeout: 30000 
        });
        
        // Wait for page to stabilize
        await page.waitForFunction(() => document.readyState === 'complete', { timeout: 10000 }).catch(() => {});
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        console.log('Current URL:', page.url());
        console.log('Page title:', await page.title());
        
        // Take screenshot
        const screenshotData = await page.screenshot({ 
          fullPage: true, 
          encoding: 'base64' 
        });
        console.log('Screenshot captured, length:', screenshotData.length);
        
        // Extract workflow data
        const extractionResult = await page.evaluate(() => {
          const currentUrl = window.location.href;
          const pageTitle = document.title;
          
          // Check if login is required
          const needsLogin = !!(
            document.querySelector('.login-form, input[type="email"], [data-test-id="signin-form"]') ||
            currentUrl.includes('/signin') ||
            currentUrl.includes('/login')
          );
          
          if (needsLogin) {
            return {
              needsLogin: true,
              currentUrl: currentUrl,
              pageTitle: pageTitle,
              workflows: [],
              message: 'Authentication required'
            };
          }
          
          // Look for workflow cards
          const selectors = [
            '.workflow-card',
            '[data-test-id="workflow-card"]',
            '.card',
            '[data-test-id="workflow"]'
          ];
          
          let cards = [];
          for (const selector of selectors) {
            const found = document.querySelectorAll(selector);
            if (found.length > 0) {
              cards = Array.from(found);
              break;
            }
          }
          
          const workflows = [];
          cards.forEach((card, index) => {
            const nameElement = card.querySelector('h1, h2, h3, .name, .title, [class*="name"]');
            const name = nameElement?.textContent?.trim() || '';
            
            const linkElement = card.querySelector('a');
            const href = linkElement?.href || '';
            const id = href.match(/workflow\/([^\/\?]+)/)?.[1] || name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            const active = card.textContent?.includes('Active') || false;
            
            if (name) {
              workflows.push({
                id: id,
                name: name,
                active: active,
                url: href || `${window.location.origin}/workflow/${id}`
              });
            }
          });
          
          return {
            needsLogin: false,
            workflows: workflows,
            total: workflows.length,
            currentUrl: currentUrl,
            pageTitle: pageTitle
          };
        });
        
        // Apply filtering
        const includeInactive = ${params.include_inactive};
        if (!includeInactive && extractionResult.workflows) {
          extractionResult.workflows = extractionResult.workflows.filter(w => w.active);
          extractionResult.total = extractionResult.workflows.length;
        }
        
        // Return final result with screenshot - NOTE: base64 data will be saved separately
        return {
          ...extractionResult,
          includeInactive: includeInactive,
          screenshotPath: '${context.outputDir}/n8n-workflows-page.png',
          screenshotData: screenshotData, // This will be removed by interpreter before saving
          debug: {
            screenshotLength: screenshotData.length,
            timestamp: new Date().toISOString()
          }
        };
      output: "${context.outputDir}/workflows-result.json"
      debug:
        console: true