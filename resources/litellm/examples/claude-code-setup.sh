#!/bin/bash
# Claude Code + LiteLLM Integration Setup
# This script configures Claude Code to use LiteLLM as an API gateway

set -e

echo "üîß Claude Code + LiteLLM Integration Setup"
echo "=========================================="
echo

# Configuration
LITELLM_URL="http://localhost:11435"
ENV_FILE="${var_ROOT_DIR}/data/litellm/config/.env"

# Check if LiteLLM is running
echo "Checking LiteLLM status..."
if ! resource-litellm test >/dev/null 2>&1; then
    echo "‚ùå LiteLLM is not running"
    echo "   Starting LiteLLM..."
    
    if resource-litellm start --verbose; then
        echo "‚úÖ LiteLLM started successfully"
        sleep 5  # Give it time to initialize
    else
        echo "‚ùå Failed to start LiteLLM"
        echo "   Please install first: resource-litellm install"
        exit 1
    fi
else
    echo "‚úÖ LiteLLM is running"
fi
echo

# Get master key
echo "Getting LiteLLM master key..."
if [[ ! -f "$ENV_FILE" ]]; then
    echo "‚ùå Environment file not found: $ENV_FILE"
    exit 1
fi

MASTER_KEY=$(grep "LITELLM_MASTER_KEY=" "$ENV_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d '"' || echo "")

if [[ -z "$MASTER_KEY" ]]; then
    echo "‚ùå Master key not found in environment file"
    exit 1
fi
echo "‚úÖ Master key obtained"
echo

# Set up environment variables
echo "Setting up Claude Code environment variables..."

# Create or update .env file for Claude Code
CLAUDE_ENV_FILE="$HOME/.claude_code_env"

cat > "$CLAUDE_ENV_FILE" <<EOF
# Claude Code + LiteLLM Integration
# Generated by claude-code-setup.sh on $(date)

# Route Claude Code through LiteLLM proxy
export ANTHROPIC_BASE_URL="$LITELLM_URL"
export ANTHROPIC_AUTH_TOKEN="$MASTER_KEY"

# Optional: Set default model (if you want to override)
# export ANTHROPIC_MODEL="gpt-3.5-turbo"
# export ANTHROPIC_SMALL_FAST_MODEL="claude-3-haiku"

# LiteLLM-specific headers (optional)
export ANTHROPIC_CUSTOM_HEADERS="x-litellm-user-id: claude-code"
EOF

echo "‚úÖ Environment file created: $CLAUDE_ENV_FILE"
echo

# Add to shell profile
echo "Adding to shell profile..."
SHELL_PROFILE=""

if [[ -f "$HOME/.bashrc" ]]; then
    SHELL_PROFILE="$HOME/.bashrc"
elif [[ -f "$HOME/.zshrc" ]]; then
    SHELL_PROFILE="$HOME/.zshrc"
elif [[ -f "$HOME/.profile" ]]; then
    SHELL_PROFILE="$HOME/.profile"
fi

if [[ -n "$SHELL_PROFILE" ]]; then
    # Check if already added
    if ! grep -q "claude_code_env" "$SHELL_PROFILE"; then
        echo "" >> "$SHELL_PROFILE"
        echo "# Claude Code + LiteLLM Integration" >> "$SHELL_PROFILE"
        echo "source \"$CLAUDE_ENV_FILE\"" >> "$SHELL_PROFILE"
        echo "‚úÖ Added to shell profile: $SHELL_PROFILE"
    else
        echo "‚úÖ Already added to shell profile"
    fi
else
    echo "‚ö†Ô∏è  Could not detect shell profile"
    echo "   Please manually add: source \"$CLAUDE_ENV_FILE\""
fi
echo

# Source the environment for current session
echo "Loading environment for current session..."
source "$CLAUDE_ENV_FILE"
echo "‚úÖ Environment loaded"
echo

# Test the configuration
echo "Testing Claude Code integration..."

# Check if claude command is available
if ! command -v claude >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Claude Code CLI not found"
    echo "   Please install Claude Code first"
    echo "   The environment is set up and ready to use"
else
    echo "Testing Claude Code with LiteLLM..."
    
    # Create a simple test
    TEST_OUTPUT=$(timeout 30 claude "Say 'Hello from LiteLLM!' in exactly 5 words" 2>&1 || echo "TIMEOUT_OR_ERROR")
    
    if [[ "$TEST_OUTPUT" =~ "Hello from LiteLLM" ]] || [[ "$TEST_OUTPUT" =~ "Hello" ]]; then
        echo "‚úÖ Claude Code integration test successful!"
        echo "   Response: $TEST_OUTPUT"
    elif [[ "$TEST_OUTPUT" == "TIMEOUT_OR_ERROR" ]]; then
        echo "‚ö†Ô∏è  Test timed out or errored (this might be normal if no API keys are configured)"
    else
        echo "‚ö†Ô∏è  Test response: $TEST_OUTPUT"
        echo "   Integration may work but needs API keys configured"
    fi
fi
echo

# Show current configuration
echo "üìã Current Configuration"
echo "======================="
echo "LiteLLM URL: $ANTHROPIC_BASE_URL"
echo "Auth Token: ${ANTHROPIC_AUTH_TOKEN:0:20}..." 
echo "Custom Headers: ${ANTHROPIC_CUSTOM_HEADERS:-none}"
echo "Model Override: ${ANTHROPIC_MODEL:-default}"
echo "Fast Model: ${ANTHROPIC_SMALL_FAST_MODEL:-default}"
echo

# Show next steps
echo "üéâ Setup Complete!"
echo "================="
echo
echo "Next Steps:"
echo "1. Configure API keys for your providers:"
echo "   ‚Ä¢ Edit: $ENV_FILE"
echo "   ‚Ä¢ Or use Vault: vault kv put secret/vrooli/openai api_key='sk-...'"
echo
echo "2. Test LiteLLM models:"
echo "   ‚Ä¢ resource-litellm list-models"
echo "   ‚Ä¢ resource-litellm test-model gpt-3.5-turbo"
echo
echo "3. Start using Claude Code:"
echo "   ‚Ä¢ claude 'Generate a Python hello world script'"
echo "   ‚Ä¢ Your requests will be routed through LiteLLM!"
echo
echo "4. Monitor usage:"
echo "   ‚Ä¢ resource-litellm status-detailed"
echo "   ‚Ä¢ resource-litellm logs --follow"
echo
echo "5. Customize routing (optional):"
echo "   ‚Ä¢ resource-litellm content add --type config --file custom-config.yaml"
echo "   ‚Ä¢ resource-litellm content execute --type config --name custom"
echo

# Show how to disable integration
echo "To disable this integration:"
echo "‚Ä¢ Comment out the source line in $SHELL_PROFILE"
echo "‚Ä¢ Or unset the environment variables:"
echo "  unset ANTHROPIC_BASE_URL ANTHROPIC_AUTH_TOKEN"
echo

echo "For help: resource-litellm help"