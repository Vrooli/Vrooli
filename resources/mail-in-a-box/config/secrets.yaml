# Mail-in-a-Box Resource Secrets Declaration
# Follows Vrooli Secrets Standard v1.0

version: "1.0"
resource: "mail-in-a-box"
description: "Credentials, TLS material, and bootstrap configuration for the Mail-in-a-Box (docker-mailserver) resource"

secrets:
  admin:
    - name: "admin_email"
      path: "secret/resources/mail-in-a-box/admin/email"
      description: "Primary administrator mailbox (used for SMTP/IMAP login and HTTP basic auth)"
      required: true
      format: "email"
      default_env: "MAILINABOX_ADMIN_EMAIL"
      example: "admin@example.com"
      validation:
        pattern: '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'
    - name: "admin_password"
      path: "secret/resources/mail-in-a-box/admin/password"
      description: "Password for the administrator mailbox and API basic auth"
      required: true
      format: "password"
      default_env: "MAILINABOX_ADMIN_PASSWORD"
      example: "CorrectHorseBattery#2025"
      validation:
        min_length: 12
        pattern: '^[\x21-\x7E]+$'
  smtp:
    - name: "primary_hostname"
      path: "secret/resources/mail-in-a-box/config/primary-hostname"
      description: "Public hostname that points at this mail server (e.g. mail.example.com)"
      required: true
      format: "hostname"
      default_env: "MAILINABOX_PRIMARY_HOSTNAME"
      example: "mail.example.com"
    - name: "postmaster_alias"
      path: "secret/resources/mail-in-a-box/config/postmaster-alias"
      description: "Mailbox that should receive postmaster@ and abuse@ messages (defaults to admin email if unset)"
      required: false
      format: "email"
      default_env: "MAILINABOX_POSTMASTER_ALIAS"
      example: "support@example.com"
    - name: "default_mailbox"
      path: "secret/resources/mail-in-a-box/mailboxes/default"
      description: "Optional mailbox to bootstrap alongside the administrator account"
      required: false
      format: "credential_pair"
      fields:
        - email: "MAILINABOX_DEFAULT_MAILBOX"
        - password: "MAILINABOX_DEFAULT_MAILBOX_PASSWORD"
      example: "hello@example.com,SuperSecretPass!2025"
      validation:
        pattern: '^[^,]+,[^,]+$'
  tls:
    - name: "certificate_bundle"
      path: "secret/resources/mail-in-a-box/ssl/certificate"
      description: "TLS certificate bundle for SMTP/IMAP/HTTPS. Leave unset to use self-signed certificates."
      required: false
      format: "pem_bundle"
      default_env: "MAILINABOX_SSL_CERT_BUNDLE"
      fields:
        - cert: "MAILINABOX_SSL_CERT"
        - key: "MAILINABOX_SSL_KEY"
        - chain: "MAILINABOX_SSL_CHAIN"
      links:
        - label: "Let's Encrypt wildcard guide"
          url: "https://letsencrypt.org/docs/wildcard/"
  dkim:
    - name: "dkim_private_key"
      path: "secret/resources/mail-in-a-box/dkim/private"
      description: "DKIM private key for signing outbound messages (auto-generated if missing)"
      required: false
      format: "rsa_private_key"
      default_env: "MAILINABOX_DKIM_PRIVATE_KEY"
      auto_generate: true
      regenerate: "yearly"

dependencies:
  - resource: "vault"
    secrets: ["token"]
    purpose: "Secure storage of mailbox credentials and TLS assets"

initialization:
  auto_generate:
    - name: "dkim_private_key"
      type: "rsa"
      path: "secret/resources/mail-in-a-box/dkim/private"
      bits: 2048
  prompt_user:
    - name: "admin_email"
      prompt: |
        Enter the administrator mailbox (e.g. admin@example.com). This account will be created automatically and reused for webmail, SMTP submission, and API basic auth.
      validation: "Must be a valid mailbox on the domain you plan to host."
      optional: false
    - name: "admin_password"
      prompt: |
        Paste a strong password (12+ characters with symbols) for the administrator mailbox. Store it in Vault so agents can authenticate automatically.
      validation: "Password must meet strength requirements and allow IMAP login."
      optional: false
    - name: "primary_hostname"
      prompt: |
        Provide the public hostname that will resolve to this server (e.g. mail.example.com). Make sure DNS A/AAAA records already point here.
      validation: "Valid DNS hostname that resolves to this instance."
      optional: false
    - name: "default_mailbox"
      prompt: |
        (Optional) Provide another mailbox to create automatically in the format user@example.com,password. Leave blank to skip.
      validation: "Value must be either blank or email,password."
      optional: true

health_check:
  endpoint: "/health"
  port: 25
  required_secrets: ["admin_email", "admin_password", "primary_hostname"]
  optional_secrets: ["default_mailbox", "certificate_bundle", "dkim_private_key"]

security:
  recommendations:
    - "Rotate mailbox passwords regularly and store them in Vault."
    - "Issue valid TLS certificates or enable automatic Letâ€™s Encrypt provisioning."
    - "Publish SPF, DKIM, and DMARC records for every hosted domain."
    - "Restrict SMTP submission to authenticated users and monitor brute-force attempts."
  sensitive_paths:
    - "/var/mail"
    - "/tmp/docker-mailserver"
    - "/etc/letsencrypt"
