# Mail-in-a-Box Resource Secrets Declaration
# Follows Vrooli Secrets Standard v1.0

version: "1.0"
resource: "mail-in-a-box"
description: "Email server credentials and API keys for Mail-in-a-Box"

# Secrets organized by category
secrets:
  # Admin Authentication
  admin:
    - name: "admin_password"
      path: "secret/resources/mail-in-a-box/admin/password"
      description: "Administrator password for Mail-in-a-Box admin panel"
      required: true
      format: "string"
      validation:
        min_length: 8
        pattern: "^[A-Za-z0-9!@#$%^&*()_+=-]+$"
      default_env: "MAILINABOX_ADMIN_PASSWORD"
      example: "SecureAdminPass123!"
    
    - name: "admin_email"
      path: "secret/resources/mail-in-a-box/admin/email"
      description: "Administrator email address"
      required: true
      format: "email"
      default_env: "MAILINABOX_ADMIN_EMAIL"
      default: "admin@mail.local"
      example: "admin@example.com"
  
  # API Authentication
  api_keys:
    - name: "api_key"
      path: "secret/resources/mail-in-a-box/api/key"
      description: "API key for administrative operations"
      required: false
      format: "string"
      default_env: "MAILINABOX_API_KEY"
      ttl: "90d"
      renewable: true
      auto_generate: true
  
  # SMTP Authentication
  smtp:
    - name: "smtp_relay_password"
      path: "secret/resources/mail-in-a-box/smtp/relay"
      description: "Password for SMTP relay if using external smarthost"
      required: false
      format: "string"
      default_env: "SMTP_RELAY_PASSWORD"
      fields:
        - host: "smtp_relay_host"
        - port: "smtp_relay_port"
        - username: "smtp_relay_user"
        - password: "smtp_relay_pass"
  
  # DKIM Keys
  dkim:
    - name: "dkim_private_key"
      path: "secret/resources/mail-in-a-box/dkim/private"
      description: "DKIM private key for email signing"
      required: false
      format: "rsa_private_key"
      auto_generate: true
      regenerate: "yearly"
  
  # SSL Certificates
  certificates:
    - name: "ssl_certificate"
      path: "secret/resources/mail-in-a-box/ssl/cert"
      description: "SSL certificate for HTTPS/TLS"
      required: false
      format: "pem"
      default_env: "SSL_CERTIFICATE"
      fields:
        - cert: "ssl_cert"
        - key: "ssl_key"
        - chain: "ssl_chain"
  
  # Database Credentials (optional external DB)
  database:
    - name: "postgres_url"
      path: "secret/resources/mail-in-a-box/db/postgres"
      description: "Optional PostgreSQL for advanced mail storage"
      required: false
      format: "string"
      default_env: "DATABASE_URL"
      fallback: "env:DATABASE_URL"
      example: "postgresql://user:pass@localhost/maildb"

# Dependencies on other resource secrets
dependencies:
  - resource: "postgres"
    secrets: ["connection_string"]
    purpose: "Optional external database for mail storage"
    required: false
  
  - resource: "vault"
    secrets: ["token"]
    purpose: "Secure storage of email credentials"
    required: false

# Initialization configuration
initialization:
  # Secrets that can be auto-generated
  auto_generate:
    - name: "api_key"
      type: "api_key"
      path: "secret/resources/mail-in-a-box/api/key"
      length: 32
    
    - name: "dkim_key"
      type: "rsa"
      path: "secret/resources/mail-in-a-box/dkim/private"
      bits: 2048
  
  # Secrets that need user input
  prompt_user:
    - name: "admin_password"
      prompt: |
        Enter a secure password for the Mail-in-a-Box admin account.
        Requirements: Minimum 8 characters, alphanumeric + special chars
      validation: "Password strength check"
      optional: false
    
    - name: "primary_domain"
      prompt: |
        Enter the primary domain for your mail server (e.g., example.com)
        This will be used for the mail server hostname
      validation: "Valid domain format"
      optional: false

# Health check configuration
health_check:
  endpoint: "/health"
  port: 8543
  required_secrets: ["admin_password", "admin_email"]
  optional_secrets: ["api_key", "ssl_certificate"]
  
# Security notes
security:
  recommendations:
    - "Use strong passwords for all email accounts"
    - "Enable 2FA for admin panel access when available"
    - "Configure SPF, DKIM, and DMARC for all domains"
    - "Use proper SSL certificates in production"
    - "Regularly rotate API keys and passwords"
    - "Monitor for unauthorized access attempts"
  
  sensitive_paths:
    - "/var/lib/mailinabox/ssl"
    - "/var/lib/mailinabox/dkim"
    - "/var/lib/mailinabox/mail"
    - "/etc/postfix/sasl_passwd"