version: '3.8'

services:
  mail:
    image: mailserver/docker-mailserver:latest
    container_name: mailinabox
    hostname: mail.local
    env_file: ./config/mailserver.env
    ports:
      - "127.0.0.1:25:25"
      - "127.0.0.1:587:587"
      - "127.0.0.1:993:993"
      - "127.0.0.1:995:995"
    volumes:
      - maildata:/var/mail
      - mailconfig:/tmp/docker-mailserver
      - mailssl:/etc/letsencrypt
      - /etc/localtime:/etc/localtime:ro
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
    networks:
      - mailnet
    healthcheck:
      test: ["CMD", "ss", "-ltn", "|", "grep", ":25"]
      interval: 30s
      timeout: 5s
      retries: 3

  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: mailinabox-webmail
    depends_on:
      - mail
    ports:
      - "127.0.0.1:8080:80"
    environment:
      - ROUNDCUBEMAIL_DEFAULT_HOST=ssl://mail
      - ROUNDCUBEMAIL_DEFAULT_PORT=993
      - ROUNDCUBEMAIL_SMTP_SERVER=mail
      - ROUNDCUBEMAIL_SMTP_PORT=587
      - ROUNDCUBEMAIL_UPLOAD_MAX_FILESIZE=50M
      - ROUNDCUBEMAIL_DB_TYPE=sqlite
      - ROUNDCUBEMAIL_DB_DIR=/var/roundcube/db
      - ROUNDCUBEMAIL_SKIN=elastic
    volumes:
      - roundcube_db:/var/roundcube/db
      - roundcube_config:/var/www/html/config
    restart: unless-stopped
    networks:
      - mailnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3

  radicale:
    image: tomsquest/docker-radicale:latest
    container_name: mailinabox-caldav
    ports:
      - "127.0.0.1:5232:5232"
    environment:
      - RADICALE_SERVER_HOSTS=0.0.0.0:5232
      - RADICALE_AUTH_TYPE=htpasswd
      - RADICALE_AUTH_HTPASSWD_FILENAME=/data/users
      - RADICALE_AUTH_HTPASSWD_ENCRYPTION=bcrypt
      - RADICALE_RIGHTS_TYPE=owner_only
      - RADICALE_STORAGE_FILESYSTEM_FOLDER=/data/collections
      - RADICALE_LOGGING_LEVEL=info
    volumes:
      - radicale_data:/data
      - radicale_config:/config:ro
    restart: unless-stopped
    networks:
      - mailnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5232/.web/"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  mailnet:
    driver: bridge

volumes:
  maildata:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_DATA_DIR:-/var/lib/mailinabox}/mail
  mailconfig:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_CONFIG_DIR:-/var/lib/mailinabox}/config
  mailssl:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_DATA_DIR:-/var/lib/mailinabox}/ssl
  roundcube_db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_DATA_DIR:-/var/lib/mailinabox}/roundcube/db
  roundcube_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_DATA_DIR:-/var/lib/mailinabox}/roundcube/config
  radicale_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_DATA_DIR:-/var/lib/mailinabox}/radicale/data
  radicale_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAILINABOX_CONFIG_DIR:-/var/lib/mailinabox}/radicale/config