# Home Assistant Resource Secrets Declaration
# Follows Vrooli Secrets Standard v1.0

version: "1.0"
resource: "home-assistant"
description: "Authentication tokens and API keys for Home Assistant integrations"

# Secrets organized by category
secrets:
  # API Authentication
  api_keys:
    - name: "long_lived_token"
      path: "secret/resources/home-assistant/api/token"
      description: "Long-lived access token for API authentication"
      required: false
      format: "string"
      validation:
        pattern: "^[A-Za-z0-9._-]+$"
      default_env: "HOME_ASSISTANT_TOKEN"
      example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
    
    - name: "webhook_secret"
      path: "secret/resources/home-assistant/webhooks/secret"
      description: "Secret for validating incoming webhooks"
      required: false
      format: "string"
      default_env: "HOME_ASSISTANT_WEBHOOK_SECRET"
      ttl: "90d"
      renewable: true
  
  # Integration Tokens
  tokens:
    - name: "github_token"
      path: "secret/resources/home-assistant/tokens/github"
      description: "GitHub token for HACS and updates"
      required: false
      format: "string"
      default_env: "GITHUB_TOKEN"
      fallback: "env:GITHUB_TOKEN"
    
    - name: "openweathermap_key"
      path: "secret/resources/home-assistant/integrations/openweathermap"
      description: "OpenWeatherMap API key for weather data"
      required: false
      format: "string"
      validation:
        pattern: "^[a-f0-9]{32}$"
      default_env: "OPENWEATHERMAP_API_KEY"
  
  # Database Credentials (for recorder)
  database:
    - name: "postgres_url"
      path: "secret/resources/home-assistant/db/postgres"
      description: "PostgreSQL connection URL for recorder backend"
      required: false
      format: "string"
      default_env: "HOME_ASSISTANT_RECORDER_DB_URL"
      fallback: "env:DATABASE_URL"
      example: "postgresql://user:pass@localhost/homeassistant"
  
  # MQTT Credentials
  mqtt:
    - name: "mqtt_password"
      path: "secret/resources/home-assistant/mqtt/password"
      description: "MQTT broker password for device communication"
      required: false
      format: "string"
      default_env: "MQTT_PASSWORD"
      fields:
        - username: "mqtt_user"
        - password: "mqtt_pass"
        - broker: "mqtt_host"

# Dependencies on other resource secrets
dependencies:
  - resource: "postgres"
    secrets: ["connection_string"]
    purpose: "Recorder backend for history storage"
  
  - resource: "redis"
    secrets: ["connection_url"]
    purpose: "Session and cache management"

# Initialization configuration
initialization:
  # Secrets that can be auto-generated
  auto_generate:
    - name: "internal_api_token"
      type: "jwt"
      path: "secret/resources/home-assistant/internal/token"
      length: 256
    
    - name: "webhook_id"
      type: "uuid"
      path: "secret/resources/home-assistant/webhooks/id"
  
  # Secrets that need user input
  prompt_user:
    - name: "long_lived_token"
      prompt: |
        To create a long-lived access token:
        1. Start Home Assistant
        2. Navigate to http://localhost:8123
        3. Go to Profile -> Security -> Long-Lived Access Tokens
        4. Create a new token and paste it here
      validation: "Test API call with token"
      optional: true

# Health check configuration
health_check:
  endpoint: "/api/"
  # No required secrets - Home Assistant can run without authentication
  required_secrets: []
  optional_secrets: ["long_lived_token"]
  
# Security notes
security:
  recommendations:
    - "Always use HTTPS in production environments"
    - "Rotate long-lived tokens every 90 days"
    - "Use separate tokens for different integrations"
    - "Enable multi-factor authentication for admin users"
  
  sensitive_paths:
    - "/config/.storage/auth"
    - "/config/secrets.yaml"
    - "/config/.cloud"