{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://vrooli.com/schemas/serve.schema.json",
  "title": "Service Deployment Schema",
  "description": "Schema for service deployment, monitoring, and scaling configuration",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string"
    },
    "version": {
      "$ref": "common.schema.json#/definitions/semver"
    },
    "deployment": {
      "$ref": "#/definitions/deploymentConfig"
    },
    "monitoring": {
      "$ref": "#/definitions/monitoringConfig"
    },
    "scaling": {
      "$ref": "#/definitions/scalingConfig"
    },
    "networking": {
      "$ref": "#/definitions/networkingConfig"
    },
    "observability": {
      "$ref": "#/definitions/observabilityConfig"
    },
    "resilience": {
      "$ref": "#/definitions/resilienceConfig"
    }
  },
  "definitions": {
    "deploymentConfig": {
      "type": "object",
      "properties": {
        "targets": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/deploymentTarget"
          }
        },
        "strategy": {
          "$ref": "#/definitions/deploymentStrategy"
        },
        "artifacts": {
          "$ref": "#/definitions/artifactConfig"
        },
        "manifests": {
          "$ref": "#/definitions/manifestConfig"
        },
        "rollout": {
          "$ref": "#/definitions/rolloutConfig"
        }
      }
    },
    "deploymentTarget": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["local", "docker", "docker-compose", "kubernetes", "ecs", "lambda", "cloud-run", "app-engine", "heroku", "vercel", "netlify"]
        },
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "environment": {
          "type": "string",
          "enum": ["development", "testing", "staging", "production"]
        },
        "region": {
          "type": "string"
        },
        "cluster": {
          "type": "string"
        },
        "namespace": {
          "type": "string"
        },
        "credentials": {
          "$ref": "common.schema.json#/definitions/secretRef"
        },
        "configuration": {
          "type": "object"
        }
      },
      "required": ["type", "environment"]
    },
    "deploymentStrategy": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["recreate", "rolling-update", "blue-green", "canary", "a-b-testing", "feature-flags"],
          "default": "rolling-update"
        },
        "rollingUpdate": {
          "type": "object",
          "properties": {
            "maxSurge": {
              "oneOf": [
                { "type": "integer" },
                { "type": "string", "pattern": "^\\d+%$" }
              ]
            },
            "maxUnavailable": {
              "oneOf": [
                { "type": "integer" },
                { "type": "string", "pattern": "^\\d+%$" }
              ]
            }
          }
        },
        "blueGreen": {
          "type": "object",
          "properties": {
            "trafficSwitchDelay": {
              "$ref": "common.schema.json#/definitions/duration"
            },
            "scaleDownDelay": {
              "$ref": "common.schema.json#/definitions/duration"
            }
          }
        },
        "canary": {
          "type": "object",
          "properties": {
            "steps": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "weight": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100
                  },
                  "duration": {
                    "$ref": "common.schema.json#/definitions/duration"
                  },
                  "analysis": {
                    "$ref": "#/definitions/analysisConfig"
                  }
                },
                "required": ["weight"]
              }
            }
          }
        }
      }
    },
    "artifactConfig": {
      "type": "object",
      "properties": {
        "registry": {
          "type": "string"
        },
        "repository": {
          "type": "string"
        },
        "tag": {
          "type": "string"
        },
        "digest": {
          "type": "string"
        },
        "pullPolicy": {
          "type": "string",
          "enum": ["Always", "IfNotPresent", "Never"],
          "default": "IfNotPresent"
        },
        "credentials": {
          "$ref": "common.schema.json#/definitions/secretRef"
        }
      }
    },
    "manifestConfig": {
      "type": "object",
      "properties": {
        "templates": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": {
                "$ref": "common.schema.json#/definitions/path"
              },
              "engine": {
                "type": "string",
                "enum": ["helm", "kustomize", "jsonnet", "jinja2", "go-template"]
              },
              "values": {
                "type": "object"
              }
            }
          }
        },
        "overlays": {
          "type": "object",
          "additionalProperties": {
            "type": "object"
          }
        }
      }
    },
    "rolloutConfig": {
      "type": "object",
      "properties": {
        "automated": {
          "type": "boolean",
          "default": false
        },
        "pauseDuration": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "progressDeadline": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "revisionHistoryLimit": {
          "type": "integer",
          "default": 10
        }
      }
    },
    "monitoringConfig": {
      "type": "object",
      "properties": {
        "metrics": {
          "$ref": "#/definitions/metricsConfig"
        },
        "logging": {
          "$ref": "#/definitions/loggingConfig"
        },
        "tracing": {
          "$ref": "#/definitions/tracingConfig"
        },
        "profiling": {
          "$ref": "#/definitions/profilingConfig"
        },
        "alerts": {
          "$ref": "#/definitions/alertConfig"
        },
        "dashboards": {
          "$ref": "#/definitions/dashboardConfig"
        }
      }
    },
    "metricsConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "provider": {
          "type": "string",
          "enum": ["prometheus", "datadog", "newrelic", "cloudwatch", "stackdriver", "azure-monitor"]
        },
        "endpoint": {
          "$ref": "common.schema.json#/definitions/url"
        },
        "interval": {
          "$ref": "common.schema.json#/definitions/duration",
          "default": "30s"
        },
        "custom": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/customMetric"
          }
        },
        "exporters": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/metricExporter"
          }
        }
      }
    },
    "loggingConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "level": {
          "type": "string",
          "enum": ["trace", "debug", "info", "warn", "error", "fatal"],
          "default": "info"
        },
        "format": {
          "type": "string",
          "enum": ["json", "text", "structured"],
          "default": "json"
        },
        "outputs": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/loggingOutput"
          }
        },
        "aggregation": {
          "type": "object",
          "properties": {
            "provider": {
              "type": "string",
              "enum": ["elasticsearch", "loki", "splunk", "datadog", "cloudwatch", "stackdriver"]
            },
            "endpoint": {
              "$ref": "common.schema.json#/definitions/url"
            }
          }
        }
      }
    },
    "tracingConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "provider": {
          "type": "string",
          "enum": ["jaeger", "zipkin", "tempo", "datadog", "newrelic", "xray", "stackdriver"]
        },
        "endpoint": {
          "$ref": "common.schema.json#/definitions/url"
        },
        "samplingRate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.1
        },
        "propagation": {
          "type": "string",
          "enum": ["w3c", "jaeger", "b3", "baggage"],
          "default": "w3c"
        }
      }
    },
    "profilingConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "type": {
          "type": "string",
          "enum": ["cpu", "memory", "heap", "goroutine", "mutex", "block"],
          "default": "cpu"
        },
        "provider": {
          "type": "string",
          "enum": ["pprof", "pyflame", "async-profiler", "datadog", "newrelic"]
        },
        "interval": {
          "$ref": "common.schema.json#/definitions/duration",
          "default": "10s"
        },
        "duration": {
          "$ref": "common.schema.json#/definitions/duration",
          "default": "30s"
        }
      }
    },
    "alertConfig": {
      "type": "object",
      "properties": {
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/alertRule"
          }
        },
        "receivers": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/alertReceiver"
          }
        },
        "routing": {
          "$ref": "#/definitions/alertRouting"
        }
      }
    },
    "dashboardConfig": {
      "type": "object",
      "properties": {
        "provider": {
          "type": "string",
          "enum": ["grafana", "kibana", "datadog", "newrelic", "cloudwatch"]
        },
        "url": {
          "$ref": "common.schema.json#/definitions/url"
        },
        "templates": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "scalingConfig": {
      "type": "object",
      "properties": {
        "horizontal": {
          "$ref": "#/definitions/horizontalScaling"
        },
        "vertical": {
          "$ref": "#/definitions/verticalScaling"
        },
        "cluster": {
          "$ref": "#/definitions/clusterScaling"
        }
      }
    },
    "horizontalScaling": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "min": {
          "type": "integer",
          "minimum": 1,
          "default": 1
        },
        "max": {
          "type": "integer",
          "minimum": 1,
          "default": 10
        },
        "metrics": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/scalingMetric"
          }
        },
        "behavior": {
          "$ref": "#/definitions/scalingBehavior"
        }
      }
    },
    "verticalScaling": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "mode": {
          "type": "string",
          "enum": ["auto", "manual", "recommendation"],
          "default": "recommendation"
        },
        "resources": {
          "$ref": "common.schema.json#/definitions/resourceRequirements"
        }
      }
    },
    "clusterScaling": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "nodeGroups": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "min": {
                "type": "integer"
              },
              "max": {
                "type": "integer"
              },
              "instanceType": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "networkingConfig": {
      "type": "object",
      "properties": {
        "ingress": {
          "$ref": "#/definitions/ingressConfig"
        },
        "service": {
          "$ref": "#/definitions/serviceConfig"
        },
        "mesh": {
          "$ref": "#/definitions/serviceMeshConfig"
        },
        "cdn": {
          "$ref": "#/definitions/cdnConfig"
        },
        "loadBalancer": {
          "$ref": "#/definitions/loadBalancerConfig"
        }
      }
    },
    "ingressConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "className": {
          "type": "string"
        },
        "hosts": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "host": {
                "type": "string"
              },
              "paths": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "path": {
                      "type": "string"
                    },
                    "pathType": {
                      "type": "string",
                      "enum": ["Prefix", "Exact", "ImplementationSpecific"]
                    },
                    "backend": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "tls": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "hosts": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "secretName": {
                "type": "string"
              }
            }
          }
        },
        "annotations": {
          "$ref": "common.schema.json#/definitions/annotations"
        }
      }
    },
    "serviceConfig": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["ClusterIP", "NodePort", "LoadBalancer", "ExternalName"],
          "default": "ClusterIP"
        },
        "ports": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "port": {
                "$ref": "common.schema.json#/definitions/port"
              },
              "targetPort": {
                "$ref": "common.schema.json#/definitions/port"
              },
              "protocol": {
                "type": "string",
                "enum": ["TCP", "UDP", "SCTP"],
                "default": "TCP"
              }
            }
          }
        },
        "sessionAffinity": {
          "type": "string",
          "enum": ["None", "ClientIP"],
          "default": "None"
        }
      }
    },
    "serviceMeshConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "provider": {
          "type": "string",
          "enum": ["istio", "linkerd", "consul", "kuma", "traefik-mesh"]
        },
        "trafficManagement": {
          "type": "object",
          "properties": {
            "retries": {
              "type": "integer"
            },
            "timeout": {
              "$ref": "common.schema.json#/definitions/duration"
            },
            "circuitBreaker": {
              "$ref": "#/definitions/circuitBreakerConfig"
            }
          }
        },
        "security": {
          "type": "object",
          "properties": {
            "mtls": {
              "type": "boolean",
              "default": true
            },
            "authorization": {
              "type": "boolean",
              "default": false
            }
          }
        }
      }
    },
    "cdnConfig": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "provider": {
          "type": "string",
          "enum": ["cloudflare", "fastly", "cloudfront", "akamai", "bunny"]
        },
        "configuration": {
          "type": "object"
        }
      }
    },
    "loadBalancerConfig": {
      "type": "object",
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["round-robin", "least-connections", "ip-hash", "random", "weighted"],
          "default": "round-robin"
        },
        "healthCheck": {
          "$ref": "common.schema.json#/definitions/healthCheck"
        },
        "sessionPersistence": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "observabilityConfig": {
      "type": "object",
      "properties": {
        "slo": {
          "$ref": "#/definitions/sloConfig"
        },
        "sli": {
          "$ref": "#/definitions/sliConfig"
        },
        "errorBudget": {
          "$ref": "#/definitions/errorBudgetConfig"
        }
      }
    },
    "resilienceConfig": {
      "type": "object",
      "properties": {
        "circuitBreaker": {
          "$ref": "#/definitions/circuitBreakerConfig"
        },
        "retry": {
          "$ref": "#/definitions/retryConfig"
        },
        "timeout": {
          "$ref": "#/definitions/timeoutConfig"
        },
        "rateLimit": {
          "$ref": "#/definitions/rateLimitConfig"
        },
        "bulkhead": {
          "$ref": "#/definitions/bulkheadConfig"
        }
      }
    },
    "customMetric": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["counter", "gauge", "histogram", "summary"]
        },
        "labels": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "help": {
          "type": "string"
        }
      },
      "required": ["name", "type"]
    },
    "metricExporter": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string"
        },
        "endpoint": {
          "$ref": "common.schema.json#/definitions/url"
        },
        "interval": {
          "$ref": "common.schema.json#/definitions/duration"
        }
      }
    },
    "loggingOutput": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["stdout", "stderr", "file", "syslog", "http", "kafka"]
        },
        "format": {
          "type": "string"
        },
        "destination": {
          "type": "string"
        }
      }
    },
    "alertRule": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "expression": {
          "type": "string"
        },
        "duration": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"]
        },
        "annotations": {
          "type": "object"
        },
        "labels": {
          "type": "object"
        }
      },
      "required": ["name", "expression"]
    },
    "alertReceiver": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["email", "slack", "pagerduty", "webhook", "opsgenie"]
        },
        "config": {
          "type": "object"
        }
      },
      "required": ["name", "type"]
    },
    "alertRouting": {
      "type": "object",
      "properties": {
        "routes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "match": {
                "type": "object"
              },
              "receiver": {
                "type": "string"
              },
              "continue": {
                "type": "boolean"
              }
            }
          }
        },
        "defaultReceiver": {
          "type": "string"
        }
      }
    },
    "scalingMetric": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["cpu", "memory", "custom", "external"]
        },
        "target": {
          "type": "number"
        },
        "name": {
          "type": "string"
        }
      },
      "required": ["type", "target"]
    },
    "scalingBehavior": {
      "type": "object",
      "properties": {
        "scaleUp": {
          "$ref": "#/definitions/scalingPolicy"
        },
        "scaleDown": {
          "$ref": "#/definitions/scalingPolicy"
        }
      }
    },
    "scalingPolicy": {
      "type": "object",
      "properties": {
        "stabilizationWindow": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "policies": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["Pods", "Percent"]
              },
              "value": {
                "type": "integer"
              },
              "periodSeconds": {
                "type": "integer"
              }
            }
          }
        }
      }
    },
    "analysisConfig": {
      "type": "object",
      "properties": {
        "metrics": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "query": {
                "type": "string"
              },
              "successCriteria": {
                "type": "string"
              }
            }
          }
        },
        "failureLimit": {
          "type": "integer"
        }
      }
    },
    "sloConfig": {
      "type": "object",
      "properties": {
        "objectives": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "target": {
                "type": "number",
                "minimum": 0,
                "maximum": 100
              },
              "window": {
                "$ref": "common.schema.json#/definitions/duration"
              }
            }
          }
        }
      }
    },
    "sliConfig": {
      "type": "object",
      "properties": {
        "indicators": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "query": {
                "type": "string"
              },
              "unit": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "errorBudgetConfig": {
      "type": "object",
      "properties": {
        "threshold": {
          "type": "number"
        },
        "action": {
          "type": "string",
          "enum": ["alert", "throttle", "block"]
        }
      }
    },
    "circuitBreakerConfig": {
      "type": "object",
      "properties": {
        "threshold": {
          "type": "integer",
          "default": 5
        },
        "timeout": {
          "$ref": "common.schema.json#/definitions/duration",
          "default": "30s"
        },
        "halfOpenRequests": {
          "type": "integer",
          "default": 1
        }
      }
    },
    "retryConfig": {
      "type": "object",
      "properties": {
        "attempts": {
          "type": "integer",
          "default": 3
        },
        "delay": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "maxDelay": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "backoff": {
          "type": "string",
          "enum": ["constant", "linear", "exponential"]
        }
      }
    },
    "timeoutConfig": {
      "type": "object",
      "properties": {
        "request": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "idle": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "keepAlive": {
          "$ref": "common.schema.json#/definitions/duration"
        }
      }
    },
    "rateLimitConfig": {
      "type": "object",
      "properties": {
        "requests": {
          "type": "integer"
        },
        "window": {
          "$ref": "common.schema.json#/definitions/duration"
        },
        "burst": {
          "type": "integer"
        }
      }
    },
    "bulkheadConfig": {
      "type": "object",
      "properties": {
        "maxConcurrency": {
          "type": "integer"
        },
        "maxQueueSize": {
          "type": "integer"
        }
      }
    }
  },
  "required": ["version", "deployment"]
}