syntax = "proto3";

package browser_automation_studio.v1;

import "google/protobuf/timestamp.proto";
import "buf/validate/validate.proto";
import "common/v1/types.proto";
import "browser-automation-studio/v1/base/shared.proto";
import "browser-automation-studio/v1/domain/telemetry.proto";
import "browser-automation-studio/v1/workflows/definition.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/browser-automation-studio/v1/execution;execution";

// =============================================================================
// EXECUTION RUNTIME STATE
// =============================================================================
//
// @layer 4
// @domain execution
// @imports base, domain (telemetry), workflows
// @stability stable
//
// This file defines the runtime state of workflow executions:
//   - ExecutionParameters: Typed runtime parameters for workflow execution
//   - ExecutionResult: Typed result data from completed executions
//   - Execution: The main execution entity returned by APIs
//   - Adhoc execution types for running workflows without persisting
//
// USAGE CONTEXTS:
//   - API: GET/POST /api/v1/executions/*
//   - WebSocket: Real-time execution status updates
//   - Database: Execution records persistence
//
// @see shared.proto ExecutionStatus for lifecycle states
// =============================================================================

// ExecutionParameters captures typed runtime parameters for workflow execution.
message ExecutionParameters {
  // Initial URL to start the execution (for workflows without a navigate step).
  optional string start_url = 1;
  // Variables to inject into the workflow (e.g., login credentials).
  // DEPRECATED: Use initial_store or initial_params instead.
  map<string, string> variables = 2;
  // Viewport dimensions override.
  optional int32 viewport_width = 3;
  optional int32 viewport_height = 4;
  // Reserved: field 5 was timeout_seconds (migrated to timeout_ms for consistency).
  reserved 5;
  // Run in headless mode override.
  optional bool headless = 6;
  // User agent override.
  optional string user_agent = 7;
  // Locale override (e.g., "en-US").
  optional string locale = 8;
  // Timeout override in milliseconds (default: 300000 = 5 minutes).
  optional int32 timeout_ms = 9;

  // =============================================================================
  // NAMESPACE-AWARE VARIABLE SUPPORT (Phase 2)
  // =============================================================================
  //
  // These fields support the namespace-aware interpolation system:
  // - @store/ : Mutable runtime state (initial_store -> setVariable/storeResult mutations)
  // - @params/: Read-only input parameters (initial_params)
  // - @env/   : Read-only environment configuration (env)
  //
  // Workflows reference these via ${@namespace/path} syntax with fallback support:
  // e.g., ${@params/timeout|@env/defaultTimeout|30000}

  // Absolute path to project root for workflowPath resolution.
  // Used to resolve relative paths like "actions/login.json".
  // Example: "/home/user/Vrooli/scenarios/my-scenario/bas"
  optional string project_root = 10;

  // Initial @params/ values - the workflow's input contract.
  // These are read-only within the workflow. Subflows inherit parent's params
  // unless the subflow call explicitly specifies override params.
  map<string, common.v1.JsonValue> initial_params = 11;

  // Initial @store/ values - pre-seeded runtime state.
  // These are mutable via setVariable steps and storeResult params.
  // Child subflows receive a copy and merge back on completion.
  map<string, common.v1.JsonValue> initial_store = 12;

  // Environment values - project/user configuration.
  // Read-only, inherited by all subflows unchanged.
  // Intended for project-wide settings like API endpoints, feature flags.
  map<string, common.v1.JsonValue> env = 13;
}

// ExecutionResult captures typed execution outcomes.
// Use this instead of map<string, JsonValue> result for type safety.
message ExecutionResult {
  // Whether the execution completed successfully.
  bool success = 1;
  // Number of steps executed.
  int32 steps_executed = 2;
  // Number of steps that failed.
  int32 steps_failed = 3;
  // Final URL after execution completed.
  optional string final_url = 4;
  // Error message if execution failed.
  optional string error = 5;
  // Error code for programmatic handling.
  optional string error_code = 6;
  // Extracted data from evaluate steps (variable name -> value).
  map<string, common.v1.JsonValue> extracted_data = 7;
  // Screenshots captured during execution (step_index -> artifact_id).
  map<int32, string> screenshot_artifacts = 8;
}

// TriggerMetadata captures contextual information about how an execution was triggered.
message TriggerMetadata {
  // User ID who initiated the execution (for manual triggers).
  // @format uuid
  optional string user_id = 1 [(buf.validate.field).string.uuid = true];
  // API client ID (for API triggers).
  // @format uuid
  optional string client_id = 2 [(buf.validate.field).string.uuid = true];
  // Schedule ID (for scheduled triggers).
  // @format uuid
  optional string schedule_id = 3 [(buf.validate.field).string.uuid = true];
  // Webhook ID (for webhook triggers).
  // @format uuid
  optional string webhook_id = 4 [(buf.validate.field).string.uuid = true];
  // External request ID for correlation with upstream systems.
  optional string external_request_id = 5;
  // Source IP address of the trigger request.
  optional string source_ip = 6;
  // User agent of the trigger request.
  optional string user_agent = 7;
}

// =============================================================================
// EXECUTION
// =============================================================================

// Execution is returned by GET /api/v1/executions/{id} and list APIs.
message Execution {
  // Unique execution identifier. JSON name preserved as "id" for backwards compatibility.
  // @format uuid
  string execution_id = 1 [json_name = "id"];
  // Workflow ID associated with this execution.
  // @format uuid
  string workflow_id = 2;
  // Version of the workflow used for this execution.
  int32 workflow_version = 3;
  // Current execution status.
  ExecutionStatus status = 4;
  // How the execution was triggered (manual, scheduled, api, webhook).
  TriggerType trigger_type = 5;
  // Reserved fields from migrations:
  // - 6: trigger_data (removed, migrated to trigger_metadata typed message)
  // - 7: source (removed, migrated to trigger_type enum)
  // - 12: result_data (removed, migrated to result typed message)
  // - 17: parameters map<string, JsonValue> (removed, migrated to ExecutionParameters)
  // - 18: result map<string, JsonValue> (removed, migrated to ExecutionResult)
  reserved 6, 7, 12, 17, 18;
  // When the execution started.
  google.protobuf.Timestamp started_at = 8;
  // When the execution completed (null if still running).
  optional google.protobuf.Timestamp completed_at = 9;
  // Last heartbeat received from the executor.
  google.protobuf.Timestamp last_heartbeat_at = 10;
  // Error message if the execution failed.
  optional string error = 11;
  // Progress percentage (0-100).
  int32 progress = 13;
  // Human-readable description of the current step.
  optional string current_step = 14;
  // Creation timestamp for the execution record.
  google.protobuf.Timestamp created_at = 15;
  // Last update timestamp for the execution record.
  google.protobuf.Timestamp updated_at = 16;
  // Typed runtime parameters for the execution.
  ExecutionParameters parameters = 20;
  // Typed execution result.
  ExecutionResult result = 21;
  // Trigger metadata (typed).
  TriggerMetadata trigger_metadata = 22;

  // Distributed tracing fields for observability.
  // Trace ID for distributed tracing (e.g., OpenTelemetry trace ID).
  optional string trace_id = 30;
  // Correlation ID for linking related operations across services.
  optional string correlation_id = 31;
  // Idempotency key for request deduplication.
  optional string request_id = 32;
}

// =============================================================================
// ADHOC EXECUTION
// =============================================================================

// ExecuteAdhocRequest represents POST /api/v1/workflows/execute-adhoc.
message ExecuteAdhocRequest {
  // Workflow definition to execute without persisting (V2 format).
  WorkflowDefinitionV2 flow_definition = 1;
  // Reserved: field 2 was 'flow_definition_v1' (migrated to flow_definition V2)
  // Reserved: field 5 was untyped parameters map (migrated to typed parameters)
  reserved 2, 5;
  // Whether to wait for completion before responding.
  bool wait_for_completion = 3;
  // Optional metadata for labeling the execution.
  ExecutionMetadata metadata = 4;
  // Typed runtime parameters for the adhoc execution.
  ExecutionParameters parameters = 6;
}

// ExecutionMetadata captures optional labels for adhoc runs.
message ExecutionMetadata {
  // Human-readable name for the adhoc execution.
  string name = 1;
  // Optional description for the adhoc execution.
  string description = 2;
}

// ExecuteAdhocResponse mirrors the adhoc execution response payload.
message ExecuteAdhocResponse {
  // The created execution identifier.
  // @format uuid
  string execution_id = 1;
  // Initial execution status.
  ExecutionStatus status = 2;
  // Workflow ID if persisted (null for adhoc).
  // @format uuid
  optional string workflow_id = 3 [(buf.validate.field).string.uuid = true];
  // Human-readable status message.
  string message = 4;
  // Completion timestamp when wait_for_completion is true (null if async or failed).
  optional google.protobuf.Timestamp completed_at = 5;
  // Error message when execution fails.
  optional string error = 6;
}

// =============================================================================
// SCREENSHOTS
// =============================================================================

// ExecutionScreenshot wraps TimelineScreenshot with execution context.
// This provides the canonical screenshot data plus execution-specific metadata.
message ExecutionScreenshot {
  // The screenshot data (canonical type from telemetry.proto).
  TimelineScreenshot screenshot = 1;
  // Zero-based step index in the execution.
  int32 step_index = 2;
  // Node ID from the workflow definition.
  // @format uuid
  string node_id = 3;
  // Human-readable step label (derived from action type/metadata).
  optional string step_label = 4;
  // When the screenshot was captured.
  google.protobuf.Timestamp timestamp = 5;
}

// GetScreenshotsResponse is returned by GET /api/v1/executions/{id}/screenshots.
message GetScreenshotsResponse {
  // Execution ID the screenshots belong to.
  // @format uuid
  string execution_id = 1;
  // List of screenshots with execution context.
  repeated ExecutionScreenshot screenshots = 2;
  // Total count of screenshots.
  int32 total = 3;
}

// =============================================================================
// EXPORT PREVIEW
// =============================================================================

// ExecutionExportPreview summarizes export readiness and metadata.
message ExecutionExportPreview {
  // Execution ID being exported.
  // @format uuid
  string execution_id = 1;
  // Identifier for the generated export spec.
  // @format uuid
  string spec_id = 2;
  // Status: ready, pending, error, unavailable.
  ExportStatus status = 3;
  // Human-readable message about readiness or errors.
  string message = 4;
  // Number of captured frames available for export.
  int32 captured_frame_count = 5;
  // Number of assets available for export (images, etc.).
  int32 available_asset_count = 6;
  // Total duration in milliseconds of the replay.
  int32 total_duration_ms = 7;
  // Reserved: field 8 was 'export_url' (replaced with package containing full spec)
  reserved 8;
  // Replay movie package.
  common.v1.JsonObject package = 9;
}

// =============================================================================
// EXECUTOR METRICS
// =============================================================================
//
// These types capture executor health and performance data for monitoring.
// Used by TimelineHeartbeat in timeline_event.proto.
// =============================================================================

// ExecutorMetrics provides typed health metrics from the executor process.
message ExecutorMetrics {
  // Memory usage in bytes.
  optional int64 memory_bytes = 1;
  // CPU usage percentage (0-100).
  optional double cpu_percent = 2;
  // Number of active browser pages.
  optional int32 active_pages = 3;
  // Reserved: fields 4-5 were current_step/total_steps (redundant with progress).
  reserved 4, 5;
}

// PerformanceMetrics provides web performance data captured during execution.
message PerformanceMetrics {
  // Network request count.
  optional int32 network_requests = 1;
  // Total bytes transferred.
  optional int64 bytes_transferred = 2;
  // DOM node count.
  optional int32 dom_nodes = 3;
  // JavaScript heap size in bytes.
  optional int64 js_heap_bytes = 4;
  // Time to first byte in milliseconds.
  optional int32 ttfb_ms = 5;
  // Largest contentful paint in milliseconds.
  optional int32 lcp_ms = 6;
  // First input delay in milliseconds.
  optional int32 fid_ms = 7;
  // Cumulative layout shift score.
  optional double cls = 8;
}
