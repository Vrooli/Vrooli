syntax = "proto3";

package browser_automation_studio.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "browser-automation-studio/v1/shared.proto";
import "browser-automation-studio/v1/timeline.proto";
import "browser-automation-studio/v1/workflow.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/browser-automation-studio/v1;browser_automation_studio_v1";

// Execution is returned by GET /api/v1/executions/{id}` and list APIs.
message Execution {
  // Unique execution ID (UUID). JSON name preserved as "id" for backwards compatibility.
  string execution_id = 1 [json_name = "id"];
  // Workflow ID associated with the execution (UUID).
  string workflow_id = 2;
  // Version of the workflow used for this execution.
  int32 workflow_version = 3;
  // Current execution status.
  ExecutionStatus status = 4;
  // How the execution was triggered (manual, scheduled, api, webhook).
  TriggerType trigger_type = 5;
  // Trigger metadata payload.
  map<string, google.protobuf.Value> trigger_metadata = 6;
  // Runtime parameters passed to the execution.
  map<string, google.protobuf.Value> parameters = 7;
  // When the execution started.
  google.protobuf.Timestamp started_at = 8;
  // When the execution completed (null if still running).
  google.protobuf.Timestamp completed_at = 9;
  // Last heartbeat received from the executor.
  google.protobuf.Timestamp last_heartbeat = 10;
  // Error message if the execution failed.
  optional string error = 11;
  // Structured result payload reported by the executor.
  map<string, google.protobuf.Value> result = 12;
  // Progress percentage (0-100).
  int32 progress = 13;
  // Human-readable description of the current step.
  string current_step = 14;
  // Creation timestamp for the execution record.
  google.protobuf.Timestamp created_at = 15;
  // Last update timestamp for the execution record.
  google.protobuf.Timestamp updated_at = 16;
}

// ExecuteAdhocRequest represents POST /api/v1/workflows/execute-adhoc.
message ExecuteAdhocRequest {
  // Workflow definition to execute without persisting.
  WorkflowDefinition flow_definition = 1;
  // Runtime parameters for the adhoc execution.
  map<string, google.protobuf.Value> parameters = 2;
  // Whether to wait for completion before responding.
  bool wait_for_completion = 3;
  // Optional metadata for labeling the execution.
  ExecutionMetadata metadata = 4;
}

// ExecutionMetadata captures optional labels for adhoc runs.
message ExecutionMetadata {
  // Human-readable name for the adhoc execution.
  string name = 1;
  // Optional description for the adhoc execution.
  string description = 2;
}

// ExecuteAdhocResponse mirrors the adhoc execution response payload.
message ExecuteAdhocResponse {
  // The created execution ID.
  string execution_id = 1;
  // Initial execution status.
  ExecutionStatus status = 2;
  // Workflow ID if persisted (null for adhoc).
  optional string workflow_id = 3;
  // Human-readable status message.
  string message = 4;
  // Completion timestamp when wait_for_completion is true.
  google.protobuf.Timestamp completed_at = 5;
  // Error message when execution fails.
  optional string error = 6;
}

// Screenshot represents metadata for a captured screenshot.
message Screenshot {
  // Unique screenshot artifact ID.
  string id = 1;
  // Execution ID this screenshot belongs to.
  string execution_id = 2;
  // Human-readable step name when captured.
  string step_name = 3;
  // Zero-based step index in the execution.
  int32 step_index = 4;
  // When the screenshot was captured.
  google.protobuf.Timestamp timestamp = 5;
  // URL to download the full screenshot.
  string storage_url = 6;
  // URL to download a thumbnail.
  string thumbnail_url = 7;
  // Image width in pixels.
  int32 width = 8;
  // Image height in pixels.
  int32 height = 9;
  // File size in bytes.
  int64 size_bytes = 10;
}

// GetScreenshotsResponse is returned by GET /api/v1/executions/{id}/screenshots.
message GetScreenshotsResponse {
  // List of screenshots for the execution.
  repeated Screenshot screenshots = 1;
}

// ExecutionEventEnvelope represents WebSocket event envelopes emitted by BAS.
message ExecutionEventEnvelope {
  // Schema version for the envelope.
  string schema_version = 1;
  // Payload version for downstream consumers.
  string payload_version = 2;
  // Event kind (status_update, timeline_frame, log, heartbeat, telemetry, etc.).
  EventKind kind = 3;
  // Execution ID the event belongs to.
  string execution_id = 4;
  // Workflow ID the execution belongs to.
  string workflow_id = 5;
  // Zero-based step index if applicable.
  optional int32 step_index = 6;
  // Attempt number for retries.
  optional int32 attempt = 7;
  // Monotonic sequence number for ordering.
  optional int64 sequence = 8;
  // RFC3339 timestamp for the event.
  google.protobuf.Timestamp timestamp = 9;
  // Event payload typed by kind.
  oneof payload {
    StatusUpdateEvent status_update = 11;
    TimelineFrameEvent timeline_frame = 12;
    LogEvent log = 13;
    HeartbeatEvent heartbeat = 14;
    TelemetryEvent telemetry = 15;
  }
}

// ExecutionExportPreview summarizes export readiness and metadata.
message ExecutionExportPreview {
  // Execution ID being exported.
  string execution_id = 1;
  // Identifier for the generated export spec (replay movie).
  string spec_id = 2;
  // Status: ready, pending, error, unavailable.
  ExportStatus status = 3;
  // Human-readable message about readiness or errors.
  string message = 4;
  // Number of captured frames available for export.
  int32 captured_frame_count = 5;
  // Number of assets available for export (images, etc.).
  int32 available_asset_count = 6;
  // Total duration in milliseconds of the replay.
  int32 total_duration_ms = 7;
  // Replay movie package encoded as JSON (movie spec).
  google.protobuf.Struct package = 8;
}

// StatusUpdateEvent carries execution-level status changes.
message StatusUpdateEvent {
  ExecutionStatus status = 1;
  int32 progress = 2;
  // Current step description when available.
  optional string current_step = 3;
  // Error details when status is failed.
  optional string error = 4;
  google.protobuf.Timestamp occurred_at = 5;
}

// TimelineFrameEvent transports timeline frame updates.
message TimelineFrameEvent {
  TimelineFrame frame = 1;
}

// LogEvent captures execution log events.
message LogEvent {
  LogLevel level = 1;
  string message = 2;
  // Optional step context for the log.
  optional int32 step_index = 3;
  google.protobuf.Timestamp occurred_at = 4;
  map<string, google.protobuf.Value> metadata = 5;
}

// HeartbeatEvent reports liveness/progress signals.
message HeartbeatEvent {
  google.protobuf.Timestamp received_at = 1;
  int32 progress = 2;
  // Executor supplied metrics.
  map<string, google.protobuf.Value> metrics = 3;
}

// TelemetryEvent emits structured telemetry metrics.
message TelemetryEvent {
  map<string, google.protobuf.Value> metrics = 1;
  google.protobuf.Timestamp recorded_at = 2;
}
