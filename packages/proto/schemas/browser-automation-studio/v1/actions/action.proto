syntax = "proto3";

package browser_automation_studio.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/types.proto";
import "browser-automation-studio/v1/base/shared.proto";
import "browser-automation-studio/v1/base/geometry.proto";
import "browser-automation-studio/v1/domain/selectors.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/browser-automation-studio/v1/actions;actions";

// =============================================================================
// ACTION TYPE ENUM
// =============================================================================

// ActionType enumerates all supported browser automation action kinds.
//
// Each type corresponds to a specific *Params message in ActionDefinition.params.
// The type field MUST match the populated params oneof case.
//
// @usage ActionDefinition.type, workflow editor action palette
enum ActionType {
  // Default/unknown action type. Should not be used.
  // Indicates missing or corrupted type field.
  ACTION_TYPE_UNSPECIFIED = 0;

  // Navigate to a URL or scenario page.
  // Params: NavigateParams (url, wait_for_selector, timeout_ms, etc.)
  // Example: Go to "https://example.com/login"
  ACTION_TYPE_NAVIGATE = 1;

  // Click on an element (left, right, or middle button).
  // Params: ClickParams (selector, button, click_count, modifiers, etc.)
  // Example: Click the "Submit" button
  ACTION_TYPE_CLICK = 2;

  // Type text into an input field.
  // Params: InputParams (selector, value, is_sensitive, submit, etc.)
  // Example: Enter "user@example.com" into email field
  ACTION_TYPE_INPUT = 3;

  // Wait for a condition (time delay or element state).
  // Params: WaitParams (duration_ms OR selector with state)
  // Example: Wait for ".loading-spinner" to disappear
  ACTION_TYPE_WAIT = 4;

  // Assert a condition about an element.
  // Params: AssertParams (selector, mode, expected, negated, etc.)
  // Example: Assert ".success-message" is visible
  ACTION_TYPE_ASSERT = 5;

  // Scroll the page or a specific element.
  // Params: ScrollParams (selector, x, y, delta_x, delta_y, behavior)
  // Example: Scroll to bottom of page
  ACTION_TYPE_SCROLL = 6;

  // Select an option from a dropdown/select element.
  // Params: SelectParams (selector, value/label/index)
  // Example: Select "United States" from country dropdown
  ACTION_TYPE_SELECT = 7;

  // Execute arbitrary JavaScript in the page context.
  // Params: EvaluateParams (expression, store_result, args)
  // Example: Extract the order ID from page content
  ACTION_TYPE_EVALUATE = 8;

  // Press keyboard keys (single key or sequence).
  // Params: KeyboardParams (key, keys, modifiers, action)
  // Example: Press Ctrl+A to select all
  ACTION_TYPE_KEYBOARD = 9;

  // Hover over an element (trigger hover states/tooltips).
  // Params: HoverParams (selector, timeout_ms)
  // Example: Hover over menu item to reveal submenu
  ACTION_TYPE_HOVER = 10;

  // Capture a screenshot of the page or element.
  // Params: ScreenshotParams (full_page, selector, quality)
  // Example: Capture full-page screenshot for documentation
  ACTION_TYPE_SCREENSHOT = 11;

  // Focus an input element (for keyboard input).
  // Params: FocusParams (selector, scroll, timeout_ms)
  // Example: Focus the search input before typing
  ACTION_TYPE_FOCUS = 12;

  // Remove focus from the currently focused element.
  // Params: BlurParams (selector, timeout_ms)
  // Example: Blur input to trigger validation
  ACTION_TYPE_BLUR = 13;

  // Execute another workflow as a nested call.
  // Params: SubflowParams (workflow_id OR workflow_path, args)
  // Example: Call "login" workflow before continuing
  ACTION_TYPE_SUBFLOW = 14;
}

// =============================================================================
// ACTION ENUMS
// =============================================================================

// MouseButton enumerates supported mouse buttons for click actions.
//
// @usage ClickParams.button
enum MouseButton {
  // Default. Uses LEFT button.
  MOUSE_BUTTON_UNSPECIFIED = 0;

  // Standard left mouse button. Most common for normal clicks.
  MOUSE_BUTTON_LEFT = 1;

  // Right mouse button. Opens context menus on most elements.
  MOUSE_BUTTON_RIGHT = 2;

  // Middle mouse button (scroll wheel click).
  // Often used for opening links in new tabs.
  MOUSE_BUTTON_MIDDLE = 3;
}

// NavigateWaitEvent enumerates events to wait for after navigation.
//
// Controls when navigation is considered "complete". Affects reliability
// vs. speed tradeoff. Maps to Playwright's waitUntil option.
//
// @usage NavigateParams.wait_until
enum NavigateWaitEvent {
  // Default. Uses LOAD event.
  NAVIGATE_WAIT_EVENT_UNSPECIFIED = 0;

  // Wait for the 'load' event (all resources loaded).
  // Most reliable but slowest. Use for complex pages.
  NAVIGATE_WAIT_EVENT_LOAD = 1;

  // Wait for 'DOMContentLoaded' event (HTML parsed, deferred scripts run).
  // Faster than LOAD. Good when you don't need images/stylesheets.
  NAVIGATE_WAIT_EVENT_DOMCONTENTLOADED = 2;

  // Wait until network is idle (no requests for 500ms).
  // Good for SPAs that load data dynamically after initial render.
  NAVIGATE_WAIT_EVENT_NETWORKIDLE = 3;
}

// NavigateDestinationType indicates how a navigate target should be interpreted.
//
// Allows workflows to navigate to other Vrooli scenarios by name instead
// of hardcoding URLs, enabling portable workflows across environments.
//
// @usage NavigateParams.destination_type
enum NavigateDestinationType {
  // Default. Treat as URL type.
  NAVIGATE_DESTINATION_TYPE_UNSPECIFIED = 0;

  // Target is a literal URL string.
  // Use NavigateParams.url field.
  NAVIGATE_DESTINATION_TYPE_URL = 1;

  // Target is a Vrooli scenario name + path.
  // Use NavigateParams.scenario and scenario_path fields.
  // The URL is resolved via the scenario registry.
  NAVIGATE_DESTINATION_TYPE_SCENARIO = 2;
}

// WaitState enumerates element states for wait conditions.
//
// Used with WaitParams to wait for specific element lifecycle events.
// Maps to Playwright's waitForSelector state option.
//
// @usage WaitParams.state
enum WaitState {
  // Default. Uses VISIBLE state.
  WAIT_STATE_UNSPECIFIED = 0;

  // Wait until element is attached to DOM (may not be visible).
  // Fast check; use when you just need the element to exist.
  WAIT_STATE_ATTACHED = 1;

  // Wait until element is removed from DOM.
  // Use for waiting for loading indicators to disappear.
  WAIT_STATE_DETACHED = 2;

  // Wait until element is visible to user (in viewport, displayed).
  // Most common state; ensures element can be interacted with.
  WAIT_STATE_VISIBLE = 3;

  // Wait until element becomes hidden (display:none or removed).
  // Use for waiting for modals/overlays to close.
  WAIT_STATE_HIDDEN = 4;
}

// NOTE: AssertionMode moved to shared.proto for cross-file usage.

// ScrollBehavior enumerates scroll animation behaviors.
//
// Controls whether scrolling is instant or animated. Smooth scrolling
// is more realistic but slower.
//
// @usage ScrollParams.behavior
enum ScrollBehavior {
  // Default. Browser decides (usually instant).
  SCROLL_BEHAVIOR_UNSPECIFIED = 0;

  // Instant scroll jump. Fast and reliable.
  SCROLL_BEHAVIOR_AUTO = 1;

  // Animated smooth scroll. More realistic but takes time.
  // May cause timing issues if subsequent actions don't wait.
  SCROLL_BEHAVIOR_SMOOTH = 2;
}

// KeyAction enumerates keyboard action types.
//
// Controls the keyboard event lifecycle. Most actions should use PRESS.
// DOWN/UP are for advanced scenarios like holding modifier keys.
//
// @usage KeyboardParams.action
enum KeyAction {
  // Default. Uses PRESS (down + up).
  KEY_ACTION_UNSPECIFIED = 0;

  // Press and release the key (keydown + keyup).
  // Use for normal key presses (Enter, Tab, letters).
  KEY_ACTION_PRESS = 1;

  // Press the key down without releasing.
  // Use for holding keys (e.g., hold Shift while clicking).
  KEY_ACTION_DOWN = 2;

  // Release a previously pressed key.
  // Use to complete a DOWN action.
  KEY_ACTION_UP = 3;
}

// KeyboardModifier enumerates keyboard modifier keys.
//
// Modifiers are held during other actions (clicks, key presses).
// Multiple modifiers can be combined.
//
// @usage KeyboardParams.modifiers, ClickParams.modifiers
enum KeyboardModifier {
  // No modifier. Should not appear in modifiers array.
  KEYBOARD_MODIFIER_UNSPECIFIED = 0;

  // Ctrl key (Control on Mac). Common for shortcuts.
  // Example: Ctrl+C for copy, Ctrl+Click for new tab.
  KEYBOARD_MODIFIER_CTRL = 1;

  // Shift key. For uppercase, selection extension.
  // Example: Shift+Click for range select, Shift+Tab for back.
  KEYBOARD_MODIFIER_SHIFT = 2;

  // Alt key (Option on Mac). For alternate actions.
  // Example: Alt+Click for download link.
  KEYBOARD_MODIFIER_ALT = 3;

  // Meta key (Cmd on Mac, Win on Windows).
  // Example: Cmd+Click for new tab on Mac.
  KEYBOARD_MODIFIER_META = 4;
}

// =============================================================================
// ACTION PARAMETERS
// =============================================================================

// NavigateParams configures page navigation.
message NavigateParams {
  // Target URL to navigate to.
  string url = 1;
  // CSS selector to wait for after navigation completes.
  optional string wait_for_selector = 2;
  // Timeout in milliseconds for navigation and wait (default: 30000).
  optional int32 timeout_ms = 3;
  // Event to wait for before considering navigation complete.
  optional NavigateWaitEvent wait_until = 4;
  // Optional: interpret navigation target as a scenario+path instead of a raw URL.
  // When destination_type is SCENARIO (or scenario is provided), implementations
  // should resolve a URL using the configured scenario registry / lifecycle system.
  optional NavigateDestinationType destination_type = 10;
  // Scenario name to resolve (e.g., "browser-automation-studio").
  optional string scenario = 11;
  // Path within the scenario to navigate to (e.g., "/").
  optional string scenario_path = 12;
}

// ClickParams configures pointer click interactions.
message ClickParams {
  // CSS selector for target element.
  string selector = 1;
  // Mouse button (defaults to left if unspecified).
  optional MouseButton button = 2;
  // Number of clicks (1=single, 2=double, 3=triple).
  optional int32 click_count = 3;
  // Delay between mousedown and mouseup in milliseconds.
  optional int32 delay_ms = 4;
  // Keyboard modifiers held during click.
  repeated KeyboardModifier modifiers = 5;
  // Force click even if element is not visible/actionable.
  optional bool force = 6;
  // Scroll element into view before clicking.
  optional bool scroll_into_view = 7;
}

// InputParams configures text entry into form elements.
message InputParams {
  // CSS selector for target input element.
  string selector = 1;
  // Text value to type.
  string value = 2;
  // Mask value in logs/telemetry (for passwords, etc.).
  optional bool is_sensitive = 3;
  // Press Enter after typing (submit form).
  optional bool submit = 4;
  // Clear existing text before typing.
  optional bool clear_first = 5;
  // Delay between keystrokes in milliseconds.
  optional int32 delay_ms = 6;
}

// WaitParams configures wait conditions.
message WaitParams {
  // Wait condition: either duration or selector (one must be set).
  oneof wait_for {
    // Fixed duration to wait in milliseconds.
    int32 duration_ms = 1;
    // CSS selector to wait for.
    string selector = 2;
  }
  // Element state to wait for when using selector.
  optional WaitState state = 3;
  // Timeout in milliseconds for selector waits (default: 30000).
  optional int32 timeout_ms = 4;
}

// AssertParams configures element assertions.
message AssertParams {
  // CSS selector for element to assert on.
  string selector = 1;
  // Assertion mode to evaluate.
  AssertionMode mode = 2;
  // Expected value for comparison assertions.
  optional common.v1.JsonValue expected = 3;
  // Negate the assertion (expect opposite).
  optional bool negated = 4;
  // Case-sensitive text comparison.
  optional bool case_sensitive = 5;
  // Attribute name for attribute assertions.
  optional string attribute_name = 6;
  // Custom failure message.
  optional string failure_message = 7;
  // Timeout in milliseconds (default: 5000).
  optional int32 timeout_ms = 8;
}

// ScrollParams configures scroll actions.
message ScrollParams {
  // CSS selector to scroll (defaults to viewport if not specified).
  optional string selector = 1;
  // Absolute horizontal scroll position in pixels.
  optional int32 x = 2;
  // Absolute vertical scroll position in pixels.
  optional int32 y = 3;
  // Scroll animation behavior.
  optional ScrollBehavior behavior = 4;
  // Relative horizontal scroll delta in pixels.
  optional int32 delta_x = 5;
  // Relative vertical scroll delta in pixels.
  optional int32 delta_y = 6;
}

// SelectParams configures dropdown/select element interaction.
message SelectParams {
  // CSS selector for select element.
  string selector = 1;
  // Selection method (one must be set).
  oneof select_by {
    // Select by option value attribute.
    string value = 2;
    // Select by visible text label.
    string label = 3;
    // Select by zero-based index.
    int32 index = 4;
  }
  // Timeout in milliseconds (default: 5000).
  optional int32 timeout_ms = 5;
}

// EvaluateParams configures JavaScript evaluation.
message EvaluateParams {
  // JavaScript expression to evaluate.
  string expression = 1;
  // Variable name to store the result.
  optional string store_result = 2;
  // Arguments to pass to the expression.
  map<string, common.v1.JsonValue> args = 3;
}

// KeyboardParams configures keyboard interactions.
message KeyboardParams {
  // Single key to press (e.g., "Enter", "Tab", "a").
  optional string key = 1;
  // Sequence of keys to press.
  repeated string keys = 2;
  // Keyboard modifiers to hold during the action.
  repeated KeyboardModifier modifiers = 3;
  // Type of keyboard action to perform.
  optional KeyAction action = 4;
}

// HoverParams configures hover interactions.
message HoverParams {
  // CSS selector for element to hover over.
  string selector = 1;
  // Timeout in milliseconds (default: 5000).
  optional int32 timeout_ms = 2;
}

// ScreenshotParams configures screenshot capture.
message ScreenshotParams {
  // Capture full scrollable page vs viewport only.
  optional bool full_page = 1;
  // CSS selector to screenshot specific element.
  optional string selector = 2;
  // JPEG quality (1-100) for lossy compression.
  optional int32 quality = 3;
}

// FocusParams configures focus interactions.
message FocusParams {
  // CSS selector for element to focus.
  string selector = 1;
  // Whether to scroll element into view.
  optional bool scroll = 2;
  // Timeout in milliseconds (default: 5000).
  optional int32 timeout_ms = 3;
}

// BlurParams configures blur (unfocus) interactions.
message BlurParams {
  // CSS selector for element to blur (blurs active element if not specified).
  optional string selector = 1;
  // Timeout in milliseconds (default: 5000).
  optional int32 timeout_ms = 2;
}

// SubflowParams configures nested workflow execution.
//
// A subflow can target:
//   - A persisted workflow by ID (optionally pinned to a version), OR
//   - A workflow definition file referenced by a path relative to the *project root*.
//
// Paths are interpreted by the API using the project folder associated with the
// parent workflow (i.e., the workflow being executed). Implementations MUST
// reject absolute paths and any traversal segments ('.' or '..').
message SubflowParams {
  oneof target {
    // Workflow ID to invoke as a subflow (UUID format).
    string workflow_id = 1;
    // Project-relative path to a workflow definition file (e.g. "actions/dismiss-tutorial.json").
    string workflow_path = 2;
  }
  // Optional workflow version to invoke when targeting workflow_id.
  optional int32 workflow_version = 3;
  // Arguments exposed to the subflow as the "fixture" namespace (e.g. ${fixture.foo}).
  map<string, common.v1.JsonValue> args = 10;
}

// =============================================================================
// ACTION METADATA
// =============================================================================

// ActionMetadata captures optional rich context captured during action execution.
// This data is captured identically during BOTH recording and execution, enabling:
//   - Selector fallbacks: If primary selector fails, try alternatives
//   - Debugging: See exactly what the system saw when it executed the action
//   - Editing: Users can adjust selectors on failed steps using captured alternatives
//
// See "UNIFIED RECORDING/EXECUTION MODEL" in shared.proto for the design rationale.
message ActionMetadata {
  // Human-readable label for the action.
  optional string label = 1;
  // Alternative selectors ranked by confidence.
  // Captured during both recording (user interactions) and execution (code-driven).
  // Enables fallback selector strategies and user editing of failed steps.
  repeated SelectorCandidate selector_candidates = 2;
  // Element state snapshot when action was captured.
  // Provides context about the target element for debugging and selector refinement.
  optional ElementMeta element_snapshot = 3;
  // Confidence score (0.0-1.0) for the primary selector.
  // Higher values indicate more reliable selectors (data-testid > css class > xpath).
  optional double confidence = 4;
  // When this action was captured (during recording or execution).
  optional google.protobuf.Timestamp captured_at = 5;
  // Element bounding box when captured.
  // Used for visual debugging and screenshot annotations.
  optional BoundingBox captured_bounding_box = 6;
}

// =============================================================================
// CORE ACTION DEFINITION
// =============================================================================

// ActionDefinition is THE unified action type used across all BAS operations:
//
//   CONTEXT                   USAGE
//   ─────────────────────────────────────────────────────────────────────────
//   Recording                 Captured from user interactions with browser
//   Workflow Storage          Persisted in WorkflowNodeV2.action
//   Execution                 Sent to playwright-driver for replay
//   Timeline Streaming        Streamed to UI during live recording/execution
//   Timeline Batch            Returned in historical timeline queries
//
// This is the canonical representation of "what action to perform" throughout
// the entire system. See "UNIFIED RECORDING/EXECUTION MODEL" in shared.proto.
//
// IMPORTANT: Type-Params Consistency Requirement
// The `type` field MUST match the populated `params` oneof case:
//   - ACTION_TYPE_NAVIGATE requires `navigate` params
//   - ACTION_TYPE_CLICK requires `click` params
//   - ACTION_TYPE_INPUT requires `input` params
//   - etc.
//
// The `type` field exists for:
// 1. Efficient filtering/grouping without parsing params
// 2. Forward compatibility when new params are added
// 3. Explicit documentation of intent
//
// Consumers SHOULD validate type-params consistency. Invalid combinations
// (e.g., type=CLICK with navigate params) are malformed and should be rejected.
message ActionDefinition {
  // Action type classification. MUST match the populated params oneof case.
  // See message-level comment for consistency requirements.
  ActionType type = 1;

  // Type-specific parameters. Exactly one MUST be set, matching the `type` field.
  // The mapping is: ACTION_TYPE_X requires the corresponding `x` params field.
  oneof params {
    NavigateParams navigate = 10;    // Required when type = ACTION_TYPE_NAVIGATE
    ClickParams click = 11;          // Required when type = ACTION_TYPE_CLICK
    InputParams input = 12;          // Required when type = ACTION_TYPE_INPUT
    WaitParams wait = 13;            // Required when type = ACTION_TYPE_WAIT
    AssertParams assert = 14;        // Required when type = ACTION_TYPE_ASSERT
    ScrollParams scroll = 15;        // Required when type = ACTION_TYPE_SCROLL
    SelectParams select_option = 16; // Required when type = ACTION_TYPE_SELECT
    EvaluateParams evaluate = 17;    // Required when type = ACTION_TYPE_EVALUATE
    KeyboardParams keyboard = 18;    // Required when type = ACTION_TYPE_KEYBOARD
    HoverParams hover = 19;          // Required when type = ACTION_TYPE_HOVER
    ScreenshotParams screenshot = 20;// Required when type = ACTION_TYPE_SCREENSHOT
    FocusParams focus = 21;          // Required when type = ACTION_TYPE_FOCUS
    BlurParams blur = 22;            // Required when type = ACTION_TYPE_BLUR
    SubflowParams subflow = 23;      // Required when type = ACTION_TYPE_SUBFLOW
  }

  // Optional rich metadata - preserved from recording, useful for debugging/fallbacks.
  ActionMetadata metadata = 30;
}
