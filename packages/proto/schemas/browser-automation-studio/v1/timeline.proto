syntax = "proto3";

package browser_automation_studio.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/types.proto";
import "browser-automation-studio/v1/shared.proto";
import "browser-automation-studio/v1/action.proto";
import "browser-automation-studio/v1/geometry.proto";
import "browser-automation-studio/v1/selectors.proto";
import "browser-automation-studio/v1/telemetry.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/browser-automation-studio/v1;browser_automation_studio_v1";

// =============================================================================
// EXECUTION TIMELINE (BATCH API FORMAT)
// =============================================================================
//
// This file defines the BATCH format for execution timeline data, used by
// REST API endpoints like GET /api/v1/executions/{id}/timeline.
//
// RELATIONSHIP TO STREAMING FORMAT (timeline_event.proto):
// - TimelineEvent: Streaming format sent over WebSocket during execution/recording
// - TimelineFrame: Batch format stored after execution completes
// - ExecutionTimeline: Container for all TimelineFrames from an execution
//
// The TimelineEvent streaming format is converted to TimelineFrame batch format
// when an execution completes. Both formats share common types:
// - ActionDefinition (from action.proto)
// - ActionTelemetry (from telemetry.proto)
// - RetryStatus, AssertionResult (from shared.proto)
//
// Prefer TimelineEvent for live streaming; use TimelineFrame for historical data.
// =============================================================================

// ExecutionTimeline is returned by GET /api/v1/executions/{id}/timeline.
// This is the batch format containing all frames from a completed execution.
message ExecutionTimeline {
  // Unique identifier for this execution (UUID).
  string execution_id = 1;
  // Workflow ID associated with the execution (UUID).
  string workflow_id = 2;
  // Current execution status (pending, running, completed, failed, cancelled).
  ExecutionStatus status = 3;
  // Overall execution progress percentage (0-100).
  int32 progress = 4;
  // When the execution started.
  google.protobuf.Timestamp started_at = 5;
  // When the execution completed (null if still running).
  optional google.protobuf.Timestamp completed_at = 6;
  // Ordered list of execution frames (one per workflow step).
  repeated TimelineFrame frames = 7;
  // Console and execution logs captured during the run.
  repeated TimelineLog logs = 8;
}

// =============================================================================
// TIMELINE FRAME
// =============================================================================

// TimelineFrame captures a single workflow step in the execution timeline.
message TimelineFrame {
  // Zero-based index of this step in the execution.
  int32 step_index = 1;
  // Node ID from the workflow definition.
  string node_id = 2;
  // Action type enum (for filtering/grouping without parsing full action).
  ActionType action_type = 3;
  // Full action definition with parameters and metadata.
  // This provides complete action details for replay and debugging.
  ActionDefinition action = 35;
  // Step execution status.
  StepStatus status = 4;
  // Whether this step succeeded.
  bool success = 5;
  // Execution duration in milliseconds for this attempt.
  int32 duration_ms = 6;
  // Total time for the step including retries.
  int32 total_duration_ms = 7;
  // Progress percentage at this step (0-100).
  int32 progress = 8;
  // When the step started.
  google.protobuf.Timestamp started_at = 9;
  // When the step finished.
  google.protobuf.Timestamp completed_at = 10;
  // Final URL after step execution (for navigation steps).
  string final_url = 11;
  // Error message if the step failed.
  optional string error = 12;
  // Number of console log entries captured for this step.
  int32 console_log_count = 13;
  // Number of network events captured for this step.
  int32 network_event_count = 14;
  // Reserved: field 15 was 'step_type' (replaced by action_type from ActionType enum)
  reserved 15;
  // Highlight overlays applied to the screenshot - from unified.proto.
  repeated HighlightRegion highlight_regions = 16;
  // Masked regions applied during capture - from unified.proto.
  repeated MaskRegion mask_regions = 17;
  // Focused element metadata for the step.
  ElementFocus focused_element = 18;
  // Bounding box for the primary element interacted with - from unified.proto.
  BoundingBox element_bounding_box = 19;
  // Actual click coordinates used - from unified.proto.
  Point click_position = 20;
  // Cursor trail captured during the step - from unified.proto.
  repeated Point cursor_trail = 21;
  // Applied zoom factor during capture.
  double zoom_factor = 22;
  // Screenshot captured during/after this step - from unified.proto.
  TimelineScreenshot screenshot = 23;
  // Related artifacts (console logs, network traces, etc.).
  repeated TimelineArtifact artifacts = 24;
  // Assertion result for assert steps.
  AssertionResult assertion = 25;
  // Retry status for this step (uses unified RetryStatus type).
  // This replaces the individual retry_* fields for consistency.
  RetryStatus retry_status = 37;
  // Reserved: fields 26-31 were individual retry fields, now consolidated in retry_status.
  reserved 26, 27, 28, 29, 30, 31;
  // Truncated DOM snapshot preview text.
  string dom_snapshot_preview = 32;
  // Artifact reference for the stored DOM snapshot.
  TimelineArtifact dom_snapshot = 33;
  // Typed preview of extracted data.
  common.v1.JsonValue extracted_data_preview = 34;

  // Composed telemetry captured during this step.
  // Mirrors TimelineEvent.telemetry for consistency between streaming and batch formats.
  // NOTE: Some fields in this message duplicate inline fields above for backward compatibility.
  // New consumers should prefer telemetry.* fields; inline fields may be deprecated.
  ActionTelemetry telemetry = 36;
}

// =============================================================================
// ARTIFACTS
// =============================================================================

// TimelineArtifact exposes related artifacts such as console or network logs.
message TimelineArtifact {
  // Reserved: field 9 was 'metadata' (replaced by typed payload map)
  reserved 9;
  // Unique artifact ID.
  string id = 1;
  // Artifact type (timeline_frame, console_log, network_event, etc.).
  ArtifactType type = 2;
  // Optional human-readable label.
  optional string label = 3;
  // URL to download the artifact content.
  string storage_url = 4;
  // URL to download an artifact thumbnail if available.
  optional string thumbnail_url = 5;
  // MIME type for the artifact.
  string content_type = 6;
  // Optional size in bytes for the artifact.
  optional int64 size_bytes = 7;
  // Step index associated with this artifact, if any.
  optional int32 step_index = 8;
  // Provider-specific payload describing the artifact.
  map<string, common.v1.JsonValue> payload = 10;
}

// NOTE: RetryAttempt is now defined in shared.proto for unified usage.
// The old RetryHistoryEntry had a call_duration_ms field which has been removed
// as it was redundant with duration_ms.

// =============================================================================
// ELEMENT FOCUS
// =============================================================================

// ElementFocus captures focus metadata for screenshot framing.
message ElementFocus {
  // CSS selector of the focused element.
  string selector = 1;
  // Bounding box for the focused element - from unified.proto.
  BoundingBox bounding_box = 2;
}

// =============================================================================
// LOGGING
// =============================================================================

// TimelineLog captures execution log output for replay consumers.
message TimelineLog {
  // Unique log entry ID.
  string id = 1;
  // Log level (debug, info, warn, error).
  LogLevel level = 2;
  // Log message content.
  string message = 3;
  // Associated step name, if any.
  optional string step_name = 4;
  // Timestamp when the log was recorded.
  google.protobuf.Timestamp timestamp = 5;
}
