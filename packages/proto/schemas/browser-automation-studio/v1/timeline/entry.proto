syntax = "proto3";

package browser_automation_studio.v1;

import "google/protobuf/timestamp.proto";
import "buf/validate/validate.proto";
import "common/v1/types.proto";
import "browser-automation-studio/v1/base/shared.proto";
import "browser-automation-studio/v1/base/geometry.proto";
import "browser-automation-studio/v1/actions/action.proto";
import "browser-automation-studio/v1/domain/telemetry.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/browser-automation-studio/v1/timeline;timeline";

// =============================================================================
// TIMELINE ENTRY (UNIFIED FORMAT)
// =============================================================================
//
// @layer 3
// @domain timeline
// @imports base, actions, domain
// @stability stable
//
// TimelineEntry is THE canonical format for timeline data, used for both:
//   - Real-time streaming (WebSocket during recording/execution)
//   - Batch retrieval (REST API for historical data)
//
// This unified type replaces the previous TimelineEvent (streaming) and
// TimelineFrame (batch) types, reflecting the fact that recording and
// execution capture identical data.
//
// USAGE CONTEXTS:
//   - STREAMING (WebSocket): Sent incrementally during recording/execution
//   - BATCH (REST API): Returned in ExecutionTimeline.entries
//   - Recording: GetActionsResponse.entries
//   - Replay: ReplayPreviewRequest.entries
//
// @see shared.proto for "UNIFIED RECORDING/EXECUTION MODEL" design rationale
//
// =============================================================================

// TimelineEntry captures a single action in the timeline.
// This is the unified format for both streaming and batch access.
//
// @usage ExecutionTimeline.entries, GetActionsResponse.entries, TimelineStreamMessage.entry
message TimelineEntry {
  // === IDENTITY ===
  // Unique entry identifier.
  // @format uuid
  string id = 1;
  // Monotonic sequence number within the session/execution (0-based).
  int32 sequence_num = 2;
  // Zero-based step index in the workflow execution order.
  // See "NODE vs STEP TERMINOLOGY" in shared.proto.
  optional int32 step_index = 3;
  // Node ID from the workflow definition.
  // Links this entry to the specific WorkflowNodeV2.
  // @format uuid
  // @see WorkflowNodeV2.id
  optional string node_id = 4 [(buf.validate.field).string.uuid = true];

  // === TIMING ===
  // When this entry was captured.
  google.protobuf.Timestamp timestamp = 5;
  // Action duration in milliseconds (this attempt only).
  optional int32 duration_ms = 6;
  // Total duration including retries (computed, may differ from duration_ms).
  optional int32 total_duration_ms = 7;

  // === CORE DATA ===
  // The action performed. This is the canonical action representation.
  ActionDefinition action = 10;
  // Observable telemetry captured during the action.
  // Includes screenshots, DOM snapshots, console logs, network events, etc.
  ActionTelemetry telemetry = 11;
  // Event context (origin, outcome, retry status).
  // Contains session/execution ID, success/error, and assertion results.
  EventContext context = 12;

  // === AGGREGATED DATA (batch responses only) ===
  // Computed/derived data populated when returning historical data.
  // NOT populated during real-time streaming.
  optional TimelineEntryAggregates aggregates = 20;

  // === TRACING ===
  // Trace ID for distributed tracing (e.g., OpenTelemetry trace ID).
  optional string trace_id = 30;
  // Correlation ID for linking related operations across services.
  optional string correlation_id = 31;
}

// TimelineEntryAggregates contains computed/derived data for batch responses.
// This data is calculated when an execution completes and is NOT populated
// during real-time streaming.
//
// @usage TimelineEntry.aggregates
message TimelineEntryAggregates {
  // Step execution status (pending, running, completed, failed, etc.).
  StepStatus status = 1;
  // Final URL after step execution (primarily for navigation steps).
  optional string final_url = 2;
  // Count of console log entries (actual logs in telemetry.console_logs).
  int32 console_log_count = 3;
  // Count of network events (actual events in telemetry.network_events).
  int32 network_event_count = 4;
  // Related artifacts (console logs, traces, custom artifacts).
  repeated TimelineArtifact artifacts = 5;
  // DOM snapshot artifact reference.
  optional TimelineArtifact dom_snapshot = 6;
  // Truncated DOM snapshot preview text for quick display.
  optional string dom_snapshot_preview = 7;
  // Preview of extracted data from evaluate steps.
  optional common.v1.JsonValue extracted_data_preview = 8;
  // Focused element metadata for screenshot framing.
  optional ElementFocus focused_element = 9;
  // Execution progress percentage at this step (0-100).
  optional int32 progress = 10;
}

// =============================================================================
// ARTIFACTS
// =============================================================================

// TimelineArtifact represents a stored artifact from execution.
// Examples: screenshots, console logs, network traces, DOM snapshots.
//
// @usage TimelineEntryAggregates.artifacts, TimelineEntryAggregates.dom_snapshot
message TimelineArtifact {
  // Unique artifact identifier.
  // @format uuid
  string id = 1;
  // Artifact type (screenshot, console_log, network_event, dom_snapshot, etc.).
  ArtifactType type = 2;
  // Optional human-readable label.
  optional string label = 3;
  // URL to download the artifact content.
  string storage_url = 4;
  // URL to download an artifact thumbnail (for images).
  optional string thumbnail_url = 5;
  // MIME type for the artifact (e.g., "image/png", "application/json").
  string content_type = 6;
  // Size in bytes.
  optional int64 size_bytes = 7;
  // Step index this artifact is associated with.
  optional int32 step_index = 8;
  // Reserved: field 9 was 'metadata' (replaced by typed payload map).
  reserved 9;
  // Provider-specific payload for artifact metadata.
  map<string, common.v1.JsonValue> payload = 10;
}

// =============================================================================
// ELEMENT FOCUS
// =============================================================================

// ElementFocus captures focus metadata for screenshot framing and highlighting.
//
// @usage TimelineEntryAggregates.focused_element
message ElementFocus {
  // CSS selector of the focused element.
  string selector = 1;
  // Bounding box for the focused element.
  BoundingBox bounding_box = 2;
}

// =============================================================================
// LOGGING
// =============================================================================

// TimelineLog captures execution log output for the timeline.
//
// @usage ExecutionTimeline.logs, TimelineStreamMessage.log
message TimelineLog {
  // Unique log entry identifier.
  // @format uuid
  string id = 1;
  // Log level (debug, info, warn, error).
  LogLevel level = 2;
  // Log message content.
  string message = 3;
  // Associated step name for context.
  optional string step_name = 4;
  // When the log was recorded.
  google.protobuf.Timestamp timestamp = 5;
}

// =============================================================================
// WEBSOCKET STREAMING
// =============================================================================

// TimelineMessageType enumerates WebSocket message types for streaming.
//
// @usage TimelineStreamMessage.type
enum TimelineMessageType {
  TIMELINE_MESSAGE_TYPE_UNSPECIFIED = 0;
  TIMELINE_MESSAGE_TYPE_ENTRY = 1;       // TimelineEntry payload
  TIMELINE_MESSAGE_TYPE_STATUS = 2;      // Status update payload
  TIMELINE_MESSAGE_TYPE_HEARTBEAT = 3;   // Heartbeat payload
  TIMELINE_MESSAGE_TYPE_LOG = 4;         // Log entry payload
}

// TimelineStreamMessage wraps timeline data for WebSocket transport.
// This is the envelope format for all streaming timeline messages.
//
// @usage WebSocket timeline streaming endpoint
message TimelineStreamMessage {
  // Message type for routing and parsing.
  TimelineMessageType type = 1;

  // Message payload (exactly one set based on type).
  oneof payload {
    TimelineEntry entry = 10;            // TIMELINE_MESSAGE_TYPE_ENTRY
    TimelineStatusUpdate status = 11;    // TIMELINE_MESSAGE_TYPE_STATUS
    TimelineHeartbeat heartbeat = 12;    // TIMELINE_MESSAGE_TYPE_HEARTBEAT
    TimelineLog log = 13;                // TIMELINE_MESSAGE_TYPE_LOG
  }
}

// TimelineStatusUpdate reports overall session/execution status.
//
// @usage TimelineStreamMessage.status
message TimelineStatusUpdate {
  // Session ID (recording) or Execution ID (playback).
  // @format uuid
  string id = 1;
  // Current execution status.
  ExecutionStatus status = 2;
  // Progress percentage (0-100).
  int32 progress = 3;
  // Total entry count so far.
  int32 entry_count = 4;
  // Error message if status is failed.
  optional string error = 5;
}

// TimelineHeartbeat keeps WebSocket connection alive.
//
// @usage TimelineStreamMessage.heartbeat
message TimelineHeartbeat {
  // Heartbeat timestamp.
  google.protobuf.Timestamp timestamp = 1;
  // Session ID for connection routing.
  // @format uuid
  string session_id = 2;
}
