syntax = "proto3";

package browser_automation_studio.v1;

import "google/protobuf/struct.proto";
import "browser-automation-studio/v1/shared.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/browser-automation-studio/v1;browser_automation_studio_v1";

// WorkflowDefinition mirrors the JSON workflow definitions used by BAS.
message WorkflowDefinition {
  // Workflow nodes representing graph steps.
  repeated WorkflowNode nodes = 1;
  // Edges connecting workflow nodes.
  repeated WorkflowEdge edges = 2;
  // Arbitrary metadata associated with the workflow.
  map<string, google.protobuf.Value> metadata = 3 [deprecated = true];
  // Execution settings for the workflow (e.g., viewport).
  map<string, google.protobuf.Value> settings = 4 [deprecated = true];
  // Strongly typed metadata; prefer over the deprecated Struct-backed map.
  WorkflowMetadata metadata_typed = 5;
  // Strongly typed execution settings; prefer over the deprecated Struct-backed map.
  WorkflowSettings settings_typed = 6;
}

// WorkflowNode captures a single node in a workflow graph.
message WorkflowNode {
  // Unique node identifier.
  string id = 1;
  // Node type (navigate, click, assert, subflow, etc.).
  StepType type = 2;
  // Node-specific configuration payload (legacy); prefer config.
  google.protobuf.Struct data = 3 [deprecated = true];
  // Typed node configuration (legacy); prefer config.
  JsonObject data_typed = 4 [deprecated = true];
  // Discriminated node configuration matching StepType; prefer over Struct/JsonObject.
  WorkflowNodeConfig config = 5;
}

// WorkflowEdge connects nodes within a workflow graph.
message WorkflowEdge {
  // Unique edge identifier.
  string id = 1;
  // Source node ID.
  string source = 2;
  // Target node ID.
  string target = 3;
  // Edge type (e.g., smoothstep) when provided.
  string type = 4;
  // Provider-specific edge metadata.
  google.protobuf.Struct data = 5;
  // Typed edge metadata; prefer over Struct when available.
  JsonObject data_typed = 6;
}

// WorkflowMetadata captures the most common workflow descriptors.
message WorkflowMetadata {
  // Human-readable workflow name.
  string name = 1;
  // Optional longer description of what the workflow does.
  string description = 2;
  // Arbitrary labels for grouping/ownership (e.g., env=prod, team=apps).
  map<string, string> labels = 3;
  // Version tag for this definition (e.g., semver or git sha).
  string version = 4;
}

// WorkflowSettings captures common browser/execution knobs.
message WorkflowSettings {
  // Viewport width in pixels.
  int32 viewport_width = 1;
  // Viewport height in pixels.
  int32 viewport_height = 2;
  // User agent string to present during execution.
  string user_agent = 3;
  // Preferred locale (e.g., en-US).
  string locale = 4;
  // Overall timeout in seconds for the run.
  int32 timeout_seconds = 5;
  // Whether to run headless.
  bool headless = 6;
  // Additional provider-specific settings not yet typed.
  map<string, google.protobuf.Value> extras = 7;
}

// WorkflowNodeConfig captures typed settings for common node kinds.
message WorkflowNodeConfig {
  oneof config {
    NavigateStepConfig navigate = 1;
    ClickStepConfig click = 2;
    InputStepConfig input = 3;
    AssertStepConfig assert = 4;
    SubflowStepConfig subflow = 5;
    CustomStepConfig custom = 6;
    WaitStepConfig wait = 7;
  }
}

// NavigateStepConfig contains navigation fields.
message NavigateStepConfig {
  string url = 1;
  // Optional selector to wait for after navigation.
  optional string wait_for_selector = 2;
  // Timeout for navigation/wait in milliseconds.
  optional int32 timeout_ms = 3;
  // Whether to capture a screenshot after navigation.
  optional bool capture_screenshot = 4;
}

// ClickStepConfig contains click action metadata.
message ClickStepConfig {
  // CSS selector to click.
  string selector = 1;
  // Mouse button (left, middle, right); defaults to left when empty.
  string button = 2;
  // Number of clicks to perform.
  optional int32 click_count = 3;
  // Delay between mousedown and mouseup in milliseconds.
  optional int32 delay_ms = 4;
}

// InputStepConfig contains text entry metadata.
message InputStepConfig {
  // CSS selector to target.
  string selector = 1;
  // Value to type.
  string value = 2;
  // Treat value as sensitive and mask in logs.
  bool is_sensitive = 3;
  // Whether to press Enter after input.
  optional bool submit = 4;
}

// AssertStepConfig captures assertion configuration.
message AssertStepConfig {
  // Assertion mode (exists, visible, text_equals, etc.).
  string mode = 1;
  // CSS selector being asserted on.
  string selector = 2;
  // Expected value for the assertion.
  google.protobuf.Value expected = 3;
  // Whether the assertion is negated.
  bool negated = 4;
  // Case sensitivity flag.
  bool case_sensitive = 5;
  // Custom assertion message.
  optional string message = 6;
}

// SubflowStepConfig references another workflow.
message SubflowStepConfig {
  // Workflow ID to execute.
  string workflow_id = 1;
  // Optional workflow version.
  optional int32 version = 2;
  // Parameters to pass to the subflow (typed).
  map<string, JsonValue> parameters = 3;
}

// WaitStepConfig captures a fixed delay between steps.
message WaitStepConfig {
  // Duration to wait in milliseconds.
  int32 duration_ms = 1;
}

// CustomStepConfig captures custom provider-specific payloads.
message CustomStepConfig {
  // Custom step kind identifier.
  string kind = 1;
  // Provider-specific payload; prefer over Struct in data.
  JsonObject payload = 2;
}
