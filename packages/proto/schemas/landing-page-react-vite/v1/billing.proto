syntax = "proto3";

package landing_page_react_vite.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "common/v1/types.proto";
import "landing-page-react-vite/v1/pricing.proto";
import "landing-page-react-vite/v1/settings.proto";

option go_package = "github.com/vrooli/vrooli/packages/proto/gen/go/landing-page-react-vite/v1;landing_page_react_vite_v1";

// SubscriptionState enumerates lifecycle states for customer subscriptions.
enum SubscriptionState {
  SUBSCRIPTION_STATE_UNSPECIFIED = 0;
  SUBSCRIPTION_STATE_ACTIVE = 1;
  SUBSCRIPTION_STATE_TRIALING = 2;
  SUBSCRIPTION_STATE_PAST_DUE = 3;
  SUBSCRIPTION_STATE_CANCELED = 4;
  SUBSCRIPTION_STATE_INACTIVE = 5;
}

// SessionKind captures the intent of a checkout session.
enum SessionKind {
  SESSION_KIND_UNSPECIFIED = 0;
  SESSION_KIND_SUBSCRIPTION = 1;
  SESSION_KIND_CREDITS_TOPUP = 2;
  SESSION_KIND_SUPPORTER_CONTRIBUTION = 3;
}

// CheckoutSessionStatus mirrors Stripe checkout session states.
enum CheckoutSessionStatus {
  CHECKOUT_SESSION_STATUS_UNSPECIFIED = 0;
  CHECKOUT_SESSION_STATUS_OPEN = 1;
  CHECKOUT_SESSION_STATUS_COMPLETE = 2;
  CHECKOUT_SESSION_STATUS_EXPIRED = 3;
  CHECKOUT_SESSION_STATUS_CANCELED = 4;
}

// TransactionType constrains wallet credit/debit sources.
enum TransactionType {
  TRANSACTION_TYPE_UNSPECIFIED = 0;
  TRANSACTION_TYPE_CREDIT_TOPUP = 1;
  TRANSACTION_TYPE_CONSUMPTION = 2;
  TRANSACTION_TYPE_ADJUSTMENT = 3;
  TRANSACTION_TYPE_REFUND = 4;
  TRANSACTION_TYPE_GRANT = 5;
}

// CheckoutSession represents a created Stripe checkout session.
message CheckoutSession {
  // Stripe session identifier (cs_*).
  string session_id = 1;
  // Kind of session (subscription, credits top-up, supporter contribution).
  SessionKind session_kind = 2;
  // Current status of the session.
  CheckoutSessionStatus status = 3;
  // Hosted checkout URL to redirect the user.
  string url = 4;
  // Publishable key to use on the client.
  string publishable_key = 5;
  // Customer email tied to the session.
  string customer_email = 6;
  // Stripe price identifier for the purchase.
  string stripe_price_id = 7;
  // Stripe product identifier, when available.
  optional string stripe_product_id = 8;
  // Subscription identifier if created (sub_*).
  optional string subscription_id = 9;
  // Subscription schedule identifier when an intro price is used.
  optional string schedule_id = 10;
  // Amount in cents.
  int64 amount_cents = 11;
  // Currency code (ISO 4217).
  string currency = 12;
  // Success URL for the checkout session.
  string success_url = 13;
  // Cancel URL for the checkout session.
  string cancel_url = 14;
  // Creation timestamp.
  google.protobuf.Timestamp created_at = 15;
  // Additional structured metadata.
  map<string, google.protobuf.Value> metadata = 16 [deprecated = true];
  // Typed structured metadata; prefer over the deprecated Value map.
  map<string, common.v1.JsonValue> metadata_typed = 17;
}

// CreateCheckoutSessionRequest starts a new checkout flow for a price.
message CreateCheckoutSessionRequest {
  // Stripe price identifier to purchase.
  string price_id = 1;
  // Customer email address.
  string customer_email = 2;
  // Success redirect URL.
  string success_url = 3;
  // Cancel redirect URL.
  string cancel_url = 4;
  // Intended session kind (defaults to subscription).
  SessionKind session_kind = 5;
  // Arbitrary metadata to associate with the session.
  map<string, google.protobuf.Value> metadata = 6 [deprecated = true];
  // Typed metadata; prefer over the deprecated Value map.
  map<string, common.v1.JsonValue> metadata_typed = 7;
}

// CreateCheckoutSessionResponse returns the created checkout session.
message CreateCheckoutSessionResponse {
  // Created checkout session.
  CheckoutSession session = 1;
}

// VerifySubscriptionRequest asks for the latest subscription state for a user.
message VerifySubscriptionRequest {
  // Email or customer ID to look up.
  string user_identity = 1;
}

// SubscriptionStatus reports the current subscription state.
message SubscriptionStatus {
  // Lifecycle state of the subscription.
  SubscriptionState state = 1;
  // Subscription identifier (sub_*).
  optional string subscription_id = 2;
  // Identity used for the lookup (email or customer id).
  string user_identity = 3;
  // Plan tier associated with the subscription (e.g., pro, team).
  optional string plan_tier = 4;
  // Stripe price identifier for the active subscription.
  optional string stripe_price_id = 5;
  // Bundle key associated with the subscription.
  optional string bundle_key = 6;
  // Timestamp when this status was cached/updated.
  google.protobuf.Timestamp cached_at = 7;
  // Cache age in milliseconds.
  int64 cache_age_ms = 8;
  // When the subscription was canceled, if applicable.
  google.protobuf.Timestamp canceled_at = 9;
  // Human-readable status message.
  optional string message = 10;
  // Additional metadata about the subscription.
  map<string, google.protobuf.Value> metadata = 11 [deprecated = true];
  // Typed metadata; prefer over the deprecated Value map.
  map<string, common.v1.JsonValue> metadata_typed = 12;
}

// VerifySubscriptionResponse returns the current subscription status.
message VerifySubscriptionResponse {
  // Current subscription status for the user.
  SubscriptionStatus status = 1;
}

// CancelSubscriptionRequest cancels an active subscription for a user.
message CancelSubscriptionRequest {
  // Email or customer ID to cancel.
  string user_identity = 1;
}

// CancelSubscriptionResponse reports the cancellation outcome.
message CancelSubscriptionResponse {
  // Subscription identifier that was canceled.
  optional string subscription_id = 1;
  // Resulting subscription state.
  SubscriptionState state = 2;
  // When the subscription was canceled.
  google.protobuf.Timestamp canceled_at = 3;
  // Human-readable message about the cancellation.
  optional string message = 4;
}

// CreditsBalance summarizes wallet credits for a customer.
message CreditsBalance {
  // Customer email address.
  string customer_email = 1;
  // Bundle key the credits apply to.
  string bundle_key = 2;
  // Current balance in credits.
  int64 balance_credits = 3;
  // Last updated timestamp.
  google.protobuf.Timestamp updated_at = 4;
}

// CreditTransaction describes a wallet credit/debit entry.
message CreditTransaction {
  // Unique transaction identifier.
  string id = 1;
  // Customer email associated with the transaction.
  string customer_email = 2;
  // Amount in credits (positive for additions, negative for debits).
  int64 amount_credits = 3;
  // Transaction type (e.g., credit_topup, consumption).
  string transaction_type = 4 [deprecated = true];
  // Typed transaction type; prefer over the deprecated string field.
  TransactionType type = 7;
  // Structured metadata describing the transaction.
  map<string, google.protobuf.Value> metadata = 5 [deprecated = true];
  // Typed metadata describing the transaction; prefer over the deprecated Value map.
  map<string, common.v1.JsonValue> metadata_typed = 8;
  // Creation timestamp for the transaction.
  google.protobuf.Timestamp created_at = 6;
}

// GetCreditsResponse returns the current balance and recent transactions.
message GetCreditsResponse {
  // Current credit balance.
  CreditsBalance balance = 1;
  // Recent credit transactions.
  repeated CreditTransaction transactions = 2;
}

// BillingPortalResponse supplies a hosted billing portal URL.
message BillingPortalResponse {
  // URL for the Stripe billing portal.
  string url = 1;
}

// LandingPagePaymentsService exposes billing, pricing, and settings operations.
service LandingPagePaymentsService {
  // Creates a checkout session for a Stripe price.
  rpc CreateCheckoutSession(CreateCheckoutSessionRequest) returns (CreateCheckoutSessionResponse);
  // Verifies the latest subscription status for a user.
  rpc VerifySubscription(VerifySubscriptionRequest) returns (VerifySubscriptionResponse);
  // Cancels an active subscription for a user.
  rpc CancelSubscription(CancelSubscriptionRequest) returns (CancelSubscriptionResponse);
  // Returns pricing metadata for a bundle.
  rpc GetPricing(landing_page_react_vite.v1.GetPricingRequest) returns (landing_page_react_vite.v1.GetPricingResponse);
  // Returns current Stripe settings and runtime snapshot.
  rpc GetStripeSettings(landing_page_react_vite.v1.GetStripeSettingsRequest) returns (landing_page_react_vite.v1.GetStripeSettingsResponse);
  // Updates Stripe settings and returns the refreshed snapshot.
  rpc UpdateStripeSettings(landing_page_react_vite.v1.UpdateStripeSettingsRequest) returns (landing_page_react_vite.v1.UpdateStripeSettingsResponse);
}
