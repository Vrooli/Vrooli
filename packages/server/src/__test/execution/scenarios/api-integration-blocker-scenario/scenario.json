{
  "identity": {
    "name": "api-integration-blocker-scenario",
    "description": "Payment integration subswarm hits API deprecation, parent pivots to alternative provider",
    "category": "multi-agent",
    "complexity": "standard"
  },

  "agents": [
    {
      "name": "ecommerce-coordinator",
      "role": "coordinator",
      "botConfig": {
        "__version": "1.0",
        "model": "claude-3-5-sonnet-20241022",
        "maxTokens": 2000,
        "agentSpec": {
          "goal": "Orchestrate payment integration for e-commerce checkout system",
          "subscriptions": [
            "swarm/started",
            "payment/integration_blocked",
            "payment/alternative_selected",
            "payment/migration_complete"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "swarm/started"
              },
              "action": {
                "type": "routine",
                "label": "checkout-analysis-routine",
                "inputMap": {
                  "requirements": "blackboard.payment_requirements",
                  "existingSystem": "blackboard.current_checkout_state"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "integration_plan", "blackboardId": "payment_integration_plan"},
                    {"routineOutput": "preferred_provider", "blackboardId": "target_payment_provider"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "swarm/started"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/integration_requested",
                "dataMapping": {
                  "provider": "blackboard.target_payment_provider",
                  "requirements": "blackboard.payment_requirements",
                  "timestamp": "new Date().toISOString()"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "integration_request_id"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/integration_blocked",
                "when": "event.data.reason == 'third-party-api-deprecated'"
              },
              "action": {
                "type": "routine",
                "label": "pivot-strategy-routine",
                "inputMap": {
                  "blockedProvider": "event.data.provider",
                  "blockReason": "event.data.reason",
                  "completedWork": "event.data.completed_work"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "pivot_decision", "blackboardId": "recovery_strategy"},
                    {"routineOutput": "work_preservation", "blackboardId": "preserved_components"}
                  ],
                  "append": [
                    {"routineOutput": "pivot_log", "blackboardId": "integration_history"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/integration_blocked",
                "when": "event.data.reason == 'third-party-api-deprecated'"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/alternative_research_requested",
                "dataMapping": {
                  "excludeProvider": "event.data.provider",
                  "requirements": "blackboard.payment_requirements",
                  "preserveWork": "blackboard.preserved_components"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "alternative_research_id"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/alternative_selected"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/migration_requested",
                "dataMapping": {
                  "fromProvider": "blackboard.blocked_provider",
                  "toProvider": "event.data.recommended_provider",
                  "preservedComponents": "blackboard.preserved_components"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "migration_request_id"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/migration_complete"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/integration_successful",
                "dataMapping": {
                  "finalProvider": "event.data.provider",
                  "totalDuration": "event.data.total_duration",
                  "componentsPreserved": "event.data.preserved_count"
                },
                "outputOperations": {
                  "set": [
                    {"constantValue": true, "blackboardId": "integration_complete"},
                    {"emitOutput": "eventId", "blackboardId": "success_event_id"}
                  ]
                }
              },
              "qos": 1
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You coordinate e-commerce payment integration. When subswarms hit blockers, analyze the situation and pivot to alternative strategies while preserving completed work. Focus on maintaining checkout functionality throughout the process."
          }
        }
      }
    },
    {
      "name": "stripe-integration-specialist",
      "role": "specialist",
      "botConfig": {
        "__version": "1.0",
        "model": "gpt-4",
        "maxTokens": 3000,
        "agentSpec": {
          "goal": "Integrate Stripe payment processing into e-commerce checkout",
          "subscriptions": [
            "payment/integration_requested"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "payment/integration_requested",
                "when": "event.data.provider == 'stripe'"
              },
              "action": {
                "type": "routine",
                "label": "stripe-integration-routine",
                "inputMap": {
                  "apiVersion": "blackboard.stripe_api_version",
                  "requirements": "event.data.requirements",
                  "existingCode": "blackboard.current_checkout_state"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "integration_result", "blackboardId": "stripe_integration_result"},
                    {"routineOutput": "api_status", "blackboardId": "stripe_api_status"}
                  ],
                  "append": [
                    {"routineOutput": "completed_components", "blackboardId": "completed_work"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/integration_requested",
                "when": "event.data.provider == 'stripe'"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/integration_blocked",
                "dataMapping": {
                  "provider": "'stripe'",
                  "reason": "blackboard.stripe_api_status.deprecated ? 'third-party-api-deprecated' : 'integration_failed'",
                  "details": "blackboard.stripe_api_status.deprecation_info",
                  "completed_work": "blackboard.completed_work"
                },
                "outputOperations": {
                  "set": [
                    {"constantValue": "stripe", "blackboardId": "blocked_provider"},
                    {"emitOutput": "eventId", "blackboardId": "integration_blocked_id"}
                  ]
                }
              },
              "qos": 2
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You specialize in Stripe payment integration. When you discover API deprecation or other blockers, document completed work and provide specific termination reasons to help coordinate recovery strategies."
          }
        }
      }
    },
    {
      "name": "alternative-provider-scout",
      "role": "specialist",
      "botConfig": {
        "__version": "1.0",
        "model": "gpt-4",
        "maxTokens": 3000,
        "agentSpec": {
          "goal": "Research and recommend alternative payment providers when primary integration fails",
          "subscriptions": [
            "payment/alternative_research_requested"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "payment/alternative_research_requested"
              },
              "action": {
                "type": "routine",
                "label": "provider-research-routine",
                "inputMap": {
                  "excludeProvider": "event.data.excludeProvider",
                  "requirements": "event.data.requirements",
                  "preservedWork": "event.data.preserveWork"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "research_results", "blackboardId": "provider_alternatives"},
                    {"routineOutput": "recommended_provider", "blackboardId": "best_alternative"}
                  ],
                  "append": [
                    {"routineOutput": "research_details", "blackboardId": "provider_research_history"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/alternative_research_requested"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/alternative_selected",
                "dataMapping": {
                  "recommended_provider": "blackboard.best_alternative.name",
                  "migration_complexity": "blackboard.best_alternative.migration_effort",
                  "compatibility_score": "blackboard.best_alternative.compatibility"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "alternative_selected_id"}
                  ]
                }
              },
              "qos": 1
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You research alternative payment providers when primary integration fails. Evaluate options based on compatibility with existing work, migration complexity, and feature requirements. Prioritize providers that minimize rework."
          }
        }
      }
    },
    {
      "name": "migration-specialist",
      "role": "specialist",
      "botConfig": {
        "__version": "1.0",
        "model": "gpt-3.5-turbo",
        "maxTokens": 2000,
        "agentSpec": {
          "goal": "Migrate payment integration from blocked provider to selected alternative",
          "subscriptions": [
            "payment/migration_requested"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "payment/migration_requested"
              },
              "action": {
                "type": "routine",
                "label": "payment-migration-routine",
                "inputMap": {
                  "fromProvider": "event.data.fromProvider",
                  "toProvider": "event.data.toProvider",
                  "preservedComponents": "event.data.preservedComponents"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "migration_result", "blackboardId": "migration_outcome"},
                    {"routineOutput": "final_integration", "blackboardId": "completed_integration"}
                  ],
                  "append": [
                    {"routineOutput": "migration_log", "blackboardId": "migration_history"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "payment/migration_requested"
              },
              "action": {
                "type": "emit",
                "eventType": "payment/migration_complete",
                "dataMapping": {
                  "provider": "event.data.toProvider",
                  "success": "blackboard.migration_outcome.success",
                  "preserved_count": "blackboard.migration_outcome.preserved_components",
                  "total_duration": "blackboard.migration_outcome.total_time"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "migration_complete_id"}
                  ]
                }
              },
              "qos": 1
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You migrate payment integrations from one provider to another. Preserve as much existing work as possible, adapt API calls and data structures, and ensure the new integration meets all original requirements."
          }
        }
      }
    }
  ],

  "routines": [
    {
      "name": "checkout-analysis-routine",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Analyze existing checkout system and create integration plan for payment processing. Identify requirements, constraints, and preferred provider based on system architecture."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "requirements": "{{input.requirements}}",
              "system": "{{input.existingSystem}}"
            },
            "outputMapping": {
              "integration_plan": "analysis.plan",
              "preferred_provider": "analysis.recommended_provider"
            }
          }
        }
      }
    },
    {
      "name": "stripe-integration-routine",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Attempt Stripe payment integration. Check API version compatibility, implement payment flows, and document any blockers discovered during integration."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "apiVersion": "{{input.apiVersion}}",
              "requirements": "{{input.requirements}}"
            },
            "outputMapping": {
              "integration_result": "stripe.result",
              "api_status": "stripe.api_status",
              "completed_components": "stripe.completed_work"
            }
          }
        }
      }
    },
    {
      "name": "pivot-strategy-routine",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Analyze integration blocker and create recovery strategy. Determine which completed work can be preserved and plan alternative approach."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "blocked": "{{input.blockedProvider}}",
              "reason": "{{input.blockReason}}",
              "completed": "{{input.completedWork}}"
            },
            "outputMapping": {
              "pivot_decision": "strategy.decision",
              "work_preservation": "strategy.preserved_work",
              "pivot_log": "strategy.log"
            }
          }
        }
      }
    },
    {
      "name": "provider-research-routine",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Research alternative payment providers. Evaluate PayPal, Square, Braintree, and others based on compatibility, migration effort, and feature requirements."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "exclude": "{{input.excludeProvider}}",
              "requirements": "{{input.requirements}}"
            },
            "outputMapping": {
              "research_results": "research.providers",
              "recommended_provider": "research.best_option",
              "research_details": "research.analysis"
            }
          }
        }
      }
    },
    {
      "name": "payment-migration-routine",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Migrate payment integration from blocked provider to selected alternative. Adapt existing code, update API calls, and ensure feature compatibility."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "from": "{{input.fromProvider}}",
              "to": "{{input.toProvider}}",
              "preserve": "{{input.preservedComponents}}"
            },
            "outputMapping": {
              "migration_result": "migration.result",
              "final_integration": "migration.final_state",
              "migration_log": "migration.log"
            }
          }
        }
      }
    }
  ],

  "expectedFlow": [
    {
      "step": 1,
      "agent": "ecommerce-coordinator",
      "trigger": "swarm/started",
      "action": "checkout-analysis-routine",
      "blackboardUpdates": {
        "payment_integration_plan": "Integration plan for checkout",
        "target_payment_provider": "stripe"
      }
    },
    {
      "step": 2,
      "agent": "ecommerce-coordinator",
      "trigger": "swarm/started",
      "action": "emit",
      "emittedEvents": ["payment/integration_requested"]
    },
    {
      "step": 3,
      "agent": "stripe-integration-specialist",
      "trigger": "payment/integration_requested",
      "action": "stripe-integration-routine",
      "blackboardUpdates": {
        "stripe_api_status": {"deprecated": true, "deprecation_info": "API v2 deprecated"},
        "completed_work": ["cart-component", "ui-elements"]
      }
    },
    {
      "step": 4,
      "agent": "stripe-integration-specialist",
      "trigger": "payment/integration_requested",
      "action": "emit",
      "emittedEvents": ["payment/integration_blocked"]
    },
    {
      "step": 5,
      "agent": "ecommerce-coordinator",
      "trigger": "payment/integration_blocked",
      "action": "pivot-strategy-routine",
      "blackboardUpdates": {
        "recovery_strategy": "Research alternative providers",
        "preserved_components": ["cart-component", "ui-elements"]
      }
    },
    {
      "step": 6,
      "agent": "ecommerce-coordinator",
      "trigger": "payment/integration_blocked",
      "action": "emit",
      "emittedEvents": ["payment/alternative_research_requested"]
    },
    {
      "step": 7,
      "agent": "alternative-provider-scout",
      "trigger": "payment/alternative_research_requested",
      "action": "provider-research-routine",
      "blackboardUpdates": {
        "best_alternative": {"name": "paypal", "compatibility": 0.9, "migration_effort": "low"}
      }
    },
    {
      "step": 8,
      "agent": "alternative-provider-scout",
      "trigger": "payment/alternative_research_requested",
      "action": "emit",
      "emittedEvents": ["payment/alternative_selected"]
    },
    {
      "step": 9,
      "agent": "ecommerce-coordinator",
      "trigger": "payment/alternative_selected",
      "action": "emit",
      "emittedEvents": ["payment/migration_requested"]
    },
    {
      "step": 10,
      "agent": "migration-specialist",
      "trigger": "payment/migration_requested",
      "action": "payment-migration-routine",
      "blackboardUpdates": {
        "migration_outcome": {"success": true, "preserved_components": 2, "total_time": "45min"}
      }
    },
    {
      "step": 11,
      "agent": "migration-specialist",
      "trigger": "payment/migration_requested",
      "action": "emit",
      "emittedEvents": ["payment/migration_complete"]
    },
    {
      "step": 12,
      "agent": "ecommerce-coordinator",
      "trigger": "payment/migration_complete",
      "action": "emit",
      "emittedEvents": ["payment/integration_successful"]
    }
  ],

  "resources": {
    "maxCredits": "750000000",
    "maxDurationMs": 300000,
    "quotas": {
      "gpuPercentage": 20,
      "ramGB": 12,
      "cpuCores": 3,
      "storageGB": 75
    }
  },

  "success": {
    "requiredEvents": [
      "payment/integration_requested",
      "payment/integration_blocked",
      "payment/alternative_research_requested",
      "payment/alternative_selected",
      "payment/migration_requested",
      "payment/migration_complete",
      "payment/integration_successful"
    ],
    "blackboardState": {
      "integration_complete": "true",
      "blocked_provider": "stripe",
      "best_alternative": "exists",
      "preserved_components": "length>0",
      "migration_outcome": "exists"
    },
    "routineCallsMin": 5,
    "agentCoordination": true
  },

  "initialConditions": {
    "triggerEvent": {
      "topic": "swarm/started",
      "data": {
        "task": "integrate-payment-processing",
        "timestamp": "2024-01-17T14:30:00Z"
      }
    },
    "blackboardState": {
      "payment_requirements": {
        "currencies": ["USD", "EUR"],
        "methods": ["card", "paypal", "apple_pay"],
        "features": ["recurring", "refunds", "webhooks"]
      },
      "current_checkout_state": {
        "cart_implemented": true,
        "ui_components": ["product-list", "cart-summary"],
        "existing_integrations": []
      },
      "stripe_api_version": "v2"
    }
  },

  "mocks": {
    "routineResponses": [
      {
        "routineName": "checkout-analysis-routine",
        "response": {
          "analysis": {
            "plan": {
              "phases": ["api_setup", "payment_flow", "webhook_handling", "testing"],
              "estimated_time": "2-3 days",
              "complexity": "medium"
            },
            "recommended_provider": "stripe"
          }
        }
      },
      {
        "routineName": "stripe-integration-routine",
        "response": {
          "stripe": {
            "result": {
              "success": false,
              "error": "API version v2 deprecated, minimum required: v3"
            },
            "api_status": {
              "deprecated": true,
              "deprecation_info": "Stripe API v2 deprecated as of 2024-01-01, must use v3 or higher",
              "migration_required": true
            },
            "completed_work": [
              {
                "component": "cart-component",
                "status": "completed",
                "reusable": true
              },
              {
                "component": "ui-elements",
                "status": "completed",
                "reusable": true
              },
              {
                "component": "validation-logic",
                "status": "partial",
                "reusable": true
              }
            ]
          }
        }
      },
      {
        "routineName": "pivot-strategy-routine",
        "response": {
          "strategy": {
            "decision": "research_alternative_providers",
            "preserved_work": [
              "cart-component",
              "ui-elements",
              "validation-logic"
            ],
            "log": {
              "reason": "Stripe API v2 deprecated, cannot proceed with current plan",
              "action": "Pivot to alternative provider research",
              "work_preserved": "3 components can be reused"
            }
          }
        }
      },
      {
        "routineName": "provider-research-routine",
        "response": {
          "research": {
            "providers": [
              {
                "name": "paypal",
                "compatibility": 0.9,
                "migration_effort": "low",
                "features": ["recurring", "refunds", "webhooks"],
                "api_stability": "high"
              },
              {
                "name": "square",
                "compatibility": 0.8,
                "migration_effort": "medium",
                "features": ["recurring", "refunds"],
                "api_stability": "medium"
              },
              {
                "name": "braintree",
                "compatibility": 0.85,
                "migration_effort": "medium",
                "features": ["recurring", "refunds", "webhooks"],
                "api_stability": "high"
              }
            ],
            "best_option": {
              "name": "paypal",
              "compatibility": 0.9,
              "migration_effort": "low",
              "reasoning": "Highest compatibility with existing components, lowest migration effort"
            },
            "analysis": {
              "evaluation_criteria": ["compatibility", "migration_effort", "feature_parity", "api_stability"],
              "recommendation": "PayPal provides best balance of compatibility and migration ease"
            }
          }
        }
      },
      {
        "routineName": "payment-migration-routine",
        "response": {
          "migration": {
            "result": {
              "success": true,
              "preserved_components": 2,
              "total_time": "45min",
              "new_components": ["paypal-sdk-integration", "webhook-handlers"]
            },
            "final_state": {
              "provider": "paypal",
              "features_implemented": ["card_payments", "paypal_payments", "refunds", "webhooks"],
              "integration_complete": true
            },
            "log": {
              "steps": [
                "Analyzed existing cart component - fully reusable",
                "Adapted UI elements for PayPal branding",
                "Implemented PayPal SDK integration",
                "Created webhook handlers for payment events",
                "Tested payment flow end-to-end"
              ],
              "preserved_work": "Successfully reused cart logic and UI foundation",
              "new_work": "PayPal-specific API integration and webhook handling"
            }
          }
        }
      }
    ]
  }
}