{
  "identity": {
    "name": "redis-fix-loop",
    "description": "Multi-agent Redis connection fix with retry coordination and progressive improvement",
    "category": "multi-agent",
    "complexity": "standard"
  },

  "agents": [
    {
      "name": "redis-loop-coordinator",
      "role": "coordinator",
      "botConfig": {
        "__version": "1.0",
        "model": "claude-3-5-sonnet-20241022",
        "maxTokens": 2000,
        "agentSpec": {
          "goal": "Coordinate retry loop for Redis fix attempts until successful validation",
          "subscriptions": [
            "custom/redis/validation_complete"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "custom/redis/validation_complete",
                "when": "event.data.validation_status.success == false && event.data.fix_attempt < 5"
              },
              "action": {
                "type": "routine",
                "label": "retry-coordinator",
                "inputMap": {
                  "attemptNumber": "event.data.fix_attempt",
                  "validationResult": "event.data.validation_status"
                },
                "outputOperations": {
                  "increment": [
                    {"routineOutput": "retryCount", "blackboardId": "total_retries"}
                  ],
                  "append": [
                    {"routineOutput": "retryDetails", "blackboardId": "retry_history"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "custom/redis/validation_complete",
                "when": "event.data.validation_status.success == false && event.data.fix_attempt < 5"
              },
              "action": {
                "type": "emit",
                "eventType": "custom/redis/fix_requested",
                "dataMapping": {
                  "attemptNumber": "event.data.fix_attempt + 1",
                  "previousResult": "event.data.validation_status",
                  "retryReason": "'Validation failed, retrying fix'"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "last_retry_request"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "custom/redis/validation_complete",
                "when": "event.data.validation_status.success == true"
              },
              "action": {
                "type": "emit",
                "eventType": "custom/redis/fix_successful",
                "dataMapping": {
                  "totalAttempts": "event.data.fix_attempt",
                  "finalResult": "event.data.validation_status",
                  "successMessage": "'Redis connection successfully fixed'"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "success_event_id"},
                    {"emitOutput": "timestamp", "blackboardId": "success_timestamp"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "custom/redis/validation_complete",
                "when": "event.data.fix_attempt >= 5 && event.data.validation_status.success == false"
              },
              "action": {
                "type": "emit",
                "eventType": "custom/redis/fix_failed",
                "dataMapping": {
                  "reason": "'Maximum retry attempts exceeded'",
                  "totalAttempts": "event.data.fix_attempt",
                  "lastResult": "event.data.validation_status"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "failure_event_id"}
                  ]
                }
              },
              "qos": 1
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You coordinate Redis fix retry loops. Monitor validation results and trigger retries when fixes fail, up to 5 attempts maximum. Emit success events when validation passes."
          }
        }
      }
    },
    {
      "name": "redis-problem-fixer",
      "role": "specialist",
      "botConfig": {
        "__version": "1.0",
        "model": "gpt-4",
        "maxTokens": 4000,
        "agentSpec": {
          "goal": "Apply progressive fixes to Redis connection issues based on attempt number and previous results",
          "subscriptions": [
            "custom/redis/fix_requested"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "custom/redis/fix_requested"
              },
              "action": {
                "type": "routine",
                "label": "redis-connection-fixer",
                "inputMap": {
                  "attemptNumber": "event.data.attemptNumber",
                  "previousResult": "event.data.previousResult",
                  "errorLogs": "blackboard.last_error_logs"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "fix_applied", "blackboardId": "current_fix"},
                    {"routineOutput": "attempt_number", "blackboardId": "fix_attempt"}
                  ],
                  "append": [
                    {"routineOutput": "fixDetails", "blackboardId": "fix_history"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "custom/redis/fix_requested"
              },
              "action": {
                "type": "emit",
                "eventType": "custom/redis/ready_for_validation",
                "dataMapping": {
                  "fixApplied": "blackboard.current_fix",
                  "attemptNumber": "blackboard.fix_attempt",
                  "timestamp": "new Date().toISOString()"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "validation_request_id"}
                  ]
                }
              },
              "qos": 1
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You are a Redis connection specialist. Apply progressive fixes based on attempt number: 1) connection pool settings, 2) retry logic with backoff, 3) connection keepalive, 4) advanced diagnostics, 5) comprehensive overhaul. Each attempt should be more sophisticated than the last."
          }
        }
      }
    },
    {
      "name": "redis-fix-validator",
      "role": "monitor",
      "botConfig": {
        "__version": "1.0",
        "model": "gpt-3.5-turbo",
        "maxTokens": 2000,
        "agentSpec": {
          "goal": "Validate Redis connection fixes by testing connection stability and performance",
          "subscriptions": [
            "custom/redis/ready_for_validation"
          ],
          "behaviors": [
            {
              "trigger": {
                "topic": "custom/redis/ready_for_validation"
              },
              "action": {
                "type": "routine",
                "label": "redis-validation-workflow",
                "inputMap": {
                  "fixDetails": "event.data.fixApplied",
                  "attemptNumber": "event.data.attemptNumber"
                },
                "outputOperations": {
                  "set": [
                    {"routineOutput": "validation_result", "blackboardId": "validation_status"}
                  ],
                  "append": [
                    {"routineOutput": "testResults", "blackboardId": "validation_history"}
                  ]
                }
              },
              "qos": 1
            },
            {
              "trigger": {
                "topic": "custom/redis/ready_for_validation"
              },
              "action": {
                "type": "emit",
                "eventType": "custom/redis/validation_complete",
                "dataMapping": {
                  "validation_status": "blackboard.validation_status",
                  "fix_attempt": "event.data.attemptNumber",
                  "timestamp": "new Date().toISOString()"
                },
                "outputOperations": {
                  "set": [
                    {"emitOutput": "eventId", "blackboardId": "validation_complete_id"}
                  ],
                  "increment": [
                    {"emitOutput": "validationCount", "blackboardId": "total_validations"}
                  ]
                }
              },
              "qos": 1
            }
          ],
          "prompt": {
            "mode": "supplement",
            "source": "direct",
            "content": "You validate Redis connection fixes through comprehensive testing. Test connection stability, performance, and edge cases. Provide detailed validation results with success status and diagnostic information."
          }
        }
      }
    }
  ],

  "routines": [
    {
      "name": "retry-coordinator",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Coordinate retry logic for Redis fix attempts. Analyze the validation result and determine the next retry strategy. Track retry count and progression."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "attempt": "{{input.attemptNumber}}",
              "result": "{{input.validationResult}}"
            },
            "outputMapping": {
              "retryCount": "1",
              "retryDetails": "coordination.retryInfo"
            }
          }
        }
      }
    },
    {
      "name": "redis-connection-fixer",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Apply progressive Redis connection fixes based on attempt number. Attempt 1: connection pool settings, Attempt 2: retry logic with backoff, Attempt 3: connection keepalive, Attempt 4+: advanced diagnostics and comprehensive fixes."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "attempt": "{{input.attemptNumber}}",
              "previous": "{{input.previousResult}}",
              "logs": "{{input.errorLogs}}"
            },
            "outputMapping": {
              "fix_applied": "fix.description",
              "attempt_number": "fix.attemptNumber",
              "fixDetails": "fix.details"
            }
          }
        }
      }
    },
    {
      "name": "redis-validation-workflow",
      "type": "generate",
      "config": {
        "resourceSubType": "RoutineGenerate",
        "instructions": [
          {
            "type": "text",
            "text": "Validate Redis connection by testing stability, performance, and various operations. Provide comprehensive validation results with success status and detailed diagnostic information."
          }
        ],
        "callDataGenerate": {
          "schema": {
            "inputTemplate": {
              "fix": "{{input.fixDetails}}",
              "attempt": "{{input.attemptNumber}}"
            },
            "outputMapping": {
              "validation_result": "validation.result",
              "testResults": "validation.tests"
            }
          }
        }
      }
    }
  ],

  "expectedFlow": [
    {
      "step": 1,
      "agent": "redis-problem-fixer",
      "trigger": "custom/redis/fix_requested",
      "action": "redis-connection-fixer",
      "blackboardUpdates": {
        "current_fix": "Updated connection pool settings",
        "fix_attempt": 1
      }
    },
    {
      "step": 2,
      "agent": "redis-problem-fixer",
      "trigger": "custom/redis/fix_requested",
      "action": "emit",
      "emittedEvents": ["custom/redis/ready_for_validation"]
    },
    {
      "step": 3,
      "agent": "redis-fix-validator",
      "trigger": "custom/redis/ready_for_validation",
      "action": "redis-validation-workflow",
      "blackboardUpdates": {
        "validation_status": {"success": false, "logs": "Connection timeout"}
      }
    },
    {
      "step": 4,
      "agent": "redis-fix-validator",
      "trigger": "custom/redis/ready_for_validation",
      "action": "emit",
      "emittedEvents": ["custom/redis/validation_complete"]
    },
    {
      "step": 5,
      "agent": "redis-loop-coordinator",
      "trigger": "custom/redis/validation_complete",
      "action": "retry-coordinator",
      "blackboardUpdates": {
        "total_retries": 1
      }
    },
    {
      "step": 6,
      "agent": "redis-loop-coordinator",
      "trigger": "custom/redis/validation_complete",
      "action": "emit",
      "emittedEvents": ["custom/redis/fix_requested"]
    }
  ],

  "resources": {
    "maxCredits": "500000000",
    "maxDurationMs": 300000,
    "quotas": {
      "gpuPercentage": 20,
      "ramGB": 16,
      "cpuCores": 4,
      "storageGB": 100
    }
  },

  "success": {
    "requiredEvents": [
      "custom/redis/fix_requested",
      "custom/redis/ready_for_validation",
      "custom/redis/validation_complete",
      "custom/redis/fix_successful"
    ],
    "blackboardState": {
      "validation_status": "exists",
      "fix_attempt": ">=1",
      "current_fix": "exists",
      "total_validations": ">=1"
    },
    "routineCallsMin": 6,
    "agentCoordination": true
  },

  "initialConditions": {
    "triggerEvent": {
      "topic": "custom/redis/fix_requested",
      "data": {
        "attemptNumber": 1,
        "previousResult": null,
        "retryReason": "Initial Redis connection failure detected"
      }
    },
    "blackboardState": {
      "last_error_logs": "Redis connection timeout after 5 seconds, ECONNREFUSED"
    }
  },

  "mocks": {
    "routineResponses": [
      {
        "routineName": "redis-connection-fixer",
        "attempt": 1,
        "response": {
          "fix": {
            "description": "Updated connection pool settings",
            "attemptNumber": 1,
            "details": "Increased max connections and adjusted timeout values"
          }
        }
      },
      {
        "routineName": "redis-connection-fixer", 
        "attempt": 2,
        "response": {
          "fix": {
            "description": "Added retry logic with exponential backoff",
            "attemptNumber": 2,
            "details": "Implemented 3-retry strategy with 100ms initial delay"
          }
        }
      },
      {
        "routineName": "redis-connection-fixer",
        "attempt": 3,
        "response": {
          "fix": {
            "description": "Implemented connection keepalive",
            "attemptNumber": 3,
            "details": "Added heartbeat mechanism and connection health monitoring"
          }
        }
      },
      {
        "routineName": "redis-validation-workflow",
        "attempt": 1,
        "response": {
          "validation": {
            "result": {
              "success": false,
              "logs": "Connection timeout after 5 seconds"
            },
            "tests": ["connection_test", "ping_test", "basic_operations"]
          }
        }
      },
      {
        "routineName": "redis-validation-workflow",
        "attempt": 2,
        "response": {
          "validation": {
            "result": {
              "success": false,
              "logs": "Partial improvement - some operations succeed"
            },
            "tests": ["connection_test", "ping_test", "basic_operations", "stress_test"]
          }
        }
      },
      {
        "routineName": "redis-validation-workflow",
        "attempt": 3,
        "response": {
          "validation": {
            "result": {
              "success": true,
              "logs": "All operations successful - connection stable"
            },
            "tests": ["connection_test", "ping_test", "basic_operations", "stress_test", "edge_cases"]
          }
        }
      },
      {
        "routineName": "retry-coordinator",
        "response": {
          "coordination": {
            "retryInfo": {
              "strategy": "progressive_improvement",
              "nextAction": "escalate_fix_complexity"
            }
          }
        }
      }
    ]
  }
}