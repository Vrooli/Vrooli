/**
 * Unified Result Types for Clean Data Flow
 * 
 * These result types provide a consistent interface for returning execution
 * results across all tiers and services. They maintain compatibility with
 * existing ExecutionResult types while adding specific result information.
 * 
 * Design Principles:
 * - Consistent success/error handling
 * - Unified resource tracking
 * - Rich metadata for debugging and monitoring
 * - Compatible with existing ExecutionResult
 */

import type { ChatMessage } from "../api/types.js";
import type { BotParticipant } from "./context.js";
import type { ToolCall, MessageState } from "./conversation.js";
import type { ExecutionError, ExecutionResourceUsage } from "./core.js";
import type { BotId, SwarmId, TurnId } from "./ids.js";

/**
 * Base result interface shared across all execution operations
 * Provides consistent success/error handling and resource tracking
 */
export interface BaseResult {
    /** Whether the operation completed successfully */
    success: boolean;

    /** Resources consumed during execution */
    resourcesUsed: ExecutionResourceUsage;

    /** Total execution duration in milliseconds */
    duration: number;

    /** Optional metadata for debugging and monitoring */
    metadata?: Record<string, unknown>;

    /** Error information if the operation failed */
    error?: ExecutionError;
}

/**
 * Result from individual bot response generation
 * Contains the generated message and execution details
 */
export interface ResponseResult extends BaseResult {
    /** The message generated by the bot (lightweight conversation format) */
    message: MessageState;

    /** Tool calls made during response generation (if any) */
    toolCalls?: ToolCall[];

    /** AI confidence score for the response (0-1) */
    confidence?: number;

    /** Whether the conversation should continue after this response */
    continueConversation: boolean;

    /** The bot that generated this response */
    botId?: BotId;

    /** Response-specific metadata */
    metadata?: {
        /** Execution strategy used */
        strategy?: string;

        /** Model used for generation */
        model?: string;

        /** Token counts */
        tokens?: {
            input?: number;
            output?: number;
            total?: number;
        };

        /** Tool execution details */
        toolExecutionDetails?: Array<{
            toolName: string;
            success: boolean;
            duration: number;
            creditsUsed: string;
        }>;
    } & Record<string, unknown>;
}

/**
 * Result from conversation orchestration
 * Contains all messages generated and conversation state updates
 */
export interface ConversationResult extends BaseResult {
    /** All messages generated during this conversation turn */
    messages: MessageState[];

    /** Updated participant states after the conversation */
    updatedParticipants: BotParticipantResult[];

    /** What should happen next in the conversation */
    nextAction?: ConversationAction;

    /** Whether the conversation has completed */
    conversationComplete: boolean;

    /** Unique identifier for this conversation turn */
    turnId: TurnId;

    /** The swarm this conversation belongs to */
    swarmId: SwarmId;

    /** Conversation-specific metadata */
    metadata?: {
        /** Number of bots that participated */
        participantCount?: number;

        /** Conversation strategy used */
        strategy?: string;

        /** Turn number in the conversation */
        turnNumber?: number;

        /** Reason the conversation ended (if complete) */
        completionReason?: string;

        /** Bot selection details */
        botSelection?: {
            requested: BotId[];
            selected: BotId[];
            selectionReason: string;
            fallbackUsed: boolean;
        };
    } & Record<string, unknown>;
}

/**
 * Result from a bot's participation in a conversation
 */
export interface BotParticipantResult {
    /** The bot that participated */
    botId: BotId;

    /** Whether the bot successfully participated */
    success: boolean;

    /** Message generated by this bot (if any) */
    message?: MessageState;

    /** Updated state of this bot */
    updatedState: BotParticipant;

    /** Resources used by this bot */
    resourcesUsed: ExecutionResourceUsage;

    /** Error if the bot failed to participate */
    error?: ExecutionError;
}

/**
 * Actions that can happen next in a conversation
 */
export type ConversationAction =
    | { type: "continue"; participants?: BotId[]; reason: string }
    | { type: "wait_for_user"; prompt?: string }
    | { type: "complete"; result: string; reason: string }
    | { type: "error"; error: ExecutionError }
    | { type: "delegate_to_tool"; toolName: string; parameters: Record<string, unknown> }
    | { type: "escalate"; reason: string; targetTier?: "tier1" | "tier2" };
