# Logging

Effective logging is crucial for monitoring, debugging, and understanding the behavior of the Vrooli application in all environments. This guide details the different types of logs, their configuration, and how to access them.

> **Prerequisites**: Familiarity with [Docker](./server-deployment.md#docker-deployment) and [Environment Variables](./getting-started/environment-variables.md).
> **Related**: [Server Deployment](./server-deployment.md), [Troubleshooting](./troubleshooting.md)

## Log Types and Access

### 1. Console Logs (Development & UI)

Console logs are primarily used during development for immediate feedback.

*   **UI Code**: Viewable in the browser's developer console (e.g., Chrome DevTools, Firefox Developer Tools).
*   **Server Code (Development)**: Server logs, including those from Winston, are output to the console when running in a local development environment (not in production mode).

### 2. Application Logs (Winston)

The server and background jobs utilize [Winston](https://github.com/winstonjs/winston) for structured logging.

*   **Configuration**: Logging behavior is controlled by [Environment Variables](./getting-started/environment-variables.md):
    *   `LOG_LEVEL`: Sets the verbosity (e.g., `debug`, `info`, `warn`, `error`).
    *   `LOG_FORMAT`: Output format (`json` for production, `pretty` for development).
    *   `LOG_FILE`: Path to the log file in production (e.g., `/var/log/vrooli/app.log`).
    *   `ENABLE_STRUCTURED_LOGGING`: Enables structured (JSON) logging.
    *   `LOG_CORRELATION_ID`: Enables request correlation IDs in logs.
*   **Production Mode**: Logs are written to the file specified by `LOG_FILE`. Console output is typically minimized or disabled.
*   **Development Mode**: Logs are typically output to the console with a `pretty` format for readability, and may also write to a local file if configured.
*   **Accessing Log Files**: On the server, you can access these files directly (e.g., `tail -f /var/log/vrooli/app.log`) or via centralized logging solutions if implemented.

### 3. Container Logs (Docker)

When Vrooli services run in Docker containers (common for staging and production, and the `docker-daemon` development target), logs generated by the applications (including Winston logs) are captured by Docker.

*   **Accessing Docker Logs**: Use the `docker logs` command:
    ```bash
    docker logs <container_name_or_id>
    # To follow logs in real-time:
    docker logs -f <container_name_or_id>
    # To see the last N lines:
    docker logs --tail N <container_name_or_id>
    ```
    Container names can be found using `docker ps`. Common service container names might be `vrooli-server`, `vrooli-ui`, `vrooli-jobs`.
*   **Docker Logging Driver**: Docker's logging behavior (e.g., log rotation, destination) is configured at the Docker daemon level. The [Server Deployment Guide](./server-deployment.md#log-management) details setting up the `json-file` logging driver with size and file rotation, which is crucial for preventing logs from consuming excessive disk space.
    ```json
    // Example /etc/docker/daemon.json configuration
    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m", // Max size of a log file
        "max-file": "3"    // Max number of log files to keep
      }
    }
    ```
    A `sudo systemctl restart docker` is required after changing `daemon.json`.

## Centralized Logging (Production Environments)

For production environments, especially with multiple services or containers, relying solely on local file or `docker logs` can be inefficient. Centralized logging solutions are recommended.

*   **Common Solutions**: ELK Stack (Elasticsearch, Logstash, Kibana), Grafana Loki, Splunk, Datadog, etc.
*   **Benefits**:
    *   Aggregated view of logs from all services.
    *   Advanced search and filtering capabilities.
    *   Alerting based on log patterns.
    *   Long-term storage and archiving.
*   **Integration**: These systems typically involve configuring Docker or the applications to forward logs to a central collector. The [Server Deployment Guide](./server-deployment.md#monitoring--observability) touches on Prometheus and Grafana, which are often used alongside logging systems like Loki.

## Log Rotation and Management

*   **Application Logs (`LOG_FILE`)**: If Winston is writing directly to files outside of Docker's stdout/stderr capture (e.g., in a non-containerized setup or if specifically configured), standard Linux tools like `logrotate` should be configured to manage these files (rotation, compression, deletion).
*   **Docker Container Logs**: As mentioned, Docker's `json-file` driver with `max-size` and `max-file` options provides basic log rotation for container logs. For more advanced needs, consider a logging driver that forwards to a centralized system.

## Best Practices for Logging

*   **Structured Logging**: Use JSON or another structured format, especially in production. This makes logs machine-readable and easier to parse, query, and analyze. (`LOG_FORMAT=json` and `ENABLE_STRUCTURED_LOGGING=true`).
*   **Appropriate Log Levels**: Use `debug` for detailed development information, `info` for routine operations, `warn` for potential issues, and `error` or `fatal` for critical problems.
*   **Meaningful Messages**: Log messages should be clear, concise, and provide enough context to understand the event.
*   **Include Contextual Information**: Log correlation IDs (`LOG_CORRELATION_ID`), user IDs (if applicable and safe), request IDs, and service names to trace operations across distributed systems.
*   **Avoid Sensitive Data**: Never log passwords, API keys, personal identifiable information (PII), or other sensitive data unless absolutely necessary and properly secured/masked.
*   **Performance**: Be mindful of logging overhead. Excessive logging, especially synchronous logging in critical paths, can impact application performance.

This guide provides a foundation for understanding and managing logs within the Vrooli project. Refer to specific tool documentation and the [Troubleshooting Guide](./troubleshooting.md) for more detailed debugging techniques. 