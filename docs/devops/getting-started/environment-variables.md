# Environment Variables Reference

This document provides a comprehensive reference for all environment variables used in Vrooli across development, staging, and production environments.

## Environment Structure

Vrooli uses environment-specific configuration files:
- `.env-dev` - Development environment
- `.env-staging` - Staging environment (optional)
- `.env-prod` - Production environment

## Core Environment Variables

### Environment Classification

```bash
# Environment type (determines other default settings)
ENVIRONMENT=development        # development | staging | production

# Node.js environment (affects logging, optimization, etc.)
NODE_ENV=development          # development | production

# Location (affects script behavior)
LOCATION=local               # local | remote
```

### Secrets Management

```bash
# How secrets are loaded
SECRETS_SOURCE=file          # file | vault

# Vault configuration (when SECRETS_SOURCE=vault)
VAULT_ADDR=http://127.0.0.1:8200
VAULT_AUTH_METHOD=approle    # token | approle | kubernetes
VAULT_ROLE_ID=your-role-id
VAULT_SECRET_ID=your-secret-id
VAULT_SECRET_PATH=secret/data/vrooli/config/shared-all
```

## Application Configuration

### Server Configuration

```bash
# API server settings
PORT_SERVER=5329
API_URL=http://localhost:5329

# For production with custom domain
API_URL=https://api.example.com
```

### UI Configuration

```bash
# UI development server settings
PORT_UI=3000
UI_URL=http://localhost:3000

# For production
UI_URL=https://example.com
```

### Application URLs

```bash
# Main application URL (used for redirects, emails, etc.)
SITE_URL=http://localhost:3000

# For production
SITE_URL=https://example.com
```

## Database Configuration

### PostgreSQL

```bash
# Database connection settings
DB_HOST=localhost            # or container name for Docker: postgres
DB_PORT=5432
DB_NAME=postgres
DB_USER=vrooli_dev          # vrooli_dev | vrooli_staging | vrooli_prod
DB_PASSWORD=<auto-generated> # Secure random password

# Constructed database URL (auto-generated)
DB_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}

# Connection pool settings
DB_POOL_MIN=2
DB_POOL_MAX=10
```

### Database Environment Examples

**Development:**
```bash
DB_HOST=localhost
DB_USER=vrooli_dev
DB_PASSWORD=dev_secure_password_123
```

**Docker Target:**
```bash
DB_HOST=postgres             # Container name
DB_USER=vrooli_dev
DB_PASSWORD=dev_secure_password_123
```

**Production:**
```bash
DB_HOST=postgres             # Or external database host
DB_USER=vrooli_prod
DB_PASSWORD=prod_super_secure_password_xyz
```

## Cache Configuration

### Redis

```bash
# Redis connection settings
REDIS_HOST=localhost         # or container name for Docker: redis
REDIS_PORT=6379
REDIS_PASSWORD=<auto-generated>

# Constructed Redis URL (auto-generated)
REDIS_URL=redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}

# Redis configuration
REDIS_MAX_RETRIES=3
REDIS_RETRY_DELAY=1000
```

### Redis Environment Examples

**Development:**
```bash
REDIS_HOST=localhost
REDIS_PASSWORD=redis_dev_password_123
```

**Docker Target:**
```bash
REDIS_HOST=redis             # Container name
REDIS_PASSWORD=redis_dev_password_123
```

**Production:**
```bash
REDIS_HOST=redis             # Or external Redis host
REDIS_PASSWORD=redis_prod_super_secure_xyz
```

## Authentication & Security

### JWT Configuration

```bash
# JWT signing keys (auto-generated during setup)
JWT_PRIV=<base64-encoded-private-key>
JWT_PUB=<base64-encoded-public-key>

# JWT settings
JWT_EXPIRATION=24h
JWT_REFRESH_EXPIRATION=7d
```

### Session Configuration

```bash
# Session settings
SESSION_SECRET=<auto-generated-secret>
SESSION_MAX_AGE=86400000     # 24 hours in milliseconds
SESSION_SECURE=false         # true for HTTPS in production
```

### CORS Configuration

```bash
# CORS settings (auto-configured based on ENVIRONMENT)
CORS_ORIGIN=${UI_URL}        # Development: http://localhost:3000
# Production: https://example.com
```

## External Services

### AI Services

```bash
# OpenAI configuration
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_ORG_ID=org-your-org-id          # Optional
OPENAI_MODEL=gpt-4                     # Default model

# Anthropic configuration
ANTHROPIC_API_KEY=sk-ant-your-key
ANTHROPIC_MODEL=claude-3-sonnet-20240229

# Other AI services
GOOGLE_AI_API_KEY=your-google-ai-key
MISTRAL_API_KEY=your-mistral-key
```

### Payment Services

```bash
# Stripe configuration
STRIPE_PUBLIC_KEY=pk_test_your-public-key    # pk_live_ for production
STRIPE_SECRET_KEY=sk_test_your-secret-key    # sk_live_ for production
STRIPE_WEBHOOK_SECRET=whsec_your-webhook-secret
```

### Email Services

```bash
# Email configuration
SITE_EMAIL_FROM=noreply@example.com
SITE_EMAIL_REPLY_TO=support@example.com

# SMTP settings (if using SMTP)
SITE_EMAIL_USERNAME=your-email@domain.com
SITE_EMAIL_PASSWORD=your-email-password
SITE_EMAIL_HOST=smtp.domain.com
SITE_EMAIL_PORT=587
SITE_EMAIL_SECURE=false      # true for port 465

# SendGrid (alternative)
SENDGRID_API_KEY=SG.your-sendgrid-api-key

# Mailgun (alternative)
MAILGUN_API_KEY=your-mailgun-api-key
MAILGUN_DOMAIN=mg.example.com
```

## Development Tools

### Hot Reload & Development

```bash
# Development server settings
HOT_RELOAD=true
WATCH_FILES=true
DEVELOPMENT_LOGGING=true

# Build optimization
BUILD_OPTIMIZATION=false     # true for production builds
SOURCE_MAPS=true            # false for production
```

### Testing Configuration

```bash
# Test environment
NODE_ENV=test
DB_NAME=vrooli_test
REDIS_DB=1                  # Use different Redis database for tests

# Test-specific settings
SKIP_AUTH=false
MOCK_EXTERNAL_APIS=true
TEST_TIMEOUT=30000
```

## Production-Specific Variables

### SSL & Domain Configuration

```bash
# Domain configuration
VIRTUAL_HOST=example.com,api.example.com
LETSENCRYPT_HOST=example.com,api.example.com
LETSENCRYPT_EMAIL=admin@example.com

# SSL settings
SSL_POLICY=Mozilla-Modern
HTTPS_METHOD=redirect
```

### Performance & Monitoring

```bash
# Performance settings
NODE_OPTIONS=--max-old-space-size=4096
UV_THREADPOOL_SIZE=16

# Monitoring
ENABLE_METRICS=true
METRICS_PORT=9090
ENABLE_HEALTH_CHECKS=true
HEALTH_CHECK_PATH=/healthcheck
```

### Logging Configuration

```bash
# Logging levels
LOG_LEVEL=info              # debug | info | warn | error
LOG_FORMAT=json             # json | pretty
LOG_FILE=/var/log/vrooli/app.log

# Structured logging
ENABLE_STRUCTURED_LOGGING=true
LOG_CORRELATION_ID=true
```

## Environment-Specific Examples

### Complete Development Environment (`.env-dev`)

```bash
# Environment
ENVIRONMENT=development
NODE_ENV=development
LOCATION=local
SECRETS_SOURCE=file

# Application
PORT_SERVER=5329
PORT_UI=3000
API_URL=http://localhost:5329
UI_URL=http://localhost:3000
SITE_URL=http://localhost:3000

# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=postgres
DB_USER=vrooli_dev
DB_PASSWORD=dev_secure_password_123

# Cache
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis_dev_password_123

# Security
JWT_PRIV=<auto-generated>
JWT_PUB=<auto-generated>
SESSION_SECRET=<auto-generated>

# External Services (add your keys)
OPENAI_API_KEY=sk-your-dev-api-key
STRIPE_PUBLIC_KEY=pk_test_your-public-key
STRIPE_SECRET_KEY=sk_test_your-secret-key

# Email (development)
SITE_EMAIL_FROM=dev@localhost
SITE_EMAIL_USERNAME=dev@localhost
SITE_EMAIL_HOST=localhost
SITE_EMAIL_PORT=1025

# Development tools
HOT_RELOAD=true
DEVELOPMENT_LOGGING=true
BUILD_OPTIMIZATION=false
SOURCE_MAPS=true
```

### Complete Production Environment (`.env-prod`)

```bash
# Environment
ENVIRONMENT=production
NODE_ENV=production
LOCATION=remote
SECRETS_SOURCE=vault

# Vault configuration
VAULT_ADDR=https://vault.example.com
VAULT_AUTH_METHOD=approle
VAULT_ROLE_ID=prod-role-id
VAULT_SECRET_ID=prod-secret-id

# Application
API_URL=https://api.example.com
UI_URL=https://example.com
SITE_URL=https://example.com

# Database (from Vault or set here)
DB_HOST=postgres
DB_PORT=5432
DB_NAME=postgres
DB_USER=vrooli_prod
DB_PASSWORD=<from-vault-or-secure-password>

# Cache (from Vault or set here)
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=<from-vault-or-secure-password>

# SSL & Domain
VIRTUAL_HOST=example.com,api.example.com
LETSENCRYPT_HOST=example.com,api.example.com
LETSENCRYPT_EMAIL=admin@example.com

# External Services (from Vault)
OPENAI_API_KEY=<from-vault>
STRIPE_PUBLIC_KEY=pk_live_your-public-key
STRIPE_SECRET_KEY=<from-vault>

# Email (production)
SITE_EMAIL_FROM=noreply@example.com
SITE_EMAIL_REPLY_TO=support@example.com
SENDGRID_API_KEY=<from-vault>

# Performance
NODE_OPTIONS=--max-old-space-size=4096
ENABLE_METRICS=true
LOG_LEVEL=info
LOG_FORMAT=json
```

## Variable Validation

### Required Variables Check

```bash
#!/bin/bash
# Environment validation script

REQUIRED_VARS=(
    "ENVIRONMENT"
    "NODE_ENV"
    "DB_HOST"
    "DB_USER"
    "DB_PASSWORD"
    "REDIS_HOST"
    "REDIS_PASSWORD"
    "JWT_PRIV"
    "JWT_PUB"
    "API_URL"
    "UI_URL"
)

echo "Validating environment variables..."

for var in "${REQUIRED_VARS[@]}"; do
    if [ -z "${!var}" ]; then
        echo "❌ Missing required variable: $var"
        exit 1
    else
        echo "✅ $var is set"
    fi
done

echo "All required variables are set!"
```

### Environment File Syntax Check

```bash
#!/bin/bash
# Check .env file syntax

ENV_FILE=${1:-.env-dev}

if [ ! -f "$ENV_FILE" ]; then
    echo "❌ Environment file not found: $ENV_FILE"
    exit 1
fi

echo "Checking syntax of $ENV_FILE..."

# Check for common syntax issues
grep -n "^[^#].*[[:space:]]=" "$ENV_FILE" && echo "❌ Found spaces around = (line above)"
grep -n "^[^#].*=.*[[:space:]]$" "$ENV_FILE" && echo "❌ Found trailing spaces (line above)"
grep -n "^[[:space:]]" "$ENV_FILE" && echo "❌ Found leading spaces (line above)"

# Test loading
if set -a && source "$ENV_FILE" 2>/dev/null; then
    echo "✅ Environment file syntax is valid"
else
    echo "❌ Environment file has syntax errors"
    exit 1
fi
```

## Security Considerations

### Sensitive Variables

Never commit these variables to version control:
- `DB_PASSWORD`
- `REDIS_PASSWORD`
- `JWT_PRIV`
- `SESSION_SECRET`
- Any API keys (`OPENAI_API_KEY`, `STRIPE_SECRET_KEY`, etc.)
- `VAULT_SECRET_ID`

### Environment File Security

```bash
# Set proper permissions for environment files
chmod 600 .env-*

# Verify permissions
ls -la .env-*

# Should show: -rw------- (600)
```

### Vault Integration

For production environments, use HashiCorp Vault:

```bash
# Store sensitive variables in Vault
vault kv put secret/data/vrooli/secrets/shared-server-jobs \
  DB_PASSWORD="secure-db-password" \
  REDIS_PASSWORD="secure-redis-password" \
  OPENAI_API_KEY="sk-your-api-key"

# Configure application to load from Vault
echo "SECRETS_SOURCE=vault" >> .env-prod
```

## Troubleshooting

### Common Issues

1. **Environment file not loading**:
   ```bash
   # Check file exists and has correct permissions
   ls -la .env-dev
   
   # Check for syntax errors
   bash -n .env-dev
   ```

2. **Variables not expanding**:
   ```bash
   # Ensure proper quoting
   # Good: DB_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}"
   # Bad:  DB_URL=postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME
   ```

3. **Missing variables in application**:
   ```bash
   # Check if variables are being loaded
   node -e "console.log(process.env.DB_HOST)"
   
   # Verify environment file is being sourced
   source .env-dev && echo $DB_HOST
   ```

For more troubleshooting, see [Troubleshooting Guide](../troubleshooting.md#environment--secrets-issues). 