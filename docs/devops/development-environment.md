# Development Environment Setup

This guide covers setting up a comprehensive development environment for Vrooli using the sophisticated scripting infrastructure, ensuring a clean, isolated, and production-like environment for development and testing.

> **Prerequisites**: See [Prerequisites Guide](./getting-started/prerequisites.md) for required tools installation.
> **Environment Management**: For detailed environment configuration, see [Environment Management](./environment-management.md).
> **Environment Variables**: For complete variable reference, see [Environment Variables Guide](./getting-started/environment-variables.md).
> **SSH Setup**: For SSH key configuration, see [SSH Setup Guide](./getting-started/ssh-setup.md).
> **Troubleshooting**: For common issues, see [Troubleshooting Guide](./troubleshooting.md#development-environment-issues).

## Overview

Vrooli's development environment provides:

- ðŸŽ¯ **Multiple Development Targets**: Local services, Docker, and Kubernetes development
- ðŸ” **Advanced Secret Management**: File-based and Vault-based configuration
- ðŸ—ï¸ **Automated Setup**: Sophisticated scripting for environment preparation
- ðŸ§ª **Integrated Testing**: BATS testing framework and quality assurance
- ðŸ› ï¸ **Modern Tooling**: PNPM, TypeScript, ESLint, and advanced debugging

## Quick Start

> **Note**: Ensure you have completed the [Prerequisites](./getting-started/prerequisites.md) before proceeding.

### 1. Clone and Initial Setup

```bash
# Clone the repository
git clone https://github.com/Vrooli/Vrooli.git
cd Vrooli

# Run the automated setup and start development
bash scripts/main/develop.sh --target local-services
```

This single command will:
- âœ… Install all required dependencies
- âœ… Set up environment configuration
- âœ… Generate JWT keys
- âœ… Start all development services
- âœ… Open the application in your browser

### 2. Access Your Development Environment

Once setup completes:

- **UI**: http://localhost:3000
- **API**: http://localhost:5329  
- **GraphQL Playground**: http://localhost:5329/graphql
- **Database**: localhost:5432 (credentials in `.env-dev`)
- **Redis**: localhost:6379

## Development Targets

### Local Services Target

**Best for**: Traditional development with direct service execution

```bash
# Start local services development
bash scripts/main/develop.sh --target local-services
```

**Features:**
- Direct Node.js execution (faster development cycle)
- Local PostgreSQL and Redis instances
- File-based secret management
- Hot reload for rapid iteration

**Services:**
- UI: Direct Vite development server
- API: Direct Node.js server with debugging
- Database: Local PostgreSQL instance
- Redis: Local Redis instance

### Docker Daemon Target

**Best for**: Container-isolated development

```bash
# Start Docker-based development
bash scripts/main/develop.sh --target docker-daemon
```

**Features:**
- Full containerization (production-like)
- Docker Compose orchestration
- Volume mounting for code changes
- Isolated networking

**Services:**
- UI: Containerized React application
- API: Containerized Node.js server
- Database: PostgreSQL container
- Redis: Redis container

### Kubernetes Cluster Target

**Best for**: Kubernetes-native development

```bash
# Start Kubernetes development
bash scripts/main/develop.sh --target k8s-cluster
```

**Features:**
- Full Kubernetes deployment (Minikube)
- Helm chart development
- Vault Secrets Operator integration
- Production-like orchestration

**Services:**
- UI: Kubernetes deployment
- API: Kubernetes deployment  
- Database: PostgreSQL StatefulSet
- Redis: Redis deployment
- Vault: Local Vault instance with VSO

## Environment Configuration

> **Complete Reference**: For comprehensive environment variables documentation, see [Environment Variables Guide](./getting-started/environment-variables.md).

### Environment Files

```bash
# Development environment
.env-dev              # Main development configuration

# Other environments (for reference)
.env-prod            # Production environment
```

### Key Environment Variables

```bash
# Core Configuration
ENVIRONMENT=development
NODE_ENV=development
SECRETS_SOURCE=file                    # or 'vault' for Vault integration

# Database Configuration
DB_HOST=localhost                      # or 'postgres' for Docker
DB_PORT=5432
DB_NAME=postgres
DB_USER=vrooli_dev
DB_PASSWORD=<auto-generated>

# Redis Configuration  
REDIS_HOST=localhost                   # or 'redis' for Docker
REDIS_PORT=6379
REDIS_PASSWORD=<auto-generated>

# Application Configuration
API_URL=http://localhost:5329
UI_URL=http://localhost:3000
JWT_PRIV=<auto-generated-key>
JWT_PUB=<auto-generated-key>

# Optional Service Configuration
OPENAI_API_KEY=<your-api-key>         # For AI features
STRIPE_PUBLIC_KEY=<your-key>          # For payment features
SITE_EMAIL_*=<email-config>           # For email features
```

## Package Management with PNPM

> **Note**: For detailed package management troubleshooting, see [Troubleshooting Guide](./troubleshooting.md#package-management-issues).

### Why PNPM?

Vrooli uses PNPM for:
- **Efficient Storage**: Shared package store reduces disk usage
- **Fast Installation**: Faster than npm or pnpm for monorepos
- **Strict Dependencies**: Better dependency management
- **Workspace Support**: Excellent monorepo support

### Common PNPM Commands

```bash
# Install dependencies for all packages
pnpm install

# Install dependencies for specific package
pnpm --filter server install

# Run scripts across packages
pnpm run build                    # Build all packages
pnpm --filter ui run dev         # Run UI development server
pnpm --filter server run test    # Run server tests

# Add dependencies
pnpm --filter shared add lodash  # Add to shared package
pnpm add -D typescript           # Add dev dependency to root

# Update dependencies
pnpm update                      # Update all packages
pnpm --filter ui update react   # Update specific package
```

### Workspace Configuration

```json
// pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'docs'
```

## Visual Studio Code Configuration

### Recommended Extensions

```bash
# Core Extensions
- ESLint                         # JavaScript/TypeScript linting
- Prettier - Code formatter      # Code formatting
- TypeScript Importer           # Auto-import for TypeScript
- GitLens                       # Enhanced Git capabilities

# Development Extensions
- Docker                        # Docker container management
- Kubernetes                    # Kubernetes YAML support
- Thunder Client               # API testing
- PostgreSQL                   # Database management

# Quality of Life Extensions
- Peacock                      # Workspace color coding
- Auto Rename Tag              # HTML/JSX tag renaming
- Bracket Pair Colorizer       # Matching bracket colors
- Path Intellisense           # File path autocompletion
```

### Workspace Settings

Create `.vscode/settings.json`:

```json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.preferences.importModuleSpecifier": "relative",
  "peacock.favoriteColors": [
    { "name": "Development", "value": "#42b883" },
    { "name": "Staging", "value": "#f5a623" },
    { "name": "Production", "value": "#ff4444" }
  ],
  "files.exclude": {
    "**/node_modules": true,
    "**/dist": true,
    "**/.next": true
  },
  "search.exclude": {
    "**/node_modules": true,
    "**/dist": true,
    "**/.next": true,
    "**/pnpm-lock.yaml": true
  }
}
```

### Debug Configuration

Create `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Attach to Server",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "address": "localhost",
      "localRoot": "${workspaceFolder}/packages/server",
      "remoteRoot": "/srv/app/packages/server",
      "outFiles": ["${workspaceFolder}/packages/server/dist/**/*.js"],
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Debug Server Tests",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/packages/server/node_modules/.bin/mocha",
      "args": ["--require", "ts-node/register", "src/**/*.test.ts"],
      "cwd": "${workspaceFolder}/packages/server",
      "env": {
        "NODE_ENV": "test"
      }
    }
  ]
}
```

### Environment Color Coding

Use Peacock to visually distinguish environments:

```bash
# Command Palette (Ctrl+Shift+P)
# "Peacock: Change to a Favorite Color"
# Select:
# - Development: Green (#42b883)
# - Staging: Orange (#f5a623)  
# - Production: Red (#ff4444)
```

## Database Management

### Connecting to Development Database

```bash
# PostgreSQL connection
psql -h localhost -U vrooli_dev -d postgres
# Password is in .env-dev as DB_PASSWORD

# Or using Docker (if using docker-daemon target)
docker exec -it postgres psql -U vrooli_dev -d postgres
```

### Running Database Migrations

```bash
# Local services target
cd packages/server
pnpm run migrate

# Docker target
docker exec -it server bash -c "cd packages/server && pnpm run migrate"

# Kubernetes target
kubectl exec -it $(kubectl get pods -l app=server -o name) -- bash -c "cd packages/server && pnpm run migrate"
```

### Creating Test Data

```bash
# Enable mock data in .env-dev
echo "CREATE_MOCK_DATA=true" >> .env-dev

# Restart development environment
bash scripts/main/develop.sh --target local-services

# Or manually create mock data
cd packages/server
pnpm run create-mock-data
```

### Database Utilities

```bash
# Reset database (WARNING: Deletes all data)
cd packages/server
pnpm run db:reset

# Backup database
pg_dump -h localhost -U vrooli_dev postgres > backup.sql

# Restore database
psql -h localhost -U vrooli_dev -d postgres < backup.sql
```

## Testing Framework

> **Complete Testing Guide**: See [Testing Infrastructure](./testing-infrastructure.md) for comprehensive testing documentation.

### Running Tests

```bash
# Run all tests
pnpm run test

# Run tests for specific package
pnpm --filter shared run test
pnpm --filter server run test
pnpm --filter ui run test

# Run shell script tests
bash scripts/__tests/__runTests.sh

# Run with coverage
pnpm run test:coverage

# Run in watch mode
pnpm --filter server run test:watch
```

### Writing Tests

```typescript
// Example unit test (packages/server/src/services/auth.test.ts)
import { expect } from 'chai';
import { describe, it } from 'mocha';
import { authService } from './auth.js';

describe('Auth Service', () => {
    it('should validate JWT tokens', () => {
        const token = authService.generateToken({ userId: '123' });
        const decoded = authService.verifyToken(token);
        expect(decoded.userId).to.equal('123');
    });
});
```

```bash
# Example BATS test (scripts/__tests/utils/log.bats)
#!/usr/bin/env bats

@test "log function outputs correct format" {
    source "scripts/helpers/utils/log.sh"
    
    result=$(log::info "test message")
    
    [[ "$result" =~ \[INFO\] ]]
    [[ "$result" =~ "test message" ]]
}
```

## Debugging

### Server Debugging

The development environment includes debugging support:

```bash
# Debug mode is automatically enabled in development
# Server runs with --inspect=0.0.0.0:9229

# Connect from VSCode:
# 1. Set breakpoints in TypeScript files
# 2. Run "Attach to Server" debug configuration
# 3. Trigger the code path to hit breakpoints
```

### UI Debugging

```bash
# React Developer Tools (browser extension recommended)
# Available in Chrome/Firefox extension stores

# Vite development server includes:
# - Hot Module Replacement (HMR)
# - Source maps for debugging
# - Error overlay in browser
```

### Container Debugging

```bash
# View container logs
docker logs server              # Server logs
docker logs ui                  # UI logs
docker logs postgres           # Database logs

# Access container shell
docker exec -it server bash    # Server container
docker exec -it postgres bash  # Database container

# Monitor container resources
docker stats                   # Real-time resource usage
```

### Kubernetes Debugging

```bash
# View pod logs
kubectl logs -l app=server     # Server pods
kubectl logs -l app=ui         # UI pods

# Access pod shell
kubectl exec -it $(kubectl get pods -l app=server -o name) -- bash

# Port forwarding for direct access
kubectl port-forward svc/server 5329:5329
kubectl port-forward svc/ui 3000:3000
```

## Advanced Features

### Vault Integration (Development)

```bash
# Start local Vault for development
bash scripts/main/manageLocalVault.sh --start-dev

# Update .env-dev to use Vault
sed -i 's/SECRETS_SOURCE=file/SECRETS_SOURCE=vault/' .env-dev

# Restart development environment
bash scripts/main/develop.sh --target local-services
```

### Hot Reload Configuration

```bash
# UI Hot Reload (Vite)
# Automatically enabled in development mode
# Watches: packages/ui/src/**/*

# Server Hot Reload (nodemon)  
# Automatically enabled in development mode
# Watches: packages/server/src/**/*

# Shared Package Changes
# Requires restart when shared package changes
pnpm run build:shared && restart-dev-server
```

### Performance Profiling

```bash
# Node.js profiling
node --prof packages/server/dist/index.js
node --prof-process isolate-*.log > profile.txt

# React profiling
# Use React Developer Tools Profiler tab
# Available in browser extension

# Database profiling
# Enable query logging in PostgreSQL
echo "log_statement = 'all'" >> postgresql.conf
```

## Troubleshooting

> **Complete Troubleshooting**: See [Troubleshooting Guide](./troubleshooting.md#development-environment-issues) for comprehensive issue resolution.

### Common Issues

#### 1. Port Conflicts

```bash
# Check what's using ports
sudo lsof -i :3000    # UI port
sudo lsof -i :5329    # API port
sudo lsof -i :5432    # Database port

# Kill conflicting processes
sudo kill -9 $(lsof -ti:3000)

# Use different ports (in .env-dev)
PORT_UI=3001
PORT_SERVER=5330
```

#### 2. PNPM Issues

```bash
# Clear PNPM cache
pnpm store prune

# Reinstall dependencies
rm -rf node_modules packages/*/node_modules
pnpm install

# Check PNPM version
pnpm --version    # Should be 8.x or later
```

#### 3. Database Connection Issues

```bash
# Check database status
# Local services:
pg_isready -h localhost -p 5432

# Docker:
docker ps | grep postgres
docker logs postgres

# Kubernetes:
kubectl get pods -l app=postgres
kubectl logs -l app=postgres
```

#### 4. Environment Variable Issues

```bash
# Verify environment file exists
ls -la .env-dev

# Check environment loading
source .env-dev && echo "DB_HOST: $DB_HOST"

# Regenerate environment file
rm .env-dev
bash scripts/main/setup.sh
```

#### 5. TypeScript Compilation Issues

```bash
# Clear TypeScript cache
rm -rf packages/*/dist
rm -rf packages/*/.tsbuildinfo

# Rebuild all packages
pnpm run build

# Check TypeScript configuration
pnpm tsc --noEmit --project packages/server
```

### Reset Development Environment

If you need a complete reset:

```bash
# Stop all services
bash scripts/main/develop.sh --stop  # If available
# or
docker-compose down
pkill -f "node.*server"
pkill -f "node.*ui"

# Remove all generated files
rm -rf node_modules packages/*/node_modules
rm -rf packages/*/dist
rm .env-dev jwt_*.pem

# Clean Docker (if using Docker target)
docker system prune -f
docker volume prune -f

# Start fresh
bash scripts/main/develop.sh --target local-services
```

## Team Development

### Branch Management

```bash
# Development workflow
git checkout -b feature/my-feature
# Make changes...
git add .
git commit -m "feat: add new feature"
git push origin feature/my-feature

# Keep up to date with main
git checkout main
git pull origin main
git checkout feature/my-feature
git rebase main
```

### Code Quality

```bash
# Run linting
pnpm run lint

# Fix linting issues
pnpm run lint:fix

# Format code
pnpm run format

# Type checking
pnpm run type-check

# Pre-commit hooks (automatically set up)
# Runs linting and formatting on commit
```

### Environment Synchronization

```bash
# Share environment template
cp .env-dev .env-dev.template
# Remove sensitive values, commit template

# Team members use template
cp .env-dev.template .env-dev
# Fill in personal API keys and secrets
```

## Performance Optimization

### Development Speed

```bash
# Use local services target for fastest iteration
bash scripts/main/develop.sh --target local-services

# Enable TypeScript incremental compilation
# Already configured in tsconfig.json

# Use PNPM linking for faster installs
pnpm config set store-dir ~/.pnpm-store

# Increase Node.js memory for large builds
export NODE_OPTIONS="--max-old-space-size=4096"
```

### Resource Management

```bash
# Monitor resource usage
htop                    # CPU and memory
iotop                   # Disk I/O
nethogs                 # Network usage

# Optimize Docker resources (if using Docker target)
# Edit Docker Desktop settings:
# - Memory: 4GB minimum, 8GB recommended
# - CPUs: Half of available cores
# - Disk: 20GB minimum
```

This comprehensive development environment setup ensures you have everything needed for productive Vrooli development using the sophisticated infrastructure and modern tooling.

## Related Documentation

- **Prerequisites**: [Prerequisites Guide](./getting-started/prerequisites.md)
- **Environment Variables**: [Environment Variables Reference](./getting-started/environment-variables.md)
- **SSH Setup**: [SSH Setup Guide](./getting-started/ssh-setup.md)
- **Testing**: [Testing Infrastructure](./testing-infrastructure.md)
- **Build System**: [Build System Guide](./build-system.md)
- **Deployment**: [Server Deployment](./server-deployment.md)
- **CI/CD**: [CI/CD Pipeline](./ci-cd.md)
- **Troubleshooting**: [Troubleshooting Guide](./troubleshooting.md) 