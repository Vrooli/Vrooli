{
  "id": "7829564732190847057",
  "publicId": "corr-find-v1",
  "resourceType": "Routine",
  "isPrivate": false,
  "permissions": "{}",
  "isInternal": false,
  "tags": [],
  "versions": [
    {
      "id": "7829564732190847058",
      "publicId": "cor-fnd-v1",
      "versionLabel": "1.0.0",
      "versionNotes": "Initial version",
      "isComplete": true,
      "isPrivate": false,
      "versionIndex": 0,
      "isAutomatable": true,
      "resourceSubType": "RoutineCode",
      "config": {
        "__version": "1.0",
        "callDataCode": {
          "__version": "1.0",
          "schema": {
            "language": "python",
            "code": "import pandas as pd\nimport numpy as np\nimport json\nfrom scipy import stats\nfrom io import StringIO\n\n# Parse input data\ndata_string = '''{{input.dataset}}'''\nvariable_pairs = '''{{input.variablePairs}}'''\nanalysis_type = '''{{input.analysisType}}'''\n\n# Load data\ntry:\n    if ',' in data_string and '\\n' in data_string:\n        df = pd.read_csv(StringIO(data_string))\n    else:\n        data = json.loads(data_string)\n        df = pd.DataFrame(data)\nexcept Exception as e:\n    raise ValueError(f\"Could not parse data: {str(e)}\")\n\n# Convert numeric columns\nfor col in df.columns:\n    try:\n        df[col] = pd.to_numeric(df[col], errors='ignore')\n    except:\n        pass\n\n# Get numeric columns\nnumeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n\nif len(numeric_cols) < 2:\n    raise ValueError(\"Need at least 2 numeric columns for correlation analysis\")\n\n# Parse variable pairs if specified\nif variable_pairs.strip():\n    try:\n        pairs = [pair.strip().split(',') for pair in variable_pairs.split(';')]\n        pairs = [(p[0].strip(), p[1].strip()) for p in pairs if len(p) == 2]\n    except:\n        pairs = []\nelse:\n    # All pairs of numeric columns\n    pairs = [(numeric_cols[i], numeric_cols[j]) \n             for i in range(len(numeric_cols)) \n             for j in range(i+1, len(numeric_cols))]\n\n# Perform correlation analysis\nresults = []\n\nfor var1, var2 in pairs:\n    if var1 not in df.columns or var2 not in df.columns:\n        continue\n    \n    # Remove missing values\n    data_clean = df[[var1, var2]].dropna()\n    \n    if len(data_clean) < 3:\n        continue\n    \n    x = data_clean[var1]\n    y = data_clean[var2]\n    \n    # Calculate correlations\n    pearson_r, pearson_p = stats.pearsonr(x, y)\n    spearman_r, spearman_p = stats.spearmanr(x, y)\n    \n    # Calculate R-squared\n    r_squared = pearson_r ** 2\n    \n    # Determine strength\n    abs_r = abs(pearson_r)\n    if abs_r < 0.3:\n        strength = \"Weak\"\n    elif abs_r < 0.7:\n        strength = \"Moderate\"\n    else:\n        strength = \"Strong\"\n    \n    # Determine direction\n    direction = \"Positive\" if pearson_r > 0 else \"Negative\"\n    \n    # Create result\n    result = {\n        'variables': f\"{var1} vs {var2}\",\n        'pearson_r': round(float(pearson_r), 4),\n        'pearson_p': round(float(pearson_p), 4),\n        'spearman_r': round(float(spearman_r), 4),\n        'spearman_p': round(float(spearman_p), 4),\n        'r_squared': round(float(r_squared), 4),\n        'strength': strength,\n        'direction': direction,\n        'n_observations': len(data_clean),\n        'significant': pearson_p < 0.05\n    }\n    \n    # Add interpretation\n    if result['significant']:\n        result['interpretation'] = f\"{strength} {direction.lower()} correlation (r={pearson_r:.3f}, p={pearson_p:.3f}). \"\n        result['interpretation'] += f\"{r_squared*100:.1f}% of variance in {var2} can be explained by {var1}.\"\n    else:\n        result['interpretation'] = f\"No significant correlation found (p={pearson_p:.3f}).\"\n    \n    # Check for non-linear relationship\n    if abs(spearman_r) > abs(pearson_r) + 0.1:\n        result['note'] = \"Spearman correlation suggests possible non-linear relationship.\"\n    \n    results.append(result)\n\n# Create correlation matrix for all numeric variables\ncorr_matrix = df[numeric_cols].corr(method='pearson').round(4).to_dict()\n\n# Find strongest correlations\nstrong_correlations = []\nfor i, col1 in enumerate(numeric_cols):\n    for j, col2 in enumerate(numeric_cols[i+1:], i+1):\n        corr_val = corr_matrix[col1][col2]\n        if abs(corr_val) > 0.7:\n            strong_correlations.append({\n                'pair': f\"{col1} - {col2}\",\n                'correlation': corr_val\n            })\n\n# Warnings about correlation\nwarnings = [\n    \"Remember: Correlation does not imply causation.\",\n    \"Always consider confounding variables and domain knowledge.\",\n    \"Check scatter plots to verify linear relationships.\"\n]\n\n# Handle spurious correlations\nif len(results) > 10:\n    warnings.append(f\"With {len(results)} comparisons, expect {len(results)*0.05:.0f} false positives at p<0.05.\")\n    warnings.append(\"Consider using Bonferroni correction for multiple comparisons.\")\n\n# Create summary\nsummary = {\n    'total_variables': len(numeric_cols),\n    'total_comparisons': len(results),\n    'significant_correlations': sum(1 for r in results if r['significant']),\n    'strong_correlations': len(strong_correlations)\n}\n\n# Format output\noutput = {\n    'summary': summary,\n    'correlations': results,\n    'correlation_matrix': corr_matrix,\n    'strong_correlations': strong_correlations,\n    'warnings': warnings,\n    'numeric_columns': numeric_cols\n}\n\nprint(json.dumps(output, indent=2))",
            "timeout": 30000,
            "maxMemory": "128MB"
          }
        },
        "formInput": {
          "__version": "1.0",
          "schema": {
            "containers": [],
            "elements": [
              {
                "fieldName": "dataset",
                "id": "dataset_input",
                "label": "Dataset (CSV or JSON)",
                "type": "Text",
                "isRequired": true,
                "props": {
                  "placeholder": "Paste your data in CSV or JSON format with numeric columns to analyze...",
                  "minRows": 8
                }
              },
              {
                "fieldName": "variablePairs",
                "id": "variable_pairs_input",
                "label": "Variable Pairs (Optional)",
                "type": "Text",
                "isRequired": false,
                "props": {
                  "placeholder": "Specify pairs to analyze (e.g., 'height,weight; age,income'). Leave empty for all pairs."
                }
              },
              {
                "fieldName": "analysisType",
                "id": "analysis_type_input",
                "label": "Analysis Type",
                "type": "Selector",
                "isRequired": true,
                "props": {
                  "options": ["Pearson (Linear)", "Spearman (Monotonic)", "Both"],
                  "defaultValue": "Both"
                }
              }
            ]
          }
        },
        "formOutput": {
          "__version": "1.0",
          "schema": {
            "containers": [],
            "elements": [
              {
                "fieldName": "result",
                "id": "correlation_results_output",
                "label": "Correlation Analysis Results",
                "type": "JSON"
              },
              {
                "fieldName": "summary",
                "id": "summary_output",
                "label": "Analysis Summary",
                "type": "Text"
              },
              {
                "fieldName": "strongCorrelations",
                "id": "strong_correlations_output",
                "label": "Strong Correlations Found",
                "type": "Text"
              },
              {
                "fieldName": "interpretation",
                "id": "interpretation_output",
                "label": "Plain Language Interpretation",
                "type": "Text"
              }
            ]
          }
        },
        "executionStrategy": "deterministic"
      },
      "translations": [
        {
          "id": "7829564732190847059",
          "language": "en",
          "name": "Correlation Finder",
          "description": "Analyzes relationships between variables in datasets. Calculates Pearson and Spearman correlations, identifies strong relationships, and provides statistical significance. Includes warnings about correlation vs causation and multiple comparison issues.",
          "instructions": "1. Paste your dataset with numeric columns\n2. Optionally specify which variable pairs to analyze\n3. Choose correlation type (Pearson for linear, Spearman for any monotonic)\n\nThe analyzer will:\n- Calculate correlation coefficients and p-values\n- Identify strong correlations (|r| > 0.7)\n- Provide R-squared values\n- Warn about spurious correlations\n- Create a full correlation matrix\n- Give plain language interpretations\n\nRemember: correlation â‰  causation!"
        }
      ]
    }
  ]
}